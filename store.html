<!DOCTYPE html>
<html lang="tl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#02040a">
    <title>Radio Bingo Live | Store</title>
    
    <link rel="stylesheet" href="style.css">

    <link rel="icon" type="image/png" href="https://i.imgur.com/7D8u8h6.png">
    
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>

    <script src="https://pl28660488.effectivegatecpm.com/9b/f5/85/9bf585b6ee39cb9b515e2fae1fa958c2.js"></script>
</head>
<body>

<div id="splash-screen">
    <div class="splash-logo">RB<span>LIVE</span></div>
    <div class="splash-loader"></div>
</div>

<div id="customToast">
    <i data-lucide="info" class="toast-icon"></i>
    <span class="toast-msg" id="toastMsg">Notification!</span>
</div>

<div id="customConfirmModal">
    <div class="conf-content">
        <i data-lucide="alert-triangle" style="width: 50px; height: 50px; color: var(--gold); margin-bottom: 15px;"></i>
        <h3 class="conf-title" id="confTitle">Confirm Action</h3>
        <p class="conf-msg" id="confMsg">Are you sure?</p>
        <div class="conf-actions">
            <button class="btn-conf-no" onclick="closeCustomConfirm()">CANCEL</button>
            <button class="btn-conf-yes" id="confYesBtn">CONFIRM</button>
        </div>
    </div>
</div>

<div class="bottom-nav">
    <button class="nav-item" onclick="window.location.href='index.html'">
        <i data-lucide="home" class="nav-icon"></i>
        <span class="nav-label">Home</span>
    </button>
    <button class="nav-item" onclick="window.location.href='bingo.html'">
        <i data-lucide="play-circle" class="nav-icon"></i>
        <span class="nav-label">Bingo</span>
    </button>
    <div class="nav-center" onclick="window.location.href='index.html'">
        <div class="nav-icon-bg"><i data-lucide="plus" style="width:28px; height:28px;"></i></div>
    </div>
    <button class="nav-item active" onclick="window.location.reload()">
        <i data-lucide="shopping-bag" class="nav-icon"></i>
        <span class="nav-label">Store</span>
    </button>
    <button class="nav-item" onclick="window.location.href='me.html'">
        <i data-lucide="user" class="nav-icon"></i>
        <span class="nav-label">Me</span>
    </button>
</div>

<div class="container">
    
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:25px; padding-top:10px;">
        <div>
            <h3 style="margin:0; font-family:'Outfit', sans-serif; font-size: 24px; font-weight: 900; color: white; letter-spacing:-0.5px;">MARKETPLACE</h3>
            <p style="margin: 5px 0 0 0; font-size: 12px; font-weight: 600; color: var(--text-muted);">Redeem, Shop Skins, or Earn</p>
        </div>
        <div class="points-badge" style="height:40px; border-radius: 50px; padding:0 15px;">
            <i data-lucide="coins" style="width:18px; color:var(--gold);"></i> 
            <span id="storePoints" style="font-size:16px;">0</span>
        </div>
    </div>

    <div class="store-nav">
        <button class="store-tab-btn active" onclick="switchStoreTab('cashout')" id="tabBtnCash">Redeem</button>
        <button class="store-tab-btn" onclick="switchStoreTab('skins')" id="tabBtnSkins">Skins</button>
        <button class="store-tab-btn" onclick="switchStoreTab('earn')" id="tabBtnEarn" style="color:var(--gold-shine);">Tasks</button>
    </div>

    <div class="glass-panel" style="padding: 20px; margin-bottom: 25px; border: 1px solid rgba(251, 191, 36, 0.3); text-align: center; position: relative;">
        <h4 style="margin: 0 0 15px 0; color: var(--gold); font-size: 12px; font-weight:800; text-transform: uppercase; letter-spacing:1px; display:flex; align-items:center; justify-content:center; gap:8px;">
            <i data-lucide="zap" style="width:14px;"></i> DAILY BOOST
        </h4>
        
        <div id="adTimerOverlay" style="display: none; position: absolute; inset: 0; background: rgba(2, 4, 10, 0.98); z-index: 50; align-items: center; justify-content: center; flex-direction: column; border-radius:24px;">
            <div id="adStatusIcon" style="font-size: 40px; margin-bottom: 15px;">üì∫</div>
            <div style="font-size: 24px; font-weight: 900; color: white;" id="adCountdown">30s</div>
            <div style="font-size: 12px; color: var(--danger); padding: 0 20px; margin-top: 10px; font-weight:700;" id="adStatusText">Do not close app or switch tabs!</div>
        </div>
        
        <div id="adCaptchaOverlay" style="display: none; position: absolute; inset: 0; background: rgba(2, 4, 10, 0.98); z-index: 51; align-items: center; justify-content: center; flex-direction: column; border-radius:24px;">
            <div style="font-size: 12px; font-weight: 700; color: var(--primary-glow); margin-bottom: 15px; text-transform:uppercase; letter-spacing:1px;">Human Verification</div>
            <div style="background: rgba(255,255,255,0.05); padding: 15px 30px; border-radius: 16px; margin-bottom: 15px; border:1px solid rgba(255,255,255,0.1);">
                <span id="mathQ" style="font-size: 28px; font-weight: 900; color: white; font-family: var(--font-display);">5 + 3 = ?</span>
            </div>
            <div style="display: flex; gap: 8px;">
                <input type="number" id="mathAns" style="width: 80px; padding: 12px; border-radius: 12px; border: 1px solid var(--primary); background: #0f172a; color: white; text-align: center; font-weight: 800; font-size:18px;">
                <button onclick="verifyAdMath()" style="background: var(--success); border: none; padding: 0 20px; border-radius: 12px; color: white; font-weight: 900; cursor:pointer;">OK</button>
            </div>
        </div>

        <button id="btnWatchAd" onclick="startStrictWatch()" style="background: linear-gradient(135deg, #f59e0b, #b45309); width: 100%; border: none; padding: 16px; border-radius: 16px; font-weight: 900; color: white; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 10px; font-size: 14px; box-shadow: 0 8px 20px rgba(245, 158, 11, 0.3); text-shadow: 0 1px 2px rgba(0,0,0,0.3); transition:0.2s;">
            <i data-lucide="play" style="width: 18px; fill:white;"></i> WATCH AD (+50 Coins)
        </button>
        <p style="font-size: 10px; opacity: 0.6; margin-top: 10px; color:var(--text-muted);">*Timer pauses if you leave the app!</p>
    </div>

    <div id="storeSection-cashout" style="display:block;">
        <div class="reward-grid">
            <div class="reward-item">
                <div class="reward-main"><div class="reward-icon-box"><i data-lucide="gift" style="width:24px"></i></div><div class="reward-info"><b>‚Ç±20 GCash</b><small><i data-lucide="database" style="width:10px"></i> 50,000 Coins</small></div></div>
                <button class="btn-redeem" onclick="redeemItem('‚Ç±20 Gift Card', 50000)">Redeem</button>
            </div>
            <div class="reward-item">
                <div class="reward-main"><div class="reward-icon-box" style="color:var(--gold); background:rgba(251, 191, 36, 0.1); border-color:rgba(251, 191, 36, 0.3);"><i data-lucide="gift" style="width:24px"></i></div><div class="reward-info"><b>‚Ç±50 GCash</b><small><i data-lucide="database" style="width:10px"></i> 125,000 Coins</small></div></div>
                <button class="btn-redeem" onclick="redeemItem('‚Ç±50 Gift Card', 125000)">Redeem</button>
            </div>
            <div class="reward-item">
                <div class="reward-main"><div class="reward-icon-box" style="color:var(--success); background:rgba(16, 185, 129, 0.1); border-color:rgba(16, 185, 129, 0.3);"><i data-lucide="gift" style="width:24px"></i></div><div class="reward-info"><b>‚Ç±100 GCash</b><small><i data-lucide="database" style="width:10px"></i> 250,000 Coins</small></div></div>
                <button class="btn-redeem" onclick="redeemItem('‚Ç±100 Gift Card', 250000)">Redeem</button>
            </div>
        </div>
        <p style="text-align: center; font-size: 10px; color: var(--text-muted); margin-top: 30px; line-height: 1.6;">Processing takes 24-48 hours.<br>Ensure your details are correct in "Me" page.</p>
    </div>

    <div id="storeSection-skins" style="display:none;">
        <div style="margin-bottom:20px; padding:15px; background:rgba(255,255,255,0.05); border-radius:16px; border:1px dashed rgba(255,255,255,0.2); text-align:center; display:flex; justify-content:space-between; align-items:center;">
            <div style="text-align:left;">
                <label style="font-size:12px; font-weight:800; display:block; color:white;">CUSTOM SKIN</label>
                <span style="font-size:10px; color:var(--text-muted);">Upload your own image</span>
            </div>
            <input type="file" accept="image/*" id="customSkinInput" style="display:none" onchange="handleCustomSkinUpload(this)">
            <button onclick="document.getElementById('customSkinInput').click()" style="background:var(--primary); color:white; border:none; padding:8px 16px; border-radius:10px; font-weight:800; font-size:11px; cursor:pointer;">UPLOAD</button>
        </div>

        <div class="skins-grid">
            <div class="skin-item"><div class="skin-preview" style="background:rgba(30,41,59,0.8); border:1px solid rgba(255,255,255,0.1);">B</div><div class="skin-name">Classic</div><div class="skin-cost">Free</div><button class="btn-buy-skin equip" id="btn-skin-default" onclick="equipSkin('default')">EQUIP</button></div>
            
            <div class="skin-item"><div class="skin-preview" style="background:pink; border:2px solid hotpink; color:deeppink; font-family:'Comic Neue',cursive;">B</div><div class="skin-name">Hello Kitty</div><div class="skin-cost">75,000 Coins</div><button class="btn-buy-skin buy" id="btn-skin-kitty" onclick="buyOrEquipSkin('kitty', 75000)">BUY</button></div>
            
            <div class="skin-item"><div class="skin-preview" style="background:#0096df; border:2px solid white; color:white; border-radius:50%;">B</div><div class="skin-name">Doraemon</div><div class="skin-cost">75,000 Coins</div><button class="btn-buy-skin buy" id="btn-skin-doraemon" onclick="buyOrEquipSkin('doraemon', 75000)">BUY</button></div>
            
            <div class="skin-item"><div class="skin-preview" style="background:#f7f44d; border:2px dashed brown; color:brown;">B</div><div class="skin-name">SpongeBob</div><div class="skin-cost">75,000 Coins</div><button class="btn-buy-skin buy" id="btn-skin-spongebob" onclick="buyOrEquipSkin('spongebob', 75000)">BUY</button></div>
            
            <div class="skin-item"><div class="skin-preview" style="background:black; border:2px solid purple; color:pink;">B</div><div class="skin-name">Kuromi</div><div class="skin-cost">75,000 Coins</div><button class="btn-buy-skin buy" id="btn-skin-kuromi" onclick="buyOrEquipSkin('kuromi', 75000)">BUY</button></div>

            <div class="skin-item"><div class="skin-preview" style="background:rgba(8,51,68,1); border:2px solid #06b6d4; color:#67e8f9; text-shadow:0 0 5px #06b6d4;">B</div><div class="skin-name">Neon City</div><div class="skin-cost">50,000 Coins</div><button class="btn-buy-skin buy" id="btn-skin-neon" onclick="buyOrEquipSkin('neon', 50000)">BUY</button></div>
            <div class="skin-item"><div class="skin-preview" style="background:linear-gradient(135deg, #451a03, #000); border:2px solid #f59e0b; color:#fcd34d; font-family:'Times New Roman',serif;">B</div><div class="skin-name">Luxury Gold</div><div class="skin-cost">100,000 Coins</div><button class="btn-buy-skin buy" id="btn-skin-gold" onclick="buyOrEquipSkin('gold', 100000)">BUY</button></div>
            <div class="skin-item"><div class="skin-preview" style="background:rgba(80, 7, 36, 1); border:2px solid #ec4899; color:#fbcfe8; border-radius:50%;">B</div><div class="skin-name">Kawaii Pink</div><div class="skin-cost">25,000 Coins</div><button class="btn-buy-skin buy" id="btn-skin-pink" onclick="buyOrEquipSkin('pink', 25000)">BUY</button></div>
            
            <div class="skin-item" id="customSkinSlot" style="display:none;"><div class="skin-preview" id="customSkinPreview" style="background-size:cover;">B</div><div class="skin-name">My Custom</div><div class="skin-cost">Owned</div><button class="btn-buy-skin equip" id="btn-skin-custom" onclick="equipSkin('custom')">EQUIP</button></div>
        </div>
    </div>

    <div id="storeSection-earn" style="display:none;">
        <div class="task-list">
            <div class="task-item" style="border-color: rgba(239, 68, 68, 0.4); background: linear-gradient(135deg, rgba(69,10,10,0.6), rgba(15,23,42,0.8));">
                <div class="task-info">
                    <h4 style="color:#fca5a5; display:flex; align-items:center; gap:6px;"><i data-lucide="play-circle" style="width:14px"></i> Watch Video</h4>
                    <p>Watch full video to unlock reward</p>
                    <span class="task-reward" style="background: rgba(239,68,68,0.2); border-color:#ef4444; color:#fca5a5;">+2,000 Coins</span>
                </div>
                <button class="btn-do-task" style="background:#ef4444; box-shadow:0 4px 15px rgba(239,68,68,0.3);" id="btn-task-video" onclick="openVideoLocker('video')">WATCH</button>
            </div>
            
            <div class="task-item">
                <div class="task-info">
                    <h4 style="display:flex; align-items:center; gap:6px;"><i data-lucide="star" style="width:14px; color:var(--gold);"></i> Premium Offer</h4>
                    <p>Complete simple offer to verify</p>
                    <span class="task-reward">+5,000 Coins</span>
                </div>
                <button class="btn-do-task" id="btn-task-premium" onclick="startTaskSafe('https://doctoredits.com/1874673', 5000, 'premium')">GO</button>
            </div>
        </div>
    </div>
</div>

<script>
    // === INITIALIZATION ===
    window.addEventListener('load', () => { lucide.createIcons(); setTimeout(hideSplash, 1500); });
    function hideSplash() { const ss = document.getElementById('splash-screen'); if(ss) { ss.style.opacity='0'; setTimeout(()=>ss.style.display='none',800); }}
    
    const firebaseConfig = { apiKey: "AIzaSyDIAQXJ15atKJxu7PtcFL1W9JnO1N14pVs", authDomain: "radiobingo-9ac29.firebaseapp.com", databaseURL: "https://radiobingo-9ac29-default-rtdb.asia-southeast1.firebasedatabase.app", projectId: "radiobingo-9ac29", storageBucket: "radiobingo-9ac29.firebasestorage.app", messagingSenderId: "965903993397", appId: "1:965903993397:web:f6646fa05225f147eebf7c" };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database(); const auth = firebase.auth();
    let userData = {};

    const sounds = { click: new Audio('https://cdn.pixabay.com/audio/2022/03/15/audio_2731885542.mp3'), win: new Audio('https://cdn.freesound.org/previews/270/270404_5123851-lq.mp3') };
    function playSound(type) { if(sounds[type]) { sounds[type].currentTime = 0; sounds[type].volume = 1.0; sounds[type].play().catch(e => console.log(e)); } }
    function showToast(msg) { const toast = document.getElementById('customToast'); document.getElementById('toastMsg').innerText = msg; toast.classList.add('show'); playSound('click'); setTimeout(() => { toast.classList.remove('show'); }, 3000); }
    
    let confirmCallback = null;
    function showCustomConfirm(title, msg, onYes) { document.getElementById('confTitle').innerText = title; document.getElementById('confMsg').innerText = msg; document.getElementById('customConfirmModal').style.display = 'flex'; confirmCallback = onYes; playSound('click'); }
    function closeCustomConfirm() { document.getElementById('customConfirmModal').style.display = 'none'; confirmCallback = null; }
    document.getElementById('confYesBtn').addEventListener('click', () => { if(confirmCallback) confirmCallback(); closeCustomConfirm(); });

    // === AUTH ===
    auth.onAuthStateChanged(u => {
        if(u) {
            const userRef = db.ref('users/'+u.uid);
            userRef.on('value', s => { 
                if(s.exists()){ 
                    userData = s.val(); userData.uid = u.uid; 
                    document.getElementById('storePoints').innerText = (userData.points || 0).toLocaleString(); 
                    updateSkinButtons();
                } 
            });
        } else {
            window.location.href = 'index.html';
        }
    });

    // === TAB SWITCHING ===
    function switchStoreTab(tab) {
        document.querySelectorAll('.store-tab-btn').forEach(b => b.classList.remove('active'));
        document.getElementById('storeSection-cashout').style.display = 'none';
        document.getElementById('storeSection-skins').style.display = 'none';
        document.getElementById('storeSection-earn').style.display = 'none';
        if(tab === 'cashout') { document.getElementById('tabBtnCash').classList.add('active'); document.getElementById('storeSection-cashout').style.display = 'block'; } 
        else if(tab === 'skins') { document.getElementById('tabBtnSkins').classList.add('active'); document.getElementById('storeSection-skins').style.display = 'block'; updateSkinButtons(); } 
        else if(tab === 'earn') { document.getElementById('tabBtnEarn').classList.add('active'); document.getElementById('storeSection-earn').style.display = 'block'; }
        playSound('click');
    }

    // === REDEMPTION ===
    function deductPoints(amt) { db.ref('users/' + userData.uid + '/points').transaction(p => (p || 0) - amt); }
    function redeemItem(name, cost) { if(userData.points >= cost) { if(!userData.gcash) return showToast("Save redemption info in Me page first!"); showCustomConfirm("REDEEM REWARD?", "Exchange " + cost + " pts for " + name + "?", () => { deductPoints(cost); db.ref('redemptions').push({ uid: userData.uid, name: userData.name, gcash: userData.gcash, item: name, cost: cost, status: 'pending', timestamp: Date.now() }); showToast("Request Sent!"); }); } else { showToast("Insufficient RB Coins"); } }

    // === AD & ANTI-CHEAT LOGIC ===
    let strictTimer = null;
    let strictSeconds = 30;
    
    function addPoints(amt) { db.ref('users/' + userData.uid + '/points').transaction(p => (p || 0) + amt); }

    function startStrictWatch() {
        const adsterraLink = "https://directoryeditorweep.com/9b/f5/85/9bf585b6ee39cb9b515e2fae1fa958c2.js"; 
        window.open(adsterraLink, "_blank"); 
        
        const overlay = document.getElementById('adTimerOverlay'); 
        overlay.style.display = 'flex'; 
        
        strictSeconds = 30; 
        const cd = document.getElementById('adCountdown'); 
        const status = document.getElementById('adStatusText'); 
        const cap = document.getElementById('adCaptchaOverlay'); 
        
        cd.innerText = strictSeconds + "s";
        status.innerText = "Do not close app or switch tabs!";
        
        clearInterval(strictTimer);
        strictTimer = setInterval(() => { 
            if(document.hidden) { status.innerText = "‚ö†Ô∏è PAUSED! Please return to app."; return; } 
            strictSeconds--; 
            cd.innerText = strictSeconds + "s"; 
            status.innerText = "Watching Ad..."; 
            if(strictSeconds <= 0) { 
                clearInterval(strictTimer); 
                overlay.style.display = 'none'; 
                cap.style.display = 'flex'; 
                const n1 = Math.floor(Math.random()*10); 
                const n2 = Math.floor(Math.random()*10); 
                document.getElementById('mathQ').innerText = `${n1} + ${n2} = ?`; 
                document.getElementById('mathQ').dataset.ans = n1+n2; 
            } 
        }, 1000); 
    }

    function verifyAdMath() { const ans = document.getElementById('mathAns').value; const corr = document.getElementById('mathQ').dataset.ans; if(ans === corr) { document.getElementById('adCaptchaOverlay').style.display = 'none'; addPoints(50); showToast("Reward: +50 Coins Added!"); } else { showToast("Wrong Answer!"); } }
    
    function spawnFlyingCoins(amount) { 
        const count = Math.min(amount, 15); const targetEl = document.querySelector('.points-badge'); if(!targetEl) return; 
        const rect = targetEl.getBoundingClientRect(); const targetX = rect.left + (rect.width / 2); const targetY = rect.top + (rect.height / 2); 
        const startX = window.innerWidth / 2; const startY = window.innerHeight / 2; 
        for(let i=0; i<count; i++) { 
            setTimeout(() => { 
                const coin = document.createElement('div'); coin.className = 'flying-coin'; coin.style.left = startX + 'px'; coin.style.top = startY + 'px'; document.body.appendChild(coin); 
                const randX = (Math.random() - 0.5) * 80; const randY = (Math.random() - 0.5) * 80; 
                requestAnimationFrame(() => { 
                    coin.style.transition = 'transform 0.3s ease-out'; coin.style.transform = `translate(${randX}px, ${randY}px) scale(1.2)`; 
                    setTimeout(() => { coin.style.transition = 'transform 0.6s cubic-bezier(0.2, 0.8, 0.2, 1), opacity 0.6s'; const moveX = targetX - startX; const moveY = targetY - startY; coin.style.transform = `translate(${moveX}px, ${moveY}px) scale(0.5)`; coin.style.opacity = '0'; }, 300); 
                    setTimeout(() => coin.remove(), 900); 
                }); 
            }, i * 30); 
        } 
    }

    // === TASKS ===
    function startTaskSafe(url, reward, taskKey) { const lastRun = localStorage.getItem('task_cooldown_' + taskKey); const cooldownTime = 12 * 60 * 60 * 1000; if(lastRun && (Date.now() - parseInt(lastRun)) < cooldownTime) { showToast("‚è≥ Task in cooldown. Try again later."); return; } showCustomConfirm("START TASK", "Complete offer to earn coins.", () => { window.open(url, '_blank'); const btn = document.getElementById('btn-task-' + taskKey); if(btn) { btn.disabled = true; btn.innerHTML = `<i data-lucide="loader" class="icon-spin"></i> 60s`; let timeLeft = 60; const timer = setInterval(() => { timeLeft--; btn.innerHTML = `<i data-lucide="loader" class="icon-spin"></i> ${timeLeft}s`; if(timeLeft <= 0) { clearInterval(timer); btn.innerHTML = "CLAIM REWARD"; btn.disabled = false; btn.style.background = "#22c55e"; btn.onclick = () => claimTaskReward(reward, taskKey); } }, 1000); } }); }
    function claimTaskReward(reward, taskKey) { addPoints(reward); showToast(`üéâ +${reward} Coins Received!`); playSound('win'); spawnFlyingCoins(20); const btn = document.getElementById('btn-task-' + taskKey); if(btn) { btn.innerHTML = "COMPLETED"; btn.disabled = true; btn.style.background = "#334155"; } localStorage.setItem('task_cooldown_' + taskKey, Date.now()); }
    function openVideoLocker(taskKey) { const lastRun = localStorage.getItem('task_cooldown_video'); if(lastRun && (Date.now() - parseInt(lastRun)) < 300000) { showToast("‚è≥ Wait before watching again."); return; } showCustomConfirm("WATCH VIDEO", "You will be redirected to the video task. Complete it to earn.", () => { localStorage.setItem('task_cooldown_video', Date.now()); const win = window.open("", "_blank"); if(win) { win.document.write(`<html><head><title>Video Task Verification</title><meta name="viewport" content="width=device-width, initial-scale=1.0"><style>body{background:#000; color:white; font-family:sans-serif; text-align:center; padding:20px; display:flex; flex-direction:column; justify-content:center; height:100vh;}</style></head><body><h2>Loading Video Task...</h2><p>Please wait while we load the verification.</p><script type="text/javascript">var lck = false;</scr`+`ipt><script type="text/javascript" src="https://doctoredits.com/script_include.php?id=1874676"></scr`+`ipt><script type="text/javascript">if(!lck){top.location = 'https://doctoredits.com/help/ablk.php?lkt=2'; }</scr`+`ipt><noscript>Please enable JavaScript to access this page.<meta http-equiv="refresh" content="0;url=https://doctoredits.com/help/enable_javascript.php?lkt=2" ></meta></noscript><button onclick="window.close()" style="margin-top:20px; padding:10px 20px; background:red; color:white; border:none; border-radius:5px;">Close & Return to Game</button></body></html>`); win.document.close(); } else { showToast("Pop-up blocked! Please allow pop-ups."); } }); }

    // === SKINS LOGIC ===
    function updateSkinButtons() { 
        if(!userData.ownedSkins) return; 
        ['default', 'neon', 'gold', 'pink', 'kitty', 'doraemon', 'spongebob', 'kuromi', 'custom'].forEach(skin => { 
            const btn = document.getElementById('btn-skin-' + skin); 
            if(!btn) return; 
            if(userData.equippedSkin === skin) { btn.innerText = "EQUIPPED"; btn.className = "btn-buy-skin owned"; btn.onclick = null; } 
            else if(userData.ownedSkins.includes(skin)) { btn.innerText = "EQUIP"; btn.className = "btn-buy-skin equip"; btn.onclick = () => equipSkin(skin); } 
        }); 
        if(localStorage.getItem('customSkinBG')) {
            document.getElementById('customSkinSlot').style.display = 'block';
            document.getElementById('customSkinPreview').style.backgroundImage = `url('${localStorage.getItem('customSkinBG')}')`;
        }
    }
    
    function equipSkin(skinId) { db.ref('users/' + userData.uid).update({ equippedSkin: skinId }); showToast("Skin Equipped"); playSound('click'); }

    function buyOrEquipSkin(skinId, cost) { 
        if(!userData.ownedSkins) userData.ownedSkins = ['default']; 
        if(userData.ownedSkins.includes(skinId)) { equipSkin(skinId); } 
        else { 
            if(userData.points >= cost) { 
                showCustomConfirm("BUY SKIN?", "Purchase for " + cost + " Coins?", () => { 
                    deductPoints(cost); 
                    let newOwned = [...userData.ownedSkins, skinId]; 
                    db.ref('users/' + userData.uid).update({ ownedSkins: newOwned, equippedSkin: skinId }); 
                    showToast("Skin Purchased!"); playSound('win'); spawnFlyingCoins(10); 
                }); 
            } else { showToast("Insufficient Coins"); } 
        } 
    }

    function compressImage(file, maxWidth, quality) {
        return new Promise((resolve) => {
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = (event) => {
                const img = new Image();
                img.src = event.target.result;
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    let width = img.width;
                    let height = img.height;
                    if (width > maxWidth) { height *= maxWidth / width; width = maxWidth; }
                    canvas.width = width; canvas.height = height;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, width, height);
                    resolve(canvas.toDataURL('image/jpeg', quality));
                };
            };
        });
    }

    function handleCustomSkinUpload(input) {
        if(input.files && input.files[0]) {
            compressImage(input.files[0], 800, 0.7).then(base64 => {
                localStorage.setItem('customSkinBG', base64);
                if(!userData.ownedSkins.includes('custom')) {
                     let newOwned = [...userData.ownedSkins, 'custom'];
                     db.ref('users/' + userData.uid).update({ ownedSkins: newOwned });
                }
                db.ref('users/' + userData.uid).update({ equippedSkin: 'custom' });
                showToast("Custom Background Set!");
                updateSkinButtons();
            });
        }
    }
</script>
</body>
</html>
