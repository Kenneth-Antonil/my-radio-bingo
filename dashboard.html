<!DOCTYPE html>
<html lang="tl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Radio Bingo | Admin Master Pro 3D</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jsrsasign/10.5.1/jsrsasign-all-min.js"></script>
    <style>
        :root { 
            --bg-dark: #0a0a0f; 
            --bg-gradient: linear-gradient(135deg, #0a0a0f 0%, #1a1625 50%, #0f1419 100%); 
            --glass-surface: rgba(18, 18, 30, 0.95); 
            --glass-border: rgba(139, 92, 246, 0.15); 
            --glass-highlight: rgba(255, 255, 255, 0.08); 
            --accent: #8b5cf6; 
            --accent-secondary: #6366f1;
            --accent-glow: rgba(139, 92, 246, 0.5); 
            --text: #f8fafc; 
            --text-muted: #94a3b8; 
            --success: #10b981; 
            --success-glow: rgba(16, 185, 129, 0.4);
            --danger: #ef4444; 
            --danger-glow: rgba(239, 68, 68, 0.4);
            --gold: #fbbf24; 
            --gold-glow: rgba(251, 191, 36, 0.5); 
            --puro: #f97316; 
            --puro-glow: rgba(249, 115, 22, 0.5);
            --bringme: #8b5cf6; 
            --cyan: #06b6d4;
            --cyan-glow: rgba(6, 182, 212, 0.4);
            
            --spacing-xs: 8px;
            --spacing-sm: 12px;
            --spacing-md: 16px;
            --spacing-lg: 20px;
            --spacing-xl: 24px;
            --spacing-2xl: 32px;
            
            --radius-sm: 12px;
            --radius-md: 16px;
            --radius-lg: 20px;
            --radius-xl: 24px;
            --radius-full: 9999px;
            
            --shadow-card: 0 8px 32px rgba(0, 0, 0, 0.4), 0 2px 8px rgba(0, 0, 0, 0.3); 
            --shadow-hover: 0 12px 48px rgba(139, 92, 246, 0.3), 0 4px 12px rgba(0, 0, 0, 0.4);
            --shadow-active: 0 4px 16px rgba(139, 92, 246, 0.4);
        }
        * { box-sizing: border-box; }
        body { 
            font-family: 'Inter', sans-serif; 
            background: var(--bg-gradient); 
            background-attachment: fixed; 
            color: var(--text); 
            margin: 0; 
            padding: var(--spacing-lg); 
            display: grid; 
            grid-template-columns: 300px 1fr 280px; 
            gap: var(--spacing-lg); 
            height: 100vh; 
            overflow: hidden;
            position: relative;
        }
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: 
                radial-gradient(circle at 20% 30%, rgba(139, 92, 246, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 80% 70%, rgba(99, 102, 241, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 50% 50%, rgba(6, 182, 212, 0.05) 0%, transparent 50%);
            pointer-events: none;
            z-index: 0;
            animation: float-bg 20s ease-in-out infinite;
        }
        body > * {
            position: relative;
            z-index: 1;
        }
        @keyframes float-bg {
            0%, 100% { opacity: 0.6; transform: scale(1); }
            50% { opacity: 1; transform: scale(1.1); }
        }
        ::-webkit-scrollbar { width: 8px; } 
        ::-webkit-scrollbar-track { background: rgba(0, 0, 0, 0.2); border-radius: 10px; } 
        ::-webkit-scrollbar-thumb { 
            background: linear-gradient(135deg, var(--accent), var(--accent-secondary)); 
            border-radius: 10px; 
            box-shadow: 0 0 6px var(--accent-glow);
        }
        ::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(135deg, #a78bfa, #818cf8);
        }
        .card, .sidebar, .tabs-nav, .activity-panel { 
            background: var(--glass-surface); 
            backdrop-filter: blur(20px); 
            -webkit-backdrop-filter: blur(20px); 
            border: 2px solid var(--glass-border); 
            box-shadow: var(--shadow-card); 
            position: relative;
        }
        .card::before, .sidebar::before, .activity-panel::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 1px;
            background: linear-gradient(90deg, transparent, var(--accent), transparent);
            opacity: 0.5;
        }
        .sidebar { border-radius: var(--radius-lg); padding: var(--spacing-lg); overflow-y: auto; display: flex; flex-direction: column; gap: var(--spacing-md); height: calc(100vh - 40px); }
        .activity-panel { border-radius: var(--radius-lg); padding: var(--spacing-lg); overflow-y: hidden; display: flex; flex-direction: column; height: calc(100vh - 40px); }
        .logo-text { 
            font-size: 26px; 
            font-weight: 900; 
            letter-spacing: -1.5px; 
            text-transform: uppercase; 
            background: linear-gradient(135deg, #8b5cf6, #6366f1, #06b6d4, #8b5cf6); 
            background-size: 300% 300%;
            -webkit-background-clip: text; 
            -webkit-text-fill-color: transparent; 
            margin-bottom: var(--spacing-md); 
            text-shadow: 0 0 30px rgba(139, 92, 246, 0.3);
            animation: gradientShift 8s ease infinite;
            filter: drop-shadow(0 2px 4px rgba(139, 92, 246, 0.5));
        }
        @keyframes gradientShift {
            0%, 100% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
        }
        .stat-grid { display: grid; grid-template-columns: 1fr 1fr; gap: var(--spacing-sm); }
        .stat-card { 
            background: linear-gradient(145deg, rgba(139, 92, 246, 0.1), rgba(0, 0, 0, 0.3)); 
            padding: var(--spacing-md); 
            border-radius: var(--radius-md); 
            text-align: center; 
            border: 1.5px solid var(--glass-border); 
            position: relative; 
            overflow: hidden;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            cursor: pointer;
        }
        .stat-card:hover {
            transform: translateY(-3px);
            border-color: var(--accent);
            box-shadow: 0 8px 24px var(--accent-glow);
        }
        .stat-card::before { 
            content: ''; 
            position: absolute; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 3px; 
            background: linear-gradient(90deg, transparent, var(--accent), var(--cyan), transparent); 
            animation: shimmer 3s linear infinite;
        }
        @keyframes shimmer {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }
        .stat-val { 
            font-size: 24px; 
            font-weight: 900; 
            background: linear-gradient(135deg, #fff, var(--accent)); 
            -webkit-background-clip: text; 
            -webkit-text-fill-color: transparent;
            text-shadow: none;
            filter: drop-shadow(0 0 12px var(--accent-glow));
        }
        .stat-lbl { 
            font-size: 10px; 
            color: var(--text-muted); 
            font-weight: 700; 
            letter-spacing: 1.5px; 
            margin-top: 6px;
            text-transform: uppercase; 
        }
        .tabs-nav { 
            display: flex; 
            gap: 6px; 
            margin-bottom: var(--spacing-lg); 
            padding: var(--spacing-sm); 
            border-radius: var(--radius-xl); 
            background: linear-gradient(145deg, rgba(139, 92, 246, 0.05), rgba(0, 0, 0, 0.3));
        }
        .tab-btn { 
            flex: 1; 
            padding: var(--spacing-md); 
            border-radius: var(--radius-md); 
            border: none; 
            background: transparent; 
            color: var(--text-muted); 
            font-weight: 700; 
            cursor: pointer; 
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            gap: var(--spacing-xs); 
            font-size: 13px;
            position: relative;
            overflow: hidden;
        }
        .tab-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(139, 92, 246, 0.2), transparent);
            transition: left 0.5s;
        }
        .tab-btn:hover::before {
            left: 100%;
        }
        .tab-btn:hover { 
            background: rgba(139, 92, 246, 0.1); 
            color: var(--accent); 
            transform: translateY(-2px);
        }
        .tab-btn.active { 
            background: linear-gradient(135deg, var(--accent), var(--accent-secondary)); 
            color: white; 
            box-shadow: 0 6px 20px var(--accent-glow), inset 0 1px 0 rgba(255, 255, 255, 0.2); 
            transform: translateY(-2px); 
        }
        .tab-content { display: none; height: calc(100vh - 140px); overflow-y: auto; padding-right: var(--spacing-sm); padding-bottom: var(--spacing-lg); }
        .tab-content.active { display: block; animation: fadeIn 0.3s ease; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .winner-marquee { 
            background: linear-gradient(135deg, #fbbf24, #f59e0b, #fbbf24); 
            background-size: 200% 200%;
            animation: gradient-move 3s ease infinite;
            color: #78350f; 
            padding: var(--spacing-md); 
            font-weight: 900; 
            text-transform: uppercase; 
            white-space: nowrap; 
            overflow: hidden; 
            position: relative; 
            border-radius: var(--radius-lg); 
            margin-bottom: var(--spacing-lg); 
            display: none; 
            box-shadow: 0 0 30px var(--gold-glow), 
                        0 4px 12px rgba(0, 0, 0, 0.3),
                        inset 0 2px 0 rgba(255, 255, 255, 0.4); 
            border: 2px solid #fde68a;
            text-shadow: 0 1px 2px rgba(255, 255, 255, 0.5);
        }
        @keyframes gradient-move {
            0%, 100% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
        }
        .marquee-text { display: inline-block; animation: marquee 15s linear infinite; }
        @keyframes marquee { 0% { transform: translateX(100%); } 100% { transform: translateX(-100%); } }
        .cards-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap: var(--spacing-md); }
        .user-card-monitor { 
            background: linear-gradient(145deg, rgba(30, 41, 59, 0.8), rgba(15, 23, 42, 0.9)); 
            padding: var(--spacing-md); 
            border-radius: var(--radius-lg); 
            border: 2px solid var(--glass-border); 
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1); 
            position: relative; 
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            overflow: hidden;
        }
        .user-card-monitor::after {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(139, 92, 246, 0.1), transparent 70%);
            opacity: 0;
            transition: opacity 0.4s;
        }
        .user-card-monitor:hover::after {
            opacity: 1;
        }
        .user-card-monitor:hover {
            transform: translateY(-5px);
            border-color: var(--accent);
            box-shadow: 0 12px 32px rgba(139, 92, 246, 0.3);
        }
        .user-card-monitor.offline { 
            opacity: 0.35; 
            filter: grayscale(100%); 
            border: 1.5px dashed #334155; 
            background: rgba(15, 23, 42, 0.4); 
            transform: scale(0.97); 
        }
        .user-card-monitor.puro { 
            border-color: var(--puro); 
            box-shadow: 0 0 20px var(--puro-glow), 0 4px 12px rgba(0, 0, 0, 0.3); 
            animation: pulse-puro 2s ease-in-out infinite; 
            background: linear-gradient(145deg, rgba(249, 115, 22, 0.15), rgba(15, 23, 42, 0.9)); 
        }
        .user-card-monitor.bingo { 
            border-color: var(--success); 
            background: linear-gradient(145deg, rgba(16, 185, 129, 0.2), rgba(6, 78, 59, 0.9)); 
            box-shadow: 0 0 30px var(--success-glow), 0 8px 24px rgba(0, 0, 0, 0.4); 
            transform: scale(1.08) translateY(-8px); 
            z-index: 10;
            animation: bingo-pulse 1s ease-in-out infinite;
        }
        @keyframes bingo-pulse {
            0%, 100% { box-shadow: 0 0 30px var(--success-glow), 0 8px 24px rgba(0, 0, 0, 0.4); }
            50% { box-shadow: 0 0 40px var(--success-glow), 0 12px 32px rgba(0, 0, 0, 0.5); }
        }
        .monitor-badge { 
            position: absolute; 
            top: -10px; 
            right: -10px; 
            padding: 6px var(--spacing-md); 
            border-radius: var(--radius-full); 
            font-size: 10px; 
            font-weight: 900; 
            color: white; 
            display: none; 
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4); 
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
            border: 2px solid rgba(255, 255, 255, 0.2);
            animation: badge-float 2s ease-in-out infinite;
        }
        @keyframes badge-float {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-4px); }
        }
        .puro .monitor-badge { 
            display: block; 
            background: linear-gradient(135deg, var(--puro), #fb923c); 
            content: "PURO!"; 
        }
        .bingo .monitor-badge { 
            display: block; 
            background: linear-gradient(135deg, var(--success), #34d399); 
            content: "BINGO!"; 
        }
        @keyframes pulse-puro { 0% { box-shadow: 0 0 0 0 rgba(249, 115, 22, 0.4); } 70% { box-shadow: 0 0 0 10px rgba(249, 115, 22, 0); } 100% { box-shadow: 0 0 0 0 rgba(249, 115, 22, 0); } }
        .mini-bingo-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 3px; margin-top: var(--spacing-sm); }
        .mini-cell { 
            aspect-ratio: 1; 
            background: rgba(15, 23, 42, 0.8); 
            font-size: 9px; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            border-radius: 5px; 
            color: rgba(255, 255, 255, 0.3); 
            font-weight: 800;
            border: 1px solid rgba(139, 92, 246, 0.1);
            transition: all 0.2s;
        }
        .mini-cell.marked { 
            background: linear-gradient(135deg, var(--accent), var(--accent-secondary)); 
            color: white; 
            box-shadow: 0 0 8px var(--accent-glow), 
                        inset 0 1px 0 rgba(255, 255, 255, 0.3); 
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .mini-cell.hit { 
            background: linear-gradient(135deg, #fbbf24, #f59e0b); 
            color: #78350f; 
            box-shadow: 0 0 12px var(--gold-glow), 
                        inset 0 1px 0 rgba(255, 255, 255, 0.4); 
            animation: pop 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); 
            border: 1px solid rgba(255, 255, 255, 0.3);
        } 
        @keyframes pop { 0% { transform: scale(0.5); } 100% { transform: scale(1); } }
        .ball-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(45px, 1fr)); gap: var(--spacing-xs); margin-top: var(--spacing-md); }
        .ball { 
            aspect-ratio: 1; 
            background: linear-gradient(145deg, #334155, #1e293b); 
            border-radius: 50%; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            font-weight: 900; 
            cursor: pointer; 
            font-size: 15px; 
            border: 2px solid var(--glass-border); 
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); 
            box-shadow: inset 3px 3px 8px rgba(255, 255, 255, 0.08), 
                        inset -3px -3px 8px rgba(0, 0, 0, 0.5),
                        0 6px 16px rgba(0, 0, 0, 0.4); 
            position: relative;
            color: #cbd5e1;
        }
        .ball::after { 
            content: ''; 
            position: absolute; 
            top: 12%; 
            left: 18%; 
            width: 30%; 
            height: 30%; 
            background: radial-gradient(circle, rgba(255, 255, 255, 0.9), transparent); 
            border-radius: 50%; 
            opacity: 0.6; 
        }
        .ball:hover { 
            transform: translateY(-4px) scale(1.05); 
            border-color: var(--accent); 
            box-shadow: inset 3px 3px 8px rgba(255, 255, 255, 0.1), 
                        inset -3px -3px 8px rgba(0, 0, 0, 0.5),
                        0 8px 24px var(--accent-glow);
        }
        .ball.drawn { 
            background: linear-gradient(145deg, #a78bfa, #8b5cf6, #7c3aed); 
            color: white; 
            box-shadow: 0 0 20px var(--accent-glow), 
                        0 8px 24px rgba(139, 92, 246, 0.6),
                        inset -5px -5px 15px rgba(0, 0, 0, 0.3),
                        inset 5px 5px 15px rgba(255, 255, 255, 0.2); 
            border: 2px solid rgba(255, 255, 255, 0.3); 
            transform: scale(1.15); 
            animation: ball-glow 2s ease-in-out infinite;
        }
        @keyframes ball-glow {
            0%, 100% { box-shadow: 0 0 20px var(--accent-glow), 0 8px 24px rgba(139, 92, 246, 0.6); }
            50% { box-shadow: 0 0 30px var(--accent-glow), 0 12px 32px rgba(139, 92, 246, 0.8); }
        }
        .input-group { margin-bottom: var(--spacing-lg); }
        label { display: block; font-size: 11px; font-weight: 800; color: var(--text-muted); margin-bottom: var(--spacing-xs); text-transform: uppercase; letter-spacing: 0.5px; }
        input, select, textarea { 
            width: 100%; 
            background: rgba(15, 23, 42, 0.6); 
            border: 2px solid var(--glass-border); 
            padding: 16px; 
            border-radius: var(--radius-md); 
            color: white; 
            outline: none; 
            font-family: inherit; 
            font-size: 14px; 
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.2);
        }
        input:focus, select:focus, textarea:focus { 
            border-color: var(--accent); 
            background: rgba(15, 23, 42, 0.8); 
            box-shadow: 0 0 0 4px rgba(139, 92, 246, 0.15), 
                        inset 0 2px 4px rgba(0, 0, 0, 0.2);
            transform: translateY(-1px);
        }
        input:hover, select:hover, textarea:hover {
            border-color: rgba(139, 92, 246, 0.4);
        }
        .btn { 
            width: 100%; 
            padding: 16px; 
            border-radius: var(--radius-md); 
            border: none; 
            font-weight: 800; 
            cursor: pointer; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            gap: var(--spacing-xs); 
            margin-top: var(--spacing-sm); 
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); 
            text-transform: uppercase; 
            font-size: 13px; 
            letter-spacing: 0.8px; 
            position: relative; 
            overflow: hidden;
        }
        .btn::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.2);
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }
        .btn:hover::before {
            width: 300px;
            height: 300px;
        }
        .btn:active { 
            transform: scale(0.96); 
        }
        .btn-primary { 
            background: linear-gradient(135deg, #8b5cf6, #7c3aed, #6d28d9); 
            color: white; 
            box-shadow: 0 6px 20px rgba(139, 92, 246, 0.5), 
                        inset 0 1px 0 rgba(255, 255, 255, 0.2); 
        }
        .btn-primary:hover { 
            box-shadow: 0 8px 28px rgba(139, 92, 246, 0.7), 
                        inset 0 1px 0 rgba(255, 255, 255, 0.2);
            transform: translateY(-2px);
        }
        .btn-danger { 
            background: linear-gradient(135deg, #ef4444, #dc2626, #b91c1c); 
            color: white; 
            box-shadow: 0 6px 20px rgba(239, 68, 68, 0.5), 
                        inset 0 1px 0 rgba(255, 255, 255, 0.2); 
        }
        .btn-danger:hover {
            box-shadow: 0 8px 28px rgba(239, 68, 68, 0.7);
            transform: translateY(-2px);
        }
        .btn-bringme { 
            background: linear-gradient(135deg, #8b5cf6, #7c3aed, #6366f1); 
            color: white; 
            box-shadow: 0 6px 20px rgba(139, 92, 246, 0.5), 
                        inset 0 1px 0 rgba(255, 255, 255, 0.2); 
        }
        .btn-bringme:hover {
            box-shadow: 0 8px 28px rgba(139, 92, 246, 0.7);
            transform: translateY(-2px);
        }
        .btn-gold { 
            background: linear-gradient(135deg, #fbbf24, #f59e0b, #d97706); 
            color: #78350f; 
            box-shadow: 0 6px 20px rgba(251, 191, 36, 0.5), 
                        inset 0 1px 0 rgba(255, 255, 255, 0.3);
            text-shadow: 0 1px 2px rgba(255, 255, 255, 0.5);
        }
        .btn-gold:hover {
            box-shadow: 0 8px 28px rgba(251, 191, 36, 0.7);
            transform: translateY(-2px);
        }
        .online-dot { 
            width: 10px; 
            height: 10px; 
            background: var(--success); 
            border-radius: 50%; 
            box-shadow: 0 0 12px var(--success-glow), 
                        0 0 4px var(--success); 
            display: inline-block;
            animation: pulse-online 2s ease-in-out infinite;
        }
        @keyframes pulse-online {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.7; transform: scale(0.9); }
        }
        .offline-dot { 
            width: 10px; 
            height: 10px; 
            background: #475569; 
            border-radius: 50%; 
            display: inline-block; 
            border: 1.5px solid var(--glass-border); 
            opacity: 0.6;
        }
        .status-badge { 
            padding: 6px var(--spacing-md); 
            border-radius: var(--radius-full); 
            font-size: 10px; 
            font-weight: 900; 
            text-transform: uppercase;
            letter-spacing: 0.5px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        }
        .status-active { 
            background: linear-gradient(135deg, var(--success), #34d399); 
            color: white; 
            box-shadow: 0 0 15px var(--success-glow), 
                        0 2px 8px rgba(0, 0, 0, 0.2); 
        }
        .status-off { 
            background: linear-gradient(135deg, var(--danger), #dc2626); 
            color: white; 
            opacity: 0.8; 
        }
        .search-box { position: relative; margin-bottom: var(--spacing-md); }
        .search-box input { padding-right: 40px; }
        .search-icon { position: absolute; right: 14px; top: 50%; transform: translateY(-50%); color: var(--text-muted); pointer-events: none; }
        .verified-badge-inline { display: inline-flex; align-items: center; gap: 4px; padding: 2px 6px; background: rgba(59, 130, 246, 0.2); border: 1px solid #3b82f6; border-radius: 12px; font-size: 9px; font-weight: 700; color: #3b82f6; }
        .btn-verified { background: linear-gradient(135deg, #3b82f6, #2563eb); color: white; box-shadow: 0 4px 15px rgba(37, 99, 235, 0.4); }
        .btn-verified:hover { filter: brightness(1.1); }
        .grant-section { background: rgba(0,0,0,0.2); border-radius: var(--radius-md); padding: var(--spacing-lg); margin-bottom: var(--spacing-lg); border: 1px solid var(--glass-border); }
        .card { padding: var(--spacing-xl); border-radius: var(--radius-lg); margin-bottom: var(--spacing-xl); }
        h2 { margin-top: 0; font-size: 16px; font-weight: 700; display: flex; align-items: center; gap: var(--spacing-xs); margin-bottom: var(--spacing-lg); color: white; }
        .user-select-list { max-height: 250px; overflow-y: auto; background: rgba(0,0,0,0.2); border-radius: var(--radius-md); padding: 5px; border: 1px solid var(--glass-border); }
        .user-option { padding: var(--spacing-sm) var(--spacing-sm); border-radius: var(--radius-sm); cursor: pointer; font-size: 12px; display: flex; justify-content: space-between; border-bottom: 1px solid rgba(255,255,255,0.03); transition: 0.2s; }
        .user-option:hover { background: rgba(255,255,255,0.05); }
        .user-option.selected { background: var(--accent); color: white; border: none; }
        .card-settings { background: rgba(15, 23, 42, 0.4); border: 1px solid var(--glass-border); padding: var(--spacing-md); border-radius: var(--radius-md); margin-bottom: var(--spacing-sm); }
        /* Live Activity */
        .live-log-item { font-size: 11px; padding: var(--spacing-sm); border-bottom: 1px solid rgba(255,255,255,0.05); animation: flash 1s ease; }
        @keyframes flash { 0% { background: rgba(99, 102, 241, 0.3); } 100% { background: transparent; } }
        .log-pos { color: var(--success); font-weight: 700; }
        .log-neg { color: var(--danger); font-weight: 700; }
        
        /* Content Creator Styles */
        .creator-badge { 
            display: inline-flex; 
            align-items: center; 
            gap: 4px; 
            background: linear-gradient(135deg, #f59e0b, #d97706); 
            padding: 3px 10px; 
            border-radius: 12px; 
            font-size: 9px; 
            font-weight: 700; 
            text-transform: uppercase; 
            letter-spacing: 0.5px; 
            box-shadow: 0 2px 8px rgba(245, 158, 11, 0.5); 
            color: white; 
        }
        .creator-badge i { width: 12px; height: 12px; }
        .creator-card { 
            border-left: 3px solid #f59e0b !important; 
            background: linear-gradient(135deg, rgba(245, 158, 11, 0.05), rgba(0, 0, 0, 0.3)); 
        }
        .btn-creator { 
            border-color: #f59e0b; 
            background: linear-gradient(135deg, #f59e0b, #d97706); 
            box-shadow: 0 4px 12px rgba(245, 158, 11, 0.5); 
        }
        .btn-creator:hover { 
            box-shadow: 0 8px 24px rgba(245, 158, 11, 0.6); 
        }
        
        /* Creator Post Card Styles */
        .creator-post-card {
            background: linear-gradient(145deg, rgba(30, 41, 59, 0.8), rgba(15, 23, 42, 0.9));
            border: 2px solid rgba(245, 158, 11, 0.2);
            border-radius: var(--radius-lg);
            padding: var(--spacing-md);
            margin-bottom: var(--spacing-md);
            transition: all 0.3s ease;
        }
        .creator-post-card:hover {
            border-color: rgba(245, 158, 11, 0.4);
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(245, 158, 11, 0.2);
        }
        .post-content-text {
            color: var(--text);
            margin: var(--spacing-sm) 0;
            font-size: 14px;
            line-height: 1.5;
        }
        .post-image-preview {
            width: 100%;
            max-height: 300px;
            object-fit: cover;
            border-radius: var(--radius-md);
            margin: var(--spacing-sm) 0;
        }
        .post-stats {
            display: flex;
            gap: var(--spacing-md);
            margin-top: var(--spacing-sm);
            padding-top: var(--spacing-sm);
            border-top: 1px solid rgba(255,255,255,0.05);
            font-size: 12px;
            color: var(--text-muted);
        }
        .reaction-control-panel {
            background: rgba(139, 92, 246, 0.05);
            border: 1px solid rgba(139, 92, 246, 0.2);
            border-radius: var(--radius-md);
            padding: var(--spacing-sm);
            margin-top: var(--spacing-sm);
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
        }
        .reaction-input {
            width: 80px;
            padding: 6px 10px;
            background: rgba(0,0,0,0.3);
            border: 1px solid rgba(139,92,246,0.3);
            color: white;
            border-radius: 8px;
            text-align: center;
            font-weight: 700;
        }
        .add-reaction-btn {
            padding: 6px 12px;
            background: linear-gradient(135deg, var(--accent), var(--accent-secondary));
            border: none;
            color: white;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 700;
            font-size: 11px;
            transition: all 0.3s;
        }
        .add-reaction-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px var(--accent-glow);
        }
        
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        
        @media (max-width: 1100px) { body { grid-template-columns: 250px 1fr; overflow-y: auto; height: auto; } .activity-panel { display: none; } }
        @media (max-width: 900px) { body { grid-template-columns: 1fr; } .sidebar { height: auto; max-height: 500px; } .tab-content { height: auto; overflow: visible; } .main-section { padding-bottom: 50px; } }
    </style>
</head>
<body>

<div id="lockScreen" style="position:fixed; inset:0; background:#0f0f14; z-index:999999; display:flex; flex-direction:column; align-items:center; justify-content:center; color:white;">
    <div style="width: 80px; height: 80px; background: rgba(255,255,255,0.1); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-bottom: 20px; box-shadow: 0 0 30px rgba(99, 102, 241, 0.3);">
        <i data-lucide="lock" style="width: 40px; height: 40px; color: var(--accent);"></i>
    </div>
    <div style="font-size:24px; font-weight:900; margin-bottom:10px; letter-spacing: -1px;">ADMIN <span style="color:var(--accent);">LOCKED</span></div>
    <p style="opacity: 0.6; font-size: 12px; margin-bottom: 30px;">Enter security PIN to access control panel.</p>
    <div style="display:flex; gap:10px;">
        <input type="password" id="adminPassInput" placeholder="Enter PIN" style="width:180px; padding:12px; text-align:center; border-radius:12px; border:1px solid #334155; background:#1e293b; color:white; font-weight:900; letter-spacing: 2px; outline: none;">
        <button onclick="checkAdminLock()" class="btn btn-primary" style="width:auto; padding:12px 20px; margin:0;"><i data-lucide="arrow-right"></i></button>
    </div>
</div>

<div class="sidebar">
    <div class="logo-text">ADMIN<span style="color:var(--accent)">PANEL</span> <span style="font-size:10px; vertical-align:middle; background:var(--gold); color:black; padding:2px 6px; border-radius:4px;">PRO</span></div>
    
    <div class="stat-grid">
        <div class="stat-card"><div class="stat-val" id="countOnline">0</div><div class="stat-lbl">ONLINE</div></div>
        <div class="stat-card"><div class="stat-val" id="countUsers">0</div><div class="stat-lbl">TOTAL</div></div>
    </div>

    <div class="card" style="padding: 15px; margin: 0; background: linear-gradient(145deg, rgba(245, 158, 11, 0.1), rgba(0,0,0,0)); border: 1px solid rgba(245, 158, 11, 0.3);">
        <label style="color:var(--gold)"><i data-lucide="trophy" style="width:12px"></i> Jackpot Prize</label>
        <input type="text" id="jackpotAmount" placeholder="e.g. 5000" style="margin-bottom:10px; text-align:center; font-weight:900; color:var(--gold); font-size:18px;">
        <div style="display:flex; align-items:center; gap:10px; cursor:pointer;" id="jackpotToggle" onclick="toggleJackpot()">
            <div style="width:44px; height:24px; background:rgba(0,0,0,0.3); border-radius:20px; position:relative; transition:0.3s;" id="jackpotKnobBg">
                <div style="width:18px; height:18px; background:white; border-radius:50%; position:absolute; top:3px; left:3px; transition:0.3s;" id="jackpotKnob"></div>
            </div>
            <span id="jackpotStatusText" style="font-size:10px; font-weight:800; color:var(--text-muted)">HIDDEN</span>
        </div>
    </div>

    <div class="card" style="padding: 15px; margin: 0; background: rgba(99, 102, 241, 0.1); border: 1px solid rgba(99, 102, 241, 0.2);">
        <label style="color:var(--accent-glow)"><i data-lucide="video" style="width:12px"></i> Video Stream Manager</label>
        <input type="text" id="videoUrlInput" placeholder="Paste YouTube Link or ID here..." style="margin-bottom:10px;">
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:8px;">
            <button class="btn btn-primary" onclick="updateVideoFeed()" style="padding: 8px;">GO LIVE</button>
            <button class="btn btn-danger" onclick="setStreamOffline()" style="padding: 8px; background:rgba(255,255,255,0.1); border:1px solid rgba(255,255,255,0.2); box-shadow:none;">GO OFFLINE</button>
        </div>
        <div style="font-size:10px; margin-top:5px; opacity:0.7;">Offline = Shows "Waiting for Live" to players.</div>
    </div>

    <div class="input-group">
        <label>Game Schedule Manager</label>
        <div style="display: flex; gap: 8px;">
            <input type="datetime-local" id="schedInput" style="padding:10px;">
            <button class="btn btn-primary" onclick="addSchedule()" style="width: auto; margin-top: 0; padding:0 15px;">+</button>
        </div>
        <div id="scheduleList" style="margin-top:10px; max-height:100px; overflow-y:auto;"></div>
    </div>

    <div class="card" style="padding: 15px; background: rgba(0,0,0,0.2); flex:1; overflow:hidden; display:flex; flex-direction:column; margin:0;">
        <label>Active Users List (Online)</label>
        <div id="activeUsersList" style="flex:1; overflow-y: auto; font-size: 12px; margin-top:5px;"></div>
    </div>

    <button class="btn btn-danger" onclick="resetGame()"><i data-lucide="refresh-ccw"></i> RESET GAME</button>
</div>

<div class="main-section">
    <div id="winnerAnnounce" class="winner-marquee">
        <div class="marquee-text" id="winnerMarqueeText">MAY NANALO NA! CONGRATULATIONS SA ATING WINNER! ðŸŽ‰</div>
    </div>

    <div class="tabs-nav">
        <button class="tab-btn active" onclick="openTab('bingo-tab', this)"><i data-lucide="layout-grid" width="16"></i> BINGO</button>
        <button class="tab-btn" onclick="openTab('settings-tab', this)"><i data-lucide="sliders" width="16"></i> SETTINGS</button>
        <button class="tab-btn" onclick="openTab('users-tab', this)"><i data-lucide="user-cog" width="16"></i> PLAYERS</button>
        <button class="tab-btn" onclick="openTab('creators-tab', this)"><i data-lucide="star" width="16"></i> CREATORS</button>
        <button class="tab-btn" onclick="openTab('verification-tab', this)"><i data-lucide="shield-check" width="16"></i> VERIFICATION</button>
        <button class="tab-btn" onclick="openTab('cashout-tab', this)"><i data-lucide="wallet" width="16"></i> CASHOUTS</button>
        <button class="tab-btn" onclick="openTab('support-tab', this)"><i data-lucide="message-square" width="16"></i> SUPPORT</button>
    </div>

    <div id="settings-tab" class="tab-content">
        <div class="card">
            <h2><i data-lucide="image"></i> Custom Pop-up Banner Manager</h2>
            <div class="card-settings" style="background: rgba(99, 102, 241, 0.05); border-color: var(--accent);">
                <p style="font-size:11px; opacity:0.7; margin:0 0 10px 0;">This banner will pop up when users open the app. They can click it to visit a link.</p>
                
                <label>Banner Image URL (Required)</label>
                <input type="text" id="bannerImgInput" placeholder="e.g. https://imgur.com/example.png" style="margin-bottom:10px;">
                
                <label>Target Link (Where to go when clicked)</label>
                <input type="text" id="bannerLinkInput" placeholder="e.g. https://facebook.com/mypage" style="margin-bottom:10px;">
                
                <div style="display:flex; gap:10px; margin-top:10px; align-items:center;">
                    <button class="btn btn-primary" onclick="saveBannerSettings(true)" style="margin-top:0;"><i data-lucide="save"></i> SAVE & ACTIVATE</button>
                    <button class="btn btn-danger" onclick="saveBannerSettings(false)" style="margin-top:0; background:rgba(255,255,255,0.1); border:1px solid rgba(255,255,255,0.2); box-shadow:none;">DISABLE BANNER</button>
                </div>
            </div>
        </div>

        <div class="card">
            <h2><i data-lucide="shield"></i> Service Account (Push Notifications)</h2>
            <div class="card-settings" style="background:rgba(239, 68, 68, 0.1); border-color:var(--danger);">
                <p style="font-size:11px; color:#fca5a5; margin:0 0 10px 0;"><i data-lucide="alert-triangle" style="width:12px"></i> <b>IMPORTANT:</b> The Legacy API is disabled. Paste your Firebase Service Account JSON here to enable push notifications (HTTP v1).</p>
                <textarea id="serviceAccountJson" rows="5" placeholder='Paste contents of service-account.json here...' style="font-family:monospace; font-size:10px;"></textarea>
                <button class="btn btn-primary" onclick="saveServiceAccount()">SAVE CREDENTIALS</button>
            </div>
        </div>
        <div class="card">
            <h2><i data-lucide="joystick"></i> Mini Game Probabilities</h2>
            <div class="card-settings">
                <label>Global Win Rate (%) - ALL GAMES (Roulette, Slots, Color, Dice, Lucky9, etc.)</label>
                <div style="display:flex; gap:10px; align-items:center;">
                    <input type="range" min="10" max="90" value="40" id="winRateSlider" oninput="updateSettingsUI()">
                    <span id="winRateDisplay" style="font-weight:900; width:50px;">40%</span>
                </div>
                <p style="font-size:10px; opacity:0.6;">Sets the winning chance for ALL mini games.</p>
            </div>
            <div class="card-settings">
                <label>Scatter Chance (%) - Candy Smash</label>
                <div style="display:flex; gap:10px; align-items:center;">
                    <input type="range" min="1" max="20" value="3" id="scatterSlider" oninput="updateSettingsUI()">
                    <span id="scatterDisplay" style="font-weight:900; width:50px;">3%</span>
                </div>
                <p style="font-size:10px; opacity:0.6;">Percentage chance for a Scatter (Lollipop) to appear on grid.</p>
            </div>
            <button class="btn btn-primary" onclick="saveGameSettings()">SAVE SETTINGS</button>
        </div>
    </div>

    <div id="bingo-tab" class="tab-content active">
        <div style="display:grid; grid-template-columns: 1fr 2fr; gap: 24px; align-items:start;">
            <div class="card">
                <h2><i data-lucide="settings"></i> Game Control</h2>
                <div class="input-group">
                    <label>Winning Pattern</label>
                    <select id="patternSelect" onchange="setPattern(this.value)">
                        <option value="Normal Bingo">Normal Bingo</option>
                        <option value="Blackout">Blackout</option>
                        <option value="Letter X">Letter X</option>
                        <option value="Four Corners">Four Corners</option>
                    </select>
                </div>
                <div style="background: rgba(16, 185, 129, 0.05); border: 1px solid rgba(16, 185, 129, 0.3); padding: 15px; border-radius: 16px; margin-bottom: 20px;">
                    <label style="color:var(--success); margin-bottom:8px; display:flex; justify-content:space-between;">
                        <span>AUTO DRAW MACHINE</span>
                        <span id="speedVal" style="color:white;">8s</span>
                    </label>
                    <div style="display:flex; gap:10px; align-items:center; margin-bottom:15px;">
                        <input type="range" id="drawSpeed" min="3" max="15" value="8" style="flex:1; accent-color: var(--success);" oninput="document.getElementById('speedVal').innerText=this.value+'s'">
                    </div>
                    <button class="btn btn-primary" id="btnAutoDraw" onclick="toggleAutoDraw()" style="background: linear-gradient(135deg, #059669, #047857); box-shadow: 0 4px 15px rgba(5, 150, 105, 0.4);">
                        <i data-lucide="play"></i> START AUTO DRAW
                    </button>
                </div>
                <div class="input-group">
                    <label>Current Ball</label>
                    <div id="lastBall" style="font-size: 70px; font-weight: 900; text-align: center; color: white; background: linear-gradient(145deg, var(--accent), #1e40af); border-radius: 20px; padding: 15px; box-shadow: 0 10px 20px rgba(0,0,0,0.3); text-shadow: 0 2px 5px rgba(0,0,0,0.3); border:1px solid rgba(255,255,255,0.2);">--</div>
                </div>
                <div style="font-size:10px; font-weight:800; opacity:0.5; margin-top:20px; letter-spacing:1px;">MANUAL OVERRIDE:</div>
                <div class="ball-grid" id="ballGrid"></div>
            </div>
            <div class="card">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                    <h2><i data-lucide="users"></i> Live Cards Monitoring</h2>
                    <div style="font-size:11px; display:flex; gap:15px; font-weight:600;">
                        <span style="display:flex; align-items:center; gap:6px"><div style="width:10px; height:10px; background:var(--puro); border-radius:3px;"></div> PURO</span>
                        <span style="display:flex; align-items:center; gap:6px"><div style="width:10px; height:10px; background:var(--success); border-radius:3px;"></div> BINGO</span>
                        <span style="display:flex; align-items:center; gap:6px"><div style="width:10px; height:10px; background:#475569; border-radius:3px; border:1px solid #64748b;"></div> OFFLINE</span>
                    </div>
                </div>
                <div class="cards-grid" id="liveCardsContainer"></div>
            </div>
        </div>
    </div>
    
    <div id="users-tab" class="tab-content">
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap: 24px;">
            <div class="card">
                <h2><i data-lucide="coins"></i> Manage Points</h2>
                <div class="input-group"><label>Select User</label><div id="pointsUserList" class="user-select-list"></div><input type="hidden" id="selectedUserForPoints"></div>
                <div class="input-group"><label>Amount (+ or -)</label><input type="number" id="pointsAmount" placeholder="e.g. 500 or -500"></div>
                <button class="btn btn-primary" onclick="modifyUserPoints()">UPDATE POINTS & LOG</button>
            </div>
            <div class="card">
                <h2><i data-lucide="send"></i> Send Notification / Task</h2>
                <div class="input-group"><label>Recipient</label><select id="notifRecipient"><option value="all">ALL USERS (Include Push)</option><option value="selected">Selected User Only (From Left)</option></select></div>
                <div class="input-group"><label>Message / Announcement</label><textarea id="notifMessage" rows="5" placeholder="e.g. 5 Mins na lang BOLA NA!"></textarea></div>
                <button class="btn btn-bringme" onclick="sendAdminNotification()">SEND PUSH NOTIFICATION (HTTP v1)</button>
                <div id="sendStatus" style="font-size:10px; margin-top:5px; color:var(--text-muted);"></div>
            </div>
            
            <div class="card" style="grid-column: 1 / -1;">
                <h2><i data-lucide="history"></i> Points Transaction Logs <span id="historyUserName" style="color:var(--accent); margin-left:10px;">(Select a User)</span></h2>
                <div style="font-size:11px; opacity:0.6; margin-bottom:10px;">Shows: Admin Adjustments, Cashout Refunds, and Manually Logged Events. (Game bets/wins appear in "Live Activity Feed" on the right)</div>
                <div id="pointHistoryList" style="height: 250px; overflow-y: auto; background: rgba(0,0,0,0.2); padding: 15px; border-radius: 12px; border:1px solid var(--glass-border);">
                    <div style="opacity:0.5; text-align:center; padding:20px; font-size:12px;">Select a user to view their log history.</div>
                </div>
            </div>
        </div>
    </div>

    <!-- CONTENT CREATORS TAB -->
    <div id="creators-tab" class="tab-content">
        <!-- Creator Stats Overview -->
        <div class="card">
            <h2><i data-lucide="bar-chart"></i> Creator Stats Overview</h2>
            <div class="stat-grid">
                <div class="stat-card">
                    <div class="stat-val" id="totalCreatorsCount">0</div>
                    <div class="stat-lbl">Active Creators</div>
                </div>
                <div class="stat-card">
                    <div class="stat-val" id="totalFollowers">0</div>
                    <div class="stat-lbl">Total Followers</div>
                </div>
                <div class="stat-card">
                    <div class="stat-val" id="totalVideoViews">0</div>
                    <div class="stat-lbl">Total Video Views</div>
                </div>
                <div class="stat-card">
                    <div class="stat-val" id="totalCreatorPosts">0</div>
                    <div class="stat-lbl">Creator Posts</div>
                </div>
            </div>
        </div>

        <!-- Promote to Creator -->
        <div class="card">
            <h2><i data-lucide="user-plus"></i> Promote User to Content Creator</h2>
            <div style="font-size:11px; opacity:0.6; margin-bottom:15px;">Search and promote users to become content creators with 2x points and followers</div>
            
            <div class="input-group">
                <label>Search User</label>
                <input type="text" id="promote-search" placeholder="Type user name..." oninput="searchUsersForPromotion()">
            </div>
            
            <div id="promote-results" style="max-height:300px; overflow-y:auto;">
                <div style="opacity:0.5; text-align:center; padding:20px; font-size:12px;">Start typing to search users...</div>
            </div>
        </div>

        <!-- Manage Content Creators -->
        <div class="card">
            <h2><i data-lucide="users"></i> Manage Content Creators</h2>
            <div id="creator-list" style="max-height:500px; overflow-y:auto;">
                <div style="opacity:0.5; text-align:center; padding:20px; font-size:12px;">Loading creators...</div>
            </div>
        </div>
        
        <!-- Creator Posts Manager -->
        <div class="card">
            <h2><i data-lucide="image"></i> Creator Posts & Reactions</h2>
            <div style="font-size:11px; opacity:0.6; margin-bottom:15px;">
                View creator posts and add REAL reactions & comments from actual users
            </div>
            <div style="background:rgba(16, 185, 129, 0.1); border:1px solid rgba(16, 185, 129, 0.3); border-radius:8px; padding:10px; margin-bottom:15px; font-size:11px; color:#10b981;">
                <i data-lucide="info" style="width:14px; vertical-align:middle;"></i>
                <strong>Real User Engagement:</strong> Random users from your platform will be selected to react and comment on posts. Comments are randomly generated from a pool of realistic templates. All engagement includes user IDs and sends notifications to creators!
            </div>
            
            <div class="input-group">
                <label>Select Creator</label>
                <select id="post-creator-select" onchange="loadCreatorPosts(this.value)" style="padding:10px; background:rgba(0,0,0,0.3); border:1px solid rgba(139,92,246,0.3); color:white; border-radius:12px;">
                    <option value="">-- Select a Creator --</option>
                </select>
            </div>
            
            <div id="creator-posts-container" style="max-height:600px; overflow-y:auto; margin-top:15px;">
                <div style="opacity:0.5; text-align:center; padding:40px; font-size:12px;">Select a creator to view their posts</div>
            </div>
        </div>
    </div>

    <div id="verification-tab" class="tab-content">
        <!-- MANUAL GRANT SECTION -->
        <div class="card grant-section">
            <h2><i data-lucide="award"></i> Grant Verification Badge</h2>
            <div style="font-size:11px; opacity:0.6; margin-bottom:15px;">Manually grant verified badge to any user instantly</div>
            
            <div class="search-box">
                <input type="text" id="grant-user-search" placeholder="Search users by username..." oninput="searchUsersForGrant()">
                <i data-lucide="search" class="search-icon" style="width:16px;height:16px;"></i>
            </div>
            
            <div class="user-select-list" id="grant-user-list" style="max-height: 200px; margin-bottom: var(--spacing-md);">
                <div style="text-align: center; padding: 20px; color: var(--text-muted); font-size: 11px;">
                    Type to search for users...
                </div>
            </div>
            
            <button class="btn btn-verified" onclick="grantVerificationBadge()" id="grant-verify-btn" disabled>
                <i data-lucide="check-circle" style="width:16px;height:16px;"></i>
                GRANT VERIFIED BADGE
            </button>
        </div>
        
        <div class="card">
            <h2><i data-lucide="shield-check"></i> Verification Requests</h2>
            <div style="font-size:11px; opacity:0.6; margin-bottom:15px;">Review and manage user verification badge requests</div>
            
            <div style="display:flex; gap:10px; margin-bottom:15px;">
                <button class="btn btn-secondary" onclick="filterVerificationRequests('all')" id="filter-all" style="flex:1; font-size:12px; padding:8px;">All</button>
                <button class="btn btn-secondary" onclick="filterVerificationRequests('pending')" id="filter-pending" style="flex:1; font-size:12px; padding:8px; background:rgba(245, 158, 11, 0.2); border-color:rgba(245, 158, 11, 0.3);">Pending</button>
                <button class="btn btn-secondary" onclick="filterVerificationRequests('approved')" id="filter-approved" style="flex:1; font-size:12px; padding:8px;">Approved</button>
                <button class="btn btn-secondary" onclick="filterVerificationRequests('rejected')" id="filter-rejected" style="flex:1; font-size:12px; padding:8px;">Rejected</button>
            </div>
            
            <div id="verificationRequestsList" style="display:flex; flex-direction:column; gap:15px;">
                <div style="opacity:0.5; text-align:center; padding:40px; font-size:12px;">Loading verification requests...</div>
            </div>
        </div>
    </div>

    <div id="cashout-tab" class="tab-content"><div class="card"><h2><i data-lucide="wallet"></i> GCash Requests</h2><div id="cashoutList"></div></div></div>
    
    <div id="support-tab" class="tab-content">
        <div class="card">
            <h2><i data-lucide="message-square"></i> Support Messages</h2>
            <div style="font-size:11px; opacity:0.6; margin-bottom:15px;">User support requests and inquiries</div>
            <div id="supportMessagesList" style="display:flex; flex-direction:column; gap:15px;">
                <div style="opacity:0.5; text-align:center; padding:40px; font-size:12px;">Loading support messages...</div>
            </div>
        </div>
    </div>
</div>

<div class="activity-panel">
    <h2 style="font-size:13px; color:var(--text-muted); text-transform:uppercase; letter-spacing:1px;"><i data-lucide="activity" style="width:14px"></i> Live Activity Feed</h2>
    <p style="font-size:10px; opacity:0.5; margin-bottom:15px; border-bottom:1px solid rgba(255,255,255,0.1); padding-bottom:10px;">Monitors ALL user point changes in real-time (Games, Bets, Wins).</p>
    <div id="liveActivityFeed" style="flex:1; overflow-y:auto; display:flex; flex-direction:column; gap:5px;"></div>
</div>

<!-- Reject Verification Modal -->
<div id="rejectVerificationModal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.8); z-index:99999; justify-content:center; align-items:center;" onclick="this.style.display='none'">
    <div style="background:#1e293b; border-radius:16px; padding:24px; max-width:500px; width:90%;" onclick="event.stopPropagation()">
        <h3 style="margin:0 0 16px 0; color:white; font-size:18px;">Reject Verification Request</h3>
        <p style="color:rgba(255,255,255,0.7); font-size:13px; margin-bottom:16px;">Provide a reason for rejecting this verification request (optional):</p>
        <textarea id="rejectReasonInput" placeholder="e.g., Insufficient activity, Suspicious account..." style="width:100%; min-height:100px; padding:12px; background:rgba(0,0,0,0.3); border:1px solid rgba(255,255,255,0.1); border-radius:8px; color:white; font-family:inherit; font-size:13px; resize:vertical;"></textarea>
        <div style="display:flex; gap:12px; margin-top:20px;">
            <button onclick="document.getElementById('rejectVerificationModal').style.display='none'" style="flex:1; padding:12px; background:rgba(255,255,255,0.1); border:1px solid rgba(255,255,255,0.2); border-radius:8px; color:white; font-weight:600; cursor:pointer;">Cancel</button>
            <button onclick="confirmRejectVerification()" style="flex:1; padding:12px; background:#ef4444; border:none; border-radius:8px; color:white; font-weight:600; cursor:pointer;">Reject Request</button>
        </div>
    </div>
</div>

<script>
    // --- LOCK SCREEN LOGIC ---
    const ADMIN_PIN = "12345"; // <--- CHANGE THIS TO YOUR DESIRED PIN
    
    function checkAdminLock() {
        const val = document.getElementById('adminPassInput').value;
        if(val === ADMIN_PIN) {
            document.getElementById('lockScreen').style.opacity = '0';
            setTimeout(() => { document.getElementById('lockScreen').style.display = 'none'; }, 500);
            sessionStorage.setItem('admin_unlocked', 'true');
        } else {
            alert("WRONG PIN! ACCESS DENIED.");
            document.getElementById('adminPassInput').value = "";
        }
    }
    // Check if already unlocked in this session
    if(sessionStorage.getItem('admin_unlocked') === 'true') {
        document.getElementById('lockScreen').style.display = 'none';
    }

    lucide.createIcons();
    const firebaseConfig = { apiKey: "AIzaSyDIAQXJ15atKJxu7PtcFL1W9JnO1N14pVs", authDomain: "radiobingo-9ac29.firebaseapp.com", databaseURL: "https://radiobingo-9ac29-default-rtdb.asia-southeast1.firebasedatabase.app", projectId: "radiobingo-9ac29", storageBucket: "radiobingo-9ac29.firebasestorage.app", messagingSenderId: "965903993397", appId: "1:965903993397:web:f6646fa05225f147eebf7c" };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    
    // --- SERVICE ACCOUNT LOGIC (REQUIRED FOR HTTP V1) ---
    let serviceAccount = null;
    const savedSA = localStorage.getItem('rb_service_account');
    if(savedSA) { try { serviceAccount = JSON.parse(savedSA); document.getElementById('serviceAccountJson').value = savedSA; } catch(e) {} }
    function saveServiceAccount() {
        const val = document.getElementById('serviceAccountJson').value.trim();
        try { const json = JSON.parse(val); if(!json.private_key || !json.client_email) throw new Error("Invalid JSON"); serviceAccount = json; localStorage.setItem('rb_service_account', val); alert("Service Account Saved! Push notifications enabled."); } catch(e) { alert("Error: Invalid Service Account JSON. Please copy the whole file."); }
    }
    // (JWT Generation using jsrsasign)
    function getAccessToken() {
        return new Promise((resolve, reject) => {
            if(!serviceAccount) return reject("No Service Account Loaded");
            const now = Math.floor(Date.now() / 1000);
            const claimSet = { iss: serviceAccount.client_email, scope: "https://www.googleapis.com/auth/firebase.messaging", aud: "https://oauth2.googleapis.com/token", exp: now + 3600, iat: now };
            const sJWT = KJUR.jws.JWS.sign("RS256", JSON.stringify({alg: "RS256", typ: "JWT"}), JSON.stringify(claimSet), serviceAccount.private_key);
            fetch("https://oauth2.googleapis.com/token", { method: "POST", headers: { "Content-Type": "application/x-www-form-urlencoded" }, body: `grant_type=urn:ietf:params:oauth:grant-type:jwt-bearer&assertion=${sJWT}` }).then(r => r.json()).then(data => { if(data.access_token) resolve(data.access_token); else reject(data.error_description || "Auth Failed"); }).catch(err => reject(err));
        });
    }

    let currentPattern = "Normal Bingo"; let drawnNumbers = []; let autoDrawInterval = null; let isAutoDrawing = false; let jackpotVisible = false; let schedules = {}; let globalStatusData = {}; let allUsersData = {}; let lastSpokenNumber = null;
    let userPointsCache = {}; // For detecting live changes
    
    // === CURRENCY LOGIC (ADMIN SIDE) ===
    const COIN_TO_PHP_RATE = 1; // Must match script.js
    function formatCurrency(amount) {
        const pesoVal = (amount || 0) / COIN_TO_PHP_RATE;
        return 'â‚±' + pesoVal.toLocaleString('en-PH', {minimumFractionDigits: 2, maximumFractionDigits: 2});
    }

    function cleanName(name) { 
        if(!name || name === 'Unknown') return "Guest"; 
        let cleaned = name.replace(/[\u4E00-\u9FFF\u3400-\u4DBF\u2000-\u206F]/g, '').trim(); 
        return cleaned || name || "Guest"; 
    }
    function openTab(tabId, btn) { document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active')); document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active')); document.getElementById(tabId).classList.add('active'); btn.classList.add('active'); }
    for(let i=1; i<=75; i++) { let b = document.createElement('div'); b.className = 'ball'; b.id = 'ball-'+i; b.innerText = i; b.onclick = () => toggleBall(i); document.getElementById('ballGrid').appendChild(b); }
    
    function updateSettingsUI() { document.getElementById('winRateDisplay').innerText = document.getElementById('winRateSlider').value + "%"; document.getElementById('scatterDisplay').innerText = document.getElementById('scatterSlider').value + "%"; }
    function saveGameSettings() { const wr = parseInt(document.getElementById('winRateSlider').value); const sc = parseInt(document.getElementById('scatterSlider').value); db.ref('gameState/settings').update({ minigameWinRate: wr, scatterChance: sc }).then(() => { alert("Settings Updated! All clients will now use these probabilities."); }); }
    db.ref('gameState/settings').once('value', s => { const val = s.val(); if(val) { document.getElementById('winRateSlider').value = val.minigameWinRate || 40; document.getElementById('scatterSlider').value = val.scatterChance || 3; updateSettingsUI(); } });

    // --- BANNER SETTINGS LOGIC ---
    function saveBannerSettings(isActive) {
        const imgUrl = document.getElementById('bannerImgInput').value.trim();
        const linkUrl = document.getElementById('bannerLinkInput').value.trim();
        
        if(isActive && !imgUrl) return alert("Please enter an Image URL if activating the banner.");

        db.ref('gameState/bannerSettings').set({
            imageUrl: imgUrl,
            targetUrl: linkUrl,
            active: isActive,
            updatedAt: Date.now()
        }).then(() => {
            alert(isActive ? "Banner Activated and Saved!" : "Banner Disabled.");
        });
    }

    // Load Banner Settings
    db.ref('gameState/bannerSettings').once('value', s => {
        const d = s.val();
        if(d) {
            document.getElementById('bannerImgInput').value = d.imageUrl || "";
            document.getElementById('bannerLinkInput').value = d.targetUrl || "";
        }
    });

    // --- VIDEO & SCHEDULE ---
    function updateVideoFeed() {
        const url = document.getElementById('videoUrlInput').value;
        if(!url) return alert("Please enter a valid YouTube Link or ID.");
        db.ref('gameState/videoSettings').set({ type: 'youtube', url: url, updatedAt: Date.now() }).then(() => { alert("Video Stream Updated Successfully! LIVE NOW."); document.getElementById('videoUrlInput').value = ""; });
    }
    function setStreamOffline() {
        if(confirm("Are you sure you want to STOP the stream and show the 'Waiting' screen?")) {
            db.ref('gameState/videoSettings').set({ type: 'offline', url: '', updatedAt: Date.now() }).then(() => { alert("Stream set to OFFLINE."); document.getElementById('videoUrlInput').value = ""; });
        }
    }
    db.ref('gameState/schedules').on('value', s => { schedules = s.val() || {}; renderSchedules(); });
    function addSchedule() { const input = document.getElementById('schedInput'); if(!input.value) return; const time = new Date(input.value).getTime(); const key = db.ref('gameState/schedules').push().key; db.ref('gameState/schedules/' + key).set({ time: time, notified5min: false }); input.value = ""; }
    function removeSchedule(key) { db.ref('gameState/schedules/' + key).remove(); }
    function renderSchedules() {
        const list = document.getElementById('scheduleList'); list.innerHTML = "";
        const sorted = Object.entries(schedules).sort(([,a], [,b]) => { const timeA = typeof a === 'object' ? a.time : a; const timeB = typeof b === 'object' ? b.time : b; return timeA - timeB; });
        sorted.forEach(([key, val]) => { let timeVal = typeof val === 'object' ? val.time : val; const date = new Date(timeVal); const str = date.toLocaleDateString('en-PH', { month:'short', day:'numeric'}) + ' ' + date.toLocaleTimeString('en-PH', {hour:'2-digit', minute:'2-digit'}); list.innerHTML += `<div style="display:flex; justify-content:space-between; background:rgba(255,255,255,0.05); padding:8px; border-radius:8px; margin-bottom:5px; font-size:11px;"><span>${str}</span><button style="background:var(--danger); border:none; color:white; border-radius:4px; cursor:pointer;" onclick="removeSchedule('${key}')">X</button></div>`; });
    }
    setInterval(() => {
        const now = Date.now();
        Object.entries(schedules).forEach(([key, val]) => { 
            let time = val; let notified = false; if(typeof val === 'object') { time = val.time; notified = val.notified5min; }
            if(!notified && (time - now) <= 300000 && (time - now) > 0) { sendPushToAll("RB LIVE ALERT", "âš ï¸ 5 Minutes na lang! Magsisimula na ang Bingo draw!"); if(typeof val === 'object') { db.ref('gameState/schedules/' + key).update({ notified5min: true }); } }
            if(now >= time && now < time + 60000) { db.ref('gameState/latestWinner').once('value', w => { if(!w.exists() && !isAutoDrawing) { db.ref('gameState').update({ status: 'playing', gameStartTime: Date.now() }); startAutoDrawLogic(); } }); removeSchedule(key); } 
        });
    }, 5000);

    // --- GAME LOGIC ---
    db.ref('drawnNumbers').on('value', s => { drawnNumbers = s.val() ? Object.values(s.val()) : []; document.querySelectorAll('.ball').forEach(b => b.classList.remove('drawn')); drawnNumbers.forEach(n => document.getElementById('ball-'+n).classList.add('drawn')); updateMonitorCards(); });
    db.ref('gameState/lastCalled').on('value', s => { if(s.exists()) { const num = s.val(); document.getElementById('lastBall').innerText = num; if (num !== lastSpokenNumber) { speakNumber(num); lastSpokenNumber = num; } } else { document.getElementById('lastBall').innerText = "--"; lastSpokenNumber = null; } });
    db.ref('gameState/currentPattern').on('value', s => { currentPattern = s.val() || "Normal Bingo"; document.getElementById('patternSelect').value = currentPattern; updateMonitorCards(); });
    
    function toggleJackpot() { jackpotVisible = !jackpotVisible; const amount = document.getElementById('jackpotAmount').value; const knob = document.getElementById('jackpotKnob'); const bg = document.getElementById('jackpotKnobBg'); if(jackpotVisible) { knob.style.left = "23px"; bg.style.background = "var(--success)"; document.getElementById('jackpotStatusText').innerText = "VISIBLE"; db.ref('gameState/jackpot').set({ amount: amount, active: true }); } else { knob.style.left = "3px"; bg.style.background = "rgba(0,0,0,0.3)"; document.getElementById('jackpotStatusText').innerText = "HIDDEN"; db.ref('gameState/jackpot').set({ amount: amount, active: false }); } }
    db.ref('gameState/jackpot').once('value', s => { if(s.exists()){ const d = s.val(); document.getElementById('jackpotAmount').value = d.amount || ""; if(d.active) { jackpotVisible = true; document.getElementById('jackpotKnob').style.left = "23px"; document.getElementById('jackpotKnobBg').style.background = "var(--success)"; document.getElementById('jackpotStatusText').innerText = "VISIBLE"; } } });
    document.getElementById('jackpotAmount').addEventListener('input', (e) => { if(jackpotVisible) { db.ref('gameState/jackpot').update({ amount: e.target.value }); } });

    function toggleAutoDraw() { if(!isAutoDrawing) { db.ref('gameState/latestWinner').once('value', s => { if(s.exists()) { alert("May Winner Na! Reset Game muna bago mag start ulit."); return; } startAutoDrawLogic(); }); } else { stopAutoDrawLogic(); } }
    function startAutoDrawLogic() { if(isAutoDrawing) return; db.ref('gameState').update({ status: 'playing', gameStartTime: Date.now() }); const btn = document.getElementById('btnAutoDraw'); const speed = document.getElementById('drawSpeed').value * 1000; isAutoDrawing = true; btn.innerHTML = `<i data-lucide="pause"></i> STOP AUTO DRAW`; btn.style.background = "linear-gradient(135deg, #ef4444, #b91c1c)"; autoDrawLogic(); autoDrawInterval = setInterval(autoDrawLogic, speed); lucide.createIcons(); }
    function stopAutoDrawLogic() { const btn = document.getElementById('btnAutoDraw'); clearInterval(autoDrawInterval); isAutoDrawing = false; btn.innerHTML = `<i data-lucide="play"></i> START AUTO DRAW`; btn.style.background = "linear-gradient(135deg, #059669, #047857)"; lucide.createIcons(); }
    function autoDrawLogic() { if(drawnNumbers.length >= 75) { stopAutoDrawLogic(); return alert("Game Over! All numbers drawn."); } db.ref('gameState/latestWinner').once('value', s => { if(s.exists()) { stopAutoDrawLogic(); return; } let nextNum; do { nextNum = Math.floor(Math.random() * 75) + 1; } while (drawnNumbers.includes(nextNum)); toggleBall(nextNum); }); }
    function speakNumber(num) { if ('speechSynthesis' in window) { let letter = "B"; if (num > 15) letter = "I"; if (num > 30) letter = "N"; if (num > 45) letter = "G"; if (num > 60) letter = "O"; const msg = new SpeechSynthesisUtterance(`${letter} ${num}`); msg.rate = 0.9; window.speechSynthesis.speak(msg); } }
    function toggleBall(num) { const ref = db.ref('drawnNumbers/' + num); ref.once('value', s => { if(s.exists()) { ref.remove(); } else { ref.set(num); db.ref('gameState/lastCalled').set(num); db.ref('gameState/gameStartTime').once('value', ss => { if(!ss.exists()) db.ref('gameState/gameStartTime').set(Date.now()); }); } }); }

    // --- USERS & LIVE ACTIVITY SPY ---
    db.ref('status').on('value', s => { globalStatusData = s.val() || {}; document.getElementById('countOnline').innerText = Object.keys(globalStatusData).length; renderActiveUserList(); updateMonitorCards(); });
    function renderActiveUserList() { 
        const list = document.getElementById('activeUsersList'); 
        list.innerHTML = ""; 
        Object.entries(globalStatusData).forEach(([uid, data]) => { 
            let displayName = "Guest"; 
            if(allUsersData[uid]) {
                // Try multiple possible name fields
                displayName = allUsersData[uid].name || allUsersData[uid].username || allUsersData[uid].displayName || allUsersData[uid].email || uid.substring(0, 10);
            } else if(data.name) {
                displayName = data.name;
            }
            const safeName = cleanName(displayName); 
            list.innerHTML += `<div style="padding:6px 0; border-bottom:1px solid rgba(255,255,255,0.05); display:flex; align-items:center; gap:8px;"><span class="online-dot"></span> ${safeName}</div>`; 
        }); 
    }
    
    // THE GLOBAL SPY MONITOR
    db.ref('users').on('value', s => { 
        allUsersData = s.val() || {}; 
        document.getElementById('countUsers').innerText = s.numChildren();
        
        // 1. Update UI List
        const list = document.getElementById('pointsUserList'); 
        const currentSelected = document.getElementById('selectedUserForPoints').value; 
        list.innerHTML = ""; 
        
        s.forEach(child => { 
            const u = child.val(); 
            const uid = child.key; 
            const safeName = cleanName(u.name); 
            const currentPts = u.points || 0;
            
            // 2. LIVE ACTIVITY DETECTION
            // If we have seen this user before, compare points
            if (userPointsCache.hasOwnProperty(uid)) {
                const oldPts = userPointsCache[uid];
                if (oldPts !== currentPts) {
                    const diff = currentPts - oldPts;
                    logLiveActivity(safeName, oldPts, currentPts, diff);
                }
            }
            // Update cache
            userPointsCache[uid] = currentPts;

            const isSel = currentSelected === uid ? 'selected' : ''; 
            const div = document.createElement('div'); 
            div.className = `user-option ${isSel}`; 
            div.onclick = () => selectUserForMgmt(uid, div, safeName); 
            // UPDATED: Show PHP in Admin List
            div.innerHTML = `<span>${safeName}</span> <span>${formatCurrency(currentPts)}</span>`; 
            list.appendChild(div); 
        }); 
        
        renderActiveUserList(); 
        updateMonitorCards(); 
    });
    
    function logLiveActivity(name, oldVal, newVal, diff) {
        const feed = document.getElementById('liveActivityFeed');
        const item = document.createElement('div');
        item.className = 'live-log-item';
        const sign = diff > 0 ? '+' : '';
        const colorClass = diff > 0 ? 'log-pos' : 'log-neg';
        
        item.innerHTML = `
            <div style="display:flex; justify-content:space-between; margin-bottom:2px;">
                <span style="font-weight:700; color:white;">${name}</span>
                <span style="font-size:9px; opacity:0.6;">${new Date().toLocaleTimeString()}</span>
            </div>
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <span style="opacity:0.7;">${oldVal} âž ${newVal}</span>
                <span class="${colorClass}">${sign}${formatCurrency(diff)}</span>
            </div>
        `;
        feed.prepend(item);
        // Keep list clean (max 50)
        if(feed.children.length > 50) feed.removeChild(feed.lastChild);
    }

    function selectUserForMgmt(uid, el, name) { 
        document.querySelectorAll('.user-option').forEach(e => e.classList.remove('selected')); 
        el.classList.add('selected'); 
        document.getElementById('selectedUserForPoints').value = uid; 
        document.getElementById('historyUserName').innerText = name;
        renderUserHistory(uid);
    }
    
    function renderUserHistory(uid) {
        const list = document.getElementById('pointHistoryList');
        list.innerHTML = "<div style='text-align:center; padding:10px;'>Loading...</div>";
        
        db.ref('pointLogs/' + uid).orderByChild('timestamp').limitToLast(50).once('value', s => {
            if(!s.exists()) {
                list.innerHTML = "<div style='opacity:0.5; text-align:center; padding:20px; font-size:12px;'>No permanent logs found.<br>(Only Admin Adjustments & Cashouts are logged permanently)</div>";
                return;
            }
            list.innerHTML = "";
            let items = [];
            s.forEach(c => items.push(c.val()));
            items.reverse(); 
            
            items.forEach(log => {
                const date = new Date(log.timestamp).toLocaleString();
                const isAdd = log.amount >= 0;
                const color = isAdd ? 'var(--success)' : 'var(--danger)';
                const sign = isAdd ? '+' : '';
                
                list.innerHTML += `
                    <div style="display:flex; justify-content:space-between; align-items:center; background:rgba(255,255,255,0.05); padding:10px; border-radius:8px; margin-bottom:5px; font-size:12px;">
                        <div>
                            <div style="font-weight:700;">${log.reason || "Point Adjustment"}</div>
                            <div style="font-size:10px; opacity:0.6;">${date}</div>
                        </div>
                        <div style="color:${color}; font-weight:900;">${sign}${formatCurrency(log.amount)}</div>
                    </div>
                `;
            });
        });
    }

    function updateMonitorCards() {
        const container = document.getElementById('liveCardsContainer'); container.innerHTML = ""; let usersArray = [];
        Object.entries(allUsersData).forEach(([key, user]) => { if(user.card || user.currentCard) { usersArray.push({ ...user, uid: key }); } });
        usersArray.sort((a, b) => { const aOnline = globalStatusData[a.uid] ? 1 : 0; const bOnline = globalStatusData[b.uid] ? 1 : 0; return bOnline - aOnline; });
        usersArray.forEach(user => {
            const card = user.currentCard || user.card; 
            const check = checkCardStatus(card, currentPattern, drawnNumbers); 
            const isOnline = globalStatusData[user.uid] ? true : false; 
            // Try multiple possible name fields
            const displayName = user.name || user.username || user.displayName || user.email || user.uid.substring(0, 10);
            const safeName = cleanName(displayName);
            let isBingo = check.isBingo; let isPuro = check.isPuro; if(!isOnline) { isBingo = false; isPuro = false; } else { if(user.hasWonCurrent && drawnNumbers.length > 0) isBingo = true; if(isBingo) isPuro = false; }
            const cardDiv = document.createElement('div'); cardDiv.className = `user-card-monitor ${!isOnline ? 'offline' : ''} ${isBingo ? 'bingo' : ''} ${isPuro ? 'puro' : ''}`;
            let gridHtml = '<div class="mini-bingo-grid">'; card.forEach((n, idx) => { const marked = drawnNumbers.includes(n) || n === "FREE"; const isWinningCell = check.winningCells.includes(idx); const visualHit = isOnline && isWinningCell; gridHtml += `<div class="mini-cell ${marked ? 'marked' : ''} ${visualHit ? 'hit' : ''}">${n === "FREE" ? 'â˜…' : n}</div>`; }); gridHtml += '</div>';
            cardDiv.innerHTML = `<div class="monitor-badge">${isBingo ? "BINGO!" : "PURO!"}</div><div style="font-size:12px; font-weight:800; display:flex; justify-content:space-between; color:white; align-items:center;"><span style="display:flex; align-items:center; gap:5px;"><span class="${isOnline ? 'online-dot' : 'offline-dot'}"></span>${safeName}</span><span style="font-size:9px; background:rgba(255,255,255,0.1); padding:2px 6px; border-radius:4px;">${user.points || 0} pts</span></div>${gridHtml}`;
            if(isBingo && isOnline) container.prepend(cardDiv); else if(isPuro && isOnline) container.insertBefore(cardDiv, container.children[1] || null); else container.appendChild(cardDiv);
        });
    }

    function checkCardStatus(card, pattern, drawn) {
        let markedIndices = [12]; card.forEach((val, idx) => { if(drawn.includes(val) && idx !== 12) markedIndices.push(idx); });
        let patterns = [];
        if (pattern === "Blackout") { patterns = [[...Array(25).keys()]]; }
        else if (pattern === "Letter X") { patterns = [[0,4,6,8,12,16,18,20,24]]; }
        else if (pattern === "Four Corners") { patterns = [[0,4,20,24]]; }
        else { patterns = [[0,1,2,3,4],[5,6,7,8,9],[10,11,12,13,14],[15,16,17,18,19],[20,21,22,23,24],[0,5,10,15,20],[1,6,11,16,21],[2,7,12,17,22],[3,8,13,18,23],[4,9,14,19,24],[0,6,12,18,24],[4,8,12,16,20]]; }
        let isBingo = false; let isPuro = false; let winningCells = [];
        for (let p of patterns) { const hits = p.filter(idx => markedIndices.includes(idx)); const needed = p.length; const got = hits.length; if (got === needed) { isBingo = true; winningCells = p; break; } else if (needed - got === 1) { isPuro = true; } }
        return { isBingo, isPuro, winningCells };
    }

    db.ref('gameState/latestWinner').on('value', s => {
        const marquee = document.getElementById('winnerAnnounce');
        if(s.exists()) {
            const winData = s.val(); const safeWinnerName = cleanName(winData.name);
            let msg = `ðŸŽ‰ BINGO WINNER: ${safeWinnerName.toUpperCase()}!`; if(winData.prize) msg += ` WON ${formatCurrency(winData.prize)}! ðŸ’°`; else msg += ` CONGRATULATIONS! ðŸŽ‰`;
            marquee.style.display = 'block'; document.getElementById('winnerMarqueeText').innerText = msg;
            if(isAutoDrawing) { stopAutoDrawLogic(); alert("AUTO STOP: We have a winner!"); }
        } else { marquee.style.display = 'none'; updateMonitorCards(); } 
    });

    // --- ADMIN POINTS WITH LOGGING ---
    function modifyUserPoints() { 
        const uid = document.getElementById('selectedUserForPoints').value; 
        const amount = document.getElementById('pointsAmount').value; 
        if(!uid) return alert("Select a user first!"); 
        if(!amount) return alert("Enter amount"); 
        
        const amountInt = parseInt(amount);
        
        db.ref(`users/${uid}/points`).transaction(current => (current || 0) + amountInt, (error, committed, snapshot) => {
            if (committed) {
                // Log the transaction
                db.ref(`pointLogs/${uid}`).push({
                    amount: amountInt,
                    reason: "Admin Adjustment",
                    timestamp: firebase.database.ServerValue.TIMESTAMP,
                    by: "Admin"
                });
                alert("Points updated and logged!"); 
                document.getElementById('pointsAmount').value = "";
                renderUserHistory(uid); 
            }
        }); 
    }

    async function sendPushNotification(token, title, body) {
        if(!serviceAccount) { console.error("NO SERVICE ACCOUNT"); return false; }
        try {
            const accessToken = await getAccessToken();
            const projectId = serviceAccount.project_id;
            const response = await fetch(`https://fcm.googleapis.com/v1/projects/${projectId}/messages:send`, { 
                method: 'POST', 
                headers: { 
                    'Authorization': `Bearer ${accessToken}`, 
                    'Content-Type': 'application/json' 
                }, 
                body: JSON.stringify({ 
                    message: { 
                        token: token, 
                        notification: { 
                            title: title, 
                            body: body 
                        }, 
                        webpush: { 
                            notification: { 
                                icon: 'https://i.imgur.com/7D8u8h6.png'
                            },
                            fcm_options: {
                                link: window.location.origin
                            }
                        },
                        data: {
                            url: window.location.origin
                        }
                    } 
                }) 
            });
            if(!response.ok) { const err = await response.json(); console.error("FCM Error:", err); return false; } return true;
        } catch(e) { console.error("Push Token Gen Error:", e); return false; }
    }
    
    async function sendPushToAll(title, body) { const statusEl = document.getElementById('sendStatus'); statusEl.innerText = "Sending..."; db.ref('users').once('value', async s => { const promises = []; s.forEach(u => { const user = u.val(); if(user.fcmToken) { promises.push(sendPushNotification(user.fcmToken, title, body)); } }); await Promise.all(promises); statusEl.innerText = `Sent push to devices (if available).`; }); }
    
    function sendAdminNotification() { 
        if(!serviceAccount) return alert("WARNING: Please paste your Service Account JSON in the Settings tab first!"); 
        const type = document.getElementById('notifRecipient').value; 
        const msg = document.getElementById('notifMessage').value; 
        const title = "RB LIVE ALERT"; 
        if(!msg) return alert("Enter message"); 
        
        if(type === 'selected') { 
            const uid = document.getElementById('selectedUserForPoints').value; 
            if(!uid) return alert("Select a user first!"); 
            db.ref(`notifications/${uid}`).push({ msg: msg, time: Date.now(), type: 'admin', read: false }); 
            db.ref(`users/${uid}/fcmToken`).once('value', t => { if(t.exists()) { sendPushNotification(t.val(), title, msg).then(() => alert("Sent!")); } else { alert("User has no push token (App not installed or perm denied). Sent to inbox only."); } }); 
        } else { 
            if(confirm("Send to ALL users (Push + In-App)?")) { 
                db.ref('users').once('value', s => { s.forEach(u => { db.ref(`notifications/${u.key}`).push({ msg: msg, time: Date.now(), type: 'admin', read: false }); }); }); 
                sendPushToAll(title, msg); 
                alert("Broadcast sent! (DB + Push)"); 
            } 
        } 
        document.getElementById('notifMessage').value = ""; 
    }

    function setPattern(p) { db.ref('gameState/currentPattern').set(p); }
    function resetGame() {
        if(confirm("WARNING: Reset entire board?")){
            db.ref('drawnNumbers').remove(); db.ref('gameState/latestWinner').remove(); db.ref('gameState/gameStartTime').remove(); db.ref('gameState/lastCalled').remove();
            db.ref('gameState').update({ status: 'waiting' });
            db.ref('users').once('value', s => { let updates = {}; s.forEach(u => { updates[u.key + '/hasWonCurrent'] = false; }); db.ref('users').update(updates); });
            stopAutoDrawLogic(); setTimeout(updateMonitorCards, 500); document.getElementById('lastBall').innerText = "--"; lastSpokenNumber = null;
        }
    }

    db.ref('redemptions').on('value', s => {
        const list = document.getElementById('cashoutList'); list.innerHTML = "";
        s.forEach(child => {
            const r = child.val(); const key = child.key; if(r.status !== 'pending') return;
            const safeName = cleanName(r.name);
            const div = document.createElement('div'); div.className = 'card'; div.style.padding = "15px"; div.style.marginBottom = "10px";
            div.innerHTML = `<div style="display:flex; justify-content:space-between; align-items:center;"><div><div style="font-weight:800;">${safeName} - <span style="color:var(--gold)">${r.item}</span></div><div style="font-size:11px; opacity:0.6;">GCash: ${r.gcash}</div></div><div style="display:flex; gap:10px;"><button class=\"btn btn-primary\" style=\"width:auto; padding:8px 20px\" onclick=\"updateStatus('${key}', 'sent', ${JSON.stringify(r).replace(/"/g, '&quot;')})\">PAID</button><button class=\"btn btn-danger\" style=\"width:auto; padding:8px 20px\" onclick=\"updateStatus('${key}', 'denied', ${JSON.stringify(r).replace(/"/g, '&quot;')})\">X</button></div></div>`;
            list.prepend(div);
        });
    });

    function updateStatus(key, status, data) {
        if(confirm(`${status} this?`)) {
            db.ref('redemptions/' + key).update({ status: status });
            const statusMsg = status === 'sent' ? `Ang iyong ${data.item} ay na-ipadala na! îžé ‚` : `Ang iyong ${data.item} ay na-deny. ç¬¶å½¢`;
            db.ref('notifications/' + data.uid).push({ msg: statusMsg, time: Date.now() });
            
            // Refund points if denied
            if(status === 'denied') {
                db.ref('users/' + data.uid + '/points').transaction(p => (p || 0) + data.cost, (err, committed) => {
                     if(committed) {
                         db.ref(`pointLogs/${data.uid}`).push({
                             amount: data.cost,
                             reason: `Refund: ${data.item}`,
                             timestamp: firebase.database.ServerValue.TIMESTAMP,
                             by: "System/Admin"
                         });
                         if(document.getElementById('selectedUserForPoints').value === data.uid) {
                             renderUserHistory(data.uid);
                         }
                     }
                 });
            }
        }
    }

    // === UTILITY: HTML ESCAPING ===
    function escapeHtml(text) {
        if (!text) return '';
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    // === SUPPORT MESSAGES ===
    db.ref('supportMessages').on('value', s => {
        const list = document.getElementById('supportMessagesList');
        list.innerHTML = "";
        
        if(!s.exists()) {
            list.innerHTML = '<div style="opacity:0.5; text-align:center; padding:40px; font-size:12px;">No support messages yet.</div>';
            return;
        }
        
        const messages = [];
        s.forEach(child => {
            messages.push({ key: child.key, ...child.val() });
        });
        
        // Sort by timestamp, newest first
        messages.sort((a, b) => b.timestamp - a.timestamp);
        
        messages.forEach(msg => {
            const statusColor = msg.status === 'open' ? 'var(--gold)' : 'var(--success)';
            const statusText = msg.status === 'open' ? 'OPEN' : 'RESOLVED';
            const date = new Date(msg.timestamp).toLocaleString();
            
            const div = document.createElement('div');
            div.className = 'card';
            div.style.padding = "15px";
            div.style.marginBottom = "10px";
            div.style.background = msg.status === 'open' ? 'rgba(251, 191, 36, 0.05)' : 'rgba(0,0,0,0.2)';
            div.style.borderLeft = `3px solid ${statusColor}`;
            
            div.innerHTML = `
                <div style="display:flex; justify-content:space-between; align-items:flex-start; margin-bottom:10px;">
                    <div style="display:flex; gap:10px; align-items:center;">
                        <img src="${msg.userPhoto || 'https://via.placeholder.com/40'}" style="width:40px; height:40px; border-radius:50%; object-fit:cover;">
                        <div>
                            <div style="font-weight:800; font-size:13px;">${escapeHtml(msg.userName)}</div>
                            <div style="font-size:10px; opacity:0.6;">${date}</div>
                        </div>
                    </div>
                    <div style="font-size:10px; font-weight:800; color:${statusColor}; text-transform:uppercase; border:1px solid ${statusColor}; padding:4px 8px; border-radius:6px;">
                        ${statusText}
                    </div>
                </div>
                <div style="margin-bottom:8px;">
                    <div style="font-weight:700; font-size:12px; color:var(--accent-glow); margin-bottom:5px;">Subject: ${escapeHtml(msg.subject)}</div>
                    <div style="font-size:12px; line-height:1.5; color:#cbd5e1;">${escapeHtml(msg.message)}</div>
                </div>
                <div style="font-size:10px; opacity:0.6; margin-top:8px; padding-top:8px; border-top:1px solid rgba(255,255,255,0.05);">
                    Contact: ${escapeHtml(msg.userEmail)}
                </div>
                <div style="display:flex; gap:10px; margin-top:10px;">
                    <button class="btn btn-primary reply-support-btn" 
                        style="width:auto; padding:8px 20px; font-size:11px; background:var(--accent); border-color:var(--accent);"
                        data-msg-key="${msg.key}" 
                        data-uid="${msg.uid}" 
                        data-username="${escapeHtml(msg.userName)}">
                        <i data-lucide="reply" width="14"></i> REPLY
                    </button>
                    ${msg.status === 'open' ? `
                        <button class="btn btn-primary resolve-support-btn" 
                            style="width:auto; padding:8px 20px; font-size:11px;"
                            data-msg-key="${msg.key}" 
                            data-uid="${msg.uid}">MARK RESOLVED</button>
                    ` : ''}
                    <button class="btn btn-danger delete-support-btn" 
                        style="width:auto; padding:8px 20px; font-size:11px;"
                        data-msg-key="${msg.key}">DELETE</button>
                </div>
            `;
            
            list.appendChild(div);
            
            // Add event listeners using data attributes
            const replyBtn = div.querySelector('.reply-support-btn');
            if (replyBtn) {
                replyBtn.addEventListener('click', function() {
                    replySupportMessage(
                        this.dataset.msgKey, 
                        this.dataset.uid, 
                        this.dataset.username
                    );
                });
            }
            
            const resolveBtn = div.querySelector('.resolve-support-btn');
            if (resolveBtn) {
                resolveBtn.addEventListener('click', function() {
                    resolveSupportMessage(this.dataset.msgKey, this.dataset.uid);
                });
            }
            
            const deleteBtn = div.querySelector('.delete-support-btn');
            if (deleteBtn) {
                deleteBtn.addEventListener('click', function() {
                    deleteSupportMessage(this.dataset.msgKey);
                });
            }
        });
        
        lucide.createIcons();
    });

    function resolveSupportMessage(key, uid) {
        if(confirm('Mark this message as resolved?')) {
            db.ref('supportMessages/' + key).update({ status: 'resolved' });
            
            // Send notification to user
            db.ref('notifications/' + uid).push({
                msg: 'Your support request has been resolved. Thank you!',
                time: Date.now(),
                type: 'support'
            });
        }
    }

    function deleteSupportMessage(key) {
        if(confirm('Delete this support message?')) {
            db.ref('supportMessages/' + key).remove();
        }
    }

    function replySupportMessage(key, uid, userName) {
        const reply = prompt(`Reply to ${userName}:`);
        if (!reply || reply.trim() === '') {
            return;
        }
        
        // Sanitize the reply to prevent any injection issues
        const sanitizedReply = reply.trim().substring(0, 500); // Limit length
        
        // Send notification to user
        db.ref('notifications/' + uid).push({
            msg: `Admin replied to your support request: "${sanitizedReply}"`,
            time: Date.now(),
            type: 'support_reply'
        }).then(() => {
            alert('Reply sent successfully!');
        }).catch(err => {
            console.error('Error sending reply:', err);
            alert('Failed to send reply');
        });
    }

    // === VERIFICATION REQUEST MANAGEMENT ===
    let currentVerificationFilter = 'all';
    let pendingRejectUid = null; // Store UID for rejection confirmation
    
    function loadVerificationRequests() {
        db.ref('users').once('value', snapshot => {
            const requests = [];
            snapshot.forEach(userSnap => {
                const user = userSnap.val();
                const uid = userSnap.key;
                
                if (user.verificationStatus || user.verified) {
                    // Try multiple possible name fields
                    const displayName = user.name || user.username || user.displayName || user.email || uid.substring(0, 12);
                    
                    requests.push({
                        uid: uid,
                        name: displayName,
                        photo: user.photo || 'https://via.placeholder.com/60',
                        reason: user.verificationReason || 'No reason provided',
                        status: user.verified ? 'approved' : (user.verificationStatus || 'none'),
                        requestedAt: user.verificationRequestedAt || 0,
                        points: user.points || 0,
                        bingoWins: user.bingoWins || 0
                    });
                }
            });
            
            // Sort by requested date (newest first)
            requests.sort((a, b) => b.requestedAt - a.requestedAt);
            
            renderVerificationRequests(requests);
        });
    }
    
    function filterVerificationRequests(filter) {
        currentVerificationFilter = filter;
        
        // Update button styles
        document.querySelectorAll('#verification-tab button[id^="filter-"]').forEach(btn => {
            btn.style.background = 'rgba(255,255,255,0.05)';
            btn.style.borderColor = 'rgba(255,255,255,0.1)';
        });
        
        const activeBtn = document.getElementById('filter-' + filter);
        if (activeBtn) {
            activeBtn.style.background = 'rgba(59, 130, 246, 0.2)';
            activeBtn.style.borderColor = 'rgba(59, 130, 246, 0.3)';
        }
        
        loadVerificationRequests();
    }
    
    function renderVerificationRequests(requests) {
        const list = document.getElementById('verificationRequestsList');
        list.innerHTML = '';
        
        // Filter requests based on current filter
        const filtered = requests.filter(req => {
            if (currentVerificationFilter === 'all') return true;
            if (currentVerificationFilter === 'pending') return req.status === 'pending';
            if (currentVerificationFilter === 'approved') return req.status === 'approved';
            if (currentVerificationFilter === 'rejected') return req.status === 'rejected';
            return true;
        });
        
        if (filtered.length === 0) {
            list.innerHTML = '<div style="opacity:0.5; text-align:center; padding:40px; font-size:12px;">No verification requests found.</div>';
            return;
        }
        
        filtered.forEach(req => {
            const statusColors = {
                'pending': { bg: 'rgba(245, 158, 11, 0.15)', border: 'rgba(245, 158, 11, 0.3)', text: '#f59e0b', label: 'â³ Pending' },
                'approved': { bg: 'rgba(16, 185, 129, 0.15)', border: 'rgba(16, 185, 129, 0.3)', text: '#10b981', label: 'âœ“ Approved' },
                'rejected': { bg: 'rgba(239, 68, 68, 0.15)', border: 'rgba(239, 68, 68, 0.3)', text: '#ef4444', label: 'âœ— Rejected' }
            };
            
            const statusStyle = statusColors[req.status] || statusColors.pending;
            const dateStr = req.requestedAt ? new Date(req.requestedAt).toLocaleString() : 'Unknown';
            
            const div = document.createElement('div');
            div.style.cssText = `
                background: rgba(255, 255, 255, 0.02);
                border: 1px solid rgba(255, 255, 255, 0.1);
                border-radius: 12px;
                padding: 16px;
            `;
            
            div.innerHTML = `
                <div style="display:flex; gap:12px; align-items:start;">
                    <img src="${escapeHtml(req.photo)}" 
                        style="width:50px; height:50px; border-radius:50%; object-fit:cover; border:2px solid rgba(255,255,255,0.1);">
                    <div style="flex:1; min-width:0;">
                        <div style="display:flex; align-items:center; gap:8px; margin-bottom:4px;">
                            <div style="font-weight:700; color:white; font-size:14px;">${escapeHtml(req.name)}</div>
                            <div style="font-size:10px; padding:2px 8px; border-radius:12px; background:${statusStyle.bg}; border:1px solid ${statusStyle.border}; color:${statusStyle.text}; font-weight:600;">
                                ${statusStyle.label}
                            </div>
                        </div>
                        <div style="font-size:11px; color:rgba(255,255,255,0.5); margin-bottom:8px;">
                            <span title="${req.uid}">UID: ${req.uid.substring(0,8)}</span> â€¢ ${req.bingoWins} wins â€¢ ${req.points} pts
                        </div>
                        <div style="font-size:12px; color:rgba(255,255,255,0.7); background:rgba(0,0,0,0.2); padding:10px; border-radius:8px; margin-bottom:8px;">
                            <strong>Reason:</strong> ${escapeHtml(req.reason)}
                        </div>
                        <div style="font-size:10px; opacity:0.5;">
                            Requested: ${dateStr}
                        </div>
                        ${req.status === 'pending' ? `
                            <div style="display:flex; gap:8px; margin-top:12px;">
                                <button class="btn btn-primary" 
                                    onclick="approveVerificationRequest('${req.uid}')"
                                    style="flex:1; padding:8px; font-size:11px; background:#10b981; border-color:#10b981;">
                                    <i data-lucide="check" width="14"></i> APPROVE
                                </button>
                                <button class="btn btn-danger" 
                                    onclick="rejectVerificationRequest('${req.uid}')"
                                    style="flex:1; padding:8px; font-size:11px;">
                                    <i data-lucide="x" width="14"></i> REJECT
                                </button>
                            </div>
                        ` : req.status === 'approved' ? `
                            <div style="display:flex; gap:8px; margin-top:12px;">
                                <button class="btn btn-danger" 
                                    onclick="revokeVerification('${req.uid}')"
                                    style="flex:1; padding:8px; font-size:11px;">
                                    <i data-lucide="shield-off" width="14"></i> REVOKE VERIFICATION
                                </button>
                            </div>
                        ` : ''}
                    </div>
                </div>
            `;
            
            list.appendChild(div);
        });
        
        lucide.createIcons();
    }
    
    function approveVerificationRequest(uid) {
        if (!confirm('Approve this verification request?')) return;
        
        db.ref('users/' + uid).update({
            verified: true,
            verificationStatus: 'approved',
            verificationApprovedAt: Date.now()
        }).then(() => {
            // Send notification to user
            db.ref('notifications/' + uid).push({
                msg: 'âœ“ Your verification request has been approved! You now have a verification badge.',
                time: Date.now(),
                type: 'verification_approved'
            });
            
            alert('Verification approved!');
            loadVerificationRequests();
        }).catch(err => {
            console.error('Error approving verification:', err);
            alert('Failed to approve verification');
        });
    }
    
    function rejectVerificationRequest(uid) {
        pendingRejectUid = uid;
        document.getElementById('rejectReasonInput').value = '';
        document.getElementById('rejectVerificationModal').style.display = 'flex';
    }
    
    function confirmRejectVerification() {
        if (!pendingRejectUid) return;
        
        const reason = document.getElementById('rejectReasonInput').value.trim() || 'No reason provided';
        
        db.ref('users/' + pendingRejectUid).update({
            verified: false,
            verificationStatus: 'rejected',
            verificationRejectedAt: Date.now(),
            verificationRejectionReason: reason
        }).then(() => {
            // Send notification to user
            db.ref('notifications/' + pendingRejectUid).push({
                msg: `âœ— Your verification request has been rejected. ${reason !== 'No reason provided' ? 'Reason: ' + reason : ''}`,
                time: Date.now(),
                type: 'verification_rejected'
            });
            
            alert('Verification rejected.');
            document.getElementById('rejectVerificationModal').style.display = 'none';
            pendingRejectUid = null;
            loadVerificationRequests();
        }).catch(err => {
            console.error('Error rejecting verification:', err);
            alert('Failed to reject verification');
        });
    }
    
    function revokeVerification(uid) {
        if (!confirm('Revoke verification badge from this user?')) return;
        
        db.ref('users/' + uid).update({
            verified: false,
            verificationStatus: 'revoked',
            verificationRevokedAt: Date.now()
        }).then(() => {
            // Send notification to user
            db.ref('notifications/' + uid).push({
                msg: 'âš ï¸ Your verification badge has been revoked by an admin.',
                time: Date.now(),
                type: 'verification_revoked'
            });
            
            alert('Verification revoked.');
            loadVerificationRequests();
        }).catch(err => {
            console.error('Error revoking verification:', err);
            alert('Failed to revoke verification');
        });
    }
    
    // MANUAL GRANT FUNCTIONS
    let selectedGrantUser = null;
    
    function searchUsersForGrant() {
        const searchTerm = document.getElementById('grant-user-search').value.toLowerCase().trim();
        const list = document.getElementById('grant-user-list');
        const grantBtn = document.getElementById('grant-verify-btn');
        
        // Show loading indicator
        list.innerHTML = '<div style="text-align: center; padding: 20px; color: var(--text-muted); font-size: 11px;">ðŸ” Loading users...</div>';
        
        db.ref('users').once('value').then(snap => {
            const users = snap.val() || {};
            list.innerHTML = '';
            let found = false;
            
            // Check if database has users
            if (Object.keys(users).length === 0) {
                list.innerHTML = '<div style="text-align: center; padding: 20px; color: var(--text-muted); font-size: 11px;">No users found in database</div>';
                return;
            }
            
            Object.entries(users).forEach(([uid, user]) => {
                // Try multiple possible username fields
                const displayName = user.username || user.displayName || user.name || user.email || uid;
                const searchableText = displayName.toLowerCase();
                
                // Show all users if search is empty, otherwise filter
                if (!searchTerm || searchableText.includes(searchTerm)) {
                    found = true;
                    const div = document.createElement('div');
                    div.className = 'user-option';
                    if (selectedGrantUser === uid) div.classList.add('selected');
                    
                    const verifiedBadge = user.verified ? '<span class="verified-badge-inline"><i data-lucide="check-circle" style="width:10px;height:10px;"></i> Verified</span>' : '';
                    const statusDot = user.online ? '<span class="online-dot"></span>' : '<span class="offline-dot"></span>';
                    
                    // Show UID in small text if no proper name
                    const uidText = (!user.username && !user.displayName && !user.name && !user.email) 
                        ? `<br><span style="font-size: 9px; color: var(--text-muted);">ID: ${uid.substring(0, 12)}...</span>` 
                        : '';
                    
                    div.innerHTML = `
                        <div style="display: flex; align-items: center; gap: 8px;">
                            ${statusDot}
                            <div style="flex: 1;">
                                <strong>${displayName}</strong>
                                ${uidText}
                            </div>
                            ${verifiedBadge}
                        </div>
                    `;
                    
                    div.onclick = () => {
                        selectedGrantUser = uid;
                        grantBtn.disabled = false;
                        searchUsersForGrant();
                    };
                    
                    list.appendChild(div);
                }
            });
            
            if (!found) {
                const message = searchTerm 
                    ? 'No users found matching "' + searchTerm + '"'
                    : 'No users found in database';
                list.innerHTML = '<div style="text-align: center; padding: 20px; color: var(--text-muted); font-size: 11px;">' + message + '</div>';
                selectedGrantUser = null;
                grantBtn.disabled = true;
            }
            
            lucide.createIcons();
        }).catch(err => {
            console.error('Error loading users:', err);
            list.innerHTML = '<div style="text-align: center; padding: 20px; color: var(--danger); font-size: 11px;">âŒ Error loading users. Check console.</div>';
        });
    }
    
    function grantVerificationBadge() {
        if (!selectedGrantUser) {
            alert('Please select a user first');
            return;
        }
        
        db.ref('users/' + selectedGrantUser).once('value').then(snap => {
            const user = snap.val();
            
            if (user.verified) {
                if (!confirm(`${user.username || 'This user'} is already verified. Grant again anyway?`)) {
                    return;
                }
            }
            
            if (!confirm(`Grant verified badge to ${user.username || 'this user'}?`)) {
                return;
            }
            
            db.ref('users/' + selectedGrantUser).update({
                verified: true,
                verificationStatus: 'admin_granted',
                verificationApprovedAt: Date.now()
            }).then(() => {
                // Send notification to user
                db.ref('notifications/' + selectedGrantUser).push({
                    msg: 'ðŸŒŸ You have been granted a verification badge by an admin!',
                    time: Date.now(),
                    type: 'verification_granted'
                });
                
                alert('âœ… Verification badge granted successfully!');
                
                // Reset the form
                document.getElementById('grant-user-search').value = '';
                document.getElementById('grant-user-list').innerHTML = '<div style="text-align: center; padding: 20px; color: var(--text-muted); font-size: 11px;">Type to search for users...</div>';
                selectedGrantUser = null;
                document.getElementById('grant-verify-btn').disabled = true;
                
                // Refresh verification requests list
                loadVerificationRequests();
            }).catch(err => {
                console.error('Error granting verification:', err);
                alert('âŒ Failed to grant verification badge');
            });
        });
    }
    
    // Load verification requests when the tab is opened
    const verificationTab = document.getElementById('verification-tab');
    if (verificationTab) {
        const observer = new MutationObserver((mutations) => {
            mutations.forEach((mutation) => {
                if (mutation.target.classList.contains('active') && mutation.target.id === 'verification-tab') {
                    loadVerificationRequests();
                    searchUsersForGrant(); // Load all users in grant section
                }
            });
        });
        
        observer.observe(verificationTab, { attributes: true, attributeFilter: ['class'] });
    }
    
    // ===============================================
    // CONTENT CREATOR MANAGEMENT SYSTEM
    // ===============================================
    
    // Search users for promotion to creator
    function searchUsersForPromotion() {
        const query = document.getElementById('promote-search').value.toLowerCase().trim();
        const results = document.getElementById('promote-results');
        
        if (!query) {
            results.innerHTML = '<div style="opacity:0.5; text-align:center; padding:20px; font-size:12px;">Start typing to search users...</div>';
            return;
        }
        
        db.ref('users').once('value').then(snap => {
            const users = snap.val() || {};
            const matches = [];
            
            Object.entries(users).forEach(([uid, user]) => {
                const name = (user.name || user.username || user.displayName || '').toLowerCase();
                if (name.includes(query) && !user.isContentCreator) {
                    matches.push({ uid, ...user });
                }
            });
            
            if (matches.length === 0) {
                results.innerHTML = '<div style="opacity:0.5; text-align:center; padding:20px; font-size:12px;">No users found or already creators</div>';
                return;
            }
            
            results.innerHTML = '';
            matches.slice(0, 10).forEach(user => {
                const div = document.createElement('div');
                div.className = 'user-option';
                div.style.cursor = 'pointer';
                div.innerHTML = `
                    <div style="flex:1;">
                        <strong>${user.name || user.username || user.displayName || 'User'}</strong>
                        <div style="font-size:10px; color:var(--text-muted); margin-top:2px;">
                            ${user.points || 0} points â€¢ ${user.bingoWins || 0} wins
                        </div>
                    </div>
                    <button class="btn btn-creator" onclick="promoteToCreator('${user.uid}', '${(user.name || '').replace(/'/g, "\\'")}'); event.stopPropagation();" style="padding:6px 12px; font-size:10px; margin:0;">
                        Promote
                    </button>
                `;
                results.appendChild(div);
            });
        });
    }
    
    // Promote user to content creator
    function promoteToCreator(uid, name) {
        if (!confirm(`Promote ${name} to Content Creator? They will get 2x points multiplier and follower system.`)) return;
        
        db.ref('users/' + uid).update({
            isContentCreator: true,
            creatorPromotedAt: Date.now(),
            creatorPoints: 0,
            creatorVideoViews: 0,
            fakeFollowers: 0,
            fakeReactionsPerPost: 0
        }).then(() => {
            // Send notification
            db.ref('notifications/' + uid).push({
                msg: 'ðŸŒŸ Congratulations! You are now a Content Creator! You earn double points and can gain followers.',
                time: Date.now(),
                type: 'creator_promotion'
            });
            
            alert('âœ… User promoted to Content Creator!');
            document.getElementById('promote-search').value = '';
            searchUsersForPromotion();
            loadCreators();
            updateCreatorStats();
        }).catch(err => {
            console.error('Error promoting user:', err);
            alert('âŒ Failed to promote user');
        });
    }
    
    // Load content creators list
    function loadCreators() {
        const list = document.getElementById('creator-list');
        list.innerHTML = '<div style="text-align:center;padding:20px;">Loading...</div>';
        
        db.ref('users').orderByChild('isContentCreator').equalTo(true).once('value').then(snap => {
            const creators = snap.val() || {};
            list.innerHTML = '';
            
            if (Object.keys(creators).length === 0) {
                list.innerHTML = '<div style="opacity:0.5; text-align:center; padding:40px; font-size:12px;">No content creators yet</div>';
                return;
            }
            
            Object.entries(creators).forEach(([uid, creator]) => {
                const div = document.createElement('div');
                div.className = 'user-option creator-card';
                div.style.padding = '15px';
                div.style.border = '2px solid rgba(245, 158, 11, 0.2)';
                
                const displayName = creator.name || creator.username || creator.displayName || uid;
                const verifiedBadge = creator.verified ? 'âœ“ Verified' : '';
                
                // Calculate real followers
                const realFollowers = creator.followers ? Object.keys(creator.followers).length : 0;
                const fakeFollowers = creator.fakeFollowers || 0;
                const totalFollowers = realFollowers + fakeFollowers;
                
                // Calculate fake reactions per post
                const fakeReactionsPerPost = creator.fakeReactionsPerPost || 0;
                
                div.innerHTML = `
                    <div style="flex:1;">
                        <div style="display:flex;align-items:center;gap:8px;margin-bottom:8px;">
                            <strong>${displayName}</strong>
                            ${verifiedBadge}
                            <span class="creator-badge">â˜… Creator</span>
                        </div>
                        <div style="font-size:10px;color:var(--text-muted);">
                            ðŸ‘¥ ${totalFollowers} followers (${fakeFollowers} fake) â€¢ 
                            â¤ï¸ ${fakeReactionsPerPost} fake reactions per post â€¢ 
                            ðŸ‘ï¸ ${creator.creatorVideoViews || 0} video views
                        </div>
                    </div>
                    <div style="display:flex;gap:8px;">
                        <button class="btn btn-creator" onclick="openMetricsModal('${uid}', '${displayName.replace(/'/g, "\\'")}')" style="padding:6px 12px;font-size:10px;">
                            Adjust
                        </button>
                        <button class="btn btn-danger" onclick="demoteCreator('${uid}', '${displayName.replace(/'/g, "\\'")}')" style="padding:6px 12px;font-size:10px;">
                            Demote
                        </button>
                    </div>
                `;
                
                list.appendChild(div);
            });
        });
    }
    
    // Open metrics adjustment modal
    function openMetricsModal(uid, name) {
        db.ref('users/' + uid).once('value').then(snap => {
            const user = snap.val();
            const fakeFollowers = user.fakeFollowers || 0;
            const fakeReactionsPerPost = user.fakeReactionsPerPost || 0;
            
            const modal = prompt(
                `Adjust Fake Metrics for ${name}\n\n` +
                `Current Fake Followers: ${fakeFollowers}\n` +
                `Current Fake Reactions Per Post: ${fakeReactionsPerPost}\n\n` +
                `Enter new values separated by comma (followers,reactions_per_post):\n` +
                `Example: 5000,100`,
                `${fakeFollowers},${fakeReactionsPerPost}`
            );
            
            if (modal !== null) {
                const [newFollowers, newReactionsPerPost] = modal.split(',').map(v => parseInt(v.trim()) || 0);
                
                db.ref('users/' + uid).update({
                    fakeFollowers: newFollowers,
                    fakeReactionsPerPost: newReactionsPerPost
                }).then(() => {
                    alert('âœ… Metrics updated!');
                    loadCreators();
                    updateCreatorStats();
                }).catch(err => {
                    console.error('Error updating metrics:', err);
                    alert('âŒ Failed to update metrics');
                });
            }
        });
    }
    
    // Demote creator
    function demoteCreator(uid, name) {
        if (!confirm(`Remove Content Creator status from ${name}?`)) return;
        
        db.ref('users/' + uid).update({
            isContentCreator: false,
            creatorDemotedAt: Date.now()
        }).then(() => {
            db.ref('notifications/' + uid).push({
                msg: 'âš ï¸ Your Content Creator status has been removed by an admin.',
                time: Date.now(),
                type: 'creator_demotion'
            });
            
            alert('âœ… Creator demoted');
            loadCreators();
            updateCreatorStats();
        }).catch(err => {
            console.error('Error demoting creator:', err);
            alert('âŒ Failed to demote creator');
        });
    }
    
    // Update creator stats
    function updateCreatorStats() {
        db.ref('users').orderByChild('isContentCreator').equalTo(true).once('value').then(snap => {
            const creators = snap.val() || {};
            let totalFollowers = 0;
            let totalVideoViews = 0;
            
            Object.values(creators).forEach(creator => {
                const realFollowers = creator.followers ? Object.keys(creator.followers).length : 0;
                const fakeFollowers = creator.fakeFollowers || 0;
                totalFollowers += realFollowers + fakeFollowers;
                totalVideoViews += creator.creatorVideoViews || 0;
            });
            
            // Count creator posts
            db.ref('socialPosts').once('value').then(postsSnap => {
                const posts = postsSnap.val() || {};
                let totalPosts = 0;
                Object.values(posts).forEach(post => {
                    if (creators[post.uid]) totalPosts++;
                });
                
                document.getElementById('totalCreatorsCount').textContent = Object.keys(creators).length;
                document.getElementById('totalFollowers').textContent = totalFollowers;
                document.getElementById('totalVideoViews').textContent = totalVideoViews;
                document.getElementById('totalCreatorPosts').textContent = totalPosts;
            });
        });
    }
    
    // Load creators when creators tab is opened
    const creatorsTab = document.getElementById('creators-tab');
    if (creatorsTab) {
        const tabObserver = new MutationObserver((mutations) => {
            mutations.forEach((mutation) => {
                if (mutation.target.classList.contains('active') && mutation.target.id === 'creators-tab') {
                    loadCreators();
                    updateCreatorStats();
                    populateCreatorSelect();
                }
            });
        });
        
        tabObserver.observe(creatorsTab, { attributes: true, attributeFilter: ['class'] });
    }
    
    // ===============================================
    // CREATOR POSTS & REACTIONS MANAGEMENT
    // ===============================================
    
    // Populate creator dropdown
    function populateCreatorSelect() {
        const select = document.getElementById('post-creator-select');
        select.innerHTML = '<option value="">-- Select a Creator --</option>';
        
        db.ref('users').orderByChild('isContentCreator').equalTo(true).once('value').then(snap => {
            const creators = snap.val() || {};
            
            Object.entries(creators).forEach(([uid, creator]) => {
                const option = document.createElement('option');
                option.value = uid;
                option.textContent = creator.name || creator.username || creator.displayName || uid;
                select.appendChild(option);
            });
        });
    }
    
    // Load creator posts
    function loadCreatorPosts(creatorUid) {
        const container = document.getElementById('creator-posts-container');
        
        if (!creatorUid) {
            container.innerHTML = '<div style="opacity:0.5; text-align:center; padding:40px; font-size:12px;">Select a creator to view their posts</div>';
            return;
        }
        
        container.innerHTML = '<div style="text-align:center; padding:40px;"><div class="loading-spinner"></div><div style="margin-top:10px; opacity:0.7;">Loading posts...</div></div>';
        
        db.ref('socialPosts').orderByChild('uid').equalTo(creatorUid).limitToLast(20).once('value').then(snap => {
            if (!snap.exists()) {
                container.innerHTML = '<div style="opacity:0.5; text-align:center; padding:40px; font-size:12px;">No posts yet from this creator</div>';
                return;
            }
            
            const posts = [];
            snap.forEach(child => {
                const post = child.val();
                if (!post.deleted) {
                    posts.push({ key: child.key, ...post });
                }
            });
            
            if (posts.length === 0) {
                container.innerHTML = '<div style="opacity:0.5; text-align:center; padding:40px; font-size:12px;">No posts yet from this creator</div>';
                return;
            }
            
            container.innerHTML = '';
            posts.reverse().forEach(post => {
                const postCard = createPostCard(post, creatorUid);
                container.appendChild(postCard);
            });
            
            lucide.createIcons();
        }).catch(err => {
            console.error('Error loading posts:', err);
            container.innerHTML = '<div style="color:var(--danger); text-align:center; padding:40px; font-size:12px;">Error loading posts</div>';
        });
    }
    
    // Create post card
    function createPostCard(post, creatorUid) {
        const card = document.createElement('div');
        card.className = 'creator-post-card';
        card.id = 'post-card-' + post.key;
        
        const timestamp = new Date(post.timestamp).toLocaleString('en-PH', {
            month: 'short',
            day: 'numeric',
            hour: '2-digit',
            minute: '2-digit'
        });
        
        const imageHtml = post.image ? `<img src="${post.image}" class="post-image-preview" alt="Post image">` : '';
        const videoHtml = post.video ? `<video src="${post.video}" class="post-image-preview" controls></video>` : '';
        
        card.innerHTML = `
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                <div style="font-size:11px; color:var(--text-muted);">
                    <i data-lucide="calendar" style="width:12px; vertical-align:middle;"></i> ${timestamp}
                </div>
                <div style="font-size:11px; color:#f59e0b; font-weight:700;">
                    POST ID: ${post.key.substring(0, 8)}
                </div>
            </div>
            
            ${post.mood ? `<div style="font-size:11px; color:var(--accent-glow); margin-bottom:8px;">ðŸ˜Š Feeling ${post.mood}</div>` : ''}
            
            <div class="post-content-text">${escapeHtml(post.content || '')}</div>
            
            ${imageHtml}
            ${videoHtml}
            
            <div class="post-stats">
                <span><i data-lucide="heart" style="width:14px; vertical-align:middle;"></i> <strong id="likes-${post.key}">${post.likes || 0}</strong> reactions</span>
                <span><i data-lucide="message-circle" style="width:14px; vertical-align:middle;"></i> <span id="comments-${post.key}">0</span> comments</span>
            </div>
            
            <div class="reaction-control-panel">
                <span style="font-size:11px; font-weight:700; color:var(--accent);">
                    <i data-lucide="zap" style="width:14px; vertical-align:middle;"></i> Add Reactions:
                </span>
                <input type="number" class="reaction-input" id="reaction-amount-${post.key}" placeholder="0" min="0" value="0">
                <button class="add-reaction-btn" onclick="addBulkReactions('${post.key}', '${creatorUid}')">
                    <i data-lucide="plus-circle" style="width:14px; vertical-align:middle;"></i> ADD
                </button>
            </div>
            
            <div class="reaction-control-panel" style="background:rgba(6, 182, 212, 0.05); border-color:rgba(6, 182, 212, 0.2); margin-top:8px;">
                <span style="font-size:11px; font-weight:700; color:var(--cyan);">
                    <i data-lucide="message-square" style="width:14px; vertical-align:middle;"></i> Add Comments:
                </span>
                <input type="number" class="reaction-input" id="comment-amount-${post.key}" placeholder="0" min="0" value="0">
                <button class="add-reaction-btn" onclick="addBulkComments('${post.key}', '${creatorUid}')" style="background:linear-gradient(135deg, var(--cyan), #0891b2);">
                    <i data-lucide="plus-circle" style="width:14px; vertical-align:middle;"></i> ADD
                </button>
            </div>
        `;
        
        // Load comment count
        db.ref('postComments/' + post.key).once('value').then(commentSnap => {
            const commentCount = commentSnap.numChildren();
            const commentEl = card.querySelector('#comments-' + post.key);
            if (commentEl) commentEl.textContent = commentCount;
        });
        
        return card;
    }
    
    // Add bulk reactions to a post
    function addBulkReactions(postKey, creatorUid) {
        const input = document.getElementById('reaction-amount-' + postKey);
        const amount = parseInt(input.value) || 0;
        
        if (amount <= 0) {
            alert('Please enter a valid number of reactions (greater than 0)');
            return;
        }
        
        if (amount > 1000) {
            alert('Maximum 1,000 reactions at a time (to avoid performance issues)');
            return;
        }
        
        if (!confirm(`Add ${amount} REAL reactions from actual users to this post?\n\nThis will select ${amount} random users and record their reactions.`)) return;
        
        const btn = event.target.closest('button');
        const originalText = btn.innerHTML;
        btn.disabled = true;
        btn.innerHTML = '<i data-lucide="loader" style="width:14px; vertical-align:middle; animation:spin 1s linear infinite;"></i> Processing...';
        btn.style.background = 'rgba(139, 92, 246, 0.5)';
        
        // Get all users
        db.ref('users').once('value').then(usersSnap => {
            const users = usersSnap.val() || {};
            const userIds = Object.keys(users);
            
            if (userIds.length === 0) {
                alert('No users found in the system');
                btn.disabled = false;
                btn.innerHTML = originalText;
                btn.style.background = 'linear-gradient(135deg, var(--accent), var(--accent-secondary))';
                lucide.createIcons();
                return;
            }
            
            // Get existing reactions to avoid duplicates
            db.ref('postLikes/' + postKey).once('value').then(likesSnap => {
                const existingReactors = likesSnap.exists() ? Object.keys(likesSnap.val()) : [];
                
                // Filter out users who already reacted
                const availableUsers = userIds.filter(uid => !existingReactors.includes(uid));
                
                if (availableUsers.length === 0) {
                    alert('All users have already reacted to this post!');
                    btn.disabled = false;
                    btn.innerHTML = originalText;
                    btn.style.background = 'linear-gradient(135deg, var(--accent), var(--accent-secondary))';
                    lucide.createIcons();
                    return;
                }
                
                // Limit amount to available users
                const actualAmount = Math.min(amount, availableUsers.length);
                
                if (actualAmount < amount) {
                    if (!confirm(`Only ${actualAmount} users available (${availableUsers.length} haven't reacted yet).\n\nContinue with ${actualAmount} reactions?`)) {
                        btn.disabled = false;
                        btn.innerHTML = originalText;
                        btn.style.background = 'linear-gradient(135deg, var(--accent), var(--accent-secondary))';
                        lucide.createIcons();
                        return;
                    }
                }
                
                // Randomly select users
                const shuffled = availableUsers.sort(() => 0.5 - Math.random());
                const selectedUsers = shuffled.slice(0, actualAmount);
                
                // Prepare reaction emojis
                const emojis = ['â¤ï¸', 'ðŸ˜‚', 'ðŸ˜®', 'ðŸ˜¢', 'ðŸ‘', 'ðŸ”¥', 'ðŸ˜'];
                
                // Add reactions from selected users
                const updates = {};
                let addedCount = 0;
                const notificationPromises = [];
                
                selectedUsers.forEach(uid => {
                    const randomEmoji = emojis[Math.floor(Math.random() * emojis.length)];
                    updates[`postLikes/${postKey}/${uid}`] = randomEmoji;
                    addedCount++;
                    
                    // Send notification to creator for each reaction (batched)
                    const userName = users[uid]?.name || users[uid]?.username || 'Someone';
                    notificationPromises.push(
                        db.ref(`notifications/${creatorUid}`).push({
                            msg: `${userName} reacted ${randomEmoji} to your post`,
                            time: Date.now(),
                            type: 'post_reaction',
                            from: uid,
                            postKey: postKey
                        })
                    );
                });
                
                // Update the database
                db.ref().update(updates).then(() => {
                    // Send all notifications
                    return Promise.all(notificationPromises);
                }).then(() => {
                    // Update the likes count
                    const newTotal = existingReactors.length + addedCount;
                    return db.ref('socialPosts/' + postKey + '/likes').set(newTotal);
                }).then(() => {
                    // Update UI
                    const newTotal = existingReactors.length + addedCount;
                    document.getElementById('likes-' + postKey).textContent = newTotal;
                    input.value = 0;
                    
                    // Show success message
                    btn.innerHTML = `<i data-lucide="check" style="width:14px; vertical-align:middle;"></i> ${addedCount} ADDED!`;
                    btn.style.background = 'linear-gradient(135deg, var(--success), #059669)';
                    
                    setTimeout(() => {
                        btn.disabled = false;
                        btn.innerHTML = originalText;
                        btn.style.background = 'linear-gradient(135deg, var(--accent), var(--accent-secondary))';
                        lucide.createIcons();
                    }, 3000);
                    
                    lucide.createIcons();
                }).catch(err => {
                    console.error('Error adding reactions:', err);
                    alert('Failed to add reactions. Please try again.');
                    btn.disabled = false;
                    btn.innerHTML = originalText;
                    btn.style.background = 'linear-gradient(135deg, var(--accent), var(--accent-secondary))';
                    lucide.createIcons();
                });
            });
        }).catch(err => {
            console.error('Error fetching users:', err);
            alert('Failed to fetch users. Please try again.');
            btn.disabled = false;
            btn.innerHTML = originalText;
            btn.style.background = 'linear-gradient(135deg, var(--accent), var(--accent-secondary))';
            lucide.createIcons();
        });
    }
    }
    
    // Escape HTML for security
    
    // ===============================================
    // BULK COMMENT GENERATOR
    // ===============================================
    
    // Random comment templates
    const commentTemplates = [
        "Nice post! ðŸ‘",
        "Love this! â¤ï¸",
        "Amazing content! ðŸ”¥",
        "Keep it up! ðŸ’ª",
        "So cool! ðŸ˜",
        "Great work! â­",
        "Awesome! ðŸŽ‰",
        "This is fire! ðŸ”¥ðŸ”¥",
        "I love it! ðŸ’•",
        "Beautiful! âœ¨",
        "Wow! ðŸ˜®",
        "Incredible! ðŸ‘",
        "So good! ðŸ‘Œ",
        "Perfect! ðŸ’¯",
        "Nailed it! ðŸŽ¯",
        "Superb! ðŸŒŸ",
        "Outstanding! ðŸ†",
        "Fantastic! ðŸŽŠ",
        "Brilliant! ðŸ’¡",
        "Impressive! ðŸ‘€",
        "Love your posts! ðŸ’–",
        "Always amazing content! â­â­",
        "You're the best! ðŸ¥‡",
        "Keep posting! ðŸ“¸",
        "More of this please! ðŸ™",
        "Can't get enough! ðŸ˜Š",
        "So inspiring! âœ¨âœ¨",
        "This made my day! â˜€ï¸",
        "Legend! ðŸ”¥",
        "Pure gold! ðŸ’›"
    ];
    
    function addBulkComments(postKey, creatorUid) {
        const input = document.getElementById('comment-amount-' + postKey);
        const amount = parseInt(input.value) || 0;
        
        if (amount <= 0) {
            alert('Please enter a valid number of comments (greater than 0)');
            return;
        }
        
        if (amount > 500) {
            alert('Maximum 500 comments at a time (to avoid performance issues)');
            return;
        }
        
        if (!confirm(`Add ${amount} REAL comments from actual users to this post?\n\nRandom users will be selected and realistic comments will be generated.`)) return;
        
        const btn = event.target.closest('button');
        const originalText = btn.innerHTML;
        btn.disabled = true;
        btn.innerHTML = '<i data-lucide="loader" style="width:14px; vertical-align:middle; animation:spin 1s linear infinite;"></i> Processing...';
        btn.style.background = 'rgba(6, 182, 212, 0.5)';
        
        // Get all users
        db.ref('users').once('value').then(usersSnap => {
            const users = usersSnap.val() || {};
            const userIds = Object.keys(users);
            
            if (userIds.length === 0) {
                alert('No users found in the system');
                btn.disabled = false;
                btn.innerHTML = originalText;
                btn.style.background = 'linear-gradient(135deg, var(--cyan), #0891b2)';
                lucide.createIcons();
                return;
            }
            
            // Limit amount to available users (can comment multiple times, but let's keep it reasonable)
            const actualAmount = Math.min(amount, userIds.length * 2); // Each user can comment up to 2 times max
            
            if (actualAmount < amount) {
                if (!confirm(`Adjusted to ${actualAmount} comments for better distribution.\n\nContinue?`)) {
                    btn.disabled = false;
                    btn.innerHTML = originalText;
                    btn.style.background = 'linear-gradient(135deg, var(--cyan), #0891b2)';
                    lucide.createIcons();
                    return;
                }
            }
            
            // Randomly select users with possible repeats
            const selectedComments = [];
            for (let i = 0; i < actualAmount; i++) {
                const randomUserIndex = Math.floor(Math.random() * userIds.length);
                const randomUid = userIds[randomUserIndex];
                const randomComment = commentTemplates[Math.floor(Math.random() * commentTemplates.length)];
                
                selectedComments.push({
                    uid: randomUid,
                    text: randomComment,
                    userName: users[randomUid]?.name || users[randomUid]?.username || 'Someone'
                });
            }
            
            // Add comments to database
            const commentPromises = [];
            const notificationPromises = [];
            
            selectedComments.forEach(comment => {
                const commentRef = db.ref(`postComments/${postKey}`).push();
                commentPromises.push(
                    commentRef.set({
                        uid: comment.uid,
                        text: comment.text,
                        time: Date.now()
                    })
                );
                
                // Send notification to creator
                notificationPromises.push(
                    db.ref(`notifications/${creatorUid}`).push({
                        msg: `${comment.userName} commented on your post: "${comment.text}"`,
                        time: Date.now(),
                        type: 'post_comment',
                        from: comment.uid,
                        postKey: postKey
                    })
                );
            });
            
            // Execute all promises
            Promise.all([...commentPromises, ...notificationPromises]).then(() => {
                // Update comment count in UI
                return db.ref('postComments/' + postKey).once('value');
            }).then(commentSnap => {
                const newCommentCount = commentSnap.numChildren();
                document.getElementById('comments-' + postKey).textContent = newCommentCount;
                input.value = 0;
                
                // Show success message
                btn.innerHTML = `<i data-lucide="check" style="width:14px; vertical-align:middle;"></i> ${actualAmount} ADDED!`;
                btn.style.background = 'linear-gradient(135deg, var(--success), #059669)';
                
                setTimeout(() => {
                    btn.disabled = false;
                    btn.innerHTML = originalText;
                    btn.style.background = 'linear-gradient(135deg, var(--cyan), #0891b2)';
                    lucide.createIcons();
                }, 3000);
                
                lucide.createIcons();
            }).catch(err => {
                console.error('Error adding comments:', err);
                alert('Failed to add comments. Please try again.');
                btn.disabled = false;
                btn.innerHTML = originalText;
                btn.style.background = 'linear-gradient(135deg, var(--cyan), #0891b2)';
                lucide.createIcons();
            });
        }).catch(err => {
            console.error('Error fetching users:', err);
            alert('Failed to fetch users. Please try again.');
            btn.disabled = false;
            btn.innerHTML = originalText;
            btn.style.background = 'linear-gradient(135deg, var(--cyan), #0891b2)';
            lucide.createIcons();
        });
    }
</script>

</body>
</html>
