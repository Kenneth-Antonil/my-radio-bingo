<!DOCTYPE html>
<html lang="tl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Radio Bingo | Admin Master Pro 3D</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <style>
        :root { 
            --bg-dark: #0f172a;
            --bg-gradient: linear-gradient(135deg, #0f172a 0%, #1e1b4b 100%);
            --glass-surface: rgba(30, 41, 59, 0.7);
            --glass-border: rgba(255, 255, 255, 0.08);
            --glass-highlight: rgba(255, 255, 255, 0.1);
            
            --accent: #3b82f6; 
            --accent-glow: rgba(59, 130, 246, 0.5);
            
            --text: #f8fafc; 
            --text-muted: #94a3b8;
            
            --success: #10b981; 
            --danger: #ef4444; 
            --gold: #f59e0b; 
            --gold-glow: rgba(245, 158, 11, 0.5);
            --puro: #f97316;
            --bringme: #8b5cf6;
            
            --radius-lg: 20px;
            --radius-md: 12px;
            --shadow-card: 0 10px 30px -10px rgba(0,0,0,0.5);
        }

        * { box-sizing: border-box; }
        
        body { 
            font-family: 'Inter', sans-serif; 
            background: var(--bg-gradient); 
            background-attachment: fixed;
            color: var(--text); 
            margin: 0; 
            padding: 20px; 
            display: grid; 
            grid-template-columns: 320px 1fr; 
            gap: 24px; 
            height: 100vh;
            overflow: hidden;
        }

        /* 3D SCROLLBAR */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: rgba(0,0,0,0.1); }
        ::-webkit-scrollbar-thumb { background: var(--glass-border); border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--accent); }

        /* GLASS COMPONENTS */
        .card, .sidebar, .tabs-nav { 
            background: var(--glass-surface); 
            backdrop-filter: blur(12px); 
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid var(--glass-border); 
            box-shadow: var(--shadow-card);
        }

        /* SIDEBAR */
        .sidebar { 
            border-radius: var(--radius-lg); 
            padding: 24px; 
            overflow-y: auto; 
            display: flex; 
            flex-direction: column; 
            gap: 20px; 
            height: calc(100vh - 40px);
        }
        
        .logo-text {
            font-size: 24px; 
            font-weight: 900; 
            letter-spacing: -1px;
            text-transform: uppercase;
            background: linear-gradient(to right, #fff, #94a3b8);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 10px;
            text-shadow: 0 2px 10px rgba(255,255,255,0.1);
        }

        /* STATS 3D */
        .stat-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
        .stat-card { 
            background: rgba(0,0,0,0.2); 
            padding: 15px; 
            border-radius: var(--radius-md); 
            text-align: center; 
            border: 1px solid var(--glass-border);
            position: relative;
            overflow: hidden;
        }
        .stat-card::before {
            content: ''; position: absolute; top:0; left:0; width:100%; height:2px;
            background: linear-gradient(90deg, transparent, var(--accent), transparent);
        }
        .stat-val { font-size: 24px; font-weight: 900; color: white; text-shadow: 0 0 10px var(--accent-glow); }
        .stat-lbl { font-size: 10px; color: var(--text-muted); font-weight: 700; letter-spacing: 1px; margin-top: 5px; }

        /* TABS 3D */
        .tabs-nav { 
            display: flex; 
            gap: 5px; 
            margin-bottom: 20px; 
            padding: 8px; 
            border-radius: 16px; 
        }
        .tab-btn { 
            flex: 1; 
            padding: 12px; 
            border-radius: 10px; 
            border: none; 
            background: transparent; 
            color: var(--text-muted); 
            font-weight: 700; 
            cursor: pointer; 
            transition: 0.3s cubic-bezier(0.4, 0, 0.2, 1); 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            gap: 8px; 
            font-size: 13px;
        }
        .tab-btn:hover { background: rgba(255,255,255,0.05); color: white; }
        .tab-btn.active { 
            background: var(--accent); 
            color: white; 
            box-shadow: 0 4px 15px var(--accent-glow);
            transform: translateY(-1px);
        }
        
        .tab-content { display: none; height: calc(100vh - 140px); overflow-y: auto; padding-right: 10px; padding-bottom: 20px; }
        .tab-content.active { display: block; animation: fadeIn 0.3s ease; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* WINNER MARQUEE 3D */
        .winner-marquee { 
            background: linear-gradient(90deg, var(--gold), #fbbf24, var(--gold)); 
            color: #451a03; 
            padding: 12px; 
            font-weight: 900; 
            text-transform: uppercase; 
            white-space: nowrap; 
            overflow: hidden; 
            position: relative; 
            border-radius: 12px; 
            margin-bottom: 20px; 
            display: none; 
            box-shadow: 0 0 20px var(--gold-glow);
            border: 1px solid #fde68a;
        }
        .marquee-text { display: inline-block; animation: marquee 15s linear infinite; }
        @keyframes marquee { 0% { transform: translateX(100%); } 100% { transform: translateX(-100%); } }

        /* CARD MONITORING 3D & SHINY */
        .cards-grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); 
            gap: 15px; 
        }
        .user-card-monitor { 
            background: rgba(15, 23, 42, 0.6); 
            padding: 12px; 
            border-radius: 16px; 
            border: 1px solid var(--glass-border); 
            transition: all 0.3s ease; 
            position: relative; 
            box-shadow: 0 4px 6px rgba(0,0,0,0.2);
        }
        
        /* Offline State */
        .user-card-monitor.offline {
            opacity: 0.4;
            filter: grayscale(100%);
            border: 1px dashed #334155;
            background: transparent;
            transform: scale(0.98);
        }

        .user-card-monitor.puro { 
            border-color: var(--puro); 
            box-shadow: 0 0 15px rgba(249, 115, 22, 0.3); 
            animation: pulse-puro 1.5s infinite; 
            background: linear-gradient(145deg, rgba(249, 115, 22, 0.1), rgba(15, 23, 42, 0.8));
        }
        .user-card-monitor.bingo { 
            border-color: var(--success); 
            background: linear-gradient(145deg, rgba(6, 78, 59, 0.9), #064e3b); 
            box-shadow: 0 0 25px rgba(16, 185, 129, 0.6); 
            transform: scale(1.05) translateY(-5px); 
            z-index: 10; 
        }
        
        .monitor-badge { 
            position: absolute; 
            top: -8px; 
            right: -8px; 
            padding: 4px 10px; 
            border-radius: 20px; 
            font-size: 10px; 
            font-weight: 900; 
            color: white; 
            display: none; 
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
            text-shadow: 0 1px 2px rgba(0,0,0,0.2);
        }
        .puro .monitor-badge { display: block; background: var(--puro); content: "PURO!"; }
        .bingo .monitor-badge { display: block; background: var(--success); content: "BINGO!"; }

        @keyframes pulse-puro { 0% { box-shadow: 0 0 0 0 rgba(249, 115, 22, 0.4); } 70% { box-shadow: 0 0 0 10px rgba(249, 115, 22, 0); } 100% { box-shadow: 0 0 0 0 rgba(249, 115, 22, 0); } }
        
        .mini-bingo-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 3px; margin-top: 10px; }
        .mini-cell { 
            aspect-ratio: 1; 
            background: rgba(0,0,0,0.4); 
            font-size: 9px; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            border-radius: 4px; 
            color: rgba(255,255,255,0.2); 
            font-weight: 700;
        }
        .mini-cell.marked { background: var(--accent); color: white; box-shadow: 0 0 5px var(--accent-glow); }
        .mini-cell.hit { background: var(--gold); color: black; box-shadow: 0 0 8px var(--gold-glow); animation: pop 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); } 
        @keyframes pop { 0% { transform: scale(0.5); } 100% { transform: scale(1); } }

        /* BALLS 3D SPHERES */
        .ball-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(45px, 1fr)); gap: 8px; margin-top: 15px; }
        .ball { 
            aspect-ratio: 1; 
            background: linear-gradient(145deg, #334155, #1e293b); 
            border-radius: 50%; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            font-weight: 800; 
            cursor: pointer; 
            font-size: 14px; 
            border: 1px solid rgba(255,255,255,0.1); 
            transition: all 0.2s;
            box-shadow: inset 2px 2px 5px rgba(255,255,255,0.05), 0 5px 10px rgba(0,0,0,0.3);
            position: relative;
        }
        .ball::after { content: ''; position: absolute; top: 15%; left: 20%; width: 25%; height: 25%; background: radial-gradient(circle, rgba(255,255,255,0.8), transparent); border-radius: 50%; opacity: 0.4; }
        .ball:hover { transform: translateY(-2px); border-color: var(--accent); }
        .ball.drawn { 
            background: radial-gradient(circle at 30% 30%, #60a5fa, #2563eb); 
            color: white; 
            box-shadow: 0 0 15px var(--accent-glow), inset -5px -5px 10px rgba(0,0,0,0.2); 
            border: none;
            transform: scale(1.1);
        }
        
        /* INPUTS & BUTTONS 3D */
        .input-group { margin-bottom: 20px; }
        label { display: block; font-size: 11px; font-weight: 800; color: var(--text-muted); margin-bottom: 8px; text-transform: uppercase; letter-spacing: 0.5px; }
        input, select, textarea { 
            width: 100%; 
            background: rgba(0,0,0,0.3); 
            border: 1px solid var(--glass-border); 
            padding: 14px; 
            border-radius: 12px; 
            color: white; 
            outline: none; 
            font-family: inherit; 
            font-size: 13px;
            transition: 0.3s;
        }
        input:focus, select:focus, textarea:focus { border-color: var(--accent); background: rgba(0,0,0,0.5); box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.1); }
        
        .btn { 
            width: 100%; 
            padding: 14px; 
            border-radius: 12px; 
            border: none; 
            font-weight: 800; 
            cursor: pointer; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            gap: 8px; 
            margin-top: 10px; 
            transition: all 0.2s; 
            text-transform: uppercase;
            font-size: 12px;
            letter-spacing: 0.5px;
            position: relative;
            overflow: hidden;
        }
        .btn:active { transform: scale(0.97); }
        .btn-primary { background: linear-gradient(135deg, #3b82f6, #2563eb); color: white; box-shadow: 0 4px 15px rgba(37, 99, 235, 0.4); }
        .btn-primary:hover { filter: brightness(1.1); }
        .btn-danger { background: linear-gradient(135deg, #ef4444, #dc2626); color: white; box-shadow: 0 4px 15px rgba(220, 38, 38, 0.4); }
        .btn-bringme { background: linear-gradient(135deg, #8b5cf6, #7c3aed); color: white; box-shadow: 0 4px 15px rgba(124, 58, 237, 0.4); }
        .btn-gold { background: linear-gradient(135deg, #fbbf24, #d97706); color: black; box-shadow: 0 4px 15px rgba(217, 119, 6, 0.4); }

        /* STATUS BADGES & DOTS */
        .online-dot { width: 8px; height: 8px; background: var(--success); border-radius: 50%; box-shadow: 0 0 8px var(--success); display: inline-block; }
        .offline-dot { width: 8px; height: 8px; background: #475569; border-radius: 50%; display: inline-block; border: 1px solid rgba(255,255,255,0.1); }
        .status-badge { padding: 4px 12px; border-radius: 20px; font-size: 10px; font-weight: 800; text-transform: uppercase; }
        .status-active { background: var(--success); color: white; box-shadow: 0 0 10px rgba(16, 185, 129, 0.4); }
        .status-off { background: var(--danger); color: white; opacity: 0.8; }

        /* UTILS */
        .card { padding: 24px; border-radius: var(--radius-lg); margin-bottom: 24px; }
        h2 { margin-top: 0; font-size: 16px; font-weight: 700; display: flex; align-items: center; gap: 8px; margin-bottom: 20px; color: white; }
        
        .user-select-list { max-height: 250px; overflow-y: auto; background: rgba(0,0,0,0.2); border-radius: 12px; padding: 5px; border: 1px solid var(--glass-border); }
        .user-option { padding: 10px 12px; border-radius: 8px; cursor: pointer; font-size: 12px; display: flex; justify-content: space-between; border-bottom: 1px solid rgba(255,255,255,0.03); transition: 0.2s; }
        .user-option:hover { background: rgba(255,255,255,0.05); }
        .user-option.selected { background: var(--accent); color: white; border: none; }

        /* MOBILE RESPONSIVE */
        @media (max-width: 900px) {
            body { grid-template-columns: 1fr; overflow-y: auto; height: auto; }
            .sidebar { height: auto; max-height: 500px; }
            .tab-content { height: auto; overflow: visible; }
            .main-section { padding-bottom: 50px; }
        }
    </style>
</head>
<body>

<div class="sidebar">
    <div class="logo-text">ADMIN<span style="color:var(--accent)">PANEL</span> <span style="font-size:10px; vertical-align:middle; background:var(--gold); color:black; padding:2px 6px; border-radius:4px;">PRO</span></div>
    
    <div class="stat-grid">
        <div class="stat-card"><div class="stat-val" id="countOnline">0</div><div class="stat-lbl">ONLINE</div></div>
        <div class="stat-card"><div class="stat-val" id="countUsers">0</div><div class="stat-lbl">TOTAL</div></div>
    </div>

    <div class="card" style="padding: 15px; margin: 0; background: linear-gradient(145deg, rgba(245, 158, 11, 0.1), rgba(0,0,0,0)); border: 1px solid rgba(245, 158, 11, 0.3);">
        <label style="color:var(--gold)"><i data-lucide="trophy" style="width:12px"></i> Jackpot Prize</label>
        <input type="text" id="jackpotAmount" placeholder="e.g. â‚±5,000" style="margin-bottom:10px; text-align:center; font-weight:900; color:var(--gold); font-size:18px;">
        <div style="display:flex; align-items:center; gap:10px; cursor:pointer;" id="jackpotToggle" onclick="toggleJackpot()">
            <div style="width:44px; height:24px; background:rgba(0,0,0,0.3); border-radius:20px; position:relative; transition:0.3s;" id="jackpotKnobBg">
                <div style="width:18px; height:18px; background:white; border-radius:50%; position:absolute; top:3px; left:3px; transition:0.3s;" id="jackpotKnob"></div>
            </div>
            <span id="jackpotStatusText" style="font-size:10px; font-weight:800; color:var(--text-muted)">HIDDEN</span>
        </div>
    </div>

    <div class="input-group">
        <label>Game Schedule Manager</label>
        <div style="display: flex; gap: 8px;">
            <input type="datetime-local" id="schedInput" style="padding:10px;">
            <button class="btn btn-primary" onclick="addSchedule()" style="width: auto; margin-top: 0; padding:0 15px;">+</button>
        </div>
        <div id="scheduleList" style="margin-top:10px; max-height:100px; overflow-y:auto;"></div>
    </div>

    <div class="card" style="padding: 15px; background: rgba(0,0,0,0.2); flex:1; overflow:hidden; display:flex; flex-direction:column; margin:0;">
        <label>Active Users List (Online)</label>
        <div id="activeUsersList" style="flex:1; overflow-y: auto; font-size: 12px; margin-top:5px;"></div>
    </div>

    <button class="btn btn-danger" onclick="resetGame()"><i data-lucide="refresh-ccw"></i> RESET GAME</button>
</div>

<div class="main-section">
    <div id="winnerAnnounce" class="winner-marquee">
        <div class="marquee-text" id="winnerMarqueeText">MAY NANALO NA! CONGRATULATIONS SA ATING WINNER! ðŸŽ‰</div>
    </div>

    <div class="tabs-nav">
        <button class="tab-btn active" onclick="openTab('bingo-tab', this)"><i data-lucide="layout-grid" width="16"></i> BINGO</button>
        <button class="tab-btn" onclick="openTab('bringme-tab', this)"><i data-lucide="camera" width="16"></i> BRING ME</button>
        <button class="tab-btn" onclick="openTab('users-tab', this)"><i data-lucide="user-cog" width="16"></i> PLAYERS</button>
        <button class="tab-btn" onclick="openTab('cashout-tab', this)"><i data-lucide="wallet" width="16"></i> CASHOUTS</button>
    </div>

    <div id="bingo-tab" class="tab-content active">
        <div style="display:grid; grid-template-columns: 1fr 2fr; gap: 24px; align-items:start;">
            
            <div class="card">
                <h2><i data-lucide="settings"></i> Game Control</h2>
                <div class="input-group">
                    <label>Winning Pattern</label>
                    <select id="patternSelect" onchange="setPattern(this.value)">
                        <option value="Normal Bingo">Normal Bingo</option>
                        <option value="Blackout">Blackout</option>
                        <option value="Letter X">Letter X</option>
                        <option value="Four Corners">Four Corners</option>
                    </select>
                </div>
                
                <div style="background: rgba(16, 185, 129, 0.05); border: 1px solid rgba(16, 185, 129, 0.3); padding: 15px; border-radius: 16px; margin-bottom: 20px;">
                    <label style="color:var(--success); margin-bottom:8px; display:flex; justify-content:space-between;">
                        <span>AUTO DRAW MACHINE</span>
                        <span id="speedVal" style="color:white;">8s</span>
                    </label>
                    <div style="display:flex; gap:10px; align-items:center; margin-bottom:15px;">
                        <input type="range" id="drawSpeed" min="3" max="15" value="8" style="flex:1; accent-color: var(--success);" oninput="document.getElementById('speedVal').innerText=this.value+'s'">
                    </div>
                    <button class="btn btn-primary" id="btnAutoDraw" onclick="toggleAutoDraw()" style="background: linear-gradient(135deg, #059669, #047857); box-shadow: 0 4px 15px rgba(5, 150, 105, 0.4);">
                        <i data-lucide="play"></i> START AUTO DRAW
                    </button>
                </div>

                <div class="input-group">
                    <label>Current Ball</label>
                    <div id="lastBall" style="font-size: 70px; font-weight: 900; text-align: center; color: white; background: linear-gradient(145deg, var(--accent), #1e40af); border-radius: 20px; padding: 15px; box-shadow: 0 10px 20px rgba(0,0,0,0.3); text-shadow: 0 2px 5px rgba(0,0,0,0.3); border:1px solid rgba(255,255,255,0.2);">--</div>
                </div>
                
                <div style="font-size:10px; font-weight:800; opacity:0.5; margin-top:20px; letter-spacing:1px;">MANUAL OVERRIDE:</div>
                <div class="ball-grid" id="ballGrid"></div>
            </div>

            <div class="card">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                    <h2><i data-lucide="users"></i> Live Cards Monitoring</h2>
                    <div style="font-size:11px; display:flex; gap:15px; font-weight:600;">
                        <span style="display:flex; align-items:center; gap:6px"><div style="width:10px; height:10px; background:var(--puro); border-radius:3px;"></div> PURO</span>
                        <span style="display:flex; align-items:center; gap:6px"><div style="width:10px; height:10px; background:var(--success); border-radius:3px;"></div> BINGO</span>
                        <span style="display:flex; align-items:center; gap:6px"><div style="width:10px; height:10px; background:#475569; border-radius:3px; border:1px solid #64748b;"></div> OFFLINE</span>
                    </div>
                </div>
                <div class="cards-grid" id="liveCardsContainer">
                    </div>
            </div>
        </div>
    </div>

    <div id="users-tab" class="tab-content">
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap: 24px;">
            <div class="card">
                <h2><i data-lucide="coins"></i> Manage Points</h2>
                <div class="input-group">
                    <label>Select User</label>
                    <div id="pointsUserList" class="user-select-list"></div>
                    <input type="hidden" id="selectedUserForPoints">
                </div>
                <div class="input-group">
                    <label>Amount (+ or -)</label>
                    <input type="number" id="pointsAmount" placeholder="e.g. 500 or -500">
                </div>
                <button class="btn btn-primary" onclick="modifyUserPoints()">UPDATE POINTS</button>
            </div>

            <div class="card">
                <h2><i data-lucide="send"></i> Send Notification / Task</h2>
                <div class="input-group">
                    <label>Recipient</label>
                    <select id="notifRecipient">
                        <option value="all">ALL USERS</option>
                        <option value="selected">Selected User Only (From Left)</option>
                    </select>
                </div>
                <div class="input-group">
                    <label>Message / Task Instruction</label>
                    <textarea id="notifMessage" rows="5" placeholder="e.g. Bonus points! or Do this task..."></textarea>
                </div>
                <button class="btn btn-bringme" onclick="sendAdminNotification()">SEND NOTIFICATION</button>
            </div>
        </div>
    </div>

    <div id="bringme-tab" class="tab-content">
        <div class="card" style="background: linear-gradient(135deg, #4c1d95, #2e1065); border: 1px solid rgba(139, 92, 246, 0.3);">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                <h2 style="color:white; margin:0; text-shadow:0 0 10px rgba(139, 92, 246, 0.6);"><i data-lucide="zap"></i> AI BRING ME</h2>
                <div id="bringmeStatusBadge" class="status-badge status-off">OFFLINE</div>
            </div>
            <div style="display:grid; grid-template-columns: 2fr 1fr 1fr; gap:15px; align-items:end;">
                <div class="input-group" style="margin:0;">
                    <label style="color:rgba(255,255,255,0.7)">Item Target</label>
                    <input type="text" id="bringmeItemIn" placeholder="e.g. Spoon" style="background:rgba(255,255,255,0.1); border-color:rgba(255,255,255,0.2);">
                </div>
                <button class="btn btn-bringme" onclick="startBringMe()"><i data-lucide="play"></i> START</button>
                <button class="btn btn-danger" onclick="stopBringMe()"><i data-lucide="square"></i> STOP</button>
            </div>
        </div>
        <div class="card">
            <h2><i data-lucide="image"></i> Submissions Gallery</h2>
            <div id="bringmeGallery" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 15px; margin-top: 20px;"></div>
        </div>
    </div>

    <div id="cashout-tab" class="tab-content">
        <div class="card">
            <h2><i data-lucide="wallet"></i> GCash Requests</h2>
            <div id="cashoutList"></div>
        </div>
    </div>
</div>

<script>
    lucide.createIcons();
    const firebaseConfig = { apiKey: "AIzaSyDIAQXJ15atKJxu7PtcFL1W9JnO1N14pVs", authDomain: "radiobingo-9ac29.firebaseapp.com", databaseURL: "https://radiobingo-9ac29-default-rtdb.asia-southeast1.firebasedatabase.app", projectId: "radiobingo-9ac29", storageBucket: "radiobingo-9ac29.firebasestorage.app", messagingSenderId: "965903993397", appId: "1:965903993397:web:f6646fa05225f147eebf7c" };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    let currentPattern = "Normal Bingo";
    let drawnNumbers = [];
    let autoDrawInterval = null;
    let isAutoDrawing = false;
    let jackpotVisible = false;
    let schedules = {};
    let globalStatusData = {}; 
    let allUsersData = {}; // FIXED: Store ALL user data to map names correctly

    // --- HELPER FOR NAME CLEANING (NO CHINESE CHARS) ---
    function cleanName(name) {
        if(!name) return "Unknown";
        // Remove Chinese/CJK characters and symbols, keep Latin, numbers, spaces
        let cleaned = name.replace(/[\u4E00-\u9FFF\u3400-\u4DBF\u2000-\u206F]/g, '').trim();
        return cleaned || name; // Fallback to original name if regex wipes everything
    }

    function openTab(tabId, btn) {
        document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.getElementById(tabId).classList.add('active');
        btn.classList.add('active');
    }

    // Initialize Ball Grid
    for(let i=1; i<=75; i++) {
        let b = document.createElement('div'); b.className = 'ball'; b.id = 'ball-'+i; b.innerText = i; b.onclick = () => toggleBall(i);
        document.getElementById('ballGrid').appendChild(b);
    }

    // Schedules
    db.ref('gameState/schedules').on('value', s => { schedules = s.val() || {}; renderSchedules(); });
    function addSchedule() { const input = document.getElementById('schedInput'); if(!input.value) return; const time = new Date(input.value).getTime(); db.ref('gameState/schedules').push(time); input.value = ""; }
    function removeSchedule(key) { db.ref('gameState/schedules/' + key).remove(); }
    function renderSchedules() {
        const list = document.getElementById('scheduleList'); list.innerHTML = "";
        const sorted = Object.entries(schedules).sort(([,a], [,b]) => a - b);
        sorted.forEach(([key, val]) => { const date = new Date(val); const str = date.toLocaleDateString('en-PH', { month:'short', day:'numeric'}) + ' ' + date.toLocaleTimeString('en-PH', {hour:'2-digit', minute:'2-digit'}); 
        list.innerHTML += `<div style="display:flex; justify-content:space-between; background:rgba(255,255,255,0.05); padding:8px; border-radius:8px; margin-bottom:5px; font-size:11px;"><span>${str}</span><button style="background:var(--danger); border:none; color:white; border-radius:4px; cursor:pointer;" onclick="removeSchedule('${key}')">X</button></div>`; });
    }

    // FIXED: Scheduler Checker - Tuloy tuloy na draw
    setInterval(() => {
        const now = Date.now();
        Object.entries(schedules).forEach(([key, time]) => { 
            if(now >= time && now < time + 60000) { 
                console.log("Scheduled Game Started!"); 
                // Check if already running or winner exists before starting
                db.ref('gameState/latestWinner').once('value', w => {
                    if(!w.exists() && !isAutoDrawing) {
                        startAutoDrawLogic(); 
                    }
                });
                removeSchedule(key); 
            } 
        });
    }, 5000);

    // FIXED: Drawn Numbers Listener - Removed 'Last Ball' logic here to prevent stuck numbers
    db.ref('drawnNumbers').on('value', s => {
        drawnNumbers = s.val() ? Object.values(s.val()) : [];
        document.querySelectorAll('.ball').forEach(b => b.classList.remove('drawn'));
        drawnNumbers.forEach(n => document.getElementById('ball-'+n).classList.add('drawn'));
        updateMonitorCards();
    });

    // FIXED: Dedicated Listener for Current Ball (To avoid "stuck" UI)
    db.ref('gameState/lastCalled').on('value', s => {
        if(s.exists()) {
            const num = s.val();
            document.getElementById('lastBall').innerText = num;
            speakNumber(num);
        } else {
            document.getElementById('lastBall').innerText = "--";
        }
    });

    db.ref('gameState/currentPattern').on('value', s => { currentPattern = s.val() || "Normal Bingo"; document.getElementById('patternSelect').value = currentPattern; updateMonitorCards(); });

    // Jackpot
    function toggleJackpot() {
        jackpotVisible = !jackpotVisible; const amount = document.getElementById('jackpotAmount').value;
        const knob = document.getElementById('jackpotKnob'); const bg = document.getElementById('jackpotKnobBg');
        if(jackpotVisible) { knob.style.left = "23px"; bg.style.background = "var(--success)"; document.getElementById('jackpotStatusText').innerText = "VISIBLE"; db.ref('gameState/jackpot').set({ amount: amount, active: true }); } 
        else { knob.style.left = "3px"; bg.style.background = "rgba(0,0,0,0.3)"; document.getElementById('jackpotStatusText').innerText = "HIDDEN"; db.ref('gameState/jackpot').set({ amount: amount, active: false }); }
    }
    db.ref('gameState/jackpot').once('value', s => { if(s.exists()){ const d = s.val(); document.getElementById('jackpotAmount').value = d.amount || ""; if(d.active) { jackpotVisible = true; document.getElementById('jackpotKnob').style.left = "23px"; document.getElementById('jackpotKnobBg').style.background = "var(--success)"; document.getElementById('jackpotStatusText').innerText = "VISIBLE"; } } });
    document.getElementById('jackpotAmount').addEventListener('input', (e) => { if(jackpotVisible) { db.ref('gameState/jackpot').update({ amount: e.target.value }); } });

    // Auto Draw Logic
    function toggleAutoDraw() {
        if(!isAutoDrawing) { db.ref('gameState/latestWinner').once('value', s => { if(s.exists()) { alert("May Winner Na! Reset Game muna bago mag start ulit."); return; } startAutoDrawLogic(); }); } 
        else { stopAutoDrawLogic(); }
    }
    
    function startAutoDrawLogic() { 
        if(isAutoDrawing) return; // Prevent double intervals
        const btn = document.getElementById('btnAutoDraw'); 
        const speed = document.getElementById('drawSpeed').value * 1000; 
        isAutoDrawing = true; 
        btn.innerHTML = `<i data-lucide="pause"></i> STOP AUTO DRAW`; 
        btn.style.background = "linear-gradient(135deg, #ef4444, #b91c1c)"; 
        autoDrawLogic(); 
        autoDrawInterval = setInterval(autoDrawLogic, speed); 
        lucide.createIcons(); 
    }

    function stopAutoDrawLogic() { 
        const btn = document.getElementById('btnAutoDraw'); 
        clearInterval(autoDrawInterval); 
        isAutoDrawing = false; 
        btn.innerHTML = `<i data-lucide="play"></i> START AUTO DRAW`; 
        btn.style.background = "linear-gradient(135deg, #059669, #047857)"; 
        lucide.createIcons(); 
    }

    function autoDrawLogic() {
        if(drawnNumbers.length >= 75) { stopAutoDrawLogic(); return alert("Game Over! All numbers drawn."); }
        // FIXED: Strict check for winner every tick
        db.ref('gameState/latestWinner').once('value', s => { 
            if(s.exists()) { 
                stopAutoDrawLogic(); 
                return; 
            } 
            let nextNum; 
            do { nextNum = Math.floor(Math.random() * 75) + 1; } while (drawnNumbers.includes(nextNum)); 
            toggleBall(nextNum); 
        });
    }

    function speakNumber(num) { if ('speechSynthesis' in window) { let letter = "B"; if (num > 15) letter = "I"; if (num > 30) letter = "N"; if (num > 45) letter = "G"; if (num > 60) letter = "O"; const msg = new SpeechSynthesisUtterance(`${letter} ${num}`); msg.rate = 0.9; window.speechSynthesis.speak(msg); } }
    
    function toggleBall(num) { 
        const ref = db.ref('drawnNumbers/' + num); 
        ref.once('value', s => { 
            if(s.exists()) {
                ref.remove(); 
            } else { 
                ref.set(num); 
                // FIXED: Explicitly set lastCalled for UI accuracy
                db.ref('gameState/lastCalled').set(num);
                db.ref('gameState/gameStartTime').once('value', ss => { if(!ss.exists()) db.ref('gameState/gameStartTime').set(Date.now()); }); 
            } 
        }); 
    }

    // --- RE-ENGINEERED CARD MONITORING & STATUS ---
    db.ref('status').on('value', s => {
        globalStatusData = s.val() || {};
        document.getElementById('countOnline').innerText = Object.keys(globalStatusData).length;
        renderActiveUserList();
        updateMonitorCards(); 
    });

    // FIXED: Render Active Users List using 'users' data for names
    function renderActiveUserList() {
        const list = document.getElementById('activeUsersList'); list.innerHTML = "";
        Object.entries(globalStatusData).forEach(([uid, data]) => {
            // Check 'allUsersData' first, then 'status' data, then 'Unknown'
            let name = "Unknown";
            if(allUsersData[uid] && allUsersData[uid].name) name = allUsersData[uid].name;
            else if(data.name) name = data.name;

            const safeName = cleanName(name);
            list.innerHTML += `<div style="padding:6px 0; border-bottom:1px solid rgba(255,255,255,0.05); display:flex; align-items:center; gap:8px;">
                <span class="online-dot"></span> ${safeName}
            </div>`;
        });
    }

    db.ref('users').on('value', s => {
        allUsersData = s.val() || {}; // Capture all users
        const list = document.getElementById('pointsUserList');
        const currentSelected = document.getElementById('selectedUserForPoints').value;
        list.innerHTML = "";
        document.getElementById('countUsers').innerText = s.numChildren();
        
        s.forEach(child => {
            const u = child.val();
            const uid = child.key;
            const safeName = cleanName(u.name);
            const isSel = currentSelected === uid ? 'selected' : '';
            const div = document.createElement('div');
            div.className = `user-option ${isSel}`;
            div.onclick = () => selectUserForMgmt(uid, div);
            div.innerHTML = `<span>${safeName}</span> <span>${u.points || 0} pts</span>`;
            list.appendChild(div);
        });
        renderActiveUserList(); // Refresh active list names if user data updates
        updateMonitorCards();
    });

    function selectUserForMgmt(uid, el) {
        document.querySelectorAll('.user-option').forEach(e => e.classList.remove('selected'));
        el.classList.add('selected');
        document.getElementById('selectedUserForPoints').value = uid;
    }

    function updateMonitorCards() {
        const container = document.getElementById('liveCardsContainer');
        container.innerHTML = "";
        let usersArray = [];

        // Build array from allUsersData
        Object.entries(allUsersData).forEach(([key, user]) => {
            if(user.card || user.currentCard) {
                usersArray.push({ ...user, uid: key });
            }
        });

        // SORT: Online first
        usersArray.sort((a, b) => {
            const aOnline = globalStatusData[a.uid] ? 1 : 0;
            const bOnline = globalStatusData[b.uid] ? 1 : 0;
            return bOnline - aOnline; 
        });

        usersArray.forEach(user => {
            const card = user.currentCard || user.card;
            const check = checkCardStatus(card, currentPattern, drawnNumbers);
            const isOnline = globalStatusData[user.uid] ? true : false;
            const safeName = cleanName(user.name);

            // LOGIC UPDATE: Force NO BINGO/PURO if offline
            let isBingo = check.isBingo;
            let isPuro = check.isPuro;
            
            if(!isOnline) {
                isBingo = false;
                isPuro = false;
            } else {
                // Only consider DB winner flag if online
                if(user.hasWonCurrent && drawnNumbers.length > 0) isBingo = true;
                // Puro can't exist if Bingo is true
                if(isBingo) isPuro = false;
            }

            const cardDiv = document.createElement('div');
            cardDiv.className = `user-card-monitor ${!isOnline ? 'offline' : ''} ${isBingo ? 'bingo' : ''} ${isPuro ? 'puro' : ''}`;
            
            let gridHtml = '<div class="mini-bingo-grid">';
            card.forEach((n, idx) => {
                const marked = drawnNumbers.includes(n) || n === "FREE";
                const isWinningCell = check.winningCells.includes(idx); 
                // Visual fix: only show hit/gold cells if user is online and actually won/puro
                const visualHit = isOnline && isWinningCell;
                
                gridHtml += `<div class="mini-cell ${marked ? 'marked' : ''} ${visualHit ? 'hit' : ''}">${n === "FREE" ? 'â˜…' : n}</div>`;
            });
            gridHtml += '</div>';

            cardDiv.innerHTML = `
                <div class="monitor-badge">${isBingo ? "BINGO!" : "PURO!"}</div>
                <div style="font-size:12px; font-weight:800; display:flex; justify-content:space-between; color:white; align-items:center;">
                    <span style="display:flex; align-items:center; gap:5px;">
                        <span class="${isOnline ? 'online-dot' : 'offline-dot'}"></span>
                        ${safeName}
                    </span>
                    <span style="font-size:9px; background:rgba(255,255,255,0.1); padding:2px 6px; border-radius:4px;">${user.points || 0} pts</span>
                </div>
                ${gridHtml}
            `;
            
            // Append logic
            if(isBingo && isOnline) container.prepend(cardDiv); 
            else if(isPuro && isOnline) container.insertBefore(cardDiv, container.children[1] || null); 
            else container.appendChild(cardDiv);
        });
    }

    function checkCardStatus(card, pattern, drawn) {
        let markedIndices = [12]; card.forEach((val, idx) => { if(drawn.includes(val) && idx !== 12) markedIndices.push(idx); });
        let patterns = [];
        if (pattern === "Blackout") { patterns = [[...Array(25).keys()]]; }
        else if (pattern === "Letter X") { patterns = [[0,4,6,8,12,16,18,20,24]]; }
        else if (pattern === "Four Corners") { patterns = [[0,4,20,24]]; }
        else { patterns = [[0,1,2,3,4],[5,6,7,8,9],[10,11,12,13,14],[15,16,17,18,19],[20,21,22,23,24],[0,5,10,15,20],[1,6,11,16,21],[2,7,12,17,22],[3,8,13,18,23],[4,9,14,19,24],[0,6,12,18,24],[4,8,12,16,20]]; }
        let isBingo = false; let isPuro = false; let winningCells = [];
        for (let p of patterns) { const hits = p.filter(idx => markedIndices.includes(idx)); const needed = p.length; const got = hits.length; if (got === needed) { isBingo = true; winningCells = p; break; } else if (needed - got === 1) { isPuro = true; } }
        return { isBingo, isPuro, winningCells };
    }

    db.ref('gameState/latestWinner').on('value', s => {
        const marquee = document.getElementById('winnerAnnounce');
        if(s.exists()) {
            const winData = s.val(); 
            const safeWinnerName = cleanName(winData.name);
            let msg = `ðŸŽ‰ BINGO WINNER: ${safeWinnerName.toUpperCase()}!`;
            if(winData.prize) msg += ` WON â‚±${winData.prize.toLocaleString()} POINTS! ðŸ’°`; else msg += ` CONGRATULATIONS! ðŸŽ‰`;
            marquee.style.display = 'block'; document.getElementById('winnerMarqueeText').innerText = msg;
            
            // FIXED: Strict Auto Stop
            if(isAutoDrawing) { stopAutoDrawLogic(); alert("AUTO STOP: We have a winner!"); }
        } else { marquee.style.display = 'none'; updateMonitorCards(); } 
    });

    // Points & Notif
    function modifyUserPoints() {
        const uid = document.getElementById('selectedUserForPoints').value;
        const amount = document.getElementById('pointsAmount').value;
        if(!uid) return alert("Select a user first!");
        if(!amount) return alert("Enter amount");
        db.ref(`users/${uid}/points`).transaction(current => (current || 0) + parseInt(amount));
        alert("Points updated!");
        document.getElementById('pointsAmount').value = "";
    }

    function sendAdminNotification() {
        const type = document.getElementById('notifRecipient').value;
        const msg = document.getElementById('notifMessage').value;
        if(!msg) return alert("Enter message");
        if(type === 'selected') {
            const uid = document.getElementById('selectedUserForPoints').value;
            if(!uid) return alert("Select a user first!");
            db.ref(`notifications/${uid}`).push({ msg: msg, time: Date.now(), read: false });
            alert("Sent to user!");
        } else {
            if(confirm("Send to ALL users?")) {
                db.ref('users').once('value', s => { s.forEach(u => { db.ref(`notifications/${u.key}`).push({ msg: msg, time: Date.now(), read: false }); }); });
                alert("Sent to all!");
            }
        }
        document.getElementById('notifMessage').value = "";
    }

    // Bring Me
    db.ref('gameState/bringMeSubmissions').on('value', s => {
        const gallery = document.getElementById('bringmeGallery'); gallery.innerHTML = "";
        s.forEach(child => { const data = child.val(); const safeName = cleanName(data.userName); 
        gallery.innerHTML += `<div style="background:rgba(255,255,255,0.05); border-radius:12px; overflow:hidden; border:1px solid rgba(255,255,255,0.1);"><img src="${data.photoUrl}" style="width:100%; height:140px; object-fit:cover;" onclick="window.open(this.src)"><div style="padding:10px; font-size:11px;"><b>${safeName}</b><br><span style="color:var(--gold)">Score: ${data.aiScore || 0}%</span></div></div>`; });
    });
    function startBringMe() { const item = document.getElementById('bringmeItemIn').value.trim(); if(!item) return alert("Maglagay ng item!"); db.ref('gameState/bringMe').set({ active: true, item: item, winner: null, startTime: Date.now() }); db.ref('gameState/bringMeSubmissions').remove(); }
    function stopBringMe() { db.ref('gameState/bringMe').update({ active: false }); }
    db.ref('gameState/bringMe').on('value', s => { const data = s.val(); const badge = document.getElementById('bringmeStatusBadge'); if(data && data.active) { badge.innerText = "LIVE NOW"; badge.className = "status-badge status-active"; } else { badge.innerText = "OFFLINE"; badge.className = "status-badge status-off"; } });

    function setPattern(p) { db.ref('gameState/currentPattern').set(p); }
    
    function resetGame() {
        if(confirm("WARNING: Reset entire board?")){
            db.ref('drawnNumbers').remove(); db.ref('gameState/latestWinner').remove(); db.ref('gameState/gameStartTime').remove(); db.ref('gameState/lastCalled').remove();
            db.ref('users').once('value', s => { let updates = {}; s.forEach(u => { updates[u.key + '/hasWonCurrent'] = false; }); db.ref('users').update(updates); });
            stopAutoDrawLogic(); setTimeout(updateMonitorCards, 500);
        }
    }

    db.ref('redemptions').on('value', s => {
        const list = document.getElementById('cashoutList'); list.innerHTML = "";
        s.forEach(child => {
            const r = child.val(); const key = child.key; if(r.status !== 'pending') return;
            const safeName = cleanName(r.name);
            const div = document.createElement('div'); div.className = 'card'; div.style.padding = "15px"; div.style.marginBottom = "10px";
            div.innerHTML = `<div style="display:flex; justify-content:space-between; align-items:center;"><div><div style="font-weight:800;">${safeName} - <span style="color:var(--gold)">${r.item}</span></div><div style="font-size:11px; opacity:0.6;">GCash: ${r.gcash}</div></div><div style="display:flex; gap:10px;"><button class="btn btn-primary" style="width:auto; padding:8px 20px" onclick="updateStatus('${key}', 'sent', ${JSON.stringify(r).replace(/"/g, '&quot;')})">PAID</button><button class="btn btn-danger" style="width:auto; padding:8px 20px" onclick="updateStatus('${key}', 'denied', ${JSON.stringify(r).replace(/"/g, '&quot;')})">X</button></div></div>`;
            list.prepend(div);
        });
    });
    function updateStatus(key, status, data) {
        if(confirm(`${status} this?`)) {
            db.ref('redemptions/' + key).update({ status: status });
            const statusMsg = status === 'sent' ? `Ang iyong ${data.item} ay na-ipadala na! îžé ‚` : `Ang iyong ${data.item} ay na-deny. ç¬¶å½¢`;
            db.ref('notifications/' + data.uid).push({ msg: statusMsg, time: Date.now() });
            if(status === 'denied') db.ref('users/' + data.uid + '/points').transaction(p => (p || 0) + data.cost);
        }
    }
</script>
</body>
</html>
