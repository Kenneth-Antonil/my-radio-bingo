<!DOCTYPE html>
<html lang="tl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Radio Bingo | Admin Master</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <style>
        :root { 
            --bg: #030712; --surface: #111827; --surface-br: #1f2937; 
            --accent: #3b82f6; --text: #f8fafc; --success: #10b981; 
            --danger: #ef4444; --gold: #fbbf24; --puro: #f97316;
            --bringme: #8b5cf6; --glass: rgba(255, 255, 255, 0.03);
        }
        * { box-sizing: border-box; }
        body { font-family: 'Inter', sans-serif; background: var(--bg); color: var(--text); margin: 0; display: flex; min-height: 100vh; }
        
        .sidebar { width: 280px; background: var(--surface); border-right: 1px solid var(--surface-br); padding: 2rem; position: fixed; height: 100vh; z-index: 100; }
        .main { margin-left: 280px; flex: 1; padding: 2rem; }
        
        .nav-item { padding: 1rem; border-radius: 12px; cursor: pointer; display: flex; align-items: center; gap: 1rem; font-weight: 600; color: #94a3b8; transition: 0.2s; margin-bottom: 0.5rem; }
        .nav-item.active { background: var(--accent); color: white; }
        
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 2rem; }
        .stat-card { background: var(--surface); padding: 1.5rem; border-radius: 20px; border: 1px solid var(--surface-br); }
        .stat-val { font-size: 2rem; font-weight: 900; }

        .grid-layout { display: grid; grid-template-columns: 1.2fr 1fr; gap: 1.5rem; }
        .card { background: var(--surface); border-radius: 24px; border: 1px solid var(--surface-br); padding: 1.5rem; margin-bottom: 1.5rem; }

        /* BINGO GRID */
        .ball-grid { display: grid; grid-template-columns: repeat(15, 1fr); gap: 5px; background: #000; padding: 10px; border-radius: 12px; }
        .ball { aspect-ratio: 1; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 0.7rem; font-weight: 800; background: #222; color: #555; cursor: pointer; }
        .ball.active { background: var(--accent); color: white; box-shadow: 0 0 10px var(--accent); }

        /* MONITORING CARDS */
        #playerMonitor { display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 10px; margin-top: 1rem; }
        .player-card { background: #1f2937; padding: 10px; border-radius: 12px; border: 2px solid transparent; transition: 0.3s; position: relative; }
        .player-card.online { border-color: #3b82f633; }
        .player-card.is-puro { border-color: var(--puro); animation: pulse-puro 1.5s infinite; }
        .player-card.is-winner { border-color: var(--success); background: #064e3b; }
        
        .p-status { position: absolute; top: 8px; right: 8px; width: 8px; height: 8px; border-radius: 50%; background: #444; }
        .p-status.online { background: var(--success); box-shadow: 0 0 5px var(--success); }
        
        .p-name { font-weight: 800; font-size: 0.8rem; margin-bottom: 5px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; width: 80%; }
        .mini-bingo { display: grid; grid-template-columns: repeat(5, 1fr); gap: 2px; }
        .m-cell { aspect-ratio: 1; background: #111; border-radius: 2px; display: flex; align-items: center; justify-content: center; font-size: 0.5rem; color: #444; }
        .m-cell.hit { background: var(--accent); color: white; }
        .m-cell.free { background: var(--gold); color: black; }

        @keyframes pulse-puro { 0% { box-shadow: 0 0 0px var(--puro); } 50% { box-shadow: 0 0 10px var(--puro); } 100% { box-shadow: 0 0 0px var(--puro); } }

        .btn { padding: 10px 20px; border-radius: 10px; border: none; font-weight: 700; cursor: pointer; color: white; background: var(--accent); display: flex; align-items: center; gap: 8px; }
        .btn-danger { background: var(--danger); }
        .btn-success { background: var(--success); }
        
        .tab-content { display: none; }
        .tab-content.active { display: block; }
    </style>
</head>
<body>

<div class="sidebar">
    <div class="logo"><i data-lucide="radio"></i> RADIO BINGO</div>
    <div class="nav-item active" onclick="switchTab('dashboard')"><i data-lucide="monitor"></i> Live Monitor</div>
    <div class="nav-item" onclick="switchTab('users')"><i data-lucide="users"></i> Players</div>
    <div class="nav-item" onclick="switchTab('redemptions')"><i data-lucide="gift"></i> Redemptions</div>
    <div class="nav-item" onclick="switchTab('settings')"><i data-lucide="settings"></i> System</div>
</div>

<div class="main">
    <div id="dashboard" class="tab-content active">
        <div class="stats-grid">
            <div class="stat-card"><div>Online Now</div><div class="stat-val" id="onlineCount" style="color:var(--success)">0</div></div>
            <div class="stat-card"><div>Total Players</div><div class="stat-val" id="totalUsers">0</div></div>
            <div class="stat-card"><div>Current Game</div><div class="stat-val" id="activeGame" style="color:var(--puro)">Bingo</div></div>
        </div>

        <div class="grid-layout">
            <div class="card">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:1rem">
                    <h3><i data-lucide="layout"></i> Real-time Cards Monitor</h3>
                    <small style="color:#666">Online > Puro > Winner Priority</small>
                </div>
                <div id="playerMonitor"></div>
            </div>

            <div class="card">
                <h3><i data-lucide="play-circle"></i> Bingo Controller</h3>
                <div style="display:flex; gap:10px; margin-bottom:1rem">
                    <button id="drawBtn" class="btn" onclick="startAutoDraw()">Auto Draw</button>
                    <button id="stopBtn" class="btn btn-danger" onclick="stopAutoDraw()" style="display:none">Stop</button>
                    <button class="btn btn-danger" onclick="resetBingo()">Reset</button>
                </div>
                <div class="ball-grid" id="bingoGrid"></div>
                
                <hr style="border:0; border-top:1px solid #222; margin:1.5rem 0">
                
                <h3><i data-lucide="camera"></i> Bring Me</h3>
                <input type="text" id="bringMeItem" placeholder="Enter item name...">
                <div style="display:flex; gap:10px; margin-top:10px">
                    <button class="btn" style="background:var(--bringme)" onclick="setBringMe()">Start Bring Me</button>
                    <button class="btn btn-danger" onclick="clearBringMe()">Clear</button>
                </div>
                <div id="submissionList" style="margin-top:1rem"></div>
            </div>
        </div>
    </div>

    <div id="users" class="tab-content"><div class="card"><h3>User List</h3><div id="userTable"></div></div></div>
    <div id="redemptions" class="tab-content"><div class="card"><h3>Pending Redemptions</h3><div id="redemptionList"></div></div></div>
    <div id="settings" class="tab-content"><div class="card"><h3>Settings</h3><input id="nextDrawIn" placeholder="Next Draw Time..."><button onclick="setNextDraw()">Update</button></div></div>
</div>

<script>
    const firebaseConfig = { databaseURL: "https://radiobingo-68749-default-rtdb.firebaseio.com/" };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    let drawnBalls = [];
    let drawInterval = null;

    // --- TAB SYSTEM ---
    function switchTab(id) {
        document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        event.currentTarget.classList.add('active');
    }

    // --- BINGO CORE ---
    for(let i=1; i<=75; i++) {
        const b = document.createElement('div');
        b.className = 'ball'; b.id = `ball-${i}`; b.innerText = i;
        b.onclick = () => toggleBall(i);
        document.getElementById('bingoGrid').appendChild(b);
    }

    db.ref('bingoBalls').on('value', s => {
        const balls = s.val() || {};
        drawnBalls = Object.keys(balls).filter(k => balls[k]).map(Number);
        document.querySelectorAll('.ball').forEach(el => {
            el.classList.toggle('active', balls[el.innerText]);
        });
    });

    function toggleBall(n) {
        const active = !document.getElementById(`ball-${n}`).classList.contains('active');
        db.ref('bingoBalls/'+n).set(active);
    }

    function resetBingo() { if(confirm('Reset?')) { stopAutoDraw(); db.ref('bingoBalls').remove(); } }

    function startAutoDraw() {
        document.getElementById('drawBtn').style.display = 'none';
        document.getElementById('stopBtn').style.display = 'flex';
        drawInterval = setInterval(() => {
            if(drawnBalls.length >= 75) return stopAutoDraw();
            let n; do { n = Math.floor(Math.random()*75)+1; } while(drawnBalls.includes(n));
            db.ref('bingoBalls/'+n).set(true);
        }, 5000);
    }
    function stopAutoDraw() { clearInterval(drawInterval); document.getElementById('drawBtn').style.display = 'flex'; document.getElementById('stopBtn').style.display = 'none'; }

    // --- [REALTIME MONITORING LOGIC] ---
    db.ref('users').on('value', s => {
        const monitor = document.getElementById('playerMonitor');
        const players = [];
        let onlineTotal = 0;
        let grandTotal = 0;

        s.forEach(child => {
            const p = child.val();
            p.id = child.key;
            grandTotal++;
            if(p.isOnline) onlineTotal++;

            // Calculate Hits & Status
            const card = p.bingoCard || [];
            let hits = 0;
            card.forEach(n => { if(drawnBalls.includes(n) || n === 0) hits++; });
            
            p.hits = hits;
            p.isWinner = (hits === 25);
            p.isPuro = (hits === 24);
            
            // Priority Value for Sorting
            p.priority = 0;
            if(p.isOnline) p.priority += 100;
            if(p.isPuro) p.priority += 500;
            if(p.isWinner) p.priority += 1000;

            players.push(p);
        });

        document.getElementById('totalUsers').innerText = grandTotal;
        document.getElementById('onlineCount').innerText = onlineTotal;

        // Sort: Winner First > Puro Next > Online Next
        players.sort((a,b) => b.priority - a.priority);

        monitor.innerHTML = "";
        players.forEach(p => {
            const div = document.createElement('div');
            div.className = `player-card ${p.isOnline ? 'online' : ''} ${p.isPuro ? 'is-puro' : ''} ${p.isWinner ? 'is-winner' : ''}`;
            
            let gridHtml = "";
            (p.bingoCard || []).forEach(num => {
                const isHit = drawnBalls.includes(num) || num === 0;
                gridHtml += `<div class="m-cell ${num === 0 ? 'free' : ''} ${isHit ? 'hit' : ''}">${num === 0 ? 'â˜…' : num}</div>`;
            });

            div.innerHTML = `
                <div class="p-status ${p.isOnline ? 'online' : ''}"></div>
                <div class="p-name">${p.name || 'Anonymous'}</div>
                <div class="mini-bingo">${gridHtml}</div>
                <div style="font-size:0.6rem; margin-top:5px; opacity:0.7">Hits: ${p.hits}/25</div>
            `;
            monitor.appendChild(div);
        });
    });

    // --- OTHER SYNC FUNCTIONS (WALANG BAWAS) ---
    function setBringMe() {
        const item = document.getElementById('bringMeItem').value;
        db.ref('bringMe').set({ item, active: true, timestamp: Date.now() });
    }
    function clearBringMe() { db.ref('bringMe').update({ active: false }); db.ref('bringMeSubmissions').remove(); }
    
    db.ref('bringMeSubmissions').on('value', s => {
        const list = document.getElementById('submissionList'); list.innerHTML = "";
        s.forEach(c => {
            const d = c.val();
            list.innerHTML += `<div class="card" style="padding:10px"><b>${d.userName}</b><br><img src="${d.img}" style="width:100px"></div>`;
        });
    });

    lucide.createIcons();
</script>
</body>
</html>
