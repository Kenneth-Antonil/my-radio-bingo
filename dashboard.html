<!DOCTYPE html>
<html lang="tl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Radio Bingo | Admin Master Pro</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <style>
        :root { 
            --bg: #030712; 
            --surface: #111827; 
            --surface-br: #1f2937; 
            --accent: #3b82f6; 
            --text: #f8fafc; 
            --success: #10b981; 
            --danger: #ef4444; 
            --gold: #fbbf24; 
            --puro: #f59e0b;
            --bringme: #8b5cf6;
            --glass: rgba(255, 255, 255, 0.03);
        }
        * { box-sizing: border-box; }
        body { 
            font-family: 'Inter', sans-serif; 
            background: var(--bg); 
            color: var(--text); 
            margin: 0; 
            padding: 20px; 
            display: grid; 
            grid-template-columns: 300px 1fr; 
            gap: 20px; 
            height: 100vh;
            overflow: hidden;
        }

        /* TABS SYSTEM */
        .tabs-nav { display: flex; gap: 10px; margin-bottom: 20px; background: var(--surface); padding: 10px; border-radius: 16px; border: 1px solid var(--glass); }
        .tab-btn { flex: 1; padding: 12px; border-radius: 12px; border: none; background: transparent; color: #64748b; font-weight: 800; cursor: pointer; transition: 0.3s; display: flex; align-items: center; justify-content: center; gap: 8px; }
        .tab-btn.active { background: var(--accent); color: white; }
        .tab-content { display: none; height: calc(100vh - 120px); overflow-y: auto; padding-right: 10px; }
        .tab-content.active { display: block; }

        /* WINNER MARQUEE */
        .winner-marquee { background: var(--gold); color: black; padding: 8px; font-weight: 900; text-transform: uppercase; white-space: nowrap; overflow: hidden; position: relative; border-radius: 8px; margin-bottom: 15px; display: none; }
        .marquee-text { display: inline-block; animation: marquee 15s linear infinite; }
        @keyframes marquee { 0% { transform: translateX(100%); } 100% { transform: translateX(-100%); } }

        /* SIDEBAR & STATS */
        .sidebar { background: var(--surface); border-radius: 24px; padding: 20px; border: 1px solid var(--glass); overflow-y: auto; display: flex; flex-direction: column; gap: 15px; }
        .stat-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .stat-card { background: var(--glass); padding: 15px; border-radius: 18px; text-align: center; }
        .stat-val { font-size: 20px; font-weight: 900; color: var(--gold); }
        .stat-lbl { font-size: 10px; opacity: 0.5; font-weight: 700; }

        /* BINGO CARDS MONITORING */
        .cards-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 15px; }
        .user-card-monitor { background: var(--surface-br); padding: 12px; border-radius: 16px; border: 2px solid transparent; transition: 0.3s; position: relative; }
        
        .user-card-monitor.puro { border-color: var(--puro); box-shadow: 0 0 15px rgba(245, 158, 11, 0.4); animation: pulse-puro 1s infinite; }
        .user-card-monitor.bingo { border-color: var(--success); background: #064e3b; box-shadow: 0 0 20px rgba(16, 185, 129, 0.5); transform: scale(1.05); z-index: 10; }
        
        .monitor-badge { position: absolute; top: -10px; right: -5px; padding: 3px 8px; border-radius: 10px; font-size: 10px; font-weight: 900; color: black; display: none; }
        .puro .monitor-badge { display: block; background: var(--puro); content: "PURO!"; }
        .bingo .monitor-badge { display: block; background: var(--success); color: white; content: "BINGO!"; }

        @keyframes pulse-puro { 0% { opacity: 1; } 50% { opacity: 0.7; } 100% { opacity: 1; } }
        
        .mini-bingo-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 2px; margin-top: 8px; }
        .mini-cell { aspect-ratio: 1; background: rgba(0,0,0,0.3); font-size: 8px; display: flex; align-items: center; justify-content: center; border-radius: 2px; color: rgba(255,255,255,0.3); }
        .mini-cell.marked { background: var(--accent); color: white; }
        .mini-cell.hit { background: var(--gold); color: black; } 

        .online-dot { width: 8px; height: 8px; background: var(--success); border-radius: 50%; box-shadow: 0 0 5px var(--success); display: inline-block; }
        .offline-dot { width: 8px; height: 8px; background: #64748b; border-radius: 50%; display: inline-block; }

        /* BRING ME GALLERY */
        .bringme-gallery { display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 15px; margin-top: 20px; }
        .photo-card { background: var(--surface-br); border-radius: 16px; overflow: hidden; border: 1px solid var(--glass); }
        .photo-card img { width: 100%; height: 150px; object-fit: cover; }
        .photo-info { padding: 10px; font-size: 11px; }

        /* COMMON COMPONENTS */
        .card { background: var(--surface); border-radius: 24px; padding: 24px; border: 1px solid var(--glass); margin-bottom: 20px; }
        .ball-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(40px, 1fr)); gap: 6px; margin-top: 15px; }
        .ball { aspect-ratio: 1; background: var(--surface-br); border-radius: 8px; display: flex; align-items: center; justify-content: center; font-weight: 800; cursor: pointer; font-size: 12px; border: 1px solid var(--glass); transition: 0.2s; }
        .ball:hover { background: var(--accent); }
        .ball.drawn { background: var(--accent); color: white; box-shadow: 0 0 10px rgba(59,130,246,0.4); border-color: white; }
        
        .btn { width: 100%; padding: 12px; border-radius: 12px; border: none; font-weight: 800; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; margin-top: 10px; transition: 0.2s; }
        .btn:active { transform: scale(0.95); }
        .btn-primary { background: var(--accent); color: white; }
        .btn-danger { background: var(--danger); color: white; }
        .btn-bringme { background: var(--bringme); color: white; }
        .btn-gold { background: var(--gold); color: black; }
        
        .input-group { margin-bottom: 15px; }
        label { display: block; font-size: 10px; font-weight: 800; color: #64748b; margin-bottom: 5px; text-transform: uppercase; }
        input, select, textarea { width: 100%; background: var(--surface-br); border: 1px solid var(--glass); padding: 10px; border-radius: 10px; color: white; outline: none; font-family: inherit; }
        input:focus, select:focus, textarea:focus { border-color: var(--accent); }
        
        .status-badge { padding: 4px 10px; border-radius: 20px; font-size: 10px; font-weight: 800; }
        .status-active { background: var(--success); color: white; }
        .status-off { background: var(--danger); color: white; }

        .auto-draw-panel { background: rgba(16, 185, 129, 0.1); border: 1px solid var(--success); padding: 15px; border-radius: 16px; margin-bottom: 15px; }
        .toggle-switch { display: flex; align-items: center; gap: 10px; font-size: 12px; font-weight: 700; cursor: pointer; }
        .toggle-knob { width: 40px; height: 20px; background: var(--surface-br); border-radius: 20px; position: relative; transition: 0.3s; }
        .toggle-knob::after { content: ''; position: absolute; left: 2px; top: 2px; width: 16px; height: 16px; background: white; border-radius: 50%; transition: 0.3s; }
        .active .toggle-knob { background: var(--success); }
        .active .toggle-knob::after { left: 22px; }

        /* SCHEDULER STYLES */
        .sched-list { margin-top: 10px; max-height: 150px; overflow-y: auto; font-size: 11px; }
        .sched-item { display: flex; justify-content: space-between; align-items: center; background: rgba(255,255,255,0.05); padding: 8px; border-radius: 8px; margin-bottom: 5px; }
        .btn-xs { padding: 4px 8px; font-size: 10px; border-radius: 6px; cursor: pointer; border: none; }

        /* USER SELECTION LIST FOR MANAGEMENT */
        .user-select-list { max-height: 200px; overflow-y: auto; background: var(--surface-br); border-radius: 10px; padding: 5px; }
        .user-option { padding: 8px; border-radius: 6px; cursor: pointer; font-size: 12px; display: flex; justify-content: space-between; }
        .user-option:hover { background: rgba(255,255,255,0.05); }
        .user-option.selected { background: var(--accent); color: white; }

        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-thumb { background: var(--surface-br); border-radius: 10px; }
    </style>
</head>
<body>

<div class="sidebar">
    <div style="font-size: 22px; font-weight: 900; letter-spacing: -1px;">ADMIN<span style="color:var(--accent)">PANEL</span></div>
    
    <div class="stat-grid">
        <div class="stat-card"><div class="stat-val" id="countOnline">0</div><div class="stat-lbl">ONLINE</div></div>
        <div class="stat-card"><div class="stat-val" id="countUsers">0</div><div class="stat-lbl">TOTAL</div></div>
    </div>

    <div class="card" style="padding: 15px; margin: 0; background: rgba(251, 191, 36, 0.1); border: 1px solid var(--gold);">
        <label style="color:var(--gold)"><i data-lucide="trophy" style="width:12px"></i> Jackpot Prize</label>
        <input type="text" id="jackpotAmount" placeholder="e.g. â‚±5,000" style="margin-bottom:10px; text-align:center; font-weight:bold; color:var(--gold);">
        <div class="toggle-switch" id="jackpotToggle" onclick="toggleJackpot()">
            <div class="toggle-knob"></div>
            <span id="jackpotStatusText">HIDDEN</span>
        </div>
    </div>

    <div class="input-group">
        <label>Game Schedule Manager</label>
        <div style="display: flex; gap: 5px;">
            <input type="datetime-local" id="schedInput">
            <button class="btn btn-primary" onclick="addSchedule()" style="width: auto; margin-top: 0;">+</button>
        </div>
        <div id="scheduleList" class="sched-list"></div>
    </div>

    <div class="card" style="padding: 15px; background: rgba(0,0,0,0.2); flex:1; overflow:hidden; display:flex; flex-direction:column;">
        <label>Active Users List (Online)</label>
        <div id="activeUsersList" style="flex:1; overflow-y: auto; font-size: 11px;"></div>
    </div>

    <button class="btn btn-danger" onclick="resetGame()"><i data-lucide="refresh-ccw"></i> RESET GAME</button>
</div>

<div class="main-section">
    <div id="winnerAnnounce" class="winner-marquee">
        <div class="marquee-text" id="winnerMarqueeText">MAY NANALO NA! CONGRATULATIONS SA ATING WINNER! ðŸŽ‰</div>
    </div>

    <div class="tabs-nav">
        <button class="tab-btn active" onclick="openTab('bingo-tab', this)"><i data-lucide="layout-grid"></i> BINGO</button>
        <button class="tab-btn" onclick="openTab('bringme-tab', this)"><i data-lucide="camera"></i> BRING ME</button>
        <button class="tab-btn" onclick="openTab('users-tab', this)"><i data-lucide="user-cog"></i> PLAYERS</button>
        <button class="tab-btn" onclick="openTab('cashout-tab', this)"><i data-lucide="wallet"></i> CASHOUTS</button>
    </div>

    <div id="bingo-tab" class="tab-content active">
        <div style="display:grid; grid-template-columns: 1fr 2fr; gap: 20px;">
            <div class="card">
                <h2><i data-lucide="settings"></i> Game Control</h2>
                <div class="input-group">
                    <label>Pattern</label>
                    <select id="patternSelect" onchange="setPattern(this.value)">
                        <option value="Normal Bingo">Normal Bingo</option>
                        <option value="Blackout">Blackout</option>
                        <option value="Letter X">Letter X</option>
                        <option value="Four Corners">Four Corners</option>
                    </select>
                </div>
                
                <div class="auto-draw-panel">
                    <label style="color:var(--success); margin-bottom:8px;">AUTOMATIC MACHINE</label>
                    <div style="display:flex; gap:10px; align-items:center; margin-bottom:10px;">
                        <input type="range" id="drawSpeed" min="3" max="15" value="8" style="flex:1" oninput="document.getElementById('speedVal').innerText=this.value+'s'">
                        <span id="speedVal" style="font-size:12px; font-weight:800; width:30px;">8s</span>
                    </div>
                    <button class="btn btn-primary" id="btnAutoDraw" onclick="toggleAutoDraw()" style="background:var(--success)">
                        <i data-lucide="play"></i> START AUTO DRAW
                    </button>
                </div>

                <div class="input-group">
                    <label>Current Ball</label>
                    <div id="lastBall" style="font-size: 60px; font-weight: 900; text-align: center; color: var(--accent); background: var(--glass); border-radius: 15px; padding: 10px;">--</div>
                </div>
                <div style="font-size:10px; font-weight:800; opacity:0.5; margin-top:10px;">MANUAL OVERRIDE:</div>
                <div class="ball-grid" id="ballGrid"></div>
            </div>

            <div class="card">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                    <h2><i data-lucide="users"></i> Live Cards Monitoring</h2>
                    <div style="font-size:11px; display:flex; gap:10px;">
                        <span style="display:flex; align-items:center; gap:4px"><div style="width:10px; height:10px; background:var(--puro); border-radius:2px;"></div> PURO</span>
                        <span style="display:flex; align-items:center; gap:4px"><div style="width:10px; height:10px; background:var(--success); border-radius:2px;"></div> BINGO</span>
                    </div>
                </div>
                <div class="cards-grid" id="liveCardsContainer">
                    </div>
            </div>
        </div>
    </div>

    <div id="users-tab" class="tab-content">
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap: 20px;">
            <div class="card">
                <h2><i data-lucide="coins"></i> Manage Points</h2>
                <div class="input-group">
                    <label>Select User</label>
                    <div id="pointsUserList" class="user-select-list"></div>
                    <input type="hidden" id="selectedUserForPoints">
                </div>
                <div class="input-group">
                    <label>Amount (Use negative to deduct)</label>
                    <input type="number" id="pointsAmount" placeholder="e.g. 500 or -500">
                </div>
                <button class="btn btn-primary" onclick="modifyUserPoints()">UPDATE POINTS</button>
            </div>

            <div class="card">
                <h2><i data-lucide="send"></i> Send Notification / Task</h2>
                <div class="input-group">
                    <label>Recipient</label>
                    <select id="notifRecipient">
                        <option value="all">ALL USERS</option>
                        <option value="selected">Selected User Only (From Left)</option>
                    </select>
                </div>
                <div class="input-group">
                    <label>Message / Task Instruction</label>
                    <textarea id="notifMessage" rows="4" placeholder="e.g. Bonus points! or Do this task..."></textarea>
                </div>
                <button class="btn btn-bringme" onclick="sendAdminNotification()">SEND NOTIFICATION</button>
            </div>
        </div>
    </div>

    <div id="bringme-tab" class="tab-content">
        <div class="card" style="background: linear-gradient(145deg, #2e1065, #1e1b4b); border: 2px solid var(--bringme);">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                <h2 style="color:white; margin:0;"><i data-lucide="zap"></i> AI BRING ME</h2>
                <div id="bringmeStatusBadge" class="status-badge status-off">OFFLINE</div>
            </div>
            <div style="display:grid; grid-template-columns: 2fr 1fr 1fr; gap:15px; align-items:end;">
                <div class="input-group" style="margin:0;">
                    <label style="color:rgba(255,255,255,0.6)">Item Target</label>
                    <input type="text" id="bringmeItemIn" placeholder="e.g. Spoon">
                </div>
                <button class="btn btn-bringme" onclick="startBringMe()"><i data-lucide="play"></i> START</button>
                <button class="btn btn-danger" onclick="stopBringMe()"><i data-lucide="square"></i> STOP</button>
            </div>
        </div>
        <div class="card">
            <h2><i data-lucide="image"></i> Submissions Gallery</h2>
            <div class="bringme-gallery" id="bringmeGallery"></div>
        </div>
    </div>

    <div id="cashout-tab" class="tab-content">
        <div class="card">
            <h2><i data-lucide="wallet"></i> GCash Requests</h2>
            <div id="cashoutList"></div>
        </div>
    </div>
</div>

<script>
    lucide.createIcons();
    const firebaseConfig = { apiKey: "AIzaSyDIAQXJ15atKJxu7PtcFL1W9JnO1N14pVs", authDomain: "radiobingo-9ac29.firebaseapp.com", databaseURL: "https://radiobingo-9ac29-default-rtdb.asia-southeast1.firebasedatabase.app", projectId: "radiobingo-9ac29", storageBucket: "radiobingo-9ac29.firebasestorage.app", messagingSenderId: "965903993397", appId: "1:965903993397:web:f6646fa05225f147eebf7c" };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    let currentPattern = "Normal Bingo";
    let drawnNumbers = [];
    let autoDrawInterval = null;
    let isAutoDrawing = false;
    let jackpotVisible = false;
    let schedules = {};
    let globalStatusData = {}; // Store status data

    function openTab(tabId, btn) {
        document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.getElementById(tabId).classList.add('active');
        btn.classList.add('active');
    }

    for(let i=1; i<=75; i++) {
        let b = document.createElement('div'); b.className = 'ball'; b.id = 'ball-'+i; b.innerText = i; b.onclick = () => toggleBall(i);
        document.getElementById('ballGrid').appendChild(b);
    }

    db.ref('gameState/schedules').on('value', s => { schedules = s.val() || {}; renderSchedules(); });
    function addSchedule() { const input = document.getElementById('schedInput'); if(!input.value) return; const time = new Date(input.value).getTime(); db.ref('gameState/schedules').push(time); input.value = ""; }
    function removeSchedule(key) { db.ref('gameState/schedules/' + key).remove(); }
    function renderSchedules() {
        const list = document.getElementById('scheduleList'); list.innerHTML = "";
        const sorted = Object.entries(schedules).sort(([,a], [,b]) => a - b);
        sorted.forEach(([key, val]) => { const date = new Date(val); const str = date.toLocaleDateString('en-PH', { month:'short', day:'numeric'}) + ' ' + date.toLocaleTimeString('en-PH', {hour:'2-digit', minute:'2-digit'}); list.innerHTML += `<div class="sched-item"><span>${str}</span><button class="btn-xs" style="background:var(--danger); color:white;" onclick="removeSchedule('${key}')">X</button></div>`; });
    }

    setInterval(() => {
        const now = Date.now();
        Object.entries(schedules).forEach(([key, time]) => { if(now >= time && now < time + 60000) { if(!isAutoDrawing) { toggleAutoDraw(); console.log("Scheduled Game Started!"); } removeSchedule(key); } });
    }, 5000);

    db.ref('drawnNumbers').on('value', s => {
        drawnNumbers = s.val() ? Object.values(s.val()) : [];
        document.querySelectorAll('.ball').forEach(b => b.classList.remove('drawn'));
        drawnNumbers.forEach(n => document.getElementById('ball-'+n).classList.add('drawn'));
        const lastNum = drawnNumbers.length ? drawnNumbers[drawnNumbers.length-1] : "--";
        document.getElementById('lastBall').innerText = lastNum;
        if(lastNum !== "--") speakNumber(lastNum);
        updateMonitorCards();
    });

    db.ref('gameState/currentPattern').on('value', s => { currentPattern = s.val() || "Normal Bingo"; document.getElementById('patternSelect').value = currentPattern; updateMonitorCards(); });

    function toggleJackpot() {
        jackpotVisible = !jackpotVisible; const amount = document.getElementById('jackpotAmount').value;
        const toggleBtn = document.getElementById('jackpotToggle'); const statusText = document.getElementById('jackpotStatusText');
        if(jackpotVisible) { toggleBtn.classList.add('active'); statusText.innerText = "VISIBLE"; db.ref('gameState/jackpot').set({ amount: amount, active: true }); } 
        else { toggleBtn.classList.remove('active'); statusText.innerText = "HIDDEN"; db.ref('gameState/jackpot').set({ amount: amount, active: false }); }
    }
    db.ref('gameState/jackpot').once('value', s => { if(s.exists()){ const d = s.val(); document.getElementById('jackpotAmount').value = d.amount || ""; if(d.active) { jackpotVisible = true; document.getElementById('jackpotToggle').classList.add('active'); document.getElementById('jackpotStatusText').innerText = "VISIBLE"; } } });
    document.getElementById('jackpotAmount').addEventListener('input', (e) => { if(jackpotVisible) { db.ref('gameState/jackpot').update({ amount: e.target.value }); } });

    function toggleAutoDraw() {
        if(!isAutoDrawing) { db.ref('gameState/latestWinner').once('value', s => { if(s.exists()) { alert("May Winner Na! Reset Game muna bago mag start ulit."); return; } startAutoDrawLogic(); }); } 
        else { stopAutoDrawLogic(); }
    }

    function startAutoDrawLogic() { const btn = document.getElementById('btnAutoDraw'); const speed = document.getElementById('drawSpeed').value * 1000; isAutoDrawing = true; btn.innerHTML = `<i data-lucide="pause"></i> STOP AUTO DRAW`; btn.style.background = "var(--danger)"; autoDrawLogic(); autoDrawInterval = setInterval(autoDrawLogic, speed); lucide.createIcons(); }
    function stopAutoDrawLogic() { const btn = document.getElementById('btnAutoDraw'); clearInterval(autoDrawInterval); isAutoDrawing = false; btn.innerHTML = `<i data-lucide="play"></i> START AUTO DRAW`; btn.style.background = "var(--success)"; lucide.createIcons(); }
    function autoDrawLogic() {
        if(drawnNumbers.length >= 75) { stopAutoDrawLogic(); return alert("Game Over! All numbers drawn."); }
        db.ref('gameState/latestWinner').once('value', s => { if(s.exists()) { stopAutoDrawLogic(); return; } let nextNum; do { nextNum = Math.floor(Math.random() * 75) + 1; } while (drawnNumbers.includes(nextNum)); toggleBall(nextNum); });
    }
    function speakNumber(num) { if ('speechSynthesis' in window) { let letter = "B"; if (num > 15) letter = "I"; if (num > 30) letter = "N"; if (num > 45) letter = "G"; if (num > 60) letter = "O"; const msg = new SpeechSynthesisUtterance(`${letter} ${num}`); msg.rate = 0.9; window.speechSynthesis.speak(msg); } }
    function toggleBall(num) { const ref = db.ref('drawnNumbers/' + num); ref.once('value', s => { if(s.exists()) ref.remove(); else { ref.set(num); db.ref('gameState/gameStartTime').once('value', ss => { if(!ss.exists()) db.ref('gameState/gameStartTime').set(Date.now()); }); } }); }

    // --- RE-ENGINEERED CARD MONITORING & STATUS ---

    // Fetch Status Data First
    db.ref('status').on('value', s => {
        globalStatusData = s.val() || {};
        document.getElementById('countOnline').innerText = Object.keys(globalStatusData).length;
        renderActiveUserList();
        updateMonitorCards(); // Refresh cards on status change
    });

    function renderActiveUserList() {
        const list = document.getElementById('activeUsersList'); list.innerHTML = "";
        Object.entries(globalStatusData).forEach(([uid, data]) => {
            const name = data.name || "Unknown User";
            list.innerHTML += `<div style="padding:4px 0; border-bottom:1px solid var(--glass); display:flex; align-items:center; gap:6px;">
                <span class="online-dot"></span> ${name}
            </div>`;
        });
    }

    // Populate Selection List for Management
    db.ref('users').on('value', s => {
        const list = document.getElementById('pointsUserList');
        const currentSelected = document.getElementById('selectedUserForPoints').value;
        list.innerHTML = "";
        document.getElementById('countUsers').innerText = s.numChildren();
        
        s.forEach(child => {
            const u = child.val();
            const uid = child.key;
            const isSel = currentSelected === uid ? 'selected' : '';
            const div = document.createElement('div');
            div.className = `user-option ${isSel}`;
            div.onclick = () => selectUserForMgmt(uid, div);
            div.innerHTML = `<span>${u.name}</span> <span>${u.points || 0} pts</span>`;
            list.appendChild(div);
        });
        updateMonitorCards();
    });

    function selectUserForMgmt(uid, el) {
        document.querySelectorAll('.user-option').forEach(e => e.classList.remove('selected'));
        el.classList.add('selected');
        document.getElementById('selectedUserForPoints').value = uid;
    }

    function updateMonitorCards() {
        db.ref('users').once('value', s => {
            const container = document.getElementById('liveCardsContainer');
            container.innerHTML = "";
            let usersArray = [];

            s.forEach(child => {
                const user = child.val();
                if(user.card || user.currentCard) {
                    usersArray.push({ ...user, uid: child.key });
                }
            });

            // SORT: Online first, then by name
            usersArray.sort((a, b) => {
                const aOnline = globalStatusData[a.uid] ? 1 : 0;
                const bOnline = globalStatusData[b.uid] ? 1 : 0;
                return bOnline - aOnline; 
            });

            usersArray.forEach(user => {
                const card = user.currentCard || user.card;
                const check = checkCardStatus(card, currentPattern, drawnNumbers);
                
                // If reset happened, ignore DB 'hasWonCurrent' until someone wins again
                let isBingo = check.isBingo;
                if(user.hasWonCurrent && drawnNumbers.length > 0) isBingo = true;

                const isPuro = check.isPuro && !isBingo;
                const isOnline = globalStatusData[user.uid] ? true : false;

                const cardDiv = document.createElement('div');
                cardDiv.className = `user-card-monitor ${isBingo ? 'bingo' : ''} ${isPuro ? 'puro' : ''}`;
                
                let gridHtml = '<div class="mini-bingo-grid">';
                card.forEach((n, idx) => {
                    const marked = drawnNumbers.includes(n) || n === "FREE";
                    const isWinningCell = check.winningCells.includes(idx); 
                    gridHtml += `<div class="mini-cell ${marked ? 'marked' : ''} ${isWinningCell ? 'hit' : ''}">${n === "FREE" ? 'â˜…' : n}</div>`;
                });
                gridHtml += '</div>';

                cardDiv.innerHTML = `
                    <div class="monitor-badge">${isBingo ? "BINGO!" : "PURO!"}</div>
                    <div style="font-size:11px; font-weight:800; display:flex; justify-content:space-between; color:white; align-items:center;">
                        <span style="display:flex; align-items:center; gap:5px;">
                            <span class="${isOnline ? 'online-dot' : 'offline-dot'}"></span>
                            ${user.name.split(' ')[0]}
                        </span>
                        <span style="font-size:9px; background:rgba(255,255,255,0.1); padding:2px 5px; border-radius:4px;">${user.points || 0} pts</span>
                    </div>
                    ${gridHtml}
                `;
                if(isBingo) container.prepend(cardDiv); 
                else if(isPuro) container.insertBefore(cardDiv, container.children[1] || null); 
                else container.appendChild(cardDiv);
            });
        });
    }

    function checkCardStatus(card, pattern, drawn) {
        let markedIndices = [12]; card.forEach((val, idx) => { if(drawn.includes(val) && idx !== 12) markedIndices.push(idx); });
        let patterns = [];
        if (pattern === "Blackout") { patterns = [[...Array(25).keys()]]; }
        else if (pattern === "Letter X") { patterns = [[0,4,6,8,12,16,18,20,24]]; }
        else if (pattern === "Four Corners") { patterns = [[0,4,20,24]]; }
        else { patterns = [[0,1,2,3,4],[5,6,7,8,9],[10,11,12,13,14],[15,16,17,18,19],[20,21,22,23,24],[0,5,10,15,20],[1,6,11,16,21],[2,7,12,17,22],[3,8,13,18,23],[4,9,14,19,24],[0,6,12,18,24],[4,8,12,16,20]]; }
        let isBingo = false; let isPuro = false; let winningCells = [];
        for (let p of patterns) { const hits = p.filter(idx => markedIndices.includes(idx)); const needed = p.length; const got = hits.length; if (got === needed) { isBingo = true; winningCells = p; break; } else if (needed - got === 1) { isPuro = true; } }
        return { isBingo, isPuro, winningCells };
    }

    db.ref('gameState/latestWinner').on('value', s => {
        const marquee = document.getElementById('winnerAnnounce');
        if(s.exists()) {
            const winData = s.val(); let msg = `ðŸŽ‰ BINGO WINNER: ${winData.name.toUpperCase()}!`;
            if(winData.prize) msg += ` WON â‚±${winData.prize.toLocaleString()} POINTS! ðŸ’°`; else msg += ` CONGRATULATIONS! ðŸŽ‰`;
            marquee.style.display = 'block'; document.getElementById('winnerMarqueeText').innerText = msg;
            if(isAutoDrawing) { stopAutoDrawLogic(); alert("AUTO STOP: We have a winner!"); }
        } else { marquee.style.display = 'none'; updateMonitorCards(); } // Force update cards on reset
    });

    // --- POINTS AND NOTIFICATION MGMT ---

    function modifyUserPoints() {
        const uid = document.getElementById('selectedUserForPoints').value;
        const amount = document.getElementById('pointsAmount').value;
        if(!uid) return alert("Select a user first!");
        if(!amount) return alert("Enter amount");
        
        db.ref(`users/${uid}/points`).transaction(current => (current || 0) + parseInt(amount));
        alert("Points updated!");
        document.getElementById('pointsAmount').value = "";
    }

    function sendAdminNotification() {
        const type = document.getElementById('notifRecipient').value;
        const msg = document.getElementById('notifMessage').value;
        if(!msg) return alert("Enter message");

        if(type === 'selected') {
            const uid = document.getElementById('selectedUserForPoints').value;
            if(!uid) return alert("Select a user first!");
            db.ref(`notifications/${uid}`).push({ msg: msg, time: Date.now(), read: false });
            alert("Sent to user!");
        } else {
            if(confirm("Send to ALL users?")) {
                db.ref('users').once('value', s => {
                    s.forEach(u => {
                       db.ref(`notifications/${u.key}`).push({ msg: msg, time: Date.now(), read: false }); 
                    });
                });
                alert("Sent to all!");
            }
        }
        document.getElementById('notifMessage').value = "";
    }

    // --- BRING ME & OTHERS ---
    db.ref('gameState/bringMeSubmissions').on('value', s => {
        const gallery = document.getElementById('bringmeGallery'); gallery.innerHTML = "";
        s.forEach(child => { const data = child.val(); gallery.innerHTML += `<div class="photo-card"><img src="${data.photoUrl}" onclick="window.open(this.src)"><div class="photo-info"><b>${data.userName}</b><br><span style="color:var(--gold)">Score: ${data.aiScore || 0}%</span></div></div>`; });
    });
    function startBringMe() { const item = document.getElementById('bringmeItemIn').value.trim(); if(!item) return alert("Maglagay ng item!"); db.ref('gameState/bringMe').set({ active: true, item: item, winner: null, startTime: Date.now() }); db.ref('gameState/bringMeSubmissions').remove(); }
    function stopBringMe() { db.ref('gameState/bringMe').update({ active: false }); }
    db.ref('gameState/bringMe').on('value', s => { const data = s.val(); const badge = document.getElementById('bringmeStatusBadge'); if(data && data.active) { badge.innerText = "LIVE NOW"; badge.className = "status-badge status-active"; } else { badge.innerText = "OFFLINE"; badge.className = "status-badge status-off"; } });

    function setPattern(p) { db.ref('gameState/currentPattern').set(p); }
    
    function resetGame() {
        if(confirm("WARNING: This will reset the board, winner status, and drawn numbers. Proceed?")){
            db.ref('drawnNumbers').remove(); db.ref('gameState/latestWinner').remove(); db.ref('gameState/gameStartTime').remove();
            db.ref('users').once('value', s => { let updates = {}; s.forEach(u => { updates[u.key + '/hasWonCurrent'] = false; }); db.ref('users').update(updates); });
            stopAutoDrawLogic();
            // Force cards visual update immediately
            setTimeout(updateMonitorCards, 500);
        }
    }

    db.ref('redemptions').on('value', s => {
        const list = document.getElementById('cashoutList'); list.innerHTML = "";
        s.forEach(child => {
            const r = child.val(); const key = child.key; if(r.status !== 'pending') return;
            const div = document.createElement('div'); div.className = 'card'; div.style.padding = "15px";
            div.innerHTML = `<div style="display:flex; justify-content:space-between; align-items:center;"><div><div style="font-weight:800;">${r.name} - <span style="color:var(--gold)">${r.item}</span></div><div style="font-size:11px; opacity:0.6;">GCash: ${r.gcash}</div></div><div style="display:flex; gap:10px;"><button class="btn btn-primary" style="width:auto; padding:8px 20px" onclick="updateStatus('${key}', 'sent', ${JSON.stringify(r).replace(/"/g, '&quot;')})">PAID</button><button class="btn btn-danger" style="width:auto; padding:8px 20px" onclick="updateStatus('${key}', 'denied', ${JSON.stringify(r).replace(/"/g, '&quot;')})">X</button></div></div>`;
            list.prepend(div);
        });
    });
    function updateStatus(key, status, data) {
        if(confirm(`${status} this?`)) {
            db.ref('redemptions/' + key).update({ status: status });
            const statusMsg = status === 'sent' ? `Ang iyong ${data.item} ay na-ipadala na! îžé ‚` : `Ang iyong ${data.item} ay na-deny. ç¬¶å½¢`;
            db.ref('notifications/' + data.uid).push({ msg: statusMsg, time: Date.now() });
            if(status === 'denied') db.ref('users/' + data.uid + '/points').transaction(p => (p || 0) + data.cost);
        }
    }
</script>
</body>
</html>
