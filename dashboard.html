<!DOCTYPE html>
<html lang="tl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Radio Bingo | Admin Command</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <style>
        :root { --bg: #0f172a; --panel: #1e293b; --border: #334155; --accent: #3b82f6; --text: #f1f5f9; --green: #10b981; --red: #ef4444; --yellow: #eab308; }
        * { box-sizing: border-box; }
        body { font-family: 'Inter', sans-serif; background: var(--bg); color: var(--text); margin: 0; display: flex; height: 100vh; overflow: hidden; }

        /* SIDEBAR */
        .sidebar { width: 300px; background: var(--panel); border-right: 1px solid var(--border); display: flex; flex-direction: column; padding: 20px; overflow-y: auto; }
        .brand { font-size: 24px; font-weight: 900; margin-bottom: 30px; letter-spacing: -1px; }
        .control-group { margin-bottom: 25px; padding-bottom: 25px; border-bottom: 1px solid var(--border); }
        .control-group h3 { font-size: 12px; text-transform: uppercase; color: #94a3b8; margin: 0 0 10px 0; font-weight: 800; }
        
        .btn { width: 100%; padding: 12px; border: none; border-radius: 8px; font-weight: 700; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; margin-bottom: 10px; transition: 0.2s; font-size: 14px; }
        .btn-primary { background: var(--accent); color: white; }
        .btn-green { background: var(--green); color: white; }
        .btn-red { background: var(--red); color: white; }
        .btn:hover { opacity: 0.9; }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }

        .stat-row { display: flex; justify-content: space-between; margin-bottom: 5px; font-size: 14px; }
        .input-dark { width: 100%; background: #020617; border: 1px solid var(--border); color: white; padding: 10px; border-radius: 8px; margin-bottom: 10px; }

        /* MAIN AREA */
        .main { flex: 1; display: flex; flex-direction: column; padding: 20px; overflow: hidden; }
        
        /* HEADER STATS */
        .header-stats { display: flex; gap: 15px; margin-bottom: 20px; }
        .stat-card { flex: 1; background: var(--panel); padding: 15px; border-radius: 12px; border: 1px solid var(--border); display: flex; align-items: center; justify-content: space-between; }
        .stat-num { font-size: 24px; font-weight: 900; }
        .stat-label { font-size: 12px; color: #94a3b8; font-weight: 700; }

        /* GRID MONITOR */
        .monitor-area { flex: 1; background: #020617; border-radius: 16px; border: 1px solid var(--border); padding: 15px; overflow-y: auto; }
        .monitor-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 15px; }
        
        .player-card { background: var(--panel); padding: 10px; border-radius: 10px; border: 2px solid transparent; position: relative; }
        .player-card.is-online { border-color: rgba(59, 130, 246, 0.3); }
        .player-card.is-puro { border-color: var(--yellow); background: rgba(234, 179, 8, 0.1); animation: pulse 1s infinite; }
        .player-card.is-winner { border-color: var(--green); background: rgba(16, 185, 129, 0.2); box-shadow: 0 0 20px var(--green); z-index: 10; }
        
        .mini-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 2px; margin-top: 8px; }
        .mini-cell { aspect-ratio: 1; background: rgba(255,255,255,0.05); display: flex; align-items: center; justify-content: center; font-size: 8px; border-radius: 2px; }
        .mini-cell.hit { background: var(--accent); color: white; }
        .mini-cell.free { background: var(--green); color: white; }

        /* LAST BALL DISPLAY */
        .big-ball { width: 80px; height: 80px; background: var(--accent); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 32px; font-weight: 900; margin: 0 auto 15px; box-shadow: 0 10px 20px rgba(59, 130, 246, 0.3); }

        @keyframes pulse { 50% { opacity: 0.7; transform: scale(0.98); } }
        
        /* WINNER MODAL */
        #winnerAlert { position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 999; display: none; align-items: center; justify-content: center; backdrop-filter: blur(5px); }
        .winner-box { background: var(--panel); padding: 40px; border-radius: 20px; text-align: center; border: 2px solid var(--green); max-width: 500px; width: 90%; }
        .winner-box h1 { color: var(--green); font-size: 40px; margin: 0; }
    </style>
</head>
<body>

<div class="sidebar">
    <div class="brand">ADMIN<span style="color:var(--accent)">PANEL</span></div>

    <div class="control-group" style="text-align:center;">
        <div class="big-ball" id="currentBallDisplay">--</div>
        <button class="btn btn-green" id="btnAutoDraw" onclick="toggleAutoDraw()">
            <i data-lucide="play"></i> START AUTO DRAW
        </button>
        <button class="btn btn-red" onclick="resetGame()">
            <i data-lucide="refresh-cw"></i> RESET GAME
        </button>
    </div>

    <div class="control-group">
        <h3>Game Settings</h3>
        <div style="font-size:11px; margin-bottom:5px;">Jackpot Prize (Text)</div>
        <div style="display:flex; gap:5px;">
            <input type="text" id="jackpotIn" class="input-dark" value="₱5,000" style="margin:0;">
            <button class="btn btn-primary" style="width:auto; margin:0;" onclick="updateJackpot()">SET</button>
        </div>
        <div style="font-size:11px; margin-top:15px; margin-bottom:5px;">Pattern</div>
        <select id="patternSelect" class="input-dark" onchange="setPattern()">
            <option value="Normal Bingo">Normal Bingo</option>
            <option value="Blackout">Blackout</option>
            <option value="Letter X">Letter X</option>
        </select>
    </div>

    <div class="control-group">
        <h3>Bring Me</h3>
        <input type="text" id="bmItem" class="input-dark" placeholder="Item Name (e.g. Spoon)">
        <button class="btn btn-primary" onclick="startBM()">START ROUND</button>
        <button class="btn btn-red" onclick="stopBM()">STOP ROUND</button>
    </div>

    <div style="font-size:10px; opacity:0.5; margin-top:auto;">
        RadioBingo Admin v2.0
    </div>
</div>

<div class="main">
    <div class="header-stats">
        <div class="stat-card">
            <div>
                <div class="stat-num" id="statOnline">0</div>
                <div class="stat-label">ONLINE USERS</div>
            </div>
            <i data-lucide="users" style="color:var(--accent)"></i>
        </div>
        <div class="stat-card">
            <div>
                <div class="stat-num" id="statCards">0</div>
                <div class="stat-label">ACTIVE CARDS</div>
            </div>
            <i data-lucide="grid" style="color:var(--green)"></i>
        </div>
        <div class="stat-card">
            <div>
                <div class="stat-num" id="statDrawn">0</div>
                <div class="stat-label">BALLS DRAWN</div>
            </div>
            <i data-lucide="hash" style="color:var(--yellow)"></i>
        </div>
    </div>

    <div class="monitor-area">
        <h3 style="margin-top:0; border-bottom:1px solid var(--border); padding-bottom:10px;">
            <i data-lucide="monitor"></i> REAL-TIME MONITORING
        </h3>
        <div id="monitorGrid" class="monitor-grid">
            </div>
    </div>
</div>

<div id="winnerAlert">
    <div class="winner-box">
        <h1>WINNER!</h1>
        <h2 id="winnerText" style="color:white; font-size:30px;">User Name</h2>
        <p style="opacity:0.7;">Auto Draw has stopped.</p>
        <button class="btn btn-primary" onclick="document.getElementById('winnerAlert').style.display='none'">CLOSE</button>
    </div>
</div>

<script>
    lucide.createIcons();
    const firebaseConfig = { apiKey: "AIzaSyDIAQXJ15atKJxu7PtcFL1W9JnO1N14pVs", authDomain: "radiobingo-9ac29.firebaseapp.com", databaseURL: "https://radiobingo-9ac29-default-rtdb.asia-southeast1.firebasedatabase.app", projectId: "radiobingo-9ac29", storageBucket: "radiobingo-9ac29.firebasestorage.app", messagingSenderId: "965903993397", appId: "1:965903993397:web:f6646fa05225f147eebf7c" };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    let drawnNumbers = [];
    let isAutoDrawing = false;
    let autoDrawInterval;
    let currentPattern = "Normal Bingo";
    let activeUsers = [];

    // --- INITIALIZATION ---
    function init() {
        // Sync Drawn Numbers
        db.ref('drawnNumbers').on('value', s => {
            const val = s.val();
            drawnNumbers = val ? Object.values(val) : [];
            document.getElementById('statDrawn').innerText = drawnNumbers.length;
            document.getElementById('currentBallDisplay').innerText = drawnNumbers.length ? drawnNumbers[drawnNumbers.length-1] : "--";
            renderMonitoring();
        });

        // Sync Online Count
        db.ref('status').on('value', s => {
            const online = s.numChildren();
            document.getElementById('statOnline').innerText = online;
            // Update local status for sorting
            const onlineIds = Object.keys(s.val() || {});
            activeUsers.forEach(u => u.isOnline = onlineIds.includes(u.uid));
            renderMonitoring();
        });

        // Sync Users & Cards
        db.ref('users').on('value', s => {
            activeUsers = [];
            s.forEach(child => {
                const u = child.val();
                if(u.currentCard) {
                    activeUsers.push({
                        uid: child.key,
                        name: u.name,
                        card: u.currentCard,
                        isOnline: false, // Updated by status listener
                        hasWon: u.hasWonCurrent
                    });
                }
            });
            document.getElementById('statCards').innerText = activeUsers.length;
            renderMonitoring();
        });

        // Winner Check
        db.ref('gameState/latestWinner').on('value', s => {
            if(s.exists()) {
                stopAutoDraw();
                const w = s.val();
                document.getElementById('winnerAlert').style.display = 'flex';
                document.getElementById('winnerText').innerText = w.name;
            }
        });
    }

    // --- AUTO DRAW LOGIC ---
    function toggleAutoDraw() {
        if(isAutoDrawing) stopAutoDraw();
        else startAutoDraw();
    }

    function startAutoDraw() {
        if(drawnNumbers.length >= 75) return alert("Full house na!");
        isAutoDrawing = true;
        document.getElementById('btnAutoDraw').innerHTML = `<i data-lucide="pause"></i> STOP AUTO DRAW`;
        document.getElementById('btnAutoDraw').className = "btn btn-red";
        
        autoDrawInterval = setInterval(() => {
            let num;
            do {
                num = Math.floor(Math.random() * 75) + 1;
            } while (drawnNumbers.includes(num));
            
            db.ref('drawnNumbers/' + num).set(num);
        }, 4000); // 4 seconds per ball
    }

    function stopAutoDraw() {
        isAutoDrawing = false;
        clearInterval(autoDrawInterval);
        document.getElementById('btnAutoDraw').innerHTML = `<i data-lucide="play"></i> START AUTO DRAW`;
        document.getElementById('btnAutoDraw').className = "btn btn-green";
        lucide.createIcons();
    }

    function resetGame() {
        if(confirm("RESET GAME? This will clear all balls and winners.")) {
            stopAutoDraw();
            db.ref('drawnNumbers').remove();
            db.ref('gameState/latestWinner').remove();
            // Reset winners status in users
            db.ref('users').once('value', s => {
                s.forEach(u => db.ref('users/'+u.key).update({ hasWonCurrent: false }));
            });
        }
    }

    // --- MONITORING LOGIC ---
    function renderMonitoring() {
        const grid = document.getElementById('monitorGrid');
        grid.innerHTML = "";

        // Sort: Winner > Puro > Online > Offline
        activeUsers.sort((a,b) => {
            if(a.hasWon) return -1; if(b.hasWon) return 1;
            const aNeed = countNeeded(a.card);
            const bNeed = countNeeded(b.card);
            if(aNeed === 1 && bNeed !== 1) return -1;
            if(bNeed === 1 && aNeed !== 1) return 1;
            if(a.isOnline && !b.isOnline) return -1;
            if(!a.isOnline && b.isOnline) return 1;
            return 0;
        });

        activeUsers.forEach(u => {
            const needed = countNeeded(u.card);
            const isPuro = needed === 1;
            const isOnline = u.isOnline ? 'is-online' : '';
            const statusClass = u.hasWon ? 'is-winner' : (isPuro ? 'is-puro' : isOnline);
            
            let html = `
                <div class="player-card ${statusClass}">
                    <div style="display:flex; justify-content:space-between; font-size:12px; font-weight:700; margin-bottom:5px;">
                        <span>${u.name.split(' ')[0]}</span>
                        <span style="${isPuro ? 'color:var(--yellow)' : 'color:#64748b'}">${needed} left</span>
                    </div>
                    <div class="mini-grid">
            `;
            
            u.card.forEach(n => {
                const hit = drawnNumbers.includes(n) || n === "FREE";
                const type = n === "FREE" ? 'free' : (hit ? 'hit' : '');
                html += `<div class="mini-cell ${type}">${n==="FREE"?"★":n}</div>`;
            });
            
            html += `</div></div>`;
            grid.innerHTML += html;
        });
    }

    function countNeeded(card) {
        // Basic Normal Bingo Logic (Check lines) - simplified for "Puro" Visual
        // Note: For perfect accuracy, we need the exact pattern logic here.
        // Using "Total Hits" for now as approximation for visual speed, 
        // or re-implement win logic.
        
        let marks = [];
        card.forEach((n,i) => { if(n==="FREE" || drawnNumbers.includes(n)) marks.push(i); });
        
        // Define Patterns
        let wins = [[0,1,2,3,4],[5,6,7,8,9],[10,11,12,13,14],[15,16,17,18,19],[20,21,22,23,24],[0,5,10,15,20],[1,6,11,16,21],[2,7,12,17,22],[3,8,13,18,23],[4,9,14,19,24],[0,6,12,18,24],[4,8,12,16,20]];
        if(currentPattern === "Blackout") wins = [Array.from({length:25},(_,i)=>i)];
        
        let minNeeded = 5;
        for(let w of wins) {
            const missing = w.filter(idx => !marks.includes(idx)).length;
            if(missing < minNeeded) minNeeded = missing;
        }
        return minNeeded;
    }

    // --- CONTROLS ---
    function updateJackpot() {
        const val = document.getElementById('jackpotIn').value;
        db.ref('gameState/jackpotPrize').set(val);
        alert("Jackpot Updated!");
    }

    function setPattern() {
        const p = document.getElementById('patternSelect').value;
        currentPattern = p;
        db.ref('gameState/currentPattern').set(p);
    }

    function startBM() {
        const item = document.getElementById('bmItem').value;
        if(!item) return;
        db.ref('gameState/bringMe').set({ active: true, item: item });
    }

    function stopBM() {
        db.ref('gameState/bringMe').update({ active: false });
    }

    init();
</script>
</body>
</html>
