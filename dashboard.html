<!DOCTYPE html>
<html lang="tl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Radio Bingo | Admin Master Pro 3D</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jsrsasign/10.5.1/jsrsasign-all-min.js"></script>
    <style>
        :root { 
            --bg-dark: #0f172a; 
            --bg-gradient: linear-gradient(135deg, #0f172a 0%, #1e1b4b 100%); 
            --glass-surface: rgba(30, 41, 59, 0.85); 
            --glass-border: rgba(255, 255, 255, 0.1); 
            --glass-highlight: rgba(255, 255, 255, 0.1); 
            --accent: #3b82f6; 
            --accent-glow: rgba(59, 130, 246, 0.5); 
            --text: #f8fafc; 
            --text-muted: #94a3b8; 
            --success: #10b981; 
            --danger: #ef4444; 
            --gold: #f59e0b; 
            --gold-glow: rgba(245, 158, 11, 0.5); 
            --puro: #f97316; 
            --bringme: #8b5cf6; 
            
            /* Spacing System */
            --spacing-xs: 8px;
            --spacing-sm: 12px;
            --spacing-md: 16px;
            --spacing-lg: 20px;
            --spacing-xl: 24px;
            
            /* Border Radius */
            --radius-sm: 8px;
            --radius-md: 12px;
            --radius-lg: 16px;
            --radius-xl: 20px;
            --radius-full: 50px;
            
            --shadow-card: 0 10px 30px -10px rgba(0,0,0,0.5); 
        }
        * { box-sizing: border-box; }
        body { font-family: 'Inter', sans-serif; background: var(--bg-gradient); background-attachment: fixed; color: var(--text); margin: 0; padding: var(--spacing-lg); display: grid; grid-template-columns: 300px 1fr 280px; gap: var(--spacing-lg); height: 100vh; overflow: hidden; }
        ::-webkit-scrollbar { width: 6px; } ::-webkit-scrollbar-track { background: rgba(0,0,0,0.1); } ::-webkit-scrollbar-thumb { background: var(--glass-border); border-radius: var(--spacing-sm); }
        .card, .sidebar, .tabs-nav, .activity-panel { background: var(--glass-surface); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px); border: 1px solid var(--glass-border); box-shadow: var(--shadow-card); }
        .sidebar { border-radius: var(--radius-lg); padding: var(--spacing-lg); overflow-y: auto; display: flex; flex-direction: column; gap: var(--spacing-md); height: calc(100vh - 40px); }
        .activity-panel { border-radius: var(--radius-lg); padding: var(--spacing-lg); overflow-y: hidden; display: flex; flex-direction: column; height: calc(100vh - 40px); }
        .logo-text { font-size: 24px; font-weight: 900; letter-spacing: -1px; text-transform: uppercase; background: linear-gradient(to right, #fff, #94a3b8); -webkit-background-clip: text; -webkit-text-fill-color: transparent; margin-bottom: var(--spacing-sm); text-shadow: 0 2px 10px rgba(255,255,255,0.1); }
        .stat-grid { display: grid; grid-template-columns: 1fr 1fr; gap: var(--spacing-sm); }
        .stat-card { background: rgba(0,0,0,0.2); padding: var(--spacing-sm); border-radius: var(--radius-md); text-align: center; border: 1px solid var(--glass-border); position: relative; overflow: hidden; }
        .stat-card::before { content: ''; position: absolute; top:0; left:0; width:100%; height:2px; background: linear-gradient(90deg, transparent, var(--accent), transparent); }
        .stat-val { font-size: 20px; font-weight: 900; color: white; text-shadow: 0 0 10px var(--accent-glow); }
        .stat-lbl { font-size: 9px; color: var(--text-muted); font-weight: 700; letter-spacing: 1px; margin-top: 3px; }
        .tabs-nav { display: flex; gap: 5px; margin-bottom: var(--spacing-lg); padding: var(--spacing-xs); border-radius: var(--radius-lg); }
        .tab-btn { flex: 1; padding: var(--spacing-sm); border-radius: var(--spacing-sm); border: none; background: transparent; color: var(--text-muted); font-weight: 700; cursor: pointer; transition: 0.3s cubic-bezier(0.4, 0, 0.2, 1); display: flex; align-items: center; justify-content: center; gap: var(--spacing-xs); font-size: 13px; }
        .tab-btn:hover { background: rgba(255,255,255,0.05); color: white; }
        .tab-btn.active { background: var(--accent); color: white; box-shadow: 0 4px 15px var(--accent-glow); transform: translateY(-1px); }
        .tab-content { display: none; height: calc(100vh - 140px); overflow-y: auto; padding-right: var(--spacing-sm); padding-bottom: var(--spacing-lg); }
        .tab-content.active { display: block; animation: fadeIn 0.3s ease; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .winner-marquee { background: linear-gradient(90deg, var(--gold), #fbbf24, var(--gold)); color: #451a03; padding: var(--spacing-sm); font-weight: 900; text-transform: uppercase; white-space: nowrap; overflow: hidden; position: relative; border-radius: var(--radius-md); margin-bottom: var(--spacing-lg); display: none; box-shadow: 0 0 20px var(--gold-glow); border: 1px solid #fde68a; }
        .marquee-text { display: inline-block; animation: marquee 15s linear infinite; }
        @keyframes marquee { 0% { transform: translateX(100%); } 100% { transform: translateX(-100%); } }
        .cards-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap: var(--spacing-md); }
        .user-card-monitor { background: rgba(15, 23, 42, 0.6); padding: var(--spacing-sm); border-radius: var(--radius-lg); border: 1px solid var(--glass-border); transition: all 0.3s ease; position: relative; box-shadow: 0 4px 6px rgba(0,0,0,0.2); }
        .user-card-monitor.offline { opacity: 0.4; filter: grayscale(100%); border: 1px dashed #334155; background: transparent; transform: scale(0.98); }
        .user-card-monitor.puro { border-color: var(--puro); box-shadow: 0 0 15px rgba(249, 115, 22, 0.3); animation: pulse-puro 1.5s infinite; background: linear-gradient(145deg, rgba(249, 115, 22, 0.1), rgba(15, 23, 42, 0.8)); }
        .user-card-monitor.bingo { border-color: var(--success); background: linear-gradient(145deg, rgba(6, 78, 59, 0.9), #064e3b); box-shadow: 0 0 25px rgba(16, 185, 129, 0.6); transform: scale(1.05) translateY(-5px); z-index: 10; }
        .monitor-badge { position: absolute; top: -8px; right: -8px; padding: 4px var(--spacing-sm); border-radius: var(--radius-xl); font-size: 10px; font-weight: 900; color: white; display: none; box-shadow: 0 2px 5px rgba(0,0,0,0.3); text-shadow: 0 1px 2px rgba(0,0,0,0.2); }
        .puro .monitor-badge { display: block; background: var(--puro); content: "PURO!"; }
        .bingo .monitor-badge { display: block; background: var(--success); content: "BINGO!"; }
        @keyframes pulse-puro { 0% { box-shadow: 0 0 0 0 rgba(249, 115, 22, 0.4); } 70% { box-shadow: 0 0 0 10px rgba(249, 115, 22, 0); } 100% { box-shadow: 0 0 0 0 rgba(249, 115, 22, 0); } }
        .mini-bingo-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 3px; margin-top: var(--spacing-sm); }
        .mini-cell { aspect-ratio: 1; background: rgba(0,0,0,0.4); font-size: 9px; display: flex; align-items: center; justify-content: center; border-radius: 4px; color: rgba(255,255,255,0.2); font-weight: 700; }
        .mini-cell.marked { background: var(--accent); color: white; box-shadow: 0 0 5px var(--accent-glow); }
        .mini-cell.hit { background: var(--gold); color: black; box-shadow: 0 0 8px var(--gold-glow); animation: pop 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); } 
        @keyframes pop { 0% { transform: scale(0.5); } 100% { transform: scale(1); } }
        .ball-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(45px, 1fr)); gap: var(--spacing-xs); margin-top: var(--spacing-md); }
        .ball { aspect-ratio: 1; background: linear-gradient(145deg, #334155, #1e293b); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 800; cursor: pointer; font-size: 14px; border: 1px solid var(--glass-border); transition: all 0.2s; box-shadow: inset 2px 2px 5px rgba(255,255,255,0.05), 0 5px 10px rgba(0,0,0,0.3); position: relative; }
        .ball::after { content: ''; position: absolute; top: 15%; left: 20%; width: 25%; height: 25%; background: radial-gradient(circle, rgba(255,255,255,0.8), transparent); border-radius: 50%; opacity: 0.4; }
        .ball:hover { transform: translateY(-2px); border-color: var(--accent); }
        .ball.drawn { background: radial-gradient(circle at 30% 30%, #60a5fa, #2563eb); color: white; box-shadow: 0 0 15px var(--accent-glow), inset -5px -5px 10px rgba(0,0,0,0.2); border: none; transform: scale(1.1); }
        .input-group { margin-bottom: var(--spacing-lg); }
        label { display: block; font-size: 11px; font-weight: 800; color: var(--text-muted); margin-bottom: var(--spacing-xs); text-transform: uppercase; letter-spacing: 0.5px; }
        input, select, textarea { width: 100%; background: rgba(0,0,0,0.3); border: 1px solid var(--glass-border); padding: 14px; border-radius: var(--radius-md); color: white; outline: none; font-family: inherit; font-size: 13px; transition: 0.3s; }
        input:focus, select:focus, textarea:focus { border-color: var(--accent); background: rgba(0,0,0,0.5); box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.1); }
        .btn { width: 100%; padding: 14px; border-radius: var(--radius-md); border: none; font-weight: 800; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: var(--spacing-xs); margin-top: var(--spacing-sm); transition: all 0.2s; text-transform: uppercase; font-size: 12px; letter-spacing: 0.5px; position: relative; overflow: hidden; }
        .btn:active { transform: scale(0.97); }
        .btn-primary { background: linear-gradient(135deg, #3b82f6, #2563eb); color: white; box-shadow: 0 4px 15px rgba(37, 99, 235, 0.4); }
        .btn-primary:hover { filter: brightness(1.1); }
        .btn-danger { background: linear-gradient(135deg, #ef4444, #dc2626); color: white; box-shadow: 0 4px 15px rgba(220, 38, 38, 0.4); }
        .btn-bringme { background: linear-gradient(135deg, #8b5cf6, #7c3aed); color: white; box-shadow: 0 4px 15px rgba(124, 58, 237, 0.4); }
        .btn-gold { background: linear-gradient(135deg, #fbbf24, #d97706); color: black; box-shadow: 0 4px 15px rgba(217, 119, 6, 0.4); }
        .online-dot { width: var(--spacing-xs); height: var(--spacing-xs); background: var(--success); border-radius: 50%; box-shadow: 0 0 8px var(--success); display: inline-block; }
        .offline-dot { width: var(--spacing-xs); height: var(--spacing-xs); background: #475569; border-radius: 50%; display: inline-block; border: 1px solid var(--glass-border); }
        .status-badge { padding: 4px var(--spacing-sm); border-radius: var(--radius-xl); font-size: 10px; font-weight: 800; text-transform: uppercase; }
        .status-active { background: var(--success); color: white; box-shadow: 0 0 10px rgba(16, 185, 129, 0.4); }
        .status-off { background: var(--danger); color: white; opacity: 0.8; }
        .card { padding: var(--spacing-xl); border-radius: var(--radius-lg); margin-bottom: var(--spacing-xl); }
        h2 { margin-top: 0; font-size: 16px; font-weight: 700; display: flex; align-items: center; gap: var(--spacing-xs); margin-bottom: var(--spacing-lg); color: white; }
        .user-select-list { max-height: 250px; overflow-y: auto; background: rgba(0,0,0,0.2); border-radius: var(--radius-md); padding: 5px; border: 1px solid var(--glass-border); }
        .user-option { padding: var(--spacing-sm) var(--spacing-sm); border-radius: var(--radius-sm); cursor: pointer; font-size: 12px; display: flex; justify-content: space-between; border-bottom: 1px solid rgba(255,255,255,0.03); transition: 0.2s; }
        .user-option:hover { background: rgba(255,255,255,0.05); }
        .user-option.selected { background: var(--accent); color: white; border: none; }
        .card-settings { background: rgba(15, 23, 42, 0.4); border: 1px solid var(--glass-border); padding: var(--spacing-md); border-radius: var(--radius-md); margin-bottom: var(--spacing-sm); }
        /* Live Activity */
        .live-log-item { font-size: 11px; padding: var(--spacing-sm); border-bottom: 1px solid rgba(255,255,255,0.05); animation: flash 1s ease; }
        @keyframes flash { 0% { background: rgba(59, 130, 246, 0.3); } 100% { background: transparent; } }
        .log-pos { color: var(--success); font-weight: 700; }
        .log-neg { color: var(--danger); font-weight: 700; }
        
        @media (max-width: 1100px) { body { grid-template-columns: 250px 1fr; overflow-y: auto; height: auto; } .activity-panel { display: none; } }
        @media (max-width: 900px) { body { grid-template-columns: 1fr; } .sidebar { height: auto; max-height: 500px; } .tab-content { height: auto; overflow: visible; } .main-section { padding-bottom: 50px; } }
    </style>
</head>
<body>

<div id="lockScreen" style="position:fixed; inset:0; background:#0f172a; z-index:999999; display:flex; flex-direction:column; align-items:center; justify-content:center; color:white;">
    <div style="width: 80px; height: 80px; background: rgba(255,255,255,0.1); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-bottom: 20px; box-shadow: 0 0 30px rgba(59, 130, 246, 0.3);">
        <i data-lucide="lock" style="width: 40px; height: 40px; color: var(--accent);"></i>
    </div>
    <div style="font-size:24px; font-weight:900; margin-bottom:10px; letter-spacing: -1px;">ADMIN <span style="color:var(--accent);">LOCKED</span></div>
    <p style="opacity: 0.6; font-size: 12px; margin-bottom: 30px;">Enter security PIN to access control panel.</p>
    <div style="display:flex; gap:10px;">
        <input type="password" id="adminPassInput" placeholder="Enter PIN" style="width:180px; padding:12px; text-align:center; border-radius:12px; border:1px solid #334155; background:#1e293b; color:white; font-weight:900; letter-spacing: 2px; outline: none;">
        <button onclick="checkAdminLock()" class="btn btn-primary" style="width:auto; padding:12px 20px; margin:0;"><i data-lucide="arrow-right"></i></button>
    </div>
</div>

<div class="sidebar">
    <div class="logo-text">ADMIN<span style="color:var(--accent)">PANEL</span> <span style="font-size:10px; vertical-align:middle; background:var(--gold); color:black; padding:2px 6px; border-radius:4px;">PRO</span></div>
    
    <div class="stat-grid">
        <div class="stat-card"><div class="stat-val" id="countOnline">0</div><div class="stat-lbl">ONLINE</div></div>
        <div class="stat-card"><div class="stat-val" id="countUsers">0</div><div class="stat-lbl">TOTAL</div></div>
    </div>

    <div class="card" style="padding: 15px; margin: 0; background: linear-gradient(145deg, rgba(245, 158, 11, 0.1), rgba(0,0,0,0)); border: 1px solid rgba(245, 158, 11, 0.3);">
        <label style="color:var(--gold)"><i data-lucide="trophy" style="width:12px"></i> Jackpot Prize</label>
        <input type="text" id="jackpotAmount" placeholder="e.g. ‚Ç±5,000" style="margin-bottom:10px; text-align:center; font-weight:900; color:var(--gold); font-size:18px;">
        <div style="display:flex; align-items:center; gap:10px; cursor:pointer;" id="jackpotToggle" onclick="toggleJackpot()">
            <div style="width:44px; height:24px; background:rgba(0,0,0,0.3); border-radius:20px; position:relative; transition:0.3s;" id="jackpotKnobBg">
                <div style="width:18px; height:18px; background:white; border-radius:50%; position:absolute; top:3px; left:3px; transition:0.3s;" id="jackpotKnob"></div>
            </div>
            <span id="jackpotStatusText" style="font-size:10px; font-weight:800; color:var(--text-muted)">HIDDEN</span>
        </div>
    </div>

    <div class="card" style="padding: 15px; margin: 0; background: rgba(59, 130, 246, 0.1); border: 1px solid rgba(59, 130, 246, 0.2);">
        <label style="color:var(--accent-glow)"><i data-lucide="video" style="width:12px"></i> Video Stream Manager</label>
        <input type="text" id="videoUrlInput" placeholder="Paste YouTube Link or ID here..." style="margin-bottom:10px;">
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:8px;">
            <button class="btn btn-primary" onclick="updateVideoFeed()" style="padding: 8px;">GO LIVE</button>
            <button class="btn btn-danger" onclick="setStreamOffline()" style="padding: 8px; background:rgba(255,255,255,0.1); border:1px solid rgba(255,255,255,0.2); box-shadow:none;">GO OFFLINE</button>
        </div>
        <div style="font-size:10px; margin-top:5px; opacity:0.7;">Offline = Shows "Waiting for Live" to players.</div>
    </div>

    <div class="input-group">
        <label>Game Schedule Manager</label>
        <div style="display: flex; gap: 8px;">
            <input type="datetime-local" id="schedInput" style="padding:10px;">
            <button class="btn btn-primary" onclick="addSchedule()" style="width: auto; margin-top: 0; padding:0 15px;">+</button>
        </div>
        <div id="scheduleList" style="margin-top:10px; max-height:100px; overflow-y:auto;"></div>
    </div>

    <div class="card" style="padding: 15px; background: rgba(0,0,0,0.2); flex:1; overflow:hidden; display:flex; flex-direction:column; margin:0;">
        <label>Active Users List (Online)</label>
        <div id="activeUsersList" style="flex:1; overflow-y: auto; font-size: 12px; margin-top:5px;"></div>
    </div>

    <button class="btn btn-danger" onclick="resetGame()"><i data-lucide="refresh-ccw"></i> RESET GAME</button>
</div>

<div class="main-section">
    <div id="winnerAnnounce" class="winner-marquee">
        <div class="marquee-text" id="winnerMarqueeText">MAY NANALO NA! CONGRATULATIONS SA ATING WINNER! üéâ</div>
    </div>

    <div class="tabs-nav">
        <button class="tab-btn active" onclick="openTab('bingo-tab', this)"><i data-lucide="layout-grid" width="16"></i> BINGO</button>
        <button class="tab-btn" onclick="openTab('settings-tab', this)"><i data-lucide="sliders" width="16"></i> SETTINGS</button>
        <button class="tab-btn" onclick="openTab('users-tab', this)"><i data-lucide="user-cog" width="16"></i> PLAYERS</button>
        <button class="tab-btn" onclick="openTab('cashout-tab', this)"><i data-lucide="wallet" width="16"></i> CASHOUTS</button>
        <button class="tab-btn" onclick="openTab('support-tab', this)"><i data-lucide="message-square" width="16"></i> SUPPORT</button>
    </div>

    <div id="settings-tab" class="tab-content">
        <div class="card">
            <h2><i data-lucide="image"></i> Custom Pop-up Banner Manager</h2>
            <div class="card-settings" style="background: rgba(59, 130, 246, 0.05); border-color: var(--accent);">
                <p style="font-size:11px; opacity:0.7; margin:0 0 10px 0;">This banner will pop up when users open the app. They can click it to visit a link.</p>
                
                <label>Banner Image URL (Required)</label>
                <input type="text" id="bannerImgInput" placeholder="e.g. https://imgur.com/example.png" style="margin-bottom:10px;">
                
                <label>Target Link (Where to go when clicked)</label>
                <input type="text" id="bannerLinkInput" placeholder="e.g. https://facebook.com/mypage" style="margin-bottom:10px;">
                
                <div style="display:flex; gap:10px; margin-top:10px; align-items:center;">
                    <button class="btn btn-primary" onclick="saveBannerSettings(true)" style="margin-top:0;"><i data-lucide="save"></i> SAVE & ACTIVATE</button>
                    <button class="btn btn-danger" onclick="saveBannerSettings(false)" style="margin-top:0; background:rgba(255,255,255,0.1); border:1px solid rgba(255,255,255,0.2); box-shadow:none;">DISABLE BANNER</button>
                </div>
            </div>
        </div>

        <div class="card">
            <h2><i data-lucide="shield"></i> Service Account (Push Notifications)</h2>
            <div class="card-settings" style="background:rgba(239, 68, 68, 0.1); border-color:var(--danger);">
                <p style="font-size:11px; color:#fca5a5; margin:0 0 10px 0;"><i data-lucide="alert-triangle" style="width:12px"></i> <b>IMPORTANT:</b> The Legacy API is disabled. Paste your Firebase Service Account JSON here to enable push notifications (HTTP v1).</p>
                <textarea id="serviceAccountJson" rows="5" placeholder='Paste contents of service-account.json here...' style="font-family:monospace; font-size:10px;"></textarea>
                <button class="btn btn-primary" onclick="saveServiceAccount()">SAVE CREDENTIALS</button>
            </div>
        </div>
        <div class="card">
            <h2><i data-lucide="joystick"></i> Mini Game Probabilities</h2>
            <div class="card-settings">
                <label>Global Win Rate (%) - ALL GAMES (Roulette, Slots, Color, Dice, Lucky9, etc.)</label>
                <div style="display:flex; gap:10px; align-items:center;">
                    <input type="range" min="10" max="90" value="40" id="winRateSlider" oninput="updateSettingsUI()">
                    <span id="winRateDisplay" style="font-weight:900; width:50px;">40%</span>
                </div>
                <p style="font-size:10px; opacity:0.6;">Sets the winning chance for ALL mini games.</p>
            </div>
            <div class="card-settings">
                <label>Scatter Chance (%) - Candy Smash</label>
                <div style="display:flex; gap:10px; align-items:center;">
                    <input type="range" min="1" max="20" value="3" id="scatterSlider" oninput="updateSettingsUI()">
                    <span id="scatterDisplay" style="font-weight:900; width:50px;">3%</span>
                </div>
                <p style="font-size:10px; opacity:0.6;">Percentage chance for a Scatter (Lollipop) to appear on grid.</p>
            </div>
            <button class="btn btn-primary" onclick="saveGameSettings()">SAVE SETTINGS</button>
        </div>
    </div>

    <div id="bingo-tab" class="tab-content active">
        <div style="display:grid; grid-template-columns: 1fr 2fr; gap: 24px; align-items:start;">
            <div class="card">
                <h2><i data-lucide="settings"></i> Game Control</h2>
                <div class="input-group">
                    <label>Winning Pattern</label>
                    <select id="patternSelect" onchange="setPattern(this.value)">
                        <option value="Normal Bingo">Normal Bingo</option>
                        <option value="Blackout">Blackout</option>
                        <option value="Letter X">Letter X</option>
                        <option value="Four Corners">Four Corners</option>
                    </select>
                </div>
                <div style="background: rgba(16, 185, 129, 0.05); border: 1px solid rgba(16, 185, 129, 0.3); padding: 15px; border-radius: 16px; margin-bottom: 20px;">
                    <label style="color:var(--success); margin-bottom:8px; display:flex; justify-content:space-between;">
                        <span>AUTO DRAW MACHINE</span>
                        <span id="speedVal" style="color:white;">8s</span>
                    </label>
                    <div style="display:flex; gap:10px; align-items:center; margin-bottom:15px;">
                        <input type="range" id="drawSpeed" min="3" max="15" value="8" style="flex:1; accent-color: var(--success);" oninput="document.getElementById('speedVal').innerText=this.value+'s'">
                    </div>
                    <button class="btn btn-primary" id="btnAutoDraw" onclick="toggleAutoDraw()" style="background: linear-gradient(135deg, #059669, #047857); box-shadow: 0 4px 15px rgba(5, 150, 105, 0.4);">
                        <i data-lucide="play"></i> START AUTO DRAW
                    </button>
                </div>
                <div class="input-group">
                    <label>Current Ball</label>
                    <div id="lastBall" style="font-size: 70px; font-weight: 900; text-align: center; color: white; background: linear-gradient(145deg, var(--accent), #1e40af); border-radius: 20px; padding: 15px; box-shadow: 0 10px 20px rgba(0,0,0,0.3); text-shadow: 0 2px 5px rgba(0,0,0,0.3); border:1px solid rgba(255,255,255,0.2);">--</div>
                </div>
                <div style="font-size:10px; font-weight:800; opacity:0.5; margin-top:20px; letter-spacing:1px;">MANUAL OVERRIDE:</div>
                <div class="ball-grid" id="ballGrid"></div>
            </div>
            <div class="card">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                    <h2><i data-lucide="users"></i> Live Cards Monitoring</h2>
                    <div style="font-size:11px; display:flex; gap:15px; font-weight:600;">
                        <span style="display:flex; align-items:center; gap:6px"><div style="width:10px; height:10px; background:var(--puro); border-radius:3px;"></div> PURO</span>
                        <span style="display:flex; align-items:center; gap:6px"><div style="width:10px; height:10px; background:var(--success); border-radius:3px;"></div> BINGO</span>
                        <span style="display:flex; align-items:center; gap:6px"><div style="width:10px; height:10px; background:#475569; border-radius:3px; border:1px solid #64748b;"></div> OFFLINE</span>
                    </div>
                </div>
                <div class="cards-grid" id="liveCardsContainer"></div>
            </div>
        </div>
    </div>
    
    <div id="users-tab" class="tab-content">
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap: 24px;">
            <div class="card">
                <h2><i data-lucide="coins"></i> Manage Points</h2>
                <div class="input-group"><label>Select User</label><div id="pointsUserList" class="user-select-list"></div><input type="hidden" id="selectedUserForPoints"></div>
                <div class="input-group"><label>Amount (+ or -)</label><input type="number" id="pointsAmount" placeholder="e.g. 500 or -500"></div>
                <button class="btn btn-primary" onclick="modifyUserPoints()">UPDATE POINTS & LOG</button>
            </div>
            <div class="card">
                <h2><i data-lucide="send"></i> Send Notification / Task</h2>
                <div class="input-group"><label>Recipient</label><select id="notifRecipient"><option value="all">ALL USERS (Include Push)</option><option value="selected">Selected User Only (From Left)</option></select></div>
                <div class="input-group"><label>Message / Announcement</label><textarea id="notifMessage" rows="5" placeholder="e.g. 5 Mins na lang BOLA NA!"></textarea></div>
                <button class="btn btn-bringme" onclick="sendAdminNotification()">SEND PUSH NOTIFICATION (HTTP v1)</button>
                <div id="sendStatus" style="font-size:10px; margin-top:5px; color:var(--text-muted);"></div>
            </div>
            
            <div class="card" style="grid-column: 1 / -1;">
                <h2><i data-lucide="history"></i> Points Transaction Logs <span id="historyUserName" style="color:var(--accent); margin-left:10px;">(Select a User)</span></h2>
                <div style="font-size:11px; opacity:0.6; margin-bottom:10px;">Shows: Admin Adjustments, Cashout Refunds, and Manually Logged Events. (Game bets/wins appear in "Live Activity Feed" on the right)</div>
                <div id="pointHistoryList" style="height: 250px; overflow-y: auto; background: rgba(0,0,0,0.2); padding: 15px; border-radius: 12px; border:1px solid var(--glass-border);">
                    <div style="opacity:0.5; text-align:center; padding:20px; font-size:12px;">Select a user to view their log history.</div>
                </div>
            </div>
        </div>
    </div>

    <div id="cashout-tab" class="tab-content"><div class="card"><h2><i data-lucide="wallet"></i> GCash Requests</h2><div id="cashoutList"></div></div></div>
    
    <div id="support-tab" class="tab-content">
        <div class="card">
            <h2><i data-lucide="message-square"></i> Support Messages</h2>
            <div style="font-size:11px; opacity:0.6; margin-bottom:15px;">User support requests and inquiries</div>
            <div id="supportMessagesList" style="display:flex; flex-direction:column; gap:15px;">
                <div style="opacity:0.5; text-align:center; padding:40px; font-size:12px;">Loading support messages...</div>
            </div>
        </div>
    </div>
</div>

<div class="activity-panel">
    <h2 style="font-size:13px; color:var(--text-muted); text-transform:uppercase; letter-spacing:1px;"><i data-lucide="activity" style="width:14px"></i> Live Activity Feed</h2>
    <p style="font-size:10px; opacity:0.5; margin-bottom:15px; border-bottom:1px solid rgba(255,255,255,0.1); padding-bottom:10px;">Monitors ALL user point changes in real-time (Games, Bets, Wins).</p>
    <div id="liveActivityFeed" style="flex:1; overflow-y:auto; display:flex; flex-direction:column; gap:5px;"></div>
</div>

<script>
    // --- LOCK SCREEN LOGIC ---
    const ADMIN_PIN = "12345"; // <--- CHANGE THIS TO YOUR DESIRED PIN
    
    function checkAdminLock() {
        const val = document.getElementById('adminPassInput').value;
        if(val === ADMIN_PIN) {
            document.getElementById('lockScreen').style.opacity = '0';
            setTimeout(() => { document.getElementById('lockScreen').style.display = 'none'; }, 500);
            sessionStorage.setItem('admin_unlocked', 'true');
        } else {
            alert("WRONG PIN! ACCESS DENIED.");
            document.getElementById('adminPassInput').value = "";
        }
    }
    // Check if already unlocked in this session
    if(sessionStorage.getItem('admin_unlocked') === 'true') {
        document.getElementById('lockScreen').style.display = 'none';
    }

    lucide.createIcons();
    const firebaseConfig = { apiKey: "AIzaSyDIAQXJ15atKJxu7PtcFL1W9JnO1N14pVs", authDomain: "radiobingo-9ac29.firebaseapp.com", databaseURL: "https://radiobingo-9ac29-default-rtdb.asia-southeast1.firebasedatabase.app", projectId: "radiobingo-9ac29", storageBucket: "radiobingo-9ac29.firebasestorage.app", messagingSenderId: "965903993397", appId: "1:965903993397:web:f6646fa05225f147eebf7c" };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    
    // --- SERVICE ACCOUNT LOGIC (REQUIRED FOR HTTP V1) ---
    let serviceAccount = null;
    const savedSA = localStorage.getItem('rb_service_account');
    if(savedSA) { try { serviceAccount = JSON.parse(savedSA); document.getElementById('serviceAccountJson').value = savedSA; } catch(e) {} }
    function saveServiceAccount() {
        const val = document.getElementById('serviceAccountJson').value.trim();
        try { const json = JSON.parse(val); if(!json.private_key || !json.client_email) throw new Error("Invalid JSON"); serviceAccount = json; localStorage.setItem('rb_service_account', val); alert("Service Account Saved! Push notifications enabled."); } catch(e) { alert("Error: Invalid Service Account JSON. Please copy the whole file."); }
    }
    // (JWT Generation using jsrsasign)
    function getAccessToken() {
        return new Promise((resolve, reject) => {
            if(!serviceAccount) return reject("No Service Account Loaded");
            const now = Math.floor(Date.now() / 1000);
            const claimSet = { iss: serviceAccount.client_email, scope: "https://www.googleapis.com/auth/firebase.messaging", aud: "https://oauth2.googleapis.com/token", exp: now + 3600, iat: now };
            const sJWT = KJUR.jws.JWS.sign("RS256", JSON.stringify({alg: "RS256", typ: "JWT"}), JSON.stringify(claimSet), serviceAccount.private_key);
            fetch("https://oauth2.googleapis.com/token", { method: "POST", headers: { "Content-Type": "application/x-www-form-urlencoded" }, body: `grant_type=urn:ietf:params:oauth:grant-type:jwt-bearer&assertion=${sJWT}` }).then(r => r.json()).then(data => { if(data.access_token) resolve(data.access_token); else reject(data.error_description || "Auth Failed"); }).catch(err => reject(err));
        });
    }

    let currentPattern = "Normal Bingo"; let drawnNumbers = []; let autoDrawInterval = null; let isAutoDrawing = false; let jackpotVisible = false; let schedules = {}; let globalStatusData = {}; let allUsersData = {}; let lastSpokenNumber = null;
    let userPointsCache = {}; // For detecting live changes
    
    function cleanName(name) { if(!name) return "Unknown"; let cleaned = name.replace(/[\u4E00-\u9FFF\u3400-\u4DBF\u2000-\u206F]/g, '').trim(); return cleaned || name; }
    function openTab(tabId, btn) { document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active')); document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active')); document.getElementById(tabId).classList.add('active'); btn.classList.add('active'); }
    for(let i=1; i<=75; i++) { let b = document.createElement('div'); b.className = 'ball'; b.id = 'ball-'+i; b.innerText = i; b.onclick = () => toggleBall(i); document.getElementById('ballGrid').appendChild(b); }
    
    function updateSettingsUI() { document.getElementById('winRateDisplay').innerText = document.getElementById('winRateSlider').value + "%"; document.getElementById('scatterDisplay').innerText = document.getElementById('scatterSlider').value + "%"; }
    function saveGameSettings() { const wr = parseInt(document.getElementById('winRateSlider').value); const sc = parseInt(document.getElementById('scatterSlider').value); db.ref('gameState/settings').update({ minigameWinRate: wr, scatterChance: sc }).then(() => { alert("Settings Updated! All clients will now use these probabilities."); }); }
    db.ref('gameState/settings').once('value', s => { const val = s.val(); if(val) { document.getElementById('winRateSlider').value = val.minigameWinRate || 40; document.getElementById('scatterSlider').value = val.scatterChance || 3; updateSettingsUI(); } });

    // --- BANNER SETTINGS LOGIC ---
    function saveBannerSettings(isActive) {
        const imgUrl = document.getElementById('bannerImgInput').value.trim();
        const linkUrl = document.getElementById('bannerLinkInput').value.trim();
        
        if(isActive && !imgUrl) return alert("Please enter an Image URL if activating the banner.");

        db.ref('gameState/bannerSettings').set({
            imageUrl: imgUrl,
            targetUrl: linkUrl,
            active: isActive,
            updatedAt: Date.now()
        }).then(() => {
            alert(isActive ? "Banner Activated and Saved!" : "Banner Disabled.");
        });
    }

    // Load Banner Settings
    db.ref('gameState/bannerSettings').once('value', s => {
        const d = s.val();
        if(d) {
            document.getElementById('bannerImgInput').value = d.imageUrl || "";
            document.getElementById('bannerLinkInput').value = d.targetUrl || "";
        }
    });

    // --- VIDEO & SCHEDULE ---
    function updateVideoFeed() {
        const url = document.getElementById('videoUrlInput').value;
        if(!url) return alert("Please enter a valid YouTube Link or ID.");
        db.ref('gameState/videoSettings').set({ type: 'youtube', url: url, updatedAt: Date.now() }).then(() => { alert("Video Stream Updated Successfully! LIVE NOW."); document.getElementById('videoUrlInput').value = ""; });
    }
    function setStreamOffline() {
        if(confirm("Are you sure you want to STOP the stream and show the 'Waiting' screen?")) {
            db.ref('gameState/videoSettings').set({ type: 'offline', url: '', updatedAt: Date.now() }).then(() => { alert("Stream set to OFFLINE."); document.getElementById('videoUrlInput').value = ""; });
        }
    }
    db.ref('gameState/schedules').on('value', s => { schedules = s.val() || {}; renderSchedules(); });
    function addSchedule() { const input = document.getElementById('schedInput'); if(!input.value) return; const time = new Date(input.value).getTime(); const key = db.ref('gameState/schedules').push().key; db.ref('gameState/schedules/' + key).set({ time: time, notified5min: false }); input.value = ""; }
    function removeSchedule(key) { db.ref('gameState/schedules/' + key).remove(); }
    function renderSchedules() {
        const list = document.getElementById('scheduleList'); list.innerHTML = "";
        const sorted = Object.entries(schedules).sort(([,a], [,b]) => { const timeA = typeof a === 'object' ? a.time : a; const timeB = typeof b === 'object' ? b.time : b; return timeA - timeB; });
        sorted.forEach(([key, val]) => { let timeVal = typeof val === 'object' ? val.time : val; const date = new Date(timeVal); const str = date.toLocaleDateString('en-PH', { month:'short', day:'numeric'}) + ' ' + date.toLocaleTimeString('en-PH', {hour:'2-digit', minute:'2-digit'}); list.innerHTML += `<div style="display:flex; justify-content:space-between; background:rgba(255,255,255,0.05); padding:8px; border-radius:8px; margin-bottom:5px; font-size:11px;"><span>${str}</span><button style="background:var(--danger); border:none; color:white; border-radius:4px; cursor:pointer;" onclick="removeSchedule('${key}')">X</button></div>`; });
    }
    setInterval(() => {
        const now = Date.now();
        Object.entries(schedules).forEach(([key, val]) => { 
            let time = val; let notified = false; if(typeof val === 'object') { time = val.time; notified = val.notified5min; }
            if(!notified && (time - now) <= 300000 && (time - now) > 0) { sendPushToAll("RB LIVE ALERT", "‚ö†Ô∏è 5 Minutes na lang! Magsisimula na ang Bingo draw!"); if(typeof val === 'object') { db.ref('gameState/schedules/' + key).update({ notified5min: true }); } }
            if(now >= time && now < time + 60000) { db.ref('gameState/latestWinner').once('value', w => { if(!w.exists() && !isAutoDrawing) { db.ref('gameState').update({ status: 'playing', gameStartTime: Date.now() }); startAutoDrawLogic(); } }); removeSchedule(key); } 
        });
    }, 5000);

    // --- GAME LOGIC ---
    db.ref('drawnNumbers').on('value', s => { drawnNumbers = s.val() ? Object.values(s.val()) : []; document.querySelectorAll('.ball').forEach(b => b.classList.remove('drawn')); drawnNumbers.forEach(n => document.getElementById('ball-'+n).classList.add('drawn')); updateMonitorCards(); });
    db.ref('gameState/lastCalled').on('value', s => { if(s.exists()) { const num = s.val(); document.getElementById('lastBall').innerText = num; if (num !== lastSpokenNumber) { speakNumber(num); lastSpokenNumber = num; } } else { document.getElementById('lastBall').innerText = "--"; lastSpokenNumber = null; } });
    db.ref('gameState/currentPattern').on('value', s => { currentPattern = s.val() || "Normal Bingo"; document.getElementById('patternSelect').value = currentPattern; updateMonitorCards(); });
    
    function toggleJackpot() { jackpotVisible = !jackpotVisible; const amount = document.getElementById('jackpotAmount').value; const knob = document.getElementById('jackpotKnob'); const bg = document.getElementById('jackpotKnobBg'); if(jackpotVisible) { knob.style.left = "23px"; bg.style.background = "var(--success)"; document.getElementById('jackpotStatusText').innerText = "VISIBLE"; db.ref('gameState/jackpot').set({ amount: amount, active: true }); } else { knob.style.left = "3px"; bg.style.background = "rgba(0,0,0,0.3)"; document.getElementById('jackpotStatusText').innerText = "HIDDEN"; db.ref('gameState/jackpot').set({ amount: amount, active: false }); } }
    db.ref('gameState/jackpot').once('value', s => { if(s.exists()){ const d = s.val(); document.getElementById('jackpotAmount').value = d.amount || ""; if(d.active) { jackpotVisible = true; document.getElementById('jackpotKnob').style.left = "23px"; document.getElementById('jackpotKnobBg').style.background = "var(--success)"; document.getElementById('jackpotStatusText').innerText = "VISIBLE"; } } });
    document.getElementById('jackpotAmount').addEventListener('input', (e) => { if(jackpotVisible) { db.ref('gameState/jackpot').update({ amount: e.target.value }); } });

    function toggleAutoDraw() { if(!isAutoDrawing) { db.ref('gameState/latestWinner').once('value', s => { if(s.exists()) { alert("May Winner Na! Reset Game muna bago mag start ulit."); return; } startAutoDrawLogic(); }); } else { stopAutoDrawLogic(); } }
    function startAutoDrawLogic() { if(isAutoDrawing) return; db.ref('gameState').update({ status: 'playing', gameStartTime: Date.now() }); const btn = document.getElementById('btnAutoDraw'); const speed = document.getElementById('drawSpeed').value * 1000; isAutoDrawing = true; btn.innerHTML = `<i data-lucide="pause"></i> STOP AUTO DRAW`; btn.style.background = "linear-gradient(135deg, #ef4444, #b91c1c)"; autoDrawLogic(); autoDrawInterval = setInterval(autoDrawLogic, speed); lucide.createIcons(); }
    function stopAutoDrawLogic() { const btn = document.getElementById('btnAutoDraw'); clearInterval(autoDrawInterval); isAutoDrawing = false; btn.innerHTML = `<i data-lucide="play"></i> START AUTO DRAW`; btn.style.background = "linear-gradient(135deg, #059669, #047857)"; lucide.createIcons(); }
    function autoDrawLogic() { if(drawnNumbers.length >= 75) { stopAutoDrawLogic(); return alert("Game Over! All numbers drawn."); } db.ref('gameState/latestWinner').once('value', s => { if(s.exists()) { stopAutoDrawLogic(); return; } let nextNum; do { nextNum = Math.floor(Math.random() * 75) + 1; } while (drawnNumbers.includes(nextNum)); toggleBall(nextNum); }); }
    function speakNumber(num) { if ('speechSynthesis' in window) { let letter = "B"; if (num > 15) letter = "I"; if (num > 30) letter = "N"; if (num > 45) letter = "G"; if (num > 60) letter = "O"; const msg = new SpeechSynthesisUtterance(`${letter} ${num}`); msg.rate = 0.9; window.speechSynthesis.speak(msg); } }
    function toggleBall(num) { const ref = db.ref('drawnNumbers/' + num); ref.once('value', s => { if(s.exists()) { ref.remove(); } else { ref.set(num); db.ref('gameState/lastCalled').set(num); db.ref('gameState/gameStartTime').once('value', ss => { if(!ss.exists()) db.ref('gameState/gameStartTime').set(Date.now()); }); } }); }

    // --- USERS & LIVE ACTIVITY SPY ---
    db.ref('status').on('value', s => { globalStatusData = s.val() || {}; document.getElementById('countOnline').innerText = Object.keys(globalStatusData).length; renderActiveUserList(); updateMonitorCards(); });
    function renderActiveUserList() { const list = document.getElementById('activeUsersList'); list.innerHTML = ""; Object.entries(globalStatusData).forEach(([uid, data]) => { let name = "Unknown"; if(allUsersData[uid] && allUsersData[uid].name) name = allUsersData[uid].name; else if(data.name) name = data.name; const safeName = cleanName(name); list.innerHTML += `<div style="padding:6px 0; border-bottom:1px solid rgba(255,255,255,0.05); display:flex; align-items:center; gap:8px;"><span class="online-dot"></span> ${safeName}</div>`; }); }
    
    // THE GLOBAL SPY MONITOR
    db.ref('users').on('value', s => { 
        allUsersData = s.val() || {}; 
        document.getElementById('countUsers').innerText = s.numChildren();
        
        // 1. Update UI List
        const list = document.getElementById('pointsUserList'); 
        const currentSelected = document.getElementById('selectedUserForPoints').value; 
        list.innerHTML = ""; 
        
        s.forEach(child => { 
            const u = child.val(); 
            const uid = child.key; 
            const safeName = cleanName(u.name); 
            const currentPts = u.points || 0;
            
            // 2. LIVE ACTIVITY DETECTION
            // If we have seen this user before, compare points
            if (userPointsCache.hasOwnProperty(uid)) {
                const oldPts = userPointsCache[uid];
                if (oldPts !== currentPts) {
                    const diff = currentPts - oldPts;
                    logLiveActivity(safeName, oldPts, currentPts, diff);
                }
            }
            // Update cache
            userPointsCache[uid] = currentPts;

            const isSel = currentSelected === uid ? 'selected' : ''; 
            const div = document.createElement('div'); 
            div.className = `user-option ${isSel}`; 
            div.onclick = () => selectUserForMgmt(uid, div, safeName); 
            div.innerHTML = `<span>${safeName}</span> <span>${currentPts} pts</span>`; 
            list.appendChild(div); 
        }); 
        
        renderActiveUserList(); 
        updateMonitorCards(); 
    });
    
    function logLiveActivity(name, oldVal, newVal, diff) {
        const feed = document.getElementById('liveActivityFeed');
        const item = document.createElement('div');
        item.className = 'live-log-item';
        const sign = diff > 0 ? '+' : '';
        const colorClass = diff > 0 ? 'log-pos' : 'log-neg';
        
        item.innerHTML = `
            <div style="display:flex; justify-content:space-between; margin-bottom:2px;">
                <span style="font-weight:700; color:white;">${name}</span>
                <span style="font-size:9px; opacity:0.6;">${new Date().toLocaleTimeString()}</span>
            </div>
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <span style="opacity:0.7;">${oldVal} ‚ûù ${newVal}</span>
                <span class="${colorClass}">${sign}${diff}</span>
            </div>
        `;
        feed.prepend(item);
        // Keep list clean (max 50)
        if(feed.children.length > 50) feed.removeChild(feed.lastChild);
    }

    function selectUserForMgmt(uid, el, name) { 
        document.querySelectorAll('.user-option').forEach(e => e.classList.remove('selected')); 
        el.classList.add('selected'); 
        document.getElementById('selectedUserForPoints').value = uid; 
        document.getElementById('historyUserName').innerText = name;
        renderUserHistory(uid);
    }
    
    function renderUserHistory(uid) {
        const list = document.getElementById('pointHistoryList');
        list.innerHTML = "<div style='text-align:center; padding:10px;'>Loading...</div>";
        
        db.ref('pointLogs/' + uid).orderByChild('timestamp').limitToLast(50).once('value', s => {
            if(!s.exists()) {
                list.innerHTML = "<div style='opacity:0.5; text-align:center; padding:20px; font-size:12px;'>No permanent logs found.<br>(Only Admin Adjustments & Cashouts are logged permanently)</div>";
                return;
            }
            list.innerHTML = "";
            let items = [];
            s.forEach(c => items.push(c.val()));
            items.reverse(); 
            
            items.forEach(log => {
                const date = new Date(log.timestamp).toLocaleString();
                const isAdd = log.amount >= 0;
                const color = isAdd ? 'var(--success)' : 'var(--danger)';
                const sign = isAdd ? '+' : '';
                
                list.innerHTML += `
                    <div style="display:flex; justify-content:space-between; align-items:center; background:rgba(255,255,255,0.05); padding:10px; border-radius:8px; margin-bottom:5px; font-size:12px;">
                        <div>
                            <div style="font-weight:700;">${log.reason || "Point Adjustment"}</div>
                            <div style="font-size:10px; opacity:0.6;">${date}</div>
                        </div>
                        <div style="color:${color}; font-weight:900;">${sign}${log.amount}</div>
                    </div>
                `;
            });
        });
    }

    function updateMonitorCards() {
        const container = document.getElementById('liveCardsContainer'); container.innerHTML = ""; let usersArray = [];
        Object.entries(allUsersData).forEach(([key, user]) => { if(user.card || user.currentCard) { usersArray.push({ ...user, uid: key }); } });
        usersArray.sort((a, b) => { const aOnline = globalStatusData[a.uid] ? 1 : 0; const bOnline = globalStatusData[b.uid] ? 1 : 0; return bOnline - aOnline; });
        usersArray.forEach(user => {
            const card = user.currentCard || user.card; const check = checkCardStatus(card, currentPattern, drawnNumbers); const isOnline = globalStatusData[user.uid] ? true : false; const safeName = cleanName(user.name);
            let isBingo = check.isBingo; let isPuro = check.isPuro; if(!isOnline) { isBingo = false; isPuro = false; } else { if(user.hasWonCurrent && drawnNumbers.length > 0) isBingo = true; if(isBingo) isPuro = false; }
            const cardDiv = document.createElement('div'); cardDiv.className = `user-card-monitor ${!isOnline ? 'offline' : ''} ${isBingo ? 'bingo' : ''} ${isPuro ? 'puro' : ''}`;
            let gridHtml = '<div class="mini-bingo-grid">'; card.forEach((n, idx) => { const marked = drawnNumbers.includes(n) || n === "FREE"; const isWinningCell = check.winningCells.includes(idx); const visualHit = isOnline && isWinningCell; gridHtml += `<div class="mini-cell ${marked ? 'marked' : ''} ${visualHit ? 'hit' : ''}">${n === "FREE" ? '‚òÖ' : n}</div>`; }); gridHtml += '</div>';
            cardDiv.innerHTML = `<div class="monitor-badge">${isBingo ? "BINGO!" : "PURO!"}</div><div style="font-size:12px; font-weight:800; display:flex; justify-content:space-between; color:white; align-items:center;"><span style="display:flex; align-items:center; gap:5px;"><span class="${isOnline ? 'online-dot' : 'offline-dot'}"></span>${safeName}</span><span style="font-size:9px; background:rgba(255,255,255,0.1); padding:2px 6px; border-radius:4px;">${user.points || 0} pts</span></div>${gridHtml}`;
            if(isBingo && isOnline) container.prepend(cardDiv); else if(isPuro && isOnline) container.insertBefore(cardDiv, container.children[1] || null); else container.appendChild(cardDiv);
        });
    }

    function checkCardStatus(card, pattern, drawn) {
        let markedIndices = [12]; card.forEach((val, idx) => { if(drawn.includes(val) && idx !== 12) markedIndices.push(idx); });
        let patterns = [];
        if (pattern === "Blackout") { patterns = [[...Array(25).keys()]]; }
        else if (pattern === "Letter X") { patterns = [[0,4,6,8,12,16,18,20,24]]; }
        else if (pattern === "Four Corners") { patterns = [[0,4,20,24]]; }
        else { patterns = [[0,1,2,3,4],[5,6,7,8,9],[10,11,12,13,14],[15,16,17,18,19],[20,21,22,23,24],[0,5,10,15,20],[1,6,11,16,21],[2,7,12,17,22],[3,8,13,18,23],[4,9,14,19,24],[0,6,12,18,24],[4,8,12,16,20]]; }
        let isBingo = false; let isPuro = false; let winningCells = [];
        for (let p of patterns) { const hits = p.filter(idx => markedIndices.includes(idx)); const needed = p.length; const got = hits.length; if (got === needed) { isBingo = true; winningCells = p; break; } else if (needed - got === 1) { isPuro = true; } }
        return { isBingo, isPuro, winningCells };
    }

    db.ref('gameState/latestWinner').on('value', s => {
        const marquee = document.getElementById('winnerAnnounce');
        if(s.exists()) {
            const winData = s.val(); const safeWinnerName = cleanName(winData.name);
            let msg = `üéâ BINGO WINNER: ${safeWinnerName.toUpperCase()}!`; if(winData.prize) msg += ` WON ‚Ç±${winData.prize.toLocaleString()} POINTS! üí∞`; else msg += ` CONGRATULATIONS! üéâ`;
            marquee.style.display = 'block'; document.getElementById('winnerMarqueeText').innerText = msg;
            if(isAutoDrawing) { stopAutoDrawLogic(); alert("AUTO STOP: We have a winner!"); }
        } else { marquee.style.display = 'none'; updateMonitorCards(); } 
    });

    // --- ADMIN POINTS WITH LOGGING ---
    function modifyUserPoints() { 
        const uid = document.getElementById('selectedUserForPoints').value; 
        const amount = document.getElementById('pointsAmount').value; 
        if(!uid) return alert("Select a user first!"); 
        if(!amount) return alert("Enter amount"); 
        
        const amountInt = parseInt(amount);
        
        db.ref(`users/${uid}/points`).transaction(current => (current || 0) + amountInt, (error, committed, snapshot) => {
            if (committed) {
                // Log the transaction
                db.ref(`pointLogs/${uid}`).push({
                    amount: amountInt,
                    reason: "Admin Adjustment",
                    timestamp: firebase.database.ServerValue.TIMESTAMP,
                    by: "Admin"
                });
                alert("Points updated and logged!"); 
                document.getElementById('pointsAmount').value = "";
                renderUserHistory(uid); 
            }
        }); 
    }

    async function sendPushNotification(token, title, body) {
        if(!serviceAccount) { console.error("NO SERVICE ACCOUNT"); return false; }
        try {
            const accessToken = await getAccessToken();
            const projectId = serviceAccount.project_id;
            const response = await fetch(`https://fcm.googleapis.com/v1/projects/${projectId}/messages:send`, { 
                method: 'POST', 
                headers: { 
                    'Authorization': `Bearer ${accessToken}`, 
                    'Content-Type': 'application/json' 
                }, 
                body: JSON.stringify({ 
                    message: { 
                        token: token, 
                        notification: { 
                            title: title, 
                            body: body 
                        }, 
                        webpush: { 
                            notification: { 
                                icon: 'https://i.imgur.com/7D8u8h6.png'
                            },
                            fcm_options: {
                                link: window.location.origin
                            }
                        },
                        data: {
                            url: window.location.origin
                        }
                    } 
                }) 
            });
            if(!response.ok) { const err = await response.json(); console.error("FCM Error:", err); return false; } return true;
        } catch(e) { console.error("Push Token Gen Error:", e); return false; }
    }
    
    async function sendPushToAll(title, body) { const statusEl = document.getElementById('sendStatus'); statusEl.innerText = "Sending..."; db.ref('users').once('value', async s => { const promises = []; s.forEach(u => { const user = u.val(); if(user.fcmToken) { promises.push(sendPushNotification(user.fcmToken, title, body)); } }); await Promise.all(promises); statusEl.innerText = `Sent push to devices (if available).`; }); }
    
    function sendAdminNotification() { 
        if(!serviceAccount) return alert("WARNING: Please paste your Service Account JSON in the Settings tab first!"); 
        const type = document.getElementById('notifRecipient').value; 
        const msg = document.getElementById('notifMessage').value; 
        const title = "RB LIVE ALERT"; 
        if(!msg) return alert("Enter message"); 
        
        if(type === 'selected') { 
            const uid = document.getElementById('selectedUserForPoints').value; 
            if(!uid) return alert("Select a user first!"); 
            db.ref(`notifications/${uid}`).push({ msg: msg, time: Date.now(), type: 'admin', read: false }); 
            db.ref(`users/${uid}/fcmToken`).once('value', t => { if(t.exists()) { sendPushNotification(t.val(), title, msg).then(() => alert("Sent!")); } else { alert("User has no push token (App not installed or perm denied). Sent to inbox only."); } }); 
        } else { 
            if(confirm("Send to ALL users (Push + In-App)?")) { 
                db.ref('users').once('value', s => { s.forEach(u => { db.ref(`notifications/${u.key}`).push({ msg: msg, time: Date.now(), type: 'admin', read: false }); }); }); 
                sendPushToAll(title, msg); 
                alert("Broadcast sent! (DB + Push)"); 
            } 
        } 
        document.getElementById('notifMessage').value = ""; 
    }

    function setPattern(p) { db.ref('gameState/currentPattern').set(p); }
    function resetGame() {
        if(confirm("WARNING: Reset entire board?")){
            db.ref('drawnNumbers').remove(); db.ref('gameState/latestWinner').remove(); db.ref('gameState/gameStartTime').remove(); db.ref('gameState/lastCalled').remove();
            db.ref('gameState').update({ status: 'waiting' });
            db.ref('users').once('value', s => { let updates = {}; s.forEach(u => { updates[u.key + '/hasWonCurrent'] = false; }); db.ref('users').update(updates); });
            stopAutoDrawLogic(); setTimeout(updateMonitorCards, 500); document.getElementById('lastBall').innerText = "--"; lastSpokenNumber = null;
        }
    }

    db.ref('redemptions').on('value', s => {
        const list = document.getElementById('cashoutList'); list.innerHTML = "";
        s.forEach(child => {
            const r = child.val(); const key = child.key; if(r.status !== 'pending') return;
            const safeName = cleanName(r.name);
            const div = document.createElement('div'); div.className = 'card'; div.style.padding = "15px"; div.style.marginBottom = "10px";
            div.innerHTML = `<div style="display:flex; justify-content:space-between; align-items:center;"><div><div style="font-weight:800;">${safeName} - <span style="color:var(--gold)">${r.item}</span></div><div style="font-size:11px; opacity:0.6;">GCash: ${r.gcash}</div></div><div style="display:flex; gap:10px;"><button class=\"btn btn-primary\" style=\"width:auto; padding:8px 20px\" onclick=\"updateStatus('${key}', 'sent', ${JSON.stringify(r).replace(/"/g, '&quot;')})\">PAID</button><button class=\"btn btn-danger\" style=\"width:auto; padding:8px 20px\" onclick=\"updateStatus('${key}', 'denied', ${JSON.stringify(r).replace(/"/g, '&quot;')})\">X</button></div></div>`;
            list.prepend(div);
        });
    });

    function updateStatus(key, status, data) {
        if(confirm(`${status} this?`)) {
            db.ref('redemptions/' + key).update({ status: status });
            const statusMsg = status === 'sent' ? `Ang iyong ${data.item} ay na-ipadala na! ÓÅûÈ†Ç` : `Ang iyong ${data.item} ay na-deny. Á¨∂ÂΩ¢`;
            db.ref('notifications/' + data.uid).push({ msg: statusMsg, time: Date.now() });
            
            // Refund points if denied
            if(status === 'denied') {
                db.ref('users/' + data.uid + '/points').transaction(p => (p || 0) + data.cost, (err, committed) => {
                     if(committed) {
                         db.ref(`pointLogs/${data.uid}`).push({
                             amount: data.cost,
                             reason: `Refund: ${data.item}`,
                             timestamp: firebase.database.ServerValue.TIMESTAMP,
                             by: "System/Admin"
                         });
                         if(document.getElementById('selectedUserForPoints').value === data.uid) {
                             renderUserHistory(data.uid);
                         }
                     }
                 });
            }
        }
    }

    // === UTILITY: HTML ESCAPING ===
    function escapeHtml(text) {
        if (!text) return '';
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    // === SUPPORT MESSAGES ===
    db.ref('supportMessages').on('value', s => {
        const list = document.getElementById('supportMessagesList');
        list.innerHTML = "";
        
        if(!s.exists()) {
            list.innerHTML = '<div style="opacity:0.5; text-align:center; padding:40px; font-size:12px;">No support messages yet.</div>';
            return;
        }
        
        const messages = [];
        s.forEach(child => {
            messages.push({ key: child.key, ...child.val() });
        });
        
        // Sort by timestamp, newest first
        messages.sort((a, b) => b.timestamp - a.timestamp);
        
        messages.forEach(msg => {
            const statusColor = msg.status === 'open' ? 'var(--gold)' : 'var(--success)';
            const statusText = msg.status === 'open' ? 'OPEN' : 'RESOLVED';
            const date = new Date(msg.timestamp).toLocaleString();
            
            const div = document.createElement('div');
            div.className = 'card';
            div.style.padding = "15px";
            div.style.marginBottom = "10px";
            div.style.background = msg.status === 'open' ? 'rgba(251, 191, 36, 0.05)' : 'rgba(0,0,0,0.2)';
            div.style.borderLeft = `3px solid ${statusColor}`;
            
            div.innerHTML = `
                <div style="display:flex; justify-content:space-between; align-items:flex-start; margin-bottom:10px;">
                    <div style="display:flex; gap:10px; align-items:center;">
                        <img src="${msg.userPhoto || 'https://via.placeholder.com/40'}" style="width:40px; height:40px; border-radius:50%; object-fit:cover;">
                        <div>
                            <div style="font-weight:800; font-size:13px;">${escapeHtml(msg.userName)}</div>
                            <div style="font-size:10px; opacity:0.6;">${date}</div>
                        </div>
                    </div>
                    <div style="font-size:10px; font-weight:800; color:${statusColor}; text-transform:uppercase; border:1px solid ${statusColor}; padding:4px 8px; border-radius:6px;">
                        ${statusText}
                    </div>
                </div>
                <div style="margin-bottom:8px;">
                    <div style="font-weight:700; font-size:12px; color:var(--accent-glow); margin-bottom:5px;">Subject: ${escapeHtml(msg.subject)}</div>
                    <div style="font-size:12px; line-height:1.5; color:#cbd5e1;">${escapeHtml(msg.message)}</div>
                </div>
                <div style="font-size:10px; opacity:0.6; margin-top:8px; padding-top:8px; border-top:1px solid rgba(255,255,255,0.05);">
                    Contact: ${escapeHtml(msg.userEmail)}
                </div>
                <div style="display:flex; gap:10px; margin-top:10px;">
                    <button class="btn btn-primary reply-support-btn" 
                        style="width:auto; padding:8px 20px; font-size:11px; background:var(--accent); border-color:var(--accent);"
                        data-msg-key="${msg.key}" 
                        data-uid="${msg.uid}" 
                        data-username="${escapeHtml(msg.userName)}">
                        <i data-lucide="reply" width="14"></i> REPLY
                    </button>
                    ${msg.status === 'open' ? `
                        <button class="btn btn-primary resolve-support-btn" 
                            style="width:auto; padding:8px 20px; font-size:11px;"
                            data-msg-key="${msg.key}" 
                            data-uid="${msg.uid}">MARK RESOLVED</button>
                    ` : ''}
                    <button class="btn btn-danger delete-support-btn" 
                        style="width:auto; padding:8px 20px; font-size:11px;"
                        data-msg-key="${msg.key}">DELETE</button>
                </div>
            `;
            
            list.appendChild(div);
            
            // Add event listeners using data attributes
            const replyBtn = div.querySelector('.reply-support-btn');
            if (replyBtn) {
                replyBtn.addEventListener('click', function() {
                    replySupportMessage(
                        this.dataset.msgKey, 
                        this.dataset.uid, 
                        this.dataset.username
                    );
                });
            }
            
            const resolveBtn = div.querySelector('.resolve-support-btn');
            if (resolveBtn) {
                resolveBtn.addEventListener('click', function() {
                    resolveSupportMessage(this.dataset.msgKey, this.dataset.uid);
                });
            }
            
            const deleteBtn = div.querySelector('.delete-support-btn');
            if (deleteBtn) {
                deleteBtn.addEventListener('click', function() {
                    deleteSupportMessage(this.dataset.msgKey);
                });
            }
        });
        
        lucide.createIcons();
    });

    function resolveSupportMessage(key, uid) {
        if(confirm('Mark this message as resolved?')) {
            db.ref('supportMessages/' + key).update({ status: 'resolved' });
            
            // Send notification to user
            db.ref('notifications/' + uid).push({
                msg: 'Your support request has been resolved. Thank you!',
                time: Date.now(),
                type: 'support'
            });
        }
    }

    function deleteSupportMessage(key) {
        if(confirm('Delete this support message?')) {
            db.ref('supportMessages/' + key).remove();
        }
    }

    function replySupportMessage(key, uid, userName) {
        const reply = prompt(`Reply to ${userName}:`);
        if (!reply || reply.trim() === '') {
            return;
        }
        
        // Sanitize the reply to prevent any injection issues
        const sanitizedReply = reply.trim().substring(0, 500); // Limit length
        
        // Send notification to user
        db.ref('notifications/' + uid).push({
            msg: `Admin replied to your support request: "${sanitizedReply}"`,
            time: Date.now(),
            type: 'support_reply'
        }).then(() => {
            alert('Reply sent successfully!');
        }).catch(err => {
            console.error('Error sending reply:', err);
            alert('Failed to send reply');
        });
    }
</script>
</body>
</html>
