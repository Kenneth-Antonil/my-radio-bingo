<!DOCTYPE html>
<html lang="tl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Radio Bingo | Admin Master</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <style>
        :root { 
            --bg: #030712; 
            --surface: #111827; 
            --surface-br: #1f2937; 
            --accent: #3b82f6; 
            --text: #f8fafc; 
            --success: #10b981; 
            --danger: #ef4444; 
            --gold: #fbbf24; 
            --glass: rgba(255, 255, 255, 0.03);
        }
        * { box-sizing: border-box; }
        body { 
            font-family: 'Inter', sans-serif; 
            background: var(--bg); 
            color: var(--text); 
            margin: 0; 
            padding: 20px;
            line-height: 1.5;
        }

        .admin-grid {
            display: grid;
            grid-template-columns: 350px 1fr;
            gap: 25px;
            max-width: 1400px;
            margin: 0 auto;
        }

        .card {
            background: var(--surface);
            border: 1px solid var(--surface-br);
            border-radius: 24px;
            padding: 25px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.3);
        }

        .section-title {
            font-size: 14px;
            font-weight: 900;
            color: var(--accent);
            text-transform: uppercase;
            letter-spacing: 1.5px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .ball-display {
            background: linear-gradient(135deg, var(--accent), #1d4ed8);
            height: 180px;
            border-radius: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            margin-bottom: 25px;
            border: 4px solid rgba(255,255,255,0.1);
            position: relative;
            overflow: hidden;
        }

        .ball-display::after {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
        }

        #currentBall {
            font-size: 84px;
            font-weight: 900;
            line-height: 1;
            text-shadow: 0 4px 10px rgba(0,0,0,0.3);
            z-index: 1;
        }

        .control-group {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .btn {
            border: none;
            padding: 14px 20px;
            border-radius: 14px;
            font-weight: 800;
            font-size: 14px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            transition: all 0.2s;
            text-transform: uppercase;
        }

        .btn-primary { background: var(--accent); color: white; }
        .btn-success { background: var(--success); color: white; }
        .btn-danger { background: var(--danger); color: white; }
        .btn-gold { background: var(--gold); color: #000; }
        .btn:hover { transform: translateY(-2px); opacity: 0.9; }
        .btn:active { transform: scale(0.98); }

        .form-input {
            background: var(--bg);
            border: 1px solid var(--surface-br);
            padding: 12px 15px;
            border-radius: 12px;
            color: white;
            font-weight: 600;
            width: 100%;
            margin-bottom: 10px;
        }

        .drawn-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(45px, 1fr));
            gap: 10px;
            margin-top: 20px;
        }

        .ball-drawn {
            aspect-ratio: 1;
            background: var(--surface-br);
            border: 1px solid rgba(255,255,255,0.05);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 800;
            font-size: 14px;
            color: #94a3b8;
        }

        .ball-drawn.active {
            background: var(--accent);
            color: white;
            border-color: rgba(255,255,255,0.2);
            box-shadow: 0 4px 10px rgba(59, 130, 246, 0.3);
        }

        .user-list, .redeem-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .item-row {
            background: var(--glass);
            padding: 15px;
            border-radius: 16px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border: 1px solid rgba(255,255,255,0.03);
        }

        .badge {
            padding: 4px 10px;
            border-radius: 6px;
            font-size: 10px;
            font-weight: 900;
            text-transform: uppercase;
        }

        .header {
            max-width: 1400px;
            margin: 0 auto 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .admin-logo {
            font-size: 24px;
            font-weight: 900;
            letter-spacing: -1px;
        }

        .admin-logo span { color: var(--accent); }
    </style>
</head>
<body>

    <div class="header">
        <div class="admin-logo">RADIO<span>BINGO</span> MASTER</div>
        <div style="display:flex; gap:10px;">
            <button class="btn btn-primary" onclick="updateExistingUsers()" style="padding: 8px 15px; font-size: 11px;">Gen Ref Codes</button>
            <button class="btn btn-danger" onclick="resetGame()" style="padding: 8px 15px; font-size: 11px;">Emergency Reset</button>
        </div>
    </div>

    <div class="admin-grid">
        <div class="control-panel">
            <div class="card" style="margin-bottom: 25px;">
                <div class="section-title"><i data-lucide="play-circle"></i> Game Control</div>
                <div class="ball-display">
                    <span style="font-size: 10px; font-weight: 800; opacity: 0.8; margin-bottom: 5px;">CURRENT BALL</span>
                    <div id="currentBall">--</div>
                </div>
                <div class="control-group">
                    <button class="btn btn-primary" onclick="drawNumber()">
                        <i data-lucide="dices"></i> DRAW NEXT BALL
                    </button>
                    <button class="btn btn-danger" onclick="clearDrawn()">
                        <i data-lucide="refresh-cw"></i> CLEAR BOARD
                    </button>
                </div>
            </div>

            <div class="card">
                <div class="section-title"><i data-lucide="settings"></i> Game Settings</div>
                <label style="font-size: 11px; font-weight: 800; opacity: 0.6; margin-bottom: 5px; display: block;">BINGO PATTERN</label>
                <select id="patternSelect" class="form-input" onchange="updatePattern()">
                    <option value="Normal Bingo">Normal Bingo</option>
                    <option value="Blackout">Blackout</option>
                    <option value="Letter X">Letter X</option>
                    <option value="Four Corners">Four Corners</option>
                </select>

                <label style="font-size: 11px; font-weight: 800; opacity: 0.6; margin: 15px 0 5px; display: block;">NEXT DRAW SCHEDULE</label>
                <input type="text" id="drawSchedule" class="form-input" placeholder="e.g. 8:30 PM">
                <button class="btn btn-success" style="width: 100%; margin-top: 5px;" onclick="updateSchedule()">
                    UPDATE SCHEDULE
                </button>
            </div>
        </div>

        <div class="main-panel">
            <div class="card" style="margin-bottom: 25px;">
                <div class="section-title"><i data-lucide="grid"></i> Bingo Board</div>
                <div class="drawn-grid" id="masterGrid"></div>
            </div>

            <div style="display:grid; grid-template-columns: 1fr 1.2fr; gap: 25px;">
                <div class="card">
                    <div class="section-title"><i data-lucide="users"></i> Active Players</div>
                    <div class="user-list" id="userList"></div>
                </div>
                <div class="card">
                    <div class="section-title"><i data-lucide="wallet"></i> Pending Cashouts</div>
                    <div class="redeem-list" id="redeemList"></div>
                </div>
            </div>
        </div>
    </div>

<script>
    lucide.createIcons();
    const firebaseConfig = { apiKey: "AIzaSyDIAQXJ15atKJxu7PtcFL1W9JnO1N14pVs", authDomain: "radiobingo-9ac29.firebaseapp.com", databaseURL: "https://radiobingo-9ac29-default-rtdb.asia-southeast1.firebasedatabase.app", projectId: "radiobingo-9ac29", storageBucket: "radiobingo-9ac29.firebasestorage.app", messagingSenderId: "965903993397", appId: "1:965903993397:web:f6646fa05225f147eebf7c" };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    let drawn = [];

    function init() {
        db.ref('drawnNumbers').on('value', s => {
            const val = s.val();
            drawn = val ? Object.values(val) : [];
            document.getElementById('currentBall').innerText = drawn.length ? drawn[drawn.length-1] : "--";
            renderMasterGrid();
        });

        db.ref('users').limitToLast(10).on('value', s => {
            const list = document.getElementById('userList');
            list.innerHTML = "";
            s.forEach(child => {
                const u = child.val();
                const div = document.createElement('div');
                div.className = 'item-row';
                div.innerHTML = `
                    <div style="display:flex; align-items:center; gap:12px;">
                        <img src="${u.photo}" style="width:32px; height:32px; border-radius:8px;">
                        <div>
                            <div style="font-size:13px; font-weight:700;">${u.name}</div>
                            <div style="font-size:10px; opacity:0.5;">ID: ${child.key.substring(0,6)}</div>
                        </div>
                    </div>
                    <div class="badge" style="background:rgba(59,130,246,0.1); color:var(--accent);">â‚±${u.points}</div>`;
                list.prepend(div);
            });
        });

        db.ref('redemptions').orderByChild('status').equalTo('pending').on('value', s => {
            const list = document.getElementById('redeemList');
            list.innerHTML = "";
            s.forEach(child => {
                const r = child.val();
                const key = child.key;
                const div = document.createElement('div');
                div.className = 'item-row';
                div.innerHTML = `
                    <div style="max-width:60%;">
                        <div style="font-size:13px; font-weight:700;">${r.name}</div>
                        <div style="font-size:11px; color:var(--gold); font-weight:700;">${r.gcash}</div>
                        <div style="font-size:10px; opacity:0.5;">${r.item}</div>
                    </div>
                    <div style="display:flex; gap:8px;">
                        <button class="btn btn-success" style="padding:8px 12px; font-size:10px;" onclick="updateStatus('${key}', 'sent', ${JSON.stringify(r).replace(/"/g, '&quot;')})">DONE</button>
                        <button class="btn btn-danger" style="padding:8px 12px; font-size:10px;" onclick="updateStatus('${key}', 'denied', ${JSON.stringify(r).replace(/"/g, '&quot;')})">DENY</button>
                    </div>`;
                list.append(div);
            });
        });
    }

    function renderMasterGrid() {
        const grid = document.getElementById('masterGrid');
        grid.innerHTML = "";
        for(let i=1; i<=75; i++) {
            const div = document.createElement('div');
            div.className = `ball-drawn ${drawn.includes(i) ? 'active' : ''}`;
            div.innerText = i;
            grid.appendChild(div);
        }
    }

    function drawNumber() {
        let n;
        do { n = Math.floor(Math.random() * 75) + 1; } while(drawn.includes(n) && drawn.length < 75);
        if(drawn.length >= 75) return alert("All numbers drawn!");
        
        // SYNC LOGIC
        if(drawn.length === 0) db.ref('gameState/gameStartTime').set(Date.now());
        db.ref('drawnNumbers').push(n);
    }

    function clearDrawn() {
        if(confirm("Clear all?")) {
            db.ref('drawnNumbers').remove();
            db.ref('gameState/latestWinner').remove();
            db.ref('gameState/gameStartTime').set(0);
            db.ref('users').once('value', snapshot => {
                let updates = {};
                snapshot.forEach(child => { updates[child.key + '/hasWonCurrent'] = false; });
                db.ref('users').update(updates);
            });
        }
    }

    function resetGame() {
        if(confirm("FULL RESET?")) {
            db.ref().update({ 'drawnNumbers': null, 'gameState/latestWinner': null, 'gameState/gameStartTime': 0 });
            location.reload();
        }
    }

    function updatePattern() {
        const p = document.getElementById('patternSelect').value;
        db.ref('gameState/currentPattern').set(p);
    }

    function updateSchedule() {
        const s = document.getElementById('drawSchedule').value;
        db.ref('gameState/nextDraw').set(s);
        alert("Updated!");
    }

    function updateStatus(key, status, data) {
        if(confirm(`${status}?`)) {
            db.ref('redemptions/' + key).update({ status: status });
            const statusMsg = status === 'sent' ? `Your ${data.item} paid! ðŸ’¸` : `Your ${data.item} denied. âŒ`;
            db.ref('notifications/' + data.uid).push({ msg: statusMsg, time: Date.now() });
            if(status === 'denied') db.ref('users/' + data.uid + '/points').transaction(p => (p || 0) + data.cost);
        }
    }

    async function updateExistingUsers() {
        const snapshot = await db.ref('users').once('value');
        let updates = {};
        snapshot.forEach(child => {
            if (!child.val().refCode) updates[`${child.key}/refCode`] = Math.random().toString(36).substring(2, 8).toUpperCase();
        });
        db.ref('users').update(updates);
        alert("Done!");
    }

    init();
</script>
</body>
</html>
