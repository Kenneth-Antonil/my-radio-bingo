<!DOCTYPE html>
<html lang="tl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Radio Bingo | Admin Master Pro 3D</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jsrsasign/10.5.1/jsrsasign-all-min.js"></script>
    <style>
        :root { --bg-dark: #0f172a; --bg-gradient: linear-gradient(135deg, #0f172a 0%, #1e1b4b 100%); --glass-surface: rgba(30, 41, 59, 0.85); --glass-border: rgba(255, 255, 255, 0.08); --glass-highlight: rgba(255, 255, 255, 0.1); --accent: #3b82f6; --accent-glow: rgba(59, 130, 246, 0.5); --text: #f8fafc; --text-muted: #94a3b8; --success: #10b981; --danger: #ef4444; --gold: #f59e0b; --gold-glow: rgba(245, 158, 11, 0.5); --puro: #f97316; --bringme: #8b5cf6; --radius-lg: 20px; --radius-md: 12px; --shadow-card: 0 10px 30px -10px rgba(0,0,0,0.5); }
        * { box-sizing: border-box; }
        body { font-family: 'Inter', sans-serif; background: var(--bg-gradient); background-attachment: fixed; color: var(--text); margin: 0; padding: 20px; display: grid; grid-template-columns: 300px 1fr 280px; gap: 20px; height: 100vh; overflow: hidden; }
        ::-webkit-scrollbar { width: 6px; } ::-webkit-scrollbar-track { background: rgba(0,0,0,0.1); } ::-webkit-scrollbar-thumb { background: var(--glass-border); border-radius: 10px; }
        .card, .sidebar, .tabs-nav, .activity-panel { background: var(--glass-surface); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px); border: 1px solid var(--glass-border); box-shadow: var(--shadow-card); }
        .sidebar { border-radius: var(--radius-lg); padding: 20px; overflow-y: auto; display: flex; flex-direction: column; gap: 15px; height: calc(100vh - 40px); }
        .activity-panel { border-radius: var(--radius-lg); padding: 20px; overflow-y: hidden; display: flex; flex-direction: column; height: calc(100vh - 40px); }
        .logo-text { font-size: 24px; font-weight: 900; letter-spacing: -1px; text-transform: uppercase; background: linear-gradient(to right, #fff, #94a3b8); -webkit-background-clip: text; -webkit-text-fill-color: transparent; margin-bottom: 10px; text-shadow: 0 2px 10px rgba(255,255,255,0.1); }
        .stat-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
        .stat-card { background: rgba(0,0,0,0.2); padding: 10px; border-radius: var(--radius-md); text-align: center; border: 1px solid var(--glass-border); position: relative; overflow: hidden; }
        .stat-card::before { content: ''; position: absolute; top:0; left:0; width:100%; height:2px; background: linear-gradient(90deg, transparent, var(--accent), transparent); }
        .stat-val { font-size: 20px; font-weight: 900; color: white; text-shadow: 0 0 10px var(--accent-glow); }
        .stat-lbl { font-size: 9px; color: var(--text-muted); font-weight: 700; letter-spacing: 1px; margin-top: 3px; }
        .tabs-nav { display: flex; gap: 5px; margin-bottom: 20px; padding: 8px; border-radius: 16px; }
        .tab-btn { flex: 1; padding: 12px; border-radius: 10px; border: none; background: transparent; color: var(--text-muted); font-weight: 700; cursor: pointer; transition: 0.3s cubic-bezier(0.4, 0, 0.2, 1); display: flex; align-items: center; justify-content: center; gap: 8px; font-size: 13px; }
        .tab-btn:hover { background: rgba(255,255,255,0.05); color: white; }
        .tab-btn.active { background: var(--accent); color: white; box-shadow: 0 4px 15px var(--accent-glow); transform: translateY(-1px); }
        .tab-content { display: none; height: calc(100vh - 140px); overflow-y: auto; padding-right: 10px; padding-bottom: 20px; }
        .tab-content.active { display: block; animation: fadeIn 0.3s ease; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .winner-marquee { background: linear-gradient(90deg, var(--gold), #fbbf24, var(--gold)); color: #451a03; padding: 12px; font-weight: 900; text-transform: uppercase; white-space: nowrap; overflow: hidden; position: relative; border-radius: 12px; margin-bottom: 20px; display: none; box-shadow: 0 0 20px var(--gold-glow); border: 1px solid #fde68a; }
        .marquee-text { display: inline-block; animation: marquee 15s linear infinite; }
        @keyframes marquee { 0% { transform: translateX(100%); } 100% { transform: translateX(-100%); } }
        .cards-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap: 15px; }
        .user-card-monitor { background: rgba(15, 23, 42, 0.6); padding: 12px; border-radius: 16px; border: 1px solid var(--glass-border); transition: all 0.3s ease; position: relative; box-shadow: 0 4px 6px rgba(0,0,0,0.2); }
        .user-card-monitor.offline { opacity: 0.4; filter: grayscale(100%); border: 1px dashed #334155; background: transparent; transform: scale(0.98); }
        .user-card-monitor.puro { border-color: var(--puro); box-shadow: 0 0 15px rgba(249, 115, 22, 0.3); animation: pulse-puro 1.5s infinite; background: linear-gradient(145deg, rgba(249, 115, 22, 0.1), rgba(15, 23, 42, 0.8)); }
        .user-card-monitor.bingo { border-color: var(--success); background: linear-gradient(145deg, rgba(6, 78, 59, 0.9), #064e3b); box-shadow: 0 0 25px rgba(16, 185, 129, 0.6); transform: scale(1.05) translateY(-5px); z-index: 10; }
        .monitor-badge { position: absolute; top: -8px; right: -8px; padding: 4px 10px; border-radius: 20px; font-size: 10px; font-weight: 900; color: white; display: none; box-shadow: 0 2px 5px rgba(0,0,0,0.3); text-shadow: 0 1px 2px rgba(0,0,0,0.2); }
        .puro .monitor-badge { display: block; background: var(--puro); content: "PURO!"; }
        .bingo .monitor-badge { display: block; background: var(--success); content: "BINGO!"; }
        @keyframes pulse-puro { 0% { box-shadow: 0 0 0 0 rgba(249, 115, 22, 0.4); } 70% { box-shadow: 0 0 0 10px rgba(249, 115, 22, 0); } 100% { box-shadow: 0 0 0 0 rgba(249, 115, 22, 0); } }
        .mini-bingo-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 3px; margin-top: 10px; }
        .mini-cell { aspect-ratio: 1; background: rgba(0,0,0,0.4); font-size: 9px; display: flex; align-items: center; justify-content: center; border-radius: 4px; color: rgba(255,255,255,0.2); font-weight: 700; }
        .mini-cell.marked { background: var(--accent); color: white; box-shadow: 0 0 5px var(--accent-glow); }
        .mini-cell.hit { background: var(--gold); color: black; box-shadow: 0 0 8px var(--gold-glow); animation: pop 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); } 
        @keyframes pop { 0% { transform: scale(0.5); } 100% { transform: scale(1); } }
        .ball-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(45px, 1fr)); gap: 8px; margin-top: 15px; }
        .ball { aspect-ratio: 1; background: linear-gradient(145deg, #334155, #1e293b); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 800; cursor: pointer; font-size: 14px; border: 1px solid rgba(255,255,255,0.1); transition: all 0.2s; box-shadow: inset 2px 2px 5px rgba(255,255,255,0.05), 0 5px 10px rgba(0,0,0,0.3); position: relative; }
        .ball::after { content: ''; position: absolute; top: 15%; left: 20%; width: 25%; height: 25%; background: radial-gradient(circle, rgba(255,255,255,0.8), transparent); border-radius: 50%; opacity: 0.4; }
        .ball:hover { transform: translateY(-2px); border-color: var(--accent); }
        .ball.drawn { background: radial-gradient(circle at 30% 30%, #60a5fa, #2563eb); color: white; box-shadow: 0 0 15px var(--accent-glow), inset -5px -5px 10px rgba(0,0,0,0.2); border: none; transform: scale(1.1); }
        .input-group { margin-bottom: 20px; }
        label { display: block; font-size: 11px; font-weight: 800; color: var(--text-muted); margin-bottom: 8px; text-transform: uppercase; letter-spacing: 0.5px; }
        input, select, textarea { width: 100%; background: rgba(0,0,0,0.3); border: 1px solid var(--glass-border); padding: 14px; border-radius: 12px; color: white; outline: none; font-family: inherit; font-size: 13px; transition: 0.3s; }
        input:focus, select:focus, textarea:focus { border-color: var(--accent); background: rgba(0,0,0,0.5); box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.1); }
        .btn { width: 100%; padding: 14px; border-radius: 12px; border: none; font-weight: 800; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; margin-top: 10px; transition: all 0.2s; text-transform: uppercase; font-size: 12px; letter-spacing: 0.5px; position: relative; overflow: hidden; }
        .btn:active { transform: scale(0.97); }
        .btn-primary { background: linear-gradient(135deg, #3b82f6, #2563eb); color: white; box-shadow: 0 4px 15px rgba(37, 99, 235, 0.4); }
        .btn-primary:hover { filter: brightness(1.1); }
        .btn-danger { background: linear-gradient(135deg, #ef4444, #dc2626); color: white; box-shadow: 0 4px 15px rgba(220, 38, 38, 0.4); }
        .btn-bringme { background: linear-gradient(135deg, #8b5cf6, #7c3aed); color: white; box-shadow: 0 4px 15px rgba(124, 58, 237, 0.4); }
        .btn-gold { background: linear-gradient(135deg, #fbbf24, #d97706); color: black; box-shadow: 0 4px 15px rgba(217, 119, 6, 0.4); }
        .online-dot { width: 8px; height: 8px; background: var(--success); border-radius: 50%; box-shadow: 0 0 8px var(--success); display: inline-block; }
        .offline-dot { width: 8px; height: 8px; background: #475569; border-radius: 50%; display: inline-block; border: 1px solid rgba(255,255,255,0.1); }
        .status-badge { padding: 4px 12px; border-radius: 20px; font-size: 10px; font-weight: 800; text-transform: uppercase; }
        .status-active { background: var(--success); color: white; box-shadow: 0 0 10px rgba(16, 185, 129, 0.4); }
        .status-off { background: var(--danger); color: white; opacity: 0.8; }
        .card { padding: 24px; border-radius: var(--radius-lg); margin-bottom: 24px; }
        h2 { margin-top: 0; font-size: 16px; font-weight: 700; display: flex; align-items: center; gap: 8px; margin-bottom: 20px; color: white; }
        .user-select-list { max-height: 250px; overflow-y: auto; background: rgba(0,0,0,0.2); border-radius: 12px; padding: 5px; border: 1px solid var(--glass-border); }
        .user-option { padding: 10px 12px; border-radius: 8px; cursor: pointer; font-size: 12px; display: flex; justify-content: space-between; border-bottom: 1px solid rgba(255,255,255,0.03); transition: 0.2s; }
        .user-option:hover { background: rgba(255,255,255,0.05); }
        .user-option.selected { background: var(--accent); color: white; border: none; }
        .card-settings { background: rgba(15, 23, 42, 0.4); border: 1px dashed rgba(255,255,255,0.2); padding: 15px; border-radius: 12px; margin-bottom: 10px; }
        .live-log-item { font-size: 11px; padding: 10px; border-bottom: 1px solid rgba(255,255,255,0.05); animation: flash 1s ease; }
        @keyframes flash { 0% { background: rgba(59, 130, 246, 0.3); } 100% { background: transparent; } }
        .log-pos { color: var(--success); font-weight: 700; }
        .log-neg { color: var(--danger); font-weight: 700; }
        @media (max-width: 1100px) { body { grid-template-columns: 250px 1fr; overflow-y: auto; height: auto; } .activity-panel { display: none; } }
        @media (max-width: 900px) { body { grid-template-columns: 1fr; } .sidebar { height: auto; max-height: 500px; } .tab-content { height: auto; overflow: visible; } .main-section { padding-bottom: 50px; } }
    </style>
</head>
<body>

<div id="lockScreen" style="position:fixed; inset:0; background:#0f172a; z-index:999999; display:flex; flex-direction:column; align-items:center; justify-content:center; color:white;">
    <div style="width: 80px; height: 80px; background: rgba(255,255,255,0.1); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-bottom: 20px; box-shadow: 0 0 30px rgba(59, 130, 246, 0.3);">
        <i data-lucide="lock" style="width: 40px; height: 40px; color: var(--accent);"></i>
    </div>
    <div style="font-size:24px; font-weight:900; margin-bottom:10px; letter-spacing: -1px;">ADMIN <span style="color:var(--accent);">LOCKED</span></div>
    <p style="opacity: 0.6; font-size: 12px; margin-bottom: 30px;">Enter security PIN to access control panel.</p>
    <div style="display:flex; gap:10px;">
        <input type="password" id="adminPassInput" placeholder="Enter PIN" style="width:180px; padding:12px; text-align:center; border-radius:12px; border:1px solid #334155; background:#1e293b; color:white; font-weight:900; letter-spacing: 2px; outline: none;">
        <button onclick="checkAdminLock()" class="btn btn-primary" style="width:auto; padding:12px 20px; margin:0;"><i data-lucide="arrow-right"></i></button>
    </div>
</div>

<div class="sidebar">
    <div class="logo-text">ADMIN<span style="color:var(--accent)">PANEL</span> <span style="font-size:10px; vertical-align:middle; background:var(--gold); color:black; padding:2px 6px; border-radius:4px;">PRO</span></div>
    
    <div class="stat-grid">
        <div class="stat-card"><div class="stat-val" id="countOnline">0</div><div class="stat-lbl">ONLINE</div></div>
        <div class="stat-card"><div class="stat-val" id="countUsers">0</div><div class="stat-lbl">TOTAL</div></div>
    </div>

    <div class="card" style="padding: 15px; margin: 0; background: linear-gradient(145deg, rgba(245, 158, 11, 0.1), rgba(0,0,0,0)); border: 1px solid rgba(245, 158, 11, 0.3);">
        <label style="color:var(--gold)"><i data-lucide="trophy" style="width:12px"></i> Jackpot Prize</label>
        <input type="text" id="jackpotAmount" placeholder="e.g. â‚±5,000" style="margin-bottom:10px; text-align:center; font-weight:900; color:var(--gold); font-size:18px;">
        <div style="display:flex; align-items:center; gap:10px; cursor:pointer;" id="jackpotToggle" onclick="toggleJackpot()">
            <div style="width:44px; height:24px; background:rgba(0,0,0,0.3); border-radius:20px; position:relative; transition:0.3s;" id="jackpotKnobBg">
                <div style="width:18px; height:18px; background:white; border-radius:50%; position:absolute; top:3px; left:3px; transition:0.3s;" id="jackpotKnob"></div>
            </div>
            <span id="jackpotStatusText" style="font-size:10px; font-weight:800; color:var(--text-muted)">HIDDEN</span>
        </div>
    </div>

    <div class="card" style="padding: 15px; margin: 0; background: rgba(59, 130, 246, 0.1); border: 1px solid rgba(59, 130, 246, 0.2);">
        <label style="color:var(--accent-glow)"><i data-lucide="video" style="width:12px"></i> Video Stream Manager</label>
        <input type="text" id="videoUrlInput" placeholder="Paste YouTube Link or ID here..." style="margin-bottom:10px;">
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:8px;">
            <button class="btn btn-primary" onclick="updateVideoFeed()" style="padding: 8px;">GO LIVE</button>
            <button class="btn btn-danger" onclick="setStreamOffline()" style="padding: 8px; background:rgba(255,255,255,0.1); border:1px solid rgba(255,255,255,0.2); box-shadow:none;">GO OFFLINE</button>
        </div>
        <div style="font-size:10px; margin-top:5px; opacity:0.7;">Offline = Shows "Waiting for Live" to players.</div>
    </div>

    <div class="input-group">
        <label>Game Schedule Manager</label>
        <div style="display: flex; gap: 8px;">
            <input type="datetime-local" id="schedInput" style="padding:10px;">
            <button class="btn btn-primary" onclick="addSchedule()" style="width: auto; margin-top: 0; padding:0 15px;">+</button>
        </div>
        <div id="scheduleList" style="margin-top:10px; max-height:100px; overflow-y:auto;"></div>
    </div>

    <div class="card" style="padding: 15px; background: rgba(0,0,0,0.2); flex:1; overflow:hidden; display:flex; flex-direction:column; margin:0;">
        <label>Active Users List (Online)</label>
        <div id="activeUsersList" style="flex:1; overflow-y: auto; font-size: 12px; margin-top:5px;"></div>
    </div>

    <button class="btn btn-danger" onclick="resetGame()"><i data-lucide="refresh-ccw"></i> RESET GAME</button>
</div>

<div class="main-section">
    <div id="winnerAnnounce" class="winner-marquee">
        <div class="marquee-text" id="winnerMarqueeText">MAY NANALO NA! CONGRATULATIONS SA ATING WINNER! ðŸŽ‰</div>
    </div>

    <div class="tabs-nav">
        <button class="tab-btn active" onclick="openTab('bingo-tab', this)"><i data-lucide="layout-grid" width="16"></i> BINGO</button>
        <button class="tab-btn" onclick="openTab('settings-tab', this)"><i data-lucide="sliders" width="16"></i> SETTINGS</button>
        <button class="tab-btn" onclick="openTab('users-tab', this)"><i data-lucide="user-cog" width="16"></i> PLAYERS</button>
        <button class="tab-btn" onclick="openTab('cashout-tab', this)"><i data-lucide="wallet" width="16"></i> CASHOUTS</button>
    </div>

    <div id="settings-tab" class="tab-content">
        <div class="card">
            <h2><i data-lucide="shield"></i> Service Account (Push Notifications)</h2>
            <div class="card-settings" style="background:rgba(239, 68, 68, 0.1); border-color:var(--danger);">
                <p style="font-size:11px; color:#fca5a5; margin:0 0 10px 0;"><i data-lucide="alert-triangle" style="width:12px"></i> <b>IMPORTANT:</b> Paste your Firebase Service Account JSON here to enable push notifications (HTTP v1).</p>
                <textarea id="serviceAccountJson" rows="5" placeholder='Paste contents of service-account.json here...' style="font-family:monospace; font-size:10px;"></textarea>
                <button class="btn btn-primary" onclick="saveServiceAccount()">SAVE CREDENTIALS</button>
            </div>
        </div>
        <div class="card">
            <h2><i data-lucide="joystick"></i> Mini Game Probabilities</h2>
            <div class="card-settings">
                <label>Global Win Rate (%) - ALL GAMES</label>
                <div style="display:flex; gap:10px; align-items:center;">
                    <input type="range" min="10" max="90" value="40" id="winRateSlider" oninput="updateSettingsUI()">
                    <span id="winRateDisplay" style="font-weight:900; width:50px;">40%</span>
                </div>
            </div>
            <button class="btn btn-primary" onclick="saveGameSettings()">SAVE SETTINGS</button>
        </div>
    </div>

    <div id="bingo-tab" class="tab-content active">
        <div style="display:grid; grid-template-columns: 1fr 2fr; gap: 24px; align-items:start;">
            <div class="card">
                <h2><i data-lucide="settings"></i> Game Control</h2>
                <div class="input-group">
                    <label>Winning Pattern</label>
                    <select id="patternSelect" onchange="setPattern(this.value)">
                        <option value="Normal Bingo">Normal Bingo</option>
                        <option value="Blackout">Blackout</option>
                        <option value="Letter X">Letter X</option>
                        <option value="Four Corners">Four Corners</option>
                    </select>
                </div>
                <div style="background: rgba(16, 185, 129, 0.05); border: 1px solid rgba(16, 185, 129, 0.3); padding: 15px; border-radius: 16px; margin-bottom: 20px;">
                    <label style="color:var(--success); margin-bottom:8px; display:flex; justify-content:space-between;">
                        <span>AUTO DRAW MACHINE</span>
                        <span id="speedVal" style="color:white;">8s</span>
                    </label>
                    <div style="display:flex; gap:10px; align-items:center; margin-bottom:15px;">
                        <input type="range" id="drawSpeed" min="3" max="15" value="8" style="flex:1; accent-color: var(--success);" oninput="document.getElementById('speedVal').innerText=this.value+'s'">
                    </div>
                    <button class="btn btn-primary" id="btnAutoDraw" onclick="toggleAutoDraw()" style="background: linear-gradient(135deg, #059669, #047857); box-shadow: 0 4px 15px rgba(5, 150, 105, 0.4);">
                        <i data-lucide="play"></i> START AUTO DRAW
                    </button>
                </div>
                <div class="input-group">
                    <label>Current Ball</label>
                    <div id="lastBall" style="font-size: 70px; font-weight: 900; text-align: center; color: white; background: linear-gradient(145deg, var(--accent), #1e40af); border-radius: 20px; padding: 15px; box-shadow: 0 10px 20px rgba(0,0,0,0.3); text-shadow: 0 2px 5px rgba(0,0,0,0.3); border:1px solid rgba(255,255,255,0.2);">--</div>
                </div>
                <div style="font-size:10px; font-weight:800; opacity:0.5; margin-top:20px; letter-spacing:1px;">MANUAL OVERRIDE:</div>
                <div class="ball-grid" id="ballGrid"></div>
            </div>
            <div class="card">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                    <h2><i data-lucide="users"></i> Live Cards Monitoring</h2>
                    <div style="font-size:11px; display:flex; gap:15px; font-weight:600;">
                        <span style="display:flex; align-items:center; gap:6px"><div style="width:10px; height:10px; background:var(--puro); border-radius:3px;"></div> PURO</span>
                        <span style="display:flex; align-items:center; gap:6px"><div style="width:10px; height:10px; background:var(--success); border-radius:3px;"></div> BINGO</span>
                    </div>
                </div>
                <div class="cards-grid" id="liveCardsContainer"></div>
            </div>
        </div>
    </div>
    
    <div id="users-tab" class="tab-content">
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap: 24px;">
            <div class="card">
                <h2><i data-lucide="coins"></i> Manage Points</h2>
                <div class="input-group"><label>Select User</label><div id="pointsUserList" class="user-select-list"></div><input type="hidden" id="selectedUserForPoints"></div>
                <div class="input-group"><label>Amount (+ or -)</label><input type="number" id="pointsAmount" placeholder="e.g. 500 or -500"></div>
                <button class="btn btn-primary" onclick="modifyUserPoints()">UPDATE POINTS & LOG</button>
            </div>
            <div class="card">
                <h2><i data-lucide="send"></i> Send Notification / Task</h2>
                <div class="input-group"><label>Recipient</label><select id="notifRecipient"><option value="all">ALL USERS (Include Push)</option><option value="selected">Selected User Only</option></select></div>
                <div class="input-group"><label>Message</label><textarea id="notifMessage" rows="5" placeholder="e.g. 5 Mins na lang BOLA NA!"></textarea></div>
                <button class="btn btn-bringme" onclick="sendAdminNotification()">SEND PUSH NOTIFICATION (HTTP v1)</button>
            </div>
            
            <div class="card" style="grid-column: 1 / -1;">
                <h2><i data-lucide="history"></i> Points Transaction Logs <span id="historyUserName" style="color:var(--accent); margin-left:10px;">(Select a User)</span></h2>
                <div id="pointHistoryList" style="height: 250px; overflow-y: auto; background: rgba(0,0,0,0.2); padding: 15px; border-radius: 12px;"></div>
            </div>
        </div>
    </div>

    <div id="cashout-tab" class="tab-content"><div class="card"><h2><i data-lucide="wallet"></i> GCash Requests</h2><div id="cashoutList"></div></div></div>
</div>

<div class="activity-panel">
    <h2 style="font-size:13px; color:var(--text-muted); text-transform:uppercase; letter-spacing:1px;"><i data-lucide="activity" style="width:14px"></i> Live Activity Feed</h2>
    <div id="liveActivityFeed" style="flex:1; overflow-y:auto; display:flex; flex-direction:column; gap:5px;"></div>
</div>

<script>
    const ADMIN_PIN = "12345";
    function checkAdminLock() { if(document.getElementById('adminPassInput').value === ADMIN_PIN) { document.getElementById('lockScreen').style.display = 'none'; sessionStorage.setItem('admin_unlocked', 'true'); } else { alert("WRONG PIN!"); } }
    if(sessionStorage.getItem('admin_unlocked') === 'true') document.getElementById('lockScreen').style.display = 'none';

    lucide.createIcons();
    const firebaseConfig = { apiKey: "AIzaSyDIAQXJ15atKJxu7PtcFL1W9JnO1N14pVs", authDomain: "radiobingo-9ac29.firebaseapp.com", databaseURL: "https://radiobingo-9ac29-default-rtdb.asia-southeast1.firebasedatabase.app", projectId: "radiobingo-9ac29", storageBucket: "radiobingo-9ac29.firebasestorage.app", messagingSenderId: "965903993397", appId: "1:965903993397:web:f6646fa05225f147eebf7c" };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    
    let serviceAccount = null;
    const savedSA = localStorage.getItem('rb_service_account');
    if(savedSA) { try { serviceAccount = JSON.parse(savedSA); document.getElementById('serviceAccountJson').value = savedSA; } catch(e) {} }
    function saveServiceAccount() { const val = document.getElementById('serviceAccountJson').value.trim(); try { const json = JSON.parse(val); if(!json.private_key) throw new Error(); serviceAccount = json; localStorage.setItem('rb_service_account', val); alert("Service Account Saved!"); } catch(e) { alert("Invalid JSON."); } }
    
    function getAccessToken() {
        return new Promise((resolve, reject) => {
            if(!serviceAccount) return reject("No Service Account");
            const now = Math.floor(Date.now() / 1000);
            const claimSet = { iss: serviceAccount.client_email, scope: "https://www.googleapis.com/auth/firebase.messaging", aud: "https://oauth2.googleapis.com/token", exp: now + 3600, iat: now };
            const sJWT = KJUR.jws.JWS.sign("RS256", JSON.stringify({alg: "RS256", typ: "JWT"}), JSON.stringify(claimSet), serviceAccount.private_key);
            fetch("https://oauth2.googleapis.com/token", { method: "POST", headers: { "Content-Type": "application/x-www-form-urlencoded" }, body: `grant_type=urn:ietf:params:oauth:grant-type:jwt-bearer&assertion=${sJWT}` }).then(r => r.json()).then(data => { if(data.access_token) resolve(data.access_token); else reject("Auth Failed"); });
        });
    }

    let drawnNumbers = []; let autoDrawInterval = null; let isAutoDrawing = false; let allUsersData = {}; let userPointsCache = {};
    function cleanName(name) { return name ? name.replace(/[\u4E00-\u9FFF]/g, '').trim() || name : "Unknown"; }
    function openTab(tabId, btn) { document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active')); document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active')); document.getElementById(tabId).classList.add('active'); btn.classList.add('active'); }
    for(let i=1; i<=75; i++) { let b = document.createElement('div'); b.className = 'ball'; b.id = 'ball-'+i; b.innerText = i; b.onclick = () => toggleBall(i); document.getElementById('ballGrid').appendChild(b); }
    
    function updateSettingsUI() { document.getElementById('winRateDisplay').innerText = document.getElementById('winRateSlider').value + "%"; }
    function saveGameSettings() { db.ref('gameState/settings').update({ minigameWinRate: parseInt(document.getElementById('winRateSlider').value) }).then(() => alert("Settings Updated!")); }

    function updateVideoFeed() { db.ref('gameState/videoSettings').set({ type: 'youtube', url: document.getElementById('videoUrlInput').value }); }
    function setStreamOffline() { db.ref('gameState/videoSettings').set({ type: 'offline', url: '' }); }
    
    db.ref('drawnNumbers').on('value', s => { drawnNumbers = s.val() ? Object.values(s.val()) : []; document.querySelectorAll('.ball').forEach(b => b.classList.remove('drawn')); drawnNumbers.forEach(n => document.getElementById('ball-'+n).classList.add('drawn')); updateMonitorCards(); });
    db.ref('gameState/lastCalled').on('value', s => { document.getElementById('lastBall').innerText = s.val() || "--"; });
    
    function toggleJackpot() { const active = document.getElementById('jackpotStatusText').innerText === "VISIBLE"; db.ref('gameState/jackpot').set({ amount: document.getElementById('jackpotAmount').value, active: !active }); }
    db.ref('gameState/jackpot').on('value', s => { const d = s.val(); if(d) { document.getElementById('jackpotAmount').value = d.amount; document.getElementById('jackpotStatusText').innerText = d.active ? "VISIBLE" : "HIDDEN"; document.getElementById('jackpotKnob').style.left = d.active ? "23px" : "3px"; document.getElementById('jackpotKnobBg').style.background = d.active ? "var(--success)" : "rgba(0,0,0,0.3)"; } });

    function toggleAutoDraw() { if(isAutoDrawing) { clearInterval(autoDrawInterval); isAutoDrawing=false; document.getElementById('btnAutoDraw').innerHTML='START AUTO'; } else { isAutoDrawing=true; document.getElementById('btnAutoDraw').innerHTML='STOP AUTO'; autoDrawInterval = setInterval(() => { let n; do { n = Math.floor(Math.random()*75)+1; } while(drawnNumbers.includes(n)); toggleBall(n); }, document.getElementById('drawSpeed').value*1000); } }
    function toggleBall(num) { const ref = db.ref('drawnNumbers/' + num); ref.once('value', s => { if(s.exists()) ref.remove(); else { ref.set(num); db.ref('gameState/lastCalled').set(num); } }); }

    db.ref('users').on('value', s => { 
        allUsersData = s.val() || {}; document.getElementById('countUsers').innerText = s.numChildren();
        const list = document.getElementById('pointsUserList'); list.innerHTML = "";
        s.forEach(child => { 
            const u = child.val(); const uid = child.key;
            if (userPointsCache[uid] !== undefined && userPointsCache[uid] !== u.points) {
                const diff = u.points - userPointsCache[uid];
                const feed = document.getElementById('liveActivityFeed');
                feed.innerHTML = `<div class="live-log-item"><span style="font-weight:700;">${cleanName(u.name)}</span>: <span class="${diff>0?'log-pos':'log-neg'}">${diff>0?'+':''}${diff}</span></div>` + feed.innerHTML;
            }
            userPointsCache[uid] = u.points || 0;
            const div = document.createElement('div'); div.className = `user-option ${document.getElementById('selectedUserForPoints').value===uid?'selected':''}`; 
            div.onclick = () => { document.getElementById('selectedUserForPoints').value = uid; document.getElementById('historyUserName').innerText = cleanName(u.name); renderUserHistory(uid); document.querySelectorAll('.user-option').forEach(e=>e.classList.remove('selected')); div.classList.add('selected'); };
            div.innerHTML = `<span>${cleanName(u.name)}</span> <span>${u.points}</span>`; list.appendChild(div);
        });
        updateMonitorCards();
    });

    function renderUserHistory(uid) {
        const list = document.getElementById('pointHistoryList'); list.innerHTML = "Loading...";
        db.ref('pointLogs/' + uid).limitToLast(50).once('value', s => {
            list.innerHTML = "";
            s.forEach(c => { const log = c.val(); list.innerHTML = `<div style="padding:10px; border-bottom:1px solid rgba(255,255,255,0.1); font-size:12px;"><b>${log.reason}</b>: ${log.amount}</div>` + list.innerHTML; });
        });
    }

    function updateMonitorCards() {
        const container = document.getElementById('liveCardsContainer'); container.innerHTML = "";
        Object.entries(allUsersData).forEach(([uid, user]) => {
            if(!user.currentCard) return;
            // Simple Bingo Logic Check (Simplified for brevity but functional)
            let hits = 0; user.currentCard.forEach(n => { if(drawnNumbers.includes(n) || n==="FREE") hits++; });
            const isBingo = hits >= 5; // Placeholder logic
            const div = document.createElement('div'); div.className = `user-card-monitor ${isBingo?'bingo':''}`;
            div.innerHTML = `<div class="monitor-badge">${isBingo?"BINGO!":""}</div><div style="font-size:12px; font-weight:800;">${cleanName(user.name)}</div>`;
            container.appendChild(div);
        });
    }

    function modifyUserPoints() { 
        const uid = document.getElementById('selectedUserForPoints').value; 
        const amount = parseInt(document.getElementById('pointsAmount').value);
        if(!uid || !amount) return;
        db.ref(`users/${uid}/points`).transaction(c => (c||0) + amount, (e, committed) => {
            if(committed) db.ref(`pointLogs/${uid}`).push({ amount: amount, reason: "Admin Adjustment", timestamp: firebase.database.ServerValue.TIMESTAMP });
        });
    }

    async function sendAdminNotification() {
        const msg = document.getElementById('notifMessage').value; if(!msg) return;
        const type = document.getElementById('notifRecipient').value;
        const title = "RB LIVE ALERT";
        
        if(type === 'selected') {
            const uid = document.getElementById('selectedUserForPoints').value;
            db.ref(`notifications/${uid}`).push({ msg: msg, time: Date.now() });
            db.ref(`users/${uid}/fcmToken`).once('value', t => { if(t.exists()) sendPush(t.val(), title, msg); });
        } else {
            db.ref('users').once('value', s => { s.forEach(u => { db.ref(`notifications/${u.key}`).push({ msg: msg, time: Date.now() }); if(u.val().fcmToken) sendPush(u.val().fcmToken, title, msg); }); });
        }
        alert("Sent!");
    }

    async function sendPush(token, title, body) {
        if(!serviceAccount) return;
        try {
            const accessToken = await getAccessToken();
            fetch(`https://fcm.googleapis.com/v1/projects/${serviceAccount.project_id}/messages:send`, {
                method: 'POST',
                headers: { 'Authorization': `Bearer ${accessToken}`, 'Content-Type': 'application/json' },
                body: JSON.stringify({ message: { token: token, notification: { title: title, body: body } } })
            });
        } catch(e) { console.error(e); }
    }
    
    db.ref('redemptions').on('value', s => {
        const list = document.getElementById('cashoutList'); list.innerHTML = "";
        s.forEach(child => {
            const r = child.val(); const key = child.key; if(r.status !== 'pending') return;
            const div = document.createElement('div'); div.className = 'card'; div.style.padding = "10px";
            div.innerHTML = `<div><b>${cleanName(r.name)}</b> - ${r.item} (${r.gcash})</div><button class="btn btn-primary" onclick="updateStatus('${key}','sent','${r.uid}','${r.item}')">PAID</button><button class="btn btn-danger" onclick="updateStatus('${key}','denied','${r.uid}','${r.item}',${r.cost})">DENY</button>`;
            list.appendChild(div);
        });
    });

    function updateStatus(key, status, uid, item, cost) {
        if(!confirm(status + "?")) return;
        db.ref('redemptions/' + key).update({ status: status });
        if(status === 'denied') {
             db.ref('users/' + uid + '/points').transaction(p => (p || 0) + cost);
             db.ref(`pointLogs/${uid}`).push({ amount: cost, reason: `Refund: ${item}`, timestamp: Date.now() });
        }
    }
    
    function resetGame() { if(confirm("RESET?")) { db.ref('drawnNumbers').remove(); db.ref('gameState/lastCalled').remove(); } }
</script>
</body>
</html>
