<!DOCTYPE html>
<html lang="tl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Radio Bring Me | Admin Discord-Style</title>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <style>
        :root { 
            --bg: #313338; 
            --sidebar: #2b2d31; 
            --surface: #1e1f22; 
            --accent: #5865f2; 
            --text: #dbdee1; 
            --text-muted: #949ba4;
            --success: #23a559; 
            --danger: #f23f42; 
            --gold: #f0b232; 
        }
        body { 
            font-family: 'Plus Jakarta Sans', sans-serif; 
            background: var(--bg); color: var(--text); 
            margin: 0; display: flex; height: 100vh; overflow: hidden;
        }
        .sidebar { width: 260px; background: var(--sidebar); display: flex; flex-direction: column; border-right: 1px solid rgba(0,0,0,0.2); }
        .main-content { flex: 1; overflow-y: auto; padding: 25px; }
        
        .nav-header { padding: 20px; font-weight: 800; font-size: 18px; border-bottom: 1px solid rgba(255,255,255,0.05); color: white; }
        
        .card { background: var(--surface); padding: 20px; border-radius: 8px; margin-bottom: 20px; border: 1px solid rgba(0,0,0,0.1); }
        h2 { font-size: 12px; text-transform: uppercase; color: var(--text-muted); letter-spacing: 0.5px; display: flex; align-items: center; gap: 8px; }

        input, textarea { 
            width: 100%; background: #1e1f22; border: 1px solid #111; color: white; 
            padding: 10px; border-radius: 4px; margin-bottom: 10px; font-family: inherit;
        }

        .btn-set { background: var(--accent); color: white; border: none; padding: 12px; border-radius: 3px; cursor: pointer; font-weight: 600; width: 100%; }
        .btn-set:hover { background: #4752c4; }

        .player-mini-card { 
            display: flex; align-items: center; gap: 12px; padding: 8px; border-radius: 4px; transition: 0.2s; cursor: pointer;
        }
        .player-mini-card:hover { background: rgba(255,255,255,0.05); }
        .player-pfp { width: 32px; height: 32px; border-radius: 50%; }
        
        .chat-monitor { height: 400px; display: flex; flex-direction: column; background: var(--sidebar); border-radius: 8px; }
        #chatList { flex: 1; overflow-y: auto; padding: 15px; font-size: 14px; }
        .chat-msg { margin-bottom: 8px; }
        .chat-msg b { color: var(--accent); }

        #adminWinnerNotif { background: var(--success); padding: 15px; border-radius: 8px; margin-bottom: 15px; display: none; }
    </style>
</head>
<body>

    <div class="sidebar">
        <div class="nav-header">ADMIN PANEL</div>
        <div style="padding: 15px;">
            <h2><i data-lucide="users"></i> Online Players</h2>
            <div id="playersGrid"></div>
        </div>
    </div>

    <div class="main-content">
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
            <div>
                <div class="card">
                    <h2><i data-lucide="radio"></i> Control Engine</h2>
                    <div id="adminWinnerNotif">
                        <div id="winnerInfo"></div>
                    </div>
                    <h1 id="currentItemDisplay" style="color:var(--gold); text-align:center;">WAITING...</h1>
                    <input type="text" id="itemInput" placeholder="Target item...">
                    <button class="btn-set" onclick="setTargetItem()">LAUNCH ROUND</button>
                    <div style="display:flex; gap:10px; margin-top:10px;">
                        <button onclick="resetGame()" style="flex:1; background:var(--danger); border:none; color:white; padding:8px; border-radius:3px; cursor:pointer;">RESET</button>
                        <button onclick="clearWinner()" style="flex:1; background:var(--gold); border:none; color:black; padding:8px; border-radius:3px; cursor:pointer;">CLEAR</button>
                    </div>
                </div>

                <div class="card">
                    <h2><i data-lucide="megaphone"></i> Global Marquee</h2>
                    <textarea id="notifMsg" placeholder="Announcement..."></textarea>
                    <button onclick="updateAnnouncement()" class="btn-set">UPDATE APP</button>
                </div>
            </div>

            <div>
                <div class="card">
                    <h2><i data-lucide="coins"></i> Point Adjuster (Secure)</h2>
                    <input type="text" id="targetUid" placeholder="Player UID">
                    <input type="number" id="pointAmount" placeholder="Amount">
                    <div style="display:flex; gap:10px;">
                        <button onclick="adjustPoints('add')" style="background:var(--success); border:none; color:white; flex:1; padding:10px; border-radius:3px;">ADD</button>
                        <button onclick="adjustPoints('sub')" style="background:var(--danger); border:none; color:white; flex:1; padding:10px; border-radius:3px;">SUB</button>
                    </div>
                </div>

                <div class="card chat-monitor">
                    <h2><i data-lucide="message-square"></i> Live Chat</h2>
                    <div id="chatList"></div>
                </div>
            </div>
        </div>

        <div class="card">
            <h2><i data-lucide="wallet"></i> Pending Payouts</h2>
            <div id="payoutList"></div>
        </div>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyDIAQXJ15atKJxu7PtcFL1W9JnO1N14pVs",
            authDomain: "radiobingo-9ac29.firebaseapp.com",
            databaseURL: "https://radiobingo-9ac29-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "radiobingo-9ac29",
            storageBucket: "radiobingo-9ac29.firebasestorage.app",
            messagingSenderId: "965903993397",
            appId: "1:965903993397:web:f6646fa05225f147eebf7c"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        function setTargetItem() {
            const item = document.getElementById('itemInput').value.toLowerCase().trim();
            if(!item) return;
            // Siguruhing malinis ang previous winner bago mag-start
            db.ref('gameState/latestWinner').set(null).then(() => {
                db.ref('gameState/targetItem').set(item);
            });
            document.getElementById('itemInput').value = "";
        }

        function updateAnnouncement() {
            const msg = document.getElementById('notifMsg').value.trim();
            if(msg) db.ref('gameState/announcement').set(msg);
        }

        function resetGame() {
            if(confirm("Reset?")) {
                db.ref('gameState/targetItem').set("Waiting for Host...");
                db.ref('gameState/latestWinner').set(null);
            }
        }

        function clearWinner() { db.ref('gameState/latestWinner').set(null); }

        db.ref('gameState/targetItem').on('value', s => {
            document.getElementById('currentItemDisplay').innerText = s.val() || "WAITING...";
        });

        db.ref('gameState/latestWinner').on('value', s => {
            const notif = document.getElementById('adminWinnerNotif');
            const info = document.getElementById('winnerInfo');
            if(s.exists()) {
                const w = s.val();
                notif.style.display = 'block';
                info.innerHTML = `Winner: <b>${w.name}</b> <button onclick="copyUid('${w.uid}')">COPY UID</button>`;
            } else { notif.style.display = 'none'; }
        });

        function copyUid(uid) { document.getElementById('targetUid').value = uid; }

        db.ref('redemptions').on('value', s => {
            const list = document.getElementById('payoutList');
            list.innerHTML = "";
            s.forEach(child => {
                const r = child.val();
                if(r.status !== 'pending') return;
                const div = document.createElement('div');
                div.style.padding = "10px"; div.style.borderBottom = "1px solid #444";
                div.innerHTML = `${r.name} - ${r.item} (${r.gcash}) 
                    <button onclick="updateStatus('${child.key}', 'completed', ${JSON.stringify(r).replace(/"/g, '&quot;')})">PAID</button>`;
                list.appendChild(div);
            });
        });

        function updateStatus(key, status, data) {
            db.ref('redemptions/' + key).update({ status: status });
            db.ref('notifications').push({ title: "Payout", body: "Updated to " + status, uid: data.uid });
        }

        db.ref('users').on('value', s => {
            const grid = document.getElementById('playersGrid');
            grid.innerHTML = "";
            s.forEach(child => {
                const p = child.val();
                const div = document.createElement('div');
                div.className = 'player-mini-card';
                div.innerHTML = `<img src="${p.photo}" class="player-pfp"> <span>${p.name}</span> <small>${p.points || 0}</small>`;
                div.onclick = () => copyUid(child.key);
                grid.appendChild(div);
            });
        });

        function adjustPoints(type) {
            const uid = document.getElementById('targetUid').value;
            const amt = parseInt(document.getElementById('pointAmount').value);
            if(!uid || !amt) return;
            // Gumamit ng transaction para iwas double points
            db.ref('users/' + uid + '/points').transaction(p => type === 'add' ? (p || 0) + amt : (p || 0) - amt);
            alert("Points Adjusted!");
        }

        db.ref('chats').limitToLast(20).on('child_added', s => {
            const m = s.val();
            const list = document.getElementById('chatList');
            const div = document.createElement('div');
            div.className = 'chat-msg';
            div.innerHTML = `<b>${m.name}:</b> ${m.msg}`;
            list.appendChild(div);
            list.scrollTop = list.scrollHeight;
        });

        lucide.createIcons();
    </script>
</body>
</html>
