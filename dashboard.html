<!DOCTYPE html>
<html lang="tl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Radio Bingo | Admin Master</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <style>
        :root { --bg: #030712; --surface: #111827; --accent: #3b82f6; --text: #f8fafc; --success: #10b981; --gold: #fbbf24; --danger: #ef4444; }
        body { font-family: 'Inter', sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 20px; display: grid; grid-template-columns: 300px 1fr; gap: 20px; height: 100vh; }
        
        .sidebar { background: var(--surface); padding: 20px; border-radius: 20px; border: 1px solid rgba(255,255,255,0.1); overflow-y: auto; }
        .main-content { overflow-y: auto; padding-right: 10px; }
        
        /* AUTO DRAW & CONFIG SECTION */
        .config-card { background: var(--surface); padding: 20px; border-radius: 20px; margin-bottom: 20px; border: 1px solid var(--accent); }
        .input-group { margin-bottom: 15px; }
        label { font-size: 11px; font-weight: 800; color: #64748b; display: block; margin-bottom: 5px; }
        input { width: 100%; padding: 10px; background: #1f2937; border: 1px solid #374151; color: white; border-radius: 8px; }

        /* REAL-TIME MONITORING */
        .monitor-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 15px; }
        .user-monitor-card { background: #1f2937; padding: 12px; border-radius: 12px; border: 2px solid transparent; }
        .user-monitor-card.online { border-color: var(--success); }
        .user-monitor-card.puro { border-color: var(--gold); animation: pulse 1s infinite; }
        .mini-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 2px; margin-top: 8px; }
        .m-cell { aspect-ratio: 1; background: rgba(0,0,0,0.3); border-radius: 2px; font-size: 8px; display: flex; align-items: center; justify-content: center; }
        .m-cell.hit { background: var(--accent); color: white; }

        .btn { width: 100%; padding: 12px; border-radius: 10px; border: none; font-weight: 800; cursor: pointer; margin-top: 10px; transition: 0.3s; }
        .btn-start { background: var(--success); color: white; }
        .btn-stop { background: var(--danger); color: white; }
        
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }
    </style>
</head>
<body>

<div class="sidebar">
    <h2 style="margin-top:0">ADMIN <span style="color:var(--accent)">DASH</span></h2>
    
    <div class="config-card">
        <div class="input-group">
            <label>JACKPOT PRIZE (₱)</label>
            <input type="number" id="jackpotInput" onchange="updateGameConfig()" placeholder="5000">
        </div>
        <div class="input-group">
            <label>POINTS PER DRAW</label>
            <input type="number" id="pointsInput" onchange="updateGameConfig()" placeholder="10">
        </div>
        <hr style="opacity:0.1">
        <div id="drawStatus" style="text-align:center; font-weight:800; color:var(--gold); margin-bottom:10px;">AUTO DRAW: OFF</div>
        <button class="btn btn-start" id="startBtn" onclick="toggleAutoDraw(true)">START AUTO DRAW</button>
        <button class="btn btn-stop" id="stopBtn" onclick="toggleAutoDraw(false)" style="display:none">STOP DRAW</button>
    </div>

    <div class="card" style="background:rgba(255,255,255,0.05); padding:15px; border-radius:15px;">
        <label>RECENT BALLS</label>
        <div id="drawnList" style="display:flex; flex-wrap:wrap; gap:5px; margin-top:10px;"></div>
    </div>
</div>

<div class="main-content">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
        <h3 style="margin:0">REAL-TIME PLAYER CARDS</h3>
        <div id="onlineCount" style="font-weight:800; color:var(--success)">0 ONLINE</div>
    </div>
    
    <div class="monitor-grid" id="monitorGrid">
        </div>
</div>

<script>
    // FIREBASE CONFIG (Gamitin ang dati mong config dito)
    const firebaseConfig = { /* PASTE YOUR CONFIG HERE */ };
    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    let autoDrawInterval = null;
    let drawnBalls = [];

    // 1. UPDATE CONFIG (Jackpot & Points)
    function updateGameConfig() {
        const jackpot = document.getElementById('jackpotInput').value;
        const points = document.getElementById('pointsInput').value;
        db.ref('gameState').update({
            jackpot: jackpot || 0,
            pointsPerDraw: points || 0
        });
    }

    // 2. AUTO DRAW SYSTEM
    function toggleAutoDraw(start) {
        if (start) {
            document.getElementById('startBtn').style.display = 'none';
            document.getElementById('stopBtn').style.display = 'block';
            document.getElementById('drawStatus').innerText = "AUTO DRAW: RUNNING...";
            
            autoDrawInterval = setInterval(() => {
                drawNextBall();
            }, 5000); // 5 seconds per ball
        } else {
            clearInterval(autoDrawInterval);
            document.getElementById('startBtn').style.display = 'block';
            document.getElementById('stopBtn').style.display = 'none';
            document.getElementById('drawStatus').innerText = "AUTO DRAW: STOPPED";
        }
    }

    function drawNextBall() {
        if (drawnBalls.length >= 75) {
            toggleAutoDraw(false);
            return;
        }
        let ball;
        do { ball = Math.floor(Math.random() * 75) + 1; } while (drawnBalls.includes(ball));
        
        drawnBalls.push(ball);
        db.ref('gameState').update({
            currentBall: ball,
            drawnBalls: drawnBalls
        });
        updateDrawnUI();
    }

    function updateDrawnUI() {
        const list = document.getElementById('drawnList');
        list.innerHTML = drawnBalls.slice(-10).map(b => `<div style="width:30px; height:30px; background:var(--accent); border-radius:50%; display:flex; align-items:center; justify-content:center; font-size:12px; font-weight:800;">${b}</div>`).join('');
    }

    // 3. REAL-TIME MONITORING (Online First + Puro Detection)
    db.ref('users').on('value', snapshot => {
        const users = snapshot.val();
        const grid = document.getElementById('monitorGrid');
        grid.innerHTML = '';
        
        let userArray = [];
        for (let id in users) userArray.push({ id, ...users[id] });

        // SORTING: Online First, then Puro
        userArray.sort((a, b) => {
            const aOnline = (Date.now() - (a.lastSeen || 0)) < 10000;
            const bOnline = (Date.now() - (b.lastSeen || 0)) < 10000;
            if (aOnline !== bOnline) return bOnline - aOnline;
            return (b.isPuro || 0) - (a.isPuro || 0);
        });

        let onlineCount = 0;

        userArray.forEach(user => {
            const isOnline = (Date.now() - (user.lastSeen || 0)) < 10000;
            if (isOnline) onlineCount++;

            const cardDiv = document.createElement('div');
            cardDiv.className = `user-monitor-card ${isOnline ? 'online' : ''} ${user.isPuro ? 'puro' : ''}`;
            
            // Check for Winner
            if (user.isWinner) {
                alert("WINNER DETECTED: " + user.name);
                toggleAutoDraw(false);
            }

            cardDiv.innerHTML = `
                <div style="font-size:11px; font-weight:900;">${user.name || 'Player'}</div>
                <div style="font-size:9px; color:var(--success)">${isOnline ? '● ONLINE' : 'OFFLINE'}</div>
                <div class="mini-grid">
                    ${(user.card || []).map(num => `
                        <div class="m-cell ${drawnBalls.includes(num) || num === 0 ? 'hit' : ''}">${num === 0 ? 'F' : num}</div>
                    `).join('')}
                </div>
            `;
            grid.appendChild(cardDiv);
        });
        document.getElementById('onlineCount').innerText = onlineCount + " ONLINE";
    });

    function resetGame() {
        if (confirm("Reset everything?")) {
            drawnBalls = [];
            db.ref('gameState').update({ currentBall: '--', drawnBalls: [] });
            db.ref('users').once('value', s => {
                s.forEach(u => u.ref.update({ isPuro: false, isWinner: false }));
            });
            location.reload();
        }
    }
</script>
</body>
</html>
