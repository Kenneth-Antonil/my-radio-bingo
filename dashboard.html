<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>RadioBingo Admin Dashboard</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <style>
        body { font-family: sans-serif; background: #0f172a; color: white; padding: 20px; }
        .card { background: #1e293b; padding: 20px; border-radius: 12px; margin-bottom: 20px; border: 1px solid #334155; }
        button { padding: 10px 20px; cursor: pointer; border-radius: 8px; border: none; font-weight: bold; margin-right: 10px; }
        .btn-draw { background: #3b82f6; color: white; }
        .btn-reset { background: #ef4444; color: white; }
        .btn-save { background: #10b981; color: white; }
        select, input { padding: 10px; border-radius: 8px; background: #0f172a; color: white; border: 1px solid #334155; }
        #drawnList { display: flex; flex-wrap: wrap; gap: 10px; margin-top: 15px; }
        .ball { width: 40px; height: 40px; background: #334155; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th, td { text-align: left; padding: 12px; border-bottom: 1px solid #334155; }
    </style>
</head>
<body>

    <h2>RadioBingo Control Panel</h2>

    <div class="card">
        <h3>Game Controls</h3>
        <p>Current Pattern: <select id="patternSelect">
            <option value="Normal Bingo">Normal Bingo</option>
            <option value="Blackout">Blackout</option>
            <option value="Four Corners">Four Corners</option>
            <option value="Letter X">Letter X</option>
        </select> 
        <button class="btn-save" onclick="updatePattern()">Set Pattern</button></p>
        
        <div style="margin-top:20px;">
            <input type="number" id="ballInput" placeholder="Enter Ball #" style="width:100px;">
            <button class="btn-draw" onclick="drawBall()">Draw Ball</button>
            <button class="btn-reset" onclick="resetGame()">RESET GAME</button>
        </div>

        <div id="drawnList"></div>
    </div>

    <div class="card">
        <h3>Current Winner</h3>
        <div id="winnerDisplay">No winner yet.</div>
        <button class="btn-reset" style="margin-top:10px; background:#f59e0b;" onclick="clearWinner()">Clear Winner Only</button>
    </div>

    <div class="card">
        <h3>Redemption Requests</h3>
        <table>
            <thead>
                <tr>
                    <th>User</th>
                    <th>Item</th>
                    <th>GCash</th>
                    <th>Action</th>
                </tr>
            </thead>
            <tbody id="redemptionTable"></tbody>
        </table>
    </div>

<script>
    const firebaseConfig = { apiKey: "AIzaSyDIAQXJ15atKJxu7PtcFL1W9JnO1N14pVs", authDomain: "radiobingo-9ac29.firebaseapp.com", databaseURL: "https://radiobingo-9ac29-default-rtdb.asia-southeast1.firebasedatabase.app", projectId: "radiobingo-9ac29", storageBucket: "radiobingo-9ac29.firebasestorage.app", messagingSenderId: "965903993397", appId: "1:965903993397:web:f6646fa05225f147eebf7c" };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // Listen for Drawn Numbers
    db.ref('drawnNumbers').on('value', s => {
        const list = document.getElementById('drawnList');
        list.innerHTML = "";
        if(s.exists()) {
            Object.values(s.val()).forEach(n => {
                const b = document.createElement('div');
                b.className = 'ball';
                b.innerText = n;
                list.appendChild(b);
            });
        }
    });

    // Listen for Winner
    db.ref('gameState/latestWinner').on('value', s => {
        const display = document.getElementById('winnerDisplay');
        if(s.exists()) {
            const w = s.val();
            display.innerHTML = `<b style="color:#10b981">${w.name}</b> won at ${new Date(w.time).toLocaleTimeString()}`;
        } else {
            display.innerText = "No winner yet.";
        }
    });

    function drawBall() {
        const val = document.getElementById('ballInput').value;
        if(!val || val < 1 || val > 75) return alert("Enter 1-75");
        
        db.ref('drawnNumbers').once('value', s => {
            if(s.exists() && Object.values(s.val()).includes(val)) return alert("Already drawn");
            
            // If first ball, set game start time
            if(!s.exists()) db.ref('gameState/gameStartTime').set(Date.now());
            
            db.ref('drawnNumbers').push(val);
            document.getElementById('ballInput').value = "";
        });
    }

    function resetGame() {
        if(confirm("Confirm Reset? This clears ALL balls and the winner!")) {
            db.ref('drawnNumbers').remove();
            db.ref('gameState/latestWinner').remove();
            db.ref('gameState/gameStartTime').remove();
            // Reset "hasWonCurrent" for all users
            db.ref('users').once('value', s => {
                s.forEach(u => u.ref.update({ hasWonCurrent: false }));
            });
        }
    }

    function clearWinner() {
        db.ref('gameState/latestWinner').remove();
    }

    function updatePattern() {
        const p = document.getElementById('patternSelect').value;
        db.ref('gameState/currentPattern').set(p);
        alert("Pattern updated to: " + p);
    }

    // Redemption Logic
    db.ref('redemptions').on('value', s => {
        const tbody = document.getElementById('redemptionTable');
        tbody.innerHTML = "";
        s.forEach(child => {
            const r = child.val();
            if(r.status === 'pending') {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${r.name}</td>
                    <td>${r.item}</td>
                    <td>${r.gcash}</td>
                    <td><button class="btn-save" onclick="approveRedeem('${child.key}', '${r.uid}')">Approve</button></td>
                `;
                tbody.appendChild(tr);
            }
        });
    });

    function approveRedeem(key, uid) {
        db.ref('redemptions/' + key).update({ status: 'completed' });
        db.ref('notifications/' + uid).push({
            msg: "Your GCash redemption has been processed! Check your account.",
            time: Date.now()
        });
        alert("Approved and User notified!");
    }
</script>
</body>
</html>
