<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Radio Bingo | Admin Master Pro 3D</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jsrsasign/10.5.1/jsrsasign-all-min.js"></script>
    <style>
        :root { 
            --bg-dark: #0a0a0f; 
            --bg-gradient: linear-gradient(135deg, #0a0a0f 0%, #1a1625 50%, #0f1419 100%); 
            --glass-surface: rgba(18, 18, 30, 0.95); 
            --glass-border: rgba(139, 92, 246, 0.15); 
            --glass-highlight: rgba(255, 255, 255, 0.08); 
            --accent: #8b5cf6; 
            --accent-secondary: #6366f1;
            --accent-glow: rgba(139, 92, 246, 0.5); 
            --text: #f8fafc; 
            --text-muted: #94a3b8; 
            --success: #10b981; 
            --success-glow: rgba(16, 185, 129, 0.4);
            --danger: #ef4444; 
            --danger-glow: rgba(239, 68, 68, 0.4);
            --gold: #fbbf24; 
            --gold-glow: rgba(251, 191, 36, 0.5); 
            --puro: #f97316; 
            --puro-glow: rgba(249, 115, 22, 0.5);
            --bringme: #8b5cf6; 
            --cyan: #06b6d4;
            --cyan-glow: rgba(6, 182, 212, 0.4);
            
            --spacing-xs: 8px;
            --spacing-sm: 12px;
            --spacing-md: 16px;
            --spacing-lg: 20px;
            --spacing-xl: 24px;
            --spacing-2xl: 32px;
            
            --radius-sm: 12px;
            --radius-md: 16px;
            --radius-lg: 20px;
            --radius-xl: 24px;
            --radius-full: 9999px;
            
            --shadow-card: 0 8px 32px rgba(0, 0, 0, 0.4), 0 2px 8px rgba(0, 0, 0, 0.3); 
            --shadow-hover: 0 12px 48px rgba(139, 92, 246, 0.3), 0 4px 12px rgba(0, 0, 0, 0.4);
            --shadow-active: 0 4px 16px rgba(139, 92, 246, 0.4);
        }
        * { box-sizing: border-box; }
        body { 
            font-family: 'Inter', sans-serif; 
            background: var(--bg-gradient); 
            background-attachment: fixed; 
            color: var(--text); 
            margin: 0; 
            padding: var(--spacing-lg); 
            display: grid; 
            grid-template-columns: 300px 1fr 280px; 
            gap: var(--spacing-lg); 
            height: 100vh; 
            overflow: hidden;
            position: relative;
        }
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: 
                radial-gradient(circle at 20% 30%, rgba(139, 92, 246, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 80% 70%, rgba(99, 102, 241, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 50% 50%, rgba(6, 182, 212, 0.05) 0%, transparent 50%);
            pointer-events: none;
            z-index: 0;
            animation: float-bg 20s ease-in-out infinite;
        }
        body > * {
            position: relative;
            z-index: 1;
        }
        @keyframes float-bg {
            0%, 100% { opacity: 0.6; transform: scale(1); }
            50% { opacity: 1; transform: scale(1.1); }
        }
        ::-webkit-scrollbar { width: 8px; } 
        ::-webkit-scrollbar-track { background: rgba(0, 0, 0, 0.2); border-radius: 10px; } 
        ::-webkit-scrollbar-thumb { 
            background: linear-gradient(135deg, var(--accent), var(--accent-secondary)); 
            border-radius: 10px; 
            box-shadow: 0 0 6px var(--accent-glow);
        }
        ::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(135deg, #a78bfa, #818cf8);
        }
        .card, .sidebar, .tabs-nav, .activity-panel { 
            background: var(--glass-surface); 
            backdrop-filter: blur(20px); 
            -webkit-backdrop-filter: blur(20px); 
            border: 2px solid var(--glass-border); 
            box-shadow: var(--shadow-card); 
            position: relative;
        }
        .card::before, .sidebar::before, .activity-panel::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 1px;
            background: linear-gradient(90deg, transparent, var(--accent), transparent);
            opacity: 0.5;
        }
        .sidebar { border-radius: var(--radius-lg); padding: var(--spacing-lg); overflow-y: auto; display: flex; flex-direction: column; gap: var(--spacing-md); height: calc(100vh - 40px); }
        .activity-panel { border-radius: var(--radius-lg); padding: var(--spacing-lg); overflow-y: hidden; display: flex; flex-direction: column; height: calc(100vh - 40px); }
        .logo-text { 
            font-size: 26px; 
            font-weight: 900; 
            letter-spacing: -1.5px; 
            text-transform: uppercase; 
            background: linear-gradient(135deg, #8b5cf6, #6366f1, #06b6d4, #8b5cf6); 
            background-size: 300% 300%;
            -webkit-background-clip: text; 
            -webkit-text-fill-color: transparent; 
            margin-bottom: var(--spacing-md); 
            text-shadow: 0 0 30px rgba(139, 92, 246, 0.3);
            animation: gradientShift 8s ease infinite;
            filter: drop-shadow(0 2px 4px rgba(139, 92, 246, 0.5));
        }
        @keyframes gradientShift {
            0%, 100% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
        }
        .stat-grid { display: grid; grid-template-columns: 1fr 1fr; gap: var(--spacing-sm); }
        .stat-card { 
            background: linear-gradient(145deg, rgba(139, 92, 246, 0.1), rgba(0, 0, 0, 0.3)); 
            padding: var(--spacing-md); 
            border-radius: var(--radius-md); 
            text-align: center; 
            border: 1.5px solid var(--glass-border); 
            position: relative; 
            overflow: hidden;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            cursor: pointer;
        }
        .stat-card:hover {
            transform: translateY(-3px);
            border-color: var(--accent);
            box-shadow: 0 8px 24px var(--accent-glow);
        }
        .stat-card::before { 
            content: ''; 
            position: absolute; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 3px; 
            background: linear-gradient(90deg, transparent, var(--accent), var(--cyan), transparent); 
            animation: shimmer 3s linear infinite;
        }
        @keyframes shimmer {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }
        .stat-val { 
            font-size: 24px; 
            font-weight: 900; 
            background: linear-gradient(135deg, #fff, var(--accent)); 
            -webkit-background-clip: text; 
            -webkit-text-fill-color: transparent;
            text-shadow: none;
            filter: drop-shadow(0 0 12px var(--accent-glow));
        }
        .stat-lbl { 
            font-size: 10px; 
            color: var(--text-muted); 
            font-weight: 700; 
            letter-spacing: 1.5px; 
            margin-top: 6px;
            text-transform: uppercase; 
        }
        .tabs-nav { 
            display: flex; 
            gap: 6px; 
            margin-bottom: var(--spacing-lg); 
            padding: var(--spacing-sm); 
            border-radius: var(--radius-xl); 
            background: linear-gradient(145deg, rgba(139, 92, 246, 0.05), rgba(0, 0, 0, 0.3));
        }
        .tab-btn { 
            flex: 1; 
            padding: var(--spacing-md); 
            border-radius: var(--radius-md); 
            border: none; 
            background: transparent; 
            color: var(--text-muted); 
            font-weight: 700; 
            cursor: pointer; 
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            gap: var(--spacing-xs); 
            font-size: 13px;
            position: relative;
            overflow: hidden;
        }
        .tab-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(139, 92, 246, 0.2), transparent);
            transition: left 0.5s;
        }
        .tab-btn:hover::before {
            left: 100%;
        }
        .tab-btn:hover { 
            background: rgba(139, 92, 246, 0.1); 
            color: var(--accent); 
            transform: translateY(-2px);
        }
        .tab-btn.active { 
            background: linear-gradient(135deg, var(--accent), var(--accent-secondary)); 
            color: white; 
            box-shadow: 0 6px 20px var(--accent-glow), inset 0 1px 0 rgba(255, 255, 255, 0.2); 
            transform: translateY(-2px); 
        }
        .tab-content { display: none; height: calc(100vh - 140px); overflow-y: auto; padding-right: var(--spacing-sm); padding-bottom: var(--spacing-lg); }
        .tab-content.active { display: block; animation: fadeIn 0.3s ease; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .winner-marquee { 
            background: linear-gradient(135deg, #fbbf24, #f59e0b, #fbbf24); 
            background-size: 200% 200%;
            animation: gradient-move 3s ease infinite;
            color: #78350f; 
            padding: var(--spacing-md); 
            font-weight: 900; 
            text-transform: uppercase; 
            white-space: nowrap; 
            overflow: hidden; 
            position: relative; 
            border-radius: var(--radius-lg); 
            margin-bottom: var(--spacing-lg); 
            display: none; 
            box-shadow: 0 0 30px var(--gold-glow), 
                        0 4px 12px rgba(0, 0, 0, 0.3),
                        inset 0 2px 0 rgba(255, 255, 255, 0.4); 
            border: 2px solid #fde68a;
            text-shadow: 0 1px 2px rgba(255, 255, 255, 0.5);
        }
        @keyframes gradient-move {
            0%, 100% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
        }
        .marquee-text { display: inline-block; animation: marquee 15s linear infinite; }
        @keyframes marquee { 0% { transform: translateX(100%); } 100% { transform: translateX(-100%); } }
        .cards-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap: var(--spacing-md); }
        .user-card-monitor { 
            background: linear-gradient(145deg, rgba(30, 41, 59, 0.8), rgba(15, 23, 42, 0.9)); 
            padding: var(--spacing-md); 
            border-radius: var(--radius-lg); 
            border: 2px solid var(--glass-border); 
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1); 
            position: relative; 
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            overflow: hidden;
        }
        .user-card-monitor::after {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(139, 92, 246, 0.1), transparent 70%);
            opacity: 0;
            transition: opacity 0.4s;
        }
        .user-card-monitor:hover::after {
            opacity: 1;
        }
        .user-card-monitor:hover {
            transform: translateY(-5px);
            border-color: var(--accent);
            box-shadow: 0 12px 32px rgba(139, 92, 246, 0.3);
        }
        .user-card-monitor.offline { 
            opacity: 0.35; 
            filter: grayscale(100%); 
            border: 1.5px dashed #334155; 
            background: rgba(15, 23, 42, 0.4); 
            transform: scale(0.97); 
        }
        .user-card-monitor.puro { 
            border-color: var(--puro); 
            box-shadow: 0 0 20px var(--puro-glow), 0 4px 12px rgba(0, 0, 0, 0.3); 
            animation: pulse-puro 2s ease-in-out infinite; 
            background: linear-gradient(145deg, rgba(249, 115, 22, 0.15), rgba(15, 23, 42, 0.9)); 
        }
        .user-card-monitor.bingo { 
            border-color: var(--success); 
            background: linear-gradient(145deg, rgba(16, 185, 129, 0.2), rgba(6, 78, 59, 0.9)); 
            box-shadow: 0 0 30px var(--success-glow), 0 8px 24px rgba(0, 0, 0, 0.4); 
            transform: scale(1.08) translateY(-8px); 
            z-index: 10;
            animation: bingo-pulse 1s ease-in-out infinite;
        }
        @keyframes bingo-pulse {
            0%, 100% { box-shadow: 0 0 30px var(--success-glow), 0 8px 24px rgba(0, 0, 0, 0.4); }
            50% { box-shadow: 0 0 40px var(--success-glow), 0 12px 32px rgba(0, 0, 0, 0.5); }
        }
        .monitor-badge { 
            position: absolute; 
            top: -10px; 
            right: -10px; 
            padding: 6px var(--spacing-md); 
            border-radius: var(--radius-full); 
            font-size: 10px; 
            font-weight: 900; 
            color: white; 
            display: none; 
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4); 
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
            border: 2px solid rgba(255, 255, 255, 0.2);
            animation: badge-float 2s ease-in-out infinite;
        }
        @keyframes badge-float {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-4px); }
        }
        .puro .monitor-badge { 
            display: block; 
            background: linear-gradient(135deg, var(--puro), #fb923c); 
            content: "PURO!"; 
        }
        .bingo .monitor-badge { 
            display: block; 
            background: linear-gradient(135deg, var(--success), #34d399); 
            content: "BINGO!"; 
        }
        @keyframes pulse-puro { 0% { box-shadow: 0 0 0 0 rgba(249, 115, 22, 0.4); } 70% { box-shadow: 0 0 0 10px rgba(249, 115, 22, 0); } 100% { box-shadow: 0 0 0 0 rgba(249, 115, 22, 0); } }
        .mini-bingo-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 3px; margin-top: var(--spacing-sm); }
        .mini-cell { 
            aspect-ratio: 1; 
            background: rgba(15, 23, 42, 0.8); 
            font-size: 9px; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            border-radius: 5px; 
            color: rgba(255, 255, 255, 0.3); 
            font-weight: 800;
            border: 1px solid rgba(139, 92, 246, 0.1);
            transition: all 0.2s;
        }
        .mini-cell.marked { 
            background: linear-gradient(135deg, var(--accent), var(--accent-secondary)); 
            color: white; 
            box-shadow: 0 0 8px var(--accent-glow), 
                        inset 0 1px 0 rgba(255, 255, 255, 0.3); 
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .mini-cell.hit { 
            background: linear-gradient(135deg, #fbbf24, #f59e0b); 
            color: #78350f; 
            box-shadow: 0 0 12px var(--gold-glow), 
                        inset 0 1px 0 rgba(255, 255, 255, 0.4); 
            animation: pop 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); 
            border: 1px solid rgba(255, 255, 255, 0.3);
        } 
        @keyframes pop { 0% { transform: scale(0.5); } 100% { transform: scale(1); } }
        .ball-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(45px, 1fr)); gap: var(--spacing-xs); margin-top: var(--spacing-md); }
        .ball { 
            aspect-ratio: 1; 
            background: linear-gradient(145deg, #334155, #1e293b); 
            border-radius: 50%; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            font-weight: 900; 
            cursor: pointer; 
            font-size: 15px; 
            border: 2px solid var(--glass-border); 
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); 
            box-shadow: inset 3px 3px 8px rgba(255, 255, 255, 0.08), 
                        inset -3px -3px 8px rgba(0, 0, 0, 0.5),
                        0 6px 16px rgba(0, 0, 0, 0.4); 
            position: relative;
            color: #cbd5e1;
        }
        .ball::after { 
            content: ''; 
            position: absolute; 
            top: 12%; 
            left: 18%; 
            width: 30%; 
            height: 30%; 
            background: radial-gradient(circle, rgba(255, 255, 255, 0.9), transparent); 
            border-radius: 50%; 
            opacity: 0.6; 
        }
        .ball:hover { 
            transform: translateY(-4px) scale(1.05); 
            border-color: var(--accent); 
            box-shadow: inset 3px 3px 8px rgba(255, 255, 255, 0.1), 
                        inset -3px -3px 8px rgba(0, 0, 0, 0.5),
                        0 8px 24px var(--accent-glow);
        }
        .ball.drawn { 
            background: linear-gradient(145deg, #a78bfa, #8b5cf6, #7c3aed); 
            color: white; 
            box-shadow: 0 0 20px var(--accent-glow), 
                        0 8px 24px rgba(139, 92, 246, 0.6),
                        inset -5px -5px 15px rgba(0, 0, 0, 0.3),
                        inset 5px 5px 15px rgba(255, 255, 255, 0.2); 
            border: 2px solid rgba(255, 255, 255, 0.3); 
            transform: scale(1.15); 
            animation: ball-glow 2s ease-in-out infinite;
        }
        @keyframes ball-glow {
            0%, 100% { box-shadow: 0 0 20px var(--accent-glow), 0 8px 24px rgba(139, 92, 246, 0.6); }
            50% { box-shadow: 0 0 30px var(--accent-glow), 0 12px 32px rgba(139, 92, 246, 0.8); }
        }
        .input-group { margin-bottom: var(--spacing-lg); }
        label { display: block; font-size: 11px; font-weight: 800; color: var(--text-muted); margin-bottom: var(--spacing-xs); text-transform: uppercase; letter-spacing: 0.5px; }
        input, select, textarea { 
            width: 100%; 
            background: rgba(15, 23, 42, 0.6); 
            border: 2px solid var(--glass-border); 
            padding: 16px; 
            border-radius: var(--radius-md); 
            color: white; 
            outline: none; 
            font-family: inherit; 
            font-size: 14px; 
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.2);
        }
        input:focus, select:focus, textarea:focus { 
            border-color: var(--accent); 
            background: rgba(15, 23, 42, 0.8); 
            box-shadow: 0 0 0 4px rgba(139, 92, 246, 0.15), 
                        inset 0 2px 4px rgba(0, 0, 0, 0.2);
            transform: translateY(-1px);
        }
        input:hover, select:hover, textarea:hover {
            border-color: rgba(139, 92, 246, 0.4);
        }
        .btn { 
            width: 100%; 
            padding: 16px; 
            border-radius: var(--radius-md); 
            border: none; 
            font-weight: 800; 
            cursor: pointer; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            gap: var(--spacing-xs); 
            margin-top: var(--spacing-sm); 
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); 
            text-transform: uppercase; 
            font-size: 13px; 
            letter-spacing: 0.8px; 
            position: relative; 
            overflow: hidden;
        }
        .btn::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.2);
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }
        .btn:hover::before {
            width: 300px;
            height: 300px;
        }
        .btn:active { 
            transform: scale(0.96); 
        }
        .btn-primary { 
            background: linear-gradient(135deg, #8b5cf6, #7c3aed, #6d28d9); 
            color: white; 
            box-shadow: 0 6px 20px rgba(139, 92, 246, 0.5), 
                        inset 0 1px 0 rgba(255, 255, 255, 0.2); 
        }
        .btn-primary:hover { 
            box-shadow: 0 8px 28px rgba(139, 92, 246, 0.7), 
                        inset 0 1px 0 rgba(255, 255, 255, 0.2);
            transform: translateY(-2px);
        }
        .btn-danger { 
            background: linear-gradient(135deg, #ef4444, #dc2626, #b91c1c); 
            color: white; 
            box-shadow: 0 6px 20px rgba(239, 68, 68, 0.5), 
                        inset 0 1px 0 rgba(255, 255, 255, 0.2); 
        }
        .btn-danger:hover {
            box-shadow: 0 8px 28px rgba(239, 68, 68, 0.7);
            transform: translateY(-2px);
        }
        .btn-bringme { 
            background: linear-gradient(135deg, #8b5cf6, #7c3aed, #6366f1); 
            color: white; 
            box-shadow: 0 6px 20px rgba(139, 92, 246, 0.5), 
                        inset 0 1px 0 rgba(255, 255, 255, 0.2); 
        }
        .btn-bringme:hover {
            box-shadow: 0 8px 28px rgba(139, 92, 246, 0.7);
            transform: translateY(-2px);
        }
        .btn-gold { 
            background: linear-gradient(135deg, #fbbf24, #f59e0b, #d97706); 
            color: #78350f; 
            box-shadow: 0 6px 20px rgba(251, 191, 36, 0.5), 
                        inset 0 1px 0 rgba(255, 255, 255, 0.3);
            text-shadow: 0 1px 2px rgba(255, 255, 255, 0.5);
        }
        .btn-gold:hover {
            box-shadow: 0 8px 28px rgba(251, 191, 36, 0.7);
            transform: translateY(-2px);
        }
        .online-dot { 
            width: 10px; 
            height: 10px; 
            background: var(--success); 
            border-radius: 50%; 
            box-shadow: 0 0 12px var(--success-glow), 
                        0 0 4px var(--success); 
            display: inline-block;
            animation: pulse-online 2s ease-in-out infinite;
        }
        @keyframes pulse-online {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.7; transform: scale(0.9); }
        }
        .offline-dot { 
            width: 10px; 
            height: 10px; 
            background: #475569; 
            border-radius: 50%; 
            display: inline-block; 
            border: 1.5px solid var(--glass-border); 
            opacity: 0.6;
        }
        .status-badge { 
            padding: 6px var(--spacing-md); 
            border-radius: var(--radius-full); 
            font-size: 10px; 
            font-weight: 900; 
            text-transform: uppercase;
            letter-spacing: 0.5px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        }
        .status-active { 
            background: linear-gradient(135deg, var(--success), #34d399); 
            color: white; 
            box-shadow: 0 0 15px var(--success-glow), 
                        0 2px 8px rgba(0, 0, 0, 0.2); 
        }
        .status-off { 
            background: linear-gradient(135deg, var(--danger), #dc2626); 
            color: white; 
            opacity: 0.8; 
        }
        .search-box { position: relative; margin-bottom: var(--spacing-md); }
        .search-box input { padding-right: 40px; }
        .search-icon { position: absolute; right: 14px; top: 50%; transform: translateY(-50%); color: var(--text-muted); pointer-events: none; }
        .verified-badge-inline { display: inline-flex; align-items: center; gap: 4px; padding: 2px 6px; background: rgba(59, 130, 246, 0.2); border: 1px solid #3b82f6; border-radius: 12px; font-size: 9px; font-weight: 700; color: #3b82f6; }
        .btn-verified { background: linear-gradient(135deg, #3b82f6, #2563eb); color: white; box-shadow: 0 4px 15px rgba(37, 99, 235, 0.4); }
        .btn-verified:hover { filter: brightness(1.1); }
        .grant-section { background: rgba(0,0,0,0.2); border-radius: var(--radius-md); padding: var(--spacing-lg); margin-bottom: var(--spacing-lg); border: 1px solid var(--glass-border); }
        .card { padding: var(--spacing-xl); border-radius: var(--radius-lg); margin-bottom: var(--spacing-xl); }
        h2 { margin-top: 0; font-size: 16px; font-weight: 700; display: flex; align-items: center; gap: var(--spacing-xs); margin-bottom: var(--spacing-lg); color: white; }
        .user-select-list { max-height: 250px; overflow-y: auto; background: rgba(0,0,0,0.2); border-radius: var(--radius-md); padding: 5px; border: 1px solid var(--glass-border); }
        .user-option { padding: var(--spacing-sm) var(--spacing-sm); border-radius: var(--radius-sm); cursor: pointer; font-size: 12px; display: flex; justify-content: space-between; border-bottom: 1px solid rgba(255,255,255,0.03); transition: 0.2s; }
        .user-option:hover { background: rgba(255,255,255,0.05); }
        .user-option.selected { background: var(--accent); color: white; border: none; }
        .card-settings { background: rgba(15, 23, 42, 0.4); border: 1px solid var(--glass-border); padding: var(--spacing-md); border-radius: var(--radius-md); margin-bottom: var(--spacing-sm); }
        /* Live Activity */
        .live-log-item { font-size: 11px; padding: var(--spacing-sm); border-bottom: 1px solid rgba(255,255,255,0.05); animation: flash 1s ease; }
        @keyframes flash { 0% { background: rgba(99, 102, 241, 0.3); } 100% { background: transparent; } }
        .log-pos { color: var(--success); font-weight: 700; }
        .log-neg { color: var(--danger); font-weight: 700; }
        
        /* Content Creator Styles */
        .creator-badge { 
            display: inline-flex; 
            align-items: center; 
            gap: 4px; 
            background: linear-gradient(135deg, #f59e0b, #d97706); 
            padding: 3px 10px; 
            border-radius: 12px; 
            font-size: 9px; 
            font-weight: 700; 
            text-transform: uppercase; 
            letter-spacing: 0.5px; 
            box-shadow: 0 2px 8px rgba(245, 158, 11, 0.5); 
            color: white; 
        }
        .creator-badge i { width: 12px; height: 12px; }
        .creator-card { 
            border-left: 3px solid #f59e0b !important; 
            background: linear-gradient(135deg, rgba(245, 158, 11, 0.05), rgba(0, 0, 0, 0.3)); 
        }
        .btn-creator { 
            border-color: #f59e0b; 
            background: linear-gradient(135deg, #f59e0b, #d97706); 
            box-shadow: 0 4px 12px rgba(245, 158, 11, 0.5); 
        }
        .btn-creator:hover { 
            box-shadow: 0 8px 24px rgba(245, 158, 11, 0.6); 
        }
        
        /* Post Card Styles for Creator Posts */
        .creator-post-card {
            background: linear-gradient(145deg, rgba(30, 41, 59, 0.8), rgba(15, 23, 42, 0.9));
            border: 2px solid rgba(245, 158, 11, 0.2);
            border-radius: var(--radius-lg);
            padding: var(--spacing-md);
            margin-bottom: var(--spacing-md);
            transition: all 0.3s ease;
        }
        .creator-post-card:hover {
            border-color: rgba(245, 158, 11, 0.4);
            transform: translateY(-2px);
        }
        .post-content-text {
            color: var(--text);
            margin: var(--spacing-sm) 0;
            font-size: 14px;
            line-height: 1.5;
        }
        .post-image-preview {
            width: 100%;
            max-height: 300px;
            object-fit: cover;
            border-radius: var(--radius-md);
            margin: var(--spacing-sm) 0;
        }
        .post-stats {
            display: flex;
            gap: var(--spacing-md);
            margin-top: var(--spacing-sm);
            padding-top: var(--spacing-sm);
            border-top: 1px solid rgba(255,255,255,0.05);
            font-size: 12px;
            color: var(--text-muted);
        }
        .reaction-control-panel {
            background: rgba(139, 92, 246, 0.05);
            border: 1px solid rgba(139, 92, 246, 0.2);
            border-radius: var(--radius-md);
            padding: var(--spacing-sm);
            margin-top: var(--spacing-sm);
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
        }
        .reaction-input {
            width: 80px;
            padding: 6px 10px;
            background: rgba(0,0,0,0.3);
            border: 1px solid rgba(139,92,246,0.3);
            color: white;
            border-radius: 8px;
            text-align: center;
            font-weight: 700;
        }
        .add-reaction-btn {
            padding: 6px 12px;
            background: linear-gradient(135deg, var(--accent), var(--accent-secondary));
            border: none;
            color: white;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 700;
            font-size: 11px;
            transition: all 0.3s;
        }
        .add-reaction-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px var(--accent-glow);
        }
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        
        @media (max-width: 1100px) { body { grid-template-columns: 250px 1fr; overflow-y: auto; height: auto; } .activity-panel { display: none; } }
        @media (max-width: 900px) { body { grid-template-columns: 1fr; } .sidebar { height: auto; max-height: 500px; } .tab-content { height: auto; overflow: visible; } .main-section { padding-bottom: 50px; } }
        /* ===== TOURNAMENT MANAGER STYLES ===== */
        .tourn-status-badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 10px;
            font-weight: 900;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        .t-upcoming { background: rgba(14,165,233,0.2); border:1px solid rgba(14,165,233,0.4); color: #38bdf8; }
        .t-live { background: rgba(239,68,68,0.25); border:1px solid rgba(239,68,68,0.5); color: #f87171; }
        .t-finished { background: rgba(255,255,255,0.07); border:1px solid rgba(255,255,255,0.15); color: rgba(255,255,255,0.45); }
        .tourn-admin-card {
            background: rgba(15, 23, 42, 0.5);
            border: 1px solid var(--glass-border);
            border-radius: var(--radius-md);
            padding: var(--spacing-lg);
            margin-bottom: var(--spacing-md);
            position: relative;
            overflow: hidden;
            transition: all 0.3s;
        }
        .tourn-admin-card::before {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0;
            height: 3px;
            background: linear-gradient(90deg, #fbbf24, #f59e0b, #ef4444);
        }
        .tourn-admin-card:hover { border-color: var(--accent); box-shadow: 0 4px 20px var(--accent-glow); }
        .tourn-admin-card.is-live::before { animation: gradientShift 2s ease infinite; background-size: 200% 200%; }
        .tourn-admin-card.is-live { border-color: rgba(239,68,68,0.4); box-shadow: 0 0 20px rgba(239,68,68,0.2); }
        .tourn-row { display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px; }
        .tourn-name-admin { font-size: 16px; font-weight: 900; color: white; }
        .tourn-prize-info { font-size: 22px; font-weight: 900; color: #fbbf24; }
        .tourn-meta { font-size: 11px; color: var(--text-muted); display: flex; gap: 12px; flex-wrap: wrap; margin-bottom: 12px; }
        .tourn-meta span { display: flex; align-items: center; gap: 4px; }
        .tourn-action-btns { display: flex; gap: 8px; flex-wrap: wrap; }
        .t-btn {
            padding: 8px 14px;
            border: none;
            border-radius: 8px;
            font-size: 11px;
            font-weight: 800;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 5px;
            transition: all 0.2s;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .t-btn:hover { transform: translateY(-1px); filter: brightness(1.15); }
        .t-btn.go-live { background: linear-gradient(135deg, #ef4444, #dc2626); color: white; box-shadow: 0 3px 12px rgba(239,68,68,0.4); }
        .t-btn.go-finish { background: linear-gradient(135deg, #10b981, #059669); color: white; box-shadow: 0 3px 12px rgba(16,185,129,0.4); }
        .t-btn.go-del { background: rgba(239,68,68,0.1); border: 1px solid rgba(239,68,68,0.3); color: #f87171; }
        .t-btn.go-upcoming { background: rgba(14,165,233,0.1); border: 1px solid rgba(14,165,233,0.3); color: #38bdf8; }
        .t-btn.go-view { background: rgba(139,92,246,0.1); border: 1px solid rgba(139,92,246,0.3); color: #a78bfa; }
        .t-btn.go-notify { background: linear-gradient(135deg, #8b5cf6, #7c3aed); color: white; box-shadow: 0 3px 12px rgba(139,92,246,0.4); }
        .participants-preview {
            display: flex;
            align-items: center;
            gap: -6px;
            margin-top: 8px;
        }
        .part-avatar {
            width: 26px; height: 26px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid #0f172a;
            margin-left: -6px;
        }
        .part-avatar:first-child { margin-left: 0; }
        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: var(--spacing-md); }
        .prize-breakdown {
            background: rgba(251,191,36,0.07);
            border: 1px solid rgba(251,191,36,0.2);
            border-radius: var(--radius-md);
            padding: var(--spacing-md);
            margin-bottom: var(--spacing-md);
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: var(--spacing-sm);
            text-align: center;
        }
        .prize-slot { }
        .prize-slot .p-icon { font-size: 20px; }
        .prize-slot .p-label { font-size: 9px; color: var(--text-muted); font-weight: 700; letter-spacing: 1px; text-transform: uppercase; margin-top: 2px; }
        .tourn-filter-tabs { display: flex; gap: 6px; margin-bottom: var(--spacing-md); }
        .tourn-filter-tab {
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 700;
            border: 1px solid rgba(255,255,255,0.1);
            background: none;
            color: rgba(255,255,255,0.5);
            cursor: pointer;
            transition: all 0.2s;
        }
        .tourn-filter-tab.active { background: var(--accent); border-color: transparent; color: white; }
        .winner-selector {
            background: rgba(0,0,0,0.2);
            border: 1px solid var(--glass-border);
            border-radius: var(--radius-md);
            max-height: 200px;
            overflow-y: auto;
            padding: 4px;
        }
        .winner-option {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px;
            border-radius: 8px;
            cursor: pointer;
            transition: 0.2s;
            font-size: 12px;
        }
        .winner-option:hover { background: rgba(255,255,255,0.06); }
        .winner-option.selected { background: var(--accent); }
        .winner-option img { width: 32px; height: 32px; border-radius: 50%; object-fit: cover; }
    </style>
</head>
<body>

<div id="lockScreen" style="position:fixed; inset:0; background:#0f0f14; z-index:999999; display:flex; flex-direction:column; align-items:center; justify-content:center; color:white;">
    <div style="width: 80px; height: 80px; background: rgba(255,255,255,0.1); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-bottom: 20px; box-shadow: 0 0 30px rgba(99, 102, 241, 0.3);">
        <i data-lucide="lock" style="width: 40px; height: 40px; color: var(--accent);"></i>
    </div>
    <div style="font-size:24px; font-weight:900; margin-bottom:10px; letter-spacing: -1px;">ADMIN <span style="color:var(--accent);">LOCKED</span></div>
    <p style="opacity: 0.6; font-size: 12px; margin-bottom: 30px;">Enter security PIN to access control panel.</p>
    <div style="display:flex; gap:10px;">
        <input type="password" id="adminPassInput" placeholder="Enter PIN" style="width:180px; padding:12px; text-align:center; border-radius:12px; border:1px solid #334155; background:#1e293b; color:white; font-weight:900; letter-spacing: 2px; outline: none;">
        <button onclick="checkAdminLock()" class="btn btn-primary" style="width:auto; padding:12px 20px; margin:0;"><i data-lucide="arrow-right"></i></button>
    </div>
</div>

<div class="sidebar">
    <div class="logo-text">ADMIN<span style="color:var(--accent)">PANEL</span> <span style="font-size:10px; vertical-align:middle; background:var(--gold); color:black; padding:2px 6px; border-radius:4px;">PRO</span></div>
    
    <div class="stat-grid">
        <div class="stat-card"><div class="stat-val" id="countOnline">0</div><div class="stat-lbl">ONLINE</div></div>
        <div class="stat-card"><div class="stat-val" id="countUsers">0</div><div class="stat-lbl">TOTAL</div></div>
    </div>

    <div class="card" style="padding: 15px; margin: 0; background: linear-gradient(145deg, rgba(245, 158, 11, 0.1), rgba(0,0,0,0)); border: 1px solid rgba(245, 158, 11, 0.3);">
        <label style="color:var(--gold)"><i data-lucide="trophy" style="width:12px"></i> Jackpot Prize</label>
        <input type="text" id="jackpotAmount" placeholder="e.g. 5000" style="margin-bottom:10px; text-align:center; font-weight:900; color:var(--gold); font-size:18px;">
        <div style="display:flex; align-items:center; gap:10px; cursor:pointer;" id="jackpotToggle" onclick="toggleJackpot()">
            <div style="width:44px; height:24px; background:rgba(0,0,0,0.3); border-radius:20px; position:relative; transition:0.3s;" id="jackpotKnobBg">
                <div style="width:18px; height:18px; background:white; border-radius:50%; position:absolute; top:3px; left:3px; transition:0.3s;" id="jackpotKnob"></div>
            </div>
            <span id="jackpotStatusText" style="font-size:10px; font-weight:800; color:var(--text-muted)">HIDDEN</span>
        </div>
    </div>

    <div class="card" style="padding: 15px; margin: 0; background: rgba(99, 102, 241, 0.1); border: 1px solid rgba(99, 102, 241, 0.2);">
        <label style="color:var(--accent-glow)"><i data-lucide="video" style="width:12px"></i> Video Stream Manager</label>
        <input type="text" id="videoUrlInput" placeholder="Paste YouTube Link or ID here..." style="margin-bottom:10px;">
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:8px;">
            <button class="btn btn-primary" onclick="updateVideoFeed()" style="padding: 8px;">GO LIVE</button>
            <button class="btn btn-danger" onclick="setStreamOffline()" style="padding: 8px; background:rgba(255,255,255,0.1); border:1px solid rgba(255,255,255,0.2); box-shadow:none;">GO OFFLINE</button>
        </div>
        <div style="font-size:10px; margin-top:5px; opacity:0.7;">Offline = Shows "Waiting for Live" to players.</div>
    </div>

    <!-- ===== ENHANCED AUTO SCHEDULE MANAGER ===== -->
    <div style="background:rgba(139,92,246,0.07); border:1.5px solid rgba(139,92,246,0.25); border-radius:16px; padding:14px; margin-bottom:10px;">
        <div style="font-size:12px; font-weight:900; color:var(--accent); margin-bottom:10px; display:flex; align-items:center; gap:6px; letter-spacing:0.5px;">
            <span>üïê</span> AUTO DRAW SCHEDULE
        </div>

        <!-- Jackpot Round Settings -->
        <div style="background:rgba(251,191,36,0.07); border:1px solid rgba(251,191,36,0.2); border-radius:10px; padding:10px; margin-bottom:10px;">
            <div style="font-size:10px; font-weight:800; color:#fbbf24; margin-bottom:8px; letter-spacing:0.5px;">‚ö° JACKPOT ROUNDS</div>
            <div style="display:grid; grid-template-columns:1fr 1fr; gap:6px; margin-bottom:8px;">
                <div>
                    <label style="font-size:9px; color:rgba(255,255,255,0.4); font-weight:700; text-transform:uppercase;">3:00 PM Prize</label>
                    <input type="number" id="jp3pmAmount" value="5000" min="100" style="padding:7px; font-size:12px; font-weight:900; color:#fbbf24; text-align:center; background:rgba(0,0,0,0.3); border:1px solid rgba(251,191,36,0.3); border-radius:8px;">
                </div>
                <div>
                    <label style="font-size:9px; color:rgba(255,255,255,0.4); font-weight:700; text-transform:uppercase;">8:00 PM Prize</label>
                    <input type="number" id="jp8pmAmount" value="5000" min="100" style="padding:7px; font-size:12px; font-weight:900; color:#fbbf24; text-align:center; background:rgba(0,0,0,0.3); border:1px solid rgba(251,191,36,0.3); border-radius:8px;">
                </div>
            </div>
        </div>

        <!-- Generate Button -->
        <button class="btn btn-gold" onclick="generateAutoSchedule()" style="padding:10px; font-size:11px; margin-bottom:8px;">
            <i data-lucide="calendar-plus"></i> GENERATE TODAY'S SCHEDULE (8AM‚Äì12MN)
        </button>

        <!-- Clear All -->
        <button onclick="clearAllSchedules()" style="width:100%; padding:7px; background:rgba(239,68,68,0.1); border:1px solid rgba(239,68,68,0.2); border-radius:8px; color:#ef4444; font-size:10px; font-weight:800; cursor:pointer; margin-bottom:10px;">
            üóëÔ∏è CLEAR ALL SCHEDULES
        </button>

        <!-- Manual Add -->
        <div style="font-size:10px; font-weight:800; color:rgba(255,255,255,0.4); margin-bottom:5px; letter-spacing:0.5px;">+ ADD SINGLE SCHEDULE</div>
        <div style="display: flex; gap: 8px;">
            <input type="datetime-local" id="schedInput" style="padding:8px; font-size:11px; flex:1;">
            <button class="btn btn-primary" onclick="addSchedule()" style="width: auto; margin-top: 0; padding:0 12px; font-size:11px;">+</button>
        </div>
        
        <!-- Override Panel -->
        <div style="margin-top:10px; background:rgba(6,182,212,0.06); border:1px solid rgba(6,182,212,0.2); border-radius:10px; padding:10px;">
            <div style="font-size:10px; font-weight:800; color:var(--cyan); margin-bottom:8px; letter-spacing:0.5px;">üîß JACKPOT OVERRIDE</div>
            <div style="display:flex; gap:6px; align-items:center;">
                <input type="number" id="overrideJpAmount" placeholder="Amount..." min="100" style="flex:1; padding:7px; font-size:12px; background:rgba(0,0,0,0.3); border:1px solid rgba(6,182,212,0.3); border-radius:8px; color:#fbbf24; font-weight:900;">
                <button onclick="applyJackpotOverride(true)" style="padding:7px 10px; background:rgba(16,185,129,0.2); border:1px solid rgba(16,185,129,0.4); border-radius:8px; color:#10b981; font-size:10px; font-weight:800; cursor:pointer; white-space:nowrap;">‚ö° FORCE ON</button>
                <button onclick="applyJackpotOverride(false)" style="padding:7px 10px; background:rgba(239,68,68,0.1); border:1px solid rgba(239,68,68,0.3); border-radius:8px; color:#ef4444; font-size:10px; font-weight:800; cursor:pointer; white-space:nowrap;">OFF</button>
            </div>
        </div>

        <!-- Schedule List -->
        <div id="scheduleList" style="margin-top:10px; max-height:160px; overflow-y:auto;"></div>
    </div>

    <div class="card" style="padding: 15px; background: rgba(0,0,0,0.2); flex:1; overflow:hidden; display:flex; flex-direction:column; margin:0;">
        <label>Active Users List (Online)</label>
        <div id="activeUsersList" style="flex:1; overflow-y: auto; font-size: 12px; margin-top:5px;"></div>
    </div>

    <button class="btn btn-danger" onclick="resetGame()"><i data-lucide="refresh-ccw"></i> RESET GAME</button>
</div>

<div class="main-section">
    <div id="winnerAnnounce" class="winner-marquee">
        <div class="marquee-text" id="winnerMarqueeText">MAY NANALO NA! CONGRATULATIONS SA ATING WINNER! üéâ</div>
    </div>

    <div class="tabs-nav">
        <button class="tab-btn active" onclick="openTab('bingo-tab', this)"><i data-lucide="layout-grid" width="16"></i> BINGO</button>
        <button class="tab-btn" onclick="openTab('settings-tab', this)"><i data-lucide="sliders" width="16"></i> SETTINGS</button>
        <button class="tab-btn" onclick="openTab('users-tab', this)"><i data-lucide="user-cog" width="16"></i> PLAYERS</button>
        <button class="tab-btn" onclick="openTab('creators-tab', this)"><i data-lucide="star" width="16"></i> CREATORS</button>
        <button class="tab-btn" onclick="openTab('verification-tab', this)"><i data-lucide="shield-check" width="16"></i> VERIFICATION</button>
        <button class="tab-btn" onclick="openTab('cashout-tab', this)"><i data-lucide="wallet" width="16"></i> CASHOUTS</button>
        <button class="tab-btn" onclick="openTab('support-tab', this)"><i data-lucide="message-square" width="16"></i> SUPPORT</button>
        <button class="tab-btn" onclick="openTab('tournament-tab', this)"><i data-lucide="trophy" width="16"></i> TOURNAMENTS</button>
        <button class="tab-btn" id="partnersTabBtn" onclick="openTab('partners-tab', this)"><i data-lucide="store" width="16"></i> PARTNERS <span id="partnersBadge" style="display:none;background:#ef4444;color:white;font-size:9px;font-weight:900;padding:1px 7px;border-radius:20px;margin-left:4px;vertical-align:middle;"></span></button>
        <button class="tab-btn" onclick="openTab('myshop-tab', this)"><i data-lucide="shopping-bag" width="16"></i> MY SHOP</button>
    </div>

    <div id="settings-tab" class="tab-content">
        <div class="card">
            <h2><i data-lucide="image"></i> Custom Pop-up Banner Manager</h2>
            <div class="card-settings" style="background: rgba(99, 102, 241, 0.05); border-color: var(--accent);">
                <p style="font-size:11px; opacity:0.7; margin:0 0 10px 0;">This banner will pop up when users open the app. They can click it to visit a link.</p>
                
                <label>Banner Image URL (Required)</label>
                <input type="text" id="bannerImgInput" placeholder="e.g. https://imgur.com/example.png" style="margin-bottom:10px;">
                
                <label>Target Link (Where to go when clicked)</label>
                <input type="text" id="bannerLinkInput" placeholder="e.g. https://facebook.com/mypage" style="margin-bottom:10px;">
                
                <div style="display:flex; gap:10px; margin-top:10px; align-items:center;">
                    <button class="btn btn-primary" onclick="saveBannerSettings(true)" style="margin-top:0;"><i data-lucide="save"></i> SAVE & ACTIVATE</button>
                    <button class="btn btn-danger" onclick="saveBannerSettings(false)" style="margin-top:0; background:rgba(255,255,255,0.1); border:1px solid rgba(255,255,255,0.2); box-shadow:none;">DISABLE BANNER</button>
                </div>
            </div>
        </div>

        <div class="card">
            <h2><i data-lucide="shield"></i> Service Account (Push Notifications)</h2>
            <div class="card-settings" style="background:rgba(239, 68, 68, 0.1); border-color:var(--danger);">
                <p style="font-size:11px; color:#fca5a5; margin:0 0 10px 0;"><i data-lucide="alert-triangle" style="width:12px"></i> <b>IMPORTANT:</b> The Legacy API is disabled. Paste your Firebase Service Account JSON here to enable push notifications (HTTP v1).</p>
                <textarea id="serviceAccountJson" rows="5" placeholder='Paste contents of service-account.json here...' style="font-family:monospace; font-size:10px;"></textarea>
                <button class="btn btn-primary" onclick="saveServiceAccount()">SAVE CREDENTIALS</button>
            </div>
        </div>
        <div class="card">
            <h2><i data-lucide="joystick"></i> Mini Game Probabilities</h2>
            <div class="card-settings">
                <label>Global Win Rate (%) - ALL GAMES (Roulette, Slots, Color, Dice, Lucky9, etc.)</label>
                <div style="display:flex; gap:10px; align-items:center;">
                    <input type="range" min="10" max="90" value="40" id="winRateSlider" oninput="updateSettingsUI()">
                    <span id="winRateDisplay" style="font-weight:900; width:50px;">40%</span>
                </div>
                <p style="font-size:10px; opacity:0.6;">Sets the winning chance for ALL mini games.</p>
            </div>
            <div class="card-settings">
                <label>Scatter Chance (%) - Candy Smash</label>
                <div style="display:flex; gap:10px; align-items:center;">
                    <input type="range" min="1" max="20" value="3" id="scatterSlider" oninput="updateSettingsUI()">
                    <span id="scatterDisplay" style="font-weight:900; width:50px;">3%</span>
                </div>
                <p style="font-size:10px; opacity:0.6;">Percentage chance for a Scatter (Lollipop) to appear on grid.</p>
            </div>
            <button class="btn btn-primary" onclick="saveGameSettings()">SAVE SETTINGS</button>
        </div>
    </div>

    <div id="bingo-tab" class="tab-content active">
        <div style="display:grid; grid-template-columns: 1fr 2fr; gap: 24px; align-items:start;">
            <div class="card">
                <h2><i data-lucide="settings"></i> Game Control</h2>
                <div class="input-group">
                    <label>Winning Pattern <span id="patternBadge" style="margin-left:8px; font-size:9px; background:rgba(139,92,246,0.3); color:#a78bfa; padding:2px 8px; border-radius:10px; font-weight:800; letter-spacing:0.5px;"></span></label>
                    <select id="patternSelect" onchange="setPattern(this.value)">
                        <option value="Normal Bingo">üéØ Normal Bingo (Any Line)</option>
                        <option value="Blackout">‚¨õ Blackout (All 25)</option>
                        <option value="Letter X">‚úñÔ∏è Letter X (Both Diagonals)</option>
                        <option value="Four Corners">üî≤ Four Corners</option>
                        <option value="Letter T">üî° Letter T (Top + Mid Col)</option>
                        <option value="Letter L">üî° Letter L (Left Col + Bottom)</option>
                        <option value="Letter C">üî° Letter C (Left + Top + Bottom)</option>
                        <option value="Plus Sign">‚ûï Plus / Cross</option>
                        <option value="Diamond">üíé Diamond</option>
                        <option value="Letter Z">üî° Letter Z</option>
                        <option value="Double Bingo">2Ô∏è‚É£ Double Bingo (2 Lines)</option>
                        <option value="Outside Border">üî≥ Outside Border (Frame)</option>
                    </select>
                    <div style="margin-top:8px; display:flex; gap:8px; align-items:center;">
                        <button onclick="randomizePatternForGame()" style="flex:1; padding:8px 12px; background:linear-gradient(135deg,rgba(139,92,246,0.2),rgba(99,102,241,0.2)); border:1px solid rgba(139,92,246,0.4); border-radius:10px; color:#a78bfa; font-size:11px; font-weight:800; cursor:pointer; display:flex; align-items:center; gap:6px; justify-content:center;">
                            üé≤ RANDOM PATTERN
                        </button>
                    </div>
                    <div id="patternPreviewBox" style="margin-top:8px; background:rgba(0,0,0,0.3); border:1px solid rgba(139,92,246,0.2); border-radius:12px; padding:10px; display:grid; grid-template-columns:repeat(5,1fr); gap:3px;"></div>
                </div>
                <div style="background: rgba(16, 185, 129, 0.05); border: 1px solid rgba(16, 185, 129, 0.3); padding: 15px; border-radius: 16px; margin-bottom: 20px;">
                    <label style="color:var(--success); margin-bottom:8px; display:flex; justify-content:space-between;">
                        <span>AUTO DRAW MACHINE</span>
                        <span id="speedVal" style="color:white;">8s</span>
                    </label>
                    <div style="display:flex; gap:10px; align-items:center; margin-bottom:15px;">
                        <input type="range" id="drawSpeed" min="3" max="15" value="8" style="flex:1; accent-color: var(--success);" oninput="document.getElementById('speedVal').innerText=this.value+'s'; db.ref('gameState/drawConfig').update({speed: this.value*1000})">
                    </div>
                    <button class="btn btn-primary" id="btnAutoDraw" onclick="toggleAutoDraw()" style="background: linear-gradient(135deg, #059669, #047857); box-shadow: 0 4px 15px rgba(5, 150, 105, 0.4);">
                        <i data-lucide="play"></i> START AUTO DRAW
                    </button>
                </div>
                <div class="input-group">
                    <label>Current Ball</label>
                    <div id="lastBall" style="font-size: 70px; font-weight: 900; text-align: center; color: white; background: linear-gradient(145deg, var(--accent), #1e40af); border-radius: 20px; padding: 15px; box-shadow: 0 10px 20px rgba(0,0,0,0.3); text-shadow: 0 2px 5px rgba(0,0,0,0.3); border:1px solid rgba(255,255,255,0.2);">--</div>
                </div>
                <div style="font-size:10px; font-weight:800; opacity:0.5; margin-top:20px; letter-spacing:1px;">MANUAL OVERRIDE:</div>
                <div class="ball-grid" id="ballGrid"></div>
            </div>
            <div class="card">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                    <h2><i data-lucide="users"></i> Live Cards Monitoring</h2>
                    <div style="font-size:11px; display:flex; gap:15px; font-weight:600;">
                        <span style="display:flex; align-items:center; gap:6px"><div style="width:10px; height:10px; background:var(--puro); border-radius:3px;"></div> PURO</span>
                        <span style="display:flex; align-items:center; gap:6px"><div style="width:10px; height:10px; background:var(--success); border-radius:3px;"></div> BINGO</span>
                        <span style="display:flex; align-items:center; gap:6px"><div style="width:10px; height:10px; background:#475569; border-radius:3px; border:1px solid #64748b;"></div> OFFLINE</span>
                    </div>
                </div>
                <div class="cards-grid" id="liveCardsContainer"></div>
            </div>
        </div>
    </div>
    
    <div id="users-tab" class="tab-content">
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap: 24px;">
            <div class="card">
                <h2><i data-lucide="coins"></i> Manage Points</h2>
                <div class="input-group"><label>Select User</label><div id="pointsUserList" class="user-select-list"></div><input type="hidden" id="selectedUserForPoints"></div>
                <div class="input-group"><label>Amount (+ or -)</label><input type="number" id="pointsAmount" placeholder="e.g. 500 or -500"></div>
                <button class="btn btn-primary" onclick="modifyUserPoints()">UPDATE POINTS & LOG</button>
            </div>
            <div class="card">
                <h2><i data-lucide="send"></i> Send Notification / Task</h2>
                <div class="input-group"><label>Recipient</label><select id="notifRecipient"><option value="all">ALL USERS (Include Push)</option><option value="selected">Selected User Only (From Left)</option></select></div>
                <div class="input-group"><label>Message / Announcement</label><textarea id="notifMessage" rows="5" placeholder="e.g. 5 Minutes left ‚Äî starting soon!"></textarea></div>
                <button class="btn btn-bringme" onclick="sendAdminNotification()">SEND PUSH NOTIFICATION (HTTP v1)</button>
                <div id="sendStatus" style="font-size:10px; margin-top:5px; color:var(--text-muted);"></div>
            </div>
            
            <div class="card" style="grid-column: 1 / -1;">
                <h2><i data-lucide="history"></i> Points Transaction Logs <span id="historyUserName" style="color:var(--accent); margin-left:10px;">(Select a User)</span></h2>
                <div style="font-size:11px; opacity:0.6; margin-bottom:10px;">Shows: Admin Adjustments, Cashout Refunds, and Manually Logged Events. (Game bets/wins appear in "Live Activity Feed" on the right)</div>
                <div id="pointHistoryList" style="height: 250px; overflow-y: auto; background: rgba(0,0,0,0.2); padding: 15px; border-radius: 12px; border:1px solid var(--glass-border);">
                    <div style="opacity:0.5; text-align:center; padding:20px; font-size:12px;">Select a user to view their log history.</div>
                </div>
            </div>
        </div>
    </div>

    <!-- CONTENT CREATORS TAB -->
    <div id="creators-tab" class="tab-content">
        <!-- Creator Stats Overview -->
        <div class="card">
            <h2><i data-lucide="bar-chart"></i> Creator Stats Overview</h2>
            <div class="stat-grid">
                <div class="stat-card">
                    <div class="stat-val" id="totalCreatorsCount">0</div>
                    <div class="stat-lbl">Active Creators</div>
                </div>
                <div class="stat-card">
                    <div class="stat-val" id="totalFollowers">0</div>
                    <div class="stat-lbl">Total Followers</div>
                </div>
                <div class="stat-card">
                    <div class="stat-val" id="totalVideoViews">0</div>
                    <div class="stat-lbl">Total Video Views</div>
                </div>
                <div class="stat-card">
                    <div class="stat-val" id="totalCreatorPosts">0</div>
                    <div class="stat-lbl">Creator Posts</div>
                </div>
            </div>
        </div>

        <!-- Promote to Creator -->
        <div class="card">
            <h2><i data-lucide="user-plus"></i> Promote User to Content Creator</h2>
            <div style="font-size:11px; opacity:0.6; margin-bottom:15px;">Search and promote users to become content creators with 2x points and followers</div>
            
            <div class="input-group">
                <label>Search User</label>
                <input type="text" id="promote-search" placeholder="Type user name..." oninput="searchUsersForPromotion()">
            </div>
            
            <div id="promote-results" style="max-height:300px; overflow-y:auto;">
                <div style="opacity:0.5; text-align:center; padding:20px; font-size:12px;">Start typing to search users...</div>
            </div>
        </div>

        <!-- Manage Content Creators -->
        <div class="card">
            <h2><i data-lucide="users"></i> Manage Content Creators</h2>
            <div id="creator-list" style="max-height:500px; overflow-y:auto;">
                <div style="opacity:0.5; text-align:center; padding:20px; font-size:12px;">Loading creators...</div>
            </div>
        </div>
        
        <!-- Creator Posts & Engagement Manager -->
        <div class="card">
            <h2><i data-lucide="image"></i> Creator Posts & Engagement</h2>
            <div style="font-size:11px; opacity:0.6; margin-bottom:10px;">Add real reactions & comments from actual users</div>
            <div style="background:rgba(16,185,129,0.1); border:1px solid rgba(16,185,129,0.3); border-radius:8px; padding:8px; margin-bottom:15px; font-size:10px; color:#10b981;">
                <i data-lucide="info" style="width:12px; vertical-align:middle;"></i> <strong>Real Engagement:</strong> Random users will react & comment. All includes notifications!
            </div>
            
            <div class="input-group">
                <label>Select Creator</label>
                <select id="post-creator-select" onchange="loadCreatorPosts(this.value)" style="padding:10px; background:rgba(0,0,0,0.3); border:1px solid rgba(139,92,246,0.3); color:white; border-radius:12px;">
                    <option value="">-- Select Creator --</option>
                </select>
            </div>
            
            <div id="creator-posts-container" style="max-height:600px; overflow-y:auto; margin-top:15px;">
                <div style="opacity:0.5; text-align:center; padding:40px; font-size:12px;">Select a creator to view posts</div>
            </div>
        </div>
    </div>

    <div id="verification-tab" class="tab-content">
        <!-- MANUAL GRANT SECTION -->
        <div class="card grant-section">
            <h2><i data-lucide="award"></i> Grant Verification Badge</h2>
            <div style="font-size:11px; opacity:0.6; margin-bottom:15px;">Manually grant verified badge to any user instantly</div>
            
            <div class="search-box">
                <input type="text" id="grant-user-search" placeholder="Search users by username..." oninput="searchUsersForGrant()">
                <i data-lucide="search" class="search-icon" style="width:16px;height:16px;"></i>
            </div>
            
            <div class="user-select-list" id="grant-user-list" style="max-height: 200px; margin-bottom: var(--spacing-md);">
                <div style="text-align: center; padding: 20px; color: var(--text-muted); font-size: 11px;">
                    Type to search for users...
                </div>
            </div>
            
            <button class="btn btn-verified" onclick="grantVerificationBadge()" id="grant-verify-btn" disabled>
                <i data-lucide="check-circle" style="width:16px;height:16px;"></i>
                GRANT VERIFIED BADGE
            </button>
        </div>
        
        <div class="card">
            <h2><i data-lucide="shield-check"></i> Verification Requests</h2>
            <div style="font-size:11px; opacity:0.6; margin-bottom:15px;">Review and manage user verification badge requests</div>
            
            <div style="display:flex; gap:10px; margin-bottom:15px;">
                <button class="btn btn-secondary" onclick="filterVerificationRequests('all')" id="filter-all" style="flex:1; font-size:12px; padding:8px;">All</button>
                <button class="btn btn-secondary" onclick="filterVerificationRequests('pending')" id="filter-pending" style="flex:1; font-size:12px; padding:8px; background:rgba(245, 158, 11, 0.2); border-color:rgba(245, 158, 11, 0.3);">Pending</button>
                <button class="btn btn-secondary" onclick="filterVerificationRequests('approved')" id="filter-approved" style="flex:1; font-size:12px; padding:8px;">Approved</button>
                <button class="btn btn-secondary" onclick="filterVerificationRequests('rejected')" id="filter-rejected" style="flex:1; font-size:12px; padding:8px;">Rejected</button>
            </div>
            
            <div id="verificationRequestsList" style="display:flex; flex-direction:column; gap:15px;">
                <div style="opacity:0.5; text-align:center; padding:40px; font-size:12px;">Loading verification requests...</div>
            </div>
        </div>
    </div>

    <div id="cashout-tab" class="tab-content"><div class="card"><h2><i data-lucide="wallet"></i> GCash Requests</h2><div id="cashoutList"></div></div></div>
    
    <div id="tournament-tab" class="tab-content">

        <!-- Stats Row -->
        <div class="card">
            <h2><i data-lucide="trophy"></i> Tournament Overview</h2>
            <div class="stat-grid">
                <div class="stat-card">
                    <div class="stat-val" id="t-stat-total">0</div>
                    <div class="stat-lbl">Total Tournaments</div>
                </div>
                <div class="stat-card">
                    <div class="stat-val" id="t-stat-live" style="background:linear-gradient(135deg,#ef4444,#dc2626); -webkit-background-clip:text; -webkit-text-fill-color:transparent;">0</div>
                    <div class="stat-lbl">üî¥ Live Now</div>
                </div>
                <div class="stat-card">
                    <div class="stat-val" id="t-stat-players">0</div>
                    <div class="stat-lbl">Total Registrants</div>
                </div>
                <div class="stat-card">
                    <div class="stat-val" id="t-stat-prizes" style="background:linear-gradient(135deg,#fbbf24,#f59e0b); -webkit-background-clip:text; -webkit-text-fill-color:transparent;">0</div>
                    <div class="stat-lbl">ü™ô Prizes Given</div>
                </div>
            </div>
        </div>

        <!-- Create Tournament -->
        <div class="card">
            <h2><i data-lucide="plus-circle"></i> Create New Tournament</h2>

            <div class="input-group">
                <label>Tournament Name</label>
                <input type="text" id="t-name" placeholder="e.g. Weekend Bingo Blitz üéâ">
            </div>

            <div class="form-row">
                <div class="input-group">
                    <label>Start Date & Time</label>
                    <input type="datetime-local" id="t-start">
                </div>
                <div class="input-group">
                    <label>Max Participants (0 = unlimited)</label>
                    <input type="number" id="t-max" placeholder="50" min="0" value="50">
                </div>
            </div>

            <div class="form-row">
                <div class="input-group">
                    <label>Entry Fee (RB Coins)</label>
                    <input type="number" id="t-fee" placeholder="100" min="0" value="100">
                </div>
                <div class="input-group">
                    <label>Status</label>
                    <select id="t-status">
                        <option value="upcoming">üìÖ Upcoming</option>
                        <option value="live">üî¥ Live</option>
                    </select>
                </div>
            </div>

            <label style="margin-bottom:8px; display:block;">Prize Pool Breakdown</label>
            <div class="prize-breakdown">
                <div class="prize-slot">
                    <div class="p-icon">ü•á</div>
                    <input type="number" id="t-prize1" placeholder="5000" min="0" value="5000" style="margin-top:6px; text-align:center; padding:10px; font-size:16px; font-weight:900; color:#fbbf24; background:rgba(251,191,36,0.1); border-color:rgba(251,191,36,0.3);">
                    <div class="p-label">1st Place</div>
                </div>
                <div class="prize-slot">
                    <div class="p-icon">ü•à</div>
                    <input type="number" id="t-prize2" placeholder="2000" min="0" value="2000" style="margin-top:6px; text-align:center; padding:10px; font-size:16px; font-weight:900; color:#94a3b8; background:rgba(148,163,184,0.1); border-color:rgba(148,163,184,0.3);">
                    <div class="p-label">2nd Place</div>
                </div>
                <div class="prize-slot">
                    <div class="p-icon">ü•â</div>
                    <input type="number" id="t-prize3" placeholder="1000" min="0" value="1000" style="margin-top:6px; text-align:center; padding:10px; font-size:16px; font-weight:900; color:#92400e; background:rgba(146,64,14,0.1); border-color:rgba(146,64,14,0.3);">
                    <div class="p-label">3rd Place</div>
                </div>
            </div>

            <div class="input-group">
                <label>Description / Rules (optional)</label>
                <textarea id="t-desc" rows="3" placeholder="e.g. Normal Bingo pattern only. First to BINGO wins!"></textarea>
            </div>

            <button class="btn btn-gold" onclick="createTournament()">
                <i data-lucide="trophy"></i> CREATE TOURNAMENT
            </button>
        </div>

        <!-- Manage Existing Tournaments -->
        <div class="card">
            <h2><i data-lucide="list"></i> Manage Tournaments</h2>

            <div class="tourn-filter-tabs">
                <button class="tourn-filter-tab active" onclick="filterTournaments('all', this)">All</button>
                <button class="tourn-filter-tab" onclick="filterTournaments('upcoming', this)">üìÖ Upcoming</button>
                <button class="tourn-filter-tab" onclick="filterTournaments('live', this)">üî¥ Live</button>
                <button class="tourn-filter-tab" onclick="filterTournaments('finished', this)">‚úÖ Finished</button>
            </div>

            <div id="tourn-list">
                <div style="text-align:center; padding:40px; opacity:0.4; font-size:13px;">Loading tournaments...</div>
            </div>
        </div>
    </div>
        <div class="card">
            <h2><i data-lucide="message-square"></i> Support Messages</h2>
            <div style="font-size:11px; opacity:0.6; margin-bottom:15px;">User support requests and inquiries</div>
            <div id="supportMessagesList" style="display:flex; flex-direction:column; gap:15px;">
                <div style="opacity:0.5; text-align:center; padding:40px; font-size:12px;">Loading support messages...</div>
            </div>
        </div>
    </div>

    <!-- ===== PARTNER APPLICATIONS TAB ===== -->
    <div id="partners-tab" class="tab-content">
        <div class="card">

            <!-- Header + filter bar -->
            <div style="display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:12px;margin-bottom:20px;">
                <div>
                    <h2 style="margin:0 0 4px 0;display:flex;align-items:center;gap:10px;">
                        <i data-lucide="store" style="width:20px;"></i> Partner Store Applications
                    </h2>
                    <p style="font-size:11px;opacity:0.5;margin:0;">Stores that applied to become RB Live partners</p>
                </div>
                <div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center;">
                    <button onclick="filterPA('all')"      id="paf-all"      style="padding:7px 14px;border-radius:10px;border:1px solid rgba(139,92,246,0.4);background:rgba(139,92,246,0.15);color:#a78bfa;font-weight:800;font-size:11px;cursor:pointer;">ALL <span id="pac-all">0</span></button>
                    <button onclick="filterPA('pending')"  id="paf-pending"  style="padding:7px 14px;border-radius:10px;border:1px solid rgba(251,191,36,0.4);background:rgba(251,191,36,0.1);color:#fbbf24;font-weight:800;font-size:11px;cursor:pointer;">PENDING <span id="pac-pending">0</span></button>
                    <button onclick="filterPA('approved')" id="paf-approved" style="padding:7px 14px;border-radius:10px;border:1px solid rgba(16,185,129,0.4);background:rgba(16,185,129,0.1);color:#10b981;font-weight:800;font-size:11px;cursor:pointer;">APPROVED <span id="pac-approved">0</span></button>
                    <button onclick="filterPA('rejected')" id="paf-rejected" style="padding:7px 14px;border-radius:10px;border:1px solid rgba(239,68,68,0.4);background:rgba(239,68,68,0.1);color:#ef4444;font-weight:800;font-size:11px;cursor:pointer;">REJECTED <span id="pac-rejected">0</span></button>
                    <button onclick="loadPartnerApps()" style="padding:7px 14px;border-radius:10px;border:1px solid rgba(255,255,255,0.1);background:rgba(255,255,255,0.05);color:rgba(255,255,255,0.6);font-weight:800;font-size:11px;cursor:pointer;">‚Üª Refresh</button>
                </div>
            </div>

            <!-- List -->
            <div id="partnerAppsList">
                <div style="text-align:center;padding:60px;opacity:0.35;">
                    <i data-lucide="store" style="width:42px;height:42px;display:block;margin:0 auto 14px;"></i>
                    <div style="font-size:13px;font-weight:700;">No applications yet</div>
                </div>
            </div>
        </div>
    </div>

    <!-- ===== MY SHOP TAB ===== -->
    <div id="myshop-tab" class="tab-content">

        <!-- PRODUCT MANAGEMENT -->
        <div class="card" style="margin-bottom:20px;">
            <h2><i data-lucide="package" style="width:18px;"></i> üõçÔ∏è My Shop ‚Äî Product Manager</h2>

            <!-- Add Product Form -->
            <div id="shopProductForm" style="background:rgba(139,92,246,0.06);border:1px solid rgba(139,92,246,0.2);border-radius:14px;padding:20px;margin-bottom:20px;">
                <div style="font-size:13px;font-weight:900;color:#a78bfa;margin-bottom:14px;display:flex;align-items:center;gap:8px;">
                    <span id="shopFormTitle">‚ûï ADD NEW PRODUCT</span>
                </div>
                <input type="hidden" id="shopEditKey" value="">
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:12px;">
                    <div>
                        <label style="font-size:10px;font-weight:800;color:rgba(255,255,255,0.4);letter-spacing:1px;display:block;margin-bottom:5px;text-transform:uppercase;">Product Name *</label>
                        <input id="shopPName" type="text" placeholder="e.g. Ligo Sardines" style="width:100%;background:rgba(0,0,0,0.3);border:1px solid rgba(255,255,255,0.12);border-radius:10px;padding:10px 12px;color:white;font-size:13px;outline:none;box-sizing:border-box;">
                    </div>
                    <div>
                        <label style="font-size:10px;font-weight:800;color:rgba(255,255,255,0.4);letter-spacing:1px;display:block;margin-bottom:5px;text-transform:uppercase;">Category</label>
                        <select id="shopPCategory" style="width:100%;background:rgba(0,0,0,0.6);border:1px solid rgba(255,255,255,0.12);border-radius:10px;padding:10px 12px;color:white;font-size:13px;outline:none;box-sizing:border-box;">
                            <option value="grocery">üõí Grocery</option>
                            <option value="food">üçú Food & Drinks</option>
                            <option value="snacks">üç™ Snacks</option>
                            <option value="personal">üß¥ Personal Care</option>
                            <option value="clothing">üëï Clothing / Accessories</option>
                            <option value="electronics">üì± Electronics</option>
                            <option value="school">üìö School Supplies</option>
                            <option value="other" style="background:#1e293b;">üè™ Others</option>
                        </select>
                    </div>
                    <div>
                        <label style="font-size:10px;font-weight:800;color:rgba(255,255,255,0.4);letter-spacing:1px;display:block;margin-bottom:5px;text-transform:uppercase;">Price (RB Coins) *</label>
                        <input id="shopPPrice" type="number" min="1" placeholder="e.g. 5000" style="width:100%;background:rgba(0,0,0,0.3);border:1px solid rgba(255,255,255,0.12);border-radius:10px;padding:10px 12px;color:white;font-size:13px;outline:none;box-sizing:border-box;">
                    </div>
                    <div>
                        <label style="font-size:10px;font-weight:800;color:rgba(255,255,255,0.4);letter-spacing:1px;display:block;margin-bottom:5px;text-transform:uppercase;">Delivery Fee (RB Coins)</label>
                        <input id="shopPDelivery" type="number" min="0" placeholder="e.g. 1000 (0 = free)" style="width:100%;background:rgba(0,0,0,0.3);border:1px solid rgba(255,255,255,0.12);border-radius:10px;padding:10px 12px;color:white;font-size:13px;outline:none;box-sizing:border-box;">
                    </div>
                    <div>
                        <label style="font-size:10px;font-weight:800;color:rgba(255,255,255,0.4);letter-spacing:1px;display:block;margin-bottom:5px;text-transform:uppercase;">Stock Quantity</label>
                        <input id="shopPStock" type="number" min="0" placeholder="e.g. 50" style="width:100%;background:rgba(0,0,0,0.3);border:1px solid rgba(255,255,255,0.12);border-radius:10px;padding:10px 12px;color:white;font-size:13px;outline:none;box-sizing:border-box;">
                    </div>
                    <div>
                        <label style="font-size:10px;font-weight:800;color:rgba(255,255,255,0.4);letter-spacing:1px;display:block;margin-bottom:5px;text-transform:uppercase;">Emoji / Icon</label>
                        <input id="shopPEmoji" type="text" placeholder="e.g. ü•´" maxlength="4" style="width:100%;background:rgba(0,0,0,0.3);border:1px solid rgba(255,255,255,0.12);border-radius:10px;padding:10px 12px;color:white;font-size:20px;outline:none;box-sizing:border-box;">
                    </div>
                </div>
                <div style="margin-bottom:12px;">
                    <label style="font-size:10px;font-weight:800;color:rgba(255,255,255,0.4);letter-spacing:1px;display:block;margin-bottom:5px;text-transform:uppercase;">Image URL (Optional)</label>
                    <input id="shopPImage" type="url" placeholder="https://imgur.com/yourimage.jpg" style="width:100%;background:rgba(0,0,0,0.3);border:1px solid rgba(255,255,255,0.12);border-radius:10px;padding:10px 12px;color:white;font-size:13px;outline:none;box-sizing:border-box;">
                </div>
                <div style="margin-bottom:16px;">
                    <label style="font-size:10px;font-weight:800;color:rgba(255,255,255,0.4);letter-spacing:1px;display:block;margin-bottom:5px;text-transform:uppercase;">Description</label>
                    <textarea id="shopPDesc" rows="2" placeholder="Short product description..." style="width:100%;background:rgba(0,0,0,0.3);border:1px solid rgba(255,255,255,0.12);border-radius:10px;padding:10px 12px;color:white;font-size:13px;outline:none;resize:none;box-sizing:border-box;"></textarea>
                </div>
                <div style="display:flex;gap:10px;align-items:center;">
                    <button onclick="saveShopProduct()" style="padding:11px 28px;background:linear-gradient(135deg,#8b5cf6,#6366f1);border:none;border-radius:12px;color:white;font-size:13px;font-weight:900;cursor:pointer;letter-spacing:0.5px;">üíæ SAVE PRODUCT</button>
                    <button onclick="cancelShopEdit()" id="shopCancelBtn" style="display:none;padding:11px 20px;background:rgba(255,255,255,0.07);border:1px solid rgba(255,255,255,0.15);border-radius:12px;color:rgba(255,255,255,0.6);font-size:13px;font-weight:700;cursor:pointer;">‚úï CANCEL</button>
                    <label style="display:flex;align-items:center;gap:8px;cursor:pointer;font-size:12px;font-weight:700;color:rgba(255,255,255,0.6);margin-left:auto;">
                        <input type="checkbox" id="shopPActive" checked style="width:16px;height:16px;accent-color:#8b5cf6;"> ACTIVE (visible sa store)
                    </label>
                </div>
            </div>

            <!-- Product List -->
            <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:12px;">
                <div style="font-size:11px;font-weight:900;color:rgba(255,255,255,0.35);text-transform:uppercase;letter-spacing:1px;">YOUR PRODUCTS</div>
                <button onclick="loadShopProducts()" style="padding:6px 14px;background:rgba(255,255,255,0.06);border:1px solid rgba(255,255,255,0.1);border-radius:8px;color:rgba(255,255,255,0.5);font-size:11px;font-weight:700;cursor:pointer;">‚Üª Refresh</button>
            </div>
            <div id="shopProductList">
                <div style="text-align:center;padding:40px;opacity:0.35;font-size:13px;font-weight:700;">Loading products...</div>
            </div>
        </div>

        <!-- VOUCHER MANAGEMENT -->
        <div class="card" style="margin-bottom:20px;">
            <h2><i data-lucide="tag" style="width:18px;"></i> üéüÔ∏è Voucher / Discount Codes</h2>
            <div style="background:rgba(251,191,36,0.06);border:1px solid rgba(251,191,36,0.2);border-radius:14px;padding:18px;margin-bottom:20px;">
                <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px;margin-bottom:12px;">
                    <div>
                        <label style="font-size:10px;font-weight:800;color:rgba(255,255,255,0.4);letter-spacing:1px;display:block;margin-bottom:5px;text-transform:uppercase;">Voucher Code *</label>
                        <input id="vcCode" type="text" placeholder="e.g. SALE50" style="width:100%;background:rgba(0,0,0,0.3);border:1px solid rgba(255,255,255,0.12);border-radius:10px;padding:10px 12px;color:#fbbf24;font-size:14px;font-weight:900;letter-spacing:2px;outline:none;text-transform:uppercase;box-sizing:border-box;" oninput="this.value=this.value.toUpperCase()">
                    </div>
                    <div>
                        <label style="font-size:10px;font-weight:800;color:rgba(255,255,255,0.4);letter-spacing:1px;display:block;margin-bottom:5px;text-transform:uppercase;">Discount %</label>
                        <input id="vcDiscount" type="number" min="1" max="100" placeholder="e.g. 20" style="width:100%;background:rgba(0,0,0,0.3);border:1px solid rgba(255,255,255,0.12);border-radius:10px;padding:10px 12px;color:white;font-size:13px;outline:none;box-sizing:border-box;">
                    </div>
                    <div>
                        <label style="font-size:10px;font-weight:800;color:rgba(255,255,255,0.4);letter-spacing:1px;display:block;margin-bottom:5px;text-transform:uppercase;">Min. Order (RB Coins)</label>
                        <input id="vcMinOrder" type="number" min="0" placeholder="e.g. 5000 (0 = no minimum)" style="width:100%;background:rgba(0,0,0,0.3);border:1px solid rgba(255,255,255,0.12);border-radius:10px;padding:10px 12px;color:white;font-size:13px;outline:none;box-sizing:border-box;">
                    </div>
                </div>
                <button onclick="saveShopVoucher()" style="padding:10px 24px;background:linear-gradient(135deg,#f59e0b,#d97706);border:none;border-radius:12px;color:white;font-size:13px;font-weight:900;cursor:pointer;">üéüÔ∏è ADD VOUCHER CODE</button>
            </div>
            <div id="shopVoucherList">
                <div style="text-align:center;padding:30px;opacity:0.35;font-size:13px;font-weight:700;">Loading vouchers...</div>
            </div>
        </div>

        <!-- ORDERS PANEL -->
        <div class="card">
            <h2><i data-lucide="clipboard-list" style="width:18px;"></i> üì¶ Customer Orders</h2>
            <div style="display:flex;gap:8px;margin-bottom:16px;flex-wrap:wrap;">
                <button onclick="loadShopOrders('all')" id="sob-all" style="padding:7px 16px;border-radius:10px;border:1px solid rgba(139,92,246,0.4);background:rgba(139,92,246,0.15);color:#a78bfa;font-weight:800;font-size:11px;cursor:pointer;">ALL</button>
                <button onclick="loadShopOrders('pending')" id="sob-pending" style="padding:7px 16px;border-radius:10px;border:1px solid rgba(251,191,36,0.4);background:rgba(251,191,36,0.1);color:#fbbf24;font-weight:800;font-size:11px;cursor:pointer;">PENDING</button>
                <button onclick="loadShopOrders('processing')" id="sob-processing" style="padding:7px 16px;border-radius:10px;border:1px solid rgba(6,182,212,0.4);background:rgba(6,182,212,0.1);color:#06b6d4;font-weight:800;font-size:11px;cursor:pointer;">PROCESSING</button>
                <button onclick="loadShopOrders('completed')" id="sob-completed" style="padding:7px 16px;border-radius:10px;border:1px solid rgba(16,185,129,0.4);background:rgba(16,185,129,0.1);color:#10b981;font-weight:800;font-size:11px;cursor:pointer;">COMPLETED</button>
                <button onclick="loadShopOrders('cancelled')" id="sob-cancelled" style="padding:7px 16px;border-radius:10px;border:1px solid rgba(239,68,68,0.4);background:rgba(239,68,68,0.1);color:#ef4444;font-weight:800;font-size:11px;cursor:pointer;">CANCELLED</button>
                <button onclick="loadShopOrders(_shopOrderFilter||'all')" style="padding:7px 14px;border-radius:10px;border:1px solid rgba(255,255,255,0.1);background:rgba(255,255,255,0.05);color:rgba(255,255,255,0.5);font-weight:800;font-size:11px;cursor:pointer;">‚Üª Refresh</button>
            </div>
            <div id="shopOrderList">
                <div style="text-align:center;padding:40px;opacity:0.35;font-size:13px;font-weight:700;">Loading orders...</div>
            </div>
        </div>

    </div>

</div>

<div class="activity-panel">
    <h2 style="font-size:13px; color:var(--text-muted); text-transform:uppercase; letter-spacing:1px;"><i data-lucide="activity" style="width:14px"></i> Live Activity Feed</h2>
    <p style="font-size:10px; opacity:0.5; margin-bottom:15px; border-bottom:1px solid rgba(255,255,255,0.1); padding-bottom:10px;">Monitors ALL user point changes in real-time (Games, Bets, Wins).</p>
    <div id="liveActivityFeed" style="flex:1; overflow-y:auto; display:flex; flex-direction:column; gap:5px;"></div>
</div>

<!-- Reject Verification Modal -->
<div id="rejectVerificationModal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.8); z-index:99999; justify-content:center; align-items:center;" onclick="this.style.display='none'">
    <div style="background:#1e293b; border-radius:16px; padding:24px; max-width:500px; width:90%;" onclick="event.stopPropagation()">
        <h3 style="margin:0 0 16px 0; color:white; font-size:18px;">Reject Verification Request</h3>
        <p style="color:rgba(255,255,255,0.7); font-size:13px; margin-bottom:16px;">Provide a reason for rejecting this verification request (optional):</p>
        <textarea id="rejectReasonInput" placeholder="e.g., Insufficient activity, Suspicious account..." style="width:100%; min-height:100px; padding:12px; background:rgba(0,0,0,0.3); border:1px solid rgba(255,255,255,0.1); border-radius:8px; color:white; font-family:inherit; font-size:13px; resize:vertical;"></textarea>
        <div style="display:flex; gap:12px; margin-top:20px;">
            <button onclick="document.getElementById('rejectVerificationModal').style.display='none'" style="flex:1; padding:12px; background:rgba(255,255,255,0.1); border:1px solid rgba(255,255,255,0.2); border-radius:8px; color:white; font-weight:600; cursor:pointer;">Cancel</button>
            <button onclick="confirmRejectVerification()" style="flex:1; padding:12px; background:#ef4444; border:none; border-radius:8px; color:white; font-weight:600; cursor:pointer;">Reject Request</button>
        </div>
    </div>
</div>

<script>
    // --- LOCK SCREEN LOGIC ---
    const ADMIN_PIN = "12345"; // <--- CHANGE THIS TO YOUR DESIRED PIN
    
    function checkAdminLock() {
        const val = document.getElementById('adminPassInput').value;
        if(val === ADMIN_PIN) {
            document.getElementById('lockScreen').style.opacity = '0';
            setTimeout(() => { document.getElementById('lockScreen').style.display = 'none'; }, 500);
            sessionStorage.setItem('admin_unlocked', 'true');
        } else {
            alert("WRONG PIN! ACCESS DENIED.");
            document.getElementById('adminPassInput').value = "";
        }
    }
    // Check if already unlocked in this session
    if(sessionStorage.getItem('admin_unlocked') === 'true') {
        document.getElementById('lockScreen').style.display = 'none';
    }

    lucide.createIcons();
    const firebaseConfig = { apiKey: "AIzaSyDIAQXJ15atKJxu7PtcFL1W9JnO1N14pVs", authDomain: "radiobingo-9ac29.firebaseapp.com", databaseURL: "https://radiobingo-9ac29-default-rtdb.asia-southeast1.firebasedatabase.app", projectId: "radiobingo-9ac29", storageBucket: "radiobingo-9ac29.firebasestorage.app", messagingSenderId: "965903993397", appId: "1:965903993397:web:f6646fa05225f147eebf7c" };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    
    // --- SERVICE ACCOUNT LOGIC (REQUIRED FOR HTTP V1) ---
    let serviceAccount = null;
    const savedSA = localStorage.getItem('rb_service_account');
    if(savedSA) { try { serviceAccount = JSON.parse(savedSA); document.getElementById('serviceAccountJson').value = savedSA; } catch(e) {} }
    function saveServiceAccount() {
        const val = document.getElementById('serviceAccountJson').value.trim();
        try { const json = JSON.parse(val); if(!json.private_key || !json.client_email) throw new Error("Invalid JSON"); serviceAccount = json; localStorage.setItem('rb_service_account', val); alert("Service Account Saved! Push notifications enabled."); } catch(e) { alert("Error: Invalid Service Account JSON. Please copy the whole file."); }
    }
    // (JWT Generation using jsrsasign)
    function getAccessToken() {
        return new Promise((resolve, reject) => {
            if(!serviceAccount) return reject("No Service Account Loaded");
            const now = Math.floor(Date.now() / 1000);
            const claimSet = { iss: serviceAccount.client_email, scope: "https://www.googleapis.com/auth/firebase.messaging", aud: "https://oauth2.googleapis.com/token", exp: now + 3600, iat: now };
            const sJWT = KJUR.jws.JWS.sign("RS256", JSON.stringify({alg: "RS256", typ: "JWT"}), JSON.stringify(claimSet), serviceAccount.private_key);
            fetch("https://oauth2.googleapis.com/token", { method: "POST", headers: { "Content-Type": "application/x-www-form-urlencoded" }, body: `grant_type=urn:ietf:params:oauth:grant-type:jwt-bearer&assertion=${sJWT}` }).then(r => r.json()).then(data => { if(data.access_token) resolve(data.access_token); else reject(data.error_description || "Auth Failed"); }).catch(err => reject(err));
        });
    }

    let currentPattern = "Normal Bingo"; let drawnNumbers = []; let autoDrawInterval = null; let isAutoDrawing = false; let jackpotVisible = false; let schedules = {}; let globalStatusData = {}; let allUsersData = {}; let lastSpokenNumber = null;
    let userPointsCache = {}; // For detecting live changes
    
    // === CURRENCY LOGIC (ADMIN SIDE) ===
    const COIN_TO_PHP_RATE = 1; // Must match script.js
    function formatCurrency(amount) {
        const pesoVal = (amount || 0) / COIN_TO_PHP_RATE;
        return '‚Ç±' + pesoVal.toLocaleString('en-PH', {minimumFractionDigits: 2, maximumFractionDigits: 2});
    }

    function cleanName(name) { 
        if(!name || name === 'Unknown') return "Guest"; 
        let cleaned = name.replace(/[\u4E00-\u9FFF\u3400-\u4DBF\u2000-\u206F]/g, '').trim(); 
        return cleaned || name || "Guest"; 
    }
    function openTab(tabId, btn) { document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active')); document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active')); document.getElementById(tabId).classList.add('active'); btn.classList.add('active'); }
    for(let i=1; i<=75; i++) { let b = document.createElement('div'); b.className = 'ball'; b.id = 'ball-'+i; b.innerText = i; b.onclick = () => toggleBall(i); document.getElementById('ballGrid').appendChild(b); }
    
    function updateSettingsUI() { document.getElementById('winRateDisplay').innerText = document.getElementById('winRateSlider').value + "%"; document.getElementById('scatterDisplay').innerText = document.getElementById('scatterSlider').value + "%"; }
    function saveGameSettings() { const wr = parseInt(document.getElementById('winRateSlider').value); const sc = parseInt(document.getElementById('scatterSlider').value); db.ref('gameState/settings').update({ minigameWinRate: wr, scatterChance: sc }).then(() => { alert("Settings Updated! All clients will now use these probabilities."); }); }
    db.ref('gameState/settings').once('value', s => { const val = s.val(); if(val) { document.getElementById('winRateSlider').value = val.minigameWinRate || 40; document.getElementById('scatterSlider').value = val.scatterChance || 3; updateSettingsUI(); } });

    // --- BANNER SETTINGS LOGIC ---
    function saveBannerSettings(isActive) {
        const imgUrl = document.getElementById('bannerImgInput').value.trim();
        const linkUrl = document.getElementById('bannerLinkInput').value.trim();
        
        if(isActive && !imgUrl) return alert("Please enter an Image URL if activating the banner.");

        db.ref('gameState/bannerSettings').set({
            imageUrl: imgUrl,
            targetUrl: linkUrl,
            active: isActive,
            updatedAt: Date.now()
        }).then(() => {
            alert(isActive ? "Banner Activated and Saved!" : "Banner Disabled.");
        });
    }

    // Load Banner Settings
    db.ref('gameState/bannerSettings').once('value', s => {
        const d = s.val();
        if(d) {
            document.getElementById('bannerImgInput').value = d.imageUrl || "";
            document.getElementById('bannerLinkInput').value = d.targetUrl || "";
        }
    });

    // --- VIDEO & SCHEDULE ---
    function updateVideoFeed() {
        const url = document.getElementById('videoUrlInput').value;
        if(!url) return alert("Please enter a valid YouTube Link or ID.");
        db.ref('gameState/videoSettings').set({ type: 'youtube', url: url, updatedAt: Date.now() }).then(() => { alert("Video Stream Updated Successfully! LIVE NOW."); document.getElementById('videoUrlInput').value = ""; });
    }
    function setStreamOffline() {
        if(confirm("Are you sure you want to STOP the stream and show the 'Waiting' screen?")) {
            db.ref('gameState/videoSettings').set({ type: 'offline', url: '', updatedAt: Date.now() }).then(() => { alert("Stream set to OFFLINE."); document.getElementById('videoUrlInput').value = ""; });
        }
    }
    // JACKPOT ROUND TIMES (hour in 24h)
    const JACKPOT_HOURS = [15, 20]; // 3PM and 8PM
    
    db.ref('gameState/schedules').on('value', s => { schedules = s.val() || {}; renderSchedules(); });

    function addSchedule() { 
        const input = document.getElementById('schedInput'); 
        if(!input.value) return; 
        const time = new Date(input.value).getTime(); 
        const hr = new Date(time).getHours();
        const isJP = JACKPOT_HOURS.includes(hr);
        const key = db.ref('gameState/schedules').push().key; 
        db.ref('gameState/schedules/' + key).set({ time: time, notified5min: false, notified10min: false, isJackpot: isJP }); 
        input.value = ""; 
    }

    function removeSchedule(key) { db.ref('gameState/schedules/' + key).remove(); }

    function clearAllSchedules() { 
        if(confirm("Clear ALL scheduled draws?")) { 
            db.ref('gameState/schedules').remove(); 
        } 
    }

    function generateAutoSchedule() {
        const jp3pm = parseInt(document.getElementById('jp3pmAmount').value) || 5000;
        const jp8pm = parseInt(document.getElementById('jp8pmAmount').value) || 5000;

        if(!confirm(`Generate today's full schedule?\n\n‚Ä¢ 8:00 AM ‚Üí 12:00 Midnight (every 30 mins)\n‚Ä¢ 3:00 PM Jackpot: ${jp3pm.toLocaleString()} RB Coins\n‚Ä¢ 8:00 PM Jackpot: ${jp8pm.toLocaleString()} RB Coins\n\nExisting schedules will be cleared!`)) return;

        // Clear old then write new
        db.ref('gameState/schedules').remove(() => {
            const now = new Date();
            const base = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 8, 0, 0); // 8:00 AM today
            const end  = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 24, 0, 0); // 12:00 MN

            const updates = {};
            let cursor = base.getTime();
            let count = 0;
            while(cursor <= end.getTime()) {
                const hr = new Date(cursor).getHours();
                const isJP = JACKPOT_HOURS.includes(hr);
                const jpAmt = hr === 15 ? jp3pm : (hr === 20 ? jp8pm : null);
                const key = db.ref('gameState/schedules').push().key;
                updates['gameState/schedules/' + key] = { 
                    time: cursor, 
                    notified5min: false, 
                    notified10min: false,
                    isJackpot: isJP,
                    jackpotAmount: jpAmt
                };
                cursor += 30 * 60 * 1000; // +30 minutes
                count++;
            }

            // Save jackpot override amounts for reference
            updates['gameState/autoScheduleConfig'] = { jp3pmAmount: jp3pm, jp8pmAmount: jp8pm, generatedAt: Date.now() };

            db.ref().update(updates, (err) => {
                if(err) { alert("Error: " + err.message); return; }
                
                // Push announcement to players
                const msg = `üìÖ NEW BINGO SCHEDULE!\n\nDraws every 30 minutes, 8:00 AM ‚Äì 12:00 Midnight!\n\n‚ö° JACKPOT ROUNDS:\n‚Ä¢ 3:00 PM ‚Äî ${jp3pm.toLocaleString()} RB Coins\n‚Ä¢ 8:00 PM ‚Äî ${jp8pm.toLocaleString()} RB Coins\n\nGood luck to everyone! üçÄ`;
                db.ref('gameState/scheduleAnnouncement').set({ 
                    message: msg, 
                    title: "üÜï Draw Schedule Updated!",
                    createdAt: Date.now(),
                    version: Date.now()
                });
                
                // Broadcast push notification
                sendPushToAll("üìÖ NEW BINGO SCHEDULE!", `Draws every 30 mins from 8AM to 12MN! Jackpot rounds at 3PM & 8PM. ${jp3pm.toLocaleString()} RB Coins jackpot prize!`);
                
                if(typeof addActivityItem === 'function') addActivityItem(`üìÖ Auto Schedule generated: ${count} draws (Jackpot 3PM: ${jp3pm} | 8PM: ${jp8pm})`);
                alert(`‚úÖ ${count} draw slots generated!\n\nPlayers will see an announcement popup.`);
            });
        });
    }

    function applyJackpotOverride(isOn) {
        const amount = parseInt(document.getElementById('overrideJpAmount').value) || 0;
        if(isOn && amount < 100) return alert("Enter a valid jackpot amount first!");
        db.ref('gameState/jackpot').set({ amount: isOn ? amount : 0, active: isOn });
        if(isOn) {
            sendPushToAll("‚ö° JACKPOT ROUND!", `JACKPOT is now ACTIVE! Prize: ${amount.toLocaleString()} RB Coins! Join the draw NOW! üèÜ`);
            if(typeof addActivityItem === 'function') addActivityItem(`‚ö° Jackpot OVERRIDE ON: ${amount.toLocaleString()} RB Coins`);
            // Update toggle UI
            jackpotVisible = true;
            document.getElementById('jackpotKnob').style.left = "23px";
            document.getElementById('jackpotKnobBg').style.background = "var(--success)";
            document.getElementById('jackpotStatusText').innerText = "VISIBLE";
            document.getElementById('jackpotAmount').value = amount;
        } else {
            jackpotVisible = false;
            document.getElementById('jackpotKnob').style.left = "3px";
            document.getElementById('jackpotKnobBg').style.background = "rgba(0,0,0,0.3)";
            document.getElementById('jackpotStatusText').innerText = "HIDDEN";
            if(typeof addActivityItem === 'function') addActivityItem(`üîï Jackpot override OFF`);
        }
    }

    function renderSchedules() {
        const list = document.getElementById('scheduleList'); 
        list.innerHTML = "";
        const now = Date.now();
        const sorted = Object.entries(schedules).sort(([,a], [,b]) => { 
            const tA = typeof a === 'object' ? a.time : a; 
            const tB = typeof b === 'object' ? b.time : b; 
            return tA - tB; 
        });
        // Show only future + recent (last 2)
        const future = sorted.filter(([,v]) => (typeof v === 'object' ? v.time : v) >= now - 120000);
        if(future.length === 0) { list.innerHTML = '<div style="font-size:10px; opacity:0.4; text-align:center; padding:8px;">No upcoming schedules.</div>'; return; }
        future.forEach(([key, val]) => { 
            let timeVal = typeof val === 'object' ? val.time : val; 
            const isJP = typeof val === 'object' && val.isJackpot;
            const jpAmt = typeof val === 'object' ? val.jackpotAmount : null;
            const date = new Date(timeVal); 
            const str = date.toLocaleTimeString('en-PH', {hour:'2-digit', minute:'2-digit', hour12:true}); 
            const isPast = timeVal < now;
            list.innerHTML += `
                <div style="display:flex; justify-content:space-between; align-items:center; background:${isJP ? 'rgba(251,191,36,0.1)' : 'rgba(255,255,255,0.04)'}; border:1px solid ${isJP ? 'rgba(251,191,36,0.3)' : 'rgba(255,255,255,0.05)'}; padding:6px 8px; border-radius:8px; margin-bottom:4px; font-size:11px; opacity:${isPast ? 0.4 : 1};">
                    <span style="font-weight:800; color:${isJP ? '#fbbf24' : 'white'};">
                        ${isJP ? '‚ö° ' : 'üéØ '}${str}${isJP ? ` <span style="font-size:9px; color:#fbbf24;">(${(jpAmt||5000).toLocaleString()} RB)</span>` : ''}
                    </span>
                    <button style="background:rgba(239,68,68,0.2); border:none; color:#f87171; border-radius:4px; cursor:pointer; padding:2px 6px; font-size:9px;" onclick="removeSchedule('${key}')">‚úï</button>
                </div>`;
        });
        // Show count
        const totalFuture = sorted.filter(([,v]) => (typeof v === 'object' ? v.time : v) > now).length;
        list.innerHTML += `<div style="text-align:center; font-size:9px; opacity:0.4; padding:4px; font-weight:700;">${totalFuture} more draws today</div>`;
    }

    // ===== AUTOMATED SCHEDULE CHECKER (every 5 seconds) =====
    setInterval(() => {
        const now = Date.now();
        Object.entries(schedules).forEach(([key, val]) => { 
            let time = val; 
            let notified5 = false; 
            let notified10 = false;
            let isJP = false;
            let jpAmt = null;
            if(typeof val === 'object') { 
                time = val.time; 
                notified5 = val.notified5min; 
                notified10 = val.notified10min;
                isJP = val.isJackpot || false;
                jpAmt = val.jackpotAmount || null;
            }
            
            const diff = time - now;
            
            // 10-minute warning
            if(!notified10 && diff <= 600000 && diff > 540000) { 
                const msg = isJP ? `‚ö° JACKPOT ROUND in 10 minutes! Prize: ${(jpAmt||5000).toLocaleString()} RB Coins! Get ready! üèÜ` : "‚è∞ Bingo draw in 10 minutes! Prepare your cards!";
                sendPushToAll("üéØ DRAW REMINDER", msg); 
                if(typeof val === 'object') db.ref('gameState/schedules/' + key).update({ notified10min: true }); 
            }
            
            // 5-minute warning
            if(!notified5 && diff <= 300000 && diff > 240000) { 
                const msg = isJP ? `‚ö° JACKPOT ROUND starts in 5 minutes! ${(jpAmt||5000).toLocaleString()} RB Coins on the line! üî•` : "‚ö†Ô∏è Starting in 5 minutes! The Bingo draw is about to begin!";
                sendPushToAll("üéØ DRAW ALERT", msg); 
                if(typeof val === 'object') db.ref('gameState/schedules/' + key).update({ notified5min: true }); 
            }
            
            // TIME TO DRAW
            if(now >= time && now < time + 60000) { 
                db.ref('gameState/latestWinner').once('value', w => { 
                    if(!w.exists() && !isAutoDrawing) { 
                        // Save draw speed to Firebase for headless draw engine
                        const speedMs = (document.getElementById('drawSpeed').value || 8) * 1000;
                        db.ref('gameState/drawConfig').set({ speed: speedMs });
                        // AUTO-SET JACKPOT if this is a jackpot round
                        if(isJP && jpAmt) {
                            db.ref('gameState/jackpot').set({ amount: jpAmt, active: true });
                            jackpotVisible = true;
                            document.getElementById('jackpotKnob').style.left = "23px";
                            document.getElementById('jackpotKnobBg').style.background = "var(--success)";
                            document.getElementById('jackpotStatusText').innerText = "VISIBLE";
                            document.getElementById('jackpotAmount').value = jpAmt;
                            // ‚ö° JACKPOT = BLACKOUT PATTERN
                            randomizePatternForGame(true); // Force Blackout
                            document.getElementById('patternSelect').value = "Blackout";
                            sendPushToAll("‚ö° JACKPOT ROUND STARTING!", `The JACKPOT draw is LIVE! Prize: ${jpAmt.toLocaleString()} RB Coins! Open the app NOW! üèÜüî•`);
                        } else {
                            // Turn off jackpot for normal rounds + randomize pattern
                            db.ref('gameState/jackpot').update({ active: false });
                            randomizePatternForGame(false); // Random pattern for normal rounds
                        }
                        db.ref('gameState').update({ status: 'playing', gameStartTime: Date.now() });
                        // Claim draw lock via transaction - only one client draws at a time
                        db.ref('gameState/drawLock').transaction(cur => {
                            if(cur !== null) return; // abort - someone else has it
                            return { by: 'dashboard', at: Date.now(), expires: Date.now() + 300000 };
                        }, (err, committed) => {
                            if(committed) { startAutoDrawLogic(); }
                        });
                    } 
                }); 
                removeSchedule(key); 
            } 
        });
    }, 5000);

    // --- GAME LOGIC ---
    db.ref('drawnNumbers').on('value', s => { drawnNumbers = s.val() ? Object.values(s.val()) : []; document.querySelectorAll('.ball').forEach(b => b.classList.remove('drawn')); drawnNumbers.forEach(n => document.getElementById('ball-'+n).classList.add('drawn')); updateMonitorCards(); });
    db.ref('gameState/lastCalled').on('value', s => { if(s.exists()) { const num = s.val(); document.getElementById('lastBall').innerText = num; if (num !== lastSpokenNumber) { speakNumber(num); lastSpokenNumber = num; } } else { document.getElementById('lastBall').innerText = "--"; lastSpokenNumber = null; } });
    db.ref('gameState/currentPattern').on('value', s => { currentPattern = s.val() || "Normal Bingo"; document.getElementById('patternSelect').value = currentPattern; renderPatternPreview(currentPattern); updatePatternBadge(currentPattern); updateMonitorCards(); });
    
    function toggleJackpot() { jackpotVisible = !jackpotVisible; const amount = document.getElementById('jackpotAmount').value; const knob = document.getElementById('jackpotKnob'); const bg = document.getElementById('jackpotKnobBg'); if(jackpotVisible) { knob.style.left = "23px"; bg.style.background = "var(--success)"; document.getElementById('jackpotStatusText').innerText = "VISIBLE"; db.ref('gameState/jackpot').set({ amount: amount, active: true }); } else { knob.style.left = "3px"; bg.style.background = "rgba(0,0,0,0.3)"; document.getElementById('jackpotStatusText').innerText = "HIDDEN"; db.ref('gameState/jackpot').set({ amount: amount, active: false }); } }
    db.ref('gameState/jackpot').once('value', s => { if(s.exists()){ const d = s.val(); document.getElementById('jackpotAmount').value = d.amount || ""; if(d.active) { jackpotVisible = true; document.getElementById('jackpotKnob').style.left = "23px"; document.getElementById('jackpotKnobBg').style.background = "var(--success)"; document.getElementById('jackpotStatusText').innerText = "VISIBLE"; } } });
    document.getElementById('jackpotAmount').addEventListener('input', (e) => { if(jackpotVisible) { db.ref('gameState/jackpot').update({ amount: e.target.value }); } });

    function toggleAutoDraw() { if(!isAutoDrawing) { db.ref('gameState/latestWinner').once('value', s => { if(s.exists()) { alert("May Winner Na! Reset Game muna bago mag start ulit."); return; } startAutoDrawLogic(); }); } else { stopAutoDrawLogic(); } }
    function startAutoDrawLogic() { if(isAutoDrawing) return; db.ref('gameState').update({ status: 'playing', gameStartTime: Date.now() }); const btn = document.getElementById('btnAutoDraw'); const speed = document.getElementById('drawSpeed').value * 1000; isAutoDrawing = true; btn.innerHTML = `<i data-lucide="pause"></i> STOP AUTO DRAW`; btn.style.background = "linear-gradient(135deg, #ef4444, #b91c1c)"; autoDrawLogic(); autoDrawInterval = setInterval(autoDrawLogic, speed); lucide.createIcons(); }
    function stopAutoDrawLogic() { const btn = document.getElementById('btnAutoDraw'); clearInterval(autoDrawInterval); isAutoDrawing = false; db.ref('gameState/drawLock').remove(); btn.innerHTML = `<i data-lucide="play"></i> START AUTO DRAW`; btn.style.background = "linear-gradient(135deg, #059669, #047857)"; lucide.createIcons(); }
    function autoDrawLogic() { if(drawnNumbers.length >= 75) { stopAutoDrawLogic(); autoResetGame("Lahat ng numbers na-draw!"); return; } db.ref('gameState/latestWinner').once('value', s => { if(s.exists()) { stopAutoDrawLogic(); return; } let nextNum; do { nextNum = Math.floor(Math.random() * 75) + 1; } while (drawnNumbers.includes(nextNum)); toggleBall(nextNum); }); }
    function speakNumber(num) { if ('speechSynthesis' in window) { let letter = "B"; if (num > 15) letter = "I"; if (num > 30) letter = "N"; if (num > 45) letter = "G"; if (num > 60) letter = "O"; const msg = new SpeechSynthesisUtterance(`${letter} ${num}`); msg.rate = 0.9; window.speechSynthesis.speak(msg); } }
    function toggleBall(num) { const ref = db.ref('drawnNumbers/' + num); ref.once('value', s => { if(s.exists()) { ref.remove(); } else { ref.set(num); db.ref('gameState/lastCalled').set(num); db.ref('gameState/gameStartTime').once('value', ss => { if(!ss.exists()) db.ref('gameState/gameStartTime').set(Date.now()); }); } }); }

    // --- USERS & LIVE ACTIVITY SPY ---
    db.ref('status').on('value', s => {
        globalStatusData = s.val() || {};
        // Count ONLY users with state === 'online', not just any status entry
        const trueOnlineCount = Object.values(globalStatusData).filter(u => u && u.state === 'online').length;
        document.getElementById('countOnline').innerText = trueOnlineCount;
        renderActiveUserList();
        updateMonitorCards();
    });
    function renderActiveUserList() { 
        const list = document.getElementById('activeUsersList'); 
        list.innerHTML = ""; 
        Object.entries(globalStatusData).forEach(([uid, data]) => {
            // FIXED: only show users who are actually online
            if(!data || data.state !== 'online') return;
            let displayName = "Guest"; 
            if(allUsersData[uid]) {
                displayName = allUsersData[uid].name || allUsersData[uid].username || allUsersData[uid].displayName || allUsersData[uid].email || uid.substring(0, 10);
            } else if(data.name) {
                displayName = data.name;
            }
            const safeName = cleanName(displayName); 
            list.innerHTML += `<div style="padding:6px 0; border-bottom:1px solid rgba(255,255,255,0.05); display:flex; align-items:center; gap:8px;"><span class="online-dot"></span> ${safeName}</div>`; 
        }); 
    }
    
    // THE GLOBAL SPY MONITOR
    db.ref('users').on('value', s => { 
        allUsersData = s.val() || {}; 
        document.getElementById('countUsers').innerText = s.numChildren();
        
        // 1. Update UI List
        const list = document.getElementById('pointsUserList'); 
        const currentSelected = document.getElementById('selectedUserForPoints').value; 
        list.innerHTML = ""; 
        
        s.forEach(child => { 
            const u = child.val(); 
            const uid = child.key; 
            const safeName = cleanName(u.name); 
            const currentPts = u.points || 0;
            
            // 2. LIVE ACTIVITY DETECTION
            // If we have seen this user before, compare points
            if (userPointsCache.hasOwnProperty(uid)) {
                const oldPts = userPointsCache[uid];
                if (oldPts !== currentPts) {
                    const diff = currentPts - oldPts;
                    logLiveActivity(safeName, oldPts, currentPts, diff);
                }
            }
            // Update cache
            userPointsCache[uid] = currentPts;

            const isSel = currentSelected === uid ? 'selected' : ''; 
            const div = document.createElement('div'); 
            div.className = `user-option ${isSel}`; 
            div.onclick = () => selectUserForMgmt(uid, div, safeName); 
            // UPDATED: Show PHP in Admin List
            div.innerHTML = `<span>${safeName}</span> <span>${formatCurrency(currentPts)}</span>`; 
            list.appendChild(div); 
        }); 
        
        renderActiveUserList(); 
        updateMonitorCards(); 
    });
    
    function logLiveActivity(name, oldVal, newVal, diff) {
        const feed = document.getElementById('liveActivityFeed');
        const item = document.createElement('div');
        item.className = 'live-log-item';
        const sign = diff > 0 ? '+' : '';
        const colorClass = diff > 0 ? 'log-pos' : 'log-neg';
        
        item.innerHTML = `
            <div style="display:flex; justify-content:space-between; margin-bottom:2px;">
                <span style="font-weight:700; color:white;">${name}</span>
                <span style="font-size:9px; opacity:0.6;">${new Date().toLocaleTimeString()}</span>
            </div>
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <span style="opacity:0.7;">${oldVal} ‚ûù ${newVal}</span>
                <span class="${colorClass}">${sign}${formatCurrency(diff)}</span>
            </div>
        `;
        feed.prepend(item);
        // Keep list clean (max 50)
        if(feed.children.length > 50) feed.removeChild(feed.lastChild);
    }

    function selectUserForMgmt(uid, el, name) { 
        document.querySelectorAll('.user-option').forEach(e => e.classList.remove('selected')); 
        el.classList.add('selected'); 
        document.getElementById('selectedUserForPoints').value = uid; 
        document.getElementById('historyUserName').innerText = name;
        renderUserHistory(uid);
    }
    
    function renderUserHistory(uid) {
        const list = document.getElementById('pointHistoryList');
        list.innerHTML = "<div style='text-align:center; padding:10px;'>Loading...</div>";
        
        db.ref('pointLogs/' + uid).orderByChild('timestamp').limitToLast(50).once('value', s => {
            if(!s.exists()) {
                list.innerHTML = "<div style='opacity:0.5; text-align:center; padding:20px; font-size:12px;'>No permanent logs found.<br>(Only Admin Adjustments & Cashouts are logged permanently)</div>";
                return;
            }
            list.innerHTML = "";
            let items = [];
            s.forEach(c => items.push(c.val()));
            items.reverse(); 
            
            items.forEach(log => {
                const date = new Date(log.timestamp).toLocaleString();
                const isAdd = log.amount >= 0;
                const color = isAdd ? 'var(--success)' : 'var(--danger)';
                const sign = isAdd ? '+' : '';
                
                list.innerHTML += `
                    <div style="display:flex; justify-content:space-between; align-items:center; background:rgba(255,255,255,0.05); padding:10px; border-radius:8px; margin-bottom:5px; font-size:12px;">
                        <div>
                            <div style="font-weight:700;">${log.reason || "Point Adjustment"}</div>
                            <div style="font-size:10px; opacity:0.6;">${date}</div>
                        </div>
                        <div style="color:${color}; font-weight:900;">${sign}${formatCurrency(log.amount)}</div>
                    </div>
                `;
            });
        });
    }

    function updateMonitorCards() {
        const container = document.getElementById('liveCardsContainer'); container.innerHTML = ""; let usersArray = [];
        Object.entries(allUsersData).forEach(([key, user]) => { if(user.card || user.currentCard) { usersArray.push({ ...user, uid: key }); } });
        usersArray.sort((a, b) => {
            // FIXED: check state === 'online', not just existence in status
            const aOnline = globalStatusData[a.uid] && globalStatusData[a.uid].state === 'online' ? 1 : 0;
            const bOnline = globalStatusData[b.uid] && globalStatusData[b.uid].state === 'online' ? 1 : 0;
            return bOnline - aOnline;
        });
        usersArray.forEach(user => {
            const card = user.currentCard || user.card;
            const check = checkCardStatus(card, currentPattern, drawnNumbers);
            // FIXED: must have state === 'online', not just any record in status
            const isOnline = globalStatusData[user.uid] && globalStatusData[user.uid].state === 'online';
            // Try multiple possible name fields
            const displayName = user.name || user.username || user.displayName || user.email || user.uid.substring(0, 10);
            const safeName = cleanName(displayName);
            let isBingo = check.isBingo; let isPuro = check.isPuro; if(!isOnline) { isBingo = false; isPuro = false; } else { if(user.hasWonCurrent && drawnNumbers.length > 0) isBingo = true; if(isBingo) isPuro = false; }

            // Wrapper for this user (main card + extra cards grouped)
            const userWrap = document.createElement('div');
            userWrap.style.cssText = 'display:flex; flex-direction:column; gap:4px;';

            // Main card
            const cardDiv = document.createElement('div'); cardDiv.className = `user-card-monitor ${!isOnline ? 'offline' : ''} ${isBingo ? 'bingo' : ''} ${isPuro ? 'puro' : ''}`;
            let gridHtml = '<div class="mini-bingo-grid">'; card.forEach((n, idx) => { const marked = drawnNumbers.includes(n) || n === "FREE"; const isWinningCell = check.winningCells.includes(idx); const visualHit = isOnline && isWinningCell; gridHtml += `<div class="mini-cell ${marked ? 'marked' : ''} ${visualHit ? 'hit' : ''}">${n === "FREE" ? '‚òÖ' : n}</div>`; }); gridHtml += '</div>';
            cardDiv.innerHTML = `<div class="monitor-badge">${isBingo ? "BINGO!" : "PURO!"}</div><div style="font-size:12px; font-weight:800; display:flex; justify-content:space-between; color:white; align-items:center;"><span style="display:flex; align-items:center; gap:5px;"><span class="${isOnline ? 'online-dot' : 'offline-dot'}"></span>${safeName}</span><span style="font-size:9px; background:rgba(255,255,255,0.1); padding:2px 6px; border-radius:4px;">${user.points || 0} pts</span></div>${gridHtml}`;
            userWrap.appendChild(cardDiv);

            // Extra cards
            if (user.extraCards && isOnline) {
                const extraKeys = Object.keys(user.extraCards).sort((a,b) => parseInt(a)-parseInt(b));
                extraKeys.forEach((k, ei) => {
                    const ec = user.extraCards[k];
                    if (!ec || !Array.isArray(ec)) return;
                    const ecCheck = checkCardStatus(ec, currentPattern, drawnNumbers);
                    let ecIsBingo = ecCheck.isBingo && drawnNumbers.length > 0;
                    let ecIsPuro = ecCheck.isPuro;
                    if(ecIsBingo) ecIsPuro = false;
                    const ecDiv = document.createElement('div');
                    ecDiv.className = `user-card-monitor ${ecIsBingo ? 'bingo' : ''} ${ecIsPuro ? 'puro' : ''}`;
                    ecDiv.style.cssText = 'border-top: 2px solid rgba(251,191,36,0.3); margin-top: 2px; opacity: 0.9;';
                    let ecGridHtml = '<div class="mini-bingo-grid">';
                    ec.forEach((n, idx) => {
                        const marked = drawnNumbers.includes(n) || n === "FREE";
                        const isWinningCell = ecCheck.winningCells.includes(idx);
                        const visualHit = isWinningCell;
                        ecGridHtml += `<div class="mini-cell ${marked ? 'marked' : ''} ${visualHit ? 'hit' : ''}">${n === "FREE" ? '‚òÖ' : n}</div>`;
                    });
                    ecGridHtml += '</div>';
                    ecDiv.innerHTML = `<div class="monitor-badge">${ecIsBingo ? "BINGO!" : "PURO!"}</div><div style="font-size:10px; font-weight:800; display:flex; justify-content:space-between; color:rgba(255,255,255,0.7); align-items:center; margin-bottom:4px;"><span style="display:flex; align-items:center; gap:4px;"><span style="width:6px;height:6px;border-radius:50%;background:#fbbf24;display:inline-block;"></span>Card ${parseInt(k)+2}</span></div>${ecGridHtml}`;
                    userWrap.appendChild(ecDiv);
                });
            }

            if(isBingo && isOnline) container.prepend(userWrap); else if(isPuro && isOnline) container.insertBefore(userWrap, container.children[1] || null); else container.appendChild(userWrap);
        });
    }

    function checkCardStatus(card, pattern, drawn) {
        let markedIndices = [12]; card.forEach((val, idx) => { if(drawn.includes(val) && idx !== 12) markedIndices.push(idx); });
        let patterns = [];
        if (pattern === "Blackout") { 
            patterns = [[...Array(25).keys()]]; 
        } else if (pattern === "Letter X") { 
            patterns = [[0,4,6,8,12,16,18,20,24]]; 
        } else if (pattern === "Four Corners") { 
            patterns = [[0,4,20,24]]; 
        } else if (pattern === "Letter T") { 
            // Top row + middle column
            patterns = [[0,1,2,3,4, 7,12,17,22]]; 
        } else if (pattern === "Letter L") { 
            // Left column + bottom row
            patterns = [[0,5,10,15,20, 21,22,23,24]]; 
        } else if (pattern === "Letter C") { 
            // Left col + top row + bottom row (no right side)
            patterns = [[0,1,2,3,4, 5,10,15,20, 21,22,23,24]]; 
        } else if (pattern === "Plus Sign") { 
            // Middle row + middle column
            patterns = [[10,11,12,13,14, 2,7,17,22]]; 
        } else if (pattern === "Diamond") { 
            // Diamond shape around center
            patterns = [[2, 6,8, 11,12,13, 16,18, 22]]; 
        } else if (pattern === "Letter Z") { 
            // Top row + reverse diagonal + bottom row
            patterns = [[0,1,2,3,4, 8,12,16, 20,21,22,23,24]]; 
        } else if (pattern === "Double Bingo") { 
            // Need any 2 complete lines (rows/cols/diags)
            const allLines = [
                [0,1,2,3,4],[5,6,7,8,9],[10,11,12,13,14],[15,16,17,18,19],[20,21,22,23,24],
                [0,5,10,15,20],[1,6,11,16,21],[2,7,12,17,22],[3,8,13,18,23],[4,9,14,19,24],
                [0,6,12,18,24],[4,8,12,16,20]
            ];
            const completedLines = allLines.filter(line => line.every(idx => markedIndices.includes(idx)));
            let isBingo = completedLines.length >= 2;
            // For isPuro - one complete + one line needing 1 more
            const almostLines = allLines.filter(line => {
                const hits = line.filter(idx => markedIndices.includes(idx));
                return hits.length === line.length - 1;
            });
            let isPuro = completedLines.length >= 1 && almostLines.length >= 1;
            let winningCells = isBingo ? [...new Set(completedLines.slice(0,2).flat())] : [];
            return { isBingo, isPuro, winningCells };
        } else if (pattern === "Outside Border") { 
            // All 16 cells on the border (outer frame)
            patterns = [[0,1,2,3,4, 5,9, 10,14, 15,19, 20,21,22,23,24]]; 
        } else { 
            // Normal Bingo - any line
            patterns = [[0,1,2,3,4],[5,6,7,8,9],[10,11,12,13,14],[15,16,17,18,19],[20,21,22,23,24],[0,5,10,15,20],[1,6,11,16,21],[2,7,12,17,22],[3,8,13,18,23],[4,9,14,19,24],[0,6,12,18,24],[4,8,12,16,20]]; 
        }
        let isBingo = false; let isPuro = false; let winningCells = [];
        for (let p of patterns) { const hits = p.filter(idx => markedIndices.includes(idx)); const needed = p.length; const got = hits.length; if (got === needed) { isBingo = true; winningCells = p; break; } else if (needed - got === 1) { isPuro = true; } }
        return { isBingo, isPuro, winningCells };
    }

    db.ref('gameState/latestWinner').on('value', s => {
        const marquee = document.getElementById('winnerAnnounce');
        if(s.exists()) {
            const winData = s.val(); const safeWinnerName = cleanName(winData.name);
            let msg = `üéâ BINGO WINNER: ${safeWinnerName.toUpperCase()}!`; if(winData.prize) msg += ` WON ${formatCurrency(winData.prize)}! üí∞`; else msg += ` CONGRATULATIONS! üéâ`;
            marquee.style.display = 'block'; document.getElementById('winnerMarqueeText').innerText = msg;
            if(isAutoDrawing) { stopAutoDrawLogic(); autoResetGame("May BINGO winner!"); }
        } else { marquee.style.display = 'none'; updateMonitorCards(); } 
    });

    // --- ADMIN POINTS WITH LOGGING ---
    function modifyUserPoints() { 
        const uid = document.getElementById('selectedUserForPoints').value; 
        const amount = document.getElementById('pointsAmount').value; 
        if(!uid) return alert("Select a user first!"); 
        if(!amount) return alert("Enter amount"); 
        
        const amountInt = parseInt(amount);
        
        db.ref(`users/${uid}/points`).transaction(current => (current || 0) + amountInt, (error, committed, snapshot) => {
            if (committed) {
                // Log the transaction
                db.ref(`pointLogs/${uid}`).push({
                    amount: amountInt,
                    reason: "Admin Adjustment",
                    timestamp: firebase.database.ServerValue.TIMESTAMP,
                    by: "Admin"
                });
                alert("Points updated and logged!"); 
                document.getElementById('pointsAmount').value = "";
                renderUserHistory(uid); 
            }
        }); 
    }

    async function sendPushNotification(token, title, body) {
        if(!serviceAccount) { console.error("NO SERVICE ACCOUNT"); return false; }
        try {
            const accessToken = await getAccessToken();
            const projectId = serviceAccount.project_id;
            const response = await fetch(`https://fcm.googleapis.com/v1/projects/${projectId}/messages:send`, { 
                method: 'POST', 
                headers: { 
                    'Authorization': `Bearer ${accessToken}`, 
                    'Content-Type': 'application/json' 
                }, 
                body: JSON.stringify({ 
                    message: { 
                        token: token, 
                        notification: { 
                            title: title, 
                            body: body 
                        }, 
                        webpush: { 
                            notification: { 
                                icon: 'https://i.imgur.com/7D8u8h6.png'
                            },
                            fcm_options: {
                                link: window.location.origin
                            }
                        },
                        data: {
                            url: window.location.origin
                        }
                    } 
                }) 
            });
            if(!response.ok) { const err = await response.json(); console.error("FCM Error:", err); return false; } return true;
        } catch(e) { console.error("Push Token Gen Error:", e); return false; }
    }
    
    async function sendPushToAll(title, body) { const statusEl = document.getElementById('sendStatus'); statusEl.innerText = "Sending..."; db.ref('users').once('value', async s => { const promises = []; s.forEach(u => { const user = u.val(); if(user.fcmToken) { promises.push(sendPushNotification(user.fcmToken, title, body)); } }); await Promise.all(promises); statusEl.innerText = `Sent push to devices (if available).`; }); }
    
    function sendAdminNotification() { 
        if(!serviceAccount) return alert("WARNING: Please paste your Service Account JSON in the Settings tab first!"); 
        const type = document.getElementById('notifRecipient').value; 
        const msg = document.getElementById('notifMessage').value; 
        const title = "RB LIVE ALERT"; 
        if(!msg) return alert("Enter message"); 
        
        if(type === 'selected') { 
            const uid = document.getElementById('selectedUserForPoints').value; 
            if(!uid) return alert("Select a user first!"); 
            db.ref(`notifications/${uid}`).push({ msg: msg, time: Date.now(), type: 'admin', read: false }); 
            db.ref(`users/${uid}/fcmToken`).once('value', t => { if(t.exists()) { sendPushNotification(t.val(), title, msg).then(() => alert("Sent!")); } else { alert("User has no push token (App not installed or perm denied). Sent to inbox only."); } }); 
        } else { 
            if(confirm("Send to ALL users (Push + In-App)?")) { 
                db.ref('users').once('value', s => { s.forEach(u => { db.ref(`notifications/${u.key}`).push({ msg: msg, time: Date.now(), type: 'admin', read: false }); }); }); 
                sendPushToAll(title, msg); 
                alert("Broadcast sent! (DB + Push)"); 
            } 
        } 
        document.getElementById('notifMessage').value = ""; 
    }

    function setPattern(p) { db.ref('gameState/currentPattern').set(p); renderPatternPreview(p); updatePatternBadge(p); }
    
    // ===== PATTERN PREVIEW & RANDOM PICK =====
    const ALL_GAME_PATTERNS = [
        "Normal Bingo", "Letter X", "Four Corners", "Letter T",
        "Letter L", "Letter C", "Plus Sign", "Diamond",
        "Letter Z", "Double Bingo", "Outside Border"
    ]; // Blackout is excluded ‚Äî reserved for jackpot draws only
    
    function randomizePatternForGame(forceBlackout) {
        let picked;
        if (forceBlackout) {
            picked = "Blackout";
        } else {
            picked = ALL_GAME_PATTERNS[Math.floor(Math.random() * ALL_GAME_PATTERNS.length)];
        }
        setPattern(picked);
        document.getElementById('patternSelect').value = picked;
        if(typeof addActivityItem === 'function') addActivityItem(`üé≤ Pattern randomized: ${picked}`);
        // Show a brief notification
        const badge = document.getElementById('patternBadge');
        if(badge) { badge.innerText = 'üé≤ RANDOMLY PICKED!'; badge.style.background = 'rgba(251,191,36,0.3)'; badge.style.color = '#fbbf24'; setTimeout(() => { badge.innerText = ''; }, 3000); }
    }
    
    function updatePatternBadge(p) {
        const badge = document.getElementById('patternBadge');
        if(badge && p === 'Blackout') { badge.innerText = '‚ö° JACKPOT PATTERN'; badge.style.background = 'rgba(251,191,36,0.3)'; badge.style.color = '#fbbf24'; }
        else if(badge) { badge.innerText = ''; }
    }
    
    function renderPatternPreview(p) {
        const box = document.getElementById('patternPreviewBox');
        if(!box) return;
        
        // Define which cells are highlighted per pattern
        const patternCells = {
            "Normal Bingo": [0,1,2,3,4], // show first line as example
            "Blackout": [...Array(25).keys()],
            "Letter X": [0,4,6,8,12,16,18,20,24],
            "Four Corners": [0,4,20,24],
            "Letter T": [0,1,2,3,4,7,12,17,22],
            "Letter L": [0,5,10,15,20,21,22,23,24],
            "Letter C": [0,1,2,3,4,5,10,15,20,21,22,23,24],
            "Plus Sign": [2,7,10,11,12,13,14,17,22],
            "Diamond": [2,6,8,11,12,13,16,18,22],
            "Letter Z": [0,1,2,3,4,8,12,16,20,21,22,23,24],
            "Double Bingo": [0,1,2,3,4,5,6,7,8,9], // show 2 rows
            "Outside Border": [0,1,2,3,4,5,9,10,14,15,19,20,21,22,23,24]
        };
        const letters = ['B','I','N','G','O'];
        const highlighted = patternCells[p] || [];
        box.innerHTML = '';
        for(let i = 0; i < 25; i++) {
            const col = i % 5;
            const isHit = highlighted.includes(i);
            const isFree = i === 12;
            const cell = document.createElement('div');
            cell.style.cssText = `aspect-ratio:1; border-radius:4px; display:flex; align-items:center; justify-content:center; font-size:8px; font-weight:800;
                background:${isHit ? 'linear-gradient(135deg, #8b5cf6, #6366f1)' : 'rgba(255,255,255,0.04)'};
                color:${isHit ? 'white' : 'rgba(255,255,255,0.15)'};
                border:1px solid ${isHit ? 'rgba(139,92,246,0.5)' : 'rgba(255,255,255,0.05)'};
                box-shadow:${isHit ? '0 0 6px rgba(139,92,246,0.4)' : 'none'};`;
            cell.innerText = isFree ? '‚òÖ' : letters[col];
            box.appendChild(cell);
        }
    }
    function resetGame() {
        if(confirm("WARNING: Reset entire board?")){
            db.ref('drawnNumbers').remove(); db.ref('gameState/latestWinner').remove(); db.ref('gameState/winners').remove(); db.ref('gameState/gameStartTime').remove(); db.ref('gameState/lastCalled').remove();
            db.ref('gameState').update({ status: 'waiting' });
            db.ref('users').once('value', s => { let updates = {}; s.forEach(u => { updates[u.key + '/hasWonCurrent'] = false; }); db.ref('users').update(updates); });
            stopAutoDrawLogic(); setTimeout(updateMonitorCards, 500); document.getElementById('lastBall').innerText = "--"; lastSpokenNumber = null;
            // Randomize pattern for next game
            randomizePatternForGame(false);
        }
    }

    // AUTO RESET ‚Äî called automatically when a winner is found OR all numbers are drawn
    let autoResetTimer = null;
    function autoResetGame(reason) {
        // Prevent duplicate timers
        if(autoResetTimer) return;
        const DELAY = 5000; // 5 seconds
        if(typeof addActivityItem === 'function') addActivityItem('üîÑ ' + reason + ' Auto-reset in 5 seconds...');
        autoResetTimer = setTimeout(function() {
            autoResetTimer = null;
            stopAutoDrawLogic();
            db.ref('drawnNumbers').remove();
            db.ref('gameState/latestWinner').remove();
            db.ref('gameState/winners').remove();
            db.ref('gameState/gameStartTime').remove();
            db.ref('gameState/lastCalled').remove();
            db.ref('gameState').update({ status: 'waiting' });
            db.ref('users').once('value', function(s) {
                let updates = {};
                s.forEach(function(u) { updates[u.key + '/hasWonCurrent'] = false; });
                db.ref('users').update(updates);
            });
            setTimeout(updateMonitorCards, 500);
            document.getElementById('lastBall').innerText = "--";
            lastSpokenNumber = null;
            // Randomize pattern for next game (non-jackpot)
            randomizePatternForGame(false);
            if(typeof addActivityItem === 'function') addActivityItem('‚úÖ Game auto-reset complete. Ready for next draw!');
        }, DELAY);
    }

    db.ref('redemptions').on('value', s => {
        const list = document.getElementById('cashoutList'); list.innerHTML = "";
        s.forEach(child => {
            const r = child.val(); const key = child.key; if(r.status !== 'pending') return;
            const safeName = cleanName(r.name);
            const div = document.createElement('div'); div.className = 'card'; div.style.padding = "15px"; div.style.marginBottom = "10px";
            div.innerHTML = `<div style="display:flex; justify-content:space-between; align-items:center;"><div><div style="font-weight:800;">${safeName} - <span style="color:var(--gold)">${r.item}</span></div><div style="font-size:11px; opacity:0.6;">GCash: ${r.gcash}</div></div><div style="display:flex; gap:10px;"><button class=\"btn btn-primary\" style=\"width:auto; padding:8px 20px\" onclick=\"updateStatus('${key}', 'sent', ${JSON.stringify(r).replace(/"/g, '&quot;')})\">PAID</button><button class=\"btn btn-danger\" style=\"width:auto; padding:8px 20px\" onclick=\"updateStatus('${key}', 'denied', ${JSON.stringify(r).replace(/"/g, '&quot;')})\">X</button></div></div>`;
            list.prepend(div);
        });
    });

    function updateStatus(key, status, data) {
        if(confirm(`${status} this?`)) {
            db.ref('redemptions/' + key).update({ status: status });
            const statusMsg = status === 'sent' ? `Your ${data.item} has been sent! ÓÅûÈ†Ç` : `Your ${data.item} was denied. Á¨∂ÂΩ¢`;
            db.ref('notifications/' + data.uid).push({ msg: statusMsg, time: Date.now() });
            
            // Refund points if denied
            if(status === 'denied') {
                db.ref('users/' + data.uid + '/points').transaction(p => (p || 0) + data.cost, (err, committed) => {
                     if(committed) {
                         db.ref(`pointLogs/${data.uid}`).push({
                             amount: data.cost,
                             reason: `Refund: ${data.item}`,
                             timestamp: firebase.database.ServerValue.TIMESTAMP,
                             by: "System/Admin"
                         });
                         if(document.getElementById('selectedUserForPoints').value === data.uid) {
                             renderUserHistory(data.uid);
                         }
                     }
                 });
            }
        }
    }

    // === UTILITY: HTML ESCAPING ===
    function escapeHtml(text) {
        if (!text) return '';
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    // === SUPPORT MESSAGES ===
    db.ref('supportMessages').on('value', s => {
        const list = document.getElementById('supportMessagesList');
        list.innerHTML = "";
        
        if(!s.exists()) {
            list.innerHTML = '<div style="opacity:0.5; text-align:center; padding:40px; font-size:12px;">No support messages yet.</div>';
            return;
        }
        
        const messages = [];
        s.forEach(child => {
            messages.push({ key: child.key, ...child.val() });
        });
        
        // Sort by timestamp, newest first
        messages.sort((a, b) => b.timestamp - a.timestamp);
        
        messages.forEach(msg => {
            const statusColor = msg.status === 'open' ? 'var(--gold)' : 'var(--success)';
            const statusText = msg.status === 'open' ? 'OPEN' : 'RESOLVED';
            const date = new Date(msg.timestamp).toLocaleString();
            
            const div = document.createElement('div');
            div.className = 'card';
            div.style.padding = "15px";
            div.style.marginBottom = "10px";
            div.style.background = msg.status === 'open' ? 'rgba(251, 191, 36, 0.05)' : 'rgba(0,0,0,0.2)';
            div.style.borderLeft = `3px solid ${statusColor}`;
            
            div.innerHTML = `
                <div style="display:flex; justify-content:space-between; align-items:flex-start; margin-bottom:10px;">
                    <div style="display:flex; gap:10px; align-items:center;">
                        <img src="${msg.userPhoto || 'https://via.placeholder.com/40'}" style="width:40px; height:40px; border-radius:50%; object-fit:cover;">
                        <div>
                            <div style="font-weight:800; font-size:13px;">${escapeHtml(msg.userName)}</div>
                            <div style="font-size:10px; opacity:0.6;">${date}</div>
                        </div>
                    </div>
                    <div style="font-size:10px; font-weight:800; color:${statusColor}; text-transform:uppercase; border:1px solid ${statusColor}; padding:4px 8px; border-radius:6px;">
                        ${statusText}
                    </div>
                </div>
                <div style="margin-bottom:8px;">
                    <div style="font-weight:700; font-size:12px; color:var(--accent-glow); margin-bottom:5px;">Subject: ${escapeHtml(msg.subject)}</div>
                    <div style="font-size:12px; line-height:1.5; color:#cbd5e1;">${escapeHtml(msg.message)}</div>
                </div>
                <div style="font-size:10px; opacity:0.6; margin-top:8px; padding-top:8px; border-top:1px solid rgba(255,255,255,0.05);">
                    Contact: ${escapeHtml(msg.userEmail)}
                </div>
                <div style="display:flex; gap:10px; margin-top:10px;">
                    <button class="btn btn-primary reply-support-btn" 
                        style="width:auto; padding:8px 20px; font-size:11px; background:var(--accent); border-color:var(--accent);"
                        data-msg-key="${msg.key}" 
                        data-uid="${msg.uid}" 
                        data-username="${escapeHtml(msg.userName)}">
                        <i data-lucide="reply" width="14"></i> REPLY
                    </button>
                    ${msg.status === 'open' ? `
                        <button class="btn btn-primary resolve-support-btn" 
                            style="width:auto; padding:8px 20px; font-size:11px;"
                            data-msg-key="${msg.key}" 
                            data-uid="${msg.uid}">MARK RESOLVED</button>
                    ` : ''}
                    <button class="btn btn-danger delete-support-btn" 
                        style="width:auto; padding:8px 20px; font-size:11px;"
                        data-msg-key="${msg.key}">DELETE</button>
                </div>
            `;
            
            list.appendChild(div);
            
            // Add event listeners using data attributes
            const replyBtn = div.querySelector('.reply-support-btn');
            if (replyBtn) {
                replyBtn.addEventListener('click', function() {
                    replySupportMessage(
                        this.dataset.msgKey, 
                        this.dataset.uid, 
                        this.dataset.username
                    );
                });
            }
            
            const resolveBtn = div.querySelector('.resolve-support-btn');
            if (resolveBtn) {
                resolveBtn.addEventListener('click', function() {
                    resolveSupportMessage(this.dataset.msgKey, this.dataset.uid);
                });
            }
            
            const deleteBtn = div.querySelector('.delete-support-btn');
            if (deleteBtn) {
                deleteBtn.addEventListener('click', function() {
                    deleteSupportMessage(this.dataset.msgKey);
                });
            }
        });
        
        lucide.createIcons();
    });

    function resolveSupportMessage(key, uid) {
        if(confirm('Mark this message as resolved?')) {
            db.ref('supportMessages/' + key).update({ status: 'resolved' });
            
            // Send notification to user
            db.ref('notifications/' + uid).push({
                msg: 'Your support request has been resolved. Thank you!',
                time: Date.now(),
                type: 'support'
            });
        }
    }

    function deleteSupportMessage(key) {
        if(confirm('Delete this support message?')) {
            db.ref('supportMessages/' + key).remove();
        }
    }

    function replySupportMessage(key, uid, userName) {
        const reply = prompt(`Reply to ${userName}:`);
        if (!reply || reply.trim() === '') {
            return;
        }
        
        // Sanitize the reply to prevent any injection issues
        const sanitizedReply = reply.trim().substring(0, 500); // Limit length
        
        // Send notification to user
        db.ref('notifications/' + uid).push({
            msg: `Admin replied to your support request: "${sanitizedReply}"`,
            time: Date.now(),
            type: 'support_reply'
        }).then(() => {
            alert('Reply sent successfully!');
        }).catch(err => {
            console.error('Error sending reply:', err);
            alert('Failed to send reply');
        });
    }

    // === VERIFICATION REQUEST MANAGEMENT ===
    let currentVerificationFilter = 'all';
    let pendingRejectUid = null; // Store UID for rejection confirmation
    
    function loadVerificationRequests() {
        db.ref('users').once('value', snapshot => {
            const requests = [];
            snapshot.forEach(userSnap => {
                const user = userSnap.val();
                const uid = userSnap.key;
                
                if (user.verificationStatus || user.verified) {
                    // Try multiple possible name fields
                    const displayName = user.name || user.username || user.displayName || user.email || uid.substring(0, 12);
                    
                    requests.push({
                        uid: uid,
                        name: displayName,
                        photo: user.photo || 'https://via.placeholder.com/60',
                        reason: user.verificationReason || 'No reason provided',
                        status: user.verified ? 'approved' : (user.verificationStatus || 'none'),
                        requestedAt: user.verificationRequestedAt || 0,
                        points: user.points || 0,
                        bingoWins: user.bingoWins || 0
                    });
                }
            });
            
            // Sort by requested date (newest first)
            requests.sort((a, b) => b.requestedAt - a.requestedAt);
            
            renderVerificationRequests(requests);
        });
    }
    
    function filterVerificationRequests(filter) {
        currentVerificationFilter = filter;
        
        // Update button styles
        document.querySelectorAll('#verification-tab button[id^="filter-"]').forEach(btn => {
            btn.style.background = 'rgba(255,255,255,0.05)';
            btn.style.borderColor = 'rgba(255,255,255,0.1)';
        });
        
        const activeBtn = document.getElementById('filter-' + filter);
        if (activeBtn) {
            activeBtn.style.background = 'rgba(59, 130, 246, 0.2)';
            activeBtn.style.borderColor = 'rgba(59, 130, 246, 0.3)';
        }
        
        loadVerificationRequests();
    }
    
    function renderVerificationRequests(requests) {
        const list = document.getElementById('verificationRequestsList');
        list.innerHTML = '';
        
        // Filter requests based on current filter
        const filtered = requests.filter(req => {
            if (currentVerificationFilter === 'all') return true;
            if (currentVerificationFilter === 'pending') return req.status === 'pending';
            if (currentVerificationFilter === 'approved') return req.status === 'approved';
            if (currentVerificationFilter === 'rejected') return req.status === 'rejected';
            return true;
        });
        
        if (filtered.length === 0) {
            list.innerHTML = '<div style="opacity:0.5; text-align:center; padding:40px; font-size:12px;">No verification requests found.</div>';
            return;
        }
        
        filtered.forEach(req => {
            const statusColors = {
                'pending': { bg: 'rgba(245, 158, 11, 0.15)', border: 'rgba(245, 158, 11, 0.3)', text: '#f59e0b', label: '‚è≥ Pending' },
                'approved': { bg: 'rgba(16, 185, 129, 0.15)', border: 'rgba(16, 185, 129, 0.3)', text: '#10b981', label: '‚úì Approved' },
                'rejected': { bg: 'rgba(239, 68, 68, 0.15)', border: 'rgba(239, 68, 68, 0.3)', text: '#ef4444', label: '‚úó Rejected' }
            };
            
            const statusStyle = statusColors[req.status] || statusColors.pending;
            const dateStr = req.requestedAt ? new Date(req.requestedAt).toLocaleString() : 'Unknown';
            
            const div = document.createElement('div');
            div.style.cssText = `
                background: rgba(255, 255, 255, 0.02);
                border: 1px solid rgba(255, 255, 255, 0.1);
                border-radius: 12px;
                padding: 16px;
            `;
            
            div.innerHTML = `
                <div style="display:flex; gap:12px; align-items:start;">
                    <img src="${escapeHtml(req.photo)}" 
                        style="width:50px; height:50px; border-radius:50%; object-fit:cover; border:2px solid rgba(255,255,255,0.1);">
                    <div style="flex:1; min-width:0;">
                        <div style="display:flex; align-items:center; gap:8px; margin-bottom:4px;">
                            <div style="font-weight:700; color:white; font-size:14px;">${escapeHtml(req.name)}</div>
                            <div style="font-size:10px; padding:2px 8px; border-radius:12px; background:${statusStyle.bg}; border:1px solid ${statusStyle.border}; color:${statusStyle.text}; font-weight:600;">
                                ${statusStyle.label}
                            </div>
                        </div>
                        <div style="font-size:11px; color:rgba(255,255,255,0.5); margin-bottom:8px;">
                            <span title="${req.uid}">UID: ${req.uid.substring(0,8)}</span> ‚Ä¢ ${req.bingoWins} wins ‚Ä¢ ${req.points} pts
                        </div>
                        <div style="font-size:12px; color:rgba(255,255,255,0.7); background:rgba(0,0,0,0.2); padding:10px; border-radius:8px; margin-bottom:8px;">
                            <strong>Reason:</strong> ${escapeHtml(req.reason)}
                        </div>
                        <div style="font-size:10px; opacity:0.5;">
                            Requested: ${dateStr}
                        </div>
                        ${req.status === 'pending' ? `
                            <div style="display:flex; gap:8px; margin-top:12px;">
                                <button class="btn btn-primary" 
                                    onclick="approveVerificationRequest('${req.uid}')"
                                    style="flex:1; padding:8px; font-size:11px; background:#10b981; border-color:#10b981;">
                                    <i data-lucide="check" width="14"></i> APPROVE
                                </button>
                                <button class="btn btn-danger" 
                                    onclick="rejectVerificationRequest('${req.uid}')"
                                    style="flex:1; padding:8px; font-size:11px;">
                                    <i data-lucide="x" width="14"></i> REJECT
                                </button>
                            </div>
                        ` : req.status === 'approved' ? `
                            <div style="display:flex; gap:8px; margin-top:12px;">
                                <button class="btn btn-danger" 
                                    onclick="revokeVerification('${req.uid}')"
                                    style="flex:1; padding:8px; font-size:11px;">
                                    <i data-lucide="shield-off" width="14"></i> REVOKE VERIFICATION
                                </button>
                            </div>
                        ` : ''}
                    </div>
                </div>
            `;
            
            list.appendChild(div);
        });
        
        lucide.createIcons();
    }
    
    function approveVerificationRequest(uid) {
        if (!confirm('Approve this verification request?')) return;
        
        db.ref('users/' + uid).update({
            verified: true,
            verificationStatus: 'approved',
            verificationApprovedAt: Date.now()
        }).then(() => {
            // Send notification to user
            db.ref('notifications/' + uid).push({
                msg: '‚úì Your verification request has been approved! You now have a verification badge.',
                time: Date.now(),
                type: 'verification_approved'
            });
            
            alert('Verification approved!');
            loadVerificationRequests();
        }).catch(err => {
            console.error('Error approving verification:', err);
            alert('Failed to approve verification');
        });
    }
    
    function rejectVerificationRequest(uid) {
        pendingRejectUid = uid;
        document.getElementById('rejectReasonInput').value = '';
        document.getElementById('rejectVerificationModal').style.display = 'flex';
    }
    
    function confirmRejectVerification() {
        if (!pendingRejectUid) return;
        
        const reason = document.getElementById('rejectReasonInput').value.trim() || 'No reason provided';
        
        db.ref('users/' + pendingRejectUid).update({
            verified: false,
            verificationStatus: 'rejected',
            verificationRejectedAt: Date.now(),
            verificationRejectionReason: reason
        }).then(() => {
            // Send notification to user
            db.ref('notifications/' + pendingRejectUid).push({
                msg: `‚úó Your verification request has been rejected. ${reason !== 'No reason provided' ? 'Reason: ' + reason : ''}`,
                time: Date.now(),
                type: 'verification_rejected'
            });
            
            alert('Verification rejected.');
            document.getElementById('rejectVerificationModal').style.display = 'none';
            pendingRejectUid = null;
            loadVerificationRequests();
        }).catch(err => {
            console.error('Error rejecting verification:', err);
            alert('Failed to reject verification');
        });
    }
    
    function revokeVerification(uid) {
        if (!confirm('Revoke verification badge from this user?')) return;
        
        db.ref('users/' + uid).update({
            verified: false,
            verificationStatus: 'revoked',
            verificationRevokedAt: Date.now()
        }).then(() => {
            // Send notification to user
            db.ref('notifications/' + uid).push({
                msg: '‚ö†Ô∏è Your verification badge has been revoked by an admin.',
                time: Date.now(),
                type: 'verification_revoked'
            });
            
            alert('Verification revoked.');
            loadVerificationRequests();
        }).catch(err => {
            console.error('Error revoking verification:', err);
            alert('Failed to revoke verification');
        });
    }
    
    // MANUAL GRANT FUNCTIONS
    let selectedGrantUser = null;
    
    function searchUsersForGrant() {
        const searchTerm = document.getElementById('grant-user-search').value.toLowerCase().trim();
        const list = document.getElementById('grant-user-list');
        const grantBtn = document.getElementById('grant-verify-btn');
        
        // Show loading indicator
        list.innerHTML = '<div style="text-align: center; padding: 20px; color: var(--text-muted); font-size: 11px;">üîç Loading users...</div>';
        
        db.ref('users').once('value').then(snap => {
            const users = snap.val() || {};
            list.innerHTML = '';
            let found = false;
            
            // Check if database has users
            if (Object.keys(users).length === 0) {
                list.innerHTML = '<div style="text-align: center; padding: 20px; color: var(--text-muted); font-size: 11px;">No users found in database</div>';
                return;
            }
            
            Object.entries(users).forEach(([uid, user]) => {
                // Try multiple possible username fields
                const displayName = user.username || user.displayName || user.name || user.email || uid;
                const searchableText = displayName.toLowerCase();
                
                // Show all users if search is empty, otherwise filter
                if (!searchTerm || searchableText.includes(searchTerm)) {
                    found = true;
                    const div = document.createElement('div');
                    div.className = 'user-option';
                    if (selectedGrantUser === uid) div.classList.add('selected');
                    
                    const verifiedBadge = user.verified ? '<span class="verified-badge-inline"><i data-lucide="check-circle" style="width:10px;height:10px;"></i> Verified</span>' : '';
                    const statusDot = (globalStatusData[uid] && globalStatusData[uid].state === 'online') ? '<span class="online-dot"></span>' : '<span class="offline-dot"></span>';
                    
                    // Show UID in small text if no proper name
                    const uidText = (!user.username && !user.displayName && !user.name && !user.email) 
                        ? `<br><span style="font-size: 9px; color: var(--text-muted);">ID: ${uid.substring(0, 12)}...</span>` 
                        : '';
                    
                    div.innerHTML = `
                        <div style="display: flex; align-items: center; gap: 8px;">
                            ${statusDot}
                            <div style="flex: 1;">
                                <strong>${displayName}</strong>
                                ${uidText}
                            </div>
                            ${verifiedBadge}
                        </div>
                    `;
                    
                    div.onclick = () => {
                        selectedGrantUser = uid;
                        grantBtn.disabled = false;
                        searchUsersForGrant();
                    };
                    
                    list.appendChild(div);
                }
            });
            
            if (!found) {
                const message = searchTerm 
                    ? 'No users found matching "' + searchTerm + '"'
                    : 'No users found in database';
                list.innerHTML = '<div style="text-align: center; padding: 20px; color: var(--text-muted); font-size: 11px;">' + message + '</div>';
                selectedGrantUser = null;
                grantBtn.disabled = true;
            }
            
            lucide.createIcons();
        }).catch(err => {
            console.error('Error loading users:', err);
            list.innerHTML = '<div style="text-align: center; padding: 20px; color: var(--danger); font-size: 11px;">‚ùå Error loading users. Check console.</div>';
        });
    }
    
    function grantVerificationBadge() {
        if (!selectedGrantUser) {
            alert('Please select a user first');
            return;
        }
        
        db.ref('users/' + selectedGrantUser).once('value').then(snap => {
            const user = snap.val();
            
            if (user.verified) {
                if (!confirm(`${user.username || 'This user'} is already verified. Grant again anyway?`)) {
                    return;
                }
            }
            
            if (!confirm(`Grant verified badge to ${user.username || 'this user'}?`)) {
                return;
            }
            
            db.ref('users/' + selectedGrantUser).update({
                verified: true,
                verificationStatus: 'admin_granted',
                verificationApprovedAt: Date.now()
            }).then(() => {
                // Send notification to user
                db.ref('notifications/' + selectedGrantUser).push({
                    msg: 'üåü You have been granted a verification badge by an admin!',
                    time: Date.now(),
                    type: 'verification_granted'
                });
                
                alert('‚úÖ Verification badge granted successfully!');
                
                // Reset the form
                document.getElementById('grant-user-search').value = '';
                document.getElementById('grant-user-list').innerHTML = '<div style="text-align: center; padding: 20px; color: var(--text-muted); font-size: 11px;">Type to search for users...</div>';
                selectedGrantUser = null;
                document.getElementById('grant-verify-btn').disabled = true;
                
                // Refresh verification requests list
                loadVerificationRequests();
            }).catch(err => {
                console.error('Error granting verification:', err);
                alert('‚ùå Failed to grant verification badge');
            });
        });
    }
    
    // Load verification requests when the tab is opened
    const verificationTab = document.getElementById('verification-tab');
    if (verificationTab) {
        const observer = new MutationObserver((mutations) => {
            mutations.forEach((mutation) => {
                if (mutation.target.classList.contains('active') && mutation.target.id === 'verification-tab') {
                    loadVerificationRequests();
                    searchUsersForGrant(); // Load all users in grant section
                }
            });
        });
        
        observer.observe(verificationTab, { attributes: true, attributeFilter: ['class'] });
    }
    
    // ===============================================
    // CONTENT CREATOR MANAGEMENT SYSTEM
    // ===============================================
    
    // Search users for promotion to creator
    function searchUsersForPromotion() {
        const query = document.getElementById('promote-search').value.toLowerCase().trim();
        const results = document.getElementById('promote-results');
        
        if (!query) {
            results.innerHTML = '<div style="opacity:0.5; text-align:center; padding:20px; font-size:12px;">Start typing to search users...</div>';
            return;
        }
        
        db.ref('users').once('value').then(snap => {
            const users = snap.val() || {};
            const matches = [];
            
            Object.entries(users).forEach(([uid, user]) => {
                const name = (user.name || user.username || user.displayName || '').toLowerCase();
                if (name.includes(query) && !user.isContentCreator) {
                    matches.push({ uid, ...user });
                }
            });
            
            if (matches.length === 0) {
                results.innerHTML = '<div style="opacity:0.5; text-align:center; padding:20px; font-size:12px;">No users found or already creators</div>';
                return;
            }
            
            results.innerHTML = '';
            matches.slice(0, 10).forEach(user => {
                const div = document.createElement('div');
                div.className = 'user-option';
                div.style.cursor = 'pointer';
                div.innerHTML = `
                    <div style="flex:1;">
                        <strong>${user.name || user.username || user.displayName || 'User'}</strong>
                        <div style="font-size:10px; color:var(--text-muted); margin-top:2px;">
                            ${user.points || 0} points ‚Ä¢ ${user.bingoWins || 0} wins
                        </div>
                    </div>
                    <button class="btn btn-creator" onclick="promoteToCreator('${user.uid}', '${(user.name || '').replace(/'/g, "\\'")}'); event.stopPropagation();" style="padding:6px 12px; font-size:10px; margin:0;">
                        Promote
                    </button>
                `;
                results.appendChild(div);
            });
        });
    }
    
    // Promote user to content creator
    function promoteToCreator(uid, name) {
        if (!confirm(`Promote ${name} to Content Creator? They will get 2x points multiplier and follower system.`)) return;
        
        db.ref('users/' + uid).update({
            isContentCreator: true,
            creatorPromotedAt: Date.now(),
            creatorPoints: 0,
            creatorVideoViews: 0,
            fakeFollowers: 0,
            fakeReactionsPerPost: 0
        }).then(() => {
            // Send notification
            db.ref('notifications/' + uid).push({
                msg: 'üåü Congratulations! You are now a Content Creator! You earn double points and can gain followers.',
                time: Date.now(),
                type: 'creator_promotion'
            });
            
            alert('‚úÖ User promoted to Content Creator!');
            document.getElementById('promote-search').value = '';
            searchUsersForPromotion();
            loadCreators();
            updateCreatorStats();
        }).catch(err => {
            console.error('Error promoting user:', err);
            alert('‚ùå Failed to promote user');
        });
    }
    
    // Load content creators list
    function loadCreators() {
        const list = document.getElementById('creator-list');
        list.innerHTML = '<div style="text-align:center;padding:20px;">Loading...</div>';
        
        db.ref('users').orderByChild('isContentCreator').equalTo(true).once('value').then(snap => {
            const creators = snap.val() || {};
            list.innerHTML = '';
            
            if (Object.keys(creators).length === 0) {
                list.innerHTML = '<div style="opacity:0.5; text-align:center; padding:40px; font-size:12px;">No content creators yet</div>';
                return;
            }
            
            Object.entries(creators).forEach(([uid, creator]) => {
                const div = document.createElement('div');
                div.className = 'user-option creator-card';
                div.style.padding = '15px';
                div.style.border = '2px solid rgba(245, 158, 11, 0.2)';
                
                const displayName = creator.name || creator.username || creator.displayName || uid;
                const verifiedBadge = creator.verified ? '‚úì Verified' : '';
                
                // Calculate real followers
                const realFollowers = creator.followers ? Object.keys(creator.followers).length : 0;
                const fakeFollowers = creator.fakeFollowers || 0;
                const totalFollowers = realFollowers + fakeFollowers;
                
                // Calculate fake reactions per post
                const fakeReactionsPerPost = creator.fakeReactionsPerPost || 0;
                
                div.innerHTML = `
                    <div style="flex:1;">
                        <div style="display:flex;align-items:center;gap:8px;margin-bottom:8px;">
                            <strong>${displayName}</strong>
                            ${verifiedBadge}
                            <span class="creator-badge">‚òÖ Creator</span>
                        </div>
                        <div style="font-size:10px;color:var(--text-muted);">
                            üë• ${totalFollowers} followers (${fakeFollowers} fake) ‚Ä¢ 
                            ‚ù§Ô∏è ${fakeReactionsPerPost} fake reactions per post ‚Ä¢ 
                            üëÅÔ∏è ${creator.creatorVideoViews || 0} video views
                        </div>
                    </div>
                    <div style="display:flex;gap:8px;">
                        <button class="btn btn-creator" onclick="openMetricsModal('${uid}', '${displayName.replace(/'/g, "\\'")}')" style="padding:6px 12px;font-size:10px;">
                            Adjust
                        </button>
                        <button class="btn btn-danger" onclick="demoteCreator('${uid}', '${displayName.replace(/'/g, "\\'")}')" style="padding:6px 12px;font-size:10px;">
                            Demote
                        </button>
                    </div>
                `;
                
                list.appendChild(div);
            });
        });
    }
    
    // Open metrics adjustment modal
    function openMetricsModal(uid, name) {
        db.ref('users/' + uid).once('value').then(snap => {
            const user = snap.val();
            const fakeFollowers = user.fakeFollowers || 0;
            const fakeReactionsPerPost = user.fakeReactionsPerPost || 0;
            
            const modal = prompt(
                `Adjust Fake Metrics for ${name}\n\n` +
                `Current Fake Followers: ${fakeFollowers}\n` +
                `Current Fake Reactions Per Post: ${fakeReactionsPerPost}\n\n` +
                `Enter new values separated by comma (followers,reactions_per_post):\n` +
                `Example: 5000,100`,
                `${fakeFollowers},${fakeReactionsPerPost}`
            );
            
            if (modal !== null) {
                const [newFollowers, newReactionsPerPost] = modal.split(',').map(v => parseInt(v.trim()) || 0);
                
                db.ref('users/' + uid).update({
                    fakeFollowers: newFollowers,
                    fakeReactionsPerPost: newReactionsPerPost
                }).then(() => {
                    alert('‚úÖ Metrics updated!');
                    loadCreators();
                    updateCreatorStats();
                }).catch(err => {
                    console.error('Error updating metrics:', err);
                    alert('‚ùå Failed to update metrics');
                });
            }
        });
    }
    
    // Demote creator
    function demoteCreator(uid, name) {
        if (!confirm(`Remove Content Creator status from ${name}?`)) return;
        
        db.ref('users/' + uid).update({
            isContentCreator: false,
            creatorDemotedAt: Date.now()
        }).then(() => {
            db.ref('notifications/' + uid).push({
                msg: '‚ö†Ô∏è Your Content Creator status has been removed by an admin.',
                time: Date.now(),
                type: 'creator_demotion'
            });
            
            alert('‚úÖ Creator demoted');
            loadCreators();
            updateCreatorStats();
        }).catch(err => {
            console.error('Error demoting creator:', err);
            alert('‚ùå Failed to demote creator');
        });
    }
    
    // Update creator stats
    function updateCreatorStats() {
        db.ref('users').orderByChild('isContentCreator').equalTo(true).once('value').then(snap => {
            const creators = snap.val() || {};
            let totalFollowers = 0;
            let totalVideoViews = 0;
            
            Object.values(creators).forEach(creator => {
                const realFollowers = creator.followers ? Object.keys(creator.followers).length : 0;
                const fakeFollowers = creator.fakeFollowers || 0;
                totalFollowers += realFollowers + fakeFollowers;
                totalVideoViews += creator.creatorVideoViews || 0;
            });
            
            // Count creator posts
            db.ref('socialPosts').once('value').then(postsSnap => {
                const posts = postsSnap.val() || {};
                let totalPosts = 0;
                Object.values(posts).forEach(post => {
                    if (creators[post.uid]) totalPosts++;
                });
                
                document.getElementById('totalCreatorsCount').textContent = Object.keys(creators).length;
                document.getElementById('totalFollowers').textContent = totalFollowers;
                document.getElementById('totalVideoViews').textContent = totalVideoViews;
                document.getElementById('totalCreatorPosts').textContent = totalPosts;
            });
        });
    }
    
    // Load creators when creators tab is opened
    const creatorsTab = document.getElementById('creators-tab');
    if (creatorsTab) {
        const tabObserver = new MutationObserver((mutations) => {
            mutations.forEach((mutation) => {
                if (mutation.target.classList.contains('active') && mutation.target.id === 'creators-tab') {
                    loadCreators();
                    updateCreatorStats();
                    populateCreatorSelect();
                }
            });
        });
        
        tabObserver.observe(creatorsTab, { attributes: true, attributeFilter: ['class'] });
    }
    
    // Populate creator dropdown when tab opens
    function populateCreatorSelect() {
        const select = document.getElementById('post-creator-select');
        if (!select) return;
        select.innerHTML = '<option value="">-- Select Creator --</option>';
        
        db.ref('users').orderByChild('isContentCreator').equalTo(true).once('value').then(snap => {
            const creators = snap.val() || {};
            Object.entries(creators).forEach(([uid, creator]) => {
                const option = document.createElement('option');
                option.value = uid;
                option.textContent = creator.name || creator.username || creator.displayName || uid;
                select.appendChild(option);
            });
        });
    }
    
    // Load creator posts
    function loadCreatorPosts(creatorUid) {
        const container = document.getElementById('creator-posts-container');
        if (!container) return;
        
        if (!creatorUid) {
            container.innerHTML = '<div style="opacity:0.5; text-align:center; padding:40px; font-size:12px;">Select a creator to view posts</div>';
            return;
        }
        
        container.innerHTML = '<div style="text-align:center; padding:40px; opacity:0.7;">Loading...</div>';
        
        db.ref('socialPosts').orderByChild('uid').equalTo(creatorUid).limitToLast(20).once('value').then(snap => {
            if (!snap.exists()) {
                container.innerHTML = '<div style="opacity:0.5; text-align:center; padding:40px; font-size:12px;">No posts yet</div>';
                return;
            }
            
            const posts = [];
            snap.forEach(child => {
                const post = child.val();
                if (!post.deleted) posts.push({ key: child.key, ...post });
            });
            
            if (posts.length === 0) {
                container.innerHTML = '<div style="opacity:0.5; text-align:center; padding:40px; font-size:12px;">No posts yet</div>';
                return;
            }
            
            container.innerHTML = '';
            posts.reverse().forEach(post => {
                const card = createPostCard(post, creatorUid);
                container.appendChild(card);
            });
            lucide.createIcons();
        });
    }
    
    // Create post card
    function createPostCard(post, creatorUid) {
        const card = document.createElement('div');
        card.className = 'creator-post-card';
        
        const timestamp = new Date(post.timestamp).toLocaleString('en-PH', { month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' });
        const imgHtml = post.image ? `<img src="${post.image}" class="post-image-preview">` : '';
        const videoHtml = post.video ? `<video src="${post.video}" class="post-image-preview" controls></video>` : '';
        
        card.innerHTML = `
            <div style="display:flex; justify-content:space-between; margin-bottom:10px; font-size:11px; color:var(--text-muted);">
                <span><i data-lucide="calendar" style="width:12px; vertical-align:middle;"></i> ${timestamp}</span>
                <span style="color:#f59e0b; font-weight:700;">ID: ${post.key.substring(0,8)}</span>
            </div>
            ${post.mood ? `<div style="font-size:11px; color:var(--accent-glow); margin-bottom:8px;">üòä ${post.mood}</div>` : ''}
            <div class="post-content-text">${(post.content || '').replace(/</g, '&lt;').replace(/>/g, '&gt;')}</div>
            ${imgHtml}${videoHtml}
            <div class="post-stats">
                <span><i data-lucide="heart" style="width:14px; vertical-align:middle;"></i> <strong id="likes-${post.key}">${post.likes || 0}</strong></span>
                <span><i data-lucide="message-circle" style="width:14px; vertical-align:middle;"></i> <span id="comments-${post.key}">0</span></span>
            </div>
            <div class="reaction-control-panel">
                <span style="font-size:11px; font-weight:700; color:var(--accent);"><i data-lucide="zap" style="width:14px; vertical-align:middle;"></i> Reactions:</span>
                <select class="reaction-input" id="emoji-${post.key}" style="width:60px; padding:4px; font-size:16px; cursor:pointer;">
                    <option value="‚ù§Ô∏è">‚ù§Ô∏è</option>
                    <option value="üòÇ">üòÇ</option>
                    <option value="üòÆ">üòÆ</option>
                    <option value="üò¢">üò¢</option>
                    <option value="üëç">üëç</option>
                    <option value="üî•">üî•</option>
                    <option value="üòç">üòç</option>
                    <option value="üíØ">üíØ</option>
                    <option value="üéâ">üéâ</option>
                    <option value="üëè">üëè</option>
                </select>
                <input type="number" class="reaction-input" id="reaction-${post.key}" placeholder="0" min="0" value="0" style="width:70px;">
                <button class="add-reaction-btn" onclick="addBulkReactions('${post.key}', '${creatorUid}')"><i data-lucide="plus-circle" style="width:14px; vertical-align:middle;"></i> ADD</button>
            </div>
            <div class="reaction-control-panel" style="background:rgba(6,182,212,0.05); border-color:rgba(6,182,212,0.2); margin-top:8px;">
                <span style="font-size:11px; font-weight:700; color:var(--cyan);"><i data-lucide="message-square" style="width:14px; vertical-align:middle;"></i> Comments:</span>
                <label style="display:flex; align-items:center; gap:4px; font-size:10px; cursor:pointer;">
                    <input type="checkbox" id="ai-comment-${post.key}" style="cursor:pointer;">
                    <span style="color:var(--gold);">ü§ñ AI</span>
                </label>
                <input type="number" class="reaction-input" id="comment-${post.key}" placeholder="0" min="0" value="0" style="width:70px;">
                <button class="add-reaction-btn" onclick="addBulkComments('${post.key}', '${creatorUid}')" style="background:linear-gradient(135deg, var(--cyan), #0891b2);"><i data-lucide="plus-circle" style="width:14px; vertical-align:middle;"></i> ADD</button>
            </div>
        `;
        
        db.ref('postComments/' + post.key).once('value').then(s => {
            const el = card.querySelector('#comments-' + post.key);
            if (el) el.textContent = s.numChildren();
        });
        
        return card;
    }
    
    // Add bulk reactions
    function addBulkReactions(postKey, creatorUid) {
        const input = document.getElementById('reaction-' + postKey);
        const emojiSelect = document.getElementById('emoji-' + postKey);
        const selectedEmoji = emojiSelect ? emojiSelect.value : '‚ù§Ô∏è';
        const amount = parseInt(input.value) || 0;
        
        if (amount <= 0) { alert('Enter valid number'); return; }
        if (amount > 1000) { alert('Max 1000'); return; }
        if (!confirm(`Add ${amount} ${selectedEmoji} reactions?`)) return;
        
        const btn = event.target;
        const orig = btn.innerHTML;
        btn.disabled = true;
        btn.innerHTML = '<i data-lucide="loader" style="width:14px; animation:spin 1s linear infinite;"></i> Wait...';
        
        db.ref('users').once('value').then(usersSnap => {
            const users = usersSnap.val() || {};
            const userIds = Object.keys(users);
            
            db.ref('postLikes/' + postKey).once('value').then(likesSnap => {
                const existing = likesSnap.exists() ? Object.keys(likesSnap.val()) : [];
                const available = userIds.filter(uid => !existing.includes(uid));
                const toAdd = Math.min(amount, available.length);
                
                if (toAdd === 0) { alert('All users already reacted!'); btn.disabled = false; btn.innerHTML = orig; lucide.createIcons(); return; }
                
                const selected = available.sort(() => 0.5 - Math.random()).slice(0, toAdd);
                const updates = {};
                
                selected.forEach(uid => {
                    updates[`postLikes/${postKey}/${uid}`] = selectedEmoji;
                    db.ref(`notifications/${creatorUid}`).push({
                        msg: `${users[uid]?.name || 'Someone'} reacted ${selectedEmoji} to your post`,
                        time: Date.now(),
                        type: 'post_reaction',
                        from: uid,
                        postKey: postKey
                    });
                });
                
                db.ref().update(updates).then(() => {
                    const newTotal = existing.length + toAdd;
                    db.ref('socialPosts/' + postKey + '/likes').set(newTotal);
                    document.getElementById('likes-' + postKey).textContent = newTotal;
                    input.value = 0;
                    btn.innerHTML = `<i data-lucide="check" style="width:14px;"></i> ${toAdd} ADDED!`;
                    btn.style.background = 'var(--success)';
                    setTimeout(() => { btn.disabled = false; btn.innerHTML = orig; btn.style.background = ''; lucide.createIcons(); }, 3000);
                    lucide.createIcons();
                });
            });
        });
    }
    
    // Add bulk comments
    function addBulkComments(postKey, creatorUid) {
        const input = document.getElementById('comment-' + postKey);
        const aiCheckbox = document.getElementById('ai-comment-' + postKey);
        const useAI = aiCheckbox ? aiCheckbox.checked : false;
        const amount = parseInt(input.value) || 0;
        
        if (amount <= 0) { alert('Enter valid number'); return; }
        if (amount > 500) { alert('Max 500'); return; }
        
        const confirmMsg = useAI ? `Generate ${amount} AI comments based on post content?` : `Add ${amount} random comments?`;
        if (!confirm(confirmMsg)) return;
        
        const btn = event.target;
        const orig = btn.innerHTML;
        btn.disabled = true;
        btn.innerHTML = '<i data-lucide="loader" style="width:14px; animation:spin 1s linear infinite;"></i> ' + (useAI ? 'AI Thinking...' : 'Wait...');
        
        // Get post data first
        db.ref('socialPosts/' + postKey).once('value').then(postSnap => {
            const postData = postSnap.val();
            if (!postData) {
                alert('Post not found');
                btn.disabled = false;
                btn.innerHTML = orig;
                lucide.createIcons();
                return;
            }
            
            if (useAI) {
                // AI MODE: Generate contextual comments
                generateAIComments(postData, amount).then(aiComments => {
                    return addCommentsToPost(postKey, creatorUid, aiComments, btn, orig, input);
                }).catch(err => {
                    console.error('AI Error:', err);
                    alert('AI generation failed. Using random templates instead.');
                    // Fallback to templates
                    const templates = getRandomCommentTemplates(amount);
                    return addCommentsToPost(postKey, creatorUid, templates, btn, orig, input);
                });
            } else {
                // TEMPLATE MODE: Use random templates
                const templates = getRandomCommentTemplates(amount);
                addCommentsToPost(postKey, creatorUid, templates, btn, orig, input);
            }
        });
    }
    
    // Generate AI comments based on post content
    async function generateAIComments(postData, count) {
        const content = postData.content || '';
        const hasImage = !!postData.image;
        const hasVideo = !!postData.video;
        const mood = postData.mood || '';
        
        // Detect language (simple check - if contains Filipino words)
        const filipinoWords = ['ang', 'mga', 'sa', 'ng', 'na', 'ay', 'ko', 'mo', 'ka', 'yan', 'yung', 'lang'];
        const isTagalog = filipinoWords.some(word => content.toLowerCase().includes(' ' + word + ' '));
        
        const language = isTagalog ? 'Tagalog' : 'English';
        
        // Create contextual prompt
        let contextPrompt = `Generate ${count} authentic, natural ${language} social media comments for this post:\n\n`;
        contextPrompt += `Post: "${content}"\n`;
        if (mood) contextPrompt += `Mood: ${mood}\n`;
        if (hasImage) contextPrompt += `Has image attached\n`;
        if (hasVideo) contextPrompt += `Has video attached\n`;
        contextPrompt += `\nGuidelines:\n`;
        contextPrompt += `- Write in ${language} (${isTagalog ? 'casual Filipino/Taglish' : 'casual English'})\n`;
        contextPrompt += `- Be natural, friendly, supportive\n`;
        contextPrompt += `- Use emojis appropriately\n`;
        contextPrompt += `- Keep comments 3-15 words\n`;
        contextPrompt += `- Vary the reactions (likes, questions, excitement, support)\n`;
        contextPrompt += `- Reference the post content naturally\n\n`;
        contextPrompt += `Return ONLY a JSON array of comment strings, nothing else.`;
        
        try {
            const response = await fetch('https://api.anthropic.com/v1/messages', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'anthropic-version': '2023-06-01'
                },
                body: JSON.stringify({
                    model: 'claude-sonnet-4-20250514',
                    max_tokens: 1000,
                    messages: [{
                        role: 'user',
                        content: contextPrompt
                    }]
                })
            });
            
            const data = await response.json();
            const responseText = data.content[0].text;
            
            // Parse JSON response
            const jsonMatch = responseText.match(/\[[\s\S]*\]/);
            if (jsonMatch) {
                const comments = JSON.parse(jsonMatch[0]);
                return comments.slice(0, count); // Ensure we get exactly count comments
            } else {
                throw new Error('Invalid response format');
            }
        } catch (error) {
            console.error('AI API Error:', error);
            // Fallback to contextual templates
            return getContextualTemplates(content, isTagalog, count);
        }
    }
    
    // Contextual template fallback
    function getContextualTemplates(content, isTagalog, count) {
        const tagalogTemplates = [
            "Ganda! üòç", "Nice! üëç", "Galing! üî•", "Love it! ‚ù§Ô∏è", "Sobrang ganda! ‚ú®",
            "Ang ganda naman! üòä", "Ang cool! üéâ", "Wow! üòÆ", "Astig! üíØ",
            "Keep it up! üí™", "More pa! üôè", "Grabe! üî•üî•", "Idol! ‚≠ê"
        ];
        
        const englishTemplates = [
            "Amazing! üî•", "Love this! ‚ù§Ô∏è", "So good! üëç", "Awesome! üéâ",
            "Beautiful! ‚ú®", "Great post! üíØ", "Incredible! üòÆ", "Perfect! üëå",
            "Keep posting! üì∏", "This is fire! üî•", "So cool! üòç", "Legend! ‚≠ê"
        ];
        
        const templates = isTagalog ? tagalogTemplates : englishTemplates;
        const result = [];
        for (let i = 0; i < count; i++) {
            result.push(templates[Math.floor(Math.random() * templates.length)]);
        }
        return result;
    }
    
    // Random template generator (non-AI mode)
    function getRandomCommentTemplates(count) {
        const templates = [
            "Nice post! üëç","Love this! ‚ù§Ô∏è","Amazing! üî•","Keep it up! üí™","So cool! üòç",
            "Great work! ‚≠ê","Awesome! üéâ","Wow! üòÆ","Incredible! üëè","Perfect! üíØ",
            "Love your posts! üíñ","You're the best! ü•á","Keep posting! üì∏","More please! üôè",
            "So inspiring! ‚ú®","Made my day! ‚òÄÔ∏è","Legend! üî•","Pure gold! üíõ"
        ];
        const result = [];
        for (let i = 0; i < count; i++) {
            result.push(templates[Math.floor(Math.random() * templates.length)]);
        }
        return result;
    }
    
    // Add comments to post
    function addCommentsToPost(postKey, creatorUid, comments, btn, orig, input) {
        return db.ref('users').once('value').then(usersSnap => {
            const users = usersSnap.val() || {};
            const userIds = Object.keys(users);
            
            const promises = [];
            comments.forEach(text => {
                const uid = userIds[Math.floor(Math.random() * userIds.length)];
                const userName = users[uid]?.name || 'Someone';
                
                promises.push(
                    db.ref(`postComments/${postKey}`).push({ uid, text, time: Date.now() })
                );
                promises.push(
                    db.ref(`notifications/${creatorUid}`).push({
                        msg: `${userName} commented: "${text}"`,
                        time: Date.now(),
                        type: 'post_comment',
                        from: uid,
                        postKey: postKey
                    })
                );
            });
            
            return Promise.all(promises).then(() => {
                return db.ref('postComments/' + postKey).once('value');
            }).then(s => {
                document.getElementById('comments-' + postKey).textContent = s.numChildren();
                input.value = 0;
                btn.innerHTML = `<i data-lucide="check" style="width:14px;"></i> ${comments.length} ADDED!`;
                btn.style.background = 'var(--success)';
                setTimeout(() => { 
                    btn.disabled = false; 
                    btn.innerHTML = orig; 
                    btn.style.background = ''; 
                    lucide.createIcons(); 
                }, 3000);
                lucide.createIcons();
            }).catch(err => {
                console.error('Error adding comments:', err);
                alert('Failed to add comments');
                btn.disabled = false;
                btn.innerHTML = orig;
                btn.style.background = '';
                lucide.createIcons();
            });
        });
    }

    // ================================================
    // TOURNAMENT MANAGER
    // ================================================

    let allTournaments = [];
    let currentTournFilter = 'all';

    function initTournamentManager() {
        db.ref('tournaments').on('value', snap => {
            allTournaments = [];
            if (snap.exists()) {
                snap.forEach(child => {
                    allTournaments.push({ key: child.key, ...child.val() });
                });
            }
            allTournaments.sort((a, b) => (b.createdAt || 0) - (a.createdAt || 0));
            updateTournStats();
            renderTournaments(currentTournFilter);
        });
    }

    function updateTournStats() {
        const total = allTournaments.length;
        const live  = allTournaments.filter(t => t.status === 'live').length;
        let totalPlayers = 0;
        let totalPrizes = 0;
        allTournaments.forEach(t => {
            totalPlayers += t.participants ? Object.keys(t.participants).length : 0;
            if (t.status === 'finished') totalPrizes += (t.prize || 0) + (t.prize2 || 0) + (t.prize3 || 0);
        });
        document.getElementById('t-stat-total').textContent = total;
        document.getElementById('t-stat-live').textContent = live;
        document.getElementById('t-stat-players').textContent = totalPlayers;
        document.getElementById('t-stat-prizes').textContent = totalPrizes.toLocaleString();
    }

    function filterTournaments(filter, btn) {
        currentTournFilter = filter;
        document.querySelectorAll('.tourn-filter-tab').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        renderTournaments(filter);
    }

    function renderTournaments(filter) {
        const container = document.getElementById('tourn-list');
        const list = filter === 'all' ? allTournaments : allTournaments.filter(t => t.status === filter);

        if (list.length === 0) {
            container.innerHTML = `<div style="text-align:center;padding:50px;opacity:0.4;font-size:13px;">
                <div style="font-size:40px;margin-bottom:8px;">üèÜ</div>
                No ${filter === 'all' ? '' : filter} tournaments yet.
            </div>`;
            return;
        }

        container.innerHTML = list.map(t => {
            const participants = t.participants ? Object.keys(t.participants) : [];
            const count = participants.length;
            const startDate = t.startTime
                ? new Date(t.startTime).toLocaleString('en-PH', { month:'short', day:'numeric', year:'numeric', hour:'2-digit', minute:'2-digit' })
                : 'TBA';

            const statusMap   = { upcoming: 't-upcoming', live: 't-live', finished: 't-finished' };
            const statusLabel = { upcoming: 'üìÖ Upcoming', live: 'üî¥ LIVE', finished: '‚úÖ Finished' };

            const avatarsHtml = participants.slice(0, 7).map(uid =>
                `<img class="part-avatar" src="https://via.placeholder.com/26" data-puid="${t.key}-${uid}" onerror="this.src='https://via.placeholder.com/26'">`
            ).join('');
            const extraCount = count > 7 ? `<span style="font-size:11px;color:var(--text-muted);margin-left:6px;">+${count-7} more</span>` : '';

            const tNameSafe = (t.name||'').replace(/'/g,"\\'");
            const actionBtns = `
                ${t.status !== 'live'     ? `<button class="t-btn go-live"     onclick="setTournStatus('${t.key}','live')"><i data-lucide="radio" style="width:12px;"></i> SET LIVE</button>` : ''}
                ${t.status !== 'upcoming' ? `<button class="t-btn go-upcoming" onclick="setTournStatus('${t.key}','upcoming')"><i data-lucide="calendar" style="width:12px;"></i> UPCOMING</button>` : ''}
                ${t.status !== 'finished' ? `<button class="t-btn go-finish"   onclick="openWinnerModal('${t.key}')"><i data-lucide="check-circle" style="width:12px;"></i> FINISH & AWARD</button>` : ''}
                <button class="t-btn go-notify" onclick="notifyTournament('${t.key}','${tNameSafe}')"><i data-lucide="bell" style="width:12px;"></i> NOTIFY</button>
                <button class="t-btn go-view"   onclick="viewParticipants('${t.key}')"><i data-lucide="users" style="width:12px;"></i> PLAYERS (${count})</button>
                <button class="t-btn go-del"    onclick="deleteTournament('${t.key}','${tNameSafe}')"><i data-lucide="trash-2" style="width:12px;"></i> DELETE</button>
            `;

            return `
            <div class="tourn-admin-card ${t.status === 'live' ? 'is-live' : ''}">
                <div class="tourn-row">
                    <div>
                        <span class="tourn-status-badge ${statusMap[t.status]||'t-upcoming'}">${statusLabel[t.status]||'üìÖ Upcoming'}</span>
                        <div class="tourn-name-admin" style="margin-top:6px;">${escapeHtmlT(t.name||'Unnamed')}</div>
                    </div>
                    <div style="text-align:right;">
                        <div style="font-size:10px;color:var(--text-muted);margin-bottom:2px;">GRAND PRIZE</div>
                        <div class="tourn-prize-info">${(t.prize||0).toLocaleString()} ü™ô</div>
                    </div>
                </div>
                <div class="tourn-meta">
                    <span><i data-lucide="calendar" style="width:12px;"></i> ${startDate}</span>
                    <span><i data-lucide="users" style="width:12px;"></i> ${count}${t.maxParticipants?'/'+t.maxParticipants:''} joined</span>
                    <span>Entry: ${(t.entryFee||0).toLocaleString()} ü™ô</span>
                    <span>ü•à ${(t.prize2||0).toLocaleString()} ¬∑ ü•â ${(t.prize3||0).toLocaleString()}</span>
                    ${t.winnerName ? `<span style="color:#fbbf24;">üèÜ ${escapeHtmlT(t.winnerName)}</span>` : ''}
                </div>
                ${count > 0 ? `<div class="participants-preview" style="margin-bottom:10px;">${avatarsHtml}${extraCount}</div>` : ''}
                ${t.description ? `<div style="font-size:11px;color:var(--text-muted);padding:8px;background:rgba(255,255,255,0.03);border-radius:8px;margin-bottom:10px;">${escapeHtmlT(t.description)}</div>` : ''}
                <div class="tourn-action-btns">${actionBtns}</div>
            </div>`;
        }).join('');

        lucide.createIcons();

        // Load participant avatars
        list.forEach(t => {
            if (!t.participants) return;
            Object.keys(t.participants).slice(0, 7).forEach(uid => {
                db.ref(`users/${uid}/photo`).once('value', snap => {
                    const photo = snap.val();
                    if (photo) {
                        document.querySelectorAll(`[data-puid="${t.key}-${uid}"]`).forEach(el => { el.src = photo; });
                    }
                });
            });
        });
    }

    function escapeHtmlT(str) {
        if (!str) return '';
        return String(str).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
    }

    function createTournament() {
        const name   = document.getElementById('t-name').value.trim();
        const startR = document.getElementById('t-start').value;
        const maxP   = parseInt(document.getElementById('t-max').value) || 0;
        const fee    = parseInt(document.getElementById('t-fee').value) || 0;
        const prize1 = parseInt(document.getElementById('t-prize1').value) || 0;
        const prize2 = parseInt(document.getElementById('t-prize2').value) || 0;
        const prize3 = parseInt(document.getElementById('t-prize3').value) || 0;
        const status = document.getElementById('t-status').value;
        const desc   = document.getElementById('t-desc').value.trim();

        if (!name)  { alert('Please enter a tournament name!'); return; }
        if (!startR){ alert('Please set a start date and time!'); return; }
        if (prize1 <= 0) { alert('Grand prize must be greater than 0!'); return; }

        const btn = event.currentTarget;
        const origHtml = btn.innerHTML;
        btn.disabled = true;
        btn.innerHTML = `<i data-lucide="loader" style="width:16px;"></i> CREATING...`;
        lucide.createIcons();

        db.ref('tournaments').push({
            name, startTime: new Date(startR).getTime(),
            maxParticipants: maxP, entryFee: fee,
            prize: prize1, prize2, prize3,
            totalPrize: prize1 + prize2 + prize3,
            status, description: desc,
            createdAt: Date.now(), createdBy: 'admin'
        }).then(() => {
            alert(`‚úÖ Tournament "${name}" created!`);
            ['t-name','t-desc'].forEach(id => document.getElementById(id).value = '');
            document.getElementById('t-start').value = '';
            btn.disabled = false; btn.innerHTML = origHtml; lucide.createIcons();
        }).catch(err => {
            alert('Error: ' + err.message);
            btn.disabled = false; btn.innerHTML = origHtml; lucide.createIcons();
        });
    }

    function setTournStatus(key, status) {
        const labels = { live:'üî¥ LIVE', upcoming:'üìÖ Upcoming', finished:'‚úÖ Finished' };
        if (!confirm(`Set this tournament to ${labels[status]}?`)) return;
        db.ref(`tournaments/${key}`).update({ status });
    }

    function deleteTournament(key, name) {
        if (!confirm(`DELETE "${name}"?\n\nThis cannot be undone. Entry fees will NOT be auto-refunded.`)) return;
        db.ref(`tournaments/${key}`).remove();
    }

    function notifyTournament(key, name) {
        if (!confirm(`Notify all registered participants about "${name}"?`)) return;
        db.ref(`tournaments/${key}/participants`).once('value', snap => {
            const promises = [];
            if (snap.exists()) {
                snap.forEach(child => {
                    promises.push(db.ref(`notifications/${child.key}`).push({
                        msg: `üèÜ "${name}" tournament is starting! Open RB Live now!`,
                        time: Date.now(), type: 'tournament_alert'
                    }));
                });
            }
            Promise.all(promises).then(() => alert(`‚úÖ ${promises.length} participants notified!`));
        });
    }

    function viewParticipants(key) {
        const t = allTournaments.find(x => x.key === key);
        if (!t) return;
        const parts = t.participants ? Object.entries(t.participants) : [];
        if (parts.length === 0) { alert('No participants yet.'); return; }

        let modal = document.getElementById('tPModal');
        if (!modal) {
            modal = document.createElement('div');
            modal.id = 'tPModal';
            modal.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,0.85);z-index:99999;display:flex;align-items:center;justify-content:center;backdrop-filter:blur(10px);';
            document.body.appendChild(modal);
        }
        modal.innerHTML = `
            <div style="background:#1e293b;border:1px solid rgba(139,92,246,0.3);border-radius:20px;padding:24px;width:90%;max-width:480px;max-height:80vh;display:flex;flex-direction:column;">
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;">
                    <div><div style="font-size:16px;font-weight:900;color:white;">üë• Participants</div>
                    <div style="font-size:11px;color:rgba(255,255,255,0.4);">${escapeHtmlT(t.name)} ¬∑ ${parts.length} joined</div></div>
                    <button onclick="document.getElementById('tPModal').style.display='none'" style="background:rgba(255,255,255,0.1);border:none;color:white;border-radius:8px;width:32px;height:32px;cursor:pointer;font-size:18px;">√ó</button>
                </div>
                <div style="overflow-y:auto;flex:1;">
                    ${parts.map(([uid,p],i) => `
                    <div style="display:flex;align-items:center;gap:12px;padding:10px;border-radius:10px;background:rgba(255,255,255,0.03);margin-bottom:6px;">
                        <div style="font-size:13px;font-weight:900;color:rgba(255,255,255,0.3);width:24px;text-align:center;">${i+1}</div>
                        <img src="${p.photo||'https://via.placeholder.com/36'}" style="width:36px;height:36px;border-radius:50%;object-fit:cover;">
                        <div style="flex:1;">
                            <div style="font-size:13px;font-weight:700;color:white;">${escapeHtmlT(p.name||'Player')}</div>
                            <div style="font-size:10px;color:rgba(255,255,255,0.4);">Joined ${new Date(p.joinedAt||0).toLocaleDateString()}</div>
                        </div>
                    </div>`).join('')}
                </div>
                <div style="margin-top:12px;padding-top:12px;border-top:1px solid rgba(255,255,255,0.1);display:flex;gap:8px;">
                    <button onclick="document.getElementById('tPModal').style.display='none'; openWinnerModal('${key}')" style="flex:1;padding:10px;background:linear-gradient(135deg,#fbbf24,#f59e0b);border:none;border-radius:10px;color:#78350f;font-weight:900;cursor:pointer;font-size:12px;">üèÜ AWARD PRIZES</button>
                    <button onclick="document.getElementById('tPModal').style.display='none'" style="padding:10px 20px;background:rgba(255,255,255,0.08);border:none;border-radius:10px;color:white;cursor:pointer;">CLOSE</button>
                </div>
            </div>`;
        modal.style.display = 'flex';
    }

    function openWinnerModal(key) {
        const t = allTournaments.find(x => x.key === key);
        if (!t) return;
        const parts = t.participants ? Object.entries(t.participants) : [];
        const pm = document.getElementById('tPModal');
        if (pm) pm.style.display = 'none';

        let modal = document.getElementById('tWModal');
        if (!modal) {
            modal = document.createElement('div');
            modal.id = 'tWModal';
            modal.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,0.88);z-index:99999;display:flex;align-items:center;justify-content:center;backdrop-filter:blur(10px);';
            document.body.appendChild(modal);
        }
        const opts = parts.map(([uid,p]) => `<option value="${uid}">${escapeHtmlT(p.name||uid)}</option>`).join('');
        const slots = [
            {id:'w1',rank:'ü•á',label:'1st Place',prize:t.prize,color:'#fbbf24'},
            {id:'w2',rank:'ü•à',label:'2nd Place',prize:t.prize2,color:'#94a3b8'},
            {id:'w3',rank:'ü•â',label:'3rd Place',prize:t.prize3,color:'#92400e'}
        ];
        modal.innerHTML = `
            <div style="background:#1e293b;border:2px solid rgba(251,191,36,0.3);border-radius:20px;padding:24px;width:90%;max-width:500px;max-height:85vh;display:flex;flex-direction:column;box-shadow:0 0 40px rgba(251,191,36,0.2);">
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;">
                    <div style="font-size:16px;font-weight:900;color:white;">üèÜ Award Prizes ‚Äî ${escapeHtmlT(t.name)}</div>
                    <button onclick="document.getElementById('tWModal').style.display='none'" style="background:rgba(255,255,255,0.1);border:none;color:white;border-radius:8px;width:32px;height:32px;cursor:pointer;font-size:18px;">√ó</button>
                </div>
                ${slots.map(s => `
                <div style="margin-bottom:14px;background:rgba(0,0,0,0.2);border-radius:12px;padding:14px;">
                    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
                        <span style="font-size:14px;font-weight:900;">${s.rank} ${s.label}</span>
                        <span style="font-size:15px;font-weight:900;color:${s.color};">+${(s.prize||0).toLocaleString()} ü™ô</span>
                    </div>
                    <select id="${s.id}" style="width:100%;padding:10px;background:rgba(0,0,0,0.3);border:1px solid rgba(139,92,246,0.3);color:white;border-radius:10px;">
                        <option value="">-- Select Player --</option>${opts}
                    </select>
                </div>`).join('')}
                <div style="display:flex;gap:8px;margin-top:8px;">
                    <button onclick="awardPrizes('${key}')" style="flex:1;padding:14px;background:linear-gradient(135deg,#fbbf24,#f59e0b);border:none;border-radius:12px;color:#78350f;font-weight:900;cursor:pointer;font-size:14px;">üèÜ AWARD & FINISH</button>
                    <button onclick="document.getElementById('tWModal').style.display='none'" style="padding:14px 18px;background:rgba(255,255,255,0.08);border:none;border-radius:12px;color:white;cursor:pointer;">CANCEL</button>
                </div>
            </div>`;
        modal.style.display = 'flex';
    }

    function awardPrizes(key) {
        const t = allTournaments.find(x => x.key === key);
        if (!t) return;
        const w1uid = document.getElementById('w1').value;
        const w2uid = document.getElementById('w2').value;
        const w3uid = document.getElementById('w3').value;
        if (!w1uid) { alert('Please select a 1st place winner!'); return; }

        const parts = t.participants || {};
        const w1n = parts[w1uid]?.name || w1uid;
        const w2n = w2uid ? (parts[w2uid]?.name || w2uid) : null;
        const w3n = w3uid ? (parts[w3uid]?.name || w3uid) : null;

        if (!confirm(`Award prizes?\nü•á ${w1n}: ${(t.prize||0).toLocaleString()} ü™ô${w2n?'\nü•à '+w2n+': '+(t.prize2||0).toLocaleString()+' ü™ô':''}${w3n?'\nü•â '+w3n+': '+(t.prize3||0).toLocaleString()+' ü™ô':''}`)) return;

        const ps = [];
        if (w1uid && t.prize)  { ps.push(db.ref(`users/${w1uid}/points`).transaction(p=>(p||0)+t.prize));  ps.push(db.ref(`notifications/${w1uid}`).push({msg:`ü•á You WON ${(t.prize||0).toLocaleString()} ü™ô in "${t.name}"! Congratulations!`,time:Date.now(),type:'tournament_win'})); }
        if (w2uid && t.prize2) { ps.push(db.ref(`users/${w2uid}/points`).transaction(p=>(p||0)+t.prize2)); ps.push(db.ref(`notifications/${w2uid}`).push({msg:`ü•à 2nd Place! You won ${(t.prize2||0).toLocaleString()} ü™ô in "${t.name}"!`,time:Date.now(),type:'tournament_win'})); }
        if (w3uid && t.prize3) { ps.push(db.ref(`users/${w3uid}/points`).transaction(p=>(p||0)+t.prize3)); ps.push(db.ref(`notifications/${w3uid}`).push({msg:`ü•â 3rd Place! You won ${(t.prize3||0).toLocaleString()} ü™ô in "${t.name}"!`,time:Date.now(),type:'tournament_win'})); }
        ps.push(db.ref(`tournaments/${key}`).update({status:'finished',finishedAt:Date.now(),winnerUid:w1uid,winnerName:w1n,winner2Uid:w2uid||null,winner2Name:w2n||null,winner3Uid:w3uid||null,winner3Name:w3n||null}));

        Promise.all(ps).then(() => {
            document.getElementById('tWModal').style.display = 'none';
            alert(`‚úÖ Done! ${w1n} is the champion! üèÜ`);
        }).catch(err => alert('Error: ' + err.message));
    }

    // Hook tournament init when tab opens
    const _origOpenTab = window.openTab;
    window.openTab = function(tabId, btn) {
        _origOpenTab(tabId, btn);
        if (tabId === 'tournament-tab') initTournamentManager();
    };
</script>


<script>

// ================================================
// üè™ PARTNER APPLICATIONS MANAGER
// ================================================

var _paAll = [];
var _paFilter = 'all';

var _paTypeIcon = {
    'sari-sari':'üõí','grocery':'üè¨','food':'üçú','pharmacy':'üíä',
    'clothing':'üëï','electronics':'üì±','school':'üìö','beauty':'üíÑ','other':'üè™'
};
var _paTypeLabel = {
    'sari-sari':'Corner Store','grocery':'Grocery / Supermarket',
    'food':'Food / Restaurant','pharmacy':'Pharmacy / Drugstore',
    'clothing':'Clothing','electronics':'Electronics / Gadgets',
    'school':'School Supplies','beauty':'Beauty / Personal Care','other':'Others'
};

function _paEsc(s) {
    return String(s || '').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

function loadPartnerApps() {
    var list = document.getElementById('partnerAppsList');
    if (!list) return;
    list.innerHTML = '<div style="text-align:center;padding:50px;opacity:0.4;font-size:13px;font-weight:700;">Loading...</div>';

    db.ref('partnerApplications').orderByChild('timestamp').once('value', function(snap) {
        _paAll = [];
        if (snap.exists()) {
            snap.forEach(function(child) {
                var d = child.val();
                d._key = child.key;
                _paAll.push(d);
            });
            _paAll.reverse();
        }
        _paUpdateCounts();
        _paRender();
    });
}

function _paUpdateCounts() {
    var c = { all: _paAll.length, pending: 0, approved: 0, rejected: 0 };
    _paAll.forEach(function(a) {
        var s = a.status || 'pending';
        if (c[s] !== undefined) c[s]++;
    });
    ['all','pending','approved','rejected'].forEach(function(k) {
        var el = document.getElementById('pac-' + k);
        if (el) el.textContent = c[k];
    });
    var badge = document.getElementById('partnersBadge');
    if (badge) {
        if (c.pending > 0) {
            badge.textContent = c.pending;
            badge.style.display = 'inline-block';
        } else {
            badge.style.display = 'none';
        }
    }
}

function filterPA(f) {
    _paFilter = f;
    _paRender();
}

function _paRender() {
    var list = document.getElementById('partnerAppsList');
    if (!list) return;

    var items = _paFilter === 'all'
        ? _paAll
        : _paAll.filter(function(a) { return (a.status || 'pending') === _paFilter; });

    if (items.length === 0) {
        list.innerHTML = '<div style="text-align:center;padding:60px;opacity:0.35;"><div style="font-size:36px;margin-bottom:12px;">üì≠</div><div style="font-size:13px;font-weight:700;">''No ' + _paFilter + ' applications'</div></div>';
        return;
    }

    var html = '';
    items.forEach(function(app) {
        var status = app.status || 'pending';
        var icon   = _paTypeIcon[app.storeType]  || 'üè™';
        var tLabel = _paTypeLabel[app.storeType] || app.storeType || 'Unknown';
        var date   = app.timestamp
            ? new Date(app.timestamp).toLocaleString('en-PH', {year:'numeric',month:'short',day:'numeric',hour:'2-digit',minute:'2-digit'})
            : '‚Äî';

        var statusColor  = status === 'approved' ? '#10b981' : status === 'rejected' ? '#ef4444' : '#fbbf24';
        var statusBg     = status === 'approved' ? 'rgba(16,185,129,0.12)' : status === 'rejected' ? 'rgba(239,68,68,0.12)' : 'rgba(251,191,36,0.12)';
        var statusBorder = status === 'approved' ? 'rgba(16,185,129,0.3)'  : status === 'rejected' ? 'rgba(239,68,68,0.3)'  : 'rgba(251,191,36,0.3)';
        var statusLabel  = status === 'approved' ? 'APPROVED' : status === 'rejected' ? 'REJECTED' : 'PENDING';

        var approveBtn = status !== 'approved'
            ? '<button onclick="setPartnerStatus(\'' + app._key + '\',\'approved\')" '
            + 'style="padding:8px 14px;background:linear-gradient(135deg,#10b981,#059669);border:none;border-radius:9px;color:white;font-size:11px;font-weight:900;cursor:pointer;white-space:nowrap;letter-spacing:0.5px;">'
            + '‚úì APPROVE</button>'
            : '';

        var rejectBtn = status !== 'rejected'
            ? '<button onclick="setPartnerStatus(\'' + app._key + '\',\'rejected\')" '
            + 'style="padding:8px 14px;background:rgba(239,68,68,0.12);border:1px solid rgba(239,68,68,0.3);border-radius:9px;color:#ef4444;font-size:11px;font-weight:900;cursor:pointer;white-space:nowrap;">'
            + '‚úï REJECT</button>'
            : '';

        var resetBtn = status !== 'pending'
            ? '<button onclick="setPartnerStatus(\'' + app._key + '\',\'pending\')" '
            + 'style="padding:8px 14px;background:rgba(251,191,36,0.1);border:1px solid rgba(251,191,36,0.3);border-radius:9px;color:#fbbf24;font-size:11px;font-weight:700;cursor:pointer;white-space:nowrap;">'
            + '‚Ü© RESET</button>'
            : '';

        var deleteBtn = '<button onclick="deletePartnerApp(\'' + app._key + '\',\'' + _paEsc(app.storeName) + '\')" '
            + 'style="padding:8px 14px;background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.1);border-radius:9px;color:rgba(255,255,255,0.35);font-size:11px;font-weight:700;cursor:pointer;white-space:nowrap;">'
            + 'üóë DELETE</button>';

        html += '<div id="pcard-' + app._key + '" style="background:rgba(15,23,42,0.5);border:1px solid rgba(255,255,255,0.07);border-radius:14px;padding:18px;margin-bottom:12px;">'
            + '<div style="display:flex;gap:14px;flex-wrap:wrap;">'

            // Icon block
            + '<div style="width:50px;height:50px;background:rgba(139,92,246,0.1);border:1px solid rgba(139,92,246,0.2);border-radius:13px;'
            + 'display:flex;align-items:center;justify-content:center;font-size:24px;flex-shrink:0;">' + icon + '</div>'

            // Info block
            + '<div style="flex:1;min-width:0;">'
            + '<div style="display:flex;align-items:center;gap:8px;flex-wrap:wrap;margin-bottom:3px;">'
            + '<span style="font-size:16px;font-weight:900;color:white;">' + _paEsc(app.storeName || '‚Äî') + '</span>'
            + '<span style="background:' + statusBg + ';border:1px solid ' + statusBorder + ';color:' + statusColor + ';'
            + 'font-size:9px;font-weight:900;padding:2px 9px;border-radius:20px;letter-spacing:1px;">' + statusLabel + '</span>'
            + '</div>'
            + '<div style="font-size:12px;color:rgba(255,255,255,0.45);margin-bottom:10px;">' + _paEsc(tLabel) + '</div>'
            + '<div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(190px,1fr));gap:5px 16px;">'
            + '<div style="font-size:12px;color:rgba(255,255,255,0.35);"><span style="color:rgba(255,255,255,0.6);font-weight:700;">May-ari: </span>' + _paEsc(app.ownerName || '‚Äî') + '</div>'
            + '<div style="font-size:12px;color:rgba(255,255,255,0.35);"><span style="color:rgba(255,255,255,0.6);font-weight:700;">Contact: </span>' + _paEsc(app.contact || '‚Äî') + '</div>'
            + '<div style="font-size:12px;color:rgba(255,255,255,0.35);grid-column:1/-1;"><span style="color:rgba(255,255,255,0.6);font-weight:700;">Address: </span>' + _paEsc(app.address || '‚Äî') + '</div>'
            + '<div style="font-size:10px;color:rgba(255,255,255,0.25);grid-column:1/-1;">üìÖ ' + date + (app.uid && app.uid !== 'guest' ? '  ¬∑  UID: ' + app.uid.slice(0,10) + '‚Ä¶' : '') + '</div>'
            + '</div>'
            + '</div>'

            // Actions
            + '<div style="display:flex;flex-direction:column;gap:6px;flex-shrink:0;justify-content:flex-start;">'
            + approveBtn + rejectBtn + resetBtn + deleteBtn
            + '</div>'

            + '</div>'
            + '</div>';
    });

    list.innerHTML = html;
    if (window.lucide) lucide.createIcons();
}

function setPartnerStatus(key, newStatus) {
    db.ref('partnerApplications/' + key + '/status').set(newStatus, function(err) {
        if (err) { alert('Error: ' + err.message); return; }
        var app = _paAll.find(function(a) { return a._key === key; });
        if (app) app.status = newStatus;
        _paUpdateCounts();
        _paRender();
        var msg = newStatus === 'approved' ? '‚úÖ Application APPROVED!' : newStatus === 'rejected' ? '‚ùå Application REJECTED.' : '‚Ü© Reset to PENDING.';
        if (typeof addActivityItem === 'function') addActivityItem(msg);
    });
}

function deletePartnerApp(key, name) {
    if (!confirm('DELETE ang application ni "' + name + '"?\n\nHindi na ito maibabalik.')) return;
    db.ref('partnerApplications/' + key).remove(function(err) {
        if (err) { alert('Error: ' + err.message); return; }
        _paAll = _paAll.filter(function(a) { return a._key !== key; });
        _paUpdateCounts();
        _paRender();
        if (typeof addActivityItem === 'function') addActivityItem('üóëÔ∏è Deleted partner app: ' + name);
    });
}

// Hook openTab ‚Äî load apps when partners tab is opened
(function() {
    var _origOT = window.openTab;
    window.openTab = function(tabId, btn) {
        _origOT(tabId, btn);
        if (tabId === 'partners-tab') loadPartnerApps();
        if (tabId === 'myshop-tab') { loadShopProducts(); loadShopVouchers(); loadShopOrders('all'); }
    };
})();

// ============================================================
// ===           MY SHOP ‚Äî DASHBOARD MANAGER JS            ===
// ============================================================

var _shopOrderFilter = 'all';

// ---- PRODUCTS ----
function saveShopProduct() {
    var key  = document.getElementById('shopEditKey').value.trim();
    var name = document.getElementById('shopPName').value.trim();
    var cat  = document.getElementById('shopPCategory').value;
    var price = parseInt(document.getElementById('shopPPrice').value) || 0;
    var del  = parseInt(document.getElementById('shopPDelivery').value) || 0;
    var stock = parseInt(document.getElementById('shopPStock').value) || 0;
    var emoji = document.getElementById('shopPEmoji').value.trim() || 'üè™';
    var image = document.getElementById('shopPImage').value.trim();
    var desc  = document.getElementById('shopPDesc').value.trim();
    var active = document.getElementById('shopPActive').checked;
    if (!name) return alert('‚ùå Product name is required!');
    if (!price || price < 1) return alert('‚ùå Please enter a valid price!');
    var data = { name:name, category:cat, price:price, deliveryFee:del, stock:stock, emoji:emoji, image:image, description:desc, isActive:active, updatedAt:Date.now() };
    var ref = key ? db.ref('shopProducts/' + key) : db.ref('shopProducts').push();
    if (!key) data.createdAt = Date.now();
    ref.update(data, function(err) {
        if (err) { alert('Error: ' + err.message); return; }
        if (typeof addActivityItem === 'function') addActivityItem((key?'‚úèÔ∏è Updated':'‚ûï Added') + ' shop product: ' + name);
        cancelShopEdit();
        loadShopProducts();
    });
}

function cancelShopEdit() {
    document.getElementById('shopEditKey').value = '';
    document.getElementById('shopPName').value = '';
    document.getElementById('shopPCategory').value = 'grocery';
    document.getElementById('shopPPrice').value = '';
    document.getElementById('shopPDelivery').value = '';
    document.getElementById('shopPStock').value = '';
    document.getElementById('shopPEmoji').value = '';
    document.getElementById('shopPImage').value = '';
    document.getElementById('shopPDesc').value = '';
    document.getElementById('shopPActive').checked = true;
    document.getElementById('shopFormTitle').textContent = '‚ûï ADD NEW PRODUCT';
    document.getElementById('shopCancelBtn').style.display = 'none';
}

function editShopProduct(key) {
    db.ref('shopProducts/' + key).once('value', function(snap) {
        var p = snap.val();
        if (!p) return;
        document.getElementById('shopEditKey').value = key;
        document.getElementById('shopPName').value = p.name || '';
        document.getElementById('shopPCategory').value = p.category || 'grocery';
        document.getElementById('shopPPrice').value = p.price || '';
        document.getElementById('shopPDelivery').value = p.deliveryFee || 0;
        document.getElementById('shopPStock').value = p.stock || 0;
        document.getElementById('shopPEmoji').value = p.emoji || '';
        document.getElementById('shopPImage').value = p.image || '';
        document.getElementById('shopPDesc').value = p.description || '';
        document.getElementById('shopPActive').checked = !!p.isActive;
        document.getElementById('shopFormTitle').textContent = '‚úèÔ∏è EDIT PRODUCT: ' + (p.name || '');
        document.getElementById('shopCancelBtn').style.display = 'inline-block';
        document.getElementById('shopProductForm').scrollIntoView({ behavior:'smooth' });
    });
}

function deleteShopProduct(key, name) {
    if (!confirm('DELETE "' + name + '"?\nHindi na ito maibabalik.')) return;
    db.ref('shopProducts/' + key).remove(function(err) {
        if (err) { alert('Error: ' + err.message); return; }
        if (typeof addActivityItem === 'function') addActivityItem('üóëÔ∏è Deleted shop product: ' + name);
        loadShopProducts();
    });
}

function toggleShopProductActive(key, current) {
    db.ref('shopProducts/' + key + '/isActive').set(!current, function(err) {
        if (!err) loadShopProducts();
    });
}

function loadShopProducts() {
    var list = document.getElementById('shopProductList');
    if (!list) return;
    list.innerHTML = '<div style="text-align:center;padding:40px;opacity:0.35;font-size:13px;font-weight:700;">Loading...</div>';
    db.ref('shopProducts').orderByChild('createdAt').once('value', function(snap) {
        var products = [];
        if (snap.exists()) {
            snap.forEach(function(c) { var d = c.val(); d._key = c.key; products.push(d); });
            products.reverse();
        }
        if (products.length === 0) {
            list.innerHTML = '<div style="text-align:center;padding:50px;opacity:0.35;"><div style="font-size:36px;margin-bottom:10px;">üì¶</div><div style="font-size:13px;font-weight:700;">No products yet. Add one to get started!</div></div>';
            return;
        }
        var catLabels = { grocery:'üõí Grocery', food:'üçú Food', snacks:'üç™ Snacks', personal:'üß¥ Personal Care', clothing:'üëï Clothing', electronics:'üì± Electronics', school:'üìö School', other:'üè™ Others' };
        var html = '<div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:14px;">';
        products.forEach(function(p) {
            var active = !!p.isActive;
            html += '<div style="background:rgba(15,23,42,0.6);border:1px solid rgba(255,255,255,' + (active?'0.1':'0.04') + ');border-radius:14px;padding:16px;position:relative;' + (!active?'opacity:0.5':'') + '">';
            // Image/emoji header
            html += '<div style="display:flex;gap:12px;align-items:flex-start;margin-bottom:12px;">';
            if (p.image) {
                html += '<img src="' + _paEsc(p.image) + '" style="width:56px;height:56px;border-radius:10px;object-fit:cover;border:1px solid rgba(255,255,255,0.1);" onerror="this.style.display=\'none\'">';
            } else {
                html += '<div style="width:56px;height:56px;background:rgba(139,92,246,0.15);border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:28px;flex-shrink:0;">' + (p.emoji || 'üè™') + '</div>';
            }
            html += '<div style="flex:1;min-width:0;">';
            html += '<div style="font-size:14px;font-weight:900;color:white;margin-bottom:2px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">' + _paEsc(p.name || '‚Äî') + '</div>';
            html += '<div style="font-size:10px;color:rgba(255,255,255,0.4);">' + (catLabels[p.category] || 'üè™ Others') + '</div>';
            html += '<div style="font-size:10px;color:rgba(255,255,255,0.3);margin-top:2px;">' + _paEsc(p.description || '') + '</div>';
            html += '</div></div>';
            // Price row
            html += '<div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:12px;">';
            html += '<div style="background:rgba(251,191,36,0.1);border:1px solid rgba(251,191,36,0.25);border-radius:8px;padding:8px 10px;">';
            html += '<div style="font-size:9px;color:rgba(255,255,255,0.4);font-weight:700;letter-spacing:1px;text-transform:uppercase;">Price</div>';
            html += '<div style="font-size:15px;font-weight:900;color:#fbbf24;">ü™ô ' + Number(p.price || 0).toLocaleString() + '</div></div>';
            html += '<div style="background:rgba(6,182,212,0.08);border:1px solid rgba(6,182,212,0.2);border-radius:8px;padding:8px 10px;">';
            html += '<div style="font-size:9px;color:rgba(255,255,255,0.4);font-weight:700;letter-spacing:1px;text-transform:uppercase;">Delivery</div>';
            html += '<div style="font-size:15px;font-weight:900;color:#06b6d4;">' + (p.deliveryFee > 0 ? 'ü™ô ' + Number(p.deliveryFee).toLocaleString() : 'üÜì FREE') + '</div></div>';
            html += '</div>';
            // Stock + controls
            html += '<div style="display:flex;align-items:center;justify-content:space-between;">';
            html += '<div style="font-size:11px;color:rgba(255,255,255,0.4);">Stock: <b style="color:' + (p.stock > 0 ? '#10b981' : '#ef4444') + ';">' + (p.stock || 0) + ' left</b></div>';
            html += '<div style="display:flex;gap:6px;">';
            html += '<button onclick="toggleShopProductActive(\'' + p._key + '\',' + active + ')" style="padding:5px 10px;background:' + (active?'rgba(16,185,129,0.15)':'rgba(255,255,255,0.06)') + ';border:1px solid ' + (active?'rgba(16,185,129,0.4)':'rgba(255,255,255,0.1)') + ';border-radius:7px;color:' + (active?'#10b981':'rgba(255,255,255,0.4)') + ';font-size:10px;font-weight:700;cursor:pointer;">' + (active?'‚úì ACTIVE':'‚óã HIDDEN') + '</button>';
            html += '<button onclick="editShopProduct(\'' + p._key + '\')" style="padding:5px 10px;background:rgba(139,92,246,0.15);border:1px solid rgba(139,92,246,0.3);border-radius:7px;color:#a78bfa;font-size:10px;font-weight:700;cursor:pointer;">‚úèÔ∏è EDIT</button>';
            html += '<button onclick="deleteShopProduct(\'' + p._key + '\',\'' + _paEsc(p.name||'') + '\')" style="padding:5px 10px;background:rgba(239,68,68,0.1);border:1px solid rgba(239,68,68,0.25);border-radius:7px;color:#ef4444;font-size:10px;font-weight:700;cursor:pointer;">üóë</button>';
            html += '</div></div>';
            html += '</div>';
        });
        html += '</div>';
        list.innerHTML = html;
    });
}

// ---- VOUCHERS ----
function saveShopVoucher() {
    var code    = document.getElementById('vcCode').value.trim().toUpperCase();
    var disc    = parseInt(document.getElementById('vcDiscount').value) || 0;
    var minOrd  = parseInt(document.getElementById('vcMinOrder').value) || 0;
    if (!code) return alert('‚ùå Enter a voucher code!');
    if (disc < 1 || disc > 100) return alert('‚ùå Discount must be 1‚Äì100%!');
    db.ref('shopVouchers/' + code).set({ code:code, discount:disc, minOrder:minOrd, isActive:true, createdAt:Date.now() }, function(err) {
        if (err) { alert('Error: ' + err.message); return; }
        document.getElementById('vcCode').value = '';
        document.getElementById('vcDiscount').value = '';
        document.getElementById('vcMinOrder').value = '';
        if (typeof addActivityItem === 'function') addActivityItem('üéüÔ∏è Created voucher: ' + code + ' (' + disc + '% off)');
        loadShopVouchers();
    });
}

function deleteShopVoucher(code) {
    if (!confirm('DELETE voucher "' + code + '"?')) return;
    db.ref('shopVouchers/' + code).remove(function(err) {
        if (!err) loadShopVouchers();
    });
}

function toggleShopVoucher(code, current) {
    db.ref('shopVouchers/' + code + '/isActive').set(!current, function(err) {
        if (!err) loadShopVouchers();
    });
}

function loadShopVouchers() {
    var list = document.getElementById('shopVoucherList');
    if (!list) return;
    db.ref('shopVouchers').once('value', function(snap) {
        if (!snap.exists()) {
            list.innerHTML = '<div style="text-align:center;padding:30px;opacity:0.35;font-size:13px;font-weight:700;">No voucher codes yet.</div>';
            return;
        }
        var html = '<div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:12px;">';
        snap.forEach(function(c) {
            var v = c.val();
            var active = v.isActive !== false;
            html += '<div style="background:' + (active?'rgba(251,191,36,0.08)':'rgba(255,255,255,0.03)') + ';border:1px dashed rgba(251,191,36,' + (active?'0.4':'0.1') + ');border-radius:12px;padding:14px;display:flex;align-items:center;gap:12px;' + (!active?'opacity:0.5':'') + '">';
            html += '<div style="font-size:22px;">üéüÔ∏è</div>';
            html += '<div style="flex:1;">';
            html += '<div style="font-size:15px;font-weight:900;color:#fbbf24;letter-spacing:2px;">' + _paEsc(v.code) + '</div>';
            html += '<div style="font-size:11px;color:rgba(255,255,255,0.5);margin-top:2px;">' + v.discount + '% OFF' + (v.minOrder > 0 ? ' ¬∑ Min: ü™ô' + Number(v.minOrder).toLocaleString() : ' ¬∑ No minimum') + '</div>';
            html += '</div>';
            html += '<div style="display:flex;flex-direction:column;gap:5px;">';
            html += '<button onclick="toggleShopVoucher(\'' + _paEsc(v.code) + '\',' + active + ')" style="padding:4px 9px;background:' + (active?'rgba(16,185,129,0.15)':'rgba(255,255,255,0.06)') + ';border:1px solid ' + (active?'rgba(16,185,129,0.4)':'rgba(255,255,255,0.1)') + ';border-radius:6px;color:' + (active?'#10b981':'rgba(255,255,255,0.4)') + ';font-size:9px;font-weight:800;cursor:pointer;">' + (active?'ACTIVE':'OFF') + '</button>';
            html += '<button onclick="deleteShopVoucher(\'' + _paEsc(v.code) + '\')" style="padding:4px 9px;background:rgba(239,68,68,0.1);border:1px solid rgba(239,68,68,0.25);border-radius:6px;color:#ef4444;font-size:9px;font-weight:800;cursor:pointer;">DELETE</button>';
            html += '</div></div>';
        });
        html += '</div>';
        list.innerHTML = html;
    });
}

// ---- ORDERS ----
function loadShopOrders(filter) {
    _shopOrderFilter = filter || 'all';
    var list = document.getElementById('shopOrderList');
    if (!list) return;
    list.innerHTML = '<div style="text-align:center;padding:40px;opacity:0.35;font-size:13px;font-weight:700;">Loading orders...</div>';
    db.ref('shopOrders').orderByChild('timestamp').once('value', function(snap) {
        var orders = [];
        if (snap.exists()) {
            snap.forEach(function(c) { var d = c.val(); d._key = c.key; orders.push(d); });
            orders.reverse();
        }
        if (_shopOrderFilter !== 'all') orders = orders.filter(function(o) { return (o.status || 'pending') === _shopOrderFilter; });
        if (orders.length === 0) {
            list.innerHTML = '<div style="text-align:center;padding:50px;opacity:0.35;"><div style="font-size:36px;margin-bottom:10px;">üì¶</div><div style="font-size:13px;font-weight:700;">No orders yet.</div></div>';
            return;
        }
        var statusColor = { pending:'#fbbf24', processing:'#06b6d4', completed:'#10b981', cancelled:'#ef4444' };
        var html = '';
        orders.forEach(function(o) {
            var sc = statusColor[o.status || 'pending'] || '#94a3b8';
            var date = o.timestamp ? new Date(o.timestamp).toLocaleString('en-PH',{year:'numeric',month:'short',day:'numeric',hour:'2-digit',minute:'2-digit'}) : '‚Äî';
            html += '<div id="sorder-' + o._key + '" style="background:rgba(15,23,42,0.5);border:1px solid rgba(255,255,255,0.07);border-radius:12px;padding:14px 16px;margin-bottom:10px;">';
            html += '<div style="display:flex;justify-content:space-between;align-items:flex-start;flex-wrap:wrap;gap:8px;">';
            html += '<div>';
            html += '<div style="font-size:13px;font-weight:900;color:white;margin-bottom:2px;">Order #' + (o._key || '').slice(-8).toUpperCase() + '</div>';
            html += '<div style="font-size:10px;color:rgba(255,255,255,0.35);">üìÖ ' + date + '</div>';
            html += '<div style="font-size:10px;color:rgba(255,255,255,0.35);">üë§ UID: ' + (o.buyerUid||'').slice(0,12) + '‚Ä¶</div>';
            html += '</div>';
            html += '<div style="display:flex;align-items:center;gap:10px;">';
            html += '<span style="background:' + sc + '20;border:1px solid ' + sc + '50;color:' + sc + ';font-size:10px;font-weight:900;padding:3px 10px;border-radius:20px;letter-spacing:0.5px;text-transform:uppercase;">' + (o.status || 'pending') + '</span>';
            html += '<div style="font-size:14px;font-weight:900;color:#fbbf24;">ü™ô ' + Number(o.totalCoins || 0).toLocaleString() + '</div>';
            html += '</div></div>';
            // Items summary
            if (o.items && o.items.length) {
                html += '<div style="margin-top:10px;padding-top:10px;border-top:1px solid rgba(255,255,255,0.05);">';
                html += '<div style="font-size:10px;color:rgba(255,255,255,0.35);font-weight:700;margin-bottom:6px;letter-spacing:0.5px;">ITEMS:</div>';
                o.items.forEach(function(it) {
                    html += '<div style="font-size:12px;color:rgba(255,255,255,0.7);margin-bottom:3px;">' + (it.emoji||'üì¶') + ' ' + _paEsc(it.name||'Item') + ' √ó ' + (it.qty||1) + ' ‚Äî ü™ô ' + Number((it.price||0)*(it.qty||1)).toLocaleString() + '</div>';
                });
                if (o.voucherCode) html += '<div style="font-size:11px;color:#10b981;margin-top:4px;">üéüÔ∏è Voucher: ' + _paEsc(o.voucherCode) + ' (-' + (o.discountPct||0) + '%)</div>';
                if (o.deliveryFee > 0) html += '<div style="font-size:11px;color:rgba(255,255,255,0.4);">üöö Delivery: ü™ô ' + Number(o.deliveryFee).toLocaleString() + '</div>';
                if (o.address) html += '<div style="font-size:11px;color:rgba(255,255,255,0.35);margin-top:4px;">üìç ' + _paEsc(o.address) + '</div>';
                html += '</div>';
            }
            // Status update buttons
            if ((o.status||'pending') !== 'completed' && (o.status||'pending') !== 'cancelled') {
                html += '<div style="display:flex;gap:7px;margin-top:10px;">';
                if ((o.status||'pending') === 'pending') html += '<button onclick="updateShopOrderStatus(\'' + o._key + '\',\'processing\')" style="padding:7px 14px;background:rgba(6,182,212,0.15);border:1px solid rgba(6,182,212,0.3);border-radius:8px;color:#06b6d4;font-size:11px;font-weight:700;cursor:pointer;">‚öôÔ∏è PROCESSING</button>';
                html += '<button onclick="updateShopOrderStatus(\'' + o._key + '\',\'completed\')" style="padding:7px 14px;background:rgba(16,185,129,0.15);border:1px solid rgba(16,185,129,0.3);border-radius:8px;color:#10b981;font-size:11px;font-weight:700;cursor:pointer;">‚úÖ COMPLETE</button>';
                html += '<button onclick="updateShopOrderStatus(\'' + o._key + '\',\'cancelled\')" style="padding:7px 14px;background:rgba(239,68,68,0.1);border:1px solid rgba(239,68,68,0.25);border-radius:8px;color:#ef4444;font-size:11px;font-weight:700;cursor:pointer;">‚ùå CANCEL</button>';
                html += '</div>';
            }
            html += '</div>';
        });
        list.innerHTML = html;
    });
}

function updateShopOrderStatus(key, newStatus) {
    db.ref('shopOrders/' + key + '/status').set(newStatus, function(err) {
        if (err) { alert('Error: ' + err.message); return; }
        if (typeof addActivityItem === 'function') addActivityItem('üì¶ Order ' + key.slice(-8) + ' ‚Üí ' + newStatus.toUpperCase());
        // Notify buyer via coinHistory
        db.ref('shopOrders/' + key).once('value', function(snap) {
            var o = snap.val();
            if (o && o.buyerUid && window.db) {
                var msg = newStatus === 'completed' ? '‚úÖ Your order has been completed!' : newStatus === 'cancelled' ? '‚ùå Your order was cancelled.' : '‚öôÔ∏è Your order is being processed.';
                db.ref('coinHistory/' + o.buyerUid).push({ label: 'üõçÔ∏è Shop Order: ' + msg, amount: 0, type: 'info', timestamp: Date.now() });
            }
            loadShopOrders(_shopOrderFilter);
        });
    });
}

// Live badge: watch pending count in real-time
db.ref('partnerApplications').orderByChild('status').equalTo('pending').on('value', function(snap) {
    var count = snap.exists() ? Object.keys(snap.val()).length : 0;
    var badge = document.getElementById('partnersBadge');
    if (badge) {
        badge.textContent = count;
        badge.style.display = count > 0 ? 'inline-block' : 'none';
    }
});

</script>
</body>
</html>
