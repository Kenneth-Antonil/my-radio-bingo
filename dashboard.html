<!DOCTYPE html>
<html lang="tl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Radio Bingo | Admin Master</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <style>
        :root { 
            --bg: #030712; 
            --surface: #111827; 
            --surface-br: #1f2937; 
            --accent: #3b82f6; 
            --text: #f8fafc; 
            --success: #10b981; 
            --danger: #ef4444; 
            --gold: #fbbf24; 
            --puro: #f97316;
            --bringme: #8b5cf6;
            --glass: rgba(255, 255, 255, 0.03);
        }
        * { box-sizing: border-box; }
        body { 
            font-family: 'Inter', sans-serif; 
            background: var(--bg); 
            color: var(--text); 
            margin: 0; 
            padding: 20px; 
            display: grid; 
            grid-template-columns: 280px 1fr; 
            gap: 20px; 
            height: 100vh;
            overflow: hidden;
        }

        /* TABS SYSTEM */
        .tabs-nav { display: flex; gap: 10px; margin-bottom: 20px; background: var(--surface); padding: 10px; border-radius: 16px; border: 1px solid var(--glass); }
        .tab-btn { flex: 1; padding: 12px; border-radius: 12px; border: none; background: transparent; color: #64748b; font-weight: 800; cursor: pointer; transition: 0.3s; display: flex; align-items: center; justify-content: center; gap: 8px; }
        .tab-btn.active { background: var(--accent); color: white; }
        .tab-content { display: none; height: calc(100vh - 120px); overflow-y: auto; padding-right: 10px; }
        .tab-content.active { display: block; }

        /* WINNER MARQUEE */
        .winner-marquee { background: var(--gold); color: black; padding: 8px; font-weight: 900; text-transform: uppercase; white-space: nowrap; overflow: hidden; position: relative; border-radius: 8px; margin-bottom: 15px; display: none; }
        .marquee-text { display: inline-block; animation: marquee 15s linear infinite; }
        @keyframes marquee { 0% { transform: translateX(100%); } 100% { transform: translateX(-100%); } }

        /* SIDEBAR & STATS */
        .sidebar { background: var(--surface); border-radius: 24px; padding: 20px; border: 1px solid var(--glass); overflow-y: auto; }
        .stat-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 20px; }
        .stat-card { background: var(--glass); padding: 15px; border-radius: 18px; text-align: center; }
        .stat-val { font-size: 20px; font-weight: 900; color: var(--gold); }
        .stat-lbl { font-size: 10px; opacity: 0.5; font-weight: 700; }

        /* BINGO CARDS MONITORING */
        .cards-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 15px; }
        .user-card-monitor { background: var(--surface-br); padding: 10px; border-radius: 16px; border: 2px solid transparent; transition: 0.2s; position: relative; }
        .user-card-monitor.puro { border-color: var(--puro); box-shadow: 0 0 15px rgba(249, 115, 22, 0.3); animation: pulse-puro 1.5s infinite; }
        .user-card-monitor.bingo { border-color: var(--success); background: #064e3b; box-shadow: 0 0 20px rgba(16, 185, 129, 0.5); }
        
        /* CAMERA SLOT */
        .cam-slot { width: 100%; aspect-ratio: 4/3; background: #000; border-radius: 8px; margin-bottom: 8px; overflow: hidden; display: flex; align-items: center; justify-content: center; border: 1px solid var(--glass); }
        .cam-slot video { width: 100%; height: 100%; object-fit: cover; }
        .no-cam { font-size: 8px; color: #4b5563; font-weight: 700; text-transform: uppercase; }

        .mini-bingo-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 2px; }
        .mini-cell { aspect-ratio: 1; background: rgba(0,0,0,0.5); font-size: 8px; display: flex; align-items: center; justify-content: center; border-radius: 2px; font-weight: 700; }
        .mini-cell.marked { background: var(--accent); color: white; }

        /* BRING ME GALLERY */
        .bringme-gallery { display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 15px; margin-top: 20px; }
        .photo-card { background: var(--surface-br); border-radius: 16px; overflow: hidden; border: 1px solid var(--glass); }
        .photo-card img { width: 100%; height: 150px; object-fit: cover; cursor: pointer; }
        .photo-info { padding: 10px; font-size: 11px; }

        /* COMMON COMPONENTS */
        .card { background: var(--surface); border-radius: 24px; padding: 24px; border: 1px solid var(--glass); margin-bottom: 20px; }
        .ball-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(45px, 1fr)); gap: 8px; }
        .ball { aspect-ratio: 1; background: var(--surface-br); border-radius: 12px; display: flex; align-items: center; justify-content: center; font-weight: 800; cursor: pointer; font-size: 14px; border: 1px solid var(--glass); }
        .ball.drawn { background: var(--accent); color: white; box-shadow: 0 0 15px rgba(59,130,246,0.4); }
        
        .btn { width: 100%; padding: 12px; border-radius: 12px; border: none; font-weight: 800; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; margin-top: 10px; }
        .btn-primary { background: var(--accent); color: white; }
        .btn-danger { background: var(--danger); color: white; }
        .btn-bringme { background: var(--bringme); color: white; }
        .btn-auto { background: var(--success); color: white; }
        
        input, select { width: 100%; background: var(--surface-br); border: 1px solid var(--glass); padding: 10px; border-radius: 10px; color: white; }
        label { display: block; font-size: 10px; font-weight: 800; color: #64748b; margin-bottom: 5px; text-transform: uppercase; }

        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-thumb { background: var(--surface-br); border-radius: 10px; }
    </style>
</head>
<body>

<div class="sidebar">
    <div style="font-size: 22px; font-weight: 900; margin-bottom: 25px;">ADMIN<span style="color:var(--accent)">PANEL</span></div>
    
    <div class="stat-grid">
        <div class="stat-card"><div class="stat-val" id="countOnline">0</div><div class="stat-lbl">ONLINE</div></div>
        <div class="stat-card"><div class="stat-val" id="countUsers">0</div><div class="stat-lbl">TOTAL</div></div>
    </div>

    <div class="card" style="padding: 15px; margin-bottom: 15px; background: rgba(16, 185, 129, 0.1); border: 1px solid var(--success);">
        <label style="color: var(--success);">Auto Draw Engine</label>
        <div style="display:flex; gap: 5px; margin-bottom: 5px;">
            <input type="number" id="autoInterval" value="5" style="width: 60px;" title="Seconds per ball">
            <span style="font-size: 10px; align-self: center;">SEC</span>
        </div>
        <button id="autoBtn" class="btn btn-auto" onclick="toggleAutoDraw()"><i data-lucide="play"></i> START AUTO</button>
    </div>

    <div class="input-group" style="margin-bottom: 15px;">
        <label>Next Draw Time</label>
        <input type="text" id="nextDrawIn" placeholder="e.g. 8:00 PM">
        <button class="btn btn-primary" onclick="setNextDraw()"><i data-lucide="clock"></i> Update</button>
    </div>

    <div class="card" style="padding: 15px; background: rgba(0,0,0,0.2);">
        <label>Live Active Users</label>
        <div id="activeUsersList" style="max-height: 150px; overflow-y: auto; font-size: 11px;"></div>
    </div>

    <button class="btn btn-danger" onclick="resetGame()"><i data-lucide="refresh-ccw"></i> RESET GAME</button>
    <button class="btn btn-primary" style="background:#4b5563" onclick="updateExistingUsers()"><i data-lucide="shield-check"></i> Fix Codes</button>
</div>

<div class="main-section">
    <div id="winnerAnnounce" class="winner-marquee">
        <div class="marquee-text" id="winnerMarqueeText">MAY NANALO NA! CONGRATULATIONS!</div>
    </div>

    <div class="tabs-nav">
        <button class="tab-btn active" onclick="openTab('bingo-tab', this)"><i data-lucide="layout-grid"></i> LIVE MONITOR</button>
        <button class="tab-btn" onclick="openTab('bringme-tab', this)"><i data-lucide="camera"></i> BRING ME</button>
        <button class="tab-btn" onclick="openTab('cashout-tab', this)"><i data-lucide="wallet"></i> CASHOUTS</button>
    </div>

    <div id="bingo-tab" class="tab-content active">
        <div style="display:grid; grid-template-columns: 320px 1fr; gap: 20px;">
            <div class="card">
                <h2>Control</h2>
                <div class="input-group">
                    <label>Pattern</label>
                    <select id="patternSelect" onchange="setPattern(this.value)">
                        <option value="Normal Bingo">Normal Bingo</option>
                        <option value="Blackout">Blackout</option>
                        <option value="Letter X">Letter X</option>
                        <option value="Four Corners">Four Corners</option>
                    </select>
                </div>
                <div id="lastBall" style="font-size: 70px; font-weight: 900; text-align: center; color: var(--accent); margin: 20px 0;">--</div>
                <div class="ball-grid" id="ballGrid"></div>
            </div>

            <div class="card">
                <h2>Live Player Cards (Realtime)</h2>
                <div class="cards-grid" id="liveCardsContainer"></div>
            </div>
        </div>
    </div>

    <div id="bringme-tab" class="tab-content">
        <div class="card" style="background: linear-gradient(145deg, #2e1065, #1e1b4b); border: 2px solid var(--bringme);">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                <h2 style="color:white; margin:0;"><i data-lucide="zap"></i> AI BRING ME</h2>
                <div id="bringmeStatusBadge" class="status-badge status-off">OFFLINE</div>
            </div>
            <div style="display:grid; grid-template-columns: 2fr 1fr 1fr; gap:15px; align-items:end;">
                <div class="input-group" style="margin:0;">
                    <label style="color:rgba(255,255,255,0.6)">Item Target</label>
                    <input type="text" id="bringmeItemIn" placeholder="e.g. Spoon">
                </div>
                <button class="btn btn-bringme" onclick="startBringMe()"><i data-lucide="play"></i> START</button>
                <button class="btn btn-danger" onclick="stopBringMe()"><i data-lucide="square"></i> STOP</button>
            </div>
        </div>
        <div class="card">
            <h2>Submissions</h2>
            <div class="bringme-gallery" id="bringmeGallery"></div>
        </div>
    </div>

    <div id="cashout-tab" class="tab-content">
        <div class="card"><h2>GCash Requests</h2><div id="cashoutList"></div></div>
    </div>
</div>

<script>
    lucide.createIcons();
    const firebaseConfig = { apiKey: "AIzaSyDIAQXJ15atKJxu7PtcFL1W9JnO1N14pVs", authDomain: "radiobingo-9ac29.firebaseapp.com", databaseURL: "https://radiobingo-9ac29-default-rtdb.asia-southeast1.firebasedatabase.app", projectId: "radiobingo-9ac29", storageBucket: "radiobingo-9ac29.firebasestorage.app", messagingSenderId: "965903993397", appId: "1:965903993397:web:f6646fa05225f147eebf7c" };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    let drawnNumbers = [];
    let autoIntervalIdx = null;

    // --- AUTO DRAW LOGIC ---
    function toggleAutoDraw() {
        const btn = document.getElementById('autoBtn');
        if(autoIntervalIdx) {
            clearInterval(autoIntervalIdx);
            autoIntervalIdx = null;
            btn.innerHTML = '<i data-lucide="play"></i> START AUTO';
            btn.className = 'btn btn-auto';
        } else {
            const sec = document.getElementById('autoInterval').value || 5;
            autoIntervalIdx = setInterval(drawBall, sec * 1000);
            btn.innerHTML = '<i data-lucide="pause"></i> STOP AUTO';
            btn.className = 'btn btn-danger';
        }
        lucide.createIcons();
    }

    function drawBall() {
        let available = [];
        for(let i=1; i<=75; i++) { if(!drawnNumbers.includes(i)) available.push(i); }
        if(available.length === 0) return toggleAutoDraw();
        const rand = available[Math.floor(Math.random() * available.length)];
        toggleBall(rand);
    }

    // --- REALTIME CARD MONITORING (FIXED) ---
    const userWatchers = {};
    db.ref('users').on('child_added', snapshot => {
        renderUserCard(snapshot.key, snapshot.val());
        // Watch for changes on this specific user
        db.ref('users/' + snapshot.key).on('value', s => {
            updateUserCardUI(s.key, s.val());
        });
    });

    function renderUserCard(uid, data) {
        if(!data.card) return;
        const container = document.getElementById('liveCardsContainer');
        if(document.getElementById('card-'+uid)) return;

        const div = document.createElement('div');
        div.id = 'card-' + uid;
        div.className = 'user-card-monitor';
        container.appendChild(div);
        updateUserCardUI(uid, data);
    }

    function updateUserCardUI(uid, data) {
        const el = document.getElementById('card-'+uid);
        if(!el || !data.card) return;

        let matches = 0;
        let gridHtml = '<div class="mini-bingo-grid">';
        data.card.forEach(n => {
            const isMarked = drawnNumbers.includes(n) || n === "FREE";
            if(isMarked) matches++;
            gridHtml += `<div class="mini-cell ${isMarked ? 'marked' : ''}">${n === "FREE" ? '‚≠ê' : n}</div>`;
        });
        gridHtml += '</div>';

        const isBingo = data.hasWonCurrent;
        const isPuro = matches >= 23 && !isBingo;
        el.className = `user-card-monitor ${isBingo ? 'bingo' : ''} ${isPuro ? 'puro' : ''}`;

        el.innerHTML = `
            <div class="cam-slot" id="cam-${uid}"><div class="no-cam">NO LIVE FEED</div></div>
            <div style="font-size:10px; font-weight:800; display:flex; justify-content:space-between; margin-bottom:5px;">
                <span>${(data.name || 'User').split(' ')[0]}</span>
                <span style="color:var(--gold)">${matches}/24</span>
            </div>
            ${gridHtml}
        `;
    }

    // --- CORE BINGO FUNCTIONS ---
    for(let i=1; i<=75; i++) {
        let b = document.createElement('div');
        b.className = 'ball'; b.id = 'ball-'+i; b.innerText = i;
        b.onclick = () => toggleBall(i);
        document.getElementById('ballGrid').appendChild(b);
    }

    function toggleBall(num) {
        const ref = db.ref('drawnNumbers/' + num);
        ref.once('value', s => {
            if(s.exists()) ref.remove();
            else ref.set(num);
        });
    }

    db.ref('drawnNumbers').on('value', s => {
        drawnNumbers = s.val() ? Object.values(s.val()) : [];
        document.querySelectorAll('.ball').forEach(b => b.classList.remove('drawn'));
        drawnNumbers.forEach(n => document.getElementById('ball-'+n)?.classList.add('drawn'));
        document.getElementById('lastBall').innerText = drawnNumbers.length ? drawnNumbers[drawnNumbers.length-1] : "--";
        
        // Refresh all cards in UI when a new ball is drawn
        db.ref('users').once('value', snap => {
            snap.forEach(u => updateUserCardUI(u.key, u.val()));
        });
    });

    // --- OTHER UI LOGIC (RETAINED) ---
    function openTab(tabId, btn) {
        document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.getElementById(tabId).classList.add('active');
        btn.classList.add('active');
    }

    db.ref('status').on('value', s => {
        document.getElementById('countOnline').innerText = s.numChildren();
        const list = document.getElementById('activeUsersList'); list.innerHTML = "";
        s.forEach(u => {
            db.ref('users/' + u.key + '/name').once('value', n => {
                list.innerHTML += `<div style="padding:4px 0; border-bottom:1px solid var(--glass)">üü¢ ${n.val() || 'User'}</div>`;
            });
        });
    });

    function resetGame() {
        if(!confirm("Reset everything?")) return;
        db.ref('drawnNumbers').remove();
        db.ref('gameState/latestWinner').remove();
        db.ref('users').once('value', s => {
            s.forEach(u => db.ref('users/'+u.key).update({ hasWonCurrent: false }));
        });
    }

    // Winner & Bring Me & Cashout logic remains exactly as provided in your original file
    db.ref('gameState/latestWinner').on('value', s => {
        const marquee = document.getElementById('winnerAnnounce');
        if(s.exists()) {
            marquee.style.display = 'block';
            document.getElementById('winnerMarqueeText').innerText = `üéâ BINGO WINNER: ${s.val().name}! üéâ`;
            if(autoIntervalIdx) toggleAutoDraw();
        } else marquee.style.display = 'none';
    });

    function setPattern(p) { db.ref('gameState/currentPattern').set(p); }
    function setNextDraw() { db.ref('gameState/nextDraw').set(document.getElementById('nextDrawIn').value); alert("Saved!"); }
    
    // CASHOUTS & GALLERY (Original Logic)
    db.ref('redemptions').on('value', s => {
        const list = document.getElementById('cashoutList'); list.innerHTML = "";
        s.forEach(child => {
            const r = child.val(); if(r.status !== 'pending') return;
            list.innerHTML += `<div class="card" style="padding:15px; margin-bottom:10px;">
                <b>${r.name}</b> - ${r.item} (${r.gcash})
                <button onclick="updateStatus('${child.key}','sent')">PAID</button>
            </div>`;
        });
    });

    function updateStatus(key, status) { db.ref('redemptions/' + key).update({ status: status }); }
</script>
</body>
</html>
