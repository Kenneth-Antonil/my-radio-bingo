<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#060d1a">
    <title>RB Live ¬∑ DJ Console</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;900&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <style>
        :root {
            --bg:#060d1a; --surface:rgba(15,25,50,0.9); --panel:rgba(10,18,38,0.98);
            --border:rgba(255,255,255,0.07); --border2:rgba(255,255,255,0.12);
            --accent:#0ea5e9; --glow:#38bdf8; --ok:#10b981; --err:#ef4444;
            --warn:#f97316; --gold:#fbbf24; --muted:rgba(255,255,255,0.35);
            --r:12px; --rs:8px;
        }
        *{box-sizing:border-box;margin:0;padding:0;-webkit-tap-highlight-color:transparent;user-select:none;}
        html,body{font-family:'Inter',sans-serif;background:var(--bg);color:#fff;min-height:100vh;overflow-x:hidden;}

        /* GATE */
        #gate{display:flex;position:fixed;inset:0;z-index:9999;background:var(--bg);flex-direction:column;align-items:center;justify-content:center;padding:32px;}
        #gate.h{display:none;} #dj{display:none;} #dj.s{display:block;}
        .gc{background:rgba(15,25,50,0.98);border:1px solid var(--border2);border-radius:22px;padding:36px 28px;width:100%;max-width:340px;box-shadow:0 20px 60px rgba(0,0,0,0.7);}
        .gl{text-align:center;font-size:26px;font-weight:900;margin-bottom:4px;letter-spacing:-1px;}
        .gl span{color:var(--glow);}
        .gs{text-align:center;font-size:11px;color:var(--muted);margin-bottom:26px;font-weight:700;text-transform:uppercase;letter-spacing:1.5px;}
        .giw{position:relative;margin-bottom:10px;}
        .gi{width:100%;background:rgba(0,0,0,0.4);border:1px solid rgba(255,255,255,0.1);border-radius:12px;padding:14px 46px 14px 16px;color:#fff;font-family:'Inter',sans-serif;font-size:20px;font-weight:700;letter-spacing:8px;text-align:center;outline:none;transition:border-color .2s;}
        .gi::placeholder{letter-spacing:2px;font-size:13px;font-weight:500;color:var(--muted);}
        .gi:focus{border-color:rgba(14,165,233,0.5);}
        .gi.shake{animation:shake .4s ease;border-color:rgba(239,68,68,0.6);}
        @keyframes shake{0%,100%{transform:translateX(0)}20%,60%{transform:translateX(-8px)}40%,80%{transform:translateX(8px)}}
        .geye{position:absolute;right:13px;top:50%;transform:translateY(-50%);background:none;border:none;color:var(--muted);cursor:pointer;padding:4px;display:flex;}
        .gerr{font-size:12px;color:var(--err);font-weight:600;min-height:18px;margin-bottom:10px;text-align:center;}
        .gbtn{width:100%;padding:14px;background:linear-gradient(135deg,var(--accent),#0369a1);border:none;border-radius:12px;color:#fff;font-family:'Inter',sans-serif;font-size:14px;font-weight:800;cursor:pointer;box-shadow:0 4px 16px rgba(14,165,233,0.4);transition:all .2s;}
        .gbk{display:block;text-align:center;margin-top:14px;font-size:12px;color:var(--muted);background:none;border:none;cursor:pointer;font-family:'Inter',sans-serif;font-weight:600;}

        /* TOAST */
        #toast{position:fixed;top:70px;left:50%;transform:translateX(-50%) translateY(-200%);background:rgba(6,13,26,0.98);border:1px solid var(--accent);padding:10px 20px;border-radius:var(--rs);font-size:13px;font-weight:700;z-index:9998;white-space:nowrap;backdrop-filter:blur(12px);transition:transform .35s cubic-bezier(.175,.885,.32,1.275);box-shadow:0 8px 30px rgba(0,0,0,0.5);pointer-events:none;}
        #toast.s{transform:translateX(-50%) translateY(0);}

        /* NAV */
        .nav{position:sticky;top:0;z-index:500;background:rgba(6,13,26,0.99);backdrop-filter:blur(20px);border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;padding:11px 14px;}
        .nav-back{width:34px;height:34px;border-radius:50%;border:1px solid var(--border2);background:rgba(255,255,255,0.04);color:#fff;display:flex;align-items:center;justify-content:center;cursor:pointer;}
        .nav-title{font-size:15px;font-weight:900;letter-spacing:-.3px;}
        .nav-title span{color:var(--glow);}
        .nav-right{display:flex;align-items:center;gap:7px;}
        .pill{display:flex;align-items:center;gap:5px;font-size:10px;font-weight:800;padding:4px 9px;border-radius:20px;letter-spacing:.5px;border:1px solid;}
        .pill.live{background:rgba(16,185,129,0.1);border-color:rgba(16,185,129,0.3);color:var(--ok);}
        .pill.offline{background:rgba(239,68,68,0.1);border-color:rgba(239,68,68,0.3);color:var(--err);}
        .pill.music{background:rgba(14,165,233,0.1);border-color:rgba(14,165,233,0.3);color:var(--glow);}
        .pill-dot{width:6px;height:6px;border-radius:50%;background:currentColor;animation:blink 1.2s ease infinite;}
        @keyframes blink{0%,100%{opacity:1}50%{opacity:.2}}
        .nav-btn{width:34px;height:34px;border-radius:50%;border:1px solid var(--border2);background:rgba(255,255,255,0.04);color:var(--muted);display:flex;align-items:center;justify-content:center;cursor:pointer;transition:all .2s;}
        .nav-btn:hover{background:rgba(14,165,233,0.1);border-color:rgba(14,165,233,0.35);color:var(--glow);}

        /* CONSOLE */
        .console{max-width:520px;margin:0 auto;padding:12px 12px 50px;display:flex;flex-direction:column;gap:10px;}

        /* SECTION HEADER */
        .sh{font-size:9px;font-weight:800;letter-spacing:1.5px;text-transform:uppercase;color:var(--muted);margin-bottom:5px;display:flex;align-items:center;gap:5px;}
        .sh i{width:10px;height:10px;}

        /* ‚ë† BROADCAST STRIP */
        .bcast{background:var(--panel);border:1px solid var(--border);border-radius:var(--r);padding:10px 12px;display:flex;align-items:center;gap:8px;}
        .live-btn{flex:1;display:flex;align-items:center;justify-content:center;gap:7px;padding:10px 0;border-radius:var(--rs);border:none;font-family:'Inter',sans-serif;font-size:12px;font-weight:800;cursor:pointer;transition:all .2s;letter-spacing:.3px;}
        .live-btn.off{background:rgba(16,185,129,0.08);border:1px solid rgba(16,185,129,0.25);color:var(--ok);}
        .live-btn.off:active{background:rgba(16,185,129,0.18);}
        .live-btn.on{background:linear-gradient(135deg,var(--ok),#047857);border:1px solid transparent;color:#fff;box-shadow:0 0 20px rgba(16,185,129,0.4);animation:livep 2s ease infinite;}
        @keyframes livep{0%,100%{box-shadow:0 0 20px rgba(16,185,129,0.35)}50%{box-shadow:0 0 32px rgba(16,185,129,0.65)}}
        .force-btn{padding:10px 11px;border-radius:var(--rs);border:1px solid rgba(239,68,68,0.25);background:rgba(239,68,68,0.06);color:rgba(239,68,68,0.7);font-family:'Inter',sans-serif;font-size:11px;font-weight:800;cursor:pointer;transition:all .2s;white-space:nowrap;}
        .force-btn.on{background:linear-gradient(135deg,var(--err),#991b1b);border-color:transparent;color:#fff;box-shadow:0 0 14px rgba(239,68,68,0.4);}
        .bcast-ctd{text-align:right;flex-shrink:0;}
        .ctd-v{font-size:13px;font-weight:900;color:var(--gold);line-height:1;}
        .ctd-l{font-size:8px;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:.5px;margin-top:2px;}

        /* ‚ë° MIXER */
        .mixer{background:linear-gradient(170deg,rgba(10,20,42,0.99),rgba(6,13,26,0.99));border:1px solid var(--border2);border-radius:var(--r);padding:13px 10px 10px;position:relative;overflow:hidden;}
        .mixer::before{content:'';position:absolute;top:0;left:0;right:0;height:2px;background:linear-gradient(90deg,var(--accent),#8b5cf6,var(--ok));}
        .mixer-chs{display:flex;gap:7px;}
        .ch{flex:1;display:flex;flex-direction:column;align-items:center;gap:6px;background:rgba(0,0,0,0.3);border:1px solid var(--border);border-radius:10px;padding:10px 5px 8px;}
        .ch-ico{font-size:16px;line-height:1;}
        .ch-nm{font-size:7px;font-weight:800;text-transform:uppercase;letter-spacing:.8px;color:var(--muted);}
        .ch-pct{font-size:13px;font-weight:900;}
        .ch.music .ch-pct{color:var(--accent);}
        .ch.mic   .ch-pct{color:var(--err);}
        .ch.sfx   .ch-pct{color:var(--ok);}
        .fader{-webkit-appearance:none;appearance:none;width:100%;height:3px;border-radius:2px;outline:none;cursor:pointer;}
        .fader.music{background:rgba(14,165,233,0.2);}
        .fader.mic{background:rgba(239,68,68,0.2);}
        .fader.sfx{background:rgba(16,185,129,0.2);}
        .fader.music::-webkit-slider-thumb{-webkit-appearance:none;width:20px;height:20px;border-radius:50%;background:linear-gradient(135deg,var(--accent),#0369a1);border:2px solid rgba(255,255,255,0.2);box-shadow:0 2px 10px rgba(14,165,233,0.55);cursor:pointer;}
        .fader.mic::-webkit-slider-thumb  {-webkit-appearance:none;width:20px;height:20px;border-radius:50%;background:linear-gradient(135deg,var(--err),#b91c1c);border:2px solid rgba(255,255,255,0.2);box-shadow:0 2px 10px rgba(239,68,68,0.55);cursor:pointer;}
        .fader.sfx::-webkit-slider-thumb  {-webkit-appearance:none;width:20px;height:20px;border-radius:50%;background:linear-gradient(135deg,var(--ok),#047857);border:2px solid rgba(255,255,255,0.2);box-shadow:0 2px 10px rgba(16,185,129,0.55);cursor:pointer;}
        .fader.music::-moz-range-thumb{width:20px;height:20px;border-radius:50%;background:linear-gradient(135deg,var(--accent),#0369a1);border:2px solid rgba(255,255,255,0.2);cursor:pointer;}
        .fader.mic::-moz-range-thumb  {width:20px;height:20px;border-radius:50%;background:linear-gradient(135deg,var(--err),#b91c1c);border:2px solid rgba(255,255,255,0.2);cursor:pointer;}
        .fader.sfx::-moz-range-thumb  {width:20px;height:20px;border-radius:50%;background:linear-gradient(135deg,var(--ok),#047857);border:2px solid rgba(255,255,255,0.2);cursor:pointer;}

        /* ‚ë¢ NOW PLAYING */
        .np{background:var(--panel);border:1px solid var(--border);border-radius:var(--r);padding:13px;}
        .np-row{display:flex;align-items:center;gap:11px;margin-bottom:9px;}
        .np-disc{width:40px;height:40px;border-radius:50%;background:linear-gradient(135deg,rgba(14,165,233,0.18),rgba(10,18,38,0.9));border:2px solid rgba(14,165,233,0.28);display:flex;align-items:center;justify-content:center;flex-shrink:0;}
        .np-disc.spin{animation:spin 3s linear infinite;}
        @keyframes spin{to{transform:rotate(360deg)}}
        .np-dot{width:8px;height:8px;border-radius:50%;background:var(--bg);border:2px solid rgba(255,255,255,0.08);}
        .np-info{flex:1;min-width:0;}
        .np-name{font-size:13px;font-weight:800;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
        .np-sub{font-size:10px;color:var(--muted);font-weight:600;margin-top:1px;}
        .np-ctrls{display:flex;gap:5px;flex-shrink:0;}
        .npb{width:34px;height:34px;border-radius:50%;border:none;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all .2s;}
        .npb.sk{background:rgba(255,255,255,0.06);color:#fff;}
        .npb.pp{background:linear-gradient(135deg,var(--accent),#0369a1);color:#fff;box-shadow:0 3px 10px rgba(14,165,233,0.4);}
        .npb i{width:14px;height:14px;}
        .np-prog{height:3px;background:rgba(255,255,255,0.07);border-radius:2px;overflow:hidden;}
        .np-fill{height:100%;background:linear-gradient(90deg,var(--accent),var(--glow));border-radius:2px;transition:width .5s linear;width:0%;}
        .np-time{display:flex;justify-content:space-between;font-size:9px;color:var(--muted);font-weight:700;margin-top:3px;}

        /* ‚ë£ QUEUE */
        .q-panel{background:var(--panel);border:1px solid var(--border);border-radius:var(--r);overflow:hidden;}
        .q-hd{display:flex;align-items:center;justify-content:space-between;padding:10px 13px;border-bottom:1px solid var(--border);}
        .q-hd-l{font-size:9px;font-weight:800;letter-spacing:1.3px;text-transform:uppercase;color:var(--muted);display:flex;align-items:center;gap:5px;}
        .q-hd-r{display:flex;gap:5px;}
        .qbtn{padding:5px 9px;border-radius:6px;border:1px solid var(--border);background:rgba(255,255,255,0.04);color:rgba(255,255,255,0.55);font-family:'Inter',sans-serif;font-size:10px;font-weight:700;cursor:pointer;display:flex;align-items:center;gap:4px;}
        .qbtn i{width:10px;height:10px;}
        .qbtn.add{background:rgba(14,165,233,0.08);border-color:rgba(14,165,233,0.25);color:var(--glow);}
        .qbtn.del{background:rgba(239,68,68,0.06);border-color:rgba(239,68,68,0.2);color:rgba(239,68,68,0.7);}
        .q-list{max-height:190px;overflow-y:auto;scrollbar-width:thin;scrollbar-color:rgba(255,255,255,0.08) transparent;}
        .q-list::-webkit-scrollbar{width:3px;}
        .q-list::-webkit-scrollbar-thumb{background:rgba(255,255,255,0.08);border-radius:2px;}
        .qi{display:flex;align-items:center;gap:8px;padding:8px 13px;border-bottom:1px solid rgba(255,255,255,0.04);}
        .qi:last-child{border-bottom:none;}
        .qi.pl{background:rgba(14,165,233,0.05);}
        .qi-num{width:18px;font-size:9px;font-weight:800;color:var(--muted);text-align:center;flex-shrink:0;}
        .qi.pl .qi-num{color:var(--accent);}
        .qi-name{flex:1;font-size:12px;font-weight:700;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
        .qi-dur{font-size:9px;color:var(--muted);font-weight:600;flex-shrink:0;}
        .qi-acts{display:flex;gap:4px;flex-shrink:0;}
        .ta{width:24px;height:24px;border-radius:5px;border:1px solid var(--border);background:rgba(255,255,255,0.03);color:var(--muted);display:flex;align-items:center;justify-content:center;cursor:pointer;transition:all .15s;}
        .ta:hover{background:rgba(255,255,255,0.1);color:#fff;}
        .ta.rp:hover{background:rgba(14,165,233,0.12);border-color:rgba(14,165,233,0.35);color:var(--accent);}
        .ta.dl:hover{background:rgba(239,68,68,0.12);border-color:rgba(239,68,68,0.3);color:var(--err);}
        .ta i{width:10px;height:10px;}
        .q-empty{text-align:center;padding:18px;color:var(--muted);font-size:12px;font-weight:600;}

        /* ‚ë§ MIC */
        .mic-panel{background:var(--panel);border:1px solid var(--border);border-radius:var(--r);padding:13px;display:flex;align-items:center;gap:13px;}
        .mic-btn{width:68px;height:68px;border-radius:50%;border:3px solid rgba(239,68,68,0.2);background:rgba(239,68,68,0.06);color:rgba(239,68,68,0.45);display:flex;align-items:center;justify-content:center;cursor:pointer;transition:all .25s;flex-shrink:0;position:relative;}
        .mic-btn i{width:27px;height:27px;}
        .mic-btn:hover{border-color:rgba(239,68,68,0.45);color:var(--err);}
        .mic-btn.on{border-color:var(--err);background:rgba(239,68,68,0.14);color:var(--err);animation:mp 1.6s ease infinite;}
        @keyframes mp{0%,100%{box-shadow:0 0 0 0 rgba(239,68,68,0.4)}60%{box-shadow:0 0 0 12px rgba(239,68,68,0)}}
        .mic-btn.on::after{content:'REC';position:absolute;bottom:-5px;font-size:7px;font-weight:900;letter-spacing:1px;background:var(--err);color:#fff;padding:1px 5px;border-radius:20px;}
        .mic-r{flex:1;min-width:0;}
        .mic-st{font-size:13px;font-weight:800;margin-bottom:3px;}
        .mic-sb{font-size:10px;color:var(--muted);font-weight:600;margin-bottom:7px;}
        .vubars{display:flex;align-items:flex-end;gap:2px;height:32px;}
        .vubar{flex:1;background:rgba(255,255,255,0.07);border-radius:2px;min-height:3px;transition:height .07s ease;}
        .mic-meta{display:flex;gap:8px;margin-top:7px;}
        .mic-chip{background:rgba(0,0,0,0.3);border:1px solid var(--border);border-radius:6px;padding:4px 9px;font-size:9px;font-weight:700;color:var(--muted);text-align:center;}
        .mic-chip span{display:block;font-size:12px;font-weight:900;color:#fff;margin-bottom:1px;}

        /* ‚ë• PADS */
        .pads-panel{background:var(--panel);border:1px solid var(--border);border-radius:var(--r);padding:13px;}
        .pgrid{display:grid;grid-template-columns:repeat(4,1fr);gap:7px;}
        .pad{position:relative;aspect-ratio:1;border-radius:var(--rs);border:1px solid rgba(255,255,255,0.07);display:flex;flex-direction:column;align-items:center;justify-content:center;cursor:pointer;transition:all .1s;overflow:hidden;background:rgba(0,0,0,0.25);}
        .pad:active,.pad.pfx{transform:scale(0.87);filter:brightness(1.7);}
        .pad.hs{border-color:rgba(255,255,255,0.13);}
        .pad.emp{opacity:.55;}
        .pe{font-size:19px;margin-bottom:3px;pointer-events:none;}
        .plbl{font-size:8px;font-weight:800;text-align:center;padding:0 3px;pointer-events:none;color:rgba(255,255,255,0.85);line-height:1.2;letter-spacing:.2px;}
        .pad.emp .plbl{color:var(--muted);font-size:11px;}
        .pedit{position:absolute;top:3px;right:3px;width:17px;height:17px;border-radius:4px;background:rgba(0,0,0,0.55);border:none;color:rgba(255,255,255,0.3);display:flex;align-items:center;justify-content:center;cursor:pointer;opacity:0;transition:opacity .15s;}
        .pad:hover .pedit{opacity:1;}
        .pedit i{width:9px;height:9px;}
        .sfx-last{font-size:10px;color:var(--muted);font-weight:600;margin-top:8px;padding-top:7px;border-top:1px solid var(--border);}

        /* MODALS */
        .mo{display:none;position:fixed;inset:0;z-index:9000;background:rgba(0,0,0,0.78);backdrop-filter:blur(6px);align-items:flex-end;}
        .mo.s{display:flex;}
        .msh{background:rgba(8,16,34,0.99);border-top:1px solid var(--border2);border-radius:20px 20px 0 0;padding:16px 16px 38px;width:100%;max-width:520px;margin:0 auto;animation:su .3s ease;max-height:92vh;overflow-y:auto;}
        @keyframes su{from{transform:translateY(100%)}to{transform:translateY(0)}}
        .mhd{width:38px;height:4px;background:rgba(255,255,255,0.18);border-radius:2px;margin:0 auto 14px;}
        .mtit{font-size:16px;font-weight:900;margin-bottom:14px;}
        .f{margin-bottom:12px;}
        .f label{display:block;font-size:10px;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:.5px;margin-bottom:5px;}
        .f input,.f textarea{width:100%;background:rgba(0,0,0,0.35);border:1px solid var(--border2);border-radius:var(--rs);padding:10px 13px;color:#fff;font-family:'Inter',sans-serif;font-size:13px;font-weight:500;outline:none;transition:border-color .2s;}
        .f input::placeholder,.f textarea::placeholder{color:var(--muted);}
        .f input:focus,.f textarea:focus{border-color:rgba(14,165,233,0.5);}
        .fh{font-size:10px;color:var(--muted);margin-top:4px;font-weight:600;}
        .brow{display:flex;gap:8px;}
        .btn{display:inline-flex;align-items:center;justify-content:center;gap:6px;padding:10px 16px;border-radius:var(--rs);font-family:'Inter',sans-serif;font-size:12px;font-weight:700;cursor:pointer;border:none;transition:all .2s;width:100%;}
        .btn i{width:13px;height:13px;flex-shrink:0;}
        .bp{background:linear-gradient(135deg,var(--accent),#0369a1);color:#fff;box-shadow:0 4px 14px rgba(14,165,233,0.28);}
        .bg{background:rgba(255,255,255,0.05);color:rgba(255,255,255,0.65);border:1px solid var(--border2);}
        .trow{display:flex;align-items:center;justify-content:space-between;padding:7px 0;}
        .tinfo .tl{font-size:13px;font-weight:600;}
        .tinfo .td{font-size:10px;color:var(--muted);margin-top:2px;}
        .tsw{position:relative;width:44px;height:24px;flex-shrink:0;cursor:pointer;}
        .tsw input{opacity:0;width:0;height:0;position:absolute;}
        .ttr{position:absolute;inset:0;background:rgba(255,255,255,0.09);border-radius:20px;border:1px solid var(--border);transition:background .3s;}
        .ttr::after{content:'';position:absolute;top:3px;left:3px;width:16px;height:16px;border-radius:50%;background:#fff;transition:transform .3s;box-shadow:0 2px 4px rgba(0,0,0,0.4);}
        .tsw input:checked+.ttr{background:var(--accent);border-color:var(--accent);}
        .tsw input:checked+.ttr::after{transform:translateX(20px);}
        .dv{height:1px;background:var(--border);margin:4px 0;}
        .uz{border:2px dashed rgba(14,165,233,0.22);border-radius:var(--r);padding:20px;text-align:center;cursor:pointer;transition:all .2s;background:rgba(14,165,233,0.02);position:relative;}
        .uz:hover{border-color:var(--accent);background:rgba(14,165,233,0.06);}
        .uz input[type=file]{position:absolute;inset:0;opacity:0;cursor:pointer;width:100%;height:100%;}
        .ubtrack{height:3px;background:rgba(255,255,255,0.07);border-radius:2px;overflow:hidden;margin-bottom:4px;}
        .ubfill{height:100%;background:linear-gradient(90deg,var(--accent),var(--glow));border-radius:2px;transition:width .3s;width:0%;}
        .ubtxt{font-size:11px;color:var(--glow);font-weight:700;text-align:center;}
        .tlist{display:flex;flex-direction:column;gap:6px;margin-top:10px;}
        .ti{display:flex;align-items:center;gap:9px;background:rgba(0,0,0,0.3);border:1px solid var(--border);border-radius:var(--rs);padding:9px 11px;}
        .tthumb{width:34px;height:34px;border-radius:7px;background:rgba(14,165,233,0.1);display:flex;align-items:center;justify-content:center;flex-shrink:0;font-size:14px;}
        .tname{font-size:12px;font-weight:700;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
        .tmeta{font-size:10px;color:var(--muted);font-weight:600;display:flex;gap:7px;margin-top:1px;}
        .tacts{display:flex;gap:4px;flex-shrink:0;}
        .cpick{display:flex;flex-wrap:wrap;gap:7px;margin-bottom:12px;}
        .csw{width:28px;height:28px;border-radius:50%;cursor:pointer;border:2px solid transparent;transition:all .2s;}
        .csw.sel{border-color:#fff;transform:scale(1.15);}
        .epick{display:flex;flex-wrap:wrap;gap:6px;margin-bottom:12px;font-size:20px;}
        .eopt{cursor:pointer;padding:4px;border-radius:6px;transition:background .12s;}
        .eopt:hover,.eopt.sel{background:rgba(255,255,255,0.1);}
        .sfxuz{border:1px dashed rgba(14,165,233,0.22);border-radius:var(--rs);padding:12px 14px;text-align:center;cursor:pointer;transition:all .2s;background:rgba(14,165,233,0.02);position:relative;}
        .sfxuz:hover{border-color:var(--accent);}
        .sfxuz input[type=file]{position:absolute;inset:0;opacity:0;cursor:pointer;width:100%;height:100%;}
        .sb{background:rgba(0,0,0,0.3);border:1px solid var(--border);border-radius:var(--rs);padding:9px 12px;font-size:11px;font-weight:600;color:var(--muted);display:flex;align-items:center;gap:7px;margin-top:10px;}
        .sb i{width:12px;height:12px;flex-shrink:0;}
        .sb.ok{background:rgba(16,185,129,0.07);border-color:rgba(16,185,129,0.2);color:var(--ok);}
        .sb.err{background:rgba(239,68,68,0.07);border-color:rgba(239,68,68,0.2);color:var(--err);}
        .lcnt{font-size:11px;color:var(--muted);font-weight:700;text-align:center;padding:7px 0;}
        .es{text-align:center;padding:22px;color:var(--muted);}
        .es-ic{font-size:28px;margin-bottom:6px;}
        .es-tx{font-size:12px;font-weight:600;}
    </style>
</head>
<body>

<!-- GATE -->
<div id="gate">
    <div class="gc">
        <div class="gl">RB <span>LIVE</span></div>
        <div class="gs">DJ Control Console</div>
        <div class="giw">
            <input class="gi" type="password" id="gi" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" maxlength="20" onkeydown="if(event.key==='Enter')chkPw()">
            <button class="geye" onclick="togEye()" id="geyebtn"><i data-lucide="eye" style="width:18px;height:18px;" id="geyeic"></i></button>
        </div>
        <div class="gerr" id="gerr"></div>
        <button class="gbtn" onclick="chkPw()">üîì Unlock Console</button>
        <button class="gbk" onclick="location.href='index.html'">‚Üê Back to App</button>
    </div>
</div>

<!-- TOAST -->
<div id="toast"></div>

<!-- PAD EDIT MODAL -->
<div class="mo" id="padMo">
    <div class="msh">
        <div class="mhd"></div>
        <div class="mtit">‚úèÔ∏è Edit Pad</div>
        <div class="f"><label>Label</label><input type="text" id="plbl" placeholder="e.g. Applause" maxlength="16" style="user-select:text;"></div>
        <div class="f"><label>Emoji</label><div class="epick" id="epick"></div></div>
        <div class="f"><label>Color</label><div class="cpick" id="cpick"></div></div>
        <div class="f">
            <label>Sound File</label>
            <div class="sfxuz" id="sfxuz">
                <input type="file" id="sfxfi" accept="audio/*" onchange="hSfxUp(event)">
                <div style="font-size:12px;font-weight:600;color:var(--muted);" id="sfxlbl">üìÅ Tap to upload sound</div>
                <div id="sfxprog" style="display:none;margin-top:8px;">
                    <div class="ubtrack"><div class="ubfill" id="sfxbar"></div></div>
                    <div class="ubtxt">Uploading...</div>
                </div>
            </div>
        </div>
        <div class="brow">
            <button class="btn bg" onclick="closePadMo()"><i data-lucide="x"></i> Cancel</button>
            <button class="btn bp" onclick="savePad()"><i data-lucide="check"></i> Save Pad</button>
        </div>
    </div>
</div>

<!-- LIBRARY MODAL -->
<div class="mo" id="libMo">
    <div class="msh">
        <div class="mhd"></div>
        <div class="mtit">üéµ Music Library</div>
        <div class="uz" id="muz">
            <input type="file" id="mfi" accept="audio/*" multiple onchange="hMusicUp(event)">
            <div style="font-size:26px;margin-bottom:6px;">üéµ</div>
            <div style="font-size:13px;font-weight:700;margin-bottom:2px;">Drop music files here</div>
            <div style="font-size:11px;color:var(--muted);">MP3 ¬∑ AAC ¬∑ WAV ¬∑ OGG ¬∑ FLAC</div>
            <div id="muprog" style="display:none;margin-top:10px;">
                <div class="ubtrack"><div class="ubfill" id="mbar"></div></div>
                <div class="ubtxt" id="mtxt">Uploading...</div>
            </div>
        </div>
        <div class="lcnt" id="lcnt"></div>
        <div id="liblist"></div>
        <button class="btn bg" onclick="closeLibMo()" style="margin-top:12px;"><i data-lucide="x"></i> Close</button>
    </div>
</div>

<!-- SETTINGS MODAL -->
<div class="mo" id="setMo">
    <div class="msh">
        <div class="mhd"></div>
        <div class="mtit">‚öôÔ∏è Settings</div>
        <div class="trow">
            <div class="tinfo"><div class="tl">üü¢ Go Live</div><div class="td">Enable radio for all users</div></div>
            <label class="tsw"><input type="checkbox" id="ilt" onchange="togLive(this.checked)"><div class="ttr"></div></label>
        </div>
        <div class="dv"></div>
        <div class="trow">
            <div class="tinfo"><div class="tl">üî¥ Force Off</div><div class="td">Override ‚Äî mute for everyone</div></div>
            <label class="tsw"><input type="checkbox" id="fot" onchange="togForce(this.checked)"><div class="ttr"></div></label>
        </div>
        <div class="dv"></div>
        <div class="trow">
            <div class="tinfo"><div class="tl">‚èØÔ∏è Auto-Play on Draw</div><div class="td">Starts 10 min before bingo draw</div></div>
            <label class="tsw"><input type="checkbox" id="apt" checked onchange="togAP(this.checked)"><div class="ttr"></div></label>
        </div>
        <div class="dv" style="margin:12px 0;"></div>
        <div class="f"><label>Station Name</label><input type="text" id="sni" placeholder="RB Live Radio" maxlength="50" style="user-select:text;"></div>
        <div class="f"><label>Now Playing Text</label><input type="text" id="npi" placeholder="e.g. Bingo Beats with DJ Rico" maxlength="80" style="user-select:text;"><div class="fh">Shown on main site radio bar</div></div>
        <div class="trow">
            <div class="tinfo"><div class="tl">Noise Suppression</div><div class="td">Reduce background noise</div></div>
            <label class="tsw"><input type="checkbox" id="ns" checked><div class="ttr"></div></label>
        </div>
        <div class="dv"></div>
        <div class="trow">
            <div class="tinfo"><div class="tl">Echo Cancellation</div><div class="td">Remove speaker echo</div></div>
            <label class="tsw"><input type="checkbox" id="ec" checked><div class="ttr"></div></label>
        </div>
        <div class="dv"></div>
        <div class="f" style="margin-top:10px;"><label>Mic Chunk Size (ms)</label><input type="number" id="cksz" value="800" min="300" max="2000" step="100" style="user-select:text;"><div class="fh">Lower = less latency ¬∑ 800ms recommended</div></div>
        <div class="sb" id="csb"><i data-lucide="wifi-off"></i> Not connected</div>
        <button class="btn bp" onclick="saveInfo(); closeSetMo();" style="margin-top:12px;"><i data-lucide="save"></i> Save & Close</button>
    </div>
</div>

<!-- DJ CONSOLE -->
<div id="dj">
    <div class="nav">
        <button class="nav-back" onclick="location.href='index.html'"><i data-lucide="arrow-left" style="width:15px;height:15px;"></i></button>
        <div class="nav-title">üéõÔ∏è DJ <span>Console</span></div>
        <div class="nav-right">
            <div class="pill offline" id="npill"><div class="pill-dot"></div><span id="npilltxt">OFFLINE</span></div>
            <button class="nav-btn" onclick="openLibMo()" title="Music Library"><i data-lucide="music-2" style="width:15px;height:15px;"></i></button>
            <button class="nav-btn" onclick="openSetMo()" title="Settings"><i data-lucide="settings-2" style="width:15px;height:15px;"></i></button>
        </div>
    </div>

    <div class="console">

        <!-- ‚ë† BROADCAST -->
        <div class="bcast">
            <button class="live-btn off" id="liveBtn" onclick="toggleLive()">
                <i data-lucide="radio" style="width:14px;height:14px;"></i>
                <span id="liveBtnTxt">GO LIVE</span>
            </button>
            <button class="force-btn" id="forceBtn" onclick="toggleForce()">üö´ FORCE OFF</button>
            <div class="bcast-ctd">
                <div class="ctd-v" id="ctdv">--:--</div>
                <div class="ctd-l">Next Draw</div>
            </div>
        </div>

        <!-- ‚ë° MIXER -->
        <div>
            <div class="sh"><i data-lucide="sliders-horizontal"></i> MIXER ‚Äî VOLUME</div>
            <div class="mixer">
                <div class="mixer-chs">
                    <div class="ch music">
                        <div class="ch-ico">üéµ</div>
                        <div class="ch-nm">Music</div>
                        <input class="fader music" type="range" min="0" max="100" value="80" id="volMusic" oninput="setMusVol(this.value)">
                        <div class="ch-pct" id="volMusicPct">80%</div>
                    </div>
                    <div class="ch mic">
                        <div class="ch-ico">üé§</div>
                        <div class="ch-nm">Mic Gain</div>
                        <input class="fader mic" type="range" min="0" max="200" value="100" id="volMic" oninput="setMicVol(this.value)">
                        <div class="ch-pct" id="volMicPct">100%</div>
                    </div>
                    <div class="ch sfx">
                        <div class="ch-ico">üîä</div>
                        <div class="ch-nm">SFX</div>
                        <input class="fader sfx" type="range" min="0" max="100" value="80" id="volSfx" oninput="setSfxVol(this.value)">
                        <div class="ch-pct" id="volSfxPct">80%</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ‚ë¢ NOW PLAYING -->
        <div>
            <div class="sh"><i data-lucide="music-2"></i> NOW PLAYING</div>
            <div class="np">
                <div class="np-row">
                    <div class="np-disc" id="npDisc"><div class="np-dot"></div></div>
                    <div class="np-info">
                        <div class="np-name" id="npName">No track playing</div>
                        <div class="np-sub" id="npSub">Add tracks via Library button ‚Üó</div>
                    </div>
                    <div class="np-ctrls">
                        <button class="npb sk" onclick="playPrev()"><i data-lucide="skip-back"></i></button>
                        <button class="npb pp" onclick="togQPlay()" id="qpbtn"><i data-lucide="play" id="qpic"></i></button>
                        <button class="npb sk" onclick="playNext()"><i data-lucide="skip-forward"></i></button>
                    </div>
                </div>
                <div class="np-prog"><div class="np-fill" id="npFill"></div></div>
                <div class="np-time"><span id="npEl">0:00</span><span id="npDur">0:00</span></div>
            </div>
        </div>

        <!-- ‚ë£ QUEUE -->
        <div class="q-panel">
            <div class="q-hd">
                <div class="q-hd-l"><i data-lucide="list-music" style="width:10px;height:10px;"></i> QUEUE</div>
                <div class="q-hd-r">
                    <button class="qbtn add" onclick="openLibMo()"><i data-lucide="plus"></i> Add</button>
                    <button class="qbtn del" onclick="clearQ()"><i data-lucide="trash-2"></i> Clear</button>
                </div>
            </div>
            <div class="q-list" id="qlist"><div class="q-empty">Queue is empty ‚Äî tap Add</div></div>
        </div>

        <!-- ‚ë§ MIC -->
        <div>
            <div class="sh"><i data-lucide="mic"></i> MICROPHONE</div>
            <div class="mic-panel">
                <div class="mic-btn" id="mbtn" onclick="togMic()">
                    <i data-lucide="mic" id="micic"></i>
                </div>
                <div class="mic-r">
                    <div class="mic-st" id="mlbl">Ready to Broadcast</div>
                    <div class="mic-sb" id="msub">Tap mic to go live</div>
                    <div class="vubars" id="vubars"></div>
                    <div class="mic-meta">
                        <div class="mic-chip"><span id="mclis">0</span>Listeners</div>
                        <div class="mic-chip"><span id="mcdur">0:00</span>Duration</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ‚ë• SOUND PADS -->
        <div>
            <div class="sh"><i data-lucide="layout-grid"></i> SOUND PADS ‚Äî TAP TO FIRE</div>
            <div class="pads-panel">
                <div class="pgrid" id="pgrid"></div>
                <div class="sfx-last" id="sfxLast">No sound triggered yet</div>
            </div>
        </div>

    </div>
</div>

<audio id="rca" preload="none"></audio>

<script>
// ‚îÄ‚îÄ FIREBASE ‚îÄ‚îÄ
var fc = {
    apiKey:"AIzaSyDIAQXJ15atKJxu7PtcFL1W9JnO1N14pVs",
    authDomain:"radiobingo-9ac29.firebaseapp.com",
    databaseURL:"https://radiobingo-9ac29-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId:"radiobingo-9ac29",
    storageBucket:"radiobingo-9ac29.firebasestorage.app",
    messagingSenderId:"965903993397",
    appId:"1:965903993397:web:f6646fa05225f147eebf7c"
};
if (!firebase.apps.length) firebase.initializeApp(fc);
var db = firebase.database();

// ‚îÄ‚îÄ CLOUDINARY ‚îÄ‚îÄ
var CL_NAME='dzifutb8l', CL_PRESET='radiobingo_uploads';
function uploadToCloudinary(file,onProg,onDone,onErr){
    var xhr=new XMLHttpRequest(), fd=new FormData();
    fd.append('file',file); fd.append('upload_preset',CL_PRESET);
    xhr.open('POST','https://api.cloudinary.com/v1_1/'+CL_NAME+'/video/upload',true);
    xhr.upload.onprogress=function(e){if(e.lengthComputable&&onProg)onProg(Math.round(e.loaded/e.total*100));};
    xhr.onload=function(){
        try{var r=JSON.parse(xhr.responseText);if(r.secure_url)onDone(r.secure_url);else onErr(new Error((r.error&&r.error.message)||'Upload failed'));}
        catch(ex){onErr(ex);}
    };
    xhr.onerror=function(){onErr(new Error('Network error'));};
    xhr.send(fd);
}

// ‚îÄ‚îÄ GATE ‚îÄ‚îÄ
var PW='111198', eyeVis=false;
function chkPw(){
    if(document.getElementById('gi').value===PW){
        document.getElementById('gate').classList.add('h');
        document.getElementById('dj').classList.add('s');
        init();
    } else {
        var el=document.getElementById('gi');
        document.getElementById('gerr').textContent='Incorrect password.';
        el.classList.add('shake'); el.value='';
        setTimeout(function(){el.classList.remove('shake');document.getElementById('gerr').textContent='';},1800);
    }
}
function togEye(){
    eyeVis=!eyeVis;
    document.getElementById('gi').type=eyeVis?'text':'password';
    document.getElementById('geyeic').setAttribute('data-lucide',eyeVis?'eye-off':'eye');
    lucide.createIcons();
}

// ‚îÄ‚îÄ STATE ‚îÄ‚îÄ
var S={
    audio:null,
    musVol:0.8, sfxVol:0.8, micVolPct:100,
    lib:{}, queue:[], qidx:-1, qplaying:false,
    micOn:false, micStream:null, mr:null, mseq:0, mstart:0,
    mdtimer:null, analyser:null, actx:null, vuraf:null, micGain:null,
    pads:{}, editPad:-1, editUrl:null,
    selEmoji:'üéµ', selColor:'#3b82f6',
    isLive:false, forceOff:false
};
var COLORS=['#ef4444','#f97316','#eab308','#22c55e','#06b6d4','#3b82f6','#8b5cf6','#ec4899','#14b8a6','#f59e0b','#10b981','#6366f1'];
var EMOJIS=['üéµ','ü•Å','üé∫','üìØ','üîî','üéä','üëè','üòÇ','üî•','üí•','‚ö°','üéâ','üé∂','üì¢','üö®','üí´','üåü','üé§','üé∏','üëç','üíØ','üéØ'];

// ‚îÄ‚îÄ INIT ‚îÄ‚îÄ
function init(){
    S.audio=document.getElementById('rca');
    S.audio.volume=S.musVol;
    S.audio.addEventListener('ended',onEnd);
    S.audio.addEventListener('timeupdate',updNPBar);
    buildVU(); buildGrid(); buildEP(); buildCP();
    listenState(); loadLib(); loadQ(); loadPads();
    updateCtd(); setInterval(updateCtd,15000); setInterval(chkSched,10000);
    lucide.createIcons();
}

// ‚îÄ‚îÄ MODALS ‚îÄ‚îÄ
function openLibMo() {document.getElementById('libMo').classList.add('s');}
function closeLibMo(){document.getElementById('libMo').classList.remove('s');}
function openSetMo() {document.getElementById('setMo').classList.add('s');}
function closeSetMo(){document.getElementById('setMo').classList.remove('s');}
function closePadMo(){document.getElementById('padMo').classList.remove('s');S.editPad=-1;document.getElementById('sfxfi').value='';}
['libMo','setMo','padMo'].forEach(function(id){
    document.getElementById(id).addEventListener('click',function(e){if(e.target===this)this.classList.remove('s');});
});

// ‚îÄ‚îÄ BROADCAST ‚îÄ‚îÄ
function toggleLive(){
    var v=!S.isLive;
    db.ref('radioState').update({isLive:v},function(e){if(!e)toast(v?'üì° Radio LIVE':'üì¥ Radio offline');});
}
function toggleForce(){
    var v=!S.forceOff;
    db.ref('radioState').update({forceOff:v},function(e){if(!e)toast(v?'üö´ Force Off ON':'‚úÖ Force Off off');});
}

// ‚îÄ‚îÄ FIREBASE LISTENER ‚îÄ‚îÄ
function listenState(){
    db.ref('radioState').on('value',function(snap){
        var d=snap.val()||{};
        S.isLive=d.isLive||false; S.forceOff=d.forceOff||false;
        document.getElementById('ilt').checked=S.isLive;
        document.getElementById('fot').checked=S.forceOff;
        document.getElementById('apt').checked=d.autoPlay!==false;
        if(d.title) document.getElementById('sni').value=d.title;
        if(d.nowPlaying) document.getElementById('npi').value=d.nowPlaying;
        // Live button
        var lb=document.getElementById('liveBtn'), lt=document.getElementById('liveBtnTxt');
        lb.className='live-btn '+(S.isLive?'on':'off');
        lt.textContent=S.isLive?'üî¥ ON AIR':'GO LIVE';
        // Force button
        document.getElementById('forceBtn').className='force-btn'+(S.forceOff?' on':'');
        // Pill
        var pill=document.getElementById('npill'), pt=document.getElementById('npilltxt');
        pill.className='pill'; var mode=d.mode||'off';
        if(S.forceOff){pill.classList.add('offline');pt.textContent='FORCE OFF';}
        else if(S.isLive&&mode==='live'){pill.classList.add('live');pt.textContent='MIC LIVE';}
        else if(S.isLive&&mode==='music'){pill.classList.add('music');pt.textContent='MUSIC';}
        else if(S.isLive){pill.classList.add('live');pt.textContent='LIVE';}
        else{pill.classList.add('offline');pt.textContent='OFFLINE';}
        // Settings status bar
        var csb=document.getElementById('csb'); csb.className='sb';
        if(S.forceOff){csb.classList.add('err');csb.innerHTML='<i data-lucide="x-circle" style="width:12px;height:12px;"></i> Force Off active';}
        else if(S.isLive){csb.classList.add('ok');csb.innerHTML='<i data-lucide="check-circle" style="width:12px;height:12px;"></i> Radio is live';}
        else{csb.innerHTML='<i data-lucide="wifi-off" style="width:12px;height:12px;"></i> Radio offline';}
        lucide.createIcons();
    });
}

// ‚îÄ‚îÄ SETTINGS HELPERS ‚îÄ‚îÄ
function togLive(v){db.ref('radioState').update({isLive:v},function(e){if(!e)toast(v?'üì° Radio LIVE':'üì¥ Radio offline');});}
function togForce(v){db.ref('radioState').update({forceOff:v},function(e){if(!e)toast(v?'üö´ Force Off on':'‚úÖ Force Off off');});}
function togAP(v){db.ref('radioState').update({autoPlay:v},function(e){if(!e)toast(v?'‚èØ Auto-play on':'‚è∏ Auto-play off');});}
function saveInfo(){
    db.ref('radioState').update({
        title:document.getElementById('sni').value.trim()||'RB Live Radio',
        nowPlaying:document.getElementById('npi').value.trim()
    },function(e){if(!e)toast('‚úÖ Info saved!');});
}

// ‚îÄ‚îÄ VOLUME ‚îÄ‚îÄ
function setMusVol(v){S.musVol=v/100;if(S.audio)S.audio.volume=S.musVol;document.getElementById('volMusicPct').textContent=v+'%';}
function setSfxVol(v){S.sfxVol=v/100;document.getElementById('volSfxPct').textContent=v+'%';}
function setMicVol(v){S.micVolPct=parseInt(v);if(S.micGain)S.micGain.gain.value=S.micVolPct/100;document.getElementById('volMicPct').textContent=v+'%';}

// ‚îÄ‚îÄ LIBRARY ‚îÄ‚îÄ
function hMusicUp(e){if(e.target.files.length)upFiles(Array.from(e.target.files));}
function upFiles(files){
    var idx=0, prog=document.getElementById('muprog'), fill=document.getElementById('mbar'), txt=document.getElementById('mtxt');
    prog.style.display='block';
    function next(){
        if(idx>=files.length){prog.style.display='none';document.getElementById('mfi').value='';toast('‚úÖ '+files.length+' track(s) uploaded!');return;}
        var f=files[idx], tid=db.ref('radioMusic/library').push().key;
        txt.textContent='Uploading '+(idx+1)+'/'+files.length+': '+f.name; fill.style.width='0%';
        uploadToCloudinary(f,
            function(pct){fill.style.width=pct+'%';},
            function(url){
                var ta=new Audio(),saved=false;
                var save=function(dur){if(saved)return;saved=true;db.ref('radioMusic/library/'+tid).set({name:f.name.replace(/\.[^/.]+$/,''),url:url,size:f.size,duration:dur||0,addedAt:Date.now()},function(){idx++;next();});};
                ta.onloadedmetadata=function(){save(Math.round(ta.duration));};
                ta.onerror=function(){save(0);}; setTimeout(function(){save(0);},5000);
                ta.src=url; ta.load();
            },
            function(err){toast('‚ùå '+err.message);idx++;next();}
        );
    }
    next();
}
function loadLib(){db.ref('radioMusic/library').on('value',function(snap){S.lib=snap.val()||{};rendLib();});}
function rendLib(){
    var el=document.getElementById('liblist'), cnt=document.getElementById('lcnt'), keys=Object.keys(S.lib);
    if(!keys.length){el.innerHTML='<div class="es"><div class="es-ic">üé∂</div><div class="es-tx">No music uploaded yet</div></div>';cnt.textContent='';return;}
    keys.sort(function(a,b){return(S.lib[b].addedAt||0)-(S.lib[a].addedAt||0);});
    cnt.textContent=keys.length+' track'+(keys.length!==1?'s':'')+' in library';
    var h='<div class="tlist">';
    keys.forEach(function(id){
        var t=S.lib[id];
        h+='<div class="ti" id="li-'+id+'"><div class="tthumb">üéµ</div><div style="flex:1;min-width:0;"><div class="tname">'+esc(t.name)+'</div><div class="tmeta"><span>'+(t.duration?fmt(t.duration):'?:??')+'</span>'+(t.size?'<span>'+(t.size/1048576).toFixed(1)+' MB</span>':'')+'</div></div><div class="tacts"><div class="ta rp" title="Add to Queue" onclick="addQ(\''+id+'\')"><i data-lucide="plus" style="width:10px;height:10px;"></i></div><div class="ta" title="Preview" onclick="prevTrack(\''+id+'\')"><i data-lucide="play" style="width:10px;height:10px;"></i></div><div class="ta dl" title="Delete" onclick="delTrack(\''+id+'\')"><i data-lucide="trash-2" style="width:10px;height:10px;"></i></div></div></div>';
    });
    h+='</div>'; el.innerHTML=h; lucide.createIcons();
}
function prevTrack(id){var t=S.lib[id];if(!t)return;S.audio.src=t.url;S.audio.play().catch(function(){});toast('‚ñ∂ '+t.name);}
function delTrack(id){if(!confirm('Delete "'+S.lib[id].name+'"?'))return;db.ref('radioMusic/library/'+id).remove();toast('üóë Deleted');}
function addQ(tid){
    var t=S.lib[tid];if(!t)return;
    db.ref('radioMusic/queue').push().set({trackId:tid,trackName:t.name,trackUrl:t.url,duration:t.duration||0,order:Date.now()});
    toast('‚ûï Added: '+t.name);
    var el=document.getElementById('li-'+tid);
    if(el){el.style.borderColor='rgba(14,165,233,0.6)';setTimeout(function(){el.style.borderColor='';},900);}
}

// ‚îÄ‚îÄ QUEUE ‚îÄ‚îÄ
function loadQ(){
    db.ref('radioMusic/queue').on('value',function(snap){
        var r=snap.val()||{};
        S.queue=Object.keys(r).map(function(k){return Object.assign({id:k},r[k]);}).sort(function(a,b){return(a.order||0)-(b.order||0);});
        rendQ();
    });
    db.ref('radioMusic/current').on('value',function(snap){updCurrentBar(snap.val()||{});});
}
function rendQ(){
    var el=document.getElementById('qlist');
    if(!S.queue.length){el.innerHTML='<div class="q-empty">Queue is empty ‚Äî tap Add</div>';return;}
    var h='';
    S.queue.forEach(function(item,i){
        var isp=i===S.qidx;
        h+='<div class="qi'+(isp?' pl':'')+'" id="qi-'+item.id+'"><div class="qi-num">'+(isp?'‚ñ∂':(i+1))+'</div><div class="qi-name">'+esc(item.trackName)+'</div><div class="qi-dur">'+(item.duration?fmt(item.duration):'')+'</div><div class="qi-acts"><div class="ta rp" title="Play Now" onclick="playIdx('+i+')"><i data-lucide="play" style="width:10px;height:10px;"></i></div><div class="ta dl" title="Remove" onclick="remQ(\''+item.id+'\')"><i data-lucide="x" style="width:10px;height:10px;"></i></div></div></div>';
    });
    el.innerHTML=h; lucide.createIcons();
}
function playIdx(i){
    if(i<0||i>=S.queue.length)return; S.qidx=i;
    var item=S.queue[i]; S.audio.src=item.trackUrl;
    S.audio.play().then(function(){
        S.qplaying=true;
        db.ref('radioMusic/current').set({id:item.trackId,name:item.trackName,url:item.trackUrl,startedAt:Date.now(),duration:item.duration||0,playing:true});
        db.ref('radioState').update({mode:'music',isLive:true});
        rendQ();
    }).catch(function(e){toast('‚ùå '+e.message);});
}
function togQPlay(){
    if(S.qplaying){
        S.audio.pause(); S.qplaying=false;
        db.ref('radioMusic/current').update({playing:false});
        var ic=document.getElementById('qpic');if(ic)ic.setAttribute('data-lucide','play');
        document.getElementById('npDisc').classList.remove('spin'); lucide.createIcons();
    } else {
        if(S.qidx>=0){S.audio.play();S.qplaying=true;db.ref('radioMusic/current').update({playing:true,startedAt:Date.now()-(S.audio.currentTime*1000)});var ic=document.getElementById('qpic');if(ic)ic.setAttribute('data-lucide','pause');document.getElementById('npDisc').classList.add('spin');lucide.createIcons();}
        else if(S.queue.length){playIdx(0);}
    }
}
function playNext(){var n=S.qidx+1;if(n<S.queue.length)playIdx(n);else{toast('üìã End of queue');stopQ();}}
function playPrev(){var p=S.qidx-1;if(p>=0)playIdx(p);else S.audio.currentTime=0;}
function onEnd(){var n=S.qidx+1;if(n<S.queue.length)setTimeout(function(){playIdx(n);},400);else{stopQ();toast('üìã Queue finished');}}
function stopQ(){S.audio.pause();S.audio.src='';S.qplaying=false;S.qidx=-1;db.ref('radioMusic/current').set({playing:false,name:'',url:''});db.ref('radioState').update({mode:'off',isLive:false});document.getElementById('npDisc').classList.remove('spin');}
function remQ(qid){db.ref('radioMusic/queue/'+qid).remove();toast('üóë Removed');}
function clearQ(){if(!confirm('Clear entire queue?'))return;stopQ();db.ref('radioMusic/queue').remove();toast('üóë Queue cleared');}
function chkSched(){var now=Date.now();S.queue.forEach(function(item,i){if(item.scheduledAt&&item.scheduledAt>0&&Math.abs(now-item.scheduledAt)<30000&&S.qidx<i)playIdx(i);});}
function updCurrentBar(cur){
    var nm=document.getElementById('npName'),sb=document.getElementById('npSub'),disc=document.getElementById('npDisc'),pic=document.getElementById('qpic');
    if(cur&&cur.name&&cur.playing){nm.textContent=cur.name;sb.textContent='‚ñ∂ Playing';disc.classList.add('spin');if(pic)pic.setAttribute('data-lucide','pause');}
    else if(cur&&cur.name){nm.textContent=cur.name;sb.textContent='‚è∏ Paused';disc.classList.remove('spin');if(pic)pic.setAttribute('data-lucide','play');}
    else{nm.textContent='No track playing';sb.textContent='Add tracks via Library button ‚Üó';disc.classList.remove('spin');if(pic)pic.setAttribute('data-lucide','play');}
    lucide.createIcons();
}
function updNPBar(){
    if(!S.audio||!S.audio.duration)return;
    var pct=(S.audio.currentTime/S.audio.duration)*100;
    document.getElementById('npFill').style.width=pct+'%';
    document.getElementById('npEl').textContent=fmt(Math.floor(S.audio.currentTime));
    document.getElementById('npDur').textContent=fmt(Math.floor(S.audio.duration));
}

// ‚îÄ‚îÄ MIC ‚îÄ‚îÄ
function buildVU(){var h='';for(var i=0;i<20;i++)h+='<div class="vubar" id="vb'+i+'"></div>';document.getElementById('vubars').innerHTML=h;}
function togMic(){if(S.micOn)stopMic();else startMic();}
function startMic(){
    var c={audio:{noiseSuppression:document.getElementById('ns').checked,echoCancellation:document.getElementById('ec').checked,sampleRate:44100}};
    navigator.mediaDevices.getUserMedia(c).then(function(stream){
        S.micStream=stream; S.micOn=true; S.mseq=0; S.mstart=Date.now();
        S.actx=new(window.AudioContext||window.webkitAudioContext)();
        var src=S.actx.createMediaStreamSource(stream);
        S.micGain=S.actx.createGain(); S.micGain.gain.value=S.micVolPct/100;
        src.connect(S.micGain);
        S.analyser=S.actx.createAnalyser(); S.analyser.fftSize=64;
        S.micGain.connect(S.analyser); animVU();
        var dest=S.actx.createMediaStreamDestination();
        S.micGain.connect(dest);
        var chkms=parseInt(document.getElementById('cksz').value)||800;
        var mime=MediaRecorder.isTypeSupported('audio/webm;codecs=opus')?'audio/webm;codecs=opus':'audio/ogg;codecs=opus';
        S.mr=new MediaRecorder(dest.stream,{mimeType:mime,audioBitsPerSecond:64000});
        S.mr.ondataavailable=function(e){
            if(e.data&&e.data.size>10){
                var r=new FileReader();
                r.onload=function(){var seq=++S.mseq,b64=r.result.split(',')[1];db.ref('liveBroadcast/chunks/'+seq).set({data:b64,mime:mime,ts:Date.now(),seq:seq});db.ref('liveBroadcast/latestSeq').set(seq);if(seq>40)db.ref('liveBroadcast/chunks/'+(seq-40)).remove();};
                r.readAsDataURL(e.data);
            }
        };
        S.mr.start(chkms);
        db.ref('liveBroadcast').update({active:true,startedAt:Date.now()});
        db.ref('radioState').update({mode:'live',isLive:true});
        setMicUI(true);
        S.mdtimer=setInterval(function(){
            document.getElementById('mcdur').textContent=fmt(Math.floor((Date.now()-S.mstart)/1000));
            db.ref('liveBroadcast/listeners').once('value',function(s){document.getElementById('mclis').textContent=s.val()||0;});
        },1000);
    }).catch(function(e){toast('‚ùå Mic denied: '+e.message);});
}
function stopMic(){
    if(S.mr){try{S.mr.stop();}catch(e){} S.mr=null;}
    if(S.micStream){S.micStream.getTracks().forEach(function(t){t.stop();}); S.micStream=null;}
    if(S.actx){try{S.actx.close();}catch(e){} S.actx=null;}
    if(S.vuraf){cancelAnimationFrame(S.vuraf);S.vuraf=null;}
    if(S.mdtimer){clearInterval(S.mdtimer);S.mdtimer=null;}
    S.micGain=null; S.micOn=false;
    db.ref('liveBroadcast').update({active:false});
    db.ref('radioState').update({mode:'off',isLive:false});
    setMicUI(false); resetVU();
}
function setMicUI(on){
    var btn=document.getElementById('mbtn'),ic=document.getElementById('micic'),lbl=document.getElementById('mlbl'),sub=document.getElementById('msub');
    if(on){btn.classList.add('on');ic.setAttribute('data-lucide','mic-off');lbl.textContent='üî¥ LIVE ‚Äî Broadcasting';sub.textContent='Tap to stop';}
    else{btn.classList.remove('on');ic.setAttribute('data-lucide','mic');lbl.textContent='Ready to Broadcast';sub.textContent='Tap mic to go live';document.getElementById('mcdur').textContent='0:00';document.getElementById('mclis').textContent='0';}
    lucide.createIcons();
}
function animVU(){
    if(!S.analyser)return;
    var d=new Uint8Array(S.analyser.frequencyBinCount); S.analyser.getByteFrequencyData(d);
    var step=Math.floor(d.length/20);
    var cols=['#10b981','#10b981','#10b981','#10b981','#22c55e','#22c55e','#22c55e','#fbbf24','#fbbf24','#f97316','#f97316','#ef4444','#ef4444','#ef4444','#ef4444','#ef4444','#ef4444','#ef4444','#ef4444','#ef4444'];
    for(var i=0;i<20;i++){var b=document.getElementById('vb'+i);if(b){b.style.height=Math.max(3,Math.round(d[i*step]/255*30))+'px';b.style.background=cols[i];}}
    S.vuraf=requestAnimationFrame(animVU);
}
function resetVU(){for(var i=0;i<20;i++){var b=document.getElementById('vb'+i);if(b){b.style.height='3px';b.style.background='rgba(255,255,255,0.07)';}}}

// ‚îÄ‚îÄ SOUND PADS ‚îÄ‚îÄ
function buildGrid(){
    var h='';
    for(var i=0;i<12;i++){
        h+='<div class="pad emp" id="pad'+i+'" onclick="trigPad('+i+')">'+'<div class="pe" id="pe'+i+'">‚ûï</div><div class="plbl" id="pl'+i+'">Empty</div><button class="pedit" onclick="openPadEdit(event,'+i+')"><i data-lucide="pencil" style="width:9px;height:9px;"></i></button></div>';
    }
    document.getElementById('pgrid').innerHTML=h; lucide.createIcons();
}
function loadPads(){db.ref('radioSoundboard/pads').on('value',function(snap){S.pads=snap.val()||{};for(var i=0;i<12;i++)rendPad(i);lucide.createIcons();});}
function rendPad(i){
    var pad=document.getElementById('pad'+i),em=document.getElementById('pe'+i),lbl=document.getElementById('pl'+i),d=S.pads[i];
    if(d&&d.url){pad.className='pad hs';pad.style.background=(d.color||'#3b82f6')+'22';pad.style.borderColor=(d.color||'#3b82f6')+'66';em.textContent=d.emoji||'üéµ';lbl.textContent=d.label||'Sound '+(i+1);}
    else{pad.className='pad emp';pad.style.background='';pad.style.borderColor='';em.textContent='‚ûï';lbl.textContent='Empty';}
}
function trigPad(i){
    var d=S.pads[i];if(!d||!d.url){openPadEdit(null,i);return;}
    var sfx=new Audio(d.url); sfx.volume=S.sfxVol; sfx.play().catch(function(){});
    db.ref('radioSoundboard/trigger').set({url:d.url,label:d.label||'',ts:Date.now()});
    var pad=document.getElementById('pad'+i);
    pad.classList.add('pfx'); setTimeout(function(){pad.classList.remove('pfx');},280);
    document.getElementById('sfxLast').textContent='üîä '+(d.label||'Sound '+(i+1));
    toast('üîä '+(d.label||'Sound '+(i+1)));
}
function buildEP(){document.getElementById('epick').innerHTML=EMOJIS.map(function(em){return'<span class="eopt" data-emoji="'+em+'" onclick="selEm(\''+em+'\')">'+em+'</span>';}).join('');}
function buildCP(){document.getElementById('cpick').innerHTML=COLORS.map(function(c){return'<div class="csw" style="background:'+c+';" data-color="'+c+'" onclick="selCol(\''+c+'\')"></div>';}).join('');}
function selEm(em){S.selEmoji=em;document.querySelectorAll('.eopt').forEach(function(e){e.classList.toggle('sel',e.dataset.emoji===em);});}
function selCol(c){S.selColor=c;document.querySelectorAll('.csw').forEach(function(e){e.classList.toggle('sel',e.dataset.color===c);});}
function openPadEdit(evt,i){
    if(evt)evt.stopPropagation();
    S.editPad=i; S.editUrl=null;
    var d=S.pads[i]||{};
    document.getElementById('plbl').value=d.label||'';
    S.selEmoji=d.emoji||'üéµ'; S.selColor=d.color||'#3b82f6';
    document.getElementById('sfxlbl').textContent=d.url?'‚úÖ Sound uploaded':'üìÅ Tap to upload sound';
    document.getElementById('sfxprog').style.display='none';
    document.querySelectorAll('.eopt').forEach(function(e){e.classList.toggle('sel',e.dataset.emoji===S.selEmoji);});
    document.querySelectorAll('.csw').forEach(function(e){e.classList.toggle('sel',e.dataset.color===S.selColor);});
    document.getElementById('padMo').classList.add('s'); lucide.createIcons();
}
function hSfxUp(e){
    var f=e.target.files[0];if(!f)return;
    var prog=document.getElementById('sfxprog'),fill=document.getElementById('sfxbar'),lbl=document.getElementById('sfxlbl');
    prog.style.display='block'; lbl.textContent='Uploading...'; fill.style.width='0%';
    uploadToCloudinary(f,function(pct){fill.style.width=pct+'%';},function(url){S.editUrl=url;prog.style.display='none';lbl.textContent='‚úÖ '+f.name;toast('‚úÖ Sound uploaded!');},function(err){toast('‚ùå '+err.message);prog.style.display='none';});
}
function savePad(){
    var i=S.editPad;if(i<0)return;
    var label=document.getElementById('plbl').value.trim()||'Sound '+(i+1);
    var url=S.editUrl||(S.pads[i]&&S.pads[i].url)||null;
    if(!url){toast('‚ö†Ô∏è Upload a sound file first');return;}
    db.ref('radioSoundboard/pads/'+i).set({label:label,url:url,color:S.selColor,emoji:S.selEmoji});
    closePadMo(); toast('‚úÖ Pad saved!');
}

// ‚îÄ‚îÄ COUNTDOWN ‚îÄ‚îÄ
function updateCtd(){
    db.ref('gameState').once('value',function(snap){
        var d=snap.val()||{},now=Date.now(),next=null;
        if(d.schedules){var ts=Object.values(d.schedules).map(function(v){return(typeof v==='object'&&v.time)?v.time:v;});var f=ts.filter(function(t){return t>now;}).sort(function(a,b){return a-b;});if(f.length)next=f[0];}
        if(!next&&d.nextDraw&&d.nextDraw>now)next=d.nextDraw;
        var ve=document.getElementById('ctdv');
        if(next){var diff=next-now,h=Math.floor(diff/3600000),m=Math.floor((diff%3600000)/60000),s=Math.floor((diff%60000)/1000);ve.textContent=(h>0?h+'h ':'')+m+'m '+s+'s';}
        else ve.textContent='No draw';
    });
}

// ‚îÄ‚îÄ HELPERS ‚îÄ‚îÄ
function fmt(s){var m=Math.floor(s/60);return m+':'+(s%60<10?'0':'')+(s%60);}
function esc(s){return(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');}
function toast(m){var e=document.getElementById('toast');e.textContent=m;e.classList.add('s');setTimeout(function(){e.classList.remove('s');},3000);}

window.addEventListener('load',function(){
    lucide.createIcons();
    document.getElementById('gi').focus();
    var z=document.getElementById('muz');
    z.addEventListener('dragover',function(e){e.preventDefault();z.style.borderColor='var(--accent)';});
    z.addEventListener('dragleave',function(){z.style.borderColor='';});
    z.addEventListener('drop',function(e){e.preventDefault();z.style.borderColor='';var files=Array.from(e.dataTransfer.files).filter(function(f){return f.type.startsWith('audio/');});if(files.length)upFiles(files);});
});
</script>
</body>
</html>
