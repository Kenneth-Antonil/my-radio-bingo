<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#0f172a">
    <title>RB Live ¬∑ Radio Control</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;900&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-storage.js"></script>
    <style>
        :root {
            --bg: #0f172a; --surface: rgba(30,41,59,0.85); --border: rgba(255,255,255,0.08);
            --accent: #0ea5e9; --glow: #38bdf8; --gold: #fbbf24;
            --ok: #10b981; --err: #ef4444; --warn: #f97316;
            --muted: rgba(255,255,255,0.4); --radius: 16px; --rsm: 10px; --rxs: 7px;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; user-select: none; }
        body { font-family: 'Inter', sans-serif; background: var(--bg); color: #fff; min-height: 100vh; }

        /* GATE */
        #gate { display:flex; position:fixed; inset:0; z-index:9999; background:var(--bg); flex-direction:column; align-items:center; justify-content:center; padding:32px; }
        #gate.h { display:none; } #mc { display:none; } #mc.s { display:block; }
        .gc { background:rgba(30,41,59,0.92); border:1px solid var(--border); border-radius:22px; padding:36px 28px; width:100%; max-width:340px; box-shadow:0 20px 60px rgba(0,0,0,0.5); }
        .gl { text-align:center; font-size:26px; font-weight:900; margin-bottom:4px; letter-spacing:-1px; }
        .gl span { color:var(--glow); } .gs { text-align:center; font-size:11px; color:var(--muted); margin-bottom:26px; font-weight:700; text-transform:uppercase; letter-spacing:1.5px; }
        .giw { position:relative; margin-bottom:10px; }
        .gi { width:100%; background:rgba(0,0,0,0.35); border:1px solid rgba(255,255,255,0.1); border-radius:12px; padding:14px 46px 14px 16px; color:#fff; font-family:'Inter',sans-serif; font-size:20px; font-weight:700; letter-spacing:8px; text-align:center; outline:none; transition:border-color .2s; }
        .gi::placeholder { letter-spacing:2px; font-size:13px; font-weight:500; color:var(--muted); }
        .gi:focus { border-color:rgba(14,165,233,0.5); }
        .gi.shake { animation:shake .4s ease; border-color:rgba(239,68,68,0.6); }
        @keyframes shake { 0%,100%{transform:translateX(0)} 20%,60%{transform:translateX(-8px)} 40%,80%{transform:translateX(8px)} }
        .geye { position:absolute; right:13px; top:50%; transform:translateY(-50%); background:none; border:none; color:var(--muted); cursor:pointer; padding:4px; display:flex; }
        .gerr { font-size:12px; color:var(--err); font-weight:600; min-height:18px; margin-bottom:10px; text-align:center; }
        .gbtn { width:100%; padding:14px; background:linear-gradient(135deg,var(--accent),#0369a1); border:none; border-radius:12px; color:#fff; font-family:'Inter',sans-serif; font-size:14px; font-weight:800; cursor:pointer; box-shadow:0 4px 16px rgba(14,165,233,0.4); transition:all .2s; }
        .gbtn:hover { transform:translateY(-1px); box-shadow:0 6px 22px rgba(14,165,233,0.55); }
        .gbk { display:block; text-align:center; margin-top:14px; font-size:12px; color:var(--muted); background:none; border:none; cursor:pointer; font-family:'Inter',sans-serif; font-weight:600; transition:color .2s; }
        .gbk:hover { color:rgba(255,255,255,0.6); }

        /* NAV */
        .tnav { position:sticky; top:0; z-index:200; background:rgba(10,18,35,0.98); backdrop-filter:blur(20px); border-bottom:1px solid var(--border); display:flex; align-items:center; justify-content:space-between; padding:13px 16px; }
        .nbk { width:36px; height:36px; border-radius:50%; border:1px solid var(--border); background:rgba(255,255,255,0.05); color:#fff; display:flex; align-items:center; justify-content:center; cursor:pointer; transition:all .2s; }
        .nbk:hover { background:rgba(255,255,255,0.1); }
        .ntit { font-size:16px; font-weight:900; } .ntit span { color:var(--glow); }
        .pill { display:flex; align-items:center; gap:5px; background:rgba(16,185,129,0.1); border:1px solid rgba(16,185,129,0.3); color:var(--ok); font-size:10px; font-weight:800; padding:4px 10px; border-radius:20px; letter-spacing:.5px; }
        .pill-dot { width:6px; height:6px; border-radius:50%; background:var(--ok); animation:blink 1.2s ease infinite; }
        .pill.off { background:rgba(239,68,68,0.1); border-color:rgba(239,68,68,0.3); color:var(--err); }
        .pill.off .pill-dot { background:var(--err); }
        .pill.mu { background:rgba(14,165,233,0.1); border-color:rgba(14,165,233,0.3); color:var(--glow); }
        .pill.mu .pill-dot { background:var(--glow); }
        @keyframes blink { 0%,100%{opacity:1} 50%{opacity:.3} }

        /* TABS */
        .tabs { display:flex; background:rgba(10,18,35,0.97); border-bottom:1px solid var(--border); overflow-x:auto; scrollbar-width:none; }
        .tabs::-webkit-scrollbar { display:none; }
        .tb { flex:1; min-width:58px; display:flex; flex-direction:column; align-items:center; gap:3px; padding:9px 6px; background:none; border:none; border-bottom:2px solid transparent; color:var(--muted); cursor:pointer; font-family:'Inter',sans-serif; font-size:9px; font-weight:700; text-transform:uppercase; letter-spacing:.8px; transition:all .2s; }
        .tb i { width:17px; height:17px; }
        .tb.a { color:var(--glow); border-bottom-color:var(--accent); }
        .tp { display:none; } .tp.a { display:block; }
        .pg { max-width:500px; margin:0 auto; padding:16px 14px 90px; }

        /* CARDS */
        .card { background:var(--surface); border:1px solid var(--border); border-radius:var(--radius); padding:16px; margin-bottom:14px; backdrop-filter:blur(10px); }
        .ct { font-size:10px; font-weight:800; letter-spacing:1.2px; text-transform:uppercase; color:var(--muted); display:flex; align-items:center; gap:6px; margin-bottom:14px; }
        .ct i { width:13px; height:13px; }
        .sl { font-size:10px; font-weight:800; letter-spacing:1.5px; text-transform:uppercase; color:var(--muted); margin-bottom:8px; padding:0 2px; }

        /* FORMS */
        .f { margin-bottom:12px; }
        .f label { display:block; font-size:10px; font-weight:700; color:var(--muted); text-transform:uppercase; letter-spacing:.5px; margin-bottom:5px; }
        .f input,.f textarea { width:100%; background:rgba(0,0,0,0.3); border:1px solid var(--border); border-radius:var(--rsm); padding:11px 13px; color:#fff; font-family:'Inter',sans-serif; font-size:13px; font-weight:500; outline:none; transition:border-color .2s; }
        .f input::placeholder,.f textarea::placeholder { color:var(--muted); }
        .f input:focus,.f textarea:focus { border-color:rgba(14,165,233,0.5); }
        .fh { font-size:10px; color:var(--muted); margin-top:4px; font-weight:600; }

        /* BUTTONS */
        .btn { display:inline-flex; align-items:center; justify-content:center; gap:7px; padding:11px 18px; border-radius:var(--rsm); font-family:'Inter',sans-serif; font-size:12px; font-weight:700; cursor:pointer; border:none; transition:all .2s; width:100%; }
        .btn i { width:14px; height:14px; flex-shrink:0; }
        .bp { background:linear-gradient(135deg,var(--accent),#0369a1); color:#fff; box-shadow:0 4px 14px rgba(14,165,233,0.3); }
        .bp:hover { box-shadow:0 6px 20px rgba(14,165,233,0.5); transform:translateY(-1px); }
        .bs { background:linear-gradient(135deg,var(--ok),#059669); color:#fff; }
        .bd { background:linear-gradient(135deg,var(--err),#b91c1c); color:#fff; }
        .bg { background:rgba(255,255,255,0.05); color:rgba(255,255,255,0.7); border:1px solid var(--border); }
        .bg:hover { background:rgba(255,255,255,0.1); color:#fff; }
        .bsm { padding:7px 12px; font-size:11px; width:auto; }
        .brow { display:flex; gap:8px; }

        /* TOGGLE */
        .trow { display:flex; align-items:center; justify-content:space-between; padding:6px 0; }
        .tinfo .tl { font-size:13px; font-weight:600; }
        .tinfo .td { font-size:11px; color:var(--muted); margin-top:2px; }
        .tsw { position:relative; width:46px; height:25px; flex-shrink:0; cursor:pointer; }
        .tsw input { opacity:0; width:0; height:0; position:absolute; }
        .ttr { position:absolute; inset:0; background:rgba(255,255,255,0.1); border-radius:20px; border:1px solid var(--border); transition:background .3s; }
        .ttr::after { content:''; position:absolute; top:3px; left:3px; width:17px; height:17px; border-radius:50%; background:#fff; transition:transform .3s; box-shadow:0 2px 6px rgba(0,0,0,0.4); }
        .tsw input:checked + .ttr { background:var(--accent); border-color:var(--accent); }
        .tsw input:checked + .ttr::after { transform:translateX(21px); }

        /* UPLOAD ZONE */
        .uz { border:2px dashed rgba(14,165,233,0.3); border-radius:var(--radius); padding:26px 20px; text-align:center; cursor:pointer; transition:all .2s; background:rgba(14,165,233,0.03); position:relative; }
        .uz:hover,.uz.dv { border-color:var(--accent); background:rgba(14,165,233,0.08); }
        .uz input[type=file] { position:absolute; inset:0; opacity:0; cursor:pointer; width:100%; height:100%; }
        .uz-icon { font-size:30px; margin-bottom:8px; }
        .uz-t { font-size:13px; font-weight:700; margin-bottom:3px; }
        .uz-s { font-size:11px; color:var(--muted); font-weight:500; }
        .uprog { margin-top:12px; }
        .ubtrack { height:4px; background:rgba(255,255,255,0.1); border-radius:2px; overflow:hidden; margin-bottom:5px; }
        .ubfill { height:100%; background:linear-gradient(90deg,var(--accent),var(--glow)); border-radius:2px; transition:width .3s; width:0%; }
        .ubtxt { font-size:11px; color:var(--glow); font-weight:700; text-align:center; }

        /* TRACK LIST */
        .tlist { display:flex; flex-direction:column; gap:8px; }
        .ti { display:flex; align-items:center; gap:10px; background:rgba(0,0,0,0.3); border:1px solid var(--border); border-radius:var(--rsm); padding:10px 12px; transition:all .2s; }
        .ti:hover { border-color:rgba(14,165,233,0.3); background:rgba(14,165,233,0.04); }
        .tthumb { width:40px; height:40px; border-radius:8px; background:linear-gradient(135deg,rgba(14,165,233,0.2),rgba(30,41,59,0.8)); display:flex; align-items:center; justify-content:center; flex-shrink:0; font-size:16px; }
        .tname { font-size:13px; font-weight:700; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; margin-bottom:2px; }
        .tmeta { font-size:10px; color:var(--muted); font-weight:600; display:flex; gap:8px; }
        .tacts { display:flex; gap:5px; flex-shrink:0; }
        .ta { width:30px; height:30px; border-radius:var(--rxs); border:1px solid var(--border); background:rgba(255,255,255,0.05); color:var(--muted); display:flex; align-items:center; justify-content:center; cursor:pointer; transition:all .2s; }
        .ta:hover { background:rgba(255,255,255,0.1); color:#fff; }
        .ta.add:hover { background:rgba(14,165,233,0.15); border-color:rgba(14,165,233,0.4); color:var(--accent); }
        .ta.del:hover { background:rgba(239,68,68,0.15); border-color:rgba(239,68,68,0.4); color:var(--err); }
        .ta i { width:13px; height:13px; }
        .es { text-align:center; padding:28px 20px; color:var(--muted); }
        .es-ic { font-size:34px; margin-bottom:8px; }
        .es-tx { font-size:13px; font-weight:600; }

        /* QUEUE */
        .qi { display:flex; align-items:center; gap:10px; background:rgba(0,0,0,0.3); border:1px solid var(--border); border-radius:var(--rsm); padding:10px 12px; margin-bottom:7px; transition:all .2s; }
        .qi.pl { border-color:rgba(14,165,233,0.5); background:rgba(14,165,233,0.06); }
        .qnum { width:22px; height:22px; border-radius:50%; background:rgba(255,255,255,0.07); color:var(--muted); font-size:10px; font-weight:800; display:flex; align-items:center; justify-content:center; flex-shrink:0; }
        .qi.pl .qnum { background:var(--accent); color:#fff; }
        .qname { font-size:13px; font-weight:700; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
        .qsc { font-size:10px; color:var(--gold); font-weight:600; display:flex; align-items:center; gap:4px; margin-top:2px; }
        .qacts { display:flex; gap:4px; flex-shrink:0; }

        /* NOW PLAYING */
        .npbar { background:linear-gradient(135deg,rgba(14,165,233,0.1),rgba(30,41,59,0.6)); border:1px solid rgba(14,165,233,0.25); border-radius:var(--radius); padding:14px 16px 32px; margin-bottom:14px; position:relative; overflow:hidden; }
        .npbar::before { content:''; position:absolute; top:0; left:0; right:0; height:2px; background:linear-gradient(90deg,var(--accent),var(--glow)); }
        .nprow { display:flex; align-items:center; gap:14px; }
        .vin { width:44px; height:44px; border-radius:50%; background:linear-gradient(135deg,#1e293b,#0f172a); border:2px solid rgba(14,165,233,0.4); display:flex; align-items:center; justify-content:center; flex-shrink:0; }
        .vin.sp { animation:vspin 3s linear infinite; }
        @keyframes vspin { to { transform:rotate(360deg); } }
        .vd { width:10px; height:10px; border-radius:50%; background:#0f172a; border:2px solid rgba(255,255,255,0.12); }
        .npi { flex:1; min-width:0; }
        .npt { font-size:14px; font-weight:800; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
        .nps { font-size:11px; color:var(--muted); font-weight:600; margin-top:2px; }
        .npc { display:flex; gap:7px; flex-shrink:0; }
        .npb { width:38px; height:38px; border-radius:50%; border:none; cursor:pointer; display:flex; align-items:center; justify-content:center; transition:all .2s; }
        .npb.sk { background:rgba(255,255,255,0.08); color:#fff; }
        .npb.sk:hover { background:rgba(255,255,255,0.15); }
        .npb.pp { background:linear-gradient(135deg,var(--accent),#0369a1); color:#fff; box-shadow:0 3px 12px rgba(14,165,233,0.4); }
        .npb i { width:16px; height:16px; }
        .npg { position:absolute; bottom:0; left:0; right:0; padding:0 16px 8px; }
        .npbt { height:3px; background:rgba(255,255,255,0.1); border-radius:2px; overflow:hidden; }
        .npbf { height:100%; background:linear-gradient(90deg,var(--accent),var(--glow)); border-radius:2px; transition:width .5s linear; width:0%; }
        .nptm { display:flex; justify-content:space-between; font-size:9px; color:var(--muted); font-weight:700; margin-top:3px; }

        /* LIVE MIC */
        .micbtn { width:88px; height:88px; border-radius:50%; border:3px solid rgba(239,68,68,0.3); background:rgba(239,68,68,0.08); color:rgba(239,68,68,0.6); display:flex; align-items:center; justify-content:center; cursor:pointer; transition:all .3s; margin:0 auto 16px; position:relative; }
        .micbtn i { width:34px; height:34px; }
        .micbtn:hover { border-color:rgba(239,68,68,0.6); background:rgba(239,68,68,0.15); color:var(--err); }
        .micbtn.on { border-color:var(--err); background:rgba(239,68,68,0.15); color:var(--err); animation:mpulse 1.5s ease infinite; }
        @keyframes mpulse { 0%,100%{box-shadow:0 0 0 0 rgba(239,68,68,0.4)} 50%{box-shadow:0 0 0 16px rgba(239,68,68,0)} }
        .micbtn.on::before { content:''; position:absolute; inset:-8px; border-radius:50%; border:2px solid rgba(239,68,68,0.2); animation:mring 1.5s ease infinite; }
        @keyframes mring { 0%{transform:scale(1);opacity:1} 100%{transform:scale(1.4);opacity:0} }
        .ml { font-size:15px; font-weight:800; margin-bottom:4px; }
        .ms { font-size:11px; color:var(--muted); font-weight:600; margin-bottom:20px; }
        .vuw { margin:0 auto 18px; max-width:320px; }
        .vubars { display:flex; align-items:flex-end; justify-content:center; gap:3px; height:48px; }
        .vubar { width:6px; background:rgba(255,255,255,0.08); border-radius:3px; transition:height .08s ease; min-height:3px; }
        .mchips { display:flex; gap:10px; justify-content:center; margin-bottom:16px; }
        .mchip { background:rgba(0,0,0,0.3); border:1px solid var(--border); border-radius:8px; padding:7px 14px; font-size:11px; font-weight:700; color:var(--muted); text-align:center; }
        .mchip .mv { font-size:16px; font-weight:900; color:#fff; display:block; margin-bottom:1px; }

        /* SOUNDBOARD */
        .pgrid { display:grid; grid-template-columns:repeat(3,1fr); gap:10px; }
        .pad { position:relative; aspect-ratio:1; border-radius:var(--rsm); border:1px solid rgba(255,255,255,0.08); display:flex; flex-direction:column; align-items:center; justify-content:center; cursor:pointer; transition:all .15s; overflow:hidden; }
        .pad:active { transform:scale(0.93); filter:brightness(1.35); }
        .pad.hs { border-color:rgba(255,255,255,0.15); }
        .pad.pfx { transform:scale(0.91); filter:brightness(1.5); }
        .pe { font-size:24px; margin-bottom:5px; pointer-events:none; }
        .plbl { font-size:10px; font-weight:800; text-align:center; padding:0 4px; pointer-events:none; color:rgba(255,255,255,0.9); line-height:1.2; }
        .pedit { position:absolute; top:5px; right:5px; width:22px; height:22px; border-radius:5px; background:rgba(0,0,0,0.4); border:none; color:rgba(255,255,255,0.4); display:flex; align-items:center; justify-content:center; cursor:pointer; opacity:0; transition:opacity .2s; }
        .pad:hover .pedit { opacity:1; }
        .pedit i { width:12px; height:12px; }
        .pad.emp { background:rgba(255,255,255,0.02); }
        .pad.emp .plbl { color:var(--muted); }

        /* MODAL */
        .mo { display:none; position:fixed; inset:0; z-index:9000; background:rgba(0,0,0,0.7); backdrop-filter:blur(6px); align-items:flex-end; }
        .mo.s { display:flex; }
        .msh { background:rgba(13,20,38,0.99); border-top:1px solid var(--border); border-radius:20px 20px 0 0; padding:18px 18px 38px; width:100%; max-width:500px; margin:0 auto; animation:su .3s ease; }
        @keyframes su { from{transform:translateY(100%)} to{transform:translateY(0)} }
        .mh { width:40px; height:4px; background:rgba(255,255,255,0.2); border-radius:2px; margin:0 auto 14px; }
        .mtit { font-size:16px; font-weight:900; margin-bottom:16px; }
        .cpick { display:flex; flex-wrap:wrap; gap:8px; margin-bottom:12px; }
        .csw { width:30px; height:30px; border-radius:50%; cursor:pointer; border:2px solid transparent; transition:all .2s; }
        .csw.sel { border-color:#fff; transform:scale(1.15); }
        .epick { display:flex; flex-wrap:wrap; gap:7px; margin-bottom:12px; font-size:22px; }
        .eopt { cursor:pointer; padding:4px; border-radius:6px; transition:background .15s; }
        .eopt:hover,.eopt.sel { background:rgba(255,255,255,0.1); }

        /* STATUS */
        .sb { background:rgba(0,0,0,0.3); border:1px solid var(--border); border-radius:var(--rsm); padding:11px 13px; font-size:12px; font-weight:600; color:var(--muted); display:flex; align-items:center; gap:8px; margin-top:10px; }
        .sb i { width:13px; height:13px; flex-shrink:0; }
        .sb.ok { background:rgba(16,185,129,0.08); border-color:rgba(16,185,129,0.25); color:var(--ok); }
        .sb.err { background:rgba(239,68,68,0.08); border-color:rgba(239,68,68,0.25); color:var(--err); }
        .sb.warn { background:rgba(251,191,36,0.08); border-color:rgba(251,191,36,0.25); color:var(--gold); }

        /* TOAST */
        #toast { position:fixed; top:70px; left:50%; transform:translateX(-50%) translateY(-200%); background:rgba(15,23,42,0.98); border:1px solid var(--accent); padding:10px 20px; border-radius:var(--rsm); font-size:13px; font-weight:700; z-index:9999; white-space:nowrap; backdrop-filter:blur(12px); transition:transform .35s cubic-bezier(0.175,0.885,0.32,1.275); box-shadow:0 8px 30px rgba(0,0,0,0.5); pointer-events:none; }
        #toast.s { transform:translateX(-50%) translateY(0); }

        /* MISC */
        .dv { height:1px; background:var(--border); margin:10px 0; }
        .ctdbox { background:rgba(251,191,36,0.05); border:1px solid rgba(251,191,36,0.2); border-radius:var(--rsm); padding:12px 14px; display:flex; align-items:center; gap:12px; margin-bottom:14px; }
        .ctdv { font-size:20px; font-weight:900; }
        .ctdl { font-size:9px; font-weight:800; color:var(--gold); text-transform:uppercase; letter-spacing:.8px; }
        .ctdn { font-size:10px; color:var(--muted); font-weight:600; }
        .lcnt { font-size:11px; color:var(--muted); font-weight:700; text-align:center; padding:8px 0; }
    </style>
</head>
<body>

<!-- GATE -->
<div id="gate">
    <div class="gc">
        <div class="gl">RB <span>LIVE</span></div>
        <div class="gs">Radio Control Panel</div>
        <div class="giw">
            <input class="gi" type="password" id="gi" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" maxlength="20" onkeydown="if(event.key==='Enter')chkPw()">
            <button class="geye" onclick="togEye()" id="geyebtn">
                <i data-lucide="eye" style="width:18px;height:18px;" id="geyeic"></i>
            </button>
        </div>
        <div class="gerr" id="gerr"></div>
        <button class="gbtn" onclick="chkPw()">üîì Unlock</button>
        <button class="gbk" onclick="location.href='index.html'">‚Üê Back to App</button>
    </div>
</div>

<!-- TOAST -->
<div id="toast"></div>

<!-- PAD EDIT MODAL -->
<div class="mo" id="padMo">
    <div class="msh">
        <div class="mh"></div>
        <div class="mtit">‚úèÔ∏è Edit Pad</div>
        <div class="f"><label>Label</label><input type="text" id="plbl" placeholder="e.g. Applause" maxlength="16" style="user-select:text;"></div>
        <div class="f">
            <label>Emoji</label>
            <div class="epick" id="epick"></div>
        </div>
        <div class="f">
            <label>Color</label>
            <div class="cpick" id="cpick"></div>
        </div>
        <div class="f">
            <label>Sound File</label>
            <div class="uz" id="sfxuz" style="padding:14px;">
                <input type="file" id="sfxfi" accept="audio/*" onchange="hSfxUp(event)">
                <div style="font-size:12px;font-weight:600;color:var(--muted);" id="sfxlbl">üìÅ Tap to upload sound (MP3, WAV, OGG)</div>
                <div class="uprog" id="sfxprog" style="display:none;">
                    <div class="ubtrack"><div class="ubfill" id="sfxbar"></div></div>
                    <div class="ubtxt" id="sfxtxt">Uploading...</div>
                </div>
            </div>
        </div>
        <div class="brow">
            <button class="btn bg" onclick="closeMo()"><i data-lucide="x"></i> Cancel</button>
            <button class="btn bp" onclick="savePad()"><i data-lucide="check"></i> Save Pad</button>
        </div>
    </div>
</div>

<!-- MAIN -->
<div id="mc">
    <div class="tnav">
        <button class="nbk" onclick="location.href='index.html'"><i data-lucide="arrow-left" style="width:16px;height:16px;"></i></button>
        <div class="ntit">üìª Radio <span>Control</span></div>
        <div class="pill off" id="npill"><div class="pill-dot"></div><span id="npilltxt">OFFLINE</span></div>
    </div>
    <div class="tabs">
        <button class="tb a" onclick="stab('lib')" id="tlib"><i data-lucide="music-2"></i>Library</button>
        <button class="tb" onclick="stab('q')" id="tq"><i data-lucide="list-music"></i>Queue</button>
        <button class="tb" onclick="stab('mic')" id="tmic"><i data-lucide="mic"></i>Live Mic</button>
        <button class="tb" onclick="stab('sfx')" id="tsfx"><i data-lucide="layout-grid"></i>Sounds</button>
        <button class="tb" onclick="stab('set')" id="tset"><i data-lucide="settings-2"></i>Settings</button>
    </div>

    <!-- LIBRARY TAB -->
    <div class="tp a" id="plib">
        <div class="pg">
            <div class="sl">Upload Music</div>
            <div class="card" style="margin-bottom:14px;">
                <div class="uz" id="muz">
                    <input type="file" id="mfi" accept="audio/*" multiple onchange="hMusicUp(event)">
                    <div class="uz-icon">üéµ</div>
                    <div class="uz-t">Drop music files here</div>
                    <div class="uz-s">MP3 ¬∑ AAC ¬∑ WAV ¬∑ OGG ¬∑ FLAC</div>
                    <div class="uprog" id="muprog" style="display:none;margin-top:12px;">
                        <div class="ubtrack"><div class="ubfill" id="mbar"></div></div>
                        <div class="ubtxt" id="mtxt">Uploading...</div>
                    </div>
                </div>
            </div>
            <div class="sl">Music Library</div>
            <div class="card">
                <div id="liblist"><div class="es"><div class="es-ic">üé∂</div><div class="es-tx">No music uploaded yet</div></div></div>
                <div class="lcnt" id="lcnt"></div>
            </div>
        </div>
    </div>

    <!-- QUEUE TAB -->
    <div class="tp" id="pq">
        <div class="pg">
            <div class="npbar" id="npb">
                <div class="nprow">
                    <div class="vin" id="qvin"><div class="vd"></div></div>
                    <div class="npi">
                        <div class="npt" id="npt">No track playing</div>
                        <div class="nps" id="nps">Queue is empty</div>
                    </div>
                    <div class="npc">
                        <button class="npb sk" onclick="playPrev()"><i data-lucide="skip-back" style="width:15px;height:15px;"></i></button>
                        <button class="npb pp" onclick="togQPlay()" id="qpbtn"><i data-lucide="play" style="width:17px;height:17px;" id="qpic"></i></button>
                        <button class="npb sk" onclick="playNext()"><i data-lucide="skip-forward" style="width:15px;height:15px;"></i></button>
                    </div>
                </div>
                <div class="npg">
                    <div class="npbt"><div class="npbf" id="npbf"></div></div>
                    <div class="nptm"><span id="npel">0:00</span><span id="npdur">0:00</span></div>
                </div>
            </div>
            <div class="brow" style="margin-bottom:14px;">
                <button class="btn bg bsm" onclick="clearQ()"><i data-lucide="trash-2"></i> Clear All</button>
                <button class="btn bp bsm" onclick="stab('lib')" style="flex:1;"><i data-lucide="plus"></i> Add from Library</button>
            </div>
            <div class="sl">Upcoming Tracks</div>
            <div id="qlist"><div class="es"><div class="es-ic">üìã</div><div class="es-tx">Queue is empty ‚Äî add tracks from Library</div></div></div>
        </div>
    </div>

    <!-- LIVE MIC TAB -->
    <div class="tp" id="pmic">
        <div class="pg">
            <div class="card" style="text-align:center;padding:26px 18px;">
                <div class="micbtn" id="mbtn" onclick="togMic()">
                    <i data-lucide="mic" style="width:34px;height:34px;" id="micic"></i>
                </div>
                <div class="ml" id="mlbl">Ready to Broadcast</div>
                <div class="ms" id="msub">Tap the mic to go live</div>
                <div class="vuw"><div class="vubars" id="vubars"></div></div>
                <div class="mchips">
                    <div class="mchip"><span class="mv" id="mclis">0</span>Listeners</div>
                    <div class="mchip"><span class="mv" id="mcdur">0:00</span>Duration</div>
                    <div class="mchip"><span class="mv" id="mclat">~1s</span>Latency</div>
                </div>
            </div>
            <div class="card">
                <div class="ct"><i data-lucide="settings"></i> Mic Settings</div>
                <div class="trow">
                    <div class="tinfo"><div class="tl">Noise Suppression</div><div class="td">Reduce background noise</div></div>
                    <label class="tsw"><input type="checkbox" id="ns" checked><div class="ttr"></div></label>
                </div>
                <div class="dv"></div>
                <div class="trow">
                    <div class="tinfo"><div class="tl">Echo Cancellation</div><div class="td">Remove speaker echo</div></div>
                    <label class="tsw"><input type="checkbox" id="ec" checked><div class="ttr"></div></label>
                </div>
                <div class="dv"></div>
                <div class="f" style="margin-bottom:0;margin-top:10px;">
                    <label>Chunk Size (ms)</label>
                    <input type="number" id="cksz" value="800" min="300" max="2000" step="100" style="user-select:text;">
                    <div class="fh">Lower = less latency. Recommended: 800ms</div>
                </div>
            </div>
            <div class="sb" id="micsb"><i data-lucide="info"></i> Mic not active</div>
        </div>
    </div>

    <!-- SOUNDS TAB -->
    <div class="tp" id="psfx">
        <div class="pg">
            <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:12px;">
                <div class="sl" style="margin-bottom:0;">Sound Pads</div>
                <span style="font-size:9px;font-weight:800;background:rgba(14,165,233,0.15);border:1px solid rgba(14,165,233,0.3);color:var(--glow);padding:2px 8px;border-radius:20px;letter-spacing:.5px;">TAP TO BROADCAST</span>
            </div>
            <div class="pgrid" id="pgrid"></div>
            <div class="sb" id="sfxsb" style="margin-top:14px;"><i data-lucide="speaker"></i> Click a pad to trigger sound for all listeners</div>
        </div>
    </div>

    <!-- SETTINGS TAB -->
    <div class="tp" id="pset">
        <div class="pg">
            <div class="ctdbox" id="ctdb">
                <div style="font-size:22px;">üéØ</div>
                <div>
                    <div class="ctdl">Next Bingo Draw</div>
                    <div class="ctdv" id="ctdv">--:--</div>
                    <div class="ctdn" id="ctdn">Checking...</div>
                </div>
            </div>
            <div class="sl">Broadcast Control</div>
            <div class="card">
                <div class="trow" style="margin-bottom:8px;">
                    <div class="tinfo"><div class="tl">üü¢ Go Live</div><div class="td">Enable radio for all users</div></div>
                    <label class="tsw"><input type="checkbox" id="ilt" onchange="togLive(this.checked)"><div class="ttr"></div></label>
                </div>
                <div class="dv"></div>
                <div class="trow" style="margin-bottom:8px;">
                    <div class="tinfo"><div class="tl">üî¥ Force Off</div><div class="td">Override ‚Äî mute for everyone</div></div>
                    <label class="tsw"><input type="checkbox" id="fot" onchange="togForce(this.checked)"><div class="ttr"></div></label>
                </div>
                <div class="dv"></div>
                <div class="trow">
                    <div class="tinfo"><div class="tl">‚èØÔ∏è Auto-Play on Draw</div><div class="td">Starts 10 min before bingo draw</div></div>
                    <label class="tsw"><input type="checkbox" id="apt" checked onchange="togAP(this.checked)"><div class="ttr"></div></label>
                </div>
            </div>
            <div class="sl">Station Info</div>
            <div class="card">
                <div class="f"><label>Station Name</label><input type="text" id="sni" placeholder="RB Live Radio" maxlength="50" style="user-select:text;"></div>
                <div class="f"><label>Now Playing Text</label><input type="text" id="npi" placeholder="e.g. Bingo Beats with DJ Rico" maxlength="80" style="user-select:text;"><div class="fh">Shown in radio bar on main site</div></div>
                <button class="btn bp" onclick="saveInfo()"><i data-lucide="save"></i> Save Info</button>
            </div>
            <div class="sl">Status</div>
            <div class="card">
                <div class="sb" id="csb"><i data-lucide="wifi-off"></i> Not connected</div>
                <div style="margin-top:14px;">
                    <div class="ct" style="margin-bottom:8px;"><i data-lucide="calendar"></i> Today's Draw Schedule</div>
                    <div id="schlist" style="font-size:12px;color:var(--muted);">Loading...</div>
                </div>
            </div>
            <button class="btn bg" onclick="location.href='index.html'" style="margin-top:8px;"><i data-lucide="arrow-left"></i> Back to RB Live</button>
        </div>
    </div>
</div>

<audio id="rca" preload="none"></audio>
<audio id="sfxa" preload="none"></audio>

<script>
// ‚îÄ‚îÄ FIREBASE ‚îÄ‚îÄ
var fc = {
    apiKey:"AIzaSyDIAQXJ15atKJxu7PtcFL1W9JnO1N14pVs",authDomain:"radiobingo-9ac29.firebaseapp.com",
    databaseURL:"https://radiobingo-9ac29-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId:"radiobingo-9ac29",storageBucket:"radiobingo-9ac29.firebasestorage.app",
    messagingSenderId:"965903993397",appId:"1:965903993397:web:f6646fa05225f147eebf7c"
};
if (!firebase.apps.length) firebase.initializeApp(fc);
var db = firebase.database();
var st = firebase.storage();

// ‚îÄ‚îÄ GATE ‚îÄ‚îÄ
var PW = '111198', eyeVis = false;
function chkPw() {
    if (document.getElementById('gi').value === PW) {
        document.getElementById('gate').classList.add('h');
        document.getElementById('mc').classList.add('s');
        init();
    } else {
        var i = document.getElementById('gi');
        document.getElementById('gerr').textContent = 'Incorrect password.';
        i.classList.add('shake'); i.value = '';
        setTimeout(function(){ i.classList.remove('shake'); document.getElementById('gerr').textContent=''; }, 1800);
    }
}
function togEye() {
    eyeVis = !eyeVis;
    document.getElementById('gi').type = eyeVis ? 'text' : 'password';
    document.getElementById('geyeic').setAttribute('data-lucide', eyeVis ? 'eye-off' : 'eye');
    lucide.createIcons();
}

// ‚îÄ‚îÄ STATE ‚îÄ‚îÄ
var S = {
    audio: null, sfxa: null,
    lib: {}, queue: [], qidx: -1, qplaying: false,
    micOn: false, micStream: null, mr: null, mseq: 0, mstart: 0,
    mdtimer: null, analyser: null, actx: null, vuraf: null,
    pads: {}, editPad: -1, editUrl: null,
    selEmoji: 'üéµ', selColor: '#3b82f6'
};

var COLORS = ['#ef4444','#f97316','#eab308','#22c55e','#06b6d4','#3b82f6','#8b5cf6','#ec4899','#14b8a6','#f59e0b','#10b981','#6366f1'];
var EMOJIS = ['üéµ','ü•Å','üé∫','üìØ','üîî','üéä','üëè','üòÇ','üî•','üí•','‚ö°','üéâ','üé∂','üì¢','üö®','üí´','üåü','üé§','üé∏','üëç','üíØ','üéØ'];

// ‚îÄ‚îÄ INIT ‚îÄ‚îÄ
function init() {
    S.audio = document.getElementById('rca');
    S.sfxa = document.getElementById('sfxa');
    lucide.createIcons();
    buildVU(); buildGrid(); buildEP(); buildCP();
    listenState();
    loadLib();
    loadQ();
    loadPads();
    loadSched();
    updateCtd();
    setInterval(updateCtd, 15000);
    setInterval(chkSched, 10000);
    S.audio.addEventListener('ended', onEnd);
    S.audio.addEventListener('timeupdate', updNP);
}

// ‚îÄ‚îÄ TABS ‚îÄ‚îÄ
function stab(t) {
    ['lib','q','mic','sfx','set'].forEach(function(n){
        document.getElementById('t'+n).classList.remove('a');
        document.getElementById('p'+n).classList.remove('a');
    });
    document.getElementById('t'+t).classList.add('a');
    document.getElementById('p'+t).classList.add('a');
    lucide.createIcons();
}

// ‚îÄ‚îÄ FIREBASE LISTENER ‚îÄ‚îÄ
function listenState() {
    db.ref('radioState').on('value', function(snap) {
        var d = snap.val() || {};
        document.getElementById('ilt').checked = d.isLive || false;
        document.getElementById('fot').checked = d.forceOff || false;
        document.getElementById('apt').checked = d.autoPlay !== false;
        if (d.title) document.getElementById('sni').value = d.title;
        if (d.nowPlaying) document.getElementById('npi').value = d.nowPlaying;
        var pill = document.getElementById('npill');
        var pt = document.getElementById('npilltxt');
        pill.className = 'pill';
        var mode = d.mode || 'off';
        if (d.forceOff) { pill.classList.add('off'); pt.textContent = 'FORCE OFF'; }
        else if (d.isLive && mode === 'live') { pt.textContent = 'LIVE MIC'; }
        else if (d.isLive && mode === 'music') { pill.classList.add('mu'); pt.textContent = 'MUSIC'; }
        else if (d.isLive) { pt.textContent = 'LIVE'; }
        else { pill.classList.add('off'); pt.textContent = 'OFFLINE'; }
        updConnStatus(d.isLive, d.forceOff, mode);
    });
}

// ‚îÄ‚îÄ LIBRARY ‚îÄ‚îÄ
function hMusicUp(e) { if (e.target.files.length) upFiles(Array.from(e.target.files)); }

function upFiles(files) {
    var idx = 0;
    var prog = document.getElementById('muprog');
    var fill = document.getElementById('mbar');
    var txt = document.getElementById('mtxt');
    prog.style.display = 'block';
    function next() {
        if (idx >= files.length) {
            prog.style.display = 'none';
            document.getElementById('mfi').value = '';
            toast('‚úÖ ' + files.length + ' track(s) uploaded!');
            return;
        }
        var f = files[idx];
        var tid = db.ref('radioMusic/library').push().key;
        var ref = st.ref('radio/music/' + tid + '_' + f.name);
        txt.textContent = 'Uploading ' + (idx+1) + '/' + files.length + ': ' + f.name;
        var task = ref.put(f);
        task.on('state_changed',
            function(s){ fill.style.width = Math.round(s.bytesTransferred/s.totalBytes*100) + '%'; },
            function(err){ toast('‚ùå ' + err.message); idx++; next(); },
            function() {
                task.snapshot.ref.getDownloadURL().then(function(url) {
                    var ta = new Audio();
                    ta.src = url;
                    var save = function(dur) {
                        db.ref('radioMusic/library/' + tid).set({name:f.name.replace(/\.[^/.]+$/,''),url:url,size:f.size,duration:dur||0,addedAt:Date.now()}, function(){ idx++; next(); });
                    };
                    ta.onloadedmetadata = function(){ save(Math.round(ta.duration)); };
                    ta.onerror = function(){ save(0); };
                });
            }
        );
    }
    next();
}

function loadLib() {
    db.ref('radioMusic/library').on('value', function(snap) {
        S.lib = snap.val() || {};
        rendLib();
    });
}

function rendLib() {
    var el = document.getElementById('liblist');
    var cnt = document.getElementById('lcnt');
    var keys = Object.keys(S.lib);
    if (!keys.length) {
        el.innerHTML = '<div class="es"><div class="es-ic">üé∂</div><div class="es-tx">No music uploaded yet</div></div>';
        cnt.textContent = ''; return;
    }
    keys.sort(function(a,b){ return (S.lib[b].addedAt||0)-(S.lib[a].addedAt||0); });
    cnt.textContent = keys.length + ' track' + (keys.length!==1?'s':'') + ' in library';
    var h = '<div class="tlist">';
    keys.forEach(function(id) {
        var t = S.lib[id];
        h += '<div class="ti" id="li-'+id+'">' +
            '<div class="tthumb">üéµ</div>' +
            '<div style="flex:1;min-width:0;"><div class="tname">'+esc(t.name)+'</div>' +
            '<div class="tmeta"><span>'+(t.duration?fmt(t.duration):'?:??')+'</span>'+(t.size?'<span>'+(t.size/1048576).toFixed(1)+' MB</span>':'')+'</div></div>' +
            '<div class="tacts">' +
                '<div class="ta add" title="Add to Queue" onclick="addQ(\''+id+'\')"><i data-lucide="plus" style="width:13px;height:13px;"></i></div>' +
                '<div class="ta" title="Preview" onclick="prevTrack(\''+id+'\')"><i data-lucide="play" style="width:13px;height:13px;"></i></div>' +
                '<div class="ta del" title="Delete" onclick="delTrack(\''+id+'\')"><i data-lucide="trash-2" style="width:13px;height:13px;"></i></div>' +
            '</div></div>';
    });
    h += '</div>';
    el.innerHTML = h;
    lucide.createIcons();
}

function prevTrack(id) { var t=S.lib[id]; if(!t)return; S.audio.src=t.url; S.audio.play().catch(function(){}); toast('‚ñ∂ '+t.name); }
function delTrack(id) { if(!confirm('Delete "'+S.lib[id].name+'"?'))return; db.ref('radioMusic/library/'+id).remove(); toast('üóë Deleted'); }
function addQ(tid) {
    var t = S.lib[tid]; if (!t) return;
    var ref = db.ref('radioMusic/queue').push();
    ref.set({trackId:tid,trackName:t.name,trackUrl:t.url,duration:t.duration||0,order:Date.now(),scheduledAt:0});
    toast('‚ûï Added: '+t.name);
    var el = document.getElementById('li-'+tid);
    if (el) { el.style.borderColor='rgba(14,165,233,0.6)'; setTimeout(function(){ el.style.borderColor=''; },900); }
}

// ‚îÄ‚îÄ QUEUE ‚îÄ‚îÄ
function loadQ() {
    db.ref('radioMusic/queue').on('value', function(snap) {
        var r = snap.val() || {};
        S.queue = Object.keys(r).map(function(k){ return Object.assign({id:k},r[k]); }).sort(function(a,b){ return (a.order||0)-(b.order||0); });
        rendQ();
    });
    db.ref('radioMusic/current').on('value', function(snap) {
        updNPBar(snap.val() || {});
    });
}

function rendQ() {
    var el = document.getElementById('qlist');
    if (!S.queue.length) { el.innerHTML='<div class="es"><div class="es-ic">üìã</div><div class="es-tx">Queue is empty ‚Äî add tracks from Library</div></div>'; return; }
    var h = '';
    S.queue.forEach(function(item, i) {
        var isp = i===S.qidx;
        var sc = item.scheduledAt ? 'üïê '+new Date(item.scheduledAt).toLocaleTimeString('en-PH',{hour:'2-digit',minute:'2-digit',hour12:true}) : '';
        h += '<div class="qi'+(isp?' pl':'')+'" id="qi-'+item.id+'">' +
            '<div class="qnum">'+(isp?'‚ñ∂':(i+1))+'</div>' +
            '<div style="flex:1;min-width:0;"><div class="qname">'+esc(item.trackName)+'</div>' +
            (sc?'<div class="qsc">'+sc+'</div>':'')+'</div>' +
            '<div class="qacts">' +
                '<div class="ta" title="Play Now" onclick="playIdx('+i+')"><i data-lucide="play" style="width:13px;height:13px;"></i></div>' +
                '<div class="ta" title="Schedule" onclick="openSched(\''+item.id+'\')"><i data-lucide="clock" style="width:13px;height:13px;"></i></div>' +
                '<div class="ta del" title="Remove" onclick="remQ(\''+item.id+'\')"><i data-lucide="x" style="width:13px;height:13px;"></i></div>' +
            '</div></div>';
    });
    el.innerHTML = h;
    lucide.createIcons();
}

function openSched(qid) {
    var item = S.queue.find(function(q){ return q.id===qid; });
    if (!item) return;
    var cur = item.scheduledAt ? new Date(item.scheduledAt).toTimeString().substr(0,5) : '';
    var t = prompt('Schedule time (HH:MM) ‚Äî blank to remove:', cur);
    if (t===null) return;
    var ts = 0;
    if (t.trim()) {
        var d = new Date();
        var p = t.trim().split(':');
        d.setHours(parseInt(p[0]),parseInt(p[1]||0),0,0);
        ts = d.getTime();
    }
    db.ref('radioMusic/queue/'+qid).update({scheduledAt:ts});
    toast(ts ? '‚è∞ Scheduled: '+t : 'üóë Schedule removed');
}

function chkSched() {
    var now = Date.now();
    S.queue.forEach(function(item, i) {
        if (item.scheduledAt && item.scheduledAt > 0 && Math.abs(now-item.scheduledAt) < 30000 && S.qidx < i) {
            playIdx(i);
        }
    });
}

function playIdx(i) {
    if (i<0||i>=S.queue.length) return;
    S.qidx = i;
    var item = S.queue[i];
    S.audio.src = item.trackUrl;
    S.audio.play().then(function() {
        S.qplaying = true;
        var now = Date.now();
        db.ref('radioMusic/current').set({id:item.trackId,name:item.trackName,url:item.trackUrl,startedAt:now,duration:item.duration||0,playing:true});
        db.ref('radioState').update({mode:'music',isLive:true});
        rendQ();
    }).catch(function(e){ toast('‚ùå '+e.message); });
}

function togQPlay() {
    if (S.qplaying) {
        S.audio.pause(); S.qplaying = false;
        db.ref('radioMusic/current').update({playing:false});
        document.getElementById('qpic').setAttribute('data-lucide','play');
        document.getElementById('qvin').classList.remove('sp');
    } else {
        if (S.qidx>=0) {
            S.audio.play(); S.qplaying = true;
            db.ref('radioMusic/current').update({playing:true,startedAt:Date.now()-(S.audio.currentTime*1000)});
            document.getElementById('qpic').setAttribute('data-lucide','pause');
            document.getElementById('qvin').classList.add('sp');
        } else if (S.queue.length) { playIdx(0); }
    }
    lucide.createIcons();
}

function playNext() { var n=S.qidx+1; if(n<S.queue.length){playIdx(n);}else{toast('üìã End of queue');stopQ();} }
function playPrev() { var p=S.qidx-1; if(p>=0){playIdx(p);}else{S.audio.currentTime=0;} }
function onEnd() { var n=S.qidx+1; if(n<S.queue.length){setTimeout(function(){playIdx(n);},400);}else{stopQ();toast('üìã Queue finished');} }
function stopQ() {
    S.audio.pause(); S.audio.src=''; S.qplaying=false; S.qidx=-1;
    db.ref('radioMusic/current').set({playing:false,name:'',url:''});
    db.ref('radioState').update({mode:'off',isLive:false});
}
function remQ(qid) { db.ref('radioMusic/queue/'+qid).remove(); toast('üóë Removed'); }
function clearQ() { if(!confirm('Clear entire queue?'))return; stopQ(); db.ref('radioMusic/queue').remove(); toast('üóë Queue cleared'); }

function updNPBar(cur) {
    var tit=document.getElementById('npt'), sta=document.getElementById('nps');
    var vin=document.getElementById('qvin'), pic=document.getElementById('qpic');
    if (cur&&cur.name&&cur.playing) {
        tit.textContent=cur.name; sta.textContent='‚ñ∂ Playing';
        vin.classList.add('sp'); pic.setAttribute('data-lucide','pause');
    } else if (cur&&cur.name) {
        tit.textContent=cur.name; sta.textContent='‚è∏ Paused';
        vin.classList.remove('sp'); pic.setAttribute('data-lucide','play');
    } else {
        tit.textContent='No track playing'; sta.textContent='Queue is empty';
        vin.classList.remove('sp'); pic.setAttribute('data-lucide','play');
    }
    lucide.createIcons();
}

function updNP() {
    if (!S.audio||!S.audio.duration) return;
    var pct = (S.audio.currentTime/S.audio.duration)*100;
    document.getElementById('npbf').style.width = pct+'%';
    document.getElementById('npel').textContent = fmt(Math.floor(S.audio.currentTime));
    document.getElementById('npdur').textContent = fmt(Math.floor(S.audio.duration));
}

// ‚îÄ‚îÄ LIVE MIC ‚îÄ‚îÄ
function buildVU() {
    var h=''; for(var i=0;i<20;i++) h+='<div class="vubar" id="vb'+i+'"></div>';
    document.getElementById('vubars').innerHTML = h;
}

function togMic() { if(S.micOn){stopMic();}else{startMic();} }

function startMic() {
    var constraints = {audio:{noiseSuppression:document.getElementById('ns').checked,echoCancellation:document.getElementById('ec').checked,sampleRate:44100}};
    navigator.mediaDevices.getUserMedia(constraints).then(function(stream) {
        S.micStream = stream; S.micOn = true; S.mseq = 0; S.mstart = Date.now();
        S.actx = new (window.AudioContext||window.webkitAudioContext)();
        var src = S.actx.createMediaStreamSource(stream);
        S.analyser = S.actx.createAnalyser(); S.analyser.fftSize = 64;
        src.connect(S.analyser); animVU();
        var chkms = parseInt(document.getElementById('cksz').value)||800;
        var mime = MediaRecorder.isTypeSupported('audio/webm;codecs=opus')?'audio/webm;codecs=opus':'audio/ogg;codecs=opus';
        S.mr = new MediaRecorder(stream,{mimeType:mime,audioBitsPerSecond:64000});
        S.mr.ondataavailable = function(e) {
            if (e.data&&e.data.size>10) {
                var r = new FileReader();
                r.onload = function() {
                    var seq=++S.mseq, b64=r.result.split(',')[1];
                    db.ref('liveBroadcast/chunks/'+seq).set({data:b64,mime:mime,ts:Date.now(),seq:seq});
                    db.ref('liveBroadcast/latestSeq').set(seq);
                    if(seq>40) db.ref('liveBroadcast/chunks/'+(seq-40)).remove();
                };
                r.readAsDataURL(e.data);
            }
        };
        S.mr.start(chkms);
        db.ref('liveBroadcast').update({active:true,startedAt:Date.now()});
        db.ref('radioState').update({mode:'live',isLive:true});
        setMicUI(true);
        S.mdtimer = setInterval(function(){
            document.getElementById('mcdur').textContent = fmt(Math.floor((Date.now()-S.mstart)/1000));
            db.ref('liveBroadcast/listeners').once('value',function(s){ document.getElementById('mclis').textContent=s.val()||0; });
        },1000);
        updMicSB('ok','üî¥ Broadcasting live to all listeners');
    }).catch(function(e){ toast('‚ùå Mic denied: '+e.message); updMicSB('err','‚ùå Microphone access denied'); });
}

function stopMic() {
    if(S.mr){try{S.mr.stop();}catch(e){} S.mr=null;}
    if(S.micStream){S.micStream.getTracks().forEach(function(t){t.stop();});S.micStream=null;}
    if(S.actx){try{S.actx.close();}catch(e){} S.actx=null;}
    if(S.vuraf){cancelAnimationFrame(S.vuraf);S.vuraf=null;}
    if(S.mdtimer){clearInterval(S.mdtimer);S.mdtimer=null;}
    S.micOn=false;
    db.ref('liveBroadcast').update({active:false});
    db.ref('radioState').update({mode:'off',isLive:false});
    setMicUI(false); resetVU(); updMicSB('','Mic stopped');
}

function setMicUI(on) {
    var btn=document.getElementById('mbtn'),ic=document.getElementById('micic');
    var lbl=document.getElementById('mlbl'),sub=document.getElementById('msub');
    if(on){btn.classList.add('on');ic.setAttribute('data-lucide','mic-off');lbl.textContent='üî¥ LIVE ‚Äî Broadcasting';sub.textContent='Tap to stop';}
    else{btn.classList.remove('on');ic.setAttribute('data-lucide','mic');lbl.textContent='Ready to Broadcast';sub.textContent='Tap the mic to go live';document.getElementById('mcdur').textContent='0:00';document.getElementById('mclis').textContent='0';}
    lucide.createIcons();
}
function updMicSB(t,m) {
    var b=document.getElementById('micsb');
    b.className='sb'+(t?' '+t:'');
    b.innerHTML='<i data-lucide="info" style="width:13px;height:13px;"></i> '+m;
    lucide.createIcons();
}
function animVU() {
    if(!S.analyser)return;
    var d=new Uint8Array(S.analyser.frequencyBinCount);
    S.analyser.getByteFrequencyData(d);
    var step=Math.floor(d.length/20);
    var cols=['#10b981','#10b981','#10b981','#10b981','#10b981','#22c55e','#22c55e','#22c55e','#22c55e','#fbbf24','#fbbf24','#fbbf24','#f97316','#f97316','#ef4444','#ef4444','#ef4444','#ef4444','#ef4444','#ef4444'];
    for(var i=0;i<20;i++){var b=document.getElementById('vb'+i);if(b){b.style.height=Math.max(3,Math.round(d[i*step]/255*48))+'px';b.style.background=cols[i];}}
    S.vuraf=requestAnimationFrame(animVU);
}
function resetVU(){ for(var i=0;i<20;i++){var b=document.getElementById('vb'+i);if(b){b.style.height='3px';b.style.background='rgba(255,255,255,0.08)';}} }

// ‚îÄ‚îÄ SOUNDBOARD ‚îÄ‚îÄ
function buildGrid() {
    var h='';
    for(var i=0;i<12;i++) {
        h+='<div class="pad emp" id="pad'+i+'" onclick="trigPad('+i+')">' +
            '<div class="pe" id="pe'+i+'">‚ûï</div>' +
            '<div class="plbl" id="pl'+i+'">Empty</div>' +
            '<button class="pedit" onclick="openPadEdit(event,'+i+')"><i data-lucide="pencil" style="width:11px;height:11px;"></i></button>' +
        '</div>';
    }
    document.getElementById('pgrid').innerHTML = h;
    lucide.createIcons();
}

function buildEP() {
    document.getElementById('epick').innerHTML = EMOJIS.map(function(em){
        return '<span class="eopt" data-emoji="'+em+'" onclick="selEm(\''+em+'\')">'+em+'</span>';
    }).join('');
}
function buildCP() {
    document.getElementById('cpick').innerHTML = COLORS.map(function(c){
        return '<div class="csw" style="background:'+c+';" data-color="'+c+'" onclick="selCol(\''+c+'\')"></div>';
    }).join('');
}

function loadPads() {
    db.ref('radioSoundboard/pads').on('value', function(snap) {
        S.pads = snap.val() || {};
        for(var i=0;i<12;i++) rendPad(i);
        lucide.createIcons();
    });
}

function rendPad(i) {
    var pad=document.getElementById('pad'+i),em=document.getElementById('pe'+i),lbl=document.getElementById('pl'+i);
    var d=S.pads[i];
    if(d&&d.url){
        pad.className='pad hs';
        pad.style.background=(d.color||'#3b82f6')+'22';
        pad.style.borderColor=(d.color||'#3b82f6')+'66';
        em.textContent=d.emoji||'üéµ'; lbl.textContent=d.label||'Sound '+(i+1);
    } else {
        pad.className='pad emp'; pad.style.background=''; pad.style.borderColor='';
        em.textContent='‚ûï'; lbl.textContent='Empty';
    }
}

function trigPad(i) {
    var d=S.pads[i]; if(!d||!d.url){openPadEdit(null,i);return;}
    S.sfxa.src=d.url; S.sfxa.play().catch(function(){});
    db.ref('radioSoundboard/trigger').set({url:d.url,label:d.label||'',ts:Date.now()});
    var pad=document.getElementById('pad'+i);
    pad.classList.add('pfx'); setTimeout(function(){pad.classList.remove('pfx');},280);
    document.getElementById('sfxsb').innerHTML='<i data-lucide="speaker" style="width:13px;height:13px;"></i> üîä Triggered: '+(d.label||'Sound '+(i+1));
    lucide.createIcons(); toast('üîä '+(d.label||'Sound '+(i+1)));
}

function selEm(em) {
    S.selEmoji=em;
    document.querySelectorAll('.eopt').forEach(function(e){e.classList.toggle('sel',e.dataset.emoji===em);});
}
function selCol(c) {
    S.selColor=c;
    document.querySelectorAll('.csw').forEach(function(e){e.classList.toggle('sel',e.dataset.color===c);});
}

function openPadEdit(evt,i) {
    if(evt)evt.stopPropagation();
    S.editPad=i; S.editUrl=null;
    var d=S.pads[i]||{};
    document.getElementById('plbl').value=d.label||'';
    S.selEmoji=d.emoji||'üéµ'; S.selColor=d.color||'#3b82f6';
    document.getElementById('sfxlbl').textContent=d.url?'‚úÖ Sound uploaded':'üìÅ Tap to upload sound';
    document.getElementById('sfxprog').style.display='none';
    document.querySelectorAll('.eopt').forEach(function(e){e.classList.toggle('sel',e.dataset.emoji===S.selEmoji);});
    document.querySelectorAll('.csw').forEach(function(e){e.classList.toggle('sel',e.dataset.color===S.selColor);});
    document.getElementById('padMo').classList.add('s');
    lucide.createIcons();
}
function closeMo() { document.getElementById('padMo').classList.remove('s'); S.editPad=-1; document.getElementById('sfxfi').value=''; }

function hSfxUp(e) {
    var f=e.target.files[0]; if(!f)return;
    var prog=document.getElementById('sfxprog'),fill=document.getElementById('sfxbar'),txt=document.getElementById('sfxtxt'),lbl=document.getElementById('sfxlbl');
    prog.style.display='block'; lbl.textContent='Uploading...';
    var ref=st.ref('radio/sfx/sfx_'+Date.now()+'_'+S.editPad+'_'+f.name);
    var task=ref.put(f);
    task.on('state_changed',
        function(s){fill.style.width=Math.round(s.bytesTransferred/s.totalBytes*100)+'%';},
        function(err){toast('‚ùå '+err.message);prog.style.display='none';},
        function(){task.snapshot.ref.getDownloadURL().then(function(url){S.editUrl=url;prog.style.display='none';lbl.textContent='‚úÖ '+f.name;toast('‚úÖ Sound uploaded!');});}
    );
}

function savePad() {
    var i=S.editPad; if(i<0)return;
    var label=document.getElementById('plbl').value.trim()||'Sound '+(i+1);
    var url=S.editUrl||(S.pads[i]&&S.pads[i].url)||null;
    if(!url){toast('‚ö†Ô∏è Upload a sound file first');return;}
    db.ref('radioSoundboard/pads/'+i).set({label:label,url:url,color:S.selColor,emoji:S.selEmoji});
    closeMo(); toast('‚úÖ Pad saved!');
}

// ‚îÄ‚îÄ SETTINGS ‚îÄ‚îÄ
function togLive(v){db.ref('radioState').update({isLive:v},function(e){if(!e)toast(v?'üì° Radio LIVE':'üì¥ Radio offline');});}
function togForce(v){db.ref('radioState').update({forceOff:v},function(e){if(!e)toast(v?'üö´ Force Off on':'‚úÖ Force Off off');});}
function togAP(v){db.ref('radioState').update({autoPlay:v},function(e){if(!e)toast(v?'‚èØ Auto-play on':'‚è∏ Auto-play off');});}
function saveInfo(){
    db.ref('radioState').update({title:document.getElementById('sni').value.trim()||'RB Live Radio',nowPlaying:document.getElementById('npi').value.trim()},
    function(e){if(!e)toast('‚úÖ Info saved!');});
}

function updConnStatus(live,force,mode){
    var b=document.getElementById('csb'); b.className='sb';
    if(force){b.classList.add('err');b.innerHTML='<i data-lucide="x-circle" style="width:13px;height:13px;"></i> Force Off active';}
    else if(live&&mode==='music'){b.classList.add('ok');b.innerHTML='<i data-lucide="music-2" style="width:13px;height:13px;"></i> Music mode ‚Äî playing queue';}
    else if(live&&mode==='live'){b.classList.add('ok');b.innerHTML='<i data-lucide="mic" style="width:13px;height:13px;"></i> Live mic broadcast active';}
    else if(live){b.classList.add('ok');b.innerHTML='<i data-lucide="check-circle" style="width:13px;height:13px;"></i> Radio is live';}
    else{b.classList.add('warn');b.innerHTML='<i data-lucide="wifi-off" style="width:13px;height:13px;"></i> Radio offline';}
    lucide.createIcons();
}

function loadSched() {
    db.ref('gameState/schedules').once('value', function(snap) {
        var el=document.getElementById('schlist');
        if(!snap.exists()){el.innerHTML='<span style="font-size:12px;color:var(--muted);">No schedules found.</span>';return;}
        var now=Date.now(), times=[];
        snap.forEach(function(c){var v=c.val();times.push((typeof v==='object'&&v.time)?v.time:v);});
        times.sort(function(a,b){return a-b;});
        var h='';
        times.forEach(function(t){
            var past=t<now,next=!past&&times.filter(function(x){return x>now;})[0]===t;
            var dt=new Date(t).toLocaleTimeString('en-PH',{hour:'2-digit',minute:'2-digit',hour12:true});
            h+='<div style="display:flex;align-items:center;gap:8px;padding:5px 0;border-bottom:1px solid rgba(255,255,255,0.04);color:'+(past?'rgba(255,255,255,0.2)':next?'#fbbf24':'rgba(255,255,255,0.7)')+';font-size:12px;font-weight:'+(next?'800':'600')+';">'+
                '<span style="width:14px;">'+(past?'‚úì':next?'‚ñ∂':'¬∑')+'</span><span>'+dt+'</span>'+
                (next?'<span style="font-size:9px;background:rgba(251,191,36,0.15);border:1px solid rgba(251,191,36,0.4);padding:1px 6px;border-radius:10px;color:#fbbf24;font-weight:800;">NEXT</span>':'')+
            '</div>';
        });
        el.innerHTML=h;
    });
}

function updateCtd() {
    db.ref('gameState').once('value',function(snap){
        var d=snap.val()||{},now=Date.now(),next=null;
        if(d.schedules){var ts=Object.values(d.schedules).map(function(v){return(typeof v==='object'&&v.time)?v.time:v;});var f=ts.filter(function(t){return t>now;}).sort(function(a,b){return a-b;});if(f.length)next=f[0];}
        if(!next&&d.nextDraw&&d.nextDraw>now)next=d.nextDraw;
        var ve=document.getElementById('ctdv'),ne=document.getElementById('ctdn'),bx=document.getElementById('ctdb');
        if(next){var diff=next-now;var h=Math.floor(diff/3600000),m=Math.floor((diff%3600000)/60000),s=Math.floor((diff%60000)/1000);ve.textContent=(h>0?h+'h ':'')+m+'m '+s+'s';if(diff<=600000){bx.style.borderColor='rgba(239,68,68,0.4)';ne.textContent='üî¥ Auto-play activating soon!';}else{bx.style.borderColor='';ne.textContent='Auto-play starts 10 min before draw';}}
        else{ve.textContent='No draw scheduled';ne.textContent='Waiting for next schedule';}
    });
}

// ‚îÄ‚îÄ HELPERS ‚îÄ‚îÄ
function fmt(s){var m=Math.floor(s/60);return m+':'+(s%60<10?'0':'')+(s%60);}
function esc(s){return(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');}
function toast(m){var e=document.getElementById('toast');e.textContent=m;e.classList.add('s');setTimeout(function(){e.classList.remove('s');},3000);}

// ‚îÄ‚îÄ DRAG DROP ‚îÄ‚îÄ
window.addEventListener('load',function(){
    lucide.createIcons();
    document.getElementById('gi').focus();
    var z=document.getElementById('muz');
    z.addEventListener('dragover',function(e){e.preventDefault();z.classList.add('dv');});
    z.addEventListener('dragleave',function(){z.classList.remove('dv');});
    z.addEventListener('drop',function(e){
        e.preventDefault();z.classList.remove('dv');
        var files=Array.from(e.dataTransfer.files).filter(function(f){return f.type.startsWith('audio/');});
        if(files.length)upFiles(files);
    });
});
</script>
</body>
</html>
