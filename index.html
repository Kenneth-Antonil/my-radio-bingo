<!DOCTYPE html>
<html lang="tl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#0f172a">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Radio Bingo Live | Social Ecosystem</title>
    
    <script>
        if (window.location.pathname.endsWith("index.html")) {
            var newPath = window.location.pathname.replace(/index\.html$/, "");
            window.history.replaceState({}, document.title, newPath);
        }
    </script>

    <link rel="icon" type="image/png" href="https://i.imgur.com/7D8u8h6.png">
    <link rel="apple-touch-icon" href="https://i.imgur.com/7D8u8h6.png">
    <link rel="manifest" href="manifest.json">
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;900&family=Comic+Neue:wght@700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-messaging.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

    <script src="https://pl28660488.effectivegatecpm.com/9b/f5/85/9bf585b6ee39cb9b515e2fae1fa958c2.js"></script>
    <script src="https://pl28660496.effectivegatecpm.com/a6/64/bf/a664bf7e7084386b4f4b428590030df3.js"></script>

    <style>
        /* === CORE VARIABLES === */
        :root { 
            --bg-overlay: rgba(15, 23, 42, 0.95); 
            --glass-surface: rgba(30, 41, 59, 0.75);
            --glass-border: rgba(255, 255, 255, 0.08);
            
            --accent: #0ea5e9; /* Ocean Blue */
            --accent-glow: #38bdf8;
            --text: #ffffff; 
            --gold: #fbbf24; 
            --gold-shine: #fcd34d;
            --success: #10b981; 
            --danger: #ef4444; 
            --minigame: #f472b6;
            
            /* Messenger Colors */
            --messenger-blue: #3b82f6;
            --messenger-grey: #334155;
            --messenger-bg: #020617;
        }
        
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; user-select: none; }
        
        body { 
            font-family: 'Inter', sans-serif; 
            background: #0f172a;
            color: var(--text); 
            margin: 0; 
            padding-bottom: calc(90px + env(safe-area-inset-bottom)); 
            overflow-x: hidden; 
            min-height: 100vh;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.5);
        }

        /* === BADGE SYSTEM ON AVATAR (NEW) === */
        .avatar-frame {
            position: relative;
            display: inline-block;
        }
        .avatar-img-std {
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid rgba(255,255,255,0.1);
        }
        .badge-overlay {
            position: absolute;
            bottom: 0;
            right: 0;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 2px solid #0f172a; /* Match background to cut out */
            background: #1e293b;
            font-size: 10px;
            z-index: 2;
        }
        .badge-bronze { background: #5a3a22; color: #cd7f32; border-color: #cd7f32; }
        .badge-silver { background: #334155; color: #e2e8f0; border-color: #cbd5e1; }
        .badge-gold { background: #713f12; color: #fbbf24; border-color: #fbbf24; box-shadow: 0 0 5px #fbbf24; }
        .badge-platinum { background: #e2e8f0; color: #475569; border-color: white; box-shadow: 0 0 8px white; }
        .badge-diamond { background: #0891b2; color: #cffafe; border-color: #06b6d4; box-shadow: 0 0 10px #06b6d4; animation: pulseDiamond 2s infinite; }

        /* === MODERN DISCLAIMER === */
        .disclaimer-modern {
            background: rgba(15, 23, 42, 0.8);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(255,255,255,0.05);
            padding: 8px 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        .disclaimer-badge {
            background: rgba(239, 68, 68, 0.2);
            color: #f87171;
            border: 1px solid rgba(239, 68, 68, 0.3);
            font-size: 9px;
            font-weight: 900;
            padding: 3px 6px;
            border-radius: 6px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .disclaimer-text {
            font-size: 10px;
            color: #cbd5e1;
            font-weight: 500;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        /* === MODERN POST CREATOR === */
        .post-creator-modern {
            background: linear-gradient(145deg, rgba(30, 41, 59, 0.6), rgba(15, 23, 42, 0.8));
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            padding: 18px;
            border-radius: 24px;
            border: 1px solid rgba(255, 255, 255, 0.05);
            margin-bottom: 25px;
            box-shadow: 0 20px 40px -10px rgba(0,0,0,0.3);
            display: flex;
            flex-direction: column;
            gap: 15px;
            transition: transform 0.2s;
        }
        .post-input-modern {
            background: rgba(0,0,0,0.2);
            border: 1px solid rgba(255,255,255,0.05);
            border-radius: 16px;
            padding: 15px;
            color: white;
            font-family: 'Inter', sans-serif;
            font-size: 14px;
            resize: none;
            min-height: 80px;
            outline: none;
            transition: 0.3s;
        }
        .post-input-modern:focus {
            background: rgba(0,0,0,0.4);
            border-color: rgba(255,255,255,0.1);
        }
        
        /* MOOD SELECTOR */
        .mood-selector {
            display: flex;
            gap: 8px;
            overflow-x: auto;
            padding: 5px 2px 10px 2px;
            scrollbar-width: none;
        }
        .mood-selector::-webkit-scrollbar { display: none; }
        
        .mood-chip {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 700;
            color: #94a3b8;
            white-space: nowrap;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }
        .mood-chip.active {
            background: linear-gradient(135deg, var(--accent), #2563eb);
            color: white;
            border-color: rgba(255,255,255,0.2);
            box-shadow: 0 4px 15px rgba(14, 165, 233, 0.4);
            transform: scale(1.05);
        }

        .post-tools {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-top: 1px solid rgba(255,255,255,0.05);
            padding-top: 15px;
        }
        .tool-btn {
            display: flex;
            align-items: center;
            gap: 6px;
            background: rgba(255,255,255,0.03);
            border: 1px solid rgba(255,255,255,0.05);
            padding: 8px 14px;
            border-radius: 30px;
            color: #94a3b8;
            font-size: 11px;
            font-weight: 700;
            cursor: pointer;
            transition: 0.2s;
        }
        .btn-post-modern {
            background: linear-gradient(135deg, var(--accent), #2563eb);
            color: white;
            border: none;
            padding: 10px 24px;
            border-radius: 30px;
            font-weight: 800;
            font-size: 12px;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(14, 165, 233, 0.3);
            transition: 0.2s;
        }

        /* === MESSENGER & GROUP CHAT === */
        .msg-image-preview {
            max-width: 200px;
            border-radius: 12px;
            border: 1px solid rgba(255,255,255,0.1);
            margin-top: 5px;
        }
        .pm-footer-modern {
            padding: 10px;
            background: #0f172a;
            display: flex;
            gap: 10px;
            align-items: center;
            border-top: 1px solid #1e293b;
            padding-bottom: calc(15px + env(safe-area-inset-bottom));
        }
        .pm-attach-btn { background: none; border: none; color: #64748b; cursor: pointer; padding: 5px; }
        
        /* Group Creator Styles */
        .group-create-section { padding: 15px; background: #1e293b; border-bottom: 1px solid rgba(255,255,255,0.1); }
        .group-name-input { width: 100%; padding: 12px; background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.1); border-radius: 12px; color: white; margin-bottom: 10px; }
        .friend-select-list { max-height: 200px; overflow-y: auto; display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 15px; }
        .friend-select-item { background: rgba(255,255,255,0.05); padding: 8px; border-radius: 8px; display: flex; align-items: center; gap: 8px; cursor: pointer; border: 1px solid transparent; }
        .friend-select-item.selected { background: rgba(14, 165, 233, 0.2); border-color: var(--accent); }
        .btn-create-group-confirm { width: 100%; background: var(--accent); color: white; border: none; padding: 12px; border-radius: 12px; font-weight: 800; }

        /* === NOTIFICATION UPDATE (IMAGE SUPPORT) === */
        .notif-card-new {
            background: rgba(255,255,255,0.03);
            padding: 12px;
            border-radius: 16px;
            margin-bottom: 10px;
            border: 1px solid rgba(255,255,255,0.05);
            display: flex;
            align-items: center;
            gap: 12px;
            cursor: pointer;
            transition: background 0.2s;
        }
        .notif-card-new:hover { background: rgba(255,255,255,0.08); }
        .notif-img {
            width: 40px; height: 40px; border-radius: 50%; object-fit: cover;
            border: 1px solid rgba(255,255,255,0.1);
        }
        .notif-content { flex: 1; }
        .notif-text { font-size: 13px; color: #e2e8f0; line-height: 1.3; }
        .notif-time { font-size: 10px; color: #64748b; margin-top: 3px; }

        /* === MODERN UNFRIEND BUTTON === */
        .btn-unfriend-modern {
            background: transparent;
            color: var(--danger);
            border: 1px solid var(--danger);
            padding: 10px 0;
            border-radius: 25px;
            font-weight: 800;
            font-size: 12px;
            cursor: pointer;
            width: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            transition: 0.2s;
            box-shadow: 0 4px 15px rgba(239, 68, 68, 0.1);
        }
        .btn-unfriend-modern:active { transform: scale(0.95); background: rgba(239, 68, 68, 0.1); }

        /* Group Chat UI */
        .group-create-btn {
            padding: 8px 15px;
            background: var(--accent);
            color: white;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 800;
            border: none;
            cursor: pointer;
        }

        /* === GAME & CORE STYLES === */
        #customPopupBanner { display: none; position: fixed; inset: 0; z-index: 9999999; background: rgba(0,0,0,0.85); align-items: center; justify-content: center; flex-direction: column; padding: 20px; backdrop-filter: blur(5px); }
        
        /* CARD SKINS (Retained) */
        .card-skin-neon { border: 2px solid #06b6d4 !important; box-shadow: 0 0 20px #06b6d4, inset 0 0 20px rgba(6, 182, 212, 0.2) !important; background: rgba(8, 51, 68, 0.9) !important; }
        .card-skin-neon .cell { border-color: #06b6d4 !important; color: #67e8f9 !important; text-shadow: 0 0 5px #06b6d4 !important; }
        .card-skin-gold { border: 2px solid #f59e0b !important; box-shadow: 0 0 25px #f59e0b, inset 0 0 10px #f59e0b !important; background: linear-gradient(135deg, #451a03, #000) !important; }
        .card-skin-gold .cell { border-color: #fbbf24 !important; color: #fcd34d !important; font-family: 'Times New Roman', serif; }
        .card-skin-pink { border: 2px solid #ec4899 !important; box-shadow: 0 0 20px #ec4899 !important; background: rgba(80, 7, 36, 0.9) !important; }
        .card-skin-pink .cell { border-color: #f472b6 !important; color: #fbcfe8 !important; border-radius: 50% !important; }
        .card-skin-matrix { border: 2px solid #22c55e !important; box-shadow: 0 0 15px #22c55e !important; background: black !important; font-family: 'Courier New', monospace; }
        .card-skin-matrix .cell { border-color: #22c55e !important; color: #4ade80 !important; border-radius: 0 !important; }
        .card-skin-kitty { border: 4px solid #ffc0cb !important; background: radial-gradient(circle, #fff0f5, #ff69b4) !important; box-shadow: 0 0 20px #ff69b4 !important; font-family: 'Comic Neue', cursive; }
        .card-skin-kitty .cell { background: white !important; color: #ff1493 !important; border: 2px solid #ffc0cb !important; border-radius: 15px !important; }
        .card-skin-doraemon { border: 4px solid #0096df !important; background: linear-gradient(180deg, #0096df 0%, #ffffff 100%) !important; box-shadow: 0 0 20px #dd1616 !important; }
        .card-skin-doraemon .cell { background: rgba(255,255,255,0.9) !important; color: #0096df !important; border: 2px solid #dd1616 !important; border-radius: 50% !important; }
        .card-skin-spongebob { border: 4px solid #f7f44d !important; background: url('https://upload.wikimedia.org/wikipedia/commons/thumb/e/e6/SpongeBob_SquarePants_logo.svg/1200px-SpongeBob_SquarePants_logo.svg.png'), #f7f44d !important; background-size: cover !important; box-shadow: 0 0 20px #f7f44d !important; }
        .card-skin-spongebob .cell { background: rgba(255,255,255,0.8) !important; color: #7d5837 !important; border: 2px dashed #7d5837 !important; }
        .card-skin-kuromi { border: 4px solid #000000 !important; background: linear-gradient(135deg, #000000, #4b0082) !important; box-shadow: 0 0 20px #ea65a2 !important; }
        .card-skin-kuromi .cell { background: rgba(234, 101, 162, 0.2) !important; color: #ea65a2 !important; border: 1px solid #ea65a2 !important; border-radius: 8px 0 8px 0 !important; }
        .card-skin-custom { background-size: cover !important; background-position: center !important; border: 2px solid rgba(255,255,255,0.5) !important; box-shadow: 0 0 30px rgba(0,0,0,0.8) !important; }
        .card-skin-custom .cell { background: rgba(0,0,0,0.6) !important; backdrop-filter: blur(4px); color: white !important; border: 1px solid rgba(255,255,255,0.3) !important; }

        .store-nav { display: flex; gap: 8px; margin-bottom: 15px; background: rgba(0,0,0,0.3); padding: 5px; border-radius: 12px; }
        .store-tab-btn { flex: 1; padding: 10px; border: none; background: transparent; color: #94a3b8; font-weight: 800; border-radius: 8px; cursor: pointer; font-size: 11px; text-transform: uppercase; }
        .store-tab-btn.active { background: var(--accent); color: white; box-shadow: 0 4px 10px rgba(14, 165, 233, 0.3); }
        .skins-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
        .skin-item { background: rgba(255,255,255,0.05); padding: 10px; border-radius: 16px; border: 1px solid rgba(255,255,255,0.1); text-align: center; position: relative; overflow: hidden; }
        .skin-preview { height: 60px; border-radius: 8px; margin-bottom: 8px; display: flex; align-items: center; justify-content: center; font-size: 20px; font-weight: 900; background-size: cover; background-position: center; }
        .skin-name { font-size: 12px; font-weight: 800; color: white; margin-bottom: 4px; }
        .skin-cost { font-size: 10px; color: var(--gold); margin-bottom: 8px; font-weight: 700; }
        .btn-buy-skin { width: 100%; padding: 8px; border: none; border-radius: 8px; font-weight: 800; font-size: 10px; cursor: pointer; }
        .btn-buy-skin.owned { background: rgba(255,255,255,0.1); color: #cbd5e1; cursor: default; }
        .btn-buy-skin.buy { background: var(--gold); color: black; }
        .btn-buy-skin.equip { background: var(--success); color: white; }

        .task-list { display: flex; flex-direction: column; gap: 10px; }
        .task-item { background: linear-gradient(135deg, rgba(30,41,59,0.9), rgba(15,23,42,0.95)); padding: 15px; border-radius: 16px; border: 1px solid rgba(255,255,255,0.1); display: flex; justify-content: space-between; align-items: center; position: relative; overflow: hidden; }
        .task-info h4 { margin: 0; font-size: 13px; font-weight: 900; color: white; letter-spacing: 0.5px; }
        .task-info p { margin: 3px 0 0; font-size: 10px; color: #94a3b8; }
        .task-reward { background: rgba(251, 191, 36, 0.15); color: var(--gold); padding: 4px 8px; border-radius: 6px; font-size: 10px; font-weight: 800; margin-top: 5px; display: inline-block; border: 1px solid rgba(251, 191, 36, 0.3); }
        .btn-do-task { background: var(--accent); color: white; border: none; padding: 10px 18px; border-radius: 10px; font-weight: 800; font-size: 11px; cursor: pointer; transition: 0.2s; box-shadow: 0 4px 10px rgba(14, 165, 233, 0.3); min-width: 80px; z-index: 2; }
        
        .flying-coin { position: fixed; width: 24px; height: 24px; background-image: url('https://cdn-icons-png.flaticon.com/512/217/217853.png'); background-size: contain; background-repeat: no-repeat; z-index: 99999; pointer-events: none; will-change: transform, opacity; }
        .shake-effect { animation: shake-hard 0.3s ease-in-out; will-change: transform; }
        @keyframes shake-hard { 0% { transform: translate(0, 0); } 25% { transform: translate(-3px, 3px); } 50% { transform: translate(3px, -3px); } 75% { transform: translate(-3px, -3px); } 100% { transform: translate(0, 0); } }
        
        #installGate { position: fixed; inset: 0; z-index: 2147483647; background: #0f172a; display: none; flex-direction: column; align-items: center; justify-content: center; text-align: center; padding: 30px; }
        .gate-logo { font-size: 64px; font-weight: 900; letter-spacing: -3px; color: white; margin-bottom: 10px; text-shadow: 0 0 40px rgba(14, 165, 233, 0.6); }
        .gate-logo span { color: var(--accent-glow); }
        .gate-btn-install { background: linear-gradient(135deg, var(--accent), #2563eb); color: white; border: none; padding: 18px 40px; border-radius: 50px; font-weight: 900; font-size: 16px; cursor: pointer; box-shadow: 0 0 30px rgba(14, 165, 233, 0.5); }
        
        #notifBlocker { position: fixed; inset: 0; z-index: 9999999; background: rgba(15, 23, 42, 0.98); display: none; flex-direction: column; align-items: center; justify-content: center; text-align: center; padding: 30px; backdrop-filter: blur(10px); }
        .notif-gate-icon { width: 80px; height: 80px; background: rgba(59, 130, 246, 0.2); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-bottom: 20px; box-shadow: 0 0 30px rgba(59, 130, 246, 0.4); }
        .btn-allow-notif { background: linear-gradient(135deg, var(--accent), #2563eb); color: white; border: none; padding: 15px 30px; border-radius: 16px; font-weight: 800; font-size: 16px; cursor: pointer; }

        #splash-screen { position: fixed; inset: 0; background: #0f172a; z-index: 99999; display: flex; flex-direction: column; align-items: center; justify-content: center; transition: opacity 0.8s ease, visibility 0.8s; }
        .splash-logo { font-size: 60px; font-weight: 900; letter-spacing: -3px; color: white; animation: pulseLogo 2s infinite ease-in-out; text-shadow: 0 0 30px rgba(14, 165, 233, 0.5); }
        .splash-loader { width: 40px; height: 40px; border: 4px solid rgba(255,255,255,0.1); border-top: 4px solid var(--accent); border-radius: 50%; margin-top: 20px; animation: spin 1s linear infinite; }
        @keyframes pulseLogo { 0%, 100% { transform: scale(1); filter: drop-shadow(0 0 10px rgba(56,189,248,0.2)); } 50% { transform: scale(1.1); filter: drop-shadow(0 0 30px rgba(56,189,248,0.8)); } }
        @keyframes spin { 100% { transform: rotate(360deg); } }
        
        #customToast { position: fixed; top: 20px; left: 50%; transform: translateX(-50%) translateY(-150%); background: rgba(15, 23, 42, 0.95); border: 1px solid var(--accent); padding: 16px 24px; border-radius: 16px; z-index: 100000; display: flex; align-items: center; justify-content: center; text-align: center; gap: 12px; box-shadow: 0 10px 40px rgba(0,0,0,0.8); backdrop-filter: blur(12px); transition: transform 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); min-width: 280px; max-width: 90%; }
        #customToast.show { transform: translateX(-50%) translateY(0); }

        /* HEADER STYLES */
        .nav { background: rgba(15, 23, 42, 0.95); backdrop-filter: blur(15px); padding: 10px 15px; display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 100; border-bottom: 1px solid rgba(255,255,255,0.1); height: auto; min-height: 60px; }
        .user-stats { display: flex; align-items: center; gap: 8px; }
        .icon-btn { background: rgba(255,255,255,0.1); color: white; border: 1px solid rgba(255,255,255,0.15); width: 38px; height: 38px; border-radius: 12px; cursor: pointer; position: relative; display: flex; align-items: center; justify-content: center; transition: 0.2s; }
        .icon-btn:active { transform: scale(0.95); }
        .notif-badge { position: absolute; top: 8px; right: 8px; background: var(--danger); width: 8px; height: 8px; border-radius: 50%; border: 1px solid var(--surface); display: none; z-index: 10; box-shadow: 0 0 10px var(--danger); }
        .points-badge { background: linear-gradient(135deg, rgba(251, 191, 36, 0.2), rgba(245, 158, 11, 0.4)); color: #fff; padding: 0 12px; height: 38px; border-radius: 12px; font-weight: 800; border: 1px solid rgba(251, 191, 36, 0.6); font-size: 13px; cursor: pointer; display: flex; align-items: center; gap: 6px; text-shadow: 0 1px 2px rgba(0,0,0,0.8); box-shadow: 0 4px 15px rgba(245, 158, 11, 0.3); }
        
        /* BOTTOM NAV */
        .bottom-nav { position: fixed; bottom: 0; left: 0; right: 0; background: rgba(15, 23, 42, 0.95); backdrop-filter: blur(15px); border-top: 1px solid rgba(255,255,255,0.1); height: calc(65px + env(safe-area-inset-bottom)); display: flex; justify-content: space-around; align-items: flex-start; z-index: 5000; padding-top: 10px; padding-bottom: env(safe-area-inset-bottom); }
        .nav-item { display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 4px; color: #94a3b8; width: 20%; height: 50px; border: none; background: none; cursor: pointer; transition: 0.2s; }
        .nav-item.active { color: var(--accent-glow); }
        .nav-icon { width: 24px; height: 24px; transition: 0.2s; }
        .nav-center { position: relative; top: -25px; }
        .nav-center .nav-icon-bg { background: linear-gradient(135deg, var(--accent), #2563eb); width: 50px; height: 50px; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; box-shadow: 0 8px 20px rgba(14, 165, 233, 0.5); border: 4px solid #0f172a; }

        /* BINGO CARD */
        .card { background: var(--glass-surface); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); border-radius: 24px; padding: 15px; margin-bottom: 20px; border: 1px solid var(--glass-border); position: relative; transition: all 0.3s ease; box-shadow: 0 15px 35px rgba(0,0,0,0.4); }
        .grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 4px; position: relative; }
        .cell { aspect-ratio: 1; background: rgba(255,255,255,0.1); border-radius: 12px; display: flex; align-items: center; justify-content: center; font-weight: 800; font-size: 16px; border: 1px solid rgba(255,255,255,0.15); transition: all 0.3s; z-index: 2; position: relative; overflow: hidden; box-shadow: inset 0 2px 5px rgba(255,255,255,0.05); color: white; text-shadow: 0 2px 3px black; }
        .cell.hit { background: linear-gradient(135deg, var(--accent), #2563eb); color: white; transform: scale(1.05); border-color: rgba(255,255,255,0.6); box-shadow: 0 5px 15px rgba(59, 130, 246, 0.6); text-shadow: 0 2px 2px rgba(0,0,0,0.5); }
        
        /* SOCIAL FEED & REACTIONS */
        .social-feed-container { margin-top: 15px; display: flex; flex-direction: column; gap: 15px; }
        .post-card { background: #1e293b; border-radius: 16px; border: 1px solid rgba(255,255,255,0.05); overflow: hidden; margin-bottom: 10px; }
        .post-header { padding: 12px; display: flex; align-items: center; gap: 10px; border-bottom: 1px solid rgba(255,255,255,0.05); }
        .post-actions { display: flex; border-top: 1px solid rgba(255,255,255,0.05); position: relative; }
        .action-btn { flex: 1; background: transparent; border: none; color: #94a3b8; padding: 12px; font-size: 12px; font-weight: 600; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 6px; transition: 0.2s; position: relative; }
        .action-btn:hover { background: rgba(255,255,255,0.05); color: white; }
        
        /* REACTION POPUP */
        .reaction-popup {
            position: absolute;
            bottom: 100%;
            left: 10px;
            background: rgba(30, 41, 59, 0.95);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 50px;
            padding: 5px;
            display: flex;
            gap: 5px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.5);
            backdrop-filter: blur(10px);
            z-index: 50;
            animation: popIn 0.2s ease-out;
            pointer-events: auto;
        }
        @keyframes popIn { 0% { transform: scale(0); opacity: 0; } 100% { transform: scale(1); opacity: 1; } }
        .reaction-icon-btn {
            font-size: 20px;
            background: none;
            border: none;
            cursor: pointer;
            transition: transform 0.2s;
            padding: 5px;
        }
        .reaction-icon-btn:hover { transform: scale(1.3); }
        .reaction-display {
            display: flex; align-items: center; gap: 4px;
        }
        .reaction-display img { width: 16px; height: 16px; }

        /* PROFILE PAGE NEW */
        .profile-page-container { position: fixed; inset: 0; background: #020617; z-index: 6000; display: none; flex-direction: column; overflow-y: auto; padding-bottom: calc(80px + env(safe-area-inset-bottom)); }
        .profile-cover { height: 35vh; min-height: 200px; max-height: 280px; background-size: cover; background-position: center; position: relative; background-color: #334155; mask-image: linear-gradient(to bottom, black 70%, transparent 100%); -webkit-mask-image: linear-gradient(to bottom, black 70%, transparent 100%); }
        .profile-nav-back { position: absolute; top: 15px; left: 15px; z-index: 20; width: 40px; height: 40px; border-radius: 50%; background: rgba(0,0,0,0.4); backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.1); color: white; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: transform 0.2s; }
        .profile-info-section { padding: 0 20px; margin-top: -60px; position: relative; z-index: 10; display: flex; flex-direction: column; align-items: center; }
        .profile-avatar-container { position: relative; margin-bottom: 10px; width: 140px; height: 140px; }
        .profile-page-img { width: 140px; height: 140px; border-radius: 50%; border: 4px solid #020617; object-fit: cover; background: #0f172a; box-shadow: 0 10px 40px rgba(0,0,0,0.6); }
        .profile-badge-overlay { position: absolute; bottom: 5px; right: 5px; width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; border: 3px solid #020617; background: #1e293b; z-index: 5; font-size: 16px; box-shadow: 0 4px 10px rgba(0,0,0,0.5); }
        
        /* Global Modal & Utils */
        .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 6000; display: none; align-items: center; justify-content: center; padding: 15px; backdrop-filter: blur(15px); }
        .modal-content { background: rgba(30, 41, 59, 0.95); border-radius: 30px; width: 100%; max-width: 450px; padding: 25px; border: 1px solid rgba(255,255,255,0.2); max-height: 90vh; overflow-y: auto; box-shadow: 0 25px 60px rgba(0,0,0,0.8); }
        .ad-container-global { position: relative; z-index: 10 !important; width: 320px; height: 50px; display: flex; justify-content: center; align-items: center; margin: 10px auto; background: rgba(0,0,0,0.4); border-radius: 4px; border: 1px dashed rgba(255,255,255,0.3); text-align: center; overflow: hidden; clear: both; }
        .sticky-ad-footer { position: fixed; bottom: calc(65px + env(safe-area-inset-bottom)); left: 0; right: 0; height: 50px; background: #000; z-index: 4999; display: flex; justify-content: center; align-items: center; border-top: 1px solid #333; }
    </style>
</head>
<body>

<div class="bottom-nav">
    <button class="nav-item active" onclick="switchTab('home')" id="nav-home">
        <i data-lucide="home" class="nav-icon"></i>
        <span class="nav-label">Home</span>
    </button>
    <button class="nav-item" onclick="switchTab('bingo')" id="nav-bingo">
        <i data-lucide="play-circle" class="nav-icon"></i>
        <span class="nav-label">Bingo</span>
    </button>
    <div class="nav-center" onclick="openPostCreator()">
        <div class="nav-icon-bg"><i data-lucide="plus" style="width:28px; height:28px;"></i></div>
    </div>
    <button class="nav-item" onclick="document.getElementById('storeModal').style.display='flex'" id="nav-store">
        <i data-lucide="shopping-bag" class="nav-icon"></i>
        <span class="nav-label">Store</span>
    </button>
    <button class="nav-item" onclick="openMyProfile()" id="nav-profile">
        <i data-lucide="user" class="nav-icon"></i>
        <span class="nav-label">Me</span>
    </button>
</div>

<div class="sticky-ad-footer">
    <script type="text/javascript">
        atOptions = { 'key' : 'a664bf7e7084386b4f4b428590030df3', 'format' : 'iframe', 'height' : 50, 'width' : 320, 'params' : {} };
    </script>
    <script type="text/javascript" src="https://pl28660496.effectivegatecpm.com/a6/64/bf/a664bf7e7084386b4f4b428590030df3.js"></script>
</div>
<div id="customPopupBanner">
    <div style="position:relative; max-width:400px; width:100%; animation: popScale 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);">
        <button onclick="closeCustomBanner()" style="position:absolute; top:-15px; right:-10px; background:linear-gradient(135deg, #ef4444, #b91c1c); color:white; border:2px solid white; border-radius:50%; width:36px; height:36px; font-weight:bold; cursor:pointer; z-index:10; display:flex; align-items:center; justify-content:center; box-shadow:0 4px 10px rgba(0,0,0,0.3);"><i data-lucide="x" style="width:20px"></i></button>
        <img id="customBannerImg" src="" style="width:100%; border-radius:20px; border:2px solid rgba(255,255,255,0.2); box-shadow:0 20px 50px rgba(0,0,0,0.8); cursor:pointer; object-fit:cover;" onclick="clickCustomBanner()">
    </div>
</div>

<div id="installGate">
    <div class="gate-logo">RB<span>LIVE</span></div>
    <div class="gate-title">Install to Play</div>
    <p class="gate-desc">To access the full Radio Bingo experience, you must install the official App.</p>
    <button id="gateInstallBtn" class="gate-btn-install" onclick="triggerInstall()">
        <i data-lucide="download-cloud" style="width:20px; height:20px;"></i> INSTALL APP
    </button>
    <div id="gateIosNote" class="gate-ios-note" style="display:none; margin-top:20px; background:rgba(255,255,255,0.1); padding:15px; border-radius:12px;">
        <div style="font-weight:800; color:white; margin-bottom:10px; text-transform:uppercase;">iOS Instructions:</div>
        <div style="font-size:12px; margin-bottom:5px;">1. Tap Share <i data-lucide="share" style="width:12px"></i></div>
        <div style="font-size:12px;">2. Add to Home Screen <i data-lucide="plus-square" style="width:12px"></i></div>
    </div>
</div>

<div id="notifBlocker">
    <div class="notif-gate-icon">
        <i data-lucide="bell-ring" style="width: 40px; height: 40px; color: #3b82f6;"></i>
    </div>
    <div class="notif-gate-title">ENABLE NOTIFICATIONS</div>
    <p class="notif-gate-desc">To ensure fairness and real-time updates for Bingo Calls, this app requires push notifications to be enabled.</p>
    <button onclick="requestGatePermission()" class="btn-allow-notif">
        <i data-lucide="check-circle" style="width:20px"></i> ALLOW NOTIFICATIONS
    </button>
    <div id="blockedHelp" class="blocked-help" style="display:none; margin-top:15px; font-size:12px; opacity:0.7;">
        Please reset site permissions in your browser settings.
    </div>
</div>

<div id="splash-screen">
    <div class="splash-logo">RB<span>LIVE</span></div>
    <div class="splash-loader"></div>
</div>

<div id="customToast">
    <i data-lucide="info" class="toast-icon"></i>
    <span class="toast-msg" id="toastMsg">Notification!</span>
</div>

<div id="customConfirmModal">
    <div class="conf-content" style="background:rgba(30,41,59,0.95); padding:20px; border-radius:20px; border:1px solid rgba(255,255,255,0.1); text-align:center;">
        <i data-lucide="alert-circle" style="width: 40px; height: 40px; color: var(--gold); margin-bottom: 15px;"></i>
        <h3 class="conf-title" id="confTitle" style="margin:0 0 10px 0; color:white;">Confirm Action</h3>
        <p class="conf-msg" id="confMsg" style="color:#cbd5e1; font-size:13px; margin-bottom:20px;">Are you sure you want to proceed?</p>
        <div class="conf-actions" style="display:flex; gap:10px;">
            <button class="btn-conf-no" onclick="closeCustomConfirm()" style="flex:1; padding:10px; background:rgba(255,255,255,0.1); color:white; border:none; border-radius:10px; cursor:pointer;">CANCEL</button>
            <button class="btn-conf-yes" id="confYesBtn" style="flex:1; padding:10px; background:var(--accent); color:white; border:none; border-radius:10px; font-weight:bold; cursor:pointer;">CONFIRM</button>
        </div>
    </div>
</div>

<div id="loginOverlay">
    <div class="login-bg-blob blob-1"></div>
    <div class="login-bg-blob blob-2"></div>
    <div class="login-app-container">
        <div class="app-logo-lg">RB<span>LIVE</span></div>
        <p class="app-tagline">The ultimate live bingo experience.<br>Play, Win, and Redeem Rewards.</p>
        <div class="promo-badge">
            <i data-lucide="gift" style="width:16px"></i> 
            <span>Register now & Get 500 Free RB Coins</span>
        </div>
        <div class="auth-btn-group">
            <button class="btn-main-auth" onclick="login()" style="width:100%; padding:15px; background:white; color:black; border:none; border-radius:30px; font-weight:bold; cursor:pointer; display:flex; align-items:center; justify-content:center; gap:10px;">
                <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/action/google.svg" alt="Google" style="width:20px">
                Sign in with Google
            </button>
        </div>
    </div>
</div>

<div class="nav">
    <div style="display:flex; align-items:center; gap:10px;">
        <span style="font-weight: 900; font-size: 20px; text-shadow: 0 2px 5px rgba(0,0,0,0.8);">RB <span style="color:var(--accent-glow)">LIVE</span></span>
    </div>
    <div id="userPanel" style="display:none; align-items: center; gap: 10px;">
        <div class="user-stats">
            <div class="icon-btn" onclick="openSearch()">
                <i data-lucide="search" style="width:20px"></i>
            </div>
            <div class="icon-btn" onclick="openMessenger()">
                <i data-lucide="message-circle" style="width:20px"></i>
                <span id="pmBadge" class="notif-badge"></span>
            </div>
            <div class="icon-btn" onclick="openNotifs()">
                <i data-lucide="bell" style="width:20px"></i>
                <span id="notifDot" class="notif-badge"></span>
            </div>
            <div class="points-badge" onclick="document.getElementById('storeModal').style.display='flex'">
                <i data-lucide="coins" style="width:18px"></i> <span id="userPoints">0</span>
            </div>
        </div>
        
        <div class="avatar-frame" onclick="openMenuModal()">
            <img id="userImg" src="" style="width: 40px; height: 40px; border-radius: 50%; border: 2px solid var(--accent);">
            </div>
    </div>
</div>

<div class="disclaimer-modern">
    <div class="disclaimer-badge">NOTICE</div>
    <div class="disclaimer-text">Hindi ito gambling site. For entertainment purposes lamang.</div>
</div>

<div class="container">
    <div class="ad-container-global">
        <script type="text/javascript">
            atOptions = { 'key' : '9bf585b6ee39cb9b515e2fae1fa958c2', 'format' : 'iframe', 'height' : 50, 'width' : 320, 'params' : {} };
        </script>
        <script type="text/javascript" src="https://pl28660488.effectivegatecpm.com/9b/f5/85/9bf585b6ee39cb9b515e2fae1fa958c2.js"></script>
    </div>

    <div id="view-home" style="display:block;">
        <div id="friendRequestsSection"></div>
        
        <div class="post-creator-modern" id="mainPostCreator">
            <h4 style="margin:0; color:white; font-size:16px; font-weight:800; display:flex; align-items:center; gap:8px;">
                <i data-lucide="edit-3" style="width:16px; color:var(--accent-glow);"></i> Create Post
            </h4>
            
            <textarea id="postInput" class="post-input-modern" placeholder="What's on your mind?"></textarea>
            
            <div class="image-preview-container" id="imgPreviewCont" style="display:none; position:relative; margin-bottom:10px;">
                <img id="postImgPreview" class="image-preview-img" style="max-height:150px; border-radius:10px;">
                <div class="btn-remove-img" onclick="removePostImage()" style="position:absolute; top:5px; right:5px; background:red; color:white; padding:5px; border-radius:50%; cursor:pointer;">
                    <i data-lucide="x" style="width:12px;"></i>
                </div>
            </div>

            <div class="mood-selector">
                <div class="mood-chip" onclick="selectMood(this, 'Happy')">üòä Happy</div>
                <div class="mood-chip" onclick="selectMood(this, 'Sad')">üòî Sad</div>
                <div class="mood-chip" onclick="selectMood(this, 'Excited')">ü§© Excited</div>
                <div class="mood-chip" onclick="selectMood(this, 'Cool')">üòé Cool</div>
                <div class="mood-chip" onclick="selectMood(this, 'Angry')">üò° Angry</div>
                <div class="mood-chip" onclick="selectMood(this, 'Lucky')">üçÄ Lucky</div>
            </div>

            <div class="post-tools">
                <label for="postImgInput" class="tool-btn photo-tool">
                    <i data-lucide="image" style="width:16px;"></i> Photo
                </label>
                <input type="file" id="postImgInput" accept="image/*" style="display:none" onchange="handlePostImage(this)">
                
                <button class="btn-post-modern" onclick="createPost()">POST</button>
            </div>
        </div>

        <div id="pymkSection" class="pymk-section" style="display:none;">
            <div class="pymk-title">People You May Know</div>
            <div class="pymk-scroll" id="pymkList"></div>
        </div>

        <div id="socialFeed" class="social-feed-container">
            <div style="text-align:center; padding:20px; opacity:0.5;">Loading Feed...</div>
        </div>
    </div>

    <div id="view-bingo" style="display:none;">
        <div class="video-feed-wrapper">
            <div class="video-container">
                <div class="video-overlay-bl"><i data-lucide="users" style="width:14px"></i><span id="onlineCount">0</span> ONLINE</div>
                <div id="videoOfflineState" style="display:none; position:absolute; inset:0; background:#0f172a; flex-direction:column; align-items:center; justify-content:center; z-index:20;">
                    <div style="width:60px; height:60px; background:rgba(255,255,255,0.05); border-radius:50%; display:flex; align-items:center; justify-content:center; margin-bottom:15px; animation:pulse-ring 2s infinite;">
                        <i data-lucide="radio" style="width:30px; height:30px; color:#94a3b8;"></i>
                    </div>
                    <h3 style="margin:0; font-size:16px; font-weight:900; color:white; letter-spacing:1px;">WAITING FOR LIVE</h3>
                    <p style="margin:5px 0 0; font-size:12px; color:#64748b;">Stand by for the next draw.</p>
                </div>
                <iframe id="liveVideoFrame" width="100%" height="100%" src="https://www.youtube.com/embed/4I_NSJTbdXo?autoplay=1&mute=1" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" referrerpolicy="strict-origin-when-cross-origin" allowfullscreen style="border:none; position:absolute; top:0; left:0; width:100%; height:100%;"></iframe>
            </div>
        </div>

        <div id="jackpotBanner">
            <div class="jp-label-new">
                <i data-lucide="crown" style="width: 16px;"></i> JACKPOT ROUND <i data-lucide="crown" style="width: 16px;"></i>
            </div>
            <span class="jackpot-amount" id="jackpotDisplayVal">5,000</span>
            <div style="font-size: 10px; opacity: 0.7; margin-top: 5px; color: #fbbf24;">RB COINS GRAND PRIZE</div>
        </div>

        <div id="nextDrawBanner" class="next-draw-container">
            <div class="nd-icon"><i data-lucide="calendar-days"></i></div>
            <div class="nd-info">
                <div class="next-draw-label">Susunod na Bola</div>
                <div id="nextDrawTime" class="next-draw-time">--:-- --</div>
            </div>
        </div>
        
        <div id="winnerBanner">
            <span><i data-lucide="party-popper" style="width:24px; height:24px;"></i> BINGO WINNER!</span>
            <span class="winner-line" id="winnerPatternLine">Pattern: Normal Bingo</span>
        </div>

        <div class="draw-panel">
            <div class="prev-balls" id="ballRow"></div>
            <div class="current-ball-box"><span style="font-size:9px; font-weight:800; opacity:0.8; color:white;">NOW DRAWN</span><span id="currentBall" style="font-size:36px; font-weight:900; color:white; text-shadow:0 2px 10px rgba(0,0,0,0.5);">--</span></div>
        </div>
        
        <div class="card" id="bingoCardContainer">
            <div id="lateOverlay" class="late-overlay">
                <i data-lucide="lock" style="color:var(--danger); width:48px; height:48px; margin-bottom:15px; filter: drop-shadow(0 0 10px var(--danger));"></i>
                <div class="late-text">GAME ONGOING</div>
                <div class="late-subtext">Sorry, ongoing na ang bola. Bawal na sumali ang late.</div>
                <div style="margin-top:20px; background:rgba(255,255,255,0.1); padding:10px 20px; border-radius:12px; border:1px solid rgba(255,255,255,0.1);">
                    <span style="font-size:10px; display:block; opacity:0.7;">NEXT GAME:</span>
                    <strong id="lateNextSched" style="font-size:16px; color:var(--gold);">--:--</strong>
                </div>
            </div>
            <div id="gameOverOverlay" class="game-over-overlay">
                <i data-lucide="trophy" style="color:var(--gold); width:50px; height:50px; margin-bottom:15px; filter: drop-shadow(0 0 15px var(--gold));"></i>
                <div class="late-text">Game Finished</div>
                <div class="late-subtext" id="gameOverMsg">Better luck next time!</div>
            </div>
            <div class="change-card-wrapper" style="display:flex; justify-content:space-between; align-items:center; padding-bottom:15px;">
                <div class="pattern-box">
                    <div class="pattern-dot"></div>
                    <span class="pattern-text" id="patternName">Normal Bingo</span>
                </div>
                <button class="btn-change" id="newCardBtn" onclick="generateNewCard()"><i data-lucide="refresh-cw" style="width:14px"></i> NEW CARD</button>
            </div>
            <div class="bingo-header"><div class="letter">B</div><div class="letter">I</div><div class="letter">N</div><div class="letter">G</div><div class="letter">O</div></div>
            <div class="grid" id="bingoGrid"></div>
        </div>
        
        <div class="chat-box" style="margin-top:15px;">
            <div class="chat-header">
                <i data-lucide="message-square" style="width:18px; color:var(--accent-glow)"></i>
                <h3>LIVE STREAM CHAT</h3>
            </div>
            <div id="chatList"></div>
            <div id="replyIndicator" class="reply-indicator" style="display:none; padding: 5px 15px; background: #374151; color: #d1d5db; font-size: 11px;">
                <span id="replyText">Replying to...</span>
                <button onclick="cancelReply()" style="background:none; border:none; color:white; cursor:pointer;"><i data-lucide="x" style="width:14px"></i></button>
            </div>
            <div class="chat-input-area">
                <form class="input-wrapper" onsubmit="event.preventDefault(); sendChat();">
                    <input type="text" id="chatIn" placeholder="Say something..." autocomplete="off">
                    <button type="submit" class="send-btn">
                        <i data-lucide="send" style="width:16px"></i>
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>

<div id="grandJackpotModal" onclick="this.style.display='none'">
    <div class="jackpot-rays"></div>
    <div class="jackpot-content">
        <div class="icon-glow"><i data-lucide="crown" style="width: 80px; height: 80px;"></i></div>
        <h1 class="jp-title">JACKPOT WIN!</h1>
        <h2 class="jp-amount" id="grandPrizeAmount">10,000 RB COINS</h2>
        <div class="jp-name" id="jpWinnerName">WINNER NAME</div>
        <p style="font-size: 11px; color: white; opacity: 0.7; margin-top: 20px;">Tap anywhere to close</p>
    </div>
</div>

<div id="pmModal" class="pm-modal">
    <div class="pm-container">
        <div id="pmInboxView" style="display:flex; flex-direction:column; height:100%;">
            <div class="pm-header">
                <div style="display:flex; align-items:center; gap:10px;">
                    <h3>Chats</h3>
                    <button class="group-create-btn" onclick="toggleGroupCreate()">+ Group</button>
                </div>
                <button onclick="document.getElementById('pmModal').style.display='none'" style="background:rgba(255,255,255,0.1); border:none; width:30px; height:30px; border-radius:50%; color:white; display:flex; align-items:center; justify-content:center;"><i data-lucide="x" style="width:16px;"></i></button>
            </div>
            
            <div id="groupCreateUI" class="group-create-section" style="display:none;">
                <input type="text" id="groupNameInput" class="group-name-input" placeholder="Group Name">
                <div style="font-size:10px; color:#94a3b8; margin-bottom:5px;">Select Friends:</div>
                <div id="groupFriendSelect" class="friend-select-list"></div>
                <button class="btn-create-group-confirm" onclick="createGroupChat()">CREATE GROUP</button>
            </div>

            <div class="active-friends-bar" id="activeFriendsBar"></div>
            <div id="pmList" class="pm-inbox-list"></div>
        </div>
        
        <div id="pmChatView" class="pm-chat-view">
            <div class="pm-chat-header">
                <button onclick="backToInbox()" style="background:none; border:none; color:var(--messenger-blue);"><i data-lucide="arrow-left"></i></button>
                <div style="display:flex; align-items:center;">
                     <img id="chatTargetImg" style="width:36px; height:36px; border-radius:50%; margin-left:5px;">
                     <div style="display:flex; flex-direction:column; margin-left:10px;">
                        <span id="chatTargetName" style="font-weight:700; font-size:15px; color:white;">User</span>
                        <span style="font-size:11px; color:#b0b3b8;">Active now</span>
                     </div>
                </div>
            </div>
            <div id="pmMessages" class="pm-messages"></div>
            
            <div class="pm-footer-modern">
                <label for="pmImgInput" class="pm-attach-btn">
                    <i data-lucide="image" style="width:24px;"></i>
                </label>
                <input type="file" id="pmImgInput" accept="image/*" style="display:none" onchange="handlePmImage(this)">
                
                <form onsubmit="event.preventDefault(); sendPrivateMessage();" style="flex:1; display:flex; gap:10px;">
                    <input type="text" id="pmInput" class="pm-styled-input" placeholder="Type a message..." autocomplete="off">
                    <button type="submit" style="background:none; border:none; color:var(--messenger-blue); cursor:pointer;"><i data-lucide="send" style="width:24px"></i></button>
                </form>
            </div>
            <div id="pmImgPreviewCont" style="padding:10px; background:#0f172a; display:none;">
                <span style="font-size:10px; color:var(--accent-glow);">Image attached</span>
            </div>
        </div>
    </div>
</div>

<div id="notifModal" class="modal" onclick="this.style.display='none'">
    <div class="modal-content" onclick="event.stopPropagation()">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px; border-bottom:1px solid rgba(255,255,255,0.1); padding-bottom:15px;">
            <div style="display:flex; align-items:center; gap:10px;">
                <div style="background:rgba(255,255,255,0.1); padding:8px; border-radius:10px;"><i data-lucide="bell" style="width:20px;"></i></div>
                <h3 style="margin:0; font-size:18px;">Notifications</h3>
            </div>
            <button onclick="document.getElementById('notifModal').style.display='none'" style="background:none; border:none; color:white;"><i data-lucide="x"></i></button>
        </div>
        <div id="notifList"></div>
    </div>
</div>

<div id="userOptionsModal" class="modal" onclick="this.style.display='none'">
    <div class="modal-content" onclick="event.stopPropagation()" style="text-align:center;">
        <img id="optUserImg" style="width:60px; height:60px; border-radius:50%; border:2px solid var(--accent); margin-bottom:10px;">
        <h3 id="optUserName" style="margin:0 0 20px 0; color:white;">User</h3>
        
        <button class="user-opt-btn" onclick="openUserProfile(targetUserForOpt.uid)"><i data-lucide="user"></i> View Profile</button>
        <button class="user-opt-btn" onclick="optAddFriend()"><i data-lucide="user-plus"></i> Add Friend</button>
        <button class="user-opt-btn" onclick="optSendMessage()"><i data-lucide="message-circle"></i> Send Message</button>
        <button class="user-opt-btn" onclick="document.getElementById('userOptionsModal').style.display='none'"><i data-lucide="x"></i> Close</button>
    </div>
</div>

<div id="commentModalBackdrop" class="comment-modal-backdrop" onclick="closeComments()"></div>
<div id="commentModal" class="comment-modal">
    <div class="comment-header">
        <h3 style="margin:0; font-size:16px;">Comments</h3>
        <button onclick="closeComments()" style="background:none; border:none; color:white;"><i data-lucide="x"></i></button>
    </div>
    <div id="commentList" class="comment-list"></div>
    <form class="comment-input-area" onsubmit="event.preventDefault(); sendComment();">
        <input type="text" id="commentInput" class="comment-input" placeholder="Write a comment..." autocomplete="off">
        <button type="submit" style="background:none; border:none; color:var(--accent);"><i data-lucide="send"></i></button>
    </form>
</div>

<div id="searchModal" class="search-modal-container">
    <div class="search-header">
        <button onclick="document.getElementById('searchModal').style.display='none'" style="background:none; border:none; color:white;"><i data-lucide="arrow-left"></i></button>
        <div class="search-bar-wrap">
            <i data-lucide="search" style="width:16px; opacity:0.5;"></i>
            <input type="text" id="searchInput" class="search-input" placeholder="Search users or posts..." onkeyup="handleSearch()">
        </div>
    </div>
    <div id="searchResults" class="search-results">
        <div style="text-align:center; opacity:0.5; padding:20px;">Type to search...</div>
    </div>
</div>

<div id="userProfilePage" class="profile-page-container">
    <button class="profile-nav-back" onclick="closeProfilePage()">
        <i data-lucide="arrow-left"></i>
    </button>
    
    <div class="profile-cover" id="pageProfileCover"></div>
    
    <div class="profile-info-section">
        <div class="profile-avatar-container">
             <div class="profile-rank-ring"></div>
             <img id="pageProfileImg" class="profile-page-img" src="">
             <div id="pageProfileBadge" class="profile-badge-overlay" style="display:none;">
                 <i data-lucide="badge-check" style="width:16px; color:inherit;"></i>
             </div>
        </div>
        
        <h2 id="pageProfileName" class="profile-page-name">User Name</h2>
        <p id="pageProfileBio" class="profile-page-bio">Radio Bingo Player</p>
        
        <button id="profileMainActionBtn" class="profile-action-btn" onclick="handleProfileMainAction()">Add Friend</button>
        
        <button id="unfriendBtn" class="btn-unfriend-modern" style="display:none; width:250px; margin-bottom:15px;" onclick="unfriendUser()">
            <i data-lucide="user-x" style="width:14px"></i> Unfriend
        </button>
        
        <div class="profile-stats-card">
            <div class="stat-item">
                <span class="stat-val" id="statFriends">0</span>
                <span class="stat-lbl"><i data-lucide="users" style="width:12px; vertical-align:middle;"></i> Friends</span>
            </div>
            <div class="stat-item">
                <span class="stat-val" id="statLikes">0</span>
                <span class="stat-lbl"><i data-lucide="heart" style="width:12px; vertical-align:middle;"></i> Likes</span>
            </div>
             <div class="stat-item">
                <span class="stat-val" id="statPosts">0</span>
                <span class="stat-lbl"><i data-lucide="image" style="width:12px; vertical-align:middle;"></i> Posts</span>
            </div>
        </div>
        
        <div id="pageProfileFeed" class="profile-feed-section"></div>
    </div>
</div>
<div id="editProfileModal" class="modal" onclick="this.style.display='none'">
    <div class="modal-content" onclick="event.stopPropagation()">
        <h3 style="margin-top:0; color:white;">Edit Profile</h3>
        
        <label class="edit-label">Display Name</label>
        <input type="text" id="editNameIn" class="edit-input" placeholder="Your Name">
        
        <label class="edit-label">Bio</label>
        <input type="text" id="editBioIn" class="edit-input" placeholder="Short bio...">
        
        <label class="edit-label">Change Profile Picture</label>
        <input type="file" id="editProfilePicInput" class="edit-input" accept="image/*" onchange="handleProfileUpload(this, 'pfp')">
        
        <label class="edit-label">Change Cover Photo</label>
        <input type="file" id="editCoverPicInput" class="edit-input" accept="image/*" onchange="handleProfileUpload(this, 'cover')">

        <button onclick="saveProfileChanges()" style="width:100%; padding:15px; background:var(--accent); border:none; border-radius:12px; font-weight:900; color:white; cursor:pointer;">SAVE CHANGES</button>
    </div>
</div>

<div id="installGuideModal" class="modal" onclick="this.style.display='none'">
    <div class="modal-content" onclick="event.stopPropagation()">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
            <h3 style="margin:0; font-size:18px; font-weight:900;">INSTALL GUIDE</h3>
            <button onclick="document.getElementById('installGuideModal').style.display='none'" style="background:none; border:none; color:white;"><i data-lucide="x"></i></button>
        </div>
        <div class="install-tabs">
            <button class="install-tab-btn active" id="tabAndroid" onclick="showGuide('android')">ANDROID</button>
            <button class="install-tab-btn" id="tabIOS" onclick="showGuide('ios')">iOS</button>
        </div>
        <div id="guideAndroidContent">
            <div class="guide-step"><div class="step-num">1</div><div class="step-text">Click <b>Three Dots (‚ãÆ)</b> in Chrome.</div></div>
            <div class="guide-step"><div class="step-num">2</div><div class="step-text">Tap <b>"Install App"</b> or <b>"Add to Home Screen"</b>.</div></div>
        </div>
        <div id="guideIOSContent" style="display:none;">
            <div class="guide-step"><div class="step-num">1</div><div class="step-text">Tap <b>Share Icon</b> <i data-lucide="share" style="width:12px"></i> in Safari.</div></div>
            <div class="guide-step"><div class="step-num">2</div><div class="step-text">Scroll down & tap <b>"Add to Home Screen"</b>.</div></div>
        </div>
    </div>
</div>

<div id="menuModal" class="modal" onclick="this.style.display='none'">
    <div class="modal-content" onclick="event.stopPropagation()">
        <div class="profile-header">
            <img id="profileImgLarge" class="profile-img-large" src="">
            <div class="profile-name-info">
                <h2 class="profile-name" id="profileNameDisplay">User Name</h2>
                <span class="profile-uid" id="profileUidDisplay">UID: ---</span>
            </div>
            <button onclick="document.getElementById('menuModal').style.display='none'" style="background:none; border:none; color:white; opacity:0.5;"><i data-lucide="x"></i></button>
        </div>
        <div class="gcash-section">
            <span style="font-size:10px; font-weight:800; color:var(--accent-glow); text-transform:uppercase; margin-bottom:10px; display:flex; align-items:center; gap:5px;"><i data-lucide="credit-card" style="width:12px"></i> Email / Redemption Info</span>
            <div style="display:flex; gap:10px;">
                <input type="text" id="gcashInput" class="styled-input" placeholder="Enter email or details">
                <button onclick="saveGcash(); playSound('click');" style="background:var(--accent); border:none; color:white; padding:0 20px; border-radius:12px; font-weight:800; font-size:12px; cursor:pointer; box-shadow:0 4px 10px rgba(59, 130, 246, 0.3);">SAVE</button>
            </div>
        </div>
        <div class="ref-container">
            <span style="font-size:10px; font-weight:800; color:var(--success); text-transform:uppercase; margin-bottom:10px; display:flex; align-items:center; gap:5px;"><i data-lucide="share-2" style="width:12px"></i> Invite & Earn</span>
            <input type="text" id="refLink" readonly class="styled-input" style="background:rgba(0,0,0,0.2); text-align:center; cursor:pointer; margin-bottom:10px;" onclick="this.select(); document.execCommand('copy'); showToast('Copied Link!'); playSound('click');">
            <div id="referralInputSection">
                <span style="font-size:10px; font-weight:800; color:var(--gold); text-transform:uppercase; margin-bottom:10px; display:flex; align-items:center; gap:5px; margin-top:15px;"><i data-lucide="ticket" style="width:12px"></i> Claim Referral Code</span>
                <div style="display:flex; gap:10px;">
                    <input type="text" id="referralInput" class="styled-input" placeholder="ENTER CODE">
                    <button onclick="claimReferral(); playSound('click');" style="background:var(--gold); border:none; color:black; padding:0 20px; border-radius:12px; font-weight:800; font-size:12px; cursor:pointer; box-shadow:0 4px 10px rgba(251, 191, 36, 0.3);">CLAIM</button>
                </div>
            </div>
        </div>
        <div class="history-box">
            <span style="font-size:10px; font-weight:800; color:white; text-transform:uppercase; margin-bottom:10px; display:flex; align-items:center; gap:5px;"><i data-lucide="history" style="width:12px"></i> Transaction History</span>
            <div id="historyList" class="history-list"></div>
        </div>
        
        <button onclick="auth.signOut().then(()=>location.reload())" style="width:100%; padding:14px; background:rgba(239, 68, 68, 0.1); color:var(--danger); border:1px solid rgba(239, 68, 68, 0.2); border-radius:14px; font-weight:800; margin-top:20px; cursor:pointer; display:flex; align-items:center; justify-content:center; gap:8px;">
            <i data-lucide="log-out" style="width:18px"></i> Sign Out
        </button>
    </div>
</div>

<div id="storeModal" class="modal" onclick="this.style.display='none'">
    <div class="modal-content" onclick="event.stopPropagation()">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px; border-bottom: 1px solid rgba(255,255,255,0.05); padding-bottom: 15px;">
            <div>
                <h3 style="margin:0; font-size: 20px; font-weight: 900;">MARKETPLACE</h3>
                <p style="margin: 5px 0 0 0; font-size: 11px; opacity: 0.8; font-weight: 600;">Redeem, Shop Skins, or Earn</p>
            </div>
            <div class="points-badge" style="height:35px; border-radius: 10px;"><i data-lucide="coins" style="width:14px"></i> <span id="storePoints">0</span></div>
        </div>
        <div class="store-nav">
            <button class="store-tab-btn active" onclick="switchStoreTab('cashout')" id="tabBtnCash">Cash Out</button>
            <button class="store-tab-btn" onclick="switchStoreTab('skins')" id="tabBtnSkins">Skins</button>
            <button class="store-tab-btn" onclick="switchStoreTab('earn')" id="tabBtnEarn" style="color:var(--gold);">Tasks</button>
        </div>
        <div class="glass-panel" style="padding: 15px; border-radius: 18px; margin-bottom: 20px; border: 1px dashed var(--gold); text-align: center; position: relative; overflow: hidden;">
            <h4 style="margin: 0 0 10px 0; color: var(--gold); font-size: 14px; text-transform: uppercase;">‚ö° FREE RB COINS ‚ö°</h4>
            <div id="adTimerOverlay" style="display: none; position: absolute; inset: 0; background: rgba(15, 23, 42, 0.98); z-index: 50; align-items: center; justify-content: center; flex-direction: column;">
                <div id="adStatusIcon" style="font-size: 30px; margin-bottom: 10px;">üì∫</div>
                <div style="font-size: 18px; font-weight: 900; color: white;" id="adCountdown">30s</div>
                <div style="font-size: 12px; color: #ef4444; padding: 0 20px; margin-top: 5px; font-weight:800;" id="adStatusText">Do not close app or switch tabs!</div>
            </div>
            <div id="adCaptchaOverlay" style="display: none; position: absolute; inset: 0; background: rgba(15, 23, 42, 0.98); z-index: 51; align-items: center; justify-content: center; flex-direction: column;">
                <div style="font-size: 14px; font-weight: 700; color: var(--accent-glow); margin-bottom: 10px;">HUMAN VERIFICATION</div>
                <div style="background: rgba(255,255,255,0.1); padding: 10px; border-radius: 12px; margin-bottom: 10px;">
                    <span id="mathQ" style="font-size: 20px; font-weight: 900; color: white;">5 + 3 = ?</span>
                </div>
                <div style="display: flex; gap: 5px;">
                    <input type="number" id="mathAns" style="width: 60px; padding: 8px; border-radius: 8px; border: 1px solid var(--accent); background: #0f172a; color: white; text-align: center; font-weight: 800;">
                    <button onclick="verifyAdMath()" style="background: var(--success); border: none; padding: 8px 12px; border-radius: 8px; color: white; font-weight: 900;">OK</button>
                </div>
            </div>
            <button id="btnWatchAd" onclick="startStrictWatch()" style="background: linear-gradient(135deg, #f59e0b, #b45309); width: 100%; border: none; padding: 15px; border-radius: 12px; font-weight: 900; color: white; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 10px; font-size: 14px; box-shadow: 0 5px 15px rgba(245, 158, 11, 0.4); text-shadow: 0 1px 2px black;">
                <i data-lucide="play-circle" style="width: 20px;"></i> WATCH AD (+50 Coins)
            </button>
        </div>

        <div id="storeSection-cashout" style="display:block;">
            <div class="reward-grid">
                <div class="reward-item">
                    <div class="reward-main"><div class="reward-icon-box"><i data-lucide="gift" style="width:22px"></i></div><div class="reward-info"><b>‚Ç±20 Gift Card</b><small><i data-lucide="database" style="width:10px"></i> 50,000 Coins</small></div></div>
                    <button class="btn-redeem" onclick="redeemItem('‚Ç±20 Gift Card', 50000)">Redeem</button>
                </div>
                <div class="reward-item">
                    <div class="reward-main"><div class="reward-icon-box" style="color:var(--gold); background:rgba(251, 191, 36, 0.1); border-color:rgba(251, 191, 36, 0.3);"><i data-lucide="gift" style="width:22px"></i></div><div class="reward-info"><b>‚Ç±50 Gift Card</b><small><i data-lucide="database" style="width:10px"></i> 125,000 Coins</small></div></div>
                    <button class="btn-redeem" onclick="redeemItem('‚Ç±50 Gift Card', 125000)">Redeem</button>
                </div>
                <div class="reward-item">
                    <div class="reward-main"><div class="reward-icon-box" style="color:var(--success); background:rgba(16, 185, 129, 0.1); border-color:rgba(16, 185, 129, 0.3);"><i data-lucide="gift" style="width:22px"></i></div><div class="reward-info"><b>‚Ç±100 Gift Card</b><small><i data-lucide="database" style="width:10px"></i> 250,000 Coins</small></div></div>
                    <button class="btn-redeem" onclick="redeemItem('‚Ç±100 Gift Card', 250000)">Redeem</button>
                </div>
            </div>
            <p style="text-align: center; font-size: 10px; opacity: 0.6; margin-top: 25px; line-height: 1.5; text-shadow:0 1px 2px black;">*Processing may take 24-48 hours.<br>Make sure your redemption details are correct.</p>
        </div>

        <div id="storeSection-skins" style="display:none;">
            <p style="font-size:11px; opacity:0.7; margin-bottom:15px; text-align:center;">Customize your Bingo Card.</p>
            <div style="margin-bottom:20px; padding:15px; background:rgba(255,255,255,0.05); border-radius:12px; text-align:center;">
                <label style="font-size:12px; font-weight:700; display:block; margin-bottom:10px; color:var(--accent-glow);">UPLOAD CUSTOM BACKGROUND</label>
                <input type="file" accept="image/*" id="customSkinInput" style="display:none" onchange="handleCustomSkinUpload(this)">
                <button onclick="document.getElementById('customSkinInput').click()" style="background:var(--accent); color:white; border:none; padding:8px 15px; border-radius:8px; font-weight:800; font-size:11px; cursor:pointer;">CHOOSE IMAGE</button>
            </div>
            <div class="skins-grid">
                <div class="skin-item"><div class="skin-preview" style="background:rgba(30,41,59,0.8); border:1px solid rgba(255,255,255,0.1);">B</div><div class="skin-name">Classic</div><div class="skin-cost">Free</div><button class="btn-buy-skin equip" id="btn-skin-default" onclick="equipSkin('default')">EQUIP</button></div>
                <div class="skin-item"><div class="skin-preview" style="background:linear-gradient(135deg, #451a03, #000); border:2px solid #f59e0b; color:#fcd34d;">B</div><div class="skin-name">Luxury Gold</div><div class="skin-cost">100,000 Coins</div><button class="btn-buy-skin buy" id="btn-skin-gold" onclick="buyOrEquipSkin('gold', 100000)">BUY</button></div>
                <div class="skin-item" id="customSkinSlot" style="display:none;"><div class="skin-preview" id="customSkinPreview" style="background-size:cover;">B</div><div class="skin-name">My Custom</div><div class="skin-cost">Owned</div><button class="btn-buy-skin equip" id="btn-skin-custom" onclick="equipSkin('custom')">EQUIP</button></div>
            </div>
        </div>
        <div id="storeSection-earn" style="display:none;">
            <div class="task-list">
                <div class="task-item" style="border-color: #ef4444; background: linear-gradient(90deg, rgba(69,10,10,0.8), rgba(15,23,42,0.8));">
                    <div class="task-info"><h4 style="color:#fca5a5;">Watch Video Task</h4><p>Watch full video to unlock reward</p><span class="task-reward" style="background: rgba(239,68,68,0.2); border-color:#ef4444; color:#fca5a5;">+2,000 Coins</span></div>
                    <button class="btn-do-task" style="background:#ef4444;" id="btn-task-video" onclick="openVideoLocker('video')">WATCH</button>
                </div>
            </div>
        </div>
    </div>
</div>

<div id="pwaInstallBanner">
    <div><span class="pwa-text">INSTALL APP</span><span class="pwa-sub">Download for better experience!</span></div>
    <button id="pwaBottomBtn" class="pwa-btn">INSTALL</button>
</div>

<script>
    // === 1. GLOBAL & INITIALIZATION ===
    window.addEventListener('load', () => { setTimeout(hideSplash, 2000); checkNotifGate(); checkInstallGate(); initBannerListener(); loadSocialFeed(); loadPYMK(); loadCustomSkin(); });
    setTimeout(hideSplash, 5000);
    function hideSplash() { const ss = document.getElementById('splash-screen'); if(ss && ss.style.display !== 'none') { ss.style.opacity = '0'; setTimeout(() => ss.style.display = 'none', 800); } }

    function showToast(msg) { const toast = document.getElementById('customToast'); document.getElementById('toastMsg').innerText = msg; toast.classList.add('show'); playSound('click'); setTimeout(() => { toast.classList.remove('show'); }, 3000); }
    function playSound(type) { /* Simplified for brevity */ }

    // Firebase Init
    const firebaseConfig = { apiKey: "AIzaSyDIAQXJ15atKJxu7PtcFL1W9JnO1N14pVs", authDomain: "radiobingo-9ac29.firebaseapp.com", databaseURL: "https://radiobingo-9ac29-default-rtdb.asia-southeast1.firebasedatabase.app", projectId: "radiobingo-9ac29", storageBucket: "radiobingo-9ac29.firebasestorage.app", messagingSenderId: "965903993397", appId: "1:965903993397:web:f6646fa05225f147eebf7c" };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database(); const auth = firebase.auth();
    let messaging; try { messaging = firebase.messaging(); } catch(e) { console.log("Messaging failed to init", e); }
    let userData = {}; 
    let reactionsMap = {}; // Local Cache for reaction icons

    // === 2. RANKING ALGORITHM (TRENDING) ===
    function calculateTrendingScore(post) {
        // Algorithm: Score = (Likes * 2) + (Comments * 3) + (Decay based on time)
        const NOW = Date.now();
        const HOURS_SINCE = (NOW - post.timestamp) / (1000 * 60 * 60);
        
        // Decay factor: Recent posts (under 24h) get boosted. Older posts lose score.
        const decay = Math.max(1, HOURS_SINCE);
        
        // Comments count needs to be fetched or stored in post object. 
        // Assuming post.commentsCount is maintained by a cloud function or client update.
        const comments = post.commentsCount || 0;
        const likes = post.likes || 0;
        
        const score = ((likes * 2) + (comments * 3)) / Math.pow(decay, 1.5);
        return score;
    }

    // === 3. REAL BADGE LOGIC ===
    function renderAvatarBadge(containerId, points) {
        const container = document.getElementById(containerId);
        if(!container) return;
        
        // Remove existing badge
        const oldBadge = container.querySelector('.badge-overlay');
        if(oldBadge) oldBadge.remove();

        let badgeClass = "badge-bronze";
        let icon = "shield";

        if(points >= 100000) { badgeClass = "badge-diamond"; icon = "gem"; }
        else if(points >= 50000) { badgeClass = "badge-platinum"; icon = "crown"; }
        else if(points >= 25000) { badgeClass = "badge-gold"; icon = "star"; }
        else if(points >= 10000) { badgeClass = "badge-silver"; icon = "shield-check"; }

        // Inject HTML
        const badgeDiv = document.createElement('div');
        badgeDiv.className = `badge-overlay ${badgeClass}`;
        badgeDiv.innerHTML = `<i data-lucide="${icon}" style="width:10px; height:10px;"></i>`;
        
        container.appendChild(badgeDiv);
        lucide.createIcons();
    }

    // === 4. AUTH & USER DATA LISTENER ===
    auth.onAuthStateChanged(u => {
        if(u) {
            document.getElementById('loginOverlay').style.display = 'none'; 
            document.getElementById('userPanel').style.display = 'flex';
            document.getElementById('userImg').src = u.photoURL;
            document.getElementById('profileImgLarge').src = u.photoURL;

            // Load User Data
            db.ref('users/'+u.uid).on('value', s => { 
                if(s.exists()){ 
                    userData = s.val(); userData.uid = u.uid; 
                    document.getElementById('userPoints').innerText = (userData.points || 0).toLocaleString(); 
                    document.getElementById('storePoints').innerText = (userData.points || 0).toLocaleString(); 
                    
                    // Render Real Badge on Header
                    renderAvatarBadge('userPanel', userData.points || 0); 
                    
                    // Render Real Badge on Profile Modal
                    renderAvatarBadge('pageProfileBadge', userData.points || 0);
                    
                    // Other init
                    initBingo(); 
                    listenNotifications(u.uid); 
                    listenPrivateMessages(u.uid);
                    initSocialSystem(u.uid);
                } 
            });
        } else { document.getElementById('loginOverlay').style.display = 'flex'; }
    });

    // === 5. CLICKABLE NOTIFICATIONS ===
    function renderNotifs() { 
        const list = document.getElementById('notifList'); 
        db.ref('notifications/' + auth.currentUser.uid).once('value', s => { 
            list.innerHTML = ""; 
            const notifs = [];
            s.forEach(n => notifs.push({ key: n.key, ...n.val() }));
            
            notifs.sort((a,b) => b.time - a.time);

            if(notifs.length === 0) {
                list.innerHTML = "<div style='text-align:center; opacity:0.5; padding:40px;'>No new notifications</div>";
                return;
            }

            notifs.forEach(val => {
                const div = document.createElement('div');
                div.className = 'notif-card-new';
                
                // Click Logic: Go to Post or Profile
                div.onclick = () => {
                    if(val.type === 'like' || val.type === 'comment' || val.type === 'reaction') {
                        // Assuming the notification data stores postKey if available, else find it
                        // For this implementation, we need to ensure postKey is saved in notif
                        if(val.postKey) {
                            openSinglePostModal(val.postKey);
                        } else {
                            // Fallback to profile
                            openUserProfile(val.from);
                        }
                    } else if (val.type === 'pm') {
                        openPrivateChat(val.from, "User", ""); // Data should be fetched real-time
                    }
                    // Mark as read or delete? Optional.
                };

                // Image Logic
                let imgHtml = '';
                if(val.image) {
                     imgHtml = `<img src="${val.image}" class="notif-img">`;
                } else {
                     // Fetch user photo if 'from' exists
                     imgHtml = `<div style="width:40px; height:40px; background:#334155; border-radius:50%; display:flex; align-items:center; justify-content:center;"><i data-lucide="bell" style="width:16px;"></i></div>`;
                     if(val.from) {
                        // Async fetch photo (simplified)
                        db.ref('users/'+val.from+'/photo').once('value', pSnap => {
                            if(pSnap.exists()) div.querySelector('.notif-img-placeholder').src = pSnap.val();
                        });
                        imgHtml = `<img src="https://via.placeholder.com/40" class="notif-img notif-img-placeholder">`;
                     }
                }

                div.innerHTML = `
                    ${imgHtml}
                    <div class="notif-content">
                        <div class="notif-text">${val.msg}</div>
                        <div class="notif-time">${new Date(val.time).toLocaleTimeString()}</div>
                    </div>
                    <button class="btn-del-notif" onclick="event.stopPropagation(); deleteNotif('${val.key}')"><i data-lucide="trash-2" style="width:14px"></i></button>
                `;
                list.appendChild(div);
            });
            lucide.createIcons();
        }); 
    }
    // === 6. SINGLE POST MODAL (For Notification Clicks) ===
    function openSinglePostModal(postKey) {
        // reuse comment modal or create a specific view? 
        // For simplicity/UX, we switch to Home and scroll to post if loaded, 
        // OR show a dedicated modal if it's old.
        // Let's use a "Focus Mode" in the feed.
        
        switchTab('home');
        const feed = document.getElementById('socialFeed');
        feed.innerHTML = "<div style='text-align:center; padding:20px; opacity:0.5;'>Loading Post...</div>";
        
        db.ref('socialPosts/' + postKey).once('value', s => {
            if(s.exists()) {
                feed.innerHTML = ""; // Clear feed to show just this one (Focus Mode)
                renderSinglePost(s.val(), s.key, feed);
                
                // Add a "Back to Feed" button
                const btn = document.createElement('button');
                btn.innerText = "‚Üê Back to Full Feed";
                btn.style.cssText = "width:100%; padding:15px; background:#334155; color:white; border:none; border-bottom:1px solid #475569; font-weight:bold; cursor:pointer;";
                btn.onclick = loadSocialFeed; // Reload full feed
                feed.insertBefore(btn, feed.firstChild);
            } else {
                showToast("Post not found or deleted.");
                loadSocialFeed();
            }
        });
    }

    // === 7. RANKING ALGORITHM & FEED LOADING ===
    function loadSocialFeed() {
        const feedContainer = document.getElementById('socialFeed');
        feedContainer.innerHTML = "<div style='text-align:center; padding:20px; opacity:0.5;'>Loading Trending Feed...</div>";
        
        // Fetch all posts (In a real production app, use pagination/cloud functions)
        db.ref('socialPosts').limitToLast(100).once('value', s => {
            const posts = [];
            s.forEach(c => posts.push({ key: c.key, ...c.val() }));
            
            // APPLY RANKING ALGORITHM
            posts.forEach(p => {
                p.trendingScore = calculateTrendingScore(p);
            });
            
            // Sort by Trending Score (Highest first)
            posts.sort((a, b) => b.trendingScore - a.trendingScore);

            feedContainer.innerHTML = "";
            if(posts.length === 0) {
                feedContainer.innerHTML = "<div style='text-align:center; padding:40px; opacity:0.5;'>No posts yet. Be the first!</div>";
                return;
            }

            let adCounter = 0;
            posts.forEach(post => {
                renderSinglePost(post, post.key, feedContainer);
                
                // Inject Ad every 5 posts
                adCounter++;
                if(adCounter % 5 === 0) {
                    const adDiv = document.createElement('div');
                    adDiv.className = 'ad-container-global';
                    adDiv.innerHTML = `<span style="color:white; font-size:10px;">SPONSORED AD</span>`;
                    feedContainer.appendChild(adDiv);
                }
            });
            lucide.createIcons();
        });
    }

    function renderSinglePost(post, key, container) {
        const div = document.createElement('div');
        div.className = 'post-card';
        div.id = 'post-' + key;
        
        // Check if friend
        const isMe = post.uid === auth.currentUser.uid;
        
        // Mood HTML
        const moodHtml = post.mood ? `<span class="mood-display">is feeling ${post.mood}</span>` : '';
        
        // Image HTML
        const imgHtml = post.image ? `<div class="post-image-container"><img src="${post.image}" class="post-image"></div>` : '';
        
        // Reaction Summary (e.g. "‚ù§Ô∏è üòÜ 12")
        // We need to fetch this async or assume it's in post object. 
        // For this updated code, we will store reaction counts in the post object for speed.
        let reactionCount = 0;
        if(post.reactions) {
            Object.values(post.reactions).forEach(cnt => reactionCount += cnt);
        } else {
            reactionCount = post.likes || 0; // Fallback
        }

        div.innerHTML = `
            <div class="post-header">
                <div class="avatar-frame">
                    <img class="post-avatar" src="${post.authorPhoto}" onclick="openUserProfile('${post.uid}')">
                    </div>
                <div class="post-meta">
                    <div class="post-author">
                        ${post.authorName} 
                        ${isMe ? '<span class="friend-badge">YOU</span>' : ''}
                    </div>
                    <div class="post-time">${fixDate(post.timestamp)} ${moodHtml}</div>
                </div>
            </div>
            <div class="post-content">${post.content}</div>
            ${imgHtml}
            
            <div class="post-actions">
                <div style="position:relative; flex:1;">
                     <div id="reaction-popup-${key}" class="reaction-popup" style="display:none;">
                        <button class="reaction-icon-btn" onclick="submitReaction('${key}', 'Like')">üëç</button>
                        <button class="reaction-icon-btn" onclick="submitReaction('${key}', 'Love')">‚ù§Ô∏è</button>
                        <button class="reaction-icon-btn" onclick="submitReaction('${key}', 'Haha')">üòÜ</button>
                        <button class="reaction-icon-btn" onclick="submitReaction('${key}', 'Wow')">üòÆ</button>
                        <button class="reaction-icon-btn" onclick="submitReaction('${key}', 'Sad')">üò¢</button>
                        <button class="reaction-icon-btn" onclick="submitReaction('${key}', 'Angry')">üò°</button>
                     </div>
                     <button class="action-btn" onmouseenter="showReactions('${key}')" onclick="showReactions('${key}')">
                        <i data-lucide="thumbs-up" id="react-icon-${key}" style="width:14px;"></i>
                        <span id="react-label-${key}">Like</span>
                        <span id="react-count-${key}" style="margin-left:5px; opacity:0.6; font-size:10px;">${reactionCount}</span>
                     </button>
                </div>
                
                <button class="action-btn" onclick="openComments('${key}')">
                    <i data-lucide="message-circle" style="width:14px"></i> Comment
                </button>
            </div>
        `;
        
        // Render Badge on Avatar
        // We use a timeout to ensure the element is in DOM
        setTimeout(() => {
             const badgeContainer = div.querySelector('.avatar-frame');
             renderAvatarBadge(badgeContainer, post.authorPoints || 0); // Need to update function to accept element or ID
             
             // Update logic for renderAvatarBadge to support element passing:
             // (See revised helper below)
        }, 0);

        container.appendChild(div);
    }
    
    // Helper to render badge on element (Overriding previous ID-only version)
    function renderAvatarBadge(target, points) {
        let container = (typeof target === 'string') ? document.getElementById(target) : target;
        if(!container) return;
        
        const old = container.querySelector('.badge-overlay');
        if(old) old.remove();

        let badgeClass = "badge-bronze";
        let icon = "shield";
        if(points >= 100000) { badgeClass = "badge-diamond"; icon = "gem"; }
        else if(points >= 50000) { badgeClass = "badge-platinum"; icon = "crown"; }
        else if(points >= 25000) { badgeClass = "badge-gold"; icon = "star"; }
        else if(points >= 10000) { badgeClass = "badge-silver"; icon = "shield-check"; }

        const badgeDiv = document.createElement('div');
        badgeDiv.className = `badge-overlay ${badgeClass}`;
        badgeDiv.innerHTML = `<i data-lucide="${icon}" style="width:10px; height:10px;"></i>`;
        container.appendChild(badgeDiv);
        lucide.createIcons();
    }

    // === 8. REACTION SYSTEM LOGIC ===
    let activeReactionPopup = null;
    
    function showReactions(postKey) {
        // Hide previous
        if(activeReactionPopup) document.getElementById(activeReactionPopup).style.display = 'none';
        
        const popupId = `reaction-popup-${postKey}`;
        const popup = document.getElementById(popupId);
        if(popup) {
            popup.style.display = 'flex';
            activeReactionPopup = popupId;
            
            // Auto hide after 3 seconds if no selection
            setTimeout(() => { if(activeReactionPopup === popupId) popup.style.display = 'none'; }, 3000);
        }
    }

    function submitReaction(postKey, type) {
        const myUid = auth.currentUser.uid;
        
        // 1. Update UI Immediately (Optimistic)
        const label = document.getElementById(`react-label-${postKey}`);
        const icon = document.getElementById(`react-icon-${postKey}`);
        if(label) {
            label.innerText = type;
            label.style.color = getReactionColor(type);
        }
        if(document.getElementById(activeReactionPopup)) {
            document.getElementById(activeReactionPopup).style.display = 'none';
        }

        // 2. Update Database
        const reactRef = db.ref(`postReactions/${postKey}/${myUid}`);
        reactRef.set(type);
        
        // 3. Update Aggregate Counts (Transaction)
        const postRef = db.ref(`socialPosts/${postKey}`);
        postRef.transaction(post => {
            if (post) {
                if (!post.reactions) post.reactions = {};
                // Increment specific type, decrement old if existed? 
                // For simplicity, just increment current type for ranking weight
                if (!post.reactions[type]) post.reactions[type] = 0;
                post.reactions[type]++;
                // Update total trending score variables
                if(!post.likes) post.likes = 0;
                post.likes++; 
            }
            return post;
        });

        // 4. Notify Author
        db.ref('socialPosts/' + postKey).once('value', s => {
            const p = s.val();
            if(p.uid !== myUid) {
                db.ref('notifications/' + p.uid).push({
                    msg: `${userData.name} reacted ${type} to your post`,
                    type: 'reaction',
                    from: myUid,
                    postKey: postKey,
                    time: Date.now()
                });
            }
        });
        
        playSound('pop');
    }

    function getReactionColor(type) {
        switch(type) {
            case 'Love': return '#ec4899';
            case 'Haha': return '#fbbf24';
            case 'Angry': return '#ef4444';
            case 'Sad': return '#60a5fa';
            default: return '#3b82f6';
        }
    }

    // === 9. GROUP CHAT SYSTEM ===
    function toggleGroupCreate() {
        const ui = document.getElementById('groupCreateUI');
        ui.style.display = ui.style.display === 'none' ? 'block' : 'none';
        if(ui.style.display === 'block') loadFriendsForGroup();
    }

    let selectedGroupMembers = [];

    function loadFriendsForGroup() {
        const list = document.getElementById('groupFriendSelect');
        list.innerHTML = "Loading...";
        selectedGroupMembers = [];
        
        db.ref('friends/' + auth.currentUser.uid).once('value', s => {
            list.innerHTML = "";
            if(!s.exists()) { list.innerHTML = "No friends found."; return; }
            
            s.forEach(f => {
                db.ref('users/' + f.key).once('value', uSnap => {
                    const u = uSnap.val();
                    const div = document.createElement('div');
                    div.className = 'friend-select-item';
                    div.innerHTML = `<img src="${u.photo}" style="width:20px; height:20px; border-radius:50%;"> ${u.name}`;
                    div.onclick = () => {
                        // Toggle Selection
                        if(selectedGroupMembers.includes(f.key)) {
                            selectedGroupMembers = selectedGroupMembers.filter(id => id !== f.key);
                            div.classList.remove('selected');
                        } else {
                            selectedGroupMembers.push(f.key);
                            div.classList.add('selected');
                        }
                    };
                    list.appendChild(div);
                });
            });
        });
    }

    function createGroupChat() {
        const name = document.getElementById('groupNameInput').value.trim();
        if(!name) return showToast("Enter group name");
        if(selectedGroupMembers.length === 0) return showToast("Select at least 1 friend");
        
        const myUid = auth.currentUser.uid;
        const members = [...selectedGroupMembers, myUid];
        
        const newGroupRef = db.ref('groups').push();
        const groupId = newGroupRef.key;
        
        newGroupRef.set({
            name: name,
            admin: myUid,
            members: members,
            created: Date.now(),
            photo: 'https://via.placeholder.com/50?text=GP'
        }).then(() => {
            showToast("Group Created!");
            toggleGroupCreate();
            // Optionally, open the group chat immediately
            // For now, it will appear in the inbox list
            loadInbox(); 
        });
    }

    // Updated Inbox Loader to include Groups
    function loadInbox() { 
        const uid = auth.currentUser.uid; 
        const list = document.getElementById('pmList'); 
        list.innerHTML = "<div style='text-align:center; padding:20px; opacity:0.5;'>Loading Chats...</div>"; 
        
        renderActiveFriends(); // Keep active friends bar

        // 1. Load 1-on-1 Messages
        // (Existing logic kept, but we merge with groups)
        const conversations = [];
        
        db.ref('messages').once('value', s => { 
             s.forEach(msgSnap => { 
                 const m = msgSnap.val(); 
                 // If 1-on-1
                 if((m.from === uid || m.to === uid) && !m.groupId) { 
                     const partner = m.from === uid ? m.to : m.from; 
                     // Check if already in list, if not add
                     const existing = conversations.find(c => c.id === partner);
                     if(!existing) {
                         conversations.push({ type: 'user', id: partner, lastMsg: m });
                     } else {
                         // Update if newer
                         if(m.timestamp > existing.lastMsg.timestamp) existing.lastMsg = m;
                     }
                 }
             });
             
             // 2. Load Groups
             db.ref('groups').once('value', gSnap => {
                 gSnap.forEach(g => {
                     const group = g.val();
                     if(group.members && group.members.includes(uid)) {
                         conversations.push({ 
                             type: 'group', 
                             id: g.key, 
                             name: group.name, 
                             photo: group.photo,
                             lastMsg: { text: "Group Chat", timestamp: group.created } // Fetch real last msg in production
                         });
                     }
                 });
                 
                 // Sort by time
                 conversations.sort((a,b) => b.lastMsg.timestamp - a.lastMsg.timestamp);
                 
                 list.innerHTML = ""; 
                 conversations.forEach(c => {
                     if(c.type === 'user') {
                         db.ref('users/' + c.id).once('value', uSnap => { 
                            const u = uSnap.val(); 
                            const div = document.createElement('div'); 
                            div.className = 'pm-item'; 
                            div.onclick = () => openPrivateChat(c.id, u.name, u.photo); 
                            const preview = c.lastMsg.image ? 'Sent a photo' : c.lastMsg.text;
                            div.innerHTML = `<img class="pm-avatar" src="${u.photo}"><div class="pm-info"><span class="pm-name">${u.name}</span><span class="pm-preview">${preview}</span></div>`; 
                            list.appendChild(div); 
                        }); 
                     } else {
                         // Group Render
                         const div = document.createElement('div'); 
                         div.className = 'pm-item'; 
                         div.onclick = () => showToast("Group Chat UI coming in next update"); // Placeholder for full group UI implementation or reuse PM UI with groupId
                         div.innerHTML = `<img class="pm-avatar" src="${c.photo}"><div class="pm-info"><span class="pm-name">${c.name} (Group)</span><span class="pm-preview">Click to open</span></div>`; 
                         list.appendChild(div); 
                     }
                 });
             });
        }); 
    }
    // === 10. GROUP CHAT IMPLEMENTATION ===
    function openGroupChat(groupId, groupName, groupPhoto) {
        currentChatPartner = groupId; // Reuse variable, but acts as Group ID
        currentChatType = 'group'; // NEW FLAG
        
        document.getElementById('pmModal').style.display = 'flex'; 
        document.getElementById('pmInboxView').style.display = 'none'; 
        document.getElementById('pmChatView').style.display = 'flex'; 
        
        document.getElementById('chatTargetName').innerText = groupName; 
        document.getElementById('chatTargetImg').src = groupPhoto || 'https://via.placeholder.com/40'; 
        
        listenGroupMessages(groupId);
    }

    let groupListenerRef = null;
    function listenGroupMessages(groupId) {
        const chatDiv = document.getElementById('pmMessages'); 
        chatDiv.innerHTML = "";
        
        if(pmListenerRef) db.ref('messages').off(); // Turn off PM listener
        if(groupListenerRef) db.ref('groupMessages/' + groupId).off(); // Turn off prev group listener

        groupListenerRef = db.ref('groupMessages/' + groupId).limitToLast(50);
        groupListenerRef.on('child_added', s => {
            const m = s.val();
            const isMe = m.from === auth.currentUser.uid;
            
            const div = document.createElement('div'); 
            div.className = `msg-bubble ${isMe ? 'msg-me' : 'msg-them'}`; 
            
            // Show sender name in group
            let senderName = "";
            if(!isMe) senderName = `<div style="font-size:9px; opacity:0.6; margin-bottom:2px;">${m.senderName}</div>`;

            let contentHtml = m.text;
            if(m.image) contentHtml += `<br><img src="${m.image}" class="msg-image-preview">`;

            div.innerHTML = `${senderName}${contentHtml}`; 
            chatDiv.appendChild(div); 
            chatDiv.scrollTop = chatDiv.scrollHeight; 
        });
    }

    // Updated Send Function to handle Groups
    function sendPrivateMessage() { 
        const inp = document.getElementById('pmInput'); 
        const text = inp.value.trim(); 
        const imgInput = document.getElementById('pmImgInput');
        // Check global variable from Part 3 logic (pmImageBase64)
        // Note: Ensure pmImageBase64 is defined in global scope in previous parts or here
        // For safety, defining it here if strictly needed, but assuming it exists from previous part context
        
        if((!text && !pmImageBase64) || !currentChatPartner) return; 
        
        const myUid = auth.currentUser.uid; 
        
        if(currentChatType === 'group') {
            // Send to Group
            const msgData = {
                from: myUid,
                senderName: userData.name,
                text: text,
                image: pmImageBase64,
                timestamp: Date.now()
            };
            db.ref('groupMessages/' + currentChatPartner).push(msgData);
            // Update Group Last Msg Metadata (Optional for sorting)
            db.ref('groups/' + currentChatPartner).update({
                lastMsgTime: Date.now(),
                lastMsgText: text ? text : 'Photo'
            });

        } else {
            // Send PM (Existing Logic)
            const msgData = { from: myUid, to: currentChatPartner, text: text, image: pmImageBase64, timestamp: Date.now() }; 
            db.ref('messages').push(msgData); 
            
            const notifMsg = pmImageBase64 ? 'Sent a photo' : `New PM from ${userData.name}`;
            db.ref('notifications/' + currentChatPartner).push({ msg: notifMsg, time: Date.now(), type: 'pm', from: myUid }); 
        }

        inp.value = ""; 
        pmImageBase64 = null;
        document.getElementById('pmImgInput').value = "";
        document.getElementById('pmImgPreviewCont').style.display = 'none';
    }

    // === 11. CORE BINGO GAME LOGIC ===
    let gameDrawn = []; 
    let cardNumbers = []; 
    let marks = [12]; 
    let currentPattern = "Normal Bingo";
    let isJackpotActive = false;
    let currentJackpotAmount = 500;

    function initBingo() {
        // Winner Listener
        db.ref('gameState/latestWinner').on('value', s => { 
            const win = s.val(); 
            const banner = document.getElementById('winnerBanner'); 
            const cardCont = document.getElementById('bingoCardContainer'); 
            const gameOverlay = document.getElementById('gameOverOverlay'); 
            
            // Reset Visuals
            cardCont.classList.remove('card-puro'); 
            document.querySelectorAll('.cell').forEach(c => c.classList.remove('cell-waiting')); 
            
            if(win && win.name) { 
                banner.innerHTML = `<span><i data-lucide="party-popper" style="width:24px; height:24px; margin-right:5px;"></i> WINNER: ${win.name.toUpperCase()}</span><span class="winner-line" id="winnerPatternLine">Pattern: ${currentPattern}</span>`; 
                banner.style.display = 'block'; 
                playSound('win'); 
                lucide.createIcons(); 
                
                if(win.uid === auth.currentUser.uid) { 
                    confetti({ particleCount: 150, spread: 70, origin: { y: 0.6 } }); 
                    cardCont.classList.add('card-win'); 
                    cardCont.classList.remove('card-lost'); 
                    gameOverlay.style.display = 'none'; 
                    spawnFlyingCoins(20); 
                    triggerScreenShake(); 
                } else { 
                    cardCont.classList.add('card-lost'); 
                    cardCont.classList.remove('card-win'); 
                    gameOverlay.style.display = 'flex'; 
                    const nextTime = document.getElementById('nextDrawTime').innerText; 
                    document.getElementById('gameOverMsg').innerHTML = `Sayang! Si <b>${win.name.toUpperCase()}</b> ang nanalo.<br><br>Bawi tayo sa next draw!<br><span style="color:var(--gold); font-weight:800; font-size:14px; margin-top:5px; display:block;">SCHEDULE: ${nextTime}</span>`; 
                } 
            } else { 
                banner.style.display = 'none'; 
                cardCont.classList.remove('card-win', 'card-lost'); 
                gameOverlay.style.display = 'none'; 
                document.querySelectorAll('.cell').forEach(c => { c.classList.remove('win-glow', 'win-line-h', 'win-line-v', 'win-line-d1', 'win-line-d2'); }); 
            } 
        });

        // Pattern Listener
        db.ref('gameState/currentPattern').on('value', s => { 
            currentPattern = s.val() || "Normal Bingo"; 
            document.getElementById('patternName').innerText = currentPattern; 
            checkWin(); 
        });

        // Drawn Numbers Listener
        db.ref('drawnNumbers').on('value', s => { 
            const val = s.val(); 
            const newGameDrawn = val ? Object.values(val).map(n => n.toString()) : []; 
            
            if(newGameDrawn.length > 0 && gameDrawn.length > 0) { 
                const newBalls = newGameDrawn.filter(x => !gameDrawn.includes(x)); 
                if(newBalls.length > 0) { 
                    const latestBall = newBalls[newBalls.length - 1]; 
                    playSound('newBall'); 
                    showToast("BOLA: " + latestBall); 
                } 
            } 
            gameDrawn = newGameDrawn; 
            
            // Disable New Card Button if Game Started
            const btn = document.getElementById('newCardBtn'); 
            if(gameDrawn.length > 0) { 
                btn.disabled = true; 
                btn.innerHTML = `<i data-lucide="lock" style="width:14px"></i> IN GAME`; 
            } else { 
                btn.disabled = false; 
                btn.innerHTML = `<i data-lucide="refresh-cw" style="width:14px"></i> NEW CARD`; 
            } 
            
            lucide.createIcons(); 
            checkLateJoiner(); 
            updateGridHits(); 
            renderPrevBalls(); 
            checkWin(); 
            checkPuroStatus(); 
        });
        
        // Voice Caller
        db.ref('gameState/lastCalled').on('value', s => { 
            if(s.exists()) { 
                const num = s.val(); 
                document.getElementById('currentBall').innerText = num; 
                speakNumber(num);
            } else { 
                document.getElementById('currentBall').innerText = "--"; 
            } 
        });
    }

    function speakNumber(num) { 
        if ('speechSynthesis' in window) { 
            let letter = "B"; 
            if (num > 15) letter = "I"; 
            if (num > 30) letter = "N"; 
            if (num > 45) letter = "G"; 
            if (num > 60) letter = "O"; 
            const msg = new SpeechSynthesisUtterance(`${letter} ${num}`); 
            msg.rate = 0.9; 
            window.speechSynthesis.speak(msg); 
        } 
    }

    function checkWin() { 
        if(userData.hasWonCurrent || gameDrawn.length === 0) return; 
        
        db.ref('gameState/latestWinner').once('value', snap => { 
            if(snap.exists()) return; // Already a winner
            
            let winningWays = []; 
            if (currentPattern === "Blackout") { winningWays = [Array.from({length: 25}, (_, i) => i)]; } 
            else if (currentPattern === "Letter X") { winningWays = [[0,4,6,8,12,16,18,20,24]]; } 
            else if (currentPattern === "Four Corners") { winningWays = [[0,4,20,24]]; } 
            else { 
                // Normal Bingo (Rows, Cols, Diagonals)
                winningWays = [ 
                    [0,1,2,3,4],[5,6,7,8,9],[10,11,12,13,14],[15,16,17,18,19],[20,21,22,23,24], // Rows
                    [0,5,10,15,20],[1,6,11,16,21],[2,7,12,17,22],[3,8,13,18,23],[4,9,14,19,24], // Cols
                    [0,6,12,18,24], [4,8,12,16,20] // Diagonals
                ]; 
            } 
            
            for(let i = 0; i < winningWays.length; i++) { 
                let w = winningWays[i]; 
                if(w.every(idx => marks.includes(idx))) { 
                    highlightWinningPattern(w, i); 
                    triggerWin(); 
                    break; 
                } 
            } 
        }); 
    }

    function triggerWin() { 
        const uid = auth.currentUser.uid; 
        let winPrize = 500; 
        if (isJackpotActive) winPrize = currentJackpotAmount; 
        
        db.ref('gameState/latestWinner').set({ name: userData.name, uid: uid, prize: winPrize }); 
        db.ref('users/' + uid + '/points').transaction(p => (p || 0) + winPrize); 
        db.ref('users/' + uid).update({ hasWonCurrent: true }); 
        userData.hasWonCurrent = true; 
        
        if (isJackpotActive) { 
            const jpModal = document.getElementById('grandJackpotModal'); 
            document.getElementById('grandPrizeAmount').innerText = winPrize.toLocaleString() + " RB COINS"; 
            document.getElementById('jpWinnerName').innerText = userData.name; 
            jpModal.style.display = 'flex'; 
            confetti({ particleCount: 500, spread: 120, startVelocity: 60 }); 
        } 
    }

    function generateNewCard() { 
        if(gameDrawn.length > 0) return showToast("Bawal magpalit habang may laro!"); 
        
        let card = []; 
        let cols = [[1,15],[16,30],[31,45],[46,60],[61,75]]; 
        
        cols.forEach(r => { 
            let nums = []; 
            while(nums.length < 5) { 
                let n = Math.floor(Math.random() * (r[1] - r[0] + 1)) + r[0]; 
                if(!nums.includes(n)) nums.push(n); 
            } 
            card.push(...nums); 
        }); 
        
        let finalCard = []; 
        // Transpose to columns
        for(let r=0; r<5; r++) { 
            for(let c=0; c<5; c++) { 
                finalCard.push(card[c*5 + r]); 
            } 
        } 
        finalCard[12] = "FREE"; 
        
        db.ref('users/' + auth.currentUser.uid).update({ currentCard: finalCard, cardTimestamp: Date.now(), hasWonCurrent: false }); 
        cardNumbers = finalCard; 
        renderCard(); 
        playSound('cardFlip'); 
    }

    function renderCard() { 
        const grid = document.getElementById('bingoGrid'); 
        grid.innerHTML = ""; 
        cardNumbers.forEach((n, i) => { 
            const div = document.createElement('div'); 
            div.className = 'cell'; 
            div.innerText = n === "FREE" ? "‚òÖ" : n; 
            if(n === "FREE") { 
                div.classList.add('hit'); 
                if(!marks.includes(12)) marks.push(12); 
            } 
            grid.appendChild(div); 
        }); 
        updateGridHits(); 
        applySkin(userData.equippedSkin || 'default'); 
    }
    
    // === 12. GLOBAL CHAT LOGIC ===
    function setupChat() { 
        const list = document.getElementById('chatList'); 
        db.ref('chats').limitToLast(50).on('child_added', s => { 
            const d = s.val(); 
            const key = s.key; 
            // Add mute logic here if needed
            
            const isMe = d.uid === auth.currentUser.uid; 
            const div = document.createElement('div'); 
            div.className = 'chat-row'; 
            div.style.flexDirection = isMe ? 'row-reverse' : 'row'; 
            
            let replyHtml = ''; 
            if(d.replyTo && d.replyMsg) { 
                replyHtml = `<div style="font-size:10px; opacity:0.7; border-left:2px solid var(--accent); padding-left:5px; margin-bottom:5px; background:rgba(0,0,0,0.2); padding:4px; border-radius:4px;">Replying to: ${d.replyMsg.substring(0, 30)}...</div>`; 
            } 
            
            // Name onclick -> Reply
            // Avatar onclick -> Profile
            div.innerHTML = `
                <img class="chat-pfp" src="${d.pfp}" onclick="showUserOptions('${d.uid}', '${d.name.replace(/'/g, "\\'")}', '${d.pfp}')">
                <div class="chat-content">
                    <div class="bubble">
                        ${!isMe ? `<div class="chat-name" onclick="replyTo('${key}', '${d.msg.replace(/'/g, "\\'")}')">${d.name}</div>` : ''}
                        ${replyHtml}
                        <div class="chat-text">${d.msg}</div>
                    </div>
                </div>
            `; 
            list.appendChild(div); 
            list.scrollTop = list.scrollHeight; 
            lucide.createIcons(); 
        }); 
    }
    
    function sendChat() { 
        const inp = document.getElementById('chatIn'); 
        const msg = inp.value.trim(); 
        if(!msg) return; 
        
        const payload = { 
            name: userData.name, 
            msg: msg, 
            pfp: userData.photo, 
            uid: userData.uid, 
            time: Date.now() 
        }; 
        
        if(selectedReplyId) { 
            payload.replyTo = selectedReplyId; 
            payload.replyMsg = document.getElementById('replyText').innerText.replace("Replying to: ", ""); 
            cancelReply(); 
        } 
        
        db.ref('chats').push(payload); 
        inp.value = ""; 
    }
    // === 13. PROFILE FEED (WITH REACTIONS) & FRIEND LOGIC ===
    
    function loadProfilePosts(uid) {
        const container = document.getElementById('pageProfileFeed');
        container.innerHTML = "<div style='color:white; opacity:0.5; text-align:center; padding:20px;'>Loading Posts...</div>";
        
        db.ref('socialPosts').orderByChild('uid').equalTo(uid).limitToLast(20).once('value', pSnap => {
            container.innerHTML = "";
            let count = 0;
            let totalLikes = 0;
            const posts = [];
            
            pSnap.forEach(c => {
                const p = c.val();
                posts.push({ key: c.key, ...p });
                count++;
                if(p.likes) totalLikes += p.likes;
            });
            
            // Update Stats
            document.getElementById('statPosts').innerText = count;
            document.getElementById('statLikes').innerText = totalLikes;
            
            // Sort Descending
            posts.sort((a,b) => b.timestamp - a.timestamp);
            
            if(posts.length === 0) {
                container.innerHTML = "<div style='color:white; opacity:0.5; font-size:12px; text-align:center; padding:20px;'>No posts yet</div>";
                return;
            }

            // Reuse renderSinglePost to ensure Reactions & Badges work here too
            posts.forEach(post => {
                renderSinglePost(post, post.key, container);
            });
            lucide.createIcons();
        });
    }

    function handleProfileMainAction() {
        // Logic depends on button state (set in updateProfileButtonState)
        // Usually handles Add Friend or Open Chat
        const btn = document.getElementById('profileMainActionBtn');
        if(btn.innerText === "Add Friend") {
            db.ref('friendRequests/' + currentProfileUid + '/' + auth.currentUser.uid).set(true);
            showToast("Friend Request Sent!");
            updateProfileButtonState(currentProfileUid);
        } else if (btn.innerText === "Message") {
            const name = document.getElementById('pageProfileName').innerText;
            const photo = document.getElementById('pageProfileImg').src;
            openPrivateChat(currentProfileUid, name, photo);
        }
    }

    function updateProfileButtonState(uid) {
        const btn = document.getElementById('profileMainActionBtn');
        const unfriendBtn = document.getElementById('unfriendBtn');
        const myUid = auth.currentUser.uid;
        
        unfriendBtn.style.display = 'none'; // Hide by default
        
        if(uid === myUid) {
            btn.innerText = "Edit Profile";
            btn.className = "profile-action-btn secondary";
            btn.onclick = openEditProfile;
        } else {
            // Check Friend Status
            db.ref('friends/' + myUid + '/' + uid).once('value', s => {
                if(s.exists()) {
                    btn.innerText = "Message";
                    btn.className = "profile-action-btn";
                    btn.onclick = () => {
                        const name = document.getElementById('pageProfileName').innerText;
                        const photo = document.getElementById('pageProfileImg').src;
                        openPrivateChat(uid, name, photo);
                    };
                    unfriendBtn.style.display = 'flex'; // Show Modern Unfriend Button
                } else {
                     // Check Request Status
                     db.ref('friendRequests/' + uid + '/' + myUid).once('value', reqSnap => {
                         if(reqSnap.exists()) {
                             btn.innerText = "Request Sent";
                             btn.className = "profile-action-btn secondary";
                             btn.onclick = null;
                         } else {
                             btn.innerText = "Add Friend";
                             btn.className = "profile-action-btn";
                             btn.onclick = handleProfileMainAction;
                         }
                     });
                }
            });
        }
    }

    function unfriendUser() {
        if(!currentProfileUid) return;
        showCustomConfirm("Unfriend?", "Are you sure you want to remove this friend?", () => {
             const myUid = auth.currentUser.uid;
             db.ref('friends/' + myUid + '/' + currentProfileUid).remove();
             db.ref('friends/' + currentProfileUid + '/' + myUid).remove();
             showToast("Unfriended successfully.");
             updateProfileButtonState(currentProfileUid);
        });
    }

    function acceptFriend(requesterUid) {
        const myUid = auth.currentUser.uid;
        db.ref('friends/' + myUid + '/' + requesterUid).set(true);
        db.ref('friends/' + requesterUid + '/' + myUid).set(true);
        db.ref('friendRequests/' + myUid + '/' + requesterUid).remove();
        showToast("You are now friends!");
        playSound('win');
        // Refresh requests UI
        const reqDiv = document.getElementById('friendRequestsSection'); 
        if(reqDiv.children.length <= 1) reqDiv.innerHTML = "";
    }

    function declineFriend(requesterUid) {
        db.ref('friendRequests/' + auth.currentUser.uid + '/' + requesterUid).remove();
        showToast("Request declined");
    }

    // === 14. STORE & SKINS LOGIC ===

    function equipSkin(skinId) { 
        db.ref('users/' + userData.uid).update({ equippedSkin: skinId }); 
        showToast("Skin Equipped"); 
        playSound('click'); 
        updateSkinButtons();
    }

    function buyOrEquipSkin(skinId, cost) { 
        if(!userData.ownedSkins) userData.ownedSkins = ['default']; 
        
        if(userData.ownedSkins.includes(skinId)) { 
            equipSkin(skinId); 
        } else { 
            if(userData.points >= cost) { 
                showCustomConfirm("BUY SKIN?", "Purchase for " + cost + " Coins?", () => { 
                    deductPoints(cost); 
                    let newOwned = [...userData.ownedSkins, skinId]; 
                    db.ref('users/' + userData.uid).update({ ownedSkins: newOwned, equippedSkin: skinId }); 
                    showToast("Skin Purchased!"); 
                    playSound('win'); 
                    spawnFlyingCoins(10); 
                    updateSkinButtons();
                }); 
            } else { 
                showToast("Insufficient Coins"); 
            } 
        } 
    }

    function updateSkinButtons() { 
        // Sync UI with owned skins
        if(!userData.ownedSkins) return; 
        ['default', 'gold', 'custom'].forEach(skin => { 
            const btn = document.getElementById('btn-skin-' + skin); 
            if(!btn) return; 
            if(userData.equippedSkin === skin) { 
                btn.innerText = "EQUIPPED"; 
                btn.className = "btn-buy-skin owned"; 
                btn.onclick = null; 
            } else if(userData.ownedSkins.includes(skin)) { 
                btn.innerText = "EQUIP"; 
                btn.className = "btn-buy-skin equip"; 
                btn.onclick = () => equipSkin(skin); 
            } 
        }); 
    }

    function handleCustomSkinUpload(input) {
        if(input.files && input.files[0]) {
            compressImage(input.files[0], 800, 0.7).then(base64 => {
                localStorage.setItem('customSkinBG', base64);
                // Auto equip custom logic
                if(!userData.ownedSkins.includes('custom')) {
                     let newOwned = [...(userData.ownedSkins || []), 'custom'];
                     db.ref('users/' + userData.uid).update({ ownedSkins: newOwned });
                }
                db.ref('users/' + userData.uid).update({ equippedSkin: 'custom' });
                showToast("Custom Background Set!");
                updateSkinButtons();
            });
        }
    }
    
    function loadCustomSkin() {
         if(localStorage.getItem('customSkinBG')) {
            document.getElementById('customSkinSlot').style.display = 'block';
            document.getElementById('customSkinPreview').style.backgroundImage = `url('${localStorage.getItem('customSkinBG')}')`;
        }
    }

    function applySkin(skinId) { 
        const card = document.getElementById('bingoCardContainer'); 
        card.className = "card"; // Reset
        card.style.backgroundImage = 'none';

        if(skinId === 'gold') card.classList.add('card-skin-gold'); 
        if(skinId === 'custom') {
            card.classList.add('card-skin-custom');
            const storedBG = localStorage.getItem('customSkinBG');
            if(storedBG) card.style.backgroundImage = `url('${storedBG}')`;
        }
        // Default has no extra class
    }

    // === 15. TASK & ADS LOGIC ===
    let strictTimer = null;
    let strictSeconds = 30;

    function startStrictWatch() {
        // Link to ad
        window.open("https://directoryeditorweep.com/9b/f5/85/9bf585b6ee39cb9b515e2fae1fa958c2.js", "_blank"); 
        
        const overlay = document.getElementById('adTimerOverlay'); 
        overlay.style.display = 'flex'; 
        
        strictSeconds = 30; 
        const cd = document.getElementById('adCountdown'); 
        const status = document.getElementById('adStatusText'); 
        const cap = document.getElementById('adCaptchaOverlay'); 
        
        cd.innerText = strictSeconds + "s";
        status.innerText = "Do not close app or switch tabs!";
        
        clearInterval(strictTimer);
        strictTimer = setInterval(() => { 
            if(document.hidden) { 
                status.innerText = "‚ö†Ô∏è PAUSED! Please return to app."; 
                return; 
            } 
            strictSeconds--; 
            cd.innerText = strictSeconds + "s"; 
            status.innerText = "Watching Ad..."; 
            
            if(strictSeconds <= 0) { 
                clearInterval(strictTimer); 
                overlay.style.display = 'none'; 
                cap.style.display = 'flex'; 
                const n1 = Math.floor(Math.random()*10); 
                const n2 = Math.floor(Math.random()*10); 
                document.getElementById('mathQ').innerText = `${n1} + ${n2} = ?`; 
                document.getElementById('mathQ').dataset.ans = n1+n2; 
            } 
        }, 1000); 
    }

    function verifyAdMath() { 
        const ans = document.getElementById('mathAns').value; 
        const corr = document.getElementById('mathQ').dataset.ans; 
        if(ans === corr) { 
            document.getElementById('adCaptchaOverlay').style.display = 'none'; 
            addPoints(50); 
            showToast("Reward: +50 Coins Added!"); 
        } else { 
            showToast("Wrong Answer!"); 
        } 
    }
    
    function openVideoLocker(taskKey) {
        // Simple locker logic
        const lastRun = localStorage.getItem('task_cooldown_video'); 
        if(lastRun && (Date.now() - parseInt(lastRun)) < 300000) { 
            showToast("‚è≥ Wait 5 mins before watching again."); 
            return; 
        } 
        showCustomConfirm("WATCH VIDEO", "Complete video task to earn.", () => { 
            localStorage.setItem('task_cooldown_video', Date.now()); 
            // Mock Task
            setTimeout(() => {
                addPoints(2000);
                showToast("+2,000 Coins Reward!");
            }, 5000);
            window.open("https://doctoredits.com/script_include.php?id=1874676", "_blank");
        }); 
    }

    // === UTILS ===
    function compressImage(file, maxWidth, quality) {
        return new Promise((resolve) => {
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = (event) => {
                const img = new Image();
                img.src = event.target.result;
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    let width = img.width;
                    let height = img.height;
                    if (width > maxWidth) { height *= maxWidth / width; width = maxWidth; }
                    canvas.width = width; canvas.height = height;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, width, height);
                    resolve(canvas.toDataURL('image/jpeg', quality));
                };
            };
        });
    }

    function fixDate(timestamp) { 
        if(!timestamp) return "Just now"; 
        const d = new Date(parseInt(timestamp)); 
        return d.toLocaleDateString('en-PH', { month: 'short', day: 'numeric' }) + " " + d.toLocaleTimeString('en-PH', { hour: '2-digit', minute: '2-digit' }); 
    }

</script>
</body>
</html>
