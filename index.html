<!DOCTYPE html>
<html lang="tl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#0f172a">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Radio Bingo Live | Social Ecosystem</title>
    
    <script>
        if (window.location.pathname.endsWith("index.html")) {
            var newPath = window.location.pathname.replace(/index\.html$/, "");
            window.history.replaceState({}, document.title, newPath);
        }
    </script>

    <link rel="icon" type="image/png" href="https://i.imgur.com/7D8u8h6.png">
    <link rel="apple-touch-icon" href="https://i.imgur.com/7D8u8h6.png">
    <link rel="manifest" href="manifest.json">
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;900&family=Comic+Neue:wght@700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-messaging.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

    <script src="https://pl28660488.effectivegatecpm.com/9b/f5/85/9bf585b6ee39cb9b515e2fae1fa958c2.js"></script>
    <script src="https://pl28660496.effectivegatecpm.com/a6/64/bf/a664bf7e7084386b4f4b428590030df3.js"></script>

    <style>
        /* === MODERN SOCIAL MEDIA VARIABLES === */
        :root { 
            --bg-body: #0f172a;       /* Slate 900 - Darker Background */
            --bg-card: #1e293b;       /* Slate 800 - Lighter Card */
            --bg-input: #334155;      /* Slate 700 - Inputs */
            --border-color: rgba(255, 255, 255, 0.08);
            
            --accent: #3b82f6;        /* Modern Blue (FB/Twitter style) */
            --accent-glow: #60a5fa;
            --text-main: #f1f5f9;
            --text-sub: #94a3b8;
            
            --gold: #fbbf24; 
            --success: #10b981; 
            --danger: #ef4444; 
            --minigame: #f472b6;
            
            --messenger-blue: #0084ff;
            --messenger-grey: #303030;
        }
        
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; user-select: none; }
        
        body { 
            font-family: 'Inter', sans-serif; 
            background: var(--bg-body);
            color: var(--text-main); 
            margin: 0; 
            padding-bottom: 90px; 
            overflow-x: hidden; 
            min-height: 100vh;
        }

        /* === CLEANER SCROLLBAR === */
        ::-webkit-scrollbar { width: 5px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #475569; border-radius: 10px; }

        /* === UTILS === */
        #customPopupBanner { display: none; position: fixed; inset: 0; z-index: 9999999; background: rgba(0,0,0,0.85); align-items: center; justify-content: center; flex-direction: column; padding: 20px; backdrop-filter: blur(5px); }
        
        /* === BINGO CARD SKINS (PRESERVED) === */
        .card-skin-neon { border: 2px solid #06b6d4 !important; box-shadow: 0 0 20px #06b6d4, inset 0 0 20px rgba(6, 182, 212, 0.2) !important; background: rgba(8, 51, 68, 0.9) !important; }
        .card-skin-neon .cell { border-color: #06b6d4 !important; color: #67e8f9 !important; text-shadow: 0 0 5px #06b6d4 !important; }
        .card-skin-gold { border: 2px solid #f59e0b !important; box-shadow: 0 0 25px #f59e0b, inset 0 0 10px #f59e0b !important; background: linear-gradient(135deg, #451a03, #000) !important; }
        .card-skin-gold .cell { border-color: #fbbf24 !important; color: #fcd34d !important; font-family: 'Times New Roman', serif; }
        .card-skin-pink { border: 2px solid #ec4899 !important; box-shadow: 0 0 20px #ec4899 !important; background: rgba(80, 7, 36, 0.9) !important; }
        .card-skin-pink .cell { border-color: #f472b6 !important; color: #fbcfe8 !important; border-radius: 50% !important; }
        .card-skin-matrix { border: 2px solid #22c55e !important; box-shadow: 0 0 15px #22c55e !important; background: black !important; font-family: 'Courier New', monospace; }
        .card-skin-matrix .cell { border-color: #22c55e !important; color: #4ade80 !important; border-radius: 0 !important; }
        .card-skin-kitty { border: 4px solid #ffc0cb !important; background: radial-gradient(circle, #fff0f5, #ff69b4) !important; box-shadow: 0 0 20px #ff69b4 !important; font-family: 'Comic Neue', cursive; }
        .card-skin-kitty .cell { background: white !important; color: #ff1493 !important; border: 2px solid #ffc0cb !important; border-radius: 15px !important; }
        .card-skin-kitty .bingo-header .letter { color: #ff1493 !important; text-shadow: 2px 2px 0px white !important; }
        .card-skin-doraemon { border: 4px solid #0096df !important; background: linear-gradient(180deg, #0096df 0%, #ffffff 100%) !important; box-shadow: 0 0 20px #dd1616 !important; }
        .card-skin-doraemon .cell { background: rgba(255,255,255,0.9) !important; color: #0096df !important; border: 2px solid #dd1616 !important; border-radius: 50% !important; }
        .card-skin-doraemon .bingo-header .letter { color: #dd1616 !important; text-shadow: 2px 2px 0px white !important; }
        .card-skin-spongebob { border: 4px solid #f7f44d !important; background: url('https://upload.wikimedia.org/wikipedia/commons/thumb/e/e6/SpongeBob_SquarePants_logo.svg/1200px-SpongeBob_SquarePants_logo.svg.png'), #f7f44d !important; background-size: cover !important; box-shadow: 0 0 20px #f7f44d !important; }
        .card-skin-spongebob .cell { background: rgba(255,255,255,0.8) !important; color: #7d5837 !important; border: 2px dashed #7d5837 !important; }
        .card-skin-kuromi { border: 4px solid #000000 !important; background: linear-gradient(135deg, #000000, #4b0082) !important; box-shadow: 0 0 20px #ea65a2 !important; }
        .card-skin-kuromi .cell { background: rgba(234, 101, 162, 0.2) !important; color: #ea65a2 !important; border: 1px solid #ea65a2 !important; border-radius: 8px 0 8px 0 !important; }
        .card-skin-custom { background-size: cover !important; background-position: center !important; border: 2px solid rgba(255,255,255,0.5) !important; box-shadow: 0 0 30px rgba(0,0,0,0.8) !important; }
        .card-skin-custom .cell { background: rgba(0,0,0,0.6) !important; backdrop-filter: blur(4px); color: white !important; border: 1px solid rgba(255,255,255,0.3) !important; }

        /* === STORE UI === */
        .store-nav { display: flex; gap: 8px; margin-bottom: 20px; background: rgba(0,0,0,0.2); padding: 5px; border-radius: 12px; }
        .store-tab-btn { flex: 1; padding: 12px; border: none; background: transparent; color: var(--text-sub); font-weight: 700; border-radius: 8px; cursor: pointer; font-size: 12px; text-transform: uppercase; transition: 0.2s; }
        .store-tab-btn.active { background: var(--bg-input); color: white; box-shadow: none; border-bottom: 2px solid var(--accent); }
        .skins-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .skin-item { background: var(--bg-card); padding: 15px; border-radius: 16px; border: 1px solid var(--border-color); text-align: center; position: relative; overflow: hidden; }
        .skin-preview { height: 70px; border-radius: 12px; margin-bottom: 10px; display: flex; align-items: center; justify-content: center; font-size: 24px; font-weight: 900; background-size: cover; background-position: center; }
        .skin-name { font-size: 13px; font-weight: 700; color: white; margin-bottom: 4px; }
        .skin-cost { font-size: 11px; color: var(--gold); margin-bottom: 10px; font-weight: 600; }
        .btn-buy-skin { width: 100%; padding: 10px; border: none; border-radius: 8px; font-weight: 700; font-size: 11px; cursor: pointer; transition: 0.2s; }
        .btn-buy-skin.owned { background: rgba(255,255,255,0.1); color: #cbd5e1; cursor: default; }
        .btn-buy-skin.buy { background: var(--gold); color: black; }
        .btn-buy-skin.equip { background: var(--success); color: white; }
        
        /* === FLYING COINS === */
        .flying-coin { position: fixed; width: 24px; height: 24px; background-image: url('https://cdn-icons-png.flaticon.com/512/217/217853.png'); background-size: contain; background-repeat: no-repeat; z-index: 99999; pointer-events: none; will-change: transform, opacity; }
        @keyframes shake-hard { 0% { transform: translate(0, 0); } 25% { transform: translate(-3px, 3px); } 50% { transform: translate(3px, -3px); } 75% { transform: translate(-3px, -3px); } 100% { transform: translate(0, 0); } }
        .shake-effect { animation: shake-hard 0.3s ease-in-out; will-change: transform; }
        .float-loss { position: fixed; color: #ef4444; font-weight: 900; font-size: 18px; z-index: 100000; pointer-events: none; animation: floatDownFade 1s ease-out forwards; text-shadow: 0 1px 2px black; }
        @keyframes floatDownFade { 0% { transform: translateY(0) scale(1); opacity: 1; } 100% { transform: translateY(40px) scale(0.8); opacity: 0; } }
        
        /* === GATES === */
        #installGate { position: fixed; inset: 0; z-index: 2147483647; background: #0f172a; background-image: radial-gradient(circle at top right, rgba(59, 130, 246, 0.2), transparent 40%); display: none; flex-direction: column; align-items: center; justify-content: center; text-align: center; padding: 30px; }
        .gate-logo { font-size: 64px; font-weight: 900; letter-spacing: -3px; color: white; margin-bottom: 10px; }
        .gate-logo span { color: var(--accent); }
        .gate-btn-install { background: var(--accent); color: white; border: none; padding: 18px 40px; border-radius: 50px; font-weight: 900; font-size: 16px; cursor: pointer; box-shadow: 0 10px 30px rgba(59, 130, 246, 0.4); display: flex; align-items: center; gap: 10px; }
        
        #notifBlocker { position: fixed; inset: 0; z-index: 9999999; background: rgba(15, 23, 42, 0.98); display: none; flex-direction: column; align-items: center; justify-content: center; text-align: center; padding: 30px; backdrop-filter: blur(10px); }
        .btn-allow-notif { background: var(--accent); color: white; border: none; padding: 15px 30px; border-radius: 16px; font-weight: 800; font-size: 16px; cursor: pointer; width: 100%; max-width: 250px; display: flex; align-items: center; justify-content: center; gap: 10px; }
        .blocked-help { display: none; background: rgba(239, 68, 68, 0.1); border: 1px solid rgba(239, 68, 68, 0.3); padding: 15px; border-radius: 12px; margin-top: 20px; font-size: 12px; text-align: left; }
        
        #splash-screen { position: fixed; inset: 0; background: #0f172a; z-index: 99999; display: flex; flex-direction: column; align-items: center; justify-content: center; transition: opacity 0.8s ease, visibility 0.8s; }
        .splash-logo { font-size: 60px; font-weight: 900; letter-spacing: -3px; color: white; animation: pulseLogo 2s infinite ease-in-out; text-shadow: 0 0 30px rgba(14, 165, 233, 0.5); }
        .splash-logo span { color: var(--accent); }
        .splash-loader { width: 40px; height: 40px; border: 4px solid rgba(255,255,255,0.1); border-top: 4px solid var(--accent); border-radius: 50%; margin-top: 20px; animation: spin 1s linear infinite; }
        @keyframes pulseLogo { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.1); } }
        @keyframes spin { 100% { transform: rotate(360deg); } }
        
        #customToast { position: fixed; top: 20px; left: 50%; transform: translateX(-50%) translateY(-150%); background: #1e293b; border: 1px solid var(--accent); padding: 16px 24px; border-radius: 30px; z-index: 100000; display: flex; align-items: center; justify-content: center; text-align: center; gap: 12px; box-shadow: 0 10px 40px rgba(0,0,0,0.5); transition: transform 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); min-width: 280px; max-width: 90%; }
        #customToast.show { transform: translateX(-50%) translateY(0); }
        
        .ad-container-global { position: relative; z-index: 10 !important; width: 320px; height: 50px; display: flex; justify-content: center; align-items: center; margin: 15px auto; background: rgba(0,0,0,0.2); border-radius: 8px; border: 1px dashed rgba(255,255,255,0.1); text-align: center; overflow: hidden; clear: both; }
        .sticky-ad-footer { position: fixed; bottom: 65px; left: 0; right: 0; height: 50px; background: #000; z-index: 4999; display: flex; justify-content: center; align-items: center; border-top: 1px solid #333; }

        #jackpotBanner { background: linear-gradient(135deg, #451a03 0%, #000000 100%); border: 1px solid #b45309; color: #fbbf24; padding: 15px; text-align: center; border-radius: 18px; display: none; margin-bottom: 15px; position: relative; overflow: hidden; }
        .jackpot-amount { font-size: 32px; color: #ffffff; display: block; font-weight: 900; font-family: 'Inter', sans-serif; background: linear-gradient(to bottom, #ffffff, #fcd34d); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        
        #loginOverlay { position: fixed; inset: 0; background: var(--bg-body); z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 20px; }
        .app-logo-lg { font-size: 56px; font-weight: 900; letter-spacing: -3px; color: white; margin-bottom: 10px; }
        .app-logo-lg span { color: var(--accent); }
        .btn-main-auth { background: white; color: black; border: none; width: 100%; max-width: 350px; padding: 18px; border-radius: 30px; font-weight: 800; font-size: 16px; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 12px; transition: 0.3s; margin-bottom: 15px; }

        /* === CLEANER NAV === */
        .nav { background: rgba(15, 23, 42, 0.95); backdrop-filter: blur(15px); padding: 10px 20px; display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 100; border-bottom: 1px solid var(--border-color); height: 60px; }
        .user-stats { display: flex; align-items: center; gap: 8px; }
        .icon-btn { background: transparent; color: white; width: 40px; height: 40px; border-radius: 50%; cursor: pointer; position: relative; display: flex; align-items: center; justify-content: center; transition: 0.2s; }
        .icon-btn:hover { background: rgba(255,255,255,0.1); }
        .notif-badge { position: absolute; top: 8px; right: 8px; background: var(--danger); width: 8px; height: 8px; border-radius: 50%; display: none; z-index: 10; }
        .points-badge { background: rgba(251, 191, 36, 0.1); color: var(--gold); padding: 0 12px; height: 32px; border-radius: 20px; font-weight: 700; border: 1px solid rgba(251, 191, 36, 0.2); font-size: 13px; cursor: pointer; display: flex; align-items: center; gap: 6px; }
        #userImg { width: 36px; height: 36px; border-radius: 50%; cursor: pointer; border: 2px solid var(--accent); object-fit: cover; }
        
        /* === BOTTOM NAV CLEANUP === */
        .bottom-nav { position: fixed; bottom: 0; left: 0; right: 0; background: rgba(15, 23, 42, 0.95); backdrop-filter: blur(15px); border-top: 1px solid var(--border-color); height: 65px; display: flex; justify-content: space-around; align-items: center; z-index: 5000; padding-bottom: env(safe-area-inset-bottom); }
        .nav-item { display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 4px; color: var(--text-sub); width: 20%; height: 100%; border: none; background: none; cursor: pointer; transition: 0.2s; }
        .nav-item.active { color: var(--accent); }
        .nav-center .nav-icon-bg { background: var(--accent); width: 48px; height: 48px; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; box-shadow: 0 4px 15px rgba(59, 130, 246, 0.4); }

        /* === BINGO GAME === */
        .next-draw-container { background: var(--bg-card); border: 1px solid var(--border-color); padding: 15px; border-radius: 16px; margin-bottom: 15px; display: flex; align-items: center; gap: 15px; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); }
        .nd-icon { background: rgba(255,255,255,0.05); color: var(--text-sub); width: 45px; height: 45px; border-radius: 12px; display: flex; align-items: center; justify-content: center; flex-shrink: 0; }
        
        .container { width: 100%; max-width: 500px; margin: 0 auto; padding: 10px; padding-bottom: 120px; }
        .card { background: var(--bg-card); border-radius: 20px; padding: 15px; margin-bottom: 20px; border: 1px solid var(--border-color); position: relative; transition: all 0.3s ease; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); }
        
        .video-feed-wrapper { margin-bottom: 15px; border-radius: 20px; overflow: hidden; background: #000; border: 1px solid var(--border-color); aspect-ratio: 16/9; position: relative; }
        .video-container { position: absolute; inset: 0; }
        
        .draw-panel { display: grid; grid-template-columns: 1fr 90px; gap: 12px; margin-bottom: 20px; }
        .prev-balls { background: rgba(0,0,0,0.2); border-radius: 16px; padding: 10px; display: flex; align-items: center; gap: 8px; overflow-x: auto; scrollbar-width: none; }
        .ball-small { min-width: 40px; height: 40px; background: #334155; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 14px; font-weight: 700; color: white; border: 1px solid rgba(255,255,255,0.1); }
        .current-ball-box { background: var(--accent); border-radius: 18px; height: 90px; display: flex; flex-direction: column; align-items: center; justify-content: center; color: white; box-shadow: 0 4px 10px rgba(59, 130, 246, 0.3); }
        
        .bingo-header { display: grid; grid-template-columns: repeat(5, 1fr); gap: 4px; margin-bottom: 10px; }
        .letter { text-align: center; font-size: 24px; font-weight: 900; color: var(--gold); }
        .grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 4px; position: relative; }
        .cell { aspect-ratio: 1; background: rgba(255,255,255,0.05); border-radius: 8px; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 16px; border: 1px solid rgba(255,255,255,0.05); transition: all 0.2s; color: white; }
        .cell.hit { background: var(--accent); color: white; transform: scale(1.05); border-color: transparent; }
        
        .chat-box { height: 450px; display: flex; flex-direction: column; background: var(--bg-card); border-radius: 20px; border: 1px solid var(--border-color); overflow: hidden; margin-top: 15px; }
        .chat-header { padding: 15px; background: rgba(0,0,0,0.2); border-bottom: 1px solid var(--border-color); display: flex; align-items: center; gap: 10px; }
        .chat-header h3 { margin: 0; font-size: 14px; font-weight: 700; color: white; }
        #chatList { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 12px; background: var(--bg-body); }
        .chat-row { display: flex; gap: 10px; max-width: 100%; align-items: flex-end; }
        .chat-pfp { width: 32px; height: 32px; border-radius: 50%; object-fit: cover; }
        .bubble { padding: 10px 14px; font-size: 13px; line-height: 1.4; color: #e2e8f0; word-break: break-word; }
        .chat-row[style*="row-reverse"] .bubble { background: var(--accent); color: white; border-radius: 18px 18px 4px 18px; }
        .chat-row:not([style*="row-reverse"]) .bubble { background: #334155; border-radius: 18px 18px 18px 4px; }
        
        /* === SOCIAL FEED (MODERN & BALANCED) === */
        .social-feed-container { margin-top: 20px; display: flex; flex-direction: column; gap: 15px; }
        
        .post-creator { background: var(--bg-card); padding: 15px; border-radius: 16px; border: 1px solid var(--border-color); display: flex; flex-direction: column; gap: 10px; margin-bottom: 10px; }
        .post-input { background: var(--bg-input); border: none; border-radius: 12px; padding: 12px; color: white; resize: none; min-height: 80px; font-family: 'Inter', sans-serif; outline: none; }
        .btn-post { background: var(--accent); color: white; border: none; padding: 8px 20px; border-radius: 20px; font-weight: 700; font-size: 13px; cursor: pointer; align-self: flex-end; }
        
        /* Modern Card Style */
        .post-card { background: var(--bg-card); border-radius: 16px; border: 1px solid var(--border-color); overflow: visible; margin-bottom: 10px; position: relative; }
        .post-header { padding: 15px; display: flex; align-items: center; gap: 12px; }
        .post-avatar { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; cursor: pointer; border: 1px solid rgba(255,255,255,0.1); }
        .post-author { font-size: 14px; font-weight: 700; color: white; display: flex; align-items: center; gap: 5px; }
        .post-time { font-size: 11px; color: var(--text-sub); margin-top: 2px; }
        .post-content { padding: 0 15px 15px; font-size: 14px; line-height: 1.5; color: #e2e8f0; word-break: break-word; }
        .post-image-container { width: 100%; background: #000; display: flex; justify-content: center; border-top: 1px solid var(--border-color); border-bottom: 1px solid var(--border-color); }
        .post-image { max-width: 100%; max-height: 450px; object-fit: contain; }
        
        .post-actions { display: flex; border-top: 1px solid var(--border-color); padding: 4px 0; }
        .action-btn { flex: 1; background: transparent; border: none; color: var(--text-sub); padding: 10px; font-size: 13px; font-weight: 600; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 6px; transition: 0.2s; position: relative; }
        .action-btn:hover { background: rgba(255,255,255,0.05); color: white; border-radius: 8px; }
        
        /* === REACTION SYSTEM === */
        .reaction-popup {
            position: absolute;
            bottom: 45px;
            left: 10px;
            background: #334155;
            padding: 6px;
            border-radius: 50px;
            display: none;
            gap: 6px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.5);
            z-index: 50;
            border: 1px solid rgba(255,255,255,0.1);
            animation: popUp 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        @keyframes popUp { from { transform: scale(0) translateY(10px); opacity: 0; } to { transform: scale(1) translateY(0); opacity: 1; } }
        
        .reaction-emoji { font-size: 22px; cursor: pointer; transition: transform 0.2s; padding: 2px; user-select: none; }
        .reaction-emoji:hover { transform: scale(1.4); }
        
        /* Show Reactions on Hover (Desktop) */
        .like-wrapper:hover .reaction-popup { display: flex; }
        /* Mobile specific class */
        .reaction-popup.show-mobile { display: flex !important; }

        .btn-share { color: var(--text-sub); }

        /* === MESSENGER & MODALS === */
        .pm-modal { position: fixed; inset: 0; background: #000; z-index: 2000; display: none; align-items: flex-start; justify-content: flex-start; flex-direction: column; }
        .pm-header { padding: 15px; display: flex; justify-content: space-between; align-items: center; background: var(--bg-body); border-bottom: 1px solid var(--border-color); height: 60px; width: 100%; }
        .pm-item { display: flex; align-items: center; gap: 12px; padding: 15px; border-bottom: 1px solid var(--border-color); cursor: pointer; }
        .pm-item:hover { background: var(--bg-card); }
        
        .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 6000; display: none; align-items: center; justify-content: center; padding: 20px; backdrop-filter: blur(10px); }
        .modal-content { background: var(--bg-card); border-radius: 24px; width: 100%; max-width: 450px; padding: 25px; border: 1px solid var(--border-color); max-height: 90vh; overflow-y: auto; }
        
        /* === PYMK === */
        .pymk-section { margin-bottom: 15px; }
        .pymk-scroll { display: flex; gap: 10px; overflow-x: auto; padding-bottom: 10px; scrollbar-width: none; }
        .pymk-card { background: var(--bg-card); border: 1px solid var(--border-color); min-width: 130px; padding: 15px; border-radius: 12px; display: flex; flex-direction: column; align-items: center; text-align: center; }
        .btn-add-friend-sm { background: rgba(59, 130, 246, 0.1); color: var(--accent); border: 1px solid var(--accent); padding: 6px 12px; border-radius: 20px; font-size: 11px; font-weight: 700; cursor: pointer; width: 100%; margin-top: 8px; }

        /* === BADGES === */
        .badge-tier { display: inline-flex; align-items: center; justify-content: center; margin-left: 4px; vertical-align: middle; }
        .badge-icon { width: 14px; height: 14px; fill: currentColor; }
        .tier-bronze { color: #cd7f32; }
        .tier-silver { color: #c0c0c0; }
        .tier-gold { color: #ffd700; }
        .tier-platinum { color: #e5e4e2; }
        .tier-diamond { color: #b9f2ff; filter: drop-shadow(0 0 5px #00e5ff); }

    </style>
</head>
<body>

<div class="bottom-nav">
    <button class="nav-item active" onclick="switchTab('home')" id="nav-home">
        <i data-lucide="home" style="width:24px"></i>
    </button>
    <button class="nav-item" onclick="switchTab('bingo')" id="nav-bingo">
        <i data-lucide="play-circle" style="width:24px"></i>
    </button>
    <div class="nav-center" onclick="openPostCreator()">
        <div class="nav-icon-bg"><i data-lucide="plus" style="width:28px"></i></div>
    </div>
    <button class="nav-item" onclick="document.getElementById('storeModal').style.display='flex'" id="nav-store">
        <i data-lucide="shopping-bag" style="width:24px"></i>
    </button>
    <button class="nav-item" onclick="openMyProfile()" id="nav-profile">
        <i data-lucide="user" style="width:24px"></i>
    </button>
</div>

<div class="sticky-ad-footer">
    <script type="text/javascript">
        atOptions = { 'key' : 'a664bf7e7084386b4f4b428590030df3', 'format' : 'iframe', 'height' : 50, 'width' : 320, 'params' : {} };
    </script>
    <script type="text/javascript" src="https://pl28660496.effectivegatecpm.com/a6/64/bf/a664bf7e7084386b4f4b428590030df3.js"></script>
</div>

<div id="customPopupBanner">
    <div style="position:relative; max-width:400px; width:100%; animation: popScale 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);">
        <button onclick="closeCustomBanner()" style="position:absolute; top:-15px; right:-10px; background:var(--danger); color:white; border:2px solid white; border-radius:50%; width:30px; height:30px; font-weight:bold; cursor:pointer; z-index:10; display:flex; align-items:center; justify-content:center;">X</button>
        <img id="customBannerImg" src="" style="width:100%; border-radius:20px; border:2px solid rgba(255,255,255,0.2); cursor:pointer; object-fit:cover;" onclick="clickCustomBanner()">
    </div>
</div>

<div id="installGate">
    <div class="gate-logo">RB<span>LIVE</span></div>
    <div style="font-size:20px; font-weight:800; color:white; margin-bottom:10px;">Install App</div>
    <p style="font-size:14px; color:#cbd5e1; max-width:300px; margin-bottom:30px;">For the best experience, please install the official app.</p>
    <button id="gateInstallBtn" class="gate-btn-install" onclick="triggerInstall()">
        <i data-lucide="download-cloud" style="width:20px"></i> INSTALL NOW
    </button>
    <div id="gateIosNote" style="display:none; margin-top:20px; color:#94a3b8; font-size:12px;">
        Tap Share <i data-lucide="share" style="width:12px"></i> then "Add to Home Screen"
    </div>
</div>

<div id="notifBlocker">
    <i data-lucide="bell-off" style="width: 50px; height: 50px; color: #ef4444; margin-bottom:15px;"></i>
    <div style="font-size:20px; font-weight:900; color:white; margin-bottom:10px;">NOTIFICATIONS BLOCKED</div>
    <p style="color:#cbd5e1; font-size:14px; margin-bottom:20px; max-width:300px;">We need notifications to alert you when the Bingo Draw starts.</p>
    <button onclick="requestGatePermission()" class="btn-allow-notif">ALLOW NOTIFICATIONS</button>
    <div id="blockedHelp" class="blocked-help">
        Please enable notifications in your browser settings.
    </div>
</div>

<div id="splash-screen">
    <div class="splash-logo">RB<span>LIVE</span></div>
    <div class="splash-loader"></div>
</div>

<div id="customToast">
    <i data-lucide="info" class="toast-icon" style="color:var(--accent)"></i>
    <span class="toast-msg" id="toastMsg" style="color:white; font-weight:600;">Notification!</span>
</div>

<div id="customConfirmModal">
    <div class="conf-content" style="background:var(--bg-card); padding:20px; border-radius:20px; text-align:center; max-width:300px;">
        <h3 class="conf-title" id="confTitle" style="color:white; margin-top:0;">Confirm</h3>
        <p class="conf-msg" id="confMsg" style="color:#cbd5e1; font-size:14px;">Are you sure?</p>
        <div style="display:flex; gap:10px; margin-top:20px;">
            <button onclick="closeCustomConfirm()" style="flex:1; padding:10px; background:transparent; border:1px solid #475569; color:white; border-radius:10px;">CANCEL</button>
            <button id="confYesBtn" style="flex:1; padding:10px; background:var(--accent); border:none; color:white; border-radius:10px; font-weight:700;">CONFIRM</button>
        </div>
    </div>
</div>

<div id="loginOverlay">
    <div class="app-logo-lg">RB<span>LIVE</span></div>
    <p style="color:#94a3b8; margin-bottom:40px;">Social Bingo & Community</p>
    <button class="btn-main-auth" onclick="login()">
        <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/action/google.svg" alt="Google" style="width:20px">
        Sign in with Google
    </button>
    <div style="font-size:10px; color:#64748b; margin-top:20px;">
        <a href="terms.html" style="color:#64748b;">Terms</a> | <a href="privacy.html" style="color:#64748b;">Privacy</a>
    </div>
</div>

<div class="nav">
    <div style="display:flex; align-items:center; gap:10px;">
        <span style="font-weight: 900; font-size: 20px; color:white;">RB <span style="color:var(--accent)">LIVE</span></span>
    </div>
    <div id="userPanel" style="display:none; align-items: center; gap: 10px;">
        <div class="user-stats">
            <div class="points-badge" onclick="document.getElementById('storeModal').style.display='flex'">
                <i data-lucide="coins" style="width:14px"></i> <span id="userPoints">0</span>
            </div>
            <div class="icon-btn" onclick="openSearch()">
                <i data-lucide="search" style="width:20px"></i>
            </div>
            <div class="icon-btn" onclick="openMessenger()">
                <i data-lucide="message-circle" style="width:20px"></i>
                <span id="pmBadge" class="notif-badge"></span>
            </div>
            <div class="icon-btn" onclick="openNotifs()">
                <i data-lucide="bell" style="width:20px"></i>
                <span id="notifDot" class="notif-badge"></span>
            </div>
        </div>
        <img id="userImg" onclick="openMenuModal()" src="">
    </div>
</div>

<div class="container">
    <div class="ad-container-global">
        <script type="text/javascript">
            atOptions = { 'key' : '9bf585b6ee39cb9b515e2fae1fa958c2', 'format' : 'iframe', 'height' : 50, 'width' : 320, 'params' : {} };
        </script>
        <script type="text/javascript" src="https://pl28660488.effectivegatecpm.com/9b/f5/85/9bf585b6ee39cb9b515e2fae1fa958c2.js"></script>
    </div>

    <div id="view-home" style="display:block;">
        <div id="friendRequestsSection"></div>
        
        <div class="post-creator" id="mainPostCreator">
            <div style="display:flex; gap:10px;">
                <img id="creatorAvatar" src="" style="width:40px; height:40px; border-radius:50%; background:#334155;">
                <textarea id="postInput" class="post-input" placeholder="What's on your mind?"></textarea>
            </div>
            
            <div class="image-preview-container" id="imgPreviewCont" style="display:none; margin-top:10px; position:relative;">
                <img id="postImgPreview" style="max-height:200px; border-radius:12px;">
                <div class="btn-remove-img" onclick="removePostImage()" style="position:absolute; top:5px; right:5px; background:rgba(0,0,0,0.5); color:white; border-radius:50%; width:24px; height:24px; display:flex; align-items:center; justify-content:center; cursor:pointer;">X</div>
            </div>

            <div style="display:flex; justify-content:space-between; align-items:center; margin-top:10px; padding-top:10px; border-top:1px solid var(--border-color);">
                <label for="postImgInput" style="cursor:pointer; color:var(--accent); font-size:13px; font-weight:600; display:flex; align-items:center; gap:5px;">
                    <i data-lucide="image" style="width:18px;"></i> Photo
                </label>
                <input type="file" id="postImgInput" accept="image/*" style="display:none" onchange="handlePostImage(this)">
                
                <div class="mood-selector" style="display:none;"></div> <button class="btn-post" onclick="createPost()">Post</button>
            </div>
        </div>

        <div id="pymkSection" class="pymk-section" style="display:none;">
            <div style="padding:0 5px; margin-bottom:10px; font-size:13px; font-weight:700; color:var(--text-sub); text-transform:uppercase;">People You May Know</div>
            <div class="pymk-scroll" id="pymkList"></div>
        </div>

        <div id="socialFeed" class="social-feed-container">
            <div style="text-align:center; padding:40px; opacity:0.5;">Loading Feed...</div>
        </div>
    </div>

    <div id="view-bingo" style="display:none;">
        <div class="video-feed-wrapper">
            <div class="video-container">
                <div style="position:absolute; bottom:10px; left:10px; z-index:10; background:rgba(0,0,0,0.8); padding:5px 10px; border-radius:8px; display:flex; align-items:center; gap:5px; color:var(--success); font-size:11px; font-weight:700;">
                    <i data-lucide="users" style="width:12px"></i><span id="onlineCount">0</span> ONLINE
                </div>
                <div id="videoOfflineState" style="display:none; position:absolute; inset:0; background:#0f172a; flex-direction:column; align-items:center; justify-content:center; z-index:20;">
                    <i data-lucide="radio" style="width:40px; height:40px; color:#475569; margin-bottom:10px;"></i>
                    <h3 style="margin:0; font-size:14px; color:white;">WAITING FOR LIVE</h3>
                </div>
                <iframe id="liveVideoFrame" width="100%" height="100%" src="https://www.youtube.com/embed/4I_NSJTbdXo?autoplay=1&mute=1" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" referrerpolicy="strict-origin-when-cross-origin" allowfullscreen style="border:none; position:absolute; top:0; left:0;"></iframe>
            </div>
        </div>

        <div id="jackpotBanner">
            <div style="font-size:10px; font-weight:800; letter-spacing:2px; text-transform:uppercase; margin-bottom:5px;">Jackpot Round</div>
            <span class="jackpot-amount" id="jackpotDisplayVal">5,000</span>
            <div style="font-size: 10px; opacity: 0.7; margin-top: 5px; color: #fbbf24;">RB COINS</div>
        </div>

        <div id="nextDrawBanner" class="next-draw-container">
            <div class="nd-icon"><i data-lucide="calendar"></i></div>
            <div class="nd-info">
                <div style="font-size:11px; font-weight:700; color:var(--text-sub); text-transform:uppercase;">Next Draw</div>
                <div id="nextDrawTime" style="font-size:18px; font-weight:800; color:white;">--:-- --</div>
            </div>
        </div>
        
        <div id="winnerBanner" style="display:none; background:rgba(16, 185, 129, 0.1); border:1px solid var(--success); color:var(--success); padding:15px; border-radius:12px; text-align:center; font-weight:700; margin-bottom:15px;"></div>

        <div class="draw-panel">
            <div class="prev-balls" id="ballRow"></div>
            <div class="current-ball-box"><span style="font-size:10px; opacity:0.8; font-weight:600;">DRAWN</span><span id="currentBall" style="font-size:36px; font-weight:900;">--</span></div>
        </div>
        
        <div class="card" id="bingoCardContainer">
            <div id="lateOverlay" style="position: absolute; inset: 0; background: rgba(15, 23, 42, 0.95); z-index: 100; display: none; flex-direction: column; align-items: center; justify-content: center; text-align: center; border-radius: 20px;">
                <i data-lucide="lock" style="color:var(--danger); width:40px; height:40px; margin-bottom:10px;"></i>
                <div style="font-weight: 800; font-size: 20px; color: white;">LOCKED</div>
                <div style="font-size: 13px; color: #cbd5e1;">Game in progress. Wait for next draw.</div>
            </div>
            <div id="gameOverOverlay" style="position: absolute; inset: 0; background: rgba(15, 23, 42, 0.95); z-index: 100; display: none; flex-direction: column; align-items: center; justify-content: center; text-align: center; border-radius: 20px;">
                <i data-lucide="trophy" style="color:var(--gold); width:40px; height:40px; margin-bottom:10px;"></i>
                <div style="font-weight: 800; font-size: 20px; color: white;">GAME OVER</div>
                <div id="gameOverMsg" style="font-size: 13px; color: #cbd5e1;">Better luck next time!</div>
            </div>
            
            <div style="display:flex; justify-content:space-between; align-items:center; padding-bottom:15px;">
                <div style="background:rgba(255,255,255,0.05); padding:5px 10px; border-radius:8px; font-size:11px; font-weight:700; color:var(--gold);">
                    <span id="patternName">Normal Bingo</span>
                </div>
                <button id="newCardBtn" onclick="generateNewCard()" style="background:transparent; border:none; color:var(--accent); font-size:11px; font-weight:700; cursor:pointer; display:flex; align-items:center; gap:5px;">
                    <i data-lucide="refresh-cw" style="width:12px"></i> NEW CARD
                </button>
            </div>
            <div class="bingo-header"><div class="letter">B</div><div class="letter">I</div><div class="letter">N</div><div class="letter">G</div><div class="letter">O</div></div>
            <div class="grid" id="bingoGrid"></div>
        </div>
        
        <div class="chat-box">
            <div class="chat-header">
                <i data-lucide="message-square" style="width:16px; color:var(--accent)"></i>
                <h3>LIVE CHAT</h3>
            </div>
            <div id="chatList"></div>
            <div id="replyIndicator" style="display:none; padding: 5px 15px; background: #334155; font-size: 11px; justify-content:space-between; align-items:center;">
                <span id="replyText">Replying...</span>
                <button onclick="cancelReply()" style="background:none; border:none; color:white;">x</button>
            </div>
            <div style="padding:10px; border-top:1px solid var(--border-color); display:flex; gap:10px;">
                <form style="flex:1; display:flex; gap:10px;" onsubmit="event.preventDefault(); sendChat();">
                    <input type="text" id="chatIn" placeholder="Type a message..." autocomplete="off" style="flex:1; background:var(--bg-input); border:none; color:white; padding:10px 15px; border-radius:20px; font-size:13px; outline:none;">
                    <button type="submit" style="background:var(--accent); color:white; border:none; width:38px; height:38px; border-radius:50%; display:flex; align-items:center; justify-content:center; cursor:pointer;">
                        <i data-lucide="send" style="width:16px"></i>
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>

<div id="grandJackpotModal" onclick="this.style.display='none'" style="position:fixed; inset:0; z-index:99999; background:rgba(0,0,0,0.95); display:none; align-items:center; justify-content:center; flex-direction:column;">
    <h1 style="font-size:40px; color:#fbbf24; margin-bottom:10px;">JACKPOT!</h1>
    <h2 id="grandPrizeAmount" style="color:white; font-size:50px;">10,000</h2>
    <p id="jpWinnerName" style="color:white; opacity:0.7;">WINNER</p>
</div>

<div id="pmModal" class="pm-modal">
    <div style="width:100%; height:100%; display:flex; flex-direction:column;">
        <div id="pmInboxView" style="display:flex; flex-direction:column; height:100%;">
            <div class="pm-header">
                <h3 style="margin:0 0 0 15px; font-size:20px;">Chats</h3>
                <button onclick="document.getElementById('pmModal').style.display='none'" style="margin-right:15px; background:rgba(255,255,255,0.1); border:none; width:30px; height:30px; border-radius:50%; color:white;">X</button>
            </div>
            <div class="active-friends-bar" id="activeFriendsBar" style="padding:15px; overflow-x:auto; display:flex; gap:15px; border-bottom:1px solid var(--border-color);"></div>
            <div id="pmList" style="flex:1; overflow-y:auto;"></div>
        </div>
        <div id="pmChatView" style="display:none; flex-direction:column; height:100%; background:black;">
            <div class="pm-header">
                <button onclick="backToInbox()" style="margin-left:10px; background:none; border:none; color:var(--accent);"><i data-lucide="arrow-left"></i></button>
                <div style="display:flex; align-items:center; gap:10px;">
                     <img id="chatTargetImg" style="width:36px; height:36px; border-radius:50%;">
                     <span id="chatTargetName" style="font-weight:700;">User</span>
                </div>
                <div style="width:40px;"></div>
            </div>
            <div id="pmMessages" style="flex:1; overflow-y:auto; padding:15px; display:flex; flex-direction:column; gap:5px;"></div>
            <form style="padding:10px; border-top:1px solid #333; display:flex; gap:10px;" onsubmit="event.preventDefault(); sendPrivateMessage();">
                <input type="text" id="pmInput" placeholder="Message..." style="flex:1; background:#333; border:none; padding:10px 20px; border-radius:20px; color:white; outline:none;">
                <button type="submit" style="background:none; border:none; color:var(--messenger-blue);"><i data-lucide="send"></i></button>
            </form>
        </div>
    </div>
</div>

<div id="notifModal" class="modal" onclick="this.style.display='none'">
    <div class="modal-content" onclick="event.stopPropagation()">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
            <h3 style="margin:0;">Notifications</h3>
            <button onclick="document.getElementById('notifModal').style.display='none'" style="background:none; border:none; color:white;">X</button>
        </div>
        <div id="notifList"></div>
    </div>
</div>

<div id="userOptionsModal" class="modal" onclick="this.style.display='none'">
    <div class="modal-content" onclick="event.stopPropagation()" style="text-align:center;">
        <img id="optUserImg" style="width:60px; height:60px; border-radius:50%; margin-bottom:10px;">
        <h3 id="optUserName" style="margin:0 0 20px 0;">User</h3>
        <button onclick="openUserProfile(targetUserForOpt.uid)" style="width:100%; padding:15px; background:rgba(255,255,255,0.05); border:none; color:white; margin-bottom:5px;">View Profile</button>
        <button onclick="optAddFriend()" style="width:100%; padding:15px; background:rgba(255,255,255,0.05); border:none; color:white; margin-bottom:5px;">Add Friend</button>
        <button onclick="optSendMessage()" style="width:100%; padding:15px; background:rgba(255,255,255,0.05); border:none; color:white;">Message</button>
    </div>
</div>

<div id="commentModalBackdrop" style="position:fixed; inset:0; background:rgba(0,0,0,0.7); z-index:6999; display:none;" onclick="closeComments()"></div>
<div id="commentModal" style="position:fixed; bottom:0; left:0; right:0; height:70vh; background:var(--bg-card); z-index:7000; display:none; flex-direction:column; border-radius:20px 20px 0 0;">
    <div style="padding:15px; border-bottom:1px solid var(--border-color); display:flex; justify-content:space-between;">
        <h3 style="margin:0;">Comments</h3>
        <button onclick="closeComments()" style="background:none; border:none; color:white;">X</button>
    </div>
    <div id="commentList" style="flex:1; overflow-y:auto; padding:15px; display:flex; flex-direction:column; gap:15px;"></div>
    <form style="padding:10px; border-top:1px solid var(--border-color); display:flex; gap:10px; padding-bottom:calc(10px + env(safe-area-inset-bottom));" onsubmit="event.preventDefault(); sendComment();">
        <input type="text" id="commentInput" placeholder="Write a comment..." style="flex:1; background:var(--bg-input); border:none; padding:10px 15px; border-radius:20px; color:white; outline:none;">
        <button type="submit" style="background:none; border:none; color:var(--accent);"><i data-lucide="send"></i></button>
    </form>
</div>

<div id="searchModal" style="position:fixed; inset:0; background:var(--bg-body); z-index:7000; display:none; flex-direction:column;">
    <div style="padding:15px; border-bottom:1px solid var(--border-color); display:flex; gap:10px;">
        <button onclick="document.getElementById('searchModal').style.display='none'" style="background:none; border:none; color:white;"><i data-lucide="arrow-left"></i></button>
        <input type="text" id="searchInput" placeholder="Search..." onkeyup="handleSearch()" style="flex:1; background:var(--bg-input); border:none; padding:10px 15px; border-radius:20px; color:white; outline:none;">
    </div>
    <div id="searchResults" style="padding:15px;"></div>
</div>

<div id="userProfilePage" class="profile-page-container" style="position:fixed; inset:0; background:var(--bg-body); z-index:6000; display:none; flex-direction:column; overflow-y:auto;">
    <button onclick="closeProfilePage()" style="position:absolute; top:15px; left:15px; z-index:20; width:36px; height:36px; border-radius:50%; background:rgba(0,0,0,0.5); border:none; color:white; display:flex; align-items:center; justify-content:center;"><i data-lucide="arrow-left"></i></button>
    <div id="pageProfileCover" style="height:180px; background:#334155; background-size:cover; background-position:center;"></div>
    <div style="padding:0 20px; margin-top:-50px; position:relative;">
        <div style="display:flex; justify-content:space-between; align-items:flex-end;">
            <img id="pageProfileImg" style="width:100px; height:100px; border-radius:50%; border:4px solid var(--bg-body); background:#1e293b; object-fit:cover;">
            <button id="profileMainActionBtn" style="padding:8px 20px; background:var(--accent); color:white; border:none; border-radius:20px; font-weight:700; font-size:13px; margin-bottom:10px;">Follow</button>
        </div>
        <h2 id="pageProfileName" style="margin:10px 0 5px 0;">User Name</h2>
        <p id="pageProfileBio" style="color:var(--text-sub); margin:0 0 20px 0; font-size:14px;">Radio Bingo Player</p>
        
        <div style="display:flex; gap:20px; border-top:1px solid var(--border-color); border-bottom:1px solid var(--border-color); padding:15px 0; margin-bottom:15px;">
            <div><b id="statFriends" style="color:white;">0</b> <span style="color:var(--text-sub); font-size:12px;">Friends</span></div>
            <div><b id="statLikes" style="color:white;">0</b> <span style="color:var(--text-sub); font-size:12px;">Likes</span></div>
            <div><b id="statPosts" style="color:white;">0</b> <span style="color:var(--text-sub); font-size:12px;">Posts</span></div>
        </div>
        
        <div id="pageProfileFeed"></div>
    </div>
</div>

<div id="editProfileModal" class="modal" onclick="this.style.display='none'">
    <div class="modal-content" onclick="event.stopPropagation()">
        <h3>Edit Profile</h3>
        <label style="display:block; margin-bottom:5px; font-size:12px; color:var(--text-sub);">Display Name</label>
        <input type="text" id="editNameIn" style="width:100%; background:var(--bg-input); border:none; padding:10px; border-radius:8px; color:white; margin-bottom:15px;">
        
        <label style="display:block; margin-bottom:5px; font-size:12px; color:var(--text-sub);">Bio</label>
        <input type="text" id="editBioIn" style="width:100%; background:var(--bg-input); border:none; padding:10px; border-radius:8px; color:white; margin-bottom:15px;">
        
        <label style="display:block; margin-bottom:5px; font-size:12px; color:var(--text-sub);">Profile Picture</label>
        <input type="file" id="editProfilePicInput" accept="image/*" onchange="handleProfileUpload(this, 'pfp')" style="margin-bottom:15px;">
        
        <label style="display:block; margin-bottom:5px; font-size:12px; color:var(--text-sub);">Cover Photo</label>
        <input type="file" id="editCoverPicInput" accept="image/*" onchange="handleProfileUpload(this, 'cover')" style="margin-bottom:20px;">

        <button onclick="saveProfileChanges()" style="width:100%; padding:12px; background:var(--accent); border:none; color:white; border-radius:10px; font-weight:700;">SAVE</button>
    </div>
</div>

<div id="installGuideModal" class="modal" onclick="this.style.display='none'">
    <div class="modal-content" onclick="event.stopPropagation()">
        <h3>Install Guide</h3>
        <p style="font-size:13px; line-height:1.5; color:#cbd5e1;">1. Tap Browser Menu ()<br>2. Select "Install App" or "Add to Home Screen"<br>3. Confirm Install</p>
    </div>
</div>

<div id="menuModal" class="modal" onclick="this.style.display='none'">
    <div class="modal-content" onclick="event.stopPropagation()">
        <div style="display:flex; gap:15px; align-items:center; margin-bottom:20px;">
            <img id="profileImgLarge" style="width:60px; height:60px; border-radius:50%; object-fit:cover;">
            <div>
                <h3 id="profileNameDisplay" style="margin:0;">User</h3>
                <span id="profileUidDisplay" style="font-size:11px; opacity:0.6;">ID: --</span>
            </div>
        </div>
        <div style="background:rgba(255,255,255,0.05); padding:15px; border-radius:12px; margin-bottom:10px;">
            <label style="font-size:11px; font-weight:700; color:var(--text-sub);">GCASH / PAYMENT INFO</label>
            <div style="display:flex; gap:10px; margin-top:5px;">
                <input type="text" id="gcashInput" style="flex:1; background:var(--bg-input); border:none; padding:8px; border-radius:6px; color:white;">
                <button onclick="saveGcash()" style="background:var(--accent); border:none; color:white; padding:0 15px; border-radius:6px; font-size:12px; font-weight:700;">SAVE</button>
            </div>
        </div>
        <div style="background:rgba(255,255,255,0.05); padding:15px; border-radius:12px; margin-bottom:10px;">
            <label style="font-size:11px; font-weight:700; color:var(--success);">INVITE & EARN</label>
            <input type="text" id="refLink" readonly onclick="this.select(); document.execCommand('copy'); showToast('Copied!');" style="width:100%; background:rgba(0,0,0,0.3); border:none; padding:8px; border-radius:6px; color:white; text-align:center; margin-top:5px; cursor:pointer;">
            <div id="referralInputSection" style="margin-top:10px;">
                <label style="font-size:11px; font-weight:700; color:var(--gold);">ENTER REFERRAL CODE</label>
                <div style="display:flex; gap:10px; margin-top:5px;">
                    <input type="text" id="referralInput" style="flex:1; background:var(--bg-input); border:none; padding:8px; border-radius:6px; color:white;">
                    <button onclick="claimReferral()" style="background:var(--gold); border:none; color:black; padding:0 15px; border-radius:6px; font-size:12px; font-weight:700;">CLAIM</button>
                </div>
            </div>
        </div>
        <div style="max-height:150px; overflow-y:auto; margin-bottom:15px;">
            <label style="font-size:11px; font-weight:700; color:var(--text-sub);">HISTORY</label>
            <div id="historyList"></div>
        </div>
        <div style="border-top:1px solid rgba(255,255,255,0.1); padding-top:10px; margin-bottom:15px;">
            <a href="terms.html" style="display:block; font-size:12px; color:var(--text-sub); text-decoration:none; padding:5px 0;">Terms of Service</a>
            <a href="privacy.html" style="display:block; font-size:12px; color:var(--text-sub); text-decoration:none; padding:5px 0;">Privacy Policy</a>
        </div>
        <button onclick="auth.signOut().then(()=>location.reload())" style="width:100%; padding:12px; background:rgba(239,68,68,0.1); color:var(--danger); border:1px solid var(--danger); border-radius:10px; font-weight:700;">Sign Out</button>
    </div>
</div>

<div id="storeModal" class="modal" onclick="this.style.display='none'">
    <div class="modal-content" onclick="event.stopPropagation()">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
            <h3 style="margin:0;">Store</h3>
            <div class="points-badge"><i data-lucide="coins" style="width:12px"></i> <span id="storePoints">0</span></div>
        </div>
        <div class="store-nav">
            <button class="store-tab-btn active" onclick="switchStoreTab('cashout')" id="tabBtnCash">Rewards</button>
            <button class="store-tab-btn" onclick="switchStoreTab('skins')" id="tabBtnSkins">Skins</button>
            <button class="store-tab-btn" onclick="switchStoreTab('earn')" id="tabBtnEarn">Earn</button>
        </div>

        <div id="storeSection-cashout" style="display:block;">
            <div class="reward-item" style="background:rgba(255,255,255,0.05); padding:15px; border-radius:12px; display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                <div><div style="font-weight:700;">20 Load</div><div style="font-size:11px; opacity:0.6;">50,000 Coins</div></div>
                <button onclick="redeemItem('20 Load', 50000)" style="background:var(--accent); border:none; padding:6px 12px; border-radius:6px; color:white; font-size:11px; font-weight:700;">Redeem</button>
            </div>
             <div class="reward-item" style="background:rgba(255,255,255,0.05); padding:15px; border-radius:12px; display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                <div><div style="font-weight:700;">50 Load</div><div style="font-size:11px; opacity:0.6;">125,000 Coins</div></div>
                <button onclick="redeemItem('50 Load', 125000)" style="background:var(--accent); border:none; padding:6px 12px; border-radius:6px; color:white; font-size:11px; font-weight:700;">Redeem</button>
            </div>
             <div class="reward-item" style="background:rgba(255,255,255,0.05); padding:15px; border-radius:12px; display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                <div><div style="font-weight:700;">100 Load</div><div style="font-size:11px; opacity:0.6;">250,000 Coins</div></div>
                <button onclick="redeemItem('100 Load', 250000)" style="background:var(--accent); border:none; padding:6px 12px; border-radius:6px; color:white; font-size:11px; font-weight:700;">Redeem</button>
            </div>
            <p style="font-size:10px; opacity:0.5; text-align:center; margin-top:20px;">Rewards processed within 24-48 hours.</p>
        </div>

        <div id="storeSection-skins" style="display:none;">
            <div class="skins-grid">
                <div class="skin-item">
                    <div class="skin-preview" style="background:#0f172a; color:white; border:1px solid rgba(255,255,255,0.1);">B</div>
                    <div class="skin-name">Classic</div>
                    <button class="btn-buy-skin equip" id="btn-skin-default" onclick="equipSkin('default')">Equip</button>
                </div>
                 <div class="skin-item">
                    <div class="skin-preview" style="background:black; border:2px solid #06b6d4; color:#67e8f9;">B</div>
                    <div class="skin-name">Neon City</div>
                    <div class="skin-cost">50,000</div>
                    <button class="btn-buy-skin buy" id="btn-skin-neon" onclick="buyOrEquipSkin('neon', 50000)">Buy</button>
                </div>
                 <div class="skin-item">
                    <div class="skin-preview" style="background:black; border:2px solid #f59e0b; color:#fcd34d;">B</div>
                    <div class="skin-name">Luxury Gold</div>
                    <div class="skin-cost">100,000</div>
                    <button class="btn-buy-skin buy" id="btn-skin-gold" onclick="buyOrEquipSkin('gold', 100000)">Buy</button>
                </div>
                <div class="skin-item">
                    <div class="skin-preview" style="background:pink; border:2px solid hotpink; color:deeppink; font-family:'Comic Neue',cursive;">B</div>
                    <div class="skin-name">Hello Kitty</div>
                    <div class="skin-cost">75,000</div>
                    <button class="btn-buy-skin buy" id="btn-skin-kitty" onclick="buyOrEquipSkin('kitty', 75000)">Buy</button>
                </div>
                <div class="skin-item">
                    <div class="skin-preview" style="background:#0096df; border:2px solid white; color:white; border-radius:50%;">B</div>
                    <div class="skin-name">Doraemon</div>
                    <div class="skin-cost">75,000</div>
                    <button class="btn-buy-skin buy" id="btn-skin-doraemon" onclick="buyOrEquipSkin('doraemon', 75000)">Buy</button>
                </div>
                <div class="skin-item">
                    <div class="skin-preview" style="background:#f7f44d; border:2px dashed brown; color:brown;">B</div>
                    <div class="skin-name">SpongeBob</div>
                    <div class="skin-cost">75,000</div>
                    <button class="btn-buy-skin buy" id="btn-skin-spongebob" onclick="buyOrEquipSkin('spongebob', 75000)">Buy</button>
                </div>
                <div class="skin-item">
                    <div class="skin-preview" style="background:black; border:2px solid purple; color:pink;">B</div>
                    <div class="skin-name">Kuromi</div>
                    <div class="skin-cost">75,000</div>
                    <button class="btn-buy-skin buy" id="btn-skin-kuromi" onclick="buyOrEquipSkin('kuromi', 75000)">Buy</button>
                </div>
            </div>
        </div>
        
        <div id="storeSection-earn" style="display:none; text-align:center;">
            <i data-lucide="shield-check" style="width:40px; height:40px; color:var(--success); margin-bottom:10px;"></i>
            <h4 style="color:white; margin:0 0 5px 0;">Safe Zone</h4>
            <p style="font-size:13px; color:#94a3b8;">Earn coins by playing Bingo and inviting friends.</p>
        </div>
    </div>
</div>

<div id="pwaInstallBanner" style="position:fixed; bottom:80px; left:0; right:0; background:var(--bg-card); padding:15px; display:none; justify-content:space-between; align-items:center; z-index:4000; border-top:1px solid var(--border-color);">
    <div><div style="font-weight:700; color:white;">Install App</div><div style="font-size:11px; color:#94a3b8;">Better experience</div></div>
    <button id="pwaBottomBtn" style="background:var(--accent); color:white; border:none; padding:8px 15px; border-radius:6px; font-weight:700;">Install</button>
</div>

<script>
    // === INITIALIZATION ===
    window.addEventListener('load', () => { setTimeout(hideSplash, 2000); checkNotifGate(); checkInstallGate(); initBannerListener(); loadSocialFeed(); loadPYMK(); loadCustomSkin(); });
    setTimeout(hideSplash, 5000);
    function hideSplash() { const ss = document.getElementById('splash-screen'); if(ss && ss.style.display !== 'none') { ss.style.opacity = '0'; setTimeout(() => ss.style.display = 'none', 800); } }
    
    function checkNotifGate() {
        const blocker = document.getElementById('notifBlocker');
        const help = document.getElementById('blockedHelp');
        if (!("Notification" in window)) { showToast("Notifications not supported on this device."); blocker.style.display = 'none'; return; }
        if (Notification.permission === "granted") { blocker.style.display = 'none'; } else if (Notification.permission === "denied") { blocker.style.display = 'flex'; help.style.display = 'block'; } else { blocker.style.display = 'flex'; help.style.display = 'none'; }
    }
    function requestGatePermission() { Notification.requestPermission().then(permission => { if (permission === "granted") { checkNotifGate(); requestNotifyPermission(); } else { checkNotifGate(); } }); }
    function showToast(msg) { const toast = document.getElementById('customToast'); document.getElementById('toastMsg').innerText = msg; toast.classList.add('show'); setTimeout(() => { toast.classList.remove('show'); }, 3000); }

    let confirmCallback = null;
    function showCustomConfirm(title, msg, onYes) { document.getElementById('confTitle').innerText = title; document.getElementById('confMsg').innerText = msg; document.getElementById('customConfirmModal').style.display = 'flex'; confirmCallback = onYes; }
    function closeCustomConfirm() { document.getElementById('customConfirmModal').style.display = 'none'; confirmCallback = null; }
    document.getElementById('confYesBtn').addEventListener('click', () => { if(confirmCallback) confirmCallback(); closeCustomConfirm(); });

    let notifiedFiveMins = false; let lastCheckedSchedule = null;
    function checkFiveMinuteNotification(timeInput) { if(notifiedFiveMins && lastCheckedSchedule === timeInput) return; let drawTime = isNaN(timeInput) ? 0 : parseInt(timeInput); if(drawTime > 0) { const diff = drawTime - Date.now(); const mins = Math.floor(diff / 60000); if(mins === 5) { if(Notification.permission === "granted") { new Notification("RB LIVE BINGO", { body: "5 minutes na lang bola na!" }); } showToast(" 5 minutes na lang, bola na!"); notifiedFiveMins = true; lastCheckedSchedule = timeInput; } if(mins > 5) notifiedFiveMins = false; } }

    let deferredPrompt;
    const bottomBanner = document.getElementById('pwaInstallBanner');
    const bottomBtn = document.getElementById('pwaBottomBtn');
    
    function checkInstallGate() {
        const gate = document.getElementById('installGate');
        const isStandalone = window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone === true;
        if (isStandalone) { gate.style.display = 'none'; } else { gate.style.display = 'flex'; const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream; if(isIOS) { document.getElementById('gateInstallBtn').style.display = 'none'; document.getElementById('gateIosNote').style.display = 'block'; } }
        checkInstallState();
    }
    function checkInstallState() { if (window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone === true) { if(bottomBanner) bottomBanner.style.display = 'none'; } }
    window.addEventListener('beforeinstallprompt', (e) => { e.preventDefault(); deferredPrompt = e; if(bottomBanner && document.getElementById('installGate').style.display === 'none') { bottomBanner.style.display = 'flex'; } });
    function triggerInstall() { if (deferredPrompt) { deferredPrompt.prompt(); deferredPrompt.userChoice.then((choiceResult) => { if (choiceResult.outcome === 'accepted') { if(bottomBanner) bottomBanner.style.display = 'none'; } deferredPrompt = null; }); } else { document.getElementById('installGuideModal').style.display = 'flex'; const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream; if (isIOS) { } } if(bottomBanner) bottomBanner.style.display = 'none'; }
    if(bottomBtn) bottomBtn.addEventListener('click', triggerInstall);

    lucide.createIcons();
    const firebaseConfig = { apiKey: "AIzaSyDIAQXJ15atKJxu7PtcFL1W9JnO1N14pVs", authDomain: "radiobingo-9ac29.firebaseapp.com", databaseURL: "https://radiobingo-9ac29-default-rtdb.asia-southeast1.firebasedatabase.app", projectId: "radiobingo-9ac29", storageBucket: "radiobingo-9ac29.firebasestorage.app", messagingSenderId: "965903993397", appId: "1:965903993397:web:f6646fa05225f147eebf7c" };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database(); const auth = firebase.auth();
    let messaging; try { messaging = firebase.messaging(); } catch(e) { console.log("Messaging failed to init", e); }
    let userData = {}; let cardNumbers = []; let marks = [12]; let gameDrawn = []; let currentPattern = "Normal Bingo"; let lastNotifiedDraw = ""; let selectedReplyId = null;
    let currentJackpotAmount = 500; let isJackpotActive = false;

    // PRESERVED BINGO AUDIO
    function speakNumber(num) { if ('speechSynthesis' in window) { let letter = "B"; if (num > 15) letter = "I"; if (num > 30) letter = "N"; if (num > 45) letter = "G"; if (num > 60) letter = "O"; const msg = new SpeechSynthesisUtterance(`${letter} ${num}`); msg.rate = 0.9; window.speechSynthesis.speak(msg); } }

    if ('serviceWorker' in navigator) { window.addEventListener('load', () => { navigator.serviceWorker.register('./sw.js').then(reg => { }).catch(err => console.log('SW Failed:', err)); }); }
    function requestNotifyPermission() { if ("Notification" in window) { Notification.requestPermission().then(permission => { if (permission === "granted" && messaging) { messaging.getToken().then((currentToken) => { if (currentToken && auth.currentUser) db.ref('users/' + auth.currentUser.uid).update({ fcmToken: currentToken }); }).catch((err) => console.log('Err token', err)); } }); } }

    function switchTab(tab) {
        document.querySelectorAll('.nav-item').forEach(b => b.classList.remove('active'));
        document.getElementById('view-home').style.display = 'none';
        document.getElementById('view-bingo').style.display = 'none';
        
        if(tab === 'home') {
            document.getElementById('view-home').style.display = 'block';
            document.getElementById('nav-home').classList.add('active');
            loadSocialFeed();
            loadPYMK();
        } else if(tab === 'bingo') {
            document.getElementById('view-bingo').style.display = 'block';
            document.getElementById('nav-bingo').classList.add('active');
        }
    }

    function openPostCreator() { switchTab('home'); document.getElementById('postInput').focus(); }
    
    function switchStoreTab(tab) {
        document.querySelectorAll('.store-tab-btn').forEach(b => b.classList.remove('active'));
        document.getElementById('storeSection-cashout').style.display = 'none';
        document.getElementById('storeSection-skins').style.display = 'none';
        document.getElementById('storeSection-earn').style.display = 'none';
        if(tab === 'cashout') { document.getElementById('tabBtnCash').classList.add('active'); document.getElementById('storeSection-cashout').style.display = 'block'; } 
        else if(tab === 'skins') { document.getElementById('tabBtnSkins').classList.add('active'); document.getElementById('storeSection-skins').style.display = 'block'; updateSkinButtons(); } 
        else if(tab === 'earn') { document.getElementById('tabBtnEarn').classList.add('active'); document.getElementById('storeSection-earn').style.display = 'block'; }
    }

    function fixDate(timestamp) { if(!timestamp) return "No Date"; const d = new Date(parseInt(timestamp)); return d.toLocaleDateString('en-PH', { month: 'short', day: 'numeric' }) + " " + d.toLocaleTimeString('en-PH', { hour: '2-digit', minute: '2-digit' }); }
    function login() { auth.signInWithPopup(new firebase.auth.GoogleAuthProvider()).then(() => { requestNotifyPermission(); checkNotifGate(); }); }

    auth.onAuthStateChanged(u => {
        if(u) {
            if(messaging) { messaging.getToken().then((token) => { if(token) db.ref('users/' + u.uid).update({ fcmToken: token }); }).catch((err)=>console.log(err)); messaging.onMessage((payload) => { const title = payload.notification ? payload.notification.title : "Notification"; const body = payload.notification ? payload.notification.body : "New message"; showToast(title + ": " + body); }); }
            document.getElementById('loginOverlay').style.display = 'none'; document.getElementById('userPanel').style.display = 'flex';
            document.getElementById('userImg').src = u.photoURL; document.getElementById('creatorAvatar').src = u.photoURL;
            document.getElementById('profileUidDisplay').innerText = "ID: " + u.uid.substring(0,8);
            
            const userRef = db.ref('users/'+u.uid);
            userRef.once('value', snapshot => { 
                if (!snapshot.exists()) { 
                    const newRefCode = Math.random().toString(36).substring(2, 8).toUpperCase(); 
                    const urlParams = new URLSearchParams(window.location.search); 
                    const referredBy = urlParams.get('ref'); 
                    userRef.set({ name: u.displayName, photo: u.photoURL, points: 500, refCode: newRefCode, referredBy: referredBy || null, last_seen: Date.now(), cardTimestamp: Date.now(), lastLoginDate: new Date().toDateString(), hasWonBringMeThisRound: false, ownedSkins: ['default'], equippedSkin: 'default' }); 
                    if (referredBy) { db.ref('users').orderByChild('refCode').equalTo(referredBy).once('value', refSnap => { if (refSnap.exists()) { const referrerUid = Object.keys(refSnap.val())[0]; db.ref('users/' + referrerUid + '/points').transaction(p => (p || 0) + 1000); } }); } 
                } else { 
                    const data = snapshot.val(); 
                    const updates = { last_seen: Date.now() }; 
                    if (!data.name) updates.name = u.displayName;
                    if (!data.photo) updates.photo = u.photoURL;
                    const today = new Date().toDateString(); 
                    if (data.lastLoginDate !== today) { updates.points = (data.points || 0) + 200; updates.lastLoginDate = today; showToast(" Daily Bonus! +200 RB Coins."); } 
                    if (!data.refCode) updates.refCode = Math.random().toString(36).substring(2, 8).toUpperCase(); 
                    if(!data.ownedSkins) updates.ownedSkins = ['default']; 
                    if(!data.equippedSkin) updates.equippedSkin = 'default'; 
                    userRef.update(updates); 
                } 
            });
            userRef.on('value', s => { 
                if(s.exists()){ 
                    userData = s.val(); userData.uid = u.uid; 
                    document.getElementById('userPoints').innerText = (userData.points || 0).toLocaleString(); 
                    document.getElementById('storePoints').innerText = (userData.points || 0).toLocaleString(); 
                    document.getElementById('refLink').value = window.location.origin + window.location.pathname + "?ref=" + (userData.refCode || ""); 
                    if(userData.referredBy) document.getElementById('referralInputSection').style.display = 'none'; 
                    if(userData.gcash) document.getElementById('gcashInput').value = userData.gcash; 
                    if (userData.currentCard) { cardNumbers = userData.currentCard; renderCard(); } else { generateNewCard(); } 
                    
                    const displayName = userData.name || u.displayName;
                    const displayPhoto = userData.photo || u.photoURL;
                    
                    updatePresenceData(u.uid, displayName, userData.points, displayPhoto); checkLateJoiner();
                    applySkin(userData.equippedSkin || 'default'); updateSkinButtons();
                    
                    const badgeHtml = getBadgeHtml(userData.points || 0);
                    document.getElementById('profileNameDisplay').innerHTML = `${displayName} ${badgeHtml}`;
                    document.getElementById('userImg').src = displayPhoto;
                    document.getElementById('profileImgLarge').src = displayPhoto;
                } 
            });
            initBingo(); setupChat(); listenForNextDraw(); setupPresence(u.uid); listenJackpot(); listenNotifications(u.uid); listenPrivateMessages(u.uid); listenVideoUpdate();
            initSocialSystem(u.uid);
            loadPYMK();
        } else { document.getElementById('loginOverlay').style.display = 'flex'; }
    });
    
    function getBadgeHtml(points) {
        let tierClass = "tier-bronze";
        if(points >= 100000) tierClass = "tier-diamond";
        else if(points >= 50000) tierClass = "tier-platinum";
        else if(points >= 25000) tierClass = "tier-gold";
        else if(points >= 10000) tierClass = "tier-silver";
        return `<span class="badge-tier ${tierClass}"><i data-lucide="badge-check" class="badge-icon"></i></span>`;
    }

    // === UTILITY: IMAGE COMPRESSION ===
    function compressImage(file, maxWidth, quality) {
        return new Promise((resolve) => {
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = (event) => {
                const img = new Image();
                img.src = event.target.result;
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    let width = img.width;
                    let height = img.height;
                    if (width > maxWidth) {
                        height *= maxWidth / width;
                        width = maxWidth;
                    }
                    canvas.width = width;
                    canvas.height = height;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, width, height);
                    resolve(canvas.toDataURL('image/jpeg', quality));
                };
            };
        });
    }

    // === PYMK LOGIC ===
    function loadPYMK() {
        if(!auth.currentUser) return;
        const list = document.getElementById('pymkList');
        const container = document.getElementById('pymkSection');
        
        db.ref('users').limitToLast(20).once('value', s => {
            db.ref('friends/' + auth.currentUser.uid).once('value', fSnap => {
                const friends = fSnap.exists() ? Object.keys(fSnap.val()) : [];
                friends.push(auth.currentUser.uid); 
                
                const candidates = [];
                s.forEach(uSnap => {
                    if(!friends.includes(uSnap.key)) {
                        candidates.push({ uid: uSnap.key, ...uSnap.val() });
                    }
                });
                const shuffled = candidates.sort(() => 0.5 - Math.random()).slice(0, 5);
                
                if(shuffled.length > 0) {
                    list.innerHTML = "";
                    shuffled.forEach(u => {
                        const div = document.createElement('div');
                        div.className = 'pymk-card';
                        div.innerHTML = `
                            <img src="${u.photo || 'https://via.placeholder.com/60'}" style="width:50px; height:50px; border-radius:50%; object-fit:cover; margin-bottom:5px;" onclick="openUserProfile('${u.uid}')">
                            <div style="font-size:12px; font-weight:700; color:white; overflow:hidden; text-overflow:ellipsis; width:100%; white-space:nowrap;">${u.name}</div>
                            <button class="btn-add-friend-sm" onclick="sendFriendReqPYMK('${u.uid}')">ADD</button>
                        `;
                        list.appendChild(div);
                    });
                    container.style.display = 'block';
                } else {
                    container.style.display = 'none';
                }
            });
        });
    }

    function sendFriendReqPYMK(uid) {
        db.ref('friendRequests/' + uid + '/' + auth.currentUser.uid).set(true);
        showToast("Request Sent!");
        loadPYMK(); 
    }
    
    let bannerTargetUrl = "";
    function initBannerListener() { if(sessionStorage.getItem('bannerSeen')) return; db.ref('gameState/bannerSettings').once('value', s => { const d = s.val(); if(d && d.active && d.imageUrl) { document.getElementById('customBannerImg').src = d.imageUrl; bannerTargetUrl = d.targetUrl; document.getElementById('customPopupBanner').style.display = 'flex'; sessionStorage.setItem('bannerSeen', 'true'); } }); }
    function closeCustomBanner() { document.getElementById('customPopupBanner').style.display = 'none'; }
    function clickCustomBanner() { if(bannerTargetUrl) window.open(bannerTargetUrl, '_blank'); }

    // === SKIN LOGIC ===
    function applySkin(skinId) { 
        const card = document.getElementById('bingoCardContainer'); 
        card.classList.remove('card-skin-neon', 'card-skin-gold', 'card-skin-pink', 'card-skin-matrix', 'card-skin-kitty', 'card-skin-doraemon', 'card-skin-spongebob', 'card-skin-kuromi', 'card-skin-custom'); 
        card.style.backgroundImage = 'none'; 

        if(skinId === 'neon') card.classList.add('card-skin-neon'); 
        if(skinId === 'gold') card.classList.add('card-skin-gold'); 
        if(skinId === 'pink') card.classList.add('card-skin-pink'); 
        if(skinId === 'matrix') card.classList.add('card-skin-matrix'); 
        if(skinId === 'kitty') card.classList.add('card-skin-kitty');
        if(skinId === 'doraemon') card.classList.add('card-skin-doraemon');
        if(skinId === 'spongebob') card.classList.add('card-skin-spongebob');
        if(skinId === 'kuromi') card.classList.add('card-skin-kuromi');
        
        if(skinId === 'custom') {
            card.classList.add('card-skin-custom');
            const storedBG = localStorage.getItem('customSkinBG');
            if(storedBG) {
                card.style.backgroundImage = `url('${storedBG}')`;
            }
        }
    }

    function updateSkinButtons() { 
        if(!userData.ownedSkins) return; 
        ['default', 'neon', 'gold', 'pink', 'kitty', 'doraemon', 'spongebob', 'kuromi', 'custom'].forEach(skin => { 
            const btn = document.getElementById('btn-skin-' + skin); 
            if(!btn) return; 
            if(userData.equippedSkin === skin) { 
                btn.innerText = "EQUIPPED"; 
                btn.className = "btn-buy-skin owned"; 
                btn.onclick = null; 
            } else if(userData.ownedSkins.includes(skin)) { 
                btn.innerText = "EQUIP"; 
                btn.className = "btn-buy-skin equip"; 
                btn.onclick = () => equipSkin(skin); 
            } 
        }); 
    }

    function buyOrEquipSkin(skinId, cost) { 
        if(!userData.ownedSkins) userData.ownedSkins = ['default']; 
        if(userData.ownedSkins.includes(skinId)) { 
            equipSkin(skinId); 
        } else { 
            if(userData.points >= cost) { 
                showCustomConfirm("BUY SKIN?", "Purchase for " + cost + " Coins?", () => { 
                    deductPoints(cost); 
                    let newOwned = [...userData.ownedSkins, skinId]; 
                    db.ref('users/' + userData.uid).update({ ownedSkins: newOwned, equippedSkin: skinId }); 
                    showToast("Skin Purchased!"); 
                    spawnFlyingCoins(10); 
                }); 
            } else { 
                showToast("Insufficient Coins"); 
            } 
        } 
    }

    function equipSkin(skinId) { db.ref('users/' + userData.uid).update({ equippedSkin: skinId }); showToast("Skin Equipped"); }
    
    function handleCustomSkinUpload(input) {
        if(input.files && input.files[0]) {
            compressImage(input.files[0], 800, 0.7).then(base64 => {
                localStorage.setItem('customSkinBG', base64);
                if(!userData.ownedSkins.includes('custom')) {
                     let newOwned = [...userData.ownedSkins, 'custom'];
                     db.ref('users/' + userData.uid).update({ ownedSkins: newOwned });
                }
                db.ref('users/' + userData.uid).update({ equippedSkin: 'custom' });
                showToast("Custom Background Set!");
                updateSkinButtons();
            });
        }
    }
    
    // PRESERVED TASK FUNCTIONS FOR COMPATIBILITY (Even if hidden)
    function openVideoLocker(taskKey) { console.log("Video tasks disabled for Adsense"); }
    function startTaskSafe(url, reward, taskKey) { console.log("Tasks disabled"); }

    function setupPresence(uid) { const onlineRef = db.ref('.info/connected'); const userStatusRef = db.ref('status/' + uid); onlineRef.on('value', (snapshot) => { if (snapshot.val() === false) return; userStatusRef.onDisconnect().remove().then(() => { userStatusRef.set({ state: 'online', last_changed: firebase.database.ServerValue.TIMESTAMP }); }); }); db.ref('status').on('value', (s) => { document.getElementById('onlineCount').innerText = s.numChildren() || 0; }); }
    function updatePresenceData(uid, name, points, photo) { db.ref('status/' + uid).update({ name: name, points: points, photo: photo }); }
    
    function listenNotifications(uid) { 
        db.ref('notifications/' + uid).on('value', s => { 
            const notifications = [];
            let unreadPMs = 0;
            s.forEach(child => {
                const val = child.val();
                if(val.type === 'pm') unreadPMs++;
                else notifications.push(val);
            });
            const dot = document.getElementById('notifDot'); 
            const pmBadge = document.getElementById('pmBadge');
            if(notifications.length > 0) { dot.style.display = 'block'; } else { dot.style.display = 'none'; }
            if(unreadPMs > 0) { pmBadge.style.display = 'flex'; pmBadge.innerText = unreadPMs > 9 ? '9+' : unreadPMs; } else { pmBadge.style.display = 'none'; }
        }); 
    }
    
    function openNotifs() { document.getElementById('notifModal').style.display='flex'; renderNotifs(); }
    function renderNotifs() { 
        const list = document.getElementById('notifList'); 
        db.ref('notifications/' + auth.currentUser.uid).once('value', s => { 
            list.innerHTML = ""; 
            let hasSystem = false;
            s.forEach(n => { 
                const val = n.val(); 
                const key = n.key; 
                if(val.type === 'pm') return;
                hasSystem = true;
                const div = document.createElement('div'); 
                div.style.background = 'rgba(255,255,255,0.05)'; div.style.padding = '10px'; div.style.marginBottom = '10px'; div.style.borderRadius = '10px';
                div.innerHTML = `<div style="display:flex; justify-content:space-between;"><b style="color:var(--accent);">SYSTEM</b><button onclick="deleteNotif('${key}')" style="background:none; border:none; color:#94a3b8;">x</button></div><div style="font-size:13px; color:white;">${val.msg}</div><div style="font-size:10px; opacity:0.5; text-align:right;">${fixDate(val.time)}</div>`; 
                list.prepend(div); 
            }); 
            if(!hasSystem) list.innerHTML = "<div style='text-align:center; opacity:0.5; padding:40px;'>No new notifications</div>";
        }); 
    }
    function deleteNotif(key) { db.ref('notifications/' + auth.currentUser.uid + '/' + key).remove(); renderNotifs(); }
    function listenJackpot() { db.ref('gameState/jackpot').on('value', s => { const data = s.val(); const banner = document.getElementById('jackpotBanner'); if(data && data.active) { banner.style.display = 'block'; document.getElementById('jackpotDisplayVal').innerText = data.amount + " RB COINS"; isJackpotActive = true; const rawAmount = parseInt(data.amount.replace(/[^0-9]/g, '')); currentJackpotAmount = isNaN(rawAmount) ? 500 : rawAmount; } else { banner.style.display = 'none'; isJackpotActive = false; currentJackpotAmount = 500; } }); }

    function listenVideoUpdate() { db.ref('gameState/videoSettings').on('value', s => { const v = s.val(); const iframe = document.getElementById('liveVideoFrame'); const offline = document.getElementById('videoOfflineState'); if (v && v.type === 'offline') { iframe.style.display = 'none'; iframe.src = ""; offline.style.display = 'flex'; } else if(v && v.url) { offline.style.display = 'none'; iframe.style.display = 'block'; const regExp = /^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|&v=)([^#&?]*).*/; const match = v.url.match(regExp); let videoId = (match && match[2].length === 11) ? match[2] : null; if(!videoId && v.url.length === 11) videoId = v.url; if (videoId) { const embedUrl = `https://www.youtube.com/embed/${videoId}?autoplay=1&mute=1&loop=1&playlist=${videoId}&controls=1`; if(iframe.src !== embedUrl) { iframe.src = embedUrl; } } } }); }

    function listenForNextDraw() { db.ref('gameState/schedules').on('value', s => { updateNextDrawDisplay(); }); db.ref('gameState/nextDraw').on('value', s => { updateNextDrawDisplay(); }); }
    function updateNextDrawDisplay() { db.ref('gameState').on('value', s => { const gameData = s.val() || {}; const now = Date.now(); if(gameData.drawnNumbers && Object.keys(gameData.drawnNumbers).length > 0) { const banner = document.getElementById('nextDrawBanner'); const timeEl = document.getElementById('nextDrawTime'); const labelEl = document.querySelector('.nd-info div'); const ndIcon = document.querySelector('.nd-icon'); banner.style.display = 'flex'; labelEl.innerText = "GAME STATUS"; timeEl.innerText = "GAME ONGOING"; return; } let displayTime = null; if(gameData.schedules) { const rawScheds = Object.values(gameData.schedules); const times = rawScheds.map(val => (typeof val === 'object' && val.time) ? val.time : val); const futureTimes = times.filter(t => t > now); const sorted = futureTimes.sort((a,b) => a - b); if(sorted.length > 0) { displayTime = sorted[0]; } } if(!displayTime && gameData.nextDraw) { if(gameData.nextDraw > now) { displayTime = gameData.nextDraw; } } const banner = document.getElementById('nextDrawBanner'); const timeEl = document.getElementById('nextDrawTime'); const labelEl = document.querySelector('.nd-info div'); if(displayTime && displayTime > now) { banner.style.display = 'flex'; const formatted = fixDate(displayTime); timeEl.innerText = formatted; labelEl.innerText = "NEXT DRAW"; checkNotificationTime(displayTime); checkFiveMinuteNotification(displayTime); } else { banner.style.display = 'flex'; labelEl.innerText = "WAITING FOR DRAW"; timeEl.innerText = "STANDBY"; } }); }
    function checkNotificationTime(timeInput) { if(lastNotifiedDraw == timeInput) return; let drawTime = isNaN(timeInput) ? 0 : parseInt(timeInput); if(drawTime > 0) { const diff = drawTime - Date.now(); const mins = Math.floor(diff / 60000); if(mins === 10) { if(Notification.permission === "granted") new Notification("Radio Bingo", { body: "10 mins na lang, bola na!" }); lastNotifiedDraw = timeInput; } } }

    function initBingo() {
        db.ref('gameState/latestWinner').on('value', s => { const win = s.val(); const banner = document.getElementById('winnerBanner'); const cardCont = document.getElementById('bingoCardContainer'); const gameOverlay = document.getElementById('gameOverOverlay'); cardCont.classList.remove('card-puro'); document.querySelectorAll('.cell').forEach(c => c.classList.remove('cell-waiting')); if(win && win.name) { banner.innerHTML = `<span>WINNER: ${win.name.toUpperCase()}</span><br><span style="font-size:12px; font-weight:400;">Pattern: ${currentPattern}</span>`; banner.style.display = 'block'; if(win.uid === auth.currentUser.uid) { confetti({ particleCount: 150, spread: 70, origin: { y: 0.6 } }); cardCont.classList.add('card-win'); cardCont.classList.remove('card-lost'); gameOverlay.style.display = 'none'; spawnFlyingCoins(20); } else { cardCont.classList.add('card-lost'); cardCont.classList.remove('card-win'); gameOverlay.style.display = 'flex'; const nextTime = document.getElementById('nextDrawTime').innerText; document.getElementById('gameOverMsg').innerHTML = `Winner: <b>${win.name.toUpperCase()}</b><br><br>Wait for next draw!`; } } else { banner.style.display = 'none'; cardCont.classList.remove('card-win', 'card-lost'); gameOverlay.style.display = 'none'; document.querySelectorAll('.cell').forEach(c => { c.classList.remove('win-glow', 'win-line-h', 'win-line-v', 'win-line-d1', 'win-line-d2'); }); } });
        db.ref('gameState/currentPattern').on('value', s => { currentPattern = s.val() || "Normal Bingo"; document.getElementById('patternName').innerText = currentPattern; checkWin(); });
        db.ref('drawnNumbers').on('value', s => { const val = s.val(); const newGameDrawn = val ? Object.values(val).map(n => n.toString()) : []; if(newGameDrawn.length > 0 && gameDrawn.length > 0) { const newBalls = newGameDrawn.filter(x => !gameDrawn.includes(x)); if(newBalls.length > 0) { const latestBall = newBalls[newBalls.length - 1]; showToast("BOLA: " + latestBall); } } gameDrawn = newGameDrawn; const btn = document.getElementById('newCardBtn'); if(gameDrawn.length > 0) { btn.disabled = true; btn.innerHTML = `<i data-lucide="lock" style="width:12px"></i> LOCKED`; } else { btn.disabled = false; btn.innerHTML = `<i data-lucide="refresh-cw" style="width:12px"></i> NEW CARD`; } lucide.createIcons(); checkLateJoiner(); updateGridHits(); renderPrevBalls(); checkWin(); checkPuroStatus(); });
        db.ref('gameState/lastCalled').on('value', s => { if(s.exists()) { const num = s.val(); document.getElementById('currentBall').innerText = num; if (num !== lastSpokenNumber) { speakNumber(num); lastSpokenNumber = num; } } else { document.getElementById('currentBall').innerText = "--"; lastSpokenNumber = null; } });
    }
    let lastSpokenNumber = null;

    function checkWin() { if(userData.hasWonCurrent || gameDrawn.length === 0) return; db.ref('gameState/latestWinner').once('value', snap => { if(snap.exists()) return; let winningWays = []; if (currentPattern === "Blackout") { winningWays = [Array.from({length: 25}, (_, i) => i)]; } else if (currentPattern === "Letter X") { winningWays = [[0,4,6,8,12,16,18,20,24]]; } else if (currentPattern === "Four Corners") { winningWays = [[0,4,20,24]]; } else { winningWays = [ [0,1,2,3,4],[5,6,7,8,9],[10,11,12,13,14],[15,16,17,18,19],[20,21,22,23,24], [0,5,10,15,20],[1,6,11,16,21],[2,7,12,17,22],[3,8,13,18,23],[4,9,14,19,24], [0,6,12,18,24], [4,8,12,16,20] ]; } for(let i = 0; i < winningWays.length; i++) { let w = winningWays[i]; if(w.every(idx => marks.includes(idx))) { highlightWinningPattern(w, i); triggerWin(); break; } } }); }
    function checkPuroStatus() { if(userData.hasWonCurrent || gameDrawn.length === 0) return; document.getElementById('bingoCardContainer').classList.remove('card-puro'); document.querySelectorAll('.cell').forEach(c => c.classList.remove('cell-waiting')); let winningWays = []; if (currentPattern === "Blackout") winningWays = [Array.from({length: 25}, (_, i) => i)]; else if (currentPattern === "Letter X") winningWays = [[0,4,6,8,12,16,18,20,24]]; else if (currentPattern === "Four Corners") winningWays = [[0,4,20,24]]; else winningWays = [[0,1,2,3,4],[5,6,7,8,9],[10,11,12,13,14],[15,16,17,18,19],[20,21,22,23,24],[0,5,10,15,20],[1,6,11,16,21],[2,7,12,17,22],[3,8,13,18,23],[4,9,14,19,24],[0,6,12,18,24],[4,8,12,16,20]]; for (let i = 0; i < winningWays.length; i++) { let w = winningWays[i]; let missing = w.filter(idx => !marks.includes(idx)); if (missing.length === 1) { document.getElementById('bingoCardContainer').classList.add('card-puro'); const missingIdx = missing[0]; const cells = document.querySelectorAll('.cell'); if(cells[missingIdx]) cells[missingIdx].classList.add('cell-waiting'); break; } } }
    function highlightWinningPattern(indices, patternType) { const cells = document.querySelectorAll('.cell'); indices.forEach(idx => { const cell = cells[idx]; cell.classList.add('win-glow'); }); }

    function triggerWin() { const uid = auth.currentUser.uid; let winPrize = 500; if (isJackpotActive) winPrize = currentJackpotAmount; db.ref('gameState/latestWinner').set({ name: userData.name, uid: uid, prize: winPrize }); db.ref('users/' + uid + '/points').transaction(p => (p || 0) + winPrize); db.ref('users/' + uid).update({ hasWonCurrent: true }); userData.hasWonCurrent = true; if (isJackpotActive) { const jpModal = document.getElementById('grandJackpotModal'); document.getElementById('grandPrizeAmount').innerText = winPrize.toLocaleString(); document.getElementById('jpWinnerName').innerText = userData.name; jpModal.style.display = 'flex'; confetti({ particleCount: 500, spread: 120, startVelocity: 60 }); } }
    function generateNewCard() { if(gameDrawn.length > 0) return showToast("Bawal magpalit habang may laro!"); let card = []; let cols = [[1,15],[16,30],[31,45],[46,60],[61,75]]; cols.forEach(r => { let nums = []; while(nums.length < 5) { let n = Math.floor(Math.random() * (r[1] - r[0] + 1)) + r[0]; if(!nums.includes(n)) nums.push(n); } card.push(...nums); }); let finalCard = []; for(let r=0; r<5; r++) { for(let c=0; c<5; c++) { finalCard.push(card[c*5 + r]); } } finalCard[12] = "FREE"; db.ref('users/' + auth.currentUser.uid).update({ currentCard: finalCard, cardTimestamp: Date.now(), hasWonCurrent: false }); cardNumbers = finalCard; renderCard(); }
    function renderCard() { const grid = document.getElementById('bingoGrid'); grid.innerHTML = ""; cardNumbers.forEach((n, i) => { const div = document.createElement('div'); div.className = 'cell'; div.innerText = n === "FREE" ? "" : n; if(n === "FREE") { div.classList.add('hit'); if(!marks.includes(12)) marks.push(12); } grid.appendChild(div); }); updateGridHits(); applySkin(userData.equippedSkin || 'default'); }
    function updateGridHits() { marks = [12]; const cells = document.querySelectorAll('.cell'); cells.forEach((c, i) => { const val = c.innerText; if(gameDrawn.includes(val) || val === "") { c.classList.add('hit'); if(!marks.includes(i)) marks.push(i); } }); }
    function renderPrevBalls() { const row = document.getElementById('ballRow'); row.innerHTML = ""; const last5 = gameDrawn.slice(-5).reverse(); last5.forEach(n => { let d = document.createElement('div'); d.className = 'ball-small'; d.innerText = n; row.appendChild(d); }); }
    function checkLateJoiner() { const overlay = document.getElementById('lateOverlay'); if(gameDrawn.length > 0 && !userData.currentCard) { overlay.style.display = 'flex'; } else if (gameDrawn.length > 0 && userData.cardTimestamp > db.ref('gameState/gameStartTime')) { overlay.style.display = 'none'; } else { overlay.style.display = 'none'; } }

    function setupChat() { 
        const list = document.getElementById('chatList'); 
        db.ref('chats').limitToLast(50).on('child_added', s => { 
            const d = s.val(); const key = s.key; 
            const isMe = d.uid === auth.currentUser.uid; 
            const div = document.createElement('div'); div.className = 'chat-row'; div.style.flexDirection = isMe ? 'row-reverse' : 'row'; 
            let replyHtml = ''; if(d.replyTo && d.replyMsg) { replyHtml = `<div style="font-size:10px; opacity:0.7; border-left:2px solid var(--accent); padding-left:5px; margin-bottom:5px; background:rgba(0,0,0,0.2); padding:4px; border-radius:4px;">Replying to: ${d.replyMsg.substring(0, 30)}...</div>`; } 
            
            div.innerHTML = `<img class="chat-pfp" src="${d.pfp}" onclick="showUserOptions('${d.uid}', '${d.name.replace(/'/g, "\\'")}', '${d.pfp}')"><div class="chat-content"><div class="bubble">${!isMe ? `<div class="chat-name" style="font-size:10px; font-weight:700; color:#94a3b8; margin-bottom:2px;" onclick="replyTo('${key}', '${d.msg.replace(/'/g, "\\'")}')">${d.name}</div>` : ''}${replyHtml}<div class="chat-text">${d.msg}</div></div></div>`; 
            list.appendChild(div); list.scrollTop = list.scrollHeight; lucide.createIcons(); 
        }); 
    }
    
    function sendChat() { const inp = document.getElementById('chatIn'); const msg = inp.value.trim(); if(!msg) return; const payload = { name: userData.name, msg: msg, pfp: userData.photo, uid: userData.uid, time: Date.now() }; if(selectedReplyId) { payload.replyTo = selectedReplyId; payload.replyMsg = document.getElementById('replyText').innerText.replace("Replying to: ", ""); cancelReply(); } db.ref('chats').push(payload); inp.value = ""; }
    function replyTo(key, msg) { selectedReplyId = key; document.getElementById('replyText').innerText = "Replying to: " + msg.substring(0, 20) + "..."; document.getElementById('replyIndicator').style.display = 'flex'; document.getElementById('chatIn').focus(); }
    function cancelReply() { selectedReplyId = null; document.getElementById('replyIndicator').style.display = 'none'; }

    let currentChatPartner = null;
    function openMessenger() { document.getElementById('pmModal').style.display = 'flex'; document.getElementById('pmInboxView').style.display = 'flex'; document.getElementById('pmChatView').style.display = 'none'; loadInbox(); }
    function loadInbox() { 
        const uid = auth.currentUser.uid; 
        const list = document.getElementById('pmList'); 
        list.innerHTML = "<div style='text-align:center; padding:20px; opacity:0.5;'>Loading...</div>"; 
        
        renderActiveFriends();

        db.ref('messages').once('value', s => { 
            const conversations = {}; 
            s.forEach(msgSnap => { const m = msgSnap.val(); if(m.from === uid || m.to === uid) { const partner = m.from === uid ? m.to : m.from; conversations[partner] = m; } }); 
            list.innerHTML = ""; 
            if(Object.keys(conversations).length === 0) { list.innerHTML = "<div style='text-align:center; padding:20px;'>No messages yet.</div>"; return; } 
            Object.keys(conversations).forEach(partnerId => { 
                db.ref('users/' + partnerId).once('value', uSnap => { 
                    const u = uSnap.val(); 
                    const lastMsg = conversations[partnerId]; 
                    const div = document.createElement('div'); 
                    div.className = 'pm-item'; 
                    div.onclick = () => openPrivateChat(partnerId, u.name, u.photo); 
                    div.innerHTML = `<img class="pm-avatar" src="${u.photo || 'https://via.placeholder.com/40'}" style="width:50px; height:50px; border-radius:50%; object-fit:cover;"><div class="pm-info" style="margin-left:10px; display:flex; flex-direction:column;"><span class="pm-name" style="font-weight:700;">${u.name}</span><span class="pm-preview" style="font-size:13px; color:#94a3b8;">${lastMsg.from === uid ? 'You: ' : ''}${lastMsg.text}</span></div>`; 
                    list.appendChild(div); 
                    lucide.createIcons();
                }); 
            }); 
        }); 
    }
    
    function renderActiveFriends() {
        const bar = document.getElementById('activeFriendsBar');
        bar.innerHTML = '';
        db.ref('friends/' + auth.currentUser.uid).once('value', s => {
            if(!s.exists()) return;
            s.forEach(f => {
                db.ref('users/' + f.key).once('value', uSnap => {
                    const u = uSnap.val();
                    const item = document.createElement('div');
                    item.onclick = () => openPrivateChat(f.key, u.name, u.photo); 
                    item.innerHTML = `
                        <div style="position:relative; width:50px; height:50px;">
                            <img src="${u.photo}" style="width:50px; height:50px; border-radius:50%; object-fit:cover; border:2px solid var(--messenger-blue);">
                            <div style="position:absolute; bottom:2px; right:2px; width:12px; height:12px; background:#31a24c; border:2px solid #000; border-radius:50%;"></div>
                        </div>
                        <div style="font-size:11px; color:#e4e6eb; margin-top:5px; text-align:center; max-width:50px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">${u.name.split(' ')[0]}</div>
                    `;
                    bar.appendChild(item);
                });
            });
        });
    }

    function openPrivateChat(uid, name, photo) { 
        if(uid === auth.currentUser.uid) return showToast("Cant msg self"); 
        currentChatPartner = uid; 
        document.getElementById('pmModal').style.display = 'flex'; 
        document.getElementById('pmInboxView').style.display = 'none'; 
        document.getElementById('pmChatView').style.display = 'flex'; 
        document.getElementById('chatTargetName').innerText = name; 
        document.getElementById('chatTargetImg').src = photo || 'https://via.placeholder.com/30'; 
        listenPrivateMessages(auth.currentUser.uid); 
    }
    
    function backToInbox() { currentChatPartner = null; document.getElementById('pmChatView').style.display = 'none'; document.getElementById('pmInboxView').style.display = 'flex'; loadInbox(); }
    
    function sendPrivateMessage() { 
        const inp = document.getElementById('pmInput'); 
        const text = inp.value.trim(); 
        if(!text || !currentChatPartner) return; 
        const myUid = auth.currentUser.uid; 
        const msgData = { from: myUid, to: currentChatPartner, text: text, timestamp: Date.now() }; 
        db.ref('messages').push(msgData); 
        db.ref('notifications/' + currentChatPartner).push({ msg: `New PM from ${userData.name}`, time: Date.now(), type: 'pm', from: myUid }); 
        inp.value = ""; 
    }
    
    let pmListenerRef = null;
    function listenPrivateMessages(myUid) { 
        const chatDiv = document.getElementById('pmMessages'); 
        chatDiv.innerHTML = "";
        if(pmListenerRef) db.ref('messages').off();
        pmListenerRef = db.ref('messages').limitToLast(100);
        pmListenerRef.on('child_added', s => { 
            const m = s.val(); 
            if(!currentChatPartner) return; 
            if( (m.from === myUid && m.to === currentChatPartner) || (m.from === currentChatPartner && m.to === myUid) ) { 
                const div = document.createElement('div'); 
                div.className = `msg-bubble ${m.from === myUid ? 'msg-me' : 'msg-them'}`; 
                div.style.alignSelf = m.from === myUid ? 'flex-end' : 'flex-start';
                div.style.background = m.from === myUid ? 'var(--messenger-blue)' : '#303030';
                div.style.color = 'white';
                div.style.padding = '8px 14px';
                div.style.borderRadius = '18px';
                div.style.maxWidth = '70%';
                div.innerText = m.text; 
                chatDiv.appendChild(div); 
                chatDiv.scrollTop = chatDiv.scrollHeight; 
            } 
        }); 
    }

    function deductPoints(amt) { db.ref('users/' + userData.uid + '/points').transaction(p => (p || 0) - amt); spawnLossAnimation(amt); }
    function addPoints(amt) { db.ref('users/' + userData.uid + '/points').transaction(p => (p || 0) + amt); }

    function spawnFlyingCoins(amount) { const count = Math.min(amount, 15); const targetEl = document.querySelector('.points-badge'); if(!targetEl) return; const rect = targetEl.getBoundingClientRect(); const targetX = rect.left + (rect.width / 2); const targetY = rect.top + (rect.height / 2); const startX = window.innerWidth / 2; const startY = window.innerHeight / 2; for(let i=0; i<count; i++) { setTimeout(() => { const coin = document.createElement('div'); coin.className = 'flying-coin'; coin.style.left = startX + 'px'; coin.style.top = startY + 'px'; document.body.appendChild(coin); const spread = 80; const randX = (Math.random() - 0.5) * spread; const randY = (Math.random() - 0.5) * spread; requestAnimationFrame(() => { coin.style.transition = 'transform 0.3s ease-out'; coin.style.transform = `translate(${randX}px, ${randY}px) scale(1.2)`; setTimeout(() => { coin.style.transition = 'transform 0.6s cubic-bezier(0.2, 0.8, 0.2, 1), opacity 0.6s'; const moveX = targetX - startX; const moveY = targetY - startY; coin.style.transform = `translate(${moveX}px, ${moveY}px) scale(0.5)`; coin.style.opacity = '0'; }, 300); setTimeout(() => coin.remove(), 900); }); }, i * 30); } }
    function spawnLossAnimation(amount) { const startX = window.innerWidth / 2; const startY = window.innerHeight / 2; const el = document.createElement('div'); el.className = 'float-loss'; el.innerText = "-" + amount; el.style.left = startX + 'px'; el.style.top = startY + 'px'; document.body.appendChild(el); setTimeout(() => el.remove(), 1000); }

    function openMenuModal() { document.getElementById('menuModal').style.display='flex'; }
    function saveGcash() { const num = document.getElementById('gcashInput').value; if(num.length > 3) { db.ref('users/'+auth.currentUser.uid).update({ gcash: num }); showToast("Info Saved!"); } else showToast("Invalid Details"); }
    function redeemItem(name, cost) { if(userData.points >= cost) { if(!userData.gcash) return showToast("Save redemption info first!"); showCustomConfirm("REDEEM REWARD?", "Exchange " + cost + " pts for " + name + "?", () => { deductPoints(cost); db.ref('redemptions').push({ uid: userData.uid, name: userData.name, gcash: userData.gcash, item: name, cost: cost, status: 'pending', timestamp: Date.now() }); showToast("Request Sent!"); loadHistory(); }); } else { showToast("Insufficient RB Coins"); } }
    function loadHistory() { const list = document.getElementById('historyList'); db.ref('redemptions').orderByChild('uid').equalTo(auth.currentUser.uid).once('value', s => { list.innerHTML = ""; s.forEach(r => { const d = r.val(); let color = '#fbbf24'; if(d.status === 'sent') color = '#10b981'; if(d.status === 'denied') color = '#ef4444'; list.innerHTML += `<div style="display:flex; justify-content:space-between; margin-bottom:8px; border-bottom:1px solid rgba(255,255,255,0.05); padding-bottom:5px;"><div><div style="font-weight:700; font-size:12px;">${d.item}</div><div style="font-size:10px; opacity:0.6;">${fixDate(d.timestamp)}</div></div><div style="font-size:10px; font-weight:800; color:${color}; text-transform:uppercase;">${d.status}</div></div>`; }); }); }

    let selectedMood = "Happy";
    let targetUserForOpt = null;
    let selectedImageBase64 = null;

    function initSocialSystem(uid) {
        db.ref('friendRequests/' + uid).on('value', s => {
            const container = document.getElementById('friendRequestsSection');
            container.innerHTML = "";
            s.forEach(req => {
                const requesterId = req.key;
                db.ref('users/' + requesterId).once('value', u => {
                    const uData = u.val();
                    const div = document.createElement('div');
                    div.style.background = 'rgba(59, 130, 246, 0.1)'; div.style.border = '1px solid var(--accent)'; div.style.padding = '10px'; div.style.borderRadius = '10px'; div.style.display = 'flex'; div.style.justifyContent = 'space-between'; div.style.alignItems = 'center'; div.style.marginBottom = '10px';
                    div.innerHTML = `<div style="display:flex; align-items:center; gap:10px;"><img src="${uData.photo}" style="width:30px;height:30px;border-radius:50%;"><span style="font-weight:700; font-size:12px; color:white;">${uData.name} wants to be friends</span></div><div style="display:flex; gap:5px;"><button onclick="acceptFriend('${requesterId}')" style="background:var(--success); color:white; border:none; padding:6px 12px; border-radius:6px; font-weight:700; font-size:11px;">Accept</button><button onclick="declineFriend('${requesterId}')" style="background:rgba(255,255,255,0.1); color:white; border:none; padding:6px 12px; border-radius:6px; font-weight:700; font-size:11px;">X</button></div>`;
                    container.appendChild(div);
                });
            });
        });
    }

    function showUserOptions(uid, name, photo) {
        targetUserForOpt = { uid, name, photo };
        document.getElementById('optUserImg').src = photo;
        document.getElementById('optUserName').innerText = name;
        document.getElementById('userOptionsModal').style.display = 'flex';
    }

    function optSendMessage() {
        document.getElementById('userOptionsModal').style.display = 'none';
        openPrivateChat(targetUserForOpt.uid, targetUserForOpt.name, targetUserForOpt.photo);
    }

    function optAddFriend() {
        if(!targetUserForOpt) return;
        const targetUid = targetUserForOpt.uid;
        if(targetUid === auth.currentUser.uid) { showToast("That's you!"); return; }
        
        db.ref('friends/' + auth.currentUser.uid + '/' + targetUid).once('value', s => {
            if(s.exists()) {
                showToast("Already friends!");
            } else {
                db.ref('friendRequests/' + targetUid + '/' + auth.currentUser.uid).set(true);
                showToast("Friend Request Sent!");
            }
            document.getElementById('userOptionsModal').style.display = 'none';
        });
    }

    function acceptFriend(requesterUid) {
        const myUid = auth.currentUser.uid;
        db.ref('friends/' + myUid + '/' + requesterUid).set(true);
        db.ref('friends/' + requesterUid + '/' + myUid).set(true);
        db.ref('friendRequests/' + myUid + '/' + requesterUid).remove();
        showToast("You are now friends!");
    }

    function declineFriend(requesterUid) {
        db.ref('friendRequests/' + auth.currentUser.uid + '/' + requesterUid).remove();
    }
    
    function handlePostImage(input) {
        if(input.files && input.files[0]) {
            compressImage(input.files[0], 800, 0.7).then(base64 => {
                selectedImageBase64 = base64;
                document.getElementById('postImgPreview').src = selectedImageBase64;
                document.getElementById('imgPreviewCont').style.display = 'block';
            });
        }
    }
    
    function removePostImage() {
        selectedImageBase64 = null;
        document.getElementById('postImgInput').value = "";
        document.getElementById('imgPreviewCont').style.display = 'none';
    }

    function createPost() {
        const txt = document.getElementById('postInput').value.trim();
        if(!txt && !selectedImageBase64) return showToast("Type something or add photo!");
        
        const postData = {
            uid: auth.currentUser.uid,
            authorName: userData.name,
            authorPhoto: userData.photo,
            authorPoints: userData.points, 
            content: txt,
            image: selectedImageBase64,
            timestamp: Date.now(),
            likes: {}
        };
        
        db.ref('socialPosts').push(postData);
        document.getElementById('postInput').value = "";
        removePostImage();
        showToast("Posted!");
    }

    let currentProfileUid = null;

    function openMyProfile() {
        openUserProfile(auth.currentUser.uid);
    }

    function openUserProfile(uid) {
        currentProfileUid = uid;
        document.getElementById('userOptionsModal').style.display = 'none';
        document.getElementById('userProfilePage').style.display = 'flex';
        
        document.getElementById('pageProfileFeed').innerHTML = "<div style='color:white; opacity:0.5; text-align:center; padding:20px;'>Loading...</div>";
        document.getElementById('profileMainActionBtn').style.display = 'none';

        db.ref('users/' + uid).once('value', s => {
            const u = s.val();
            document.getElementById('pageProfileImg').src = u.photo || 'https://via.placeholder.com/100';
            document.getElementById('pageProfileName').innerHTML = `${u.name} ${getBadgeHtml(u.points || 0)}`;
            document.getElementById('pageProfileBio').innerText = u.bio || "Radio Bingo Player";
            
            if(u.cover) {
                document.getElementById('pageProfileCover').style.backgroundImage = `url('${u.cover}')`;
            } else {
                document.getElementById('pageProfileCover').style.background = '#334155';
                document.getElementById('pageProfileCover').style.backgroundImage = 'none';
            }
            
            updateProfileButtonState(uid);
            
            db.ref('friends/' + uid).once('value', fSnap => {
                document.getElementById('statFriends').innerText = fSnap.numChildren() || 0;
            });
            
            loadProfilePosts(uid);
            lucide.createIcons();
        });
    }

    function closeProfilePage() {
        document.getElementById('userProfilePage').style.display = 'none';
        currentProfileUid = null;
    }

    function updateProfileButtonState(uid) {
        const btn = document.getElementById('profileMainActionBtn');
        const myUid = auth.currentUser.uid;
        
        if(uid === myUid) {
            btn.innerText = "Edit Profile";
            btn.onclick = openEditProfile;
            btn.style.display = 'block';
        } else {
            db.ref('friends/' + myUid + '/' + uid).once('value', s => {
                if(s.exists()) {
                    btn.innerText = "Friends";
                    btn.onclick = null; 
                } else {
                     db.ref('friendRequests/' + uid + '/' + myUid).once('value', reqSnap => {
                         if(reqSnap.exists()) {
                             btn.innerText = "Request Sent";
                             btn.onclick = null;
                         } else {
                             btn.innerText = "Add Friend";
                             btn.onclick = () => {
                                 db.ref('friendRequests/' + uid + '/' + myUid).set(true);
                                 updateProfileButtonState(uid);
                                 showToast("Request Sent!");
                             };
                         }
                     });
                }
                btn.style.display = 'block';
            });
        }
    }
    
    function loadProfilePosts(uid) {
        const container = document.getElementById('pageProfileFeed');
        db.ref('socialPosts').orderByChild('uid').equalTo(uid).limitToLast(20).once('value', pSnap => {
            container.innerHTML = "";
            let count = 0;
            let likes = 0;
            const posts = [];
            pSnap.forEach(c => {
                const p = c.val();
                posts.push({ key: c.key, ...p });
                count++;
                if(p.likes) likes += Object.keys(p.likes).length;
            });
            
            document.getElementById('statPosts').innerText = count;
            document.getElementById('statLikes').innerText = likes;
            
            posts.reverse().forEach(post => {
                 const postDiv = document.createElement('div');
                 postDiv.style.background = 'var(--bg-card)'; postDiv.style.padding = '15px'; postDiv.style.borderRadius = '16px'; postDiv.style.marginBottom = '15px'; postDiv.style.border = '1px solid var(--border-color)';
                 const imgHtml = post.image ? `<img src="${post.image}" style="width:100%; border-radius:12px; margin-top:10px;">` : '';
                 postDiv.innerHTML = `<div style="font-size:12px; color:#94a3b8; margin-bottom:5px;">${fixDate(post.timestamp)}</div><div style="font-size:14px; color:white;">${post.content}</div>${imgHtml}`;
                 container.appendChild(postDiv);
            });
            if(count === 0) container.innerHTML = "<div style='color:white; opacity:0.5; font-size:12px; text-align:center; padding:20px;'>No posts yet</div>";
        });
    }

    function openEditProfile() {
        document.getElementById('editNameIn').value = userData.name;
        document.getElementById('editBioIn').value = userData.bio || "";
        document.getElementById('editProfileModal').style.display = 'flex';
    }

    function handleProfileUpload(input, type) {
        if(input.files && input.files[0]) {
            const maxWidth = type === 'cover' ? 1200 : 500;
            compressImage(input.files[0], maxWidth, 0.7).then(base64 => {
                input.dataset.b64 = base64;
                showToast("Image ready! Click Save.");
            });
        }
    }

    function saveProfileChanges() {
        const newName = document.getElementById('editNameIn').value.trim();
        const newBio = document.getElementById('editBioIn').value.trim();
        const pfpInput = document.getElementById('editProfilePicInput');
        const coverInput = document.getElementById('editCoverPicInput');
        
        if(newName.length < 2) return showToast("Name too short");
        
        const updates = { name: newName, bio: newBio };
        if(pfpInput.dataset.b64) updates.photo = pfpInput.dataset.b64;
        if(coverInput.dataset.b64) updates.cover = coverInput.dataset.b64;
        
        db.ref('users/' + auth.currentUser.uid).update(updates).then(() => {
            showToast("Profile Updated!");
            document.getElementById('editProfileModal').style.display = 'none';
            pfpInput.value = ""; delete pfpInput.dataset.b64;
            coverInput.value = ""; delete coverInput.dataset.b64;
            openMyProfile(); 
        });
    }

    function openSearch() {
        document.getElementById('searchModal').style.display = 'flex';
        document.getElementById('searchInput').focus();
    }
    
    let searchTimeout = null;
    function handleSearch() {
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(() => {
            const q = document.getElementById('searchInput').value.toLowerCase().trim();
            const resDiv = document.getElementById('searchResults');
            if(q.length < 2) {
                resDiv.innerHTML = "<div style='text-align:center; opacity:0.5; padding:20px;'>Type more to search...</div>";
                return;
            }
            resDiv.innerHTML = "<div style='text-align:center; opacity:0.5; padding:20px;'>Searching...</div>";
            db.ref('users').once('value', s => {
                resDiv.innerHTML = "";
                let found = false;
                s.forEach(uSnap => {
                    const u = uSnap.val();
                    const uid = uSnap.key;
                    if(u.name.toLowerCase().includes(q)) {
                        found = true;
                        const div = document.createElement('div');
                        div.onclick = () => {
                            document.getElementById('searchModal').style.display = 'none';
                            openUserProfile(uid);
                        };
                        div.innerHTML = `<div style="display:flex; align-items:center; gap:10px; padding:10px; border-bottom:1px solid rgba(255,255,255,0.05); cursor:pointer;"><img src="${u.photo || 'https://via.placeholder.com/40'}" style="width:40px; height:40px; border-radius:50%; object-fit:cover;"><div style="font-size:14px; font-weight:700; color:white;">${u.name} ${getBadgeHtml(u.points || 0)}</div></div>`;
                        resDiv.appendChild(div);
                    }
                });
                if(!found) resDiv.innerHTML = "<div style='text-align:center; opacity:0.5; padding:20px;'>No users found.</div>";
                lucide.createIcons();
            });
        }, 500);
    }

    let currentOpenPostKey = null;

    function openComments(postKey) {
        currentOpenPostKey = postKey;
        const list = document.getElementById('commentList');
        list.innerHTML = "<div style='text-align:center; color:white; opacity:0.5; padding:20px;'>Loading...</div>";
        document.getElementById('commentModal').style.display = 'flex';
        document.getElementById('commentModalBackdrop').style.display = 'block';
        
        db.ref('postComments/' + postKey).on('value', s => {
            list.innerHTML = "";
            if(!s.exists()) {
                list.innerHTML = "<div style='text-align:center; color:white; opacity:0.5; padding:20px;'>No comments yet.</div>";
                return;
            }
            s.forEach(c => {
                const com = c.val();
                const div = document.createElement('div');
                div.style.display = 'flex'; div.style.gap = '10px';
                div.innerHTML = `
                    <img src="${com.uPhoto}" style="width:32px; height:32px; border-radius:50%;">
                    <div>
                        <div style="background:#334155; padding:8px 12px; border-radius:12px;">
                            <div style="font-size:11px; font-weight:800; color:white; margin-bottom:2px;">${com.uName}</div>
                            <div style="font-size:13px; color:#cbd5e1;">${com.text}</div>
                        </div>
                    </div>
                `;
                list.appendChild(div);
            });
            list.scrollTop = list.scrollHeight;
        });
    }
    
    function closeComments() {
        document.getElementById('commentModal').style.display = 'none';
        document.getElementById('commentModalBackdrop').style.display = 'none';
        db.ref('postComments/' + currentOpenPostKey).off(); 
        currentOpenPostKey = null;
    }

    function sendComment() {
        const txt = document.getElementById('commentInput').value.trim();
        if(!txt || !currentOpenPostKey) return;
        
        db.ref('postComments/' + currentOpenPostKey).push({
            uid: auth.currentUser.uid,
            uName: userData.name,
            uPhoto: userData.photo,
            uPoints: userData.points,
            text: txt,
            time: Date.now()
        });
        document.getElementById('commentInput').value = "";
    }

    let postListener = null;

    function loadSocialFeed() {
        const feedContainer = document.getElementById('socialFeed');
        if(postListener) return; 

        feedContainer.innerHTML = "<div style='text-align:center; padding:20px; opacity:0.5;'>Loading Feed...</div>";
        
        db.ref('friends/' + auth.currentUser.uid).once('value', fSnap => {
            const myFriends = fSnap.exists() ? Object.keys(fSnap.val()) : [];
            
            postListener = db.ref('socialPosts').limitToLast(50);
            postListener.on('value', pSnap => {
                const allPosts = [];
                pSnap.forEach(child => { allPosts.push({ key: child.key, ...child.val() }); });
                
                allPosts.sort((a, b) => b.timestamp - a.timestamp);
                
                feedContainer.innerHTML = "";
                if(allPosts.length === 0) {
                    feedContainer.innerHTML = "<div style='text-align:center; padding:20px; opacity:0.5;'>No posts yet. Be the first!</div>";
                    return;
                }
                
                let adCounter = 0;
                
                allPosts.forEach(post => {
                    const isMe = post.uid === auth.currentUser.uid;
                    const likeCount = post.likes ? Object.keys(post.likes).length : 0;
                    
                    // Reaction Logic
                    let myReaction = null;
                    if(post.likes && post.likes[auth.currentUser.uid]) {
                        myReaction = post.likes[auth.currentUser.uid]; // string (e.g., 'love') or boolean (true)
                        if(myReaction === true) myReaction = 'like'; // backwards compatibility
                    }

                    const reactionIcons = {
                        like: '', love: '', haha: '', wow: '', sad: '', angry: ''
                    };
                    const reactionColors = {
                        like: '#3b82f6', love: '#ef4444', haha: '#fbbf24', wow: '#fbbf24', sad: '#fbbf24', angry: '#ef4444'
                    };
                    
                    const btnColor = myReaction ? (reactionColors[myReaction] || '#3b82f6') : '#94a3b8';
                    const btnIcon = myReaction ? reactionIcons[myReaction] : '<i data-lucide="thumbs-up" style="width:16px"></i>';
                    const btnText = myReaction ? myReaction.charAt(0).toUpperCase() + myReaction.slice(1) : 'Like';

                    const postDiv = document.createElement('div');
                    postDiv.className = 'post-card';
                    postDiv.id = 'post-' + post.key;
                    
                    const imgHtml = post.image ? `<div class="post-image-container"><img src="${post.image}" class="post-image"></div>` : '';
                    
                    postDiv.innerHTML = `
                        <div class="post-header">
                            <img class="post-avatar" src="${post.authorPhoto}" onclick="openUserProfile('${post.uid}')">
                            <div class="post-meta">
                                <div class="post-author">${post.authorName} ${getBadgeHtml(post.authorPoints || 0)}</div>
                                <div class="post-time">${fixDate(post.timestamp)}</div>
                            </div>
                        </div>
                        <div class="post-content">${post.content}</div>
                        ${imgHtml}
                        <div class="post-actions">
                            <div class="action-btn like-wrapper" style="color:${btnColor}" onclick="toggleLike('${post.key}', '${post.uid}')">
                                <div class="reaction-popup" id="react-${post.key}">
                                    <div class="reaction-emoji" onclick="event.stopPropagation(); setReaction('${post.key}', 'like')"></div>
                                    <div class="reaction-emoji" onclick="event.stopPropagation(); setReaction('${post.key}', 'love')"></div>
                                    <div class="reaction-emoji" onclick="event.stopPropagation(); setReaction('${post.key}', 'haha')"></div>
                                    <div class="reaction-emoji" onclick="event.stopPropagation(); setReaction('${post.key}', 'wow')"></div>
                                    <div class="reaction-emoji" onclick="event.stopPropagation(); setReaction('${post.key}', 'sad')"></div>
                                    <div class="reaction-emoji" onclick="event.stopPropagation(); setReaction('${post.key}', 'angry')"></div>
                                </div>
                                ${btnIcon} <span>${btnText}</span> <span style="margin-left:5px; opacity:0.6; font-size:11px;">(${likeCount})</span>
                            </div>
                            <button class="action-btn" onclick="openComments('${post.key}')">
                                <i data-lucide="message-circle" style="width:16px"></i> Comment
                            </button>
                            <button class="action-btn btn-share" onclick="sharePost('Radio Bingo', '${post.content.replace(/'/g, "")}', '${window.location.href}')">
                                <i data-lucide="share-2" style="width:16px"></i> Share
                            </button>
                        </div>
                    `;
                    
                    // Mobile Long Press Logic
                    const likeBtn = postDiv.querySelector('.like-wrapper');
                    let pressTimer;
                    likeBtn.addEventListener('touchstart', (e) => {
                        pressTimer = setTimeout(() => {
                            postDiv.querySelector('.reaction-popup').classList.add('show-mobile');
                        }, 500); 
                    });
                    likeBtn.addEventListener('touchend', () => {
                        clearTimeout(pressTimer);
                        setTimeout(() => postDiv.querySelector('.reaction-popup').classList.remove('show-mobile'), 3000);
                    });
                    
                    feedContainer.appendChild(postDiv);
                    
                    // AdSense Injection
                    adCounter++;
                    if(adCounter % 5 === 0) {
                         const adDiv = document.createElement('div');
                         adDiv.className = 'ad-container-global';
                         adDiv.style.margin = '10px auto';
                         adDiv.innerHTML = `<script type="text/javascript">atOptions = { 'key' : '59f94c5cb7bcd84edb277947774c3b9d', 'format' : 'iframe', 'height' : 50, 'width' : 320, 'params' : {} };<\/script><script type="text/javascript" src="https://directoryeditorweep.com/59f94c5cb7bcd84edb277947774c3b9d/invoke.js"><\/script>`;
                         feedContainer.appendChild(adDiv);
                    }
                });
                lucide.createIcons();
            });
        });
    }

    function toggleLike(postKey, authorUid) {
        const myUid = auth.currentUser.uid;
        const likeRef = db.ref('socialPosts/' + postKey + '/likes/' + myUid);
        likeRef.once('value', s => {
            if(s.exists()) {
                likeRef.remove(); // Unlike
            } else {
                likeRef.set('like'); // Default Like
            }
        });
    }

    function setReaction(postKey, type) {
        const myUid = auth.currentUser.uid;
        db.ref('socialPosts/' + postKey + '/likes/' + myUid).set(type);
        // Hide popup
        const pop = document.getElementById('react-' + postKey);
        if(pop) pop.classList.remove('show-mobile');
    }
    
    function sharePost(title, text, url) {
        if (navigator.share) {
            navigator.share({ title: title, text: text, url: url }).catch(console.error);
        } else {
            const tempInput = document.createElement("input");
            tempInput.value = text + " " + url;
            document.body.appendChild(tempInput);
            tempInput.select();
            document.execCommand("copy");
            document.body.removeChild(tempInput);
            showToast("Link copied to clipboard!");
        }
    }

</script>
</body>
</html>
