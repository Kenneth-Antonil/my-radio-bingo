<!DOCTYPE html>
<html lang="tl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#0f172a">
    <title>Radio Bingo Rewards | Play Free & Earn</title>
    <script>
        if (window.location.pathname.endsWith("index.html")) {
            var newPath = window.location.pathname.replace(/index\.html$/, "");
            window.history.replaceState({}, document.title, newPath);
        }
    </script>
    <link rel="icon" type="image/png" href="https://i.imgur.com/7D8u8h6.png">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;900&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-messaging.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <script src="https://pl28660488.effectivegatecpm.com/9b/f5/85/9bf585b6ee39cb9b515e2fae1fa958c2.js"></script>
    <script src="https://pl28660496.effectivegatecpm.com/a6/64/bf/a664bf7e7084386b4f4b428590030df3.js"></script>

    <style>
        :root { 
            --bg-overlay: rgba(15, 23, 42, 0.95); --glass-surface: rgba(30, 41, 59, 0.75); --glass-border: rgba(255, 255, 255, 0.1);
            --accent: #0ea5e9; --accent-glow: #38bdf8; --text: #ffffff; --gold: #fbbf24; --success: #10b981; --danger: #ef4444;
            --messenger-blue: #0084ff; --messenger-grey: #3e4042;
        }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; user-select: none; }
        body { font-family: 'Inter', sans-serif; background: radial-gradient(circle at top center, #1e293b 0%, #0f172a 60%, #020617 100%); background-attachment: fixed; color: var(--text); margin: 0; padding-bottom: 30px; overflow-x: hidden; min-height: 100vh; text-shadow: 0 1px 2px rgba(0,0,0,0.8); }

        /* === SKINS === */
        .card-skin-neon { border: 2px solid #06b6d4 !important; background: rgba(8, 51, 68, 0.9) !important; box-shadow: 0 0 20px #06b6d4; }
        .card-skin-neon .cell { border-color: #06b6d4 !important; color: #67e8f9 !important; text-shadow: 0 0 5px #06b6d4 !important; }
        .card-skin-gold { border: 2px solid #f59e0b !important; background: linear-gradient(135deg, #451a03, #000) !important; }
        .card-skin-gold .cell { border-color: #fbbf24 !important; color: #fcd34d !important; font-family: 'Times New Roman', serif; }
        
        /* NEW SKINS */
        .card-skin-kitty { border: 4px solid #ff69b4 !important; box-shadow: 0 0 20px #ff69b4, inset 0 0 20px rgba(255, 105, 180, 0.2) !important; background: radial-gradient(circle, #fff0f5, #ffc0cb) !important; }
        .card-skin-kitty .cell { border-color: #ff1493 !important; color: #d10056 !important; border-radius: 12px !important; background: rgba(255,255,255,0.6) !important; font-weight: 900 !important; text-shadow:none !important; }
        .card-skin-kitty .cell.hit { background: #ff1493 !important; color: white !important; }

        .card-skin-stitch { border: 4px solid #1e90ff !important; box-shadow: 0 0 20px #1e90ff !important; background: linear-gradient(135deg, #00008b, #4169e1) !important; }
        .card-skin-stitch .cell { border-color: #87cefa !important; color: #e0ffff !important; background: rgba(255,255,255,0.1) !important; font-family: sans-serif; }
        .card-skin-stitch .cell.hit { background: #1e90ff !important; color: white !important; box-shadow: 0 0 10px #87cefa; }

        .card-skin-doraemon { border: 4px solid #00bfff !important; background: linear-gradient(180deg, #0096FF, #ffffff 80%) !important; box-shadow: 0 0 25px #00bfff !important; }
        .card-skin-doraemon .cell { border: 2px solid #ff0000 !important; border-radius: 50% !important; background: white !important; color: #0096FF !important; text-shadow:none !important; }
        .card-skin-doraemon .cell.hit { background: #ffdd00 !important; color: black !important; border-color: black !important; }

        .card-skin-mickey { border: 4px solid #ff0000 !important; background: black !important; box-shadow: 0 0 20px #ff0000 !important; }
        .card-skin-mickey .cell { border-color: #ffff00 !important; color: white !important; border-radius: 50% !important; background: #ff0000 !important; }
        .card-skin-mickey .cell.hit { background: #ffff00 !important; color: black !important; transform: scale(1.1); }

        .card-skin-spongebob { border: 4px solid #8b4513 !important; background: #ffff00 !important; box-shadow: inset 0 0 50px rgba(0,0,0,0.2) !important; }
        .card-skin-spongebob .cell { border: 2px dashed #a0522d !important; background: rgba(255,255,255,0.8) !important; color: #333 !important; border-radius: 8px !important; text-shadow: none !important; }
        .card-skin-spongebob .cell.hit { background: #ffffff !important; color: #000 !important; border: 2px solid #000 !important; }

        /* UI COMPONENTS */
        #loginOverlay { position: fixed; inset: 0; background: radial-gradient(circle at top right, #1e293b, #0f172a 70%); z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 20px; }
        .login-app-container { width: 100%; max-width: 400px; text-align: center; }
        .app-logo-lg { font-size: 56px; font-weight: 900; color: white; margin-bottom: 10px; }
        .btn-main-auth { background: white; color: black; border: none; width: 100%; padding: 18px; border-radius: 16px; font-weight: 800; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 12px; }

        .nav { background: rgba(15, 23, 42, 0.95); backdrop-filter: blur(15px); padding: 10px 15px; display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 100; border-bottom: 1px solid rgba(255,255,255,0.1); }
        .points-badge { background: linear-gradient(135deg, rgba(251, 191, 36, 0.2), rgba(245, 158, 11, 0.4)); color: #fff; padding: 0 12px; height: 38px; border-radius: 12px; font-weight: 800; border: 1px solid rgba(251, 191, 36, 0.6); display: flex; align-items: center; gap: 6px; cursor: pointer; }
        
        .container { width: 100%; max-width: 500px; margin: 0 auto; padding: 10px; }
        .video-feed-wrapper { margin-bottom: 15px; border-radius: 24px; overflow: hidden; background: #000; border: 2px solid rgba(255,255,255,0.2); aspect-ratio: 16/9; position: relative; }
        
        .card { background: var(--glass-surface); backdrop-filter: blur(20px); border-radius: 24px; padding: 20px; margin-bottom: 20px; border: 1px solid var(--glass-border); transition: all 0.3s ease; }
        .grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 8px; }
        .cell { aspect-ratio: 1; background: rgba(255,255,255,0.1); border-radius: 12px; display: flex; align-items: center; justify-content: center; font-weight: 800; font-size: 18px; border: 1px solid rgba(255,255,255,0.15); color: white; position: relative; }
        .cell.hit { background: linear-gradient(135deg, var(--accent), #2563eb); transform: scale(1.05); border-color: rgba(255,255,255,0.6); box-shadow: 0 5px 15px rgba(59, 130, 246, 0.6); }
        .cell.win-glow { background: #10b981 !important; color: white; border: 2px solid #fff; box-shadow: 0 0 25px var(--success); }
        
        .chat-box { height: 480px; display: flex; flex-direction: column; background: #111827; border-radius: 20px; border: 1px solid rgba(255,255,255,0.1); overflow: hidden; margin-top: 15px; }
        .chat-row { display: flex; gap: 10px; margin-bottom: 12px; align-items: flex-end; }
        .bubble { padding: 10px 14px; font-size: 13px; color: #e2e8f0; background: #374151; border-radius: 18px; word-break: break-word; }
        
        .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 1000; display: none; align-items: center; justify-content: center; padding: 15px; backdrop-filter: blur(15px); }
        .modal-content { background: rgba(30, 41, 59, 0.95); border-radius: 30px; width: 100%; max-width: 450px; padding: 25px; border: 1px solid rgba(255,255,255,0.2); max-height: 90vh; overflow-y: auto; }
        
        .store-nav { display: flex; gap: 8px; margin-bottom: 15px; background: rgba(0,0,0,0.3); padding: 5px; border-radius: 12px; }
        .store-tab-btn { flex: 1; padding: 10px; border: none; background: transparent; color: #94a3b8; font-weight: 800; border-radius: 8px; cursor: pointer; }
        .store-tab-btn.active { background: var(--accent); color: white; }
        
        .skins-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
        .skin-item { background: rgba(255,255,255,0.05); padding: 10px; border-radius: 16px; border: 1px solid rgba(255,255,255,0.1); text-align: center; }
        .skin-preview { height: 60px; border-radius: 8px; margin-bottom: 8px; display: flex; align-items: center; justify-content: center; font-size: 20px; font-weight: 900; }
        .btn-buy-skin { width: 100%; padding: 8px; border: none; border-radius: 8px; font-weight: 800; cursor: pointer; }
        .btn-buy-skin.buy { background: var(--gold); color: black; }
        .btn-buy-skin.equip { background: var(--success); color: white; }
        .btn-buy-skin.owned { background: rgba(255,255,255,0.1); color: #cbd5e1; }
        
        /* Utils */
        #customToast { position: fixed; top: 20px; left: 50%; transform: translateX(-50%) translateY(-150%); background: rgba(15, 23, 42, 0.95); border: 1px solid var(--accent); padding: 16px 24px; border-radius: 16px; z-index: 100000; color: white; transition: transform 0.4s; }
        #customToast.show { transform: translateX(-50%) translateY(0); }
        .flying-coin { position: fixed; width: 24px; height: 24px; background-image: url('https://cdn-icons-png.flaticon.com/512/217/217853.png'); background-size: contain; z-index: 99999; pointer-events: none; }
        
        /* Notifications & Install Gates */
        #notifBlocker, #installGate, #splash-screen { position: fixed; inset: 0; z-index: 99999; display: flex; flex-direction: column; align-items: center; justify-content: center; background: #0f172a; text-align: center; padding: 20px; }
        #notifBlocker { background: rgba(15, 23, 42, 0.98); backdrop-filter: blur(10px); display: none; }
        #installGate { background-image: radial-gradient(circle at top right, rgba(14, 165, 233, 0.2), transparent 40%); display: none; }
        #splash-screen { transition: opacity 0.8s; }
        .gate-btn-install { background: linear-gradient(135deg, var(--accent), #2563eb); color: white; border: none; padding: 15px 30px; border-radius: 50px; font-weight: 900; margin-top: 20px; cursor: pointer; }
    </style>
</head>
<body>

<div id="customToast"><span id="toastMsg">Notification!</span></div>

<div id="splash-screen"><h1 style="font-size:40px; font-weight:900; color:white;">RB<span>LIVE</span></h1></div>

<div id="installGate">
    <h1 style="font-size:32px; font-weight:900; color:white;">RB<span>REWARDS</span></h1>
    <p style="color:#cbd5e1; margin-bottom:20px;">Install the app to play.</p>
    <button class="gate-btn-install" onclick="triggerInstall()">INSTALL APP</button>
</div>

<div id="notifBlocker">
    <i data-lucide="bell-off" style="width:50px; height:50px; color:#ef4444; margin-bottom:15px;"></i>
    <h2 style="color:white; margin:0;">ENABLE NOTIFICATIONS</h2>
    <p style="color:#94a3b8; font-size:14px;">Required for game alerts.</p>
    <button onclick="requestGatePermission()" style="margin-top:20px; padding:12px 24px; background:#3b82f6; color:white; border:none; border-radius:12px; font-weight:bold;">ALLOW</button>
</div>

<div id="loginOverlay">
    <div class="login-app-container">
        <div class="app-logo-lg">RB<span>LIVE</span></div>
        <p style="color:#cbd5e1; margin-bottom:30px;">Play Bingo & Earn Rewards (No Betting)</p>
        <button class="btn-main-auth" onclick="login()">
            <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/action/google.svg" alt="Google" style="width:20px"> Sign in with Google
        </button>
    </div>
</div>

<div id="customConfirmModal" class="modal">
    <div class="modal-content" style="text-align:center;">
        <h3 id="confTitle" style="margin-top:0;">Confirm</h3>
        <p id="confMsg" style="color:#cbd5e1;">Are you sure?</p>
        <div style="display:flex; gap:10px; justify-content:center;">
            <button onclick="closeCustomConfirm()" style="background:rgba(255,255,255,0.1); border:none; padding:10px 20px; color:white; border-radius:8px;">Cancel</button>
            <button id="confYesBtn" style="background:var(--accent); border:none; padding:10px 20px; color:white; border-radius:8px;">Confirm</button>
        </div>
    </div>
</div>

<div class="nav">
    <div style="font-weight:900; font-size:20px;">RB <span style="color:var(--accent-glow)">LIVE</span></div>
    <div id="userPanel" style="display:none; align-items:center; gap:10px;">
        <div class="points-badge" onclick="document.getElementById('storeModal').style.display='flex'">
            <i data-lucide="coins" style="width:16px"></i> <span id="userPoints">0</span>
        </div>
        <img id="userImg" src="" style="width:40px; height:40px; border-radius:50%; border:2px solid var(--accent);" onclick="document.getElementById('menuModal').style.display='flex'">
    </div>
</div>

<div class="container">
    <div class="video-feed-wrapper">
        <div id="videoOfflineState" style="display:none; position:absolute; inset:0; background:#0f172a; align-items:center; justify-content:center; flex-direction:column;">
            <i data-lucide="radio" style="width:40px; height:40px; color:#475569;"></i>
            <span style="color:white; font-weight:bold; margin-top:10px;">WAITING FOR LIVE</span>
        </div>
        <iframe id="liveVideoFrame" width="100%" height="100%" src="https://www.youtube.com/embed/4I_NSJTbdXo?autoplay=1&mute=1" frameborder="0" allowfullscreen style="border:none;"></iframe>
    </div>

    <div id="jackpotBanner" style="display:none; background:linear-gradient(135deg, #451a03, #000); border:1px solid var(--gold); padding:15px; border-radius:16px; margin-bottom:15px; text-align:center;">
        <div style="color:var(--gold); font-size:12px; font-weight:bold;">GRAND PRIZE</div>
        <div style="font-size:32px; font-weight:900; color:white;" id="jackpotDisplayVal">0</div>
    </div>

    <div id="winnerBanner" style="display:none; background:#10b981; color:white; padding:10px; border-radius:12px; text-align:center; margin-bottom:15px; font-weight:bold;"></div>

    <div id="bingoTab">
        <div style="display:flex; justify-content:space-between; margin-bottom:15px; background:rgba(0,0,0,0.3); padding:10px; border-radius:12px;">
            <div id="ballRow" style="display:flex; gap:5px; overflow-x:auto;"></div>
            <div id="currentBall" style="font-size:36px; font-weight:900; color:white; min-width:60px; text-align:center;">--</div>
        </div>

        <div class="card" id="bingoCardContainer">
            <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
                <span id="patternName" style="color:var(--gold); font-weight:bold;">Normal Bingo</span>
                <button id="newCardBtn" onclick="generateNewCard()" style="background:var(--accent); border:none; color:white; padding:5px 10px; border-radius:6px; font-weight:bold; cursor:pointer;">NEW CARD</button>
            </div>
            <div class="bingo-header"><div class="letter">B</div><div class="letter">I</div><div class="letter">N</div><div class="letter">G</div><div class="letter">O</div></div>
            <div class="grid" id="bingoGrid"></div>
        </div>
    </div>

    <div class="chat-box">
        <div style="padding:10px; background:rgba(255,255,255,0.05); font-weight:bold; border-bottom:1px solid rgba(255,255,255,0.1);">LIVE CHAT</div>
        <div id="chatList" style="flex:1; overflow-y:auto; padding:10px;"></div>
        <div style="padding:10px; display:flex; gap:10px;">
            <input type="text" id="chatIn" placeholder="Chat here..." style="flex:1; padding:10px; border-radius:20px; border:none; background:#374151; color:white;">
            <button onclick="sendChat()" style="background:var(--accent); border:none; width:40px; height:40px; border-radius:50%; color:white;"><i data-lucide="send" style="width:16px"></i></button>
        </div>
    </div>
</div>

<div id="storeModal" class="modal" onclick="this.style.display='none'">
    <div class="modal-content" onclick="event.stopPropagation()">
        <h3>MARKETPLACE</h3>
        <div class="store-nav">
            <button class="store-tab-btn active" onclick="switchStoreTab('cashout')" id="tabBtnCash">Redeem</button>
            <button class="store-tab-btn" onclick="switchStoreTab('skins')" id="tabBtnSkins">Skins</button>
            <button class="store-tab-btn" onclick="switchStoreTab('earn')" id="tabBtnEarn">Tasks</button>
        </div>

        <div id="storeSection-cashout">
            <div style="background:rgba(255,255,255,0.1); padding:15px; border-radius:12px; display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                <div><b>â‚±20 GCash</b><br><small>50,000 Coins</small></div>
                <button class="btn-buy-skin equip" onclick="redeemItem('â‚±20 GCash', 50000)">REDEEM</button>
            </div>
            <div style="background:rgba(255,255,255,0.1); padding:15px; border-radius:12px; display:flex; justify-content:space-between; align-items:center;">
                <div><b>â‚±50 GCash</b><br><small>125,000 Coins</small></div>
                <button class="btn-buy-skin equip" onclick="redeemItem('â‚±50 GCash', 125000)">REDEEM</button>
            </div>
        </div>

        <div id="storeSection-skins" style="display:none;">
            <div class="skins-grid">
                <div class="skin-item">
                    <div class="skin-preview" style="background:radial-gradient(circle, #fff0f5, #ffc0cb); border:2px solid #ff69b4; color:#d10056;">HK</div>
                    <div class="skin-name">Hello Kitty</div>
                    <div class="skin-cost">75k</div>
                    <button class="btn-buy-skin buy" id="btn-skin-kitty" onclick="buyOrEquipSkin('kitty', 75000)">BUY</button>
                </div>
                <div class="skin-item">
                    <div class="skin-preview" style="background:linear-gradient(135deg, #00008b, #4169e1); border:2px solid #1e90ff; color:#e0ffff;">ST</div>
                    <div class="skin-name">Stitch</div>
                    <div class="skin-cost">75k</div>
                    <button class="btn-buy-skin buy" id="btn-skin-stitch" onclick="buyOrEquipSkin('stitch', 75000)">BUY</button>
                </div>
                <div class="skin-item">
                    <div class="skin-preview" style="background:#0096FF; border:2px solid #00bfff; color:white; border-radius:50%;">DM</div>
                    <div class="skin-name">Doraemon</div>
                    <div class="skin-cost">60k</div>
                    <button class="btn-buy-skin buy" id="btn-skin-doraemon" onclick="buyOrEquipSkin('doraemon', 60000)">BUY</button>
                </div>
                <div class="skin-item">
                    <div class="skin-preview" style="background:black; border:2px solid #ff0000; color:yellow;">MM</div>
                    <div class="skin-name">Mickey</div>
                    <div class="skin-cost">60k</div>
                    <button class="btn-buy-skin buy" id="btn-skin-mickey" onclick="buyOrEquipSkin('mickey', 60000)">BUY</button>
                </div>
                <div class="skin-item">
                    <div class="skin-preview" style="background:#ffff00; border:2px solid #8b4513; color:#333;">SB</div>
                    <div class="skin-name">Spongebob</div>
                    <div class="skin-cost">50k</div>
                    <button class="btn-buy-skin buy" id="btn-skin-spongebob" onclick="buyOrEquipSkin('spongebob', 50000)">BUY</button>
                </div>
                <div class="skin-item">
                    <div class="skin-preview" style="background:rgba(30,41,59,0.8); border:1px solid rgba(255,255,255,0.1);">B</div>
                    <div class="skin-name">Classic</div>
                    <div class="skin-cost">Free</div>
                    <button class="btn-buy-skin equip" id="btn-skin-default" onclick="equipSkin('default')">EQUIP</button>
                </div>
            </div>
        </div>

        <div id="storeSection-earn" style="display:none;">
            <div id="adTimerOverlay" style="display:none; position:absolute; inset:0; background:rgba(0,0,0,0.95); z-index:50; flex-direction:column; align-items:center; justify-content:center;">
                <h1 id="adCountdown" style="color:white; font-size:40px;">15s</h1>
                <p style="color:#cbd5e1;">Watching Ad...</p>
            </div>
            <button onclick="startStrictWatch()" style="background:linear-gradient(135deg, #f59e0b, #b45309); width:100%; border:none; padding:15px; border-radius:12px; font-weight:900; color:white;">ðŸ“º WATCH AD (+50 Coins)</button>
        </div>
    </div>
</div>

<div id="menuModal" class="modal" onclick="this.style.display='none'">
    <div class="modal-content" onclick="event.stopPropagation()">
        <h3>PROFILE</h3>
        <h2 id="profileNameDisplay">User</h2>
        <div style="margin-bottom:15px;">
            <label style="font-size:10px;">GCASH NUMBER</label>
            <div style="display:flex; gap:5px;">
                <input type="number" id="gcashInput" style="flex:1; padding:10px; background:rgba(0,0,0,0.3); border:1px solid rgba(255,255,255,0.2); color:white; border-radius:8px;">
                <button onclick="saveGcash()" style="background:var(--accent); color:white; border:none; padding:0 15px; border-radius:8px;">SAVE</button>
            </div>
        </div>
        <button onclick="auth.signOut().then(()=>location.reload())" style="width:100%; padding:10px; background:var(--danger); color:white; border:none; border-radius:8px;">Sign Out</button>
    </div>
</div>

<script>
    // INIT
    window.addEventListener('load', () => { setTimeout(()=>document.getElementById('splash-screen').style.opacity=0, 2000); setTimeout(()=>document.getElementById('splash-screen').style.display='none', 2800); checkNotifGate(); checkInstallGate(); });
    const firebaseConfig = { apiKey: "AIzaSyDIAQXJ15atKJxu7PtcFL1W9JnO1N14pVs", authDomain: "radiobingo-9ac29.firebaseapp.com", databaseURL: "https://radiobingo-9ac29-default-rtdb.asia-southeast1.firebasedatabase.app", projectId: "radiobingo-9ac29", storageBucket: "radiobingo-9ac29.firebasestorage.app", messagingSenderId: "965903993397", appId: "1:965903993397:web:f6646fa05225f147eebf7c" };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database(); const auth = firebase.auth();
    let messaging; try { messaging = firebase.messaging(); } catch(e){}

    let userData={}, cardNumbers=[], marks=[12], gameDrawn=[];

    // AUTH
    function login() { auth.signInWithPopup(new firebase.auth.GoogleAuthProvider()); }
    auth.onAuthStateChanged(u => {
        if(u) {
            document.getElementById('loginOverlay').style.display = 'none'; document.getElementById('userPanel').style.display = 'flex';
            document.getElementById('userImg').src = u.photoURL; document.getElementById('profileNameDisplay').innerText = u.displayName;
            if(messaging) messaging.getToken().then(t => db.ref('users/'+u.uid).update({fcmToken:t}));
            
            db.ref('users/'+u.uid).on('value', s => {
                if(s.exists()){ 
                    userData = s.val(); userData.uid = u.uid; 
                    document.getElementById('userPoints').innerText = (userData.points||0).toLocaleString();
                    if(userData.gcash) document.getElementById('gcashInput').value = userData.gcash;
                    if(userData.currentCard) { cardNumbers = userData.currentCard; renderCard(); } else { generateNewCard(); }
                    applySkin(userData.equippedSkin || 'default');
                    updateSkinButtons();
                } else {
                    db.ref('users/'+u.uid).set({ name: u.displayName, photo: u.photoURL, points: 500, ownedSkins:['default'], equippedSkin:'default' });
                }
            });
            setupGame();
        } else { document.getElementById('loginOverlay').style.display = 'flex'; }
    });

    // GAME
    function setupGame() {
        db.ref('drawnNumbers').on('value', s => {
            const val = s.val();
            const newDrawn = val ? Object.values(val).map(n=>n.toString()) : [];
            if(newDrawn.length > gameDrawn.length && newDrawn.length > 0) {
                 const ball = newDrawn[newDrawn.length-1];
                 showToast("BOLA: "+ball);
                 speakNumber(ball);
            }
            gameDrawn = newDrawn;
            const row = document.getElementById('ballRow'); row.innerHTML = "";
            gameDrawn.slice(-5).reverse().forEach(n => {
                let d = document.createElement('div'); d.innerText = n; d.style.background="#334155"; d.style.width="30px"; d.style.height="30px"; d.style.borderRadius="50%"; d.style.display="flex"; d.style.alignItems="center"; d.style.justifyContent="center"; row.appendChild(d);
            });
            if(gameDrawn.length>0) document.getElementById('currentBall').innerText = gameDrawn[gameDrawn.length-1];
            
            const btn = document.getElementById('newCardBtn');
            if(gameDrawn.length>0) { btn.disabled=true; btn.innerText="LOCKED"; } else { btn.disabled=false; btn.innerText="NEW CARD"; }
            
            renderCard(); checkWin();
        });

        db.ref('chats').limitToLast(20).on('child_added', s => {
            const d = s.val();
            const list = document.getElementById('chatList');
            const div = document.createElement('div'); div.style.marginBottom="5px"; div.style.fontSize="13px";
            div.innerHTML = `<b style="color:#cbd5e1">${d.name}:</b> <span style="color:white">${d.msg}</span>`;
            list.appendChild(div); list.scrollTop = list.scrollHeight;
        });

        db.ref('gameState/videoSettings').on('value', s => {
            const v = s.val();
            const iframe = document.getElementById('liveVideoFrame');
            const offline = document.getElementById('videoOfflineState');
            if (v && v.type === 'offline') { iframe.style.display='none'; offline.style.display='flex'; } 
            else if(v && v.url) { 
                offline.style.display='none'; iframe.style.display='block';
                const match = v.url.match(/^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|&v=)([^#&?]*).*/);
                const vid = (match&&match[2].length===11)?match[2]:v.url;
                if(iframe.src !== `https://www.youtube.com/embed/${vid}?autoplay=1&mute=1`) iframe.src = `https://www.youtube.com/embed/${vid}?autoplay=1&mute=1`;
            }
        });

        db.ref('gameState/jackpot').on('value', s=>{ if(s.val() && s.val().active) { document.getElementById('jackpotBanner').style.display='block'; document.getElementById('jackpotDisplayVal').innerText = s.val().amount; } else { document.getElementById('jackpotBanner').style.display='none'; } });
        
        db.ref('gameState/latestWinner').on('value', s=>{
            const win = s.val(); const ban = document.getElementById('winnerBanner');
            if(win && win.name) {
                ban.style.display='block'; ban.innerHTML = `WINNER: ${win.name}`;
                if(win.uid === auth.currentUser.uid) { confetti(); showToast("YOU WON!"); }
            } else { ban.style.display='none'; }
        });
    }

    function generateNewCard() {
        if(gameDrawn.length > 0) return showToast("Game ongoing!");
        let card = []; 
        [[1,15],[16,30],[31,45],[46,60],[61,75]].forEach(r => {
            let nums = []; while(nums.length < 5) { let n = Math.floor(Math.random()*(r[1]-r[0]+1))+r[0]; if(!nums.includes(n)) nums.push(n); }
            card.push(...nums);
        });
        let final = []; for(let r=0;r<5;r++) for(let c=0;c<5;c++) final.push(card[c*5+r]); final[12] = "FREE";
        db.ref('users/'+auth.currentUser.uid).update({ currentCard: final });
    }

    function renderCard() {
        const grid = document.getElementById('bingoGrid'); grid.innerHTML = "";
        cardNumbers.forEach((n,i) => {
            const div = document.createElement('div'); div.className = 'cell'; div.innerText = n==="FREE"?"â˜…":n;
            if(gameDrawn.includes(n.toString()) || n==="FREE") { div.classList.add('hit'); if(!marks.includes(i)) marks.push(i); }
            grid.appendChild(div);
        });
        applySkin(userData.equippedSkin || 'default');
    }

    function checkWin() {
        // Simple logic: If Server declares winner, we just show it.
        // Add specific pattern checks here if needed for client-side highlights.
    }

    function sendChat() {
        const inp = document.getElementById('chatIn');
        if(inp.value.trim()) { db.ref('chats').push({ name: userData.name, msg: inp.value, uid: userData.uid }); inp.value=""; }
    }

    // SKINS & STORE
    function switchStoreTab(tab) {
        document.getElementById('storeSection-cashout').style.display = tab==='cashout'?'block':'none';
        document.getElementById('storeSection-skins').style.display = tab==='skins'?'block':'none';
        document.getElementById('storeSection-earn').style.display = tab==='earn'?'block':'none';
        document.querySelectorAll('.store-tab-btn').forEach(b=>b.classList.remove('active'));
    }

    function applySkin(skinId) {
        const card = document.getElementById('bingoCardContainer'); card.className = 'card';
        if(skinId !== 'default') card.classList.add('card-skin-'+skinId);
    }

    function buyOrEquipSkin(skinId, cost) {
        if(userData.ownedSkins.includes(skinId)) {
            db.ref('users/'+userData.uid).update({ equippedSkin: skinId }); showToast("Equipped!");
        } else if(userData.points >= cost) {
            showCustomConfirm("Buy Skin?", cost+" Coins", () => {
                db.ref('users/'+userData.uid+'/points').transaction(p=>(p||0)-cost);
                let newOwned = [...userData.ownedSkins, skinId];
                db.ref('users/'+userData.uid).update({ ownedSkins: newOwned, equippedSkin: skinId });
                showToast("Purchased!");
            });
        } else { showToast("Insufficient Coins"); }
    }

    function updateSkinButtons() {
        ['kitty','stitch','doraemon','mickey','spongebob'].forEach(s => {
            const btn = document.getElementById('btn-skin-'+s);
            if(userData.ownedSkins && userData.ownedSkins.includes(s)) { btn.innerText = "EQUIP"; btn.className="btn-buy-skin equip"; }
        });
    }

    function startStrictWatch() {
        window.open("https://directoryeditorweep.com/9b/f5/85/9bf585b6ee39cb9b515e2fae1fa958c2.js", "_blank");
        const overlay = document.getElementById('adTimerOverlay'); overlay.style.display='flex';
        let t=15; const cd = document.getElementById('adCountdown');
        const timer = setInterval(()=>{ 
            t--; cd.innerText=t+"s"; 
            if(t<=0) { clearInterval(timer); overlay.style.display='none'; db.ref('users/'+userData.uid+'/points').transaction(p=>(p||0)+50); showToast("+50 Coins"); }
        },1000);
    }

    function saveGcash() { const v = document.getElementById('gcashInput').value; if(v.length>=10) { db.ref('users/'+auth.currentUser.uid).update({ gcash: v }); showToast("Saved"); } }
    function redeemItem(item, cost) {
        if(userData.points >= cost) {
            showCustomConfirm("Redeem?", item, () => {
                db.ref('users/'+userData.uid+'/points').transaction(p=>(p||0)-cost);
                db.ref('redemptions').push({ uid: userData.uid, name: userData.name, item: item, cost: cost, status: 'pending', timestamp: Date.now() });
                showToast("Request Sent!");
            });
        } else showToast("Insufficient Coins");
    }

    // UTILS
    function showToast(msg) { document.getElementById('toastMsg').innerText = msg; document.getElementById('customToast').classList.add('show'); setTimeout(()=>document.getElementById('customToast').classList.remove('show'),3000); }
    let confirmCallback;
    function showCustomConfirm(t,m,cb) { document.getElementById('confTitle').innerText=t; document.getElementById('confMsg').innerText=m; document.getElementById('customConfirmModal').style.display='flex'; confirmCallback=cb; }
    function closeCustomConfirm() { document.getElementById('customConfirmModal').style.display='none'; confirmCallback=null; }
    document.getElementById('confYesBtn').addEventListener('click', ()=>{ if(confirmCallback) confirmCallback(); closeCustomConfirm(); });
    
    function speakNumber(num) { if ('speechSynthesis' in window) { const msg = new SpeechSynthesisUtterance(num); window.speechSynthesis.speak(msg); } }
    function checkNotifGate() { if(!("Notification" in window))return; if(Notification.permission==="denied") document.getElementById('notifBlocker').style.display='flex'; }
    function requestGatePermission() { Notification.requestPermission().then(p=>{ if(p==="granted") document.getElementById('notifBlocker').style.display='none'; }); }
    function checkInstallGate() { if(!window.matchMedia('(display-mode: standalone)').matches) document.getElementById('installGate').style.display='flex'; }
    let prompt; window.addEventListener('beforeinstallprompt', e=>{e.preventDefault(); prompt=e;});
    function triggerInstall() { if(prompt) prompt.prompt(); else alert("Use browser menu to install."); }

    lucide.createIcons();
</script>
</body>
</html>
