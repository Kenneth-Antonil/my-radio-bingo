<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="Content-Security-Policy" content="default-src 'self' https://*.firebase.com https://*.firebaseapp.com https://*.googleapis.com https://*.gstatic.com https://unpkg.com https://cdnjs.cloudflare.com https://*.firebasedatabase.app; script-src 'self' 'unsafe-inline' 'unsafe-eval' https://unpkg.com https://www.gstatic.com https://cdnjs.cloudflare.com https://www.googletagmanager.com https://cdn.jsdelivr.net; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; font-src https://fonts.gstatic.com data:; img-src * data: blob:; connect-src 'self' wss://*.firebaseio.com wss://*.firebasedatabase.app https://*.firebasedatabase.app https://*.googleapis.com https://*.firebase.com https://*.firebaseapp.com https://fcm.googleapis.com https://oauth2.googleapis.com https://unpkg.com https://www.gstatic.com https://cdn.jsdelivr.net https://cdnjs.cloudflare.com; frame-src https://www.youtube.com https://player.vimeo.com; media-src blob: https:;">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, interactive-widget=resizes-visual">
    <meta name="theme-color" content="#0f172a">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Radio Bingo Live | Social Ecosystem</title>
    
    <script>
        if (window.location.pathname.endsWith("index.html")) {
            var newPath = window.location.pathname.replace(/index\.html$/, "");
            window.history.replaceState({}, document.title, newPath);
        }
    </script>

    <link rel="icon" type="image/png" href="https://i.imgur.com/7D8u8h6.png">
    <link rel="apple-touch-icon" href="https://i.imgur.com/7D8u8h6.png">
    <link rel="manifest" href="manifest.json">
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;900&family=Comic+Neue:wght@700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-messaging.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

    <!-- Removed suspicious scripts from effectivegatecpm.com -->

    <style>
        /* === CORE VARIABLES === */
        :root { 
    
    /* 
    DATABASE NORMALIZATION - PROPER 3NF STRUCTURE
    ALL DATA IS PROPERLY NORMALIZED - NO REDUNDANCY!
    socialPosts, postComments, supportTicketReplies: Only store UID
    users/{uid}: name, photo, bio, verified, points, bingoWins, etc.
    */

            --bg-overlay: rgba(15, 23, 42, 0.95); 
            --glass-surface: rgba(30, 41, 59, 0.75);
            --glass-border: rgba(255, 255, 255, 0.1);
            
            --accent: #0ea5e9; /* Ocean Blue */
            --accent-glow: #38bdf8;
            --text: #ffffff; 
            --gold: #fbbf24; 
            --gold-shine: #fcd34d;
            --success: #10b981; 
            --danger: #ef4444; 
            --minigame: #f472b6;
            
            /* Messenger Colors */
            --messenger-blue: #3b82f6;
            --messenger-grey: #334155;
            --messenger-bg: #020617;
            
            /* Spacing System */
            --spacing-xs: 8px;
            --spacing-sm: 12px;
            --spacing-md: 16px;
            --spacing-lg: 20px;
            --spacing-xl: 24px;
            
            /* Border Radius */
            --radius-sm: 8px;
            --radius-md: 12px;
            --radius-lg: 16px;
            --radius-xl: 20px;
            --radius-full: 50px;
        }
        
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; user-select: none; }
        
        body { 
            font-family: 'Inter', sans-serif; 
            background: #0f172a;
            color: var(--text); 
            margin: 0; 
            padding-bottom: calc(20px + env(safe-area-inset-bottom)); 
            overflow-x: hidden; 
            min-height: 100vh;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.5);
        }

        /* === FULLSCREEN PHOTO VIEWER === */
        .fullscreen-photo-viewer {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.98);
            z-index: 99999;
            flex-direction: column;
        }
        .fullscreen-photo-viewer.active { display: flex; }
        
        .fullscreen-header {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            padding: var(--spacing-md);
            padding-top: max(var(--spacing-md), env(safe-area-inset-top));
            background: linear-gradient(180deg, rgba(0,0,0,0.8) 0%, transparent 100%);
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 10;
        }
        
        .fullscreen-close-btn {
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.2);
            color: white;
            font-size: 24px;
            cursor: pointer;
            padding: 8px;
            border-radius: var(--radius-sm);
            display: flex;
            align-items: center;
            justify-content: center;
            width: 40px;
            height: 40px;
            backdrop-filter: blur(10px);
        }
        
        .fullscreen-menu-btn {
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.2);
            color: white;
            cursor: pointer;
            padding: 8px;
            border-radius: var(--radius-sm);
            display: flex;
            align-items: center;
            justify-content: center;
            width: 40px;
            height: 40px;
            position: relative;
            backdrop-filter: blur(10px);
        }
        
        .photo-menu-dropdown {
            display: none;
            position: absolute;
            top: 100%;
            right: 0;
            margin-top: 8px;
            background: rgba(30, 41, 59, 0.98);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: var(--radius-md);
            min-width: 200px;
            overflow: hidden;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(20px);
            z-index: 100;
        }
        .photo-menu-dropdown.show { display: block; }
        
        .photo-menu-item {
            padding: var(--spacing-md);
            color: white;
            display: flex;
            align-items: center;
            gap: 12px;
            cursor: pointer;
            transition: background 0.2s;
            font-size: 14px;
            font-weight: 500;
        }
        .photo-menu-item:hover { background: rgba(255, 255, 255, 0.1); }
        .photo-menu-item i { width: 20px; height: 20px; }
        
        .fullscreen-photo-container {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 80px var(--spacing-xl) 120px;
            overflow: hidden;
        }
        
        .fullscreen-photo-container img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
            user-select: none;
            border-radius: var(--radius-md);
        }
        
        .fullscreen-photo-container video {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
            border-radius: var(--radius-md);
        }
        
        .fullscreen-footer {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            padding: var(--spacing-lg);
            padding-bottom: max(var(--spacing-lg), env(safe-area-inset-bottom));
            background: linear-gradient(0deg, rgba(0,0,0,0.8) 0%, transparent 100%);
            display: flex;
            justify-content: center;
            gap: 40px;
            z-index: 10;
        }
        
        .fullscreen-action-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 6px;
            background: none;
            border: none;
            color: white;
            cursor: pointer;
            padding: 8px;
            transition: all 0.2s;
        }
        .fullscreen-action-btn:hover { transform: scale(1.1); }
        .fullscreen-action-btn i { width: 32px; height: 32px; }
        .fullscreen-action-btn.liked i { color: #ef4444; fill: #ef4444; }
        .fullscreen-action-btn span {
            font-size: 13px;
            font-weight: 600;
            text-shadow: 0 2px 4px rgba(0,0,0,0.8);
        }

        /* === BADGE & ONLINE SYSTEM === */
        .avatar-frame {
            position: relative;
            display: inline-block;
            flex-shrink: 0;
            cursor: pointer;
        }
        .avatar-frame img {
            display: block;
            border-radius: 50%;
            border: 2px solid rgba(255,255,255,0.1);
            object-fit: cover;
        }
        
        /* UPDATED: Green Online Dot */
        .online-indicator {
            position: absolute;
            bottom: 2px;
            right: 2px;
            width: 14px;
            height: 14px;
            background-color: #22c55e;
            border: 2px solid #0f172a;
            border-radius: 50%;
            z-index: 20;
            display: none; /* Hidden by default */
            box-shadow: 0 0 5px rgba(34, 197, 94, 0.5);
        }
        .online-indicator.is-online { display: block; }

        /* Inline Follow Button - for Beats tab */
        .inline-follow-btn {
            padding: 4px 12px;
            background: var(--accent);
            color: white;
            border: none;
            border-radius: var(--radius-full);
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            margin-left: 8px;
            transition: all 0.2s;
        }
        .inline-follow-btn:hover {
            background: var(--accent-glow);
            transform: scale(1.05);
        }
        .inline-follow-btn.following {
            background: var(--glass-surface);
            border: 1px solid var(--glass-border);
        }
        .inline-follow-btn.following:hover {
            background: var(--danger);
            border-color: var(--danger);
        }

        /* Inline Verification Badge */
        .inline-badge {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            margin-left: 4px;
            vertical-align: middle;
        }

        .avatar-badge-icon {
            position: absolute;
            bottom: -2px;
            left: -2px; /* Changed from right to left to avoid overlap with online indicator */
            width: 40%; /* Scales relative to image */
            height: 40%;
            border-radius: 50%;
            background: #0f172a; /* Background to make it pop */
            border: 2px solid #0f172a;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            z-index: 10;
            box-shadow: 0 2px 5px rgba(0,0,0,0.5);
            font-size: 10px;
        }
        .tier-bronze-bg { background: linear-gradient(135deg, #cd7f32, #a0522d); }
        .tier-silver-bg { background: linear-gradient(135deg, #e0e0e0, #9ca3af); }
        .tier-gold-bg { background: linear-gradient(135deg, #fcd34d, #b45309); border: 1px solid #fcd34d; }
        .tier-platinum-bg { background: linear-gradient(135deg, #e5e4e2, #64748b); border: 1px solid white; }
        .tier-diamond-bg { background: linear-gradient(135deg, #b9f2ff, #06b6d4); box-shadow: 0 0 5px #06b6d4; border: 1px solid #06b6d4; }

        /* === MODERN POST CREATOR (Premium Social Media Style) === */
        .post-creator-modern {
            background: linear-gradient(145deg, rgba(30, 41, 59, 0.95), rgba(22, 27, 34, 0.95));
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            padding: 0;
            border-radius: 20px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            margin-bottom: 20px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.4), 
                        0 0 0 1px rgba(59, 130, 246, 0.05);
            overflow: hidden;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .post-creator-modern:hover {
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.5),
                        0 0 0 1px rgba(59, 130, 246, 0.2);
            transform: translateY(-2px);
        }

        /* Post Creator Header with Avatar */
        .post-creator-header {
            display: flex;
            align-items: flex-start;
            gap: 14px;
            padding: 20px 20px 0 20px;
        }

        .post-creator-avatar {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            object-fit: cover;
            border: 2.5px solid rgba(59, 130, 246, 0.3);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4),
                        0 0 0 3px rgba(59, 130, 246, 0.1);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            cursor: pointer;
            flex-shrink: 0;
        }
        .post-creator-avatar:hover {
            transform: scale(1.08);
            border-color: rgba(59, 130, 246, 0.6);
            box-shadow: 0 6px 20px rgba(59, 130, 246, 0.3),
                        0 0 0 3px rgba(59, 130, 246, 0.2);
        }
        .post-creator-avatar:active {
            transform: scale(1.02);
        }

        .post-input-wrapper {
            flex: 1;
            position: relative;
        }

        .post-input-modern {
            background: transparent;
            border: none;
            border-radius: 0;
            padding: 0;
            color: rgba(255, 255, 255, 0.95);
            font-family: 'Inter', sans-serif;
            font-size: 16px;
            line-height: 1.6;
            width: 100%;
            resize: none;
            min-height: 70px;
            max-height: 350px;
            outline: none;
            font-weight: 400;
            transition: all 0.2s ease;
        }
        .post-input-modern::placeholder {
            color: rgba(255, 255, 255, 0.4);
            font-weight: 400;
        }
        .post-input-modern:focus {
            color: rgba(255, 255, 255, 1);
        }
        .post-input-modern:focus::placeholder {
            color: rgba(255, 255, 255, 0.25);
        }

        /* Always visible action bar - no dropdown */
        .post-creator-body {
            display: block !important;
            padding: 0;
        }

        /* Image Preview */
        .image-preview-container {
            position: relative;
            margin: 16px 20px;
            border-radius: 16px;
            overflow: hidden;
            background: rgba(0, 0, 0, 0.4);
            border: 1.5px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            display: none;
        }
        .image-preview-container.show {
            display: block;
        }
        .image-preview-img {
            width: 100%;
            max-height: 450px;
            object-fit: cover;
            display: block;
        }
        .btn-remove-img {
            position: absolute;
            top: 12px;
            right: 12px;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: rgba(15, 23, 42, 0.95);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1.5px solid rgba(255, 255, 255, 0.15);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
            color: white;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5);
        }
        .btn-remove-img:hover {
            background: linear-gradient(135deg, #ef4444, #dc2626);
            transform: scale(1.1) rotate(90deg);
            border-color: rgba(239, 68, 68, 0.5);
            box-shadow: 0 6px 16px rgba(239, 68, 68, 0.4);
        }
        .btn-remove-img:active {
            transform: scale(1.0) rotate(90deg);
        }
        .btn-remove-img i {
            width: 18px;
            height: 18px;
        }
        
        /* Hide mood selector - keep it simple */
        .mood-selector {
            display: none;
        }
        .mood-selector::-webkit-scrollbar {
            height: 4px;
        }
        .mood-selector::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 2px;
        }
        .mood-selector::-webkit-scrollbar-thumb {
            background: rgba(59, 130, 246, 0.3);
            border-radius: 2px;
        }
        .mood-selector::-webkit-scrollbar-thumb:hover {
            background: rgba(59, 130, 246, 0.5);
        }
        
        .mood-chip {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.1), rgba(59, 130, 246, 0.05));
            border: 1.5px solid rgba(59, 130, 246, 0.2);
            padding: 10px 18px;
            border-radius: 24px;
            font-size: 13px;
            font-weight: 600;
            color: rgba(255, 255, 255, 0.7);
            white-space: nowrap;
            cursor: pointer;
            transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            flex-shrink: 0;
            position: relative;
            overflow: hidden;
        }
        .mood-chip::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.1), transparent);
            transition: left 0.5s;
        }
        .mood-chip:hover::before {
            left: 100%;
        }
        .mood-chip:hover {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.25), rgba(59, 130, 246, 0.15));
            border-color: rgba(59, 130, 246, 0.4);
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
        }
        .mood-chip:active {
            transform: translateY(0) scale(0.98);
        }
        .mood-chip.selected {
            background: linear-gradient(135deg, #3b82f6, #2563eb);
            border-color: #3b82f6;
            color: white;
            box-shadow: 0 4px 16px rgba(59, 130, 246, 0.5), 0 0 20px rgba(59, 130, 246, 0.3);
            animation: pulseGlow 2s infinite;
        }
        @keyframes pulseGlow {
            0%, 100% { box-shadow: 0 4px 16px rgba(59, 130, 246, 0.5), 0 0 20px rgba(59, 130, 246, 0.3); }
            50% { box-shadow: 0 4px 20px rgba(59, 130, 246, 0.6), 0 0 24px rgba(59, 130, 246, 0.4); }
        }

        /* Modern Action Bar */
        .post-tools {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 8px;
            padding: 16px 20px 18px 20px;
            background: rgba(15, 23, 42, 0.3);
            border-top: 1px solid rgba(255, 255, 255, 0.06);
        }
        
        .post-actions-left {
            display: flex;
            gap: 4px;
            align-items: center;
        }

        .tool-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            background: transparent;
            border: none;
            border-radius: 50%;
            padding: 8px;
            width: 40px;
            height: 40px;
            color: #60a5fa;
            cursor: pointer;
            transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
        }
        .tool-btn:hover {
            background: rgba(59, 130, 246, 0.12);
            color: #3b82f6;
            transform: scale(1.1);
        }
        .tool-btn:active {
            transform: scale(0.95);
        }
        .tool-btn svg {
            width: 22px;
            height: 22px;
        }
        .tool-btn i {
            width: 22px;
            height: 22px;
        }
        .tool-btn span {
            display: none; /* Hide text labels, show only icons */
        }


        .btn-post-modern {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            color: white;
            border: none;
            border-radius: 24px;
            padding: 10px 28px;
            font-weight: 600;
            font-size: 15px;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 4px 14px rgba(59, 130, 246, 0.4),
                        inset 0 1px 0 rgba(255, 255, 255, 0.2);
            letter-spacing: 0.3px;
            position: relative;
            overflow: hidden;
            min-width: 90px;
        }
        .btn-post-modern::before {
            content: '';
            position: absolute;
            inset: 0;
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.2), transparent);
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        .btn-post-modern:hover:not(:disabled)::before {
            opacity: 1;
        }
        .btn-post-modern:hover:not(:disabled) { 
            background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%);
            box-shadow: 0 6px 20px rgba(59, 130, 246, 0.5),
                        inset 0 1px 0 rgba(255, 255, 255, 0.2);
            transform: translateY(-2px);
        }
        .btn-post-modern:active:not(:disabled) {
            transform: translateY(0) scale(0.98);
        }
        .btn-post-modern:disabled {
            background: linear-gradient(135deg, rgba(71, 85, 105, 0.5), rgba(51, 65, 85, 0.5));
            color: rgba(255, 255, 255, 0.3);
            cursor: not-allowed;
            box-shadow: none;
            transform: none;
        }

        /* === MESSENGER MODERN === */
        .msg-image-preview {
            max-width: 200px;
            border-radius: var(--radius-md);
            border: 1px solid rgba(255,255,255,0.1);
            margin-top: 5px;
        }
        .msg-heart-reaction {
            position: absolute;
            bottom: -8px;
            right: -5px;
            background: #1e293b;
            border: 1px solid #334155;
            border-radius: var(--radius-sm);
            padding: 2px 4px;
            font-size: 10px;
            display: flex;
            align-items: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
            animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        @keyframes popIn { 0% { transform: scale(0); } 100% { transform: scale(1); } }
        
        .pm-footer-modern {
            padding: var(--spacing-sm);
            background: #0f172a;
            display: flex;
            gap: var(--spacing-sm);
            align-items: center;
            border-top: 1px solid #1e293b;
            padding-bottom: calc(15px + env(safe-area-inset-bottom));
        }
        .pm-attach-btn {
            background: none;
            border: none;
            color: #64748b;
            cursor: pointer;
            padding: 5px;
        }
        
        /* === NOTIFICATION UPDATES === */
        .notif-card-grouped {
            background: rgba(30, 41, 59, 0.4);
            border-left: 3px solid var(--accent);
            margin-bottom: var(--spacing-xs);
            padding: var(--spacing-sm);
            border-radius: 0 12px 12px 0;
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
            cursor: pointer;
            transition: 0.2s;
            position: relative;
        }
        .notif-card-grouped:active { background: rgba(30, 41, 59, 0.8); transform: scale(0.98); }
        .notif-img { width: 36px; height: 36px; border-radius: 50%; object-fit: cover; border: 1px solid rgba(255,255,255,0.1); }
        .notif-content-wrap { flex: 1; padding-right: 25px; } /* padding for delete btn */
        .btn-delete-notif {
            position: absolute; right: 10px; top: 50%; transform: translateY(-50%);
            background: rgba(239, 68, 68, 0.1); color: #ef4444; border: none;
            width: 24px; height: 24px; border-radius: 50%; display: flex; align-items: center; justify-content: center;
            cursor: pointer;
        }

        /* === MODERN NOTIFICATION STYLES === */
        .notif-filter-tab {
            padding: 8px 16px; border: 1px solid rgba(255,255,255,0.1); background: rgba(255,255,255,0.05);
            color: rgba(255,255,255,0.5); font-size: 12px; font-weight: 700;
            border-radius: 20px; cursor: pointer; transition: all 0.2s; white-space: nowrap;
            flex-shrink: 0;
        }
        .notif-filter-tab.active {
            background: rgba(14,165,233,0.2); color: #38bdf8;
            border-color: rgba(14,165,233,0.4);
        }
        .notif-item {
            display: flex; align-items: center; gap: 14px;
            padding: 14px 18px; cursor: pointer;
            transition: background 0.15s; position: relative;
            border-bottom: 1px solid rgba(255,255,255,0.04);
        }
        .notif-item:active { background: rgba(255,255,255,0.06); }
        .notif-item.unread { background: rgba(14,165,233,0.06); }
        /* Avatar stack: main + secondary overlap */
        .notif-av-wrap { position: relative; width: 50px; height: 46px; flex-shrink: 0; }
        .notif-av-main {
            width: 44px; height: 44px; border-radius: 50%; object-fit: cover;
            border: 2px solid rgba(255,255,255,0.1); display: block;
        }
        .notif-av-extra {
            position: absolute; bottom: -2px; right: -6px;
            width: 24px; height: 24px; border-radius: 50%;
            border: 2px solid #0f172a; object-fit: cover;
        }
        .notif-av-count {
            position: absolute; bottom: -2px; right: -6px;
            width: 24px; height: 24px; border-radius: 50%;
            border: 2px solid #0f172a; background: #1e293b;
            display: flex; align-items: center; justify-content: center;
            font-size: 9px; font-weight: 800; color: white;
        }
        .notif-type-badge {
            position: absolute; bottom: -2px; right: -6px;
            width: 22px; height: 22px; border-radius: 50%;
            border: 2px solid #0f172a;
            display: flex; align-items: center; justify-content: center; font-size: 11px;
        }
        .notif-type-badge.like    { background: #ef4444; }
        .notif-type-badge.comment { background: #0ea5e9; }
        .notif-type-badge.mention { background: #a78bfa; }
        .notif-type-badge.follow  { background: #10b981; }
        .notif-type-badge.share   { background: #f59e0b; }
        .notif-type-badge.gift    { background: #ec4899; }
        .notif-type-badge.system  { background: #64748b; }
        .notif-body { flex: 1; min-width: 0; }
        .notif-msg {
            font-size: 14px; color: #cbd5e1; line-height: 1.45;
            overflow: hidden; display: -webkit-box;
            -webkit-line-clamp: 2; -webkit-box-orient: vertical;
        }
        .notif-msg strong { color: #f1f5f9; font-weight: 700; }
        .notif-time { font-size: 11px; color: rgba(255,255,255,0.3); margin-top: 4px; }
        .notif-unread-dot {
            width: 9px; height: 9px; border-radius: 50%;
            background: #38bdf8; flex-shrink: 0;
            box-shadow: 0 0 8px rgba(56,189,248,0.7);
        }
        .notif-dismiss-btn {
            background: none; border: none; color: rgba(255,255,255,0.15);
            cursor: pointer; padding: 8px; border-radius: 50%; transition: all 0.2s;
            flex-shrink: 0; min-width: 36px; min-height: 36px;
            display: flex; align-items: center; justify-content: center;
        }
        .notif-dismiss-btn:active { background: rgba(239,68,68,0.15); color: #ef4444; }
        .notif-empty {
            display: flex; flex-direction: column; align-items: center;
            justify-content: center; padding: 64px 32px; text-align: center;
        }
        .notif-empty-icon { font-size: 56px; margin-bottom: 14px; line-height: 1; }
        .notif-empty-title { font-size: 17px; font-weight: 800; color: white; margin-bottom: 8px; }
        .notif-empty-sub { font-size: 13px; color: rgba(255,255,255,0.38); line-height: 1.6; }
        .notif-modal-modern { border-radius: 20px !important; }

        /* Modern Unfriend Button */
        .btn-unfriend-modern {
            background: rgba(239, 68, 68, 0.12);
            color: #f87171;
            border: 1px solid rgba(239, 68, 68, 0.25);
            padding: 14px 32px;
            border-radius: 50px;
            font-weight: 700;
            font-size: 14px;
            cursor: pointer;
            margin-bottom: var(--spacing-sm);
            width: 100%;
            max-width: 280px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: var(--spacing-xs);
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        .btn-unfriend-modern:hover {
            background: rgba(239, 68, 68, 0.18);
            border-color: rgba(239, 68, 68, 0.4);
            box-shadow: 0 4px 15px rgba(239, 68, 68, 0.15);
        }
        .btn-unfriend-modern:active {
            transform: scale(0.97);
        }

        /* Group Chat UI */
        .group-create-btn {
            padding: 8px 15px;
            background: var(--accent);
            color: white;
            border-radius: var(--radius-xl);
            font-size: 11px;
            font-weight: 800;
            border: none;
            cursor: pointer;
            box-shadow: 0 4px 10px rgba(14, 165, 233, 0.3);
        }
        
        .friend-select-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: var(--spacing-sm);
            border-bottom: 1px solid rgba(255,255,255,0.05);
            cursor: pointer;
        }
        .friend-select-item.selected { background: rgba(14, 165, 233, 0.1); }
        .checkbox-circle {
            width: 20px; height: 20px;
            border: 2px solid #475569;
            border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
        }
        .friend-select-item.selected .checkbox-circle {
            background: var(--accent); border-color: var(--accent);
        }

        #customPopupBanner { display: none; position: fixed; inset: 0; z-index: 9999999; background: rgba(0,0,0,0.85); align-items: center; justify-content: center; flex-direction: column; padding: var(--spacing-lg); backdrop-filter: blur(5px); }
        
        /* === CARD SKINS === */
        .card-skin-neon { border: 2px solid #06b6d4 !important; box-shadow: 0 0 20px #06b6d4, inset 0 0 20px rgba(6, 182, 212, 0.2) !important; background: rgba(8, 51, 68, 0.9) !important; }
        .card-skin-neon .cell { border-color: #06b6d4 !important; color: #67e8f9 !important; text-shadow: 0 0 5px #06b6d4 !important; }
        
        .card-skin-gold { border: 2px solid #f59e0b !important; box-shadow: 0 0 25px #f59e0b, inset 0 0 10px #f59e0b !important; background: linear-gradient(135deg, #451a03, #000) !important; }
        .card-skin-gold .cell { border-color: #fbbf24 !important; color: #fcd34d !important; font-family: 'Times New Roman', serif; }
        
        .card-skin-pink { border: 2px solid #ec4899 !important; box-shadow: 0 0 20px #ec4899 !important; background: rgba(80, 7, 36, 0.9) !important; }
        .card-skin-pink .cell { border-color: #f472b6 !important; color: #fbcfe8 !important; border-radius: 50% !important; }
        
        .card-skin-matrix { border: 2px solid #22c55e !important; box-shadow: 0 0 15px #22c55e !important; background: black !important; font-family: 'Courier New', monospace; }
        .card-skin-matrix .cell { border-color: #22c55e !important; color: #4ade80 !important; border-radius: 0 !important; }

        /* CHARACTER THEMES */
        .card-skin-kitty { border: 4px solid #ffc0cb !important; background: radial-gradient(circle, #fff0f5, #ff69b4) !important; box-shadow: 0 0 20px #ff69b4 !important; font-family: 'Comic Neue', cursive; }
        .card-skin-kitty .cell { background: white !important; color: #ff1493 !important; border: 2px solid #ffc0cb !important; border-radius: 15px !important; }
        .card-skin-kitty .bingo-header .letter { color: #ff1493 !important; text-shadow: 2px 2px 0px white !important; }

        .card-skin-doraemon { border: 4px solid #0096df !important; background: linear-gradient(180deg, #0096df 0%, #ffffff 100%) !important; box-shadow: 0 0 20px #dd1616 !important; }
        .card-skin-doraemon .cell { background: rgba(255,255,255,0.9) !important; color: #0096df !important; border: 2px solid #dd1616 !important; border-radius: 50% !important; }
        .card-skin-doraemon .bingo-header .letter { color: #dd1616 !important; text-shadow: 2px 2px 0px white !important; }

        .card-skin-spongebob { border: 4px solid #f7f44d !important; background: url('https://upload.wikimedia.org/wikipedia/commons/thumb/e/e6/SpongeBob_SquarePants_logo.svg/1200px-SpongeBob_SquarePants_logo.svg.png'), #f7f44d !important; background-size: cover !important; box-shadow: 0 0 20px #f7f44d !important; }
        .card-skin-spongebob .cell { background: rgba(255,255,255,0.8) !important; color: #7d5837 !important; border: 2px dashed #7d5837 !important; }
        
        .card-skin-kuromi { border: 4px solid #000000 !important; background: linear-gradient(135deg, #000000, #4b0082) !important; box-shadow: 0 0 20px #ea65a2 !important; }
        .card-skin-kuromi .cell { background: rgba(234, 101, 162, 0.2) !important; color: #ea65a2 !important; border: 1px solid #ea65a2 !important; border-radius: var(--radius-sm) 0 8px 0 !important; }

        /* CUSTOM BACKGROUND SKIN */
        .card-skin-custom { background-size: cover !important; background-position: center !important; border: 2px solid rgba(255,255,255,0.5) !important; box-shadow: 0 0 30px rgba(0,0,0,0.8) !important; }
        .card-skin-custom .cell { background: rgba(0,0,0,0.6) !important; backdrop-filter: blur(4px); color: white !important; border: 1px solid rgba(255,255,255,0.3) !important; }

        .store-nav { 
            display: flex; 
            gap: 8px; 
            margin-bottom: 20px; 
            background: rgba(0, 0, 0, 0.3); 
            padding: 6px; 
            border-radius: 14px;
            border: 1px solid rgba(255, 255, 255, 0.05);
        }
        .store-tab-btn { 
            flex: 1; 
            padding: 12px; 
            border: none; 
            background: transparent; 
            color: rgba(255, 255, 255, 0.5); 
            font-weight: 800; 
            border-radius: 10px; 
            cursor: pointer; 
            font-size: 12px; 
            text-transform: uppercase; 
            transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
            letter-spacing: 0.5px;
        }
        .store-tab-btn:hover {
            background: rgba(59, 130, 246, 0.1);
            color: rgba(255, 255, 255, 0.8);
        }
        .store-tab-btn.active { 
            background: linear-gradient(135deg, #3b82f6, #2563eb); 
            color: white; 
            box-shadow: 0 4px 14px rgba(59, 130, 246, 0.4),
                        inset 0 1px 0 rgba(255, 255, 255, 0.2);
            transform: translateY(-1px);
        }
        .skins-grid { display: grid; grid-template-columns: 1fr 1fr; gap: var(--spacing-sm); }
        .skin-item { background: rgba(255,255,255,0.05); padding: var(--spacing-sm); border-radius: var(--radius-lg); border: 1px solid rgba(255,255,255,0.1); text-align: center; position: relative; overflow: hidden; }
        .skin-preview { height: 60px; border-radius: var(--radius-sm); margin-bottom: var(--spacing-xs); display: flex; align-items: center; justify-content: center; font-size: 20px; font-weight: 900; background-size: cover; background-position: center; }
        .skin-name { font-size: 12px; font-weight: 800; color: white; margin-bottom: 4px; }
        .skin-cost { font-size: 10px; color: var(--gold); margin-bottom: var(--spacing-xs); font-weight: 700; }
        .btn-buy-skin { width: 100%; padding: 8px; border: none; border-radius: var(--radius-sm); font-weight: 800; font-size: 10px; cursor: pointer; }
        .btn-buy-skin.owned { background: rgba(255,255,255,0.1); color: #cbd5e1; cursor: default; }
        .btn-buy-skin.buy { background: var(--gold); color: black; }
        .btn-buy-skin.equip { background: var(--success); color: white; }
        .task-list { display: flex; flex-direction: column; gap: var(--spacing-sm); }
        .task-item { background: linear-gradient(135deg, rgba(30,41,59,0.9), rgba(15,23,42,0.95)); padding: var(--spacing-md); border-radius: var(--radius-lg); border: 1px solid rgba(255,255,255,0.1); display: flex; justify-content: space-between; align-items: center; position: relative; overflow: hidden; }
        .task-info h4 { margin: 0; font-size: 13px; font-weight: 900; color: white; letter-spacing: 0.5px; }
        .task-info p { margin: 3px 0 0; font-size: 10px; color: #94a3b8; }
        .task-reward { background: rgba(251, 191, 36, 0.15); color: var(--gold); padding: 4px 8px; border-radius: 6px; font-size: 10px; font-weight: 800; margin-top: 5px; display: inline-block; border: 1px solid rgba(251, 191, 36, 0.3); }
        .btn-do-task { background: var(--accent); color: white; border: none; padding: var(--spacing-sm) 18px; border-radius: var(--radius-sm); font-weight: 800; font-size: 11px; cursor: pointer; transition: 0.2s; box-shadow: 0 4px 10px rgba(14, 165, 233, 0.3); min-width: 80px; z-index: 2; }
        .btn-do-task:hover { transform: translateY(-2px); }
        .btn-do-task:disabled { background: #334155; color: #94a3b8; cursor: not-allowed; transform: none; box-shadow: none; }
        .flying-coin { position: fixed; width: 24px; height: 24px; background-image: url('https://cdn-icons-png.flaticon.com/512/217/217853.png'); background-size: contain; background-repeat: no-repeat; z-index: 99999; pointer-events: none; will-change: transform, opacity; }
        @keyframes shake-hard { 0% { transform: translate(0, 0); } 25% { transform: translate(-3px, 3px); } 50% { transform: translate(3px, -3px); } 75% { transform: translate(-3px, -3px); } 100% { transform: translate(0, 0); } }
        .shake-effect { animation: shake-hard 0.3s ease-in-out; will-change: transform; }
        .float-loss { position: fixed; color: #ef4444; font-weight: 900; font-size: 18px; z-index: 100000; pointer-events: none; animation: floatDownFade 1s ease-out forwards; text-shadow: 0 1px 2px black; }
        @keyframes floatDownFade { 0% { transform: translateY(0) scale(1); opacity: 1; } 100% { transform: translateY(40px) scale(0.8); opacity: 0; } }
        #installGate { position: fixed; inset: 0; z-index: 2147483647; background: #0f172a; background-image: radial-gradient(circle at top right, rgba(14, 165, 233, 0.2), transparent 40%), radial-gradient(circle at bottom left, rgba(251, 191, 36, 0.1), transparent 40%); display: none; flex-direction: column; align-items: center; justify-content: center; text-align: center; padding: 30px; }
        .gate-logo { font-size: 64px; font-weight: 900; letter-spacing: -3px; color: white; margin-bottom: var(--spacing-sm); text-shadow: 0 0 40px rgba(14, 165, 233, 0.6); animation: floatLogo 3s ease-in-out infinite; }
        .gate-logo span { color: var(--accent-glow); }
        @keyframes floatLogo { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }
        .gate-title { font-size: 24px; font-weight: 800; color: white; margin-bottom: var(--spacing-md); line-height: 1.3; }
        .gate-desc { font-size: 14px; color: #cbd5e1; max-width: 320px; margin-bottom: 40px; line-height: 1.6; opacity: 0.8; }
        .gate-btn-install { background: linear-gradient(135deg, var(--accent), #2563eb); color: white; border: none; padding: var(--spacing-lg) 40px; border-radius: 50px; font-weight: 900; font-size: 16px; cursor: pointer; box-shadow: 0 0 30px rgba(14, 165, 233, 0.5); transition: transform 0.2s; display: flex; align-items: center; gap: var(--spacing-sm); border: 2px solid rgba(255,255,255,0.2); animation: pulseBtn 2s infinite; }
        .gate-btn-install:active { transform: scale(0.95); }
        @keyframes pulseBtn { 0% { box-shadow: 0 0 0 0 rgba(14, 165, 233, 0.7); } 70% { box-shadow: 0 0 0 20px rgba(14, 165, 233, 0); } 100% { box-shadow: 0 0 0 0 rgba(14, 165, 233, 0); } }
        .gate-ios-note { margin-top: var(--spacing-xl); background: rgba(255,255,255,0.05); padding: var(--spacing-lg); border-radius: var(--radius-lg); border: 1px solid rgba(255,255,255,0.1); max-width: 320px; text-align: left; display: none; }
        .ios-step { display: flex; gap: var(--spacing-sm); margin-bottom: var(--spacing-sm); align-items: center; font-size: 13px; color: #e2e8f0; }
        .ios-icon { color: var(--accent-glow); }
        #notifBlocker { position: fixed; inset: 0; z-index: 9999999; background: rgba(15, 23, 42, 0.98); display: none; flex-direction: column; align-items: center; justify-content: center; text-align: center; padding: 30px; backdrop-filter: blur(10px); }
        .notif-gate-icon { width: 80px; height: 80px; background: rgba(59, 130, 246, 0.2); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-bottom: var(--spacing-lg); box-shadow: 0 0 30px rgba(59, 130, 246, 0.4); animation: pulseGate 2s infinite; }
        @keyframes pulseGate { 0% { transform: scale(1); } 50% { transform: scale(1.1); } 100% { transform: scale(1); } }
        .notif-gate-title { font-size: 24px; font-weight: 900; margin-bottom: var(--spacing-sm); color: white; }
        .notif-gate-desc { font-size: 14px; color: #cbd5e1; margin-bottom: 30px; line-height: 1.6; max-width: 300px; }
        .btn-allow-notif { background: linear-gradient(135deg, var(--accent), #2563eb); color: white; border: none; padding: var(--spacing-md) 30px; border-radius: var(--radius-lg); font-weight: 800; font-size: 16px; cursor: pointer; box-shadow: 0 10px 30px rgba(59, 130, 246, 0.4); transition: 0.3s; width: 100%; max-width: 250px; display: flex; align-items: center; justify-content: center; gap: var(--spacing-sm); }
        .btn-allow-notif:hover { transform: translateY(-3px); }
        .blocked-help { display: none; background: rgba(239, 68, 68, 0.1); border: 1px solid rgba(239, 68, 68, 0.3); padding: var(--spacing-md); border-radius: var(--radius-md); margin-top: var(--spacing-lg); font-size: 12px; text-align: left; }
        /* === SPLASH SCREEN - PROFESSIONAL & BONGGA === */
        #splash-screen { 
            position: fixed; 
            inset: 0; 
            background: linear-gradient(135deg, #020617 0%, #0f172a 50%, #1e293b 100%);
            z-index: 99999; 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            justify-content: center; 
            transition: opacity 0.8s ease, visibility 0.8s;
            overflow: hidden;
        }
        
        /* Animated gradient orbs */
        #splash-screen::before {
            content: '';
            position: absolute;
            width: 300px;
            height: 300px;
            background: radial-gradient(circle, #0ea5e9 0%, transparent 70%);
            border-radius: 50%;
            filter: blur(60px);
            opacity: 0.3;
            top: -150px;
            left: -150px;
            animation: float-orb 8s ease-in-out infinite;
        }
        #splash-screen::after {
            content: '';
            position: absolute;
            width: 400px;
            height: 400px;
            background: radial-gradient(circle, #8b5cf6 0%, transparent 70%);
            border-radius: 50%;
            filter: blur(60px);
            opacity: 0.3;
            bottom: -200px;
            right: -200px;
            animation: float-orb 8s ease-in-out infinite 2s;
        }
        
        .splash-logo { 
            position: relative;
            z-index: 2;
            font-size: clamp(52px, 15vw, 72px);
            font-weight: 900; 
            letter-spacing: -3px; 
            background: linear-gradient(135deg, #ffffff 0%, #38bdf8 50%, #0ea5e9 100%);
            background-size: 200% 200%;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            animation: gradient-shift 3s ease-in-out infinite, pulseLogo 2s infinite ease-in-out;
            text-shadow: 0 0 30px rgba(14, 165, 233, 0.5);
            margin-bottom: 8px;
        }
        .splash-logo span { 
            background: linear-gradient(135deg, var(--gold), var(--gold-shine));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .splash-tagline {
            position: relative;
            z-index: 2;
            font-size: 14px;
            color: rgba(255, 255, 255, 0.6);
            font-weight: 500;
            letter-spacing: 2px;
            text-transform: uppercase;
            margin-bottom: 32px;
            animation: fade-in-up 1s ease-out 0.3s both;
        }
        
        .splash-loader { 
            position: relative;
            z-index: 2;
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }
        
        .splash-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            animation: bounce-dot 1.4s ease-in-out infinite;
        }
        
        .splash-dot:nth-child(1) {
            background: linear-gradient(135deg, var(--accent), var(--accent-glow));
            box-shadow: 0 0 15px var(--accent);
            animation-delay: 0s;
        }
        .splash-dot:nth-child(2) {
            background: linear-gradient(135deg, var(--gold), var(--gold-shine));
            box-shadow: 0 0 15px var(--gold);
            animation-delay: 0.2s;
        }
        .splash-dot:nth-child(3) {
            background: linear-gradient(135deg, #8b5cf6, #a78bfa);
            box-shadow: 0 0 15px #8b5cf6;
            animation-delay: 0.4s;
        }
        
        /* Animations */
        @keyframes float-orb {
            0%, 100% { transform: translate(0, 0) scale(1); }
            33% { transform: translate(30px, -30px) scale(1.1); }
            66% { transform: translate(-30px, 30px) scale(0.9); }
        }
        
        @keyframes gradient-shift {
            0%, 100% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
        }
        
        @keyframes bounce-dot {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-20px); }
        }
        
        @keyframes fade-in-up {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* Mobile optimizations */
        @media (max-width: 480px) {
            #splash-screen::before { width: 200px; height: 200px; }
            #splash-screen::after { width: 300px; height: 300px; }
        }
        @keyframes pulseLogo { 0%, 100% { transform: scale(1); filter: drop-shadow(0 0 10px rgba(56,189,248,0.2)); } 50% { transform: scale(1.1); filter: drop-shadow(0 0 30px rgba(56,189,248,0.8)); } }
        @keyframes spin { 100% { transform: rotate(360deg); } }
        #customToast { position: fixed; top: 20px; left: 50%; transform: translateX(-50%) translateY(-150%); background: rgba(15, 23, 42, 0.95); border: 1px solid var(--accent); padding: 16px 24px; border-radius: var(--radius-lg); z-index: 100000; display: flex; align-items: center; justify-content: center; text-align: center; gap: var(--spacing-sm); box-shadow: 0 10px 40px rgba(0,0,0,0.8); backdrop-filter: blur(12px); transition: transform 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); min-width: 280px; max-width: 90%; }
        #customToast.show { transform: translateX(-50%) translateY(0); }
        .toast-icon { color: var(--gold); flex-shrink: 0; }
        .toast-msg { font-size: 14px; font-weight: 700; color: white; line-height: 1.4; }
        .glass-panel { background: var(--glass-surface); backdrop-filter: blur(16px); -webkit-backdrop-filter: blur(16px); border: 1px solid var(--glass-border); box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.5); }
        
        .ad-container-global { position: relative; z-index: 10 !important; width: 320px; height: 50px; display: flex; justify-content: center; align-items: center; margin: 10px auto; background: rgba(0,0,0,0.4); border-radius: 4px; border: 1px dashed rgba(255,255,255,0.3); text-align: center; overflow: hidden; clear: both; }

        #jackpotBanner { background: linear-gradient(135deg, #271a00 0%, #451a03 50%, #000000 100%); border: 2px solid #fbbf24; color: #fbbf24; padding: var(--spacing-md); text-align: center; border-radius: var(--radius-lg); box-shadow: 0 0 25px rgba(251, 191, 36, 0.3), inset 0 0 20px rgba(251, 191, 36, 0.1); display: none; margin-bottom: var(--spacing-md); position: relative; overflow: hidden; animation: pulse-border 2s infinite; }
        #jackpotBanner::before { content: ''; position: absolute; top: -50%; left: -50%; width: 200%; height: 200%; background: linear-gradient(45deg, transparent, rgba(251, 191, 36, 0.2), transparent); animation: shimmer 3s infinite linear; }
        @keyframes shimmer { 0% { transform: translateX(-100%); } 100% { transform: translateX(100%); } }
        @keyframes pulse-border { 0% { box-shadow: 0 0 15px rgba(251, 191, 36, 0.2); border-color: #b45309; } 50% { box-shadow: 0 0 35px rgba(251, 191, 36, 0.6); border-color: #fbbf24; } 100% { box-shadow: 0 0 15px rgba(251, 191, 36, 0.2); border-color: #b45309; } }
        .jp-label-new { font-size: 11px; font-weight: 900; letter-spacing: 3px; text-transform: uppercase; display: flex; align-items: center; justify-content: center; gap: var(--spacing-xs); margin-bottom: var(--spacing-xs); color: #fcd34d; text-shadow: 0 2px 4px rgba(0,0,0,0.8); }
        .jackpot-amount { font-size: 32px; color: #ffffff; display: block; font-weight: 900; text-shadow: 0 2px 15px rgba(251, 191, 36, 0.8); font-family: 'Inter', sans-serif; background: linear-gradient(to bottom, #ffffff, #fcd34d); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        /* ============================================
           LOGIN PAGE  PREMIUM REDESIGN
        ============================================ */
        #loginOverlay {
            position: fixed;
            inset: 0;
            z-index: 9999;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-end;
            overflow: hidden;
            background: #080c14;
        }

        /* Animated background canvas layer */
        .login-canvas-bg {
            position: absolute;
            inset: 0;
            z-index: 0;
            overflow: hidden;
        }
        .login-orb {
            position: absolute;
            border-radius: 50%;
            filter: blur(70px);
            opacity: 0;
            animation: orbFade 3s forwards;
        }
        .login-orb-1 {
            width: 380px; height: 380px;
            background: radial-gradient(circle, #0ea5e9 0%, transparent 70%);
            top: -120px; left: -80px;
            animation-delay: 0.2s;
            animation: orbFade 3s 0.2s forwards, orbFloat1 14s 3.2s ease-in-out infinite;
        }
        .login-orb-2 {
            width: 300px; height: 300px;
            background: radial-gradient(circle, #8b5cf6 0%, transparent 70%);
            top: 20%; right: -80px;
            animation: orbFade 3s 0.5s forwards, orbFloat2 18s 3.5s ease-in-out infinite;
        }
        .login-orb-3 {
            width: 250px; height: 250px;
            background: radial-gradient(circle, #f472b6 0%, transparent 70%);
            bottom: 30%; left: -60px;
            animation: orbFade 3s 0.8s forwards, orbFloat3 20s 3.8s ease-in-out infinite;
        }
        .login-orb-4 {
            width: 200px; height: 200px;
            background: radial-gradient(circle, #fbbf24 0%, transparent 70%);
            bottom: 10%; right: -40px;
            animation: orbFade 3s 1s forwards, orbFloat1 16s 4s ease-in-out infinite alternate;
        }
        @keyframes orbFade { to { opacity: 0.35; } }
        @keyframes orbFloat1 {
            0%, 100% { transform: translate(0, 0) scale(1); }
            33% { transform: translate(20px, 30px) scale(1.05); }
            66% { transform: translate(-10px, 20px) scale(0.97); }
        }
        @keyframes orbFloat2 {
            0%, 100% { transform: translate(0, 0) scale(1); }
            50% { transform: translate(-30px, 40px) scale(1.08); }
        }
        @keyframes orbFloat3 {
            0%, 100% { transform: translate(0, 0); }
            50% { transform: translate(25px, -20px); }
        }

        /* Grid overlay texture */
        .login-grid {
            position: absolute;
            inset: 0;
            background-image: 
                linear-gradient(rgba(255,255,255,0.025) 1px, transparent 1px),
                linear-gradient(90deg, rgba(255,255,255,0.025) 1px, transparent 1px);
            background-size: 40px 40px;
            z-index: 1;
            mask-image: radial-gradient(ellipse at center, black 0%, transparent 75%);
            -webkit-mask-image: radial-gradient(ellipse at center, black 0%, transparent 75%);
        }

        /* Top hero area */
        .login-hero {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 42%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 2;
            padding: 20px;
            text-align: center;
        }

        /* Logo badge */
        .login-logo-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            background: rgba(14,165,233,0.12);
            border: 1px solid rgba(14,165,233,0.3);
            border-radius: 30px;
            padding: 6px 14px;
            font-size: 11px;
            font-weight: 800;
            color: #38bdf8;
            letter-spacing: 2px;
            text-transform: uppercase;
            margin-bottom: 20px;
            animation: loginFadeUp 0.8s 0.4s cubic-bezier(0.16,1,0.3,1) both;
        }
        .login-logo-badge::before {
            content: '';
            width: 7px; height: 7px;
            background: #10b981;
            border-radius: 50%;
            box-shadow: 0 0 6px #10b981;
            animation: pulse 2s infinite;
        }
        @keyframes pulse { 0%,100% { opacity:1; } 50% { opacity:0.4; } }

        .login-logo-main {
            font-size: clamp(64px, 18vw, 88px);
            font-weight: 900;
            letter-spacing: -4px;
            line-height: 1;
            margin-bottom: 12px;
            animation: loginFadeUp 0.8s 0.6s cubic-bezier(0.16,1,0.3,1) both;
            position: relative;
        }
        .login-logo-main .rb {
            color: white;
            text-shadow: 0 0 60px rgba(14,165,233,0.4);
        }
        .login-logo-main .live {
            background: linear-gradient(135deg, #0ea5e9, #38bdf8, #818cf8);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            filter: drop-shadow(0 0 20px rgba(14,165,233,0.5));
        }

        .login-tagline {
            font-size: 16px;
            font-weight: 500;
            color: rgba(255,255,255,0.55);
            line-height: 1.6;
            max-width: 280px;
            animation: loginFadeUp 0.8s 0.8s cubic-bezier(0.16,1,0.3,1) both;
        }

        /* Feature pills */
        .login-feature-row {
            display: flex;
            gap: 8px;
            justify-content: center;
            flex-wrap: wrap;
            margin-top: 24px;
            animation: loginFadeUp 0.8s 1s cubic-bezier(0.16,1,0.3,1) both;
        }
        .login-feature-pill {
            display: flex;
            align-items: center;
            gap: 5px;
            background: rgba(255,255,255,0.06);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 20px;
            padding: 5px 12px;
            font-size: 11px;
            font-weight: 700;
            color: rgba(255,255,255,0.6);
            white-space: nowrap;
        }

        @keyframes loginFadeUp {
            from { opacity: 0; transform: translateY(24px); }
            to   { opacity: 1; transform: translateY(0); }
        }

        /* Bottom card */
        .login-bottom-card {
            position: relative;
            z-index: 10;
            width: 100%;
            max-width: 480px;
            background: linear-gradient(180deg, rgba(15,23,42,0) 0%, rgba(8,12,20,0.98) 12%);
            padding: 0 24px calc(32px + env(safe-area-inset-bottom)) 24px;
            display: flex;
            flex-direction: column;
            gap: 0;
            animation: loginFadeUp 0.9s 1.1s cubic-bezier(0.16,1,0.3,1) both;
        }

        /* Promo ribbon */
        .login-promo-ribbon {
            background: linear-gradient(135deg, rgba(251,191,36,0.12), rgba(245,158,11,0.08));
            border: 1px solid rgba(251,191,36,0.25);
            border-radius: 14px;
            padding: 10px 16px;
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 16px;
        }
        .login-promo-icon {
            width: 36px; height: 36px;
            background: linear-gradient(135deg, #fbbf24, #f59e0b);
            border-radius: 10px;
            display: flex; align-items: center; justify-content: center;
            font-size: 18px;
            flex-shrink: 0;
        }
        .login-promo-text strong {
            display: block;
            font-size: 13px;
            font-weight: 900;
            color: #fbbf24;
            line-height: 1.3;
        }
        .login-promo-text span {
            font-size: 11px;
            color: rgba(255,255,255,0.45);
        }

        /* Google button */
        .btn-google-signin {
            width: 100%;
            padding: 16px 20px;
            background: white;
            border: none;
            border-radius: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            font-size: 16px;
            font-weight: 700;
            color: #1f2937;
            cursor: pointer;
            transition: all 0.25s cubic-bezier(0.4,0,0.2,1);
            box-shadow: 0 8px 30px rgba(0,0,0,0.4), 0 2px 8px rgba(0,0,0,0.2);
            letter-spacing: -0.2px;
            margin-bottom: 12px;
            position: relative;
            overflow: hidden;
        }
        .btn-google-signin::before {
            content: '';
            position: absolute;
            inset: 0;
            background: linear-gradient(135deg, rgba(255,255,255,0) 0%, rgba(255,255,255,0.5) 50%, rgba(255,255,255,0) 100%);
            transform: translateX(-100%);
            transition: transform 0.5s ease;
        }
        .btn-google-signin:hover::before { transform: translateX(100%); }
        .btn-google-signin:hover { transform: translateY(-2px); box-shadow: 0 14px 40px rgba(0,0,0,0.5); }
        .btn-google-signin:active { transform: scale(0.98); }

        .login-divider {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 12px;
        }
        .login-divider::before,
        .login-divider::after {
            content: '';
            flex: 1;
            height: 1px;
            background: rgba(255,255,255,0.08);
        }
        .login-divider span {
            font-size: 10px;
            font-weight: 700;
            color: rgba(255,255,255,0.2);
            letter-spacing: 1px;
            text-transform: uppercase;
            white-space: nowrap;
        }

        /* Footer legal */
        .login-legal {
            text-align: center;
            margin-top: 4px;
        }
        .login-legal-disclaimer {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            font-size: 10px;
            font-weight: 800;
            color: rgba(255,255,255,0.25);
            letter-spacing: 0.5px;
            text-transform: uppercase;
            margin-bottom: 6px;
        }
        .login-legal-disclaimer::before {
            content: '';
            color: rgba(251,191,36,0.5);
        }
        .login-legal-links {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 4px;
            font-size: 11px;
            color: rgba(255,255,255,0.2);
        }
        .login-legal-links a {
            color: rgba(255,255,255,0.35);
            text-decoration: none;
            font-weight: 600;
            transition: color 0.2s;
        }
        .login-legal-links a:hover { color: rgba(255,255,255,0.7); }

        /* Unused old classes  keep for compat */
        .login-bg-blob, .login-app-container, .app-logo-lg, .app-tagline,
        .promo-badge, .auth-btn-group, .btn-main-auth, .btn-sec-auth,
        .login-footer-legal, .legal-text { display: none !important; }
        .nav { background: rgba(15, 23, 42, 0.95); backdrop-filter: blur(15px); padding: var(--spacing-sm) 15px; display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 100; border-bottom: 1px solid rgba(255,255,255,0.1); height: auto; min-height: 60px; }
        .user-stats { display: flex; align-items: center; gap: var(--spacing-xs); }
        .icon-btn { background: rgba(255,255,255,0.1); color: white; border: 1px solid rgba(255,255,255,0.15); width: 38px; height: 38px; border-radius: var(--radius-md); cursor: pointer; position: relative; display: flex; align-items: center; justify-content: center; transition: 0.2s; }
        .icon-btn:active { transform: scale(0.95); }
        .notif-badge { position: absolute; top: 8px; right: 8px; background: var(--danger); width: 8px; height: 8px; border-radius: 50%; border: 1px solid var(--surface); display: none; z-index: 10; box-shadow: 0 0 10px var(--danger); }
        .points-badge { background: linear-gradient(135deg, rgba(251, 191, 36, 0.2), rgba(245, 158, 11, 0.4)); color: #fff; padding: 0 12px; height: 38px; border-radius: var(--radius-md); font-weight: 800; border: 1px solid rgba(251, 191, 36, 0.6); font-size: 13px; cursor: pointer; display: flex; align-items: center; gap: 6px; text-shadow: 0 1px 2px rgba(0,0,0,0.8); box-shadow: 0 4px 15px rgba(245, 158, 11, 0.3); }
        #userImg { width: 45px; height: 45px; border-radius: 50%; cursor: pointer; border: 2px solid var(--accent); object-fit: cover; box-shadow: 0 4px 15px rgba(0,0,0,0.3); }
        
        /* BOTTOM NAVIGATION - OPTIMIZED FOR MOBILE */
        /* === RADIO PLAYER REMOVED === */
        .bottom-nav { display: none !important; }
        .nav-label { display: none; }
        .nav-item { display: none; }
        .nav-icon { width: 22px; height: 22px; flex-shrink: 0; }

        /* === CHAT BUBBLE BUTTON === */
        .chat-bubble-btn {
            position: fixed;
            bottom: calc(20px + env(safe-area-inset-bottom));
            right: 18px;
            width: 54px; height: 54px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--accent), #2563eb);
            border: none;
            color: white;
            display: flex; align-items: center; justify-content: center;
            cursor: pointer;
            z-index: 4999;
            box-shadow: 0 4px 20px rgba(14,165,233,0.5);
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .chat-bubble-btn:hover { transform: scale(1.08); box-shadow: 0 6px 28px rgba(14,165,233,0.7); }
        .chat-bubble-btn:active { transform: scale(0.95); }
        .chat-bubble-badge {
            position: absolute; top: -3px; right: -3px;
            background: #ef4444; color: white;
            font-size: 9px; font-weight: 900;
            min-width: 18px; height: 18px;
            border-radius: 9px; padding: 0 4px;
            display: none; align-items: center; justify-content: center;
            border: 2px solid #0f172a;
            line-height: 1;
        }
        .chat-bubble-badge.show { display: flex; }

        /* === CHAT DRAWER === */
        .chat-drawer-backdrop {
            display: none; position: fixed; inset: 0;
            background: rgba(0,0,0,0.6); z-index: 5000;
            backdrop-filter: blur(4px);
        }
        .chat-drawer-backdrop.open { display: block; }
        .chat-drawer {
            position: fixed; bottom: 0; left: 0; right: 0;
            height: 72vh;
            background: #111827;
            border-radius: 20px 20px 0 0;
            border-top: 1px solid rgba(255,255,255,0.1);
            z-index: 5001;
            display: flex; flex-direction: column;
            transform: translateY(100%);
            transition: transform 0.35s cubic-bezier(0.4,0,0.2,1);
            overflow: hidden;
        }
        .chat-drawer.open { transform: translateY(0); }
        .chat-drawer-handle {
            width: 36px; height: 4px;
            background: rgba(255,255,255,0.2);
            border-radius: 2px;
            margin: 10px auto 0;
            flex-shrink: 0;
        }
        .chat-drawer-header {
            padding: 10px 16px 10px;
            background: rgba(31,41,55,0.95);
            border-bottom: 1px solid rgba(255,255,255,0.08);
            display: flex; align-items: center; justify-content: space-between;
            flex-shrink: 0;
        }
        .chat-drawer-title {
            display: flex; align-items: center; gap: 10px;
            font-size: 14px; font-weight: 800;
            letter-spacing: 0.5px; color: var(--accent-glow);
            text-transform: uppercase;
        }
        .chat-drawer-close {
            width: 32px; height: 32px; border-radius: 50%;
            background: rgba(255,255,255,0.08);
            border: none; color: white;
            display: flex; align-items: center; justify-content: center;
            cursor: pointer; transition: background 0.2s;
        }
        .chat-drawer-close:hover { background: rgba(255,255,255,0.15); }
        @keyframes pulseDot { 0%,100%{opacity:1} 50%{opacity:0.3} }

        /* === HAMBURGER MENU === */
        .hamburger-btn { width: 40px; height: 40px; border-radius: var(--radius-sm); border: 1px solid rgba(255,255,255,0.08); background: rgba(255,255,255,0.05); color: white; display: flex; align-items: center; justify-content: center; cursor: pointer; flex-direction: column; gap: 4px; transition: all 0.2s; flex-shrink: 0; }
        .hamburger-btn:hover { background: rgba(255,255,255,0.1); }
        .hamburger-btn span { display: block; width: 18px; height: 2px; background: white; border-radius: 2px; transition: all 0.3s; }
        .hamburger-btn.open span:nth-child(1) { transform: translateY(6px) rotate(45deg); }
        .hamburger-btn.open span:nth-child(2) { opacity: 0; transform: scaleX(0); }
        .hamburger-btn.open span:nth-child(3) { transform: translateY(-6px) rotate(-45deg); }
        .hamburger-overlay { display: none; position: fixed; inset: 0; z-index: 9990; background: rgba(0,0,0,0.5); backdrop-filter: blur(4px); }
        .hamburger-overlay.open { display: block; }
        .hamburger-menu { position: fixed; top: 0; left: -290px; width: 290px; height: 100vh; background: rgba(10,18,35,0.99); backdrop-filter: blur(30px); border-right: 1px solid rgba(255,255,255,0.08); z-index: 9991; display: flex; flex-direction: column; transition: left 0.35s cubic-bezier(0.4,0,0.2,1); padding-top: max(20px, env(safe-area-inset-top)); overflow-y: auto; }
        .hamburger-menu.open { left: 0; }
        .hamburger-menu-header { padding: 16px 20px 12px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid rgba(255,255,255,0.06); margin-bottom: 8px; }
        .hamburger-menu-title { font-size: 11px; font-weight: 800; letter-spacing: 1.5px; text-transform: uppercase; color: rgba(255,255,255,0.35); }
        .hamburger-close-btn { width: 32px; height: 32px; border-radius: 50%; border: 1px solid rgba(255,255,255,0.1); background: rgba(255,255,255,0.05); color: white; display: flex; align-items: center; justify-content: center; cursor: pointer; }
        .hamburger-nav-item { display: flex; align-items: center; gap: 14px; padding: 14px 20px; color: rgba(255,255,255,0.7); cursor: pointer; transition: all 0.2s; font-size: 15px; font-weight: 600; border: none; background: none; width: 100%; text-align: left; }
        .hamburger-nav-item:hover { background: rgba(255,255,255,0.05); color: white; }
        .hamburger-nav-item.active { color: var(--accent-glow); background: rgba(14,165,233,0.08); }
        .hamburger-nav-item i { width: 20px; height: 20px; flex-shrink: 0; }
        .hamburger-divider { height: 1px; background: rgba(255,255,255,0.06); margin: 6px 0; }
        .hamburger-section-label { font-size: 9px; font-weight: 800; letter-spacing: 1.5px; text-transform: uppercase; color: rgba(255,255,255,0.2); padding: 10px 20px 4px; }

        /* === SIDE DRAWER (mapped from hamburger) === */
        .drawer-overlay { display: none; position: fixed; inset: 0; z-index: 9990; background: rgba(0,0,0,0.6); backdrop-filter: blur(4px); }
        .drawer-overlay.open { display: block; }
        .side-drawer { position: fixed; top: 0; left: 0; bottom: 0; width: 280px; background: rgba(10,16,30,0.99); backdrop-filter: blur(30px); border-right: 1px solid rgba(255,255,255,0.08); z-index: 9991; transform: translateX(-100%); transition: transform 0.35s cubic-bezier(0.4,0,0.2,1); display: flex; flex-direction: column; padding-top: max(20px, env(safe-area-inset-top)); }
        .side-drawer.open { transform: translateX(0); }
        .drawer-header { padding: 16px 20px 14px; border-bottom: 1px solid rgba(255,255,255,0.07); display: flex; align-items: center; justify-content: space-between; }
        .drawer-logo { font-weight: 900; font-size: 20px; }
        .drawer-logo span { color: var(--accent-glow); }
        .drawer-close { width: 32px; height: 32px; border-radius: 50%; border: 1px solid rgba(255,255,255,0.1); background: rgba(255,255,255,0.05); color: white; display: flex; align-items: center; justify-content: center; cursor: pointer; }
        .drawer-nav { padding: 8px 0; flex: 1; overflow-y: auto; }
        .drawer-nav-item { display: flex; align-items: center; gap: 14px; padding: 14px 20px; color: rgba(255,255,255,0.7); cursor: pointer; transition: all 0.2s; font-size: 15px; font-weight: 600; border: none; background: none; width: 100%; text-align: left; }
        .drawer-nav-item:hover { background: rgba(255,255,255,0.05); color: white; }
        .drawer-nav-item.active { color: var(--accent-glow); background: rgba(14,165,233,0.08); border-left: 3px solid var(--accent-glow); }
        .drawer-nav-item i { width: 20px; height: 20px; flex-shrink: 0; }
        .drawer-divider { height: 1px; background: rgba(255,255,255,0.06); margin: 6px 0; }
        .drawer-footer { padding: 14px 20px; border-top: 1px solid rgba(255,255,255,0.07); }

        .next-draw-container { background: rgba(15, 23, 42, 0.8); border: 1px solid rgba(251, 191, 36, 0.4); padding: var(--spacing-md); border-radius: var(--radius-xl); margin-bottom: var(--spacing-md); display: flex; align-items: center; gap: var(--spacing-md); box-shadow: 0 10px 30px rgba(0,0,0,0.5); backdrop-filter: blur(10px); }

        /* === BEATS SECTION (Vertical Video Feed) === */
        #view-beats {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 65px;
            background: #000;
            overflow-y: scroll;
            scroll-snap-type: y mandatory;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: none;
        }
        #view-beats::-webkit-scrollbar { display: none; }

        .beats-video-container {
            position: relative;
            width: 100%;
            height: calc(100vh - 65px);
            scroll-snap-align: start;
            background: #000;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .beats-video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .beats-overlay {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            padding: 20px;
            background: linear-gradient(to top, rgba(0,0,0,0.9), transparent);
            z-index: 10;
        }

        .beats-user-info {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 12px;
        }

        .beats-avatar {
            width: 42px;
            height: 42px;
            border-radius: 50%;
            border: 2px solid rgba(255,255,255,0.3);
            cursor: pointer;
            flex-shrink: 0;
        }

        .beats-username {
            font-size: 15px;
            font-weight: 700;
            color: white;
            text-shadow: 0 2px 8px rgba(0,0,0,0.8);
            flex: 1;
        }

        .beats-follow-btn {
            background: linear-gradient(135deg, #ef4444, #dc2626);
            color: white;
            border: none;
            padding: 8px 20px;
            border-radius: 6px;
            font-weight: 700;
            font-size: 13px;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(239, 68, 68, 0.4);
            flex-shrink: 0;
            white-space: nowrap;
        }

        .beats-follow-btn.following {
            background: rgba(255,255,255,0.2);
            border: 1px solid rgba(255,255,255,0.3);
        }

        .beats-description {
            font-size: 14px;
            color: white;
            margin-bottom: 12px;
            text-shadow: 0 2px 6px rgba(0,0,0,0.8);
            line-height: 1.4;
        }

        .beats-music {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 12px;
            color: rgba(255,255,255,0.8);
        }

        .beats-comments-preview {
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid rgba(255,255,255,0.1);
        }

        .beats-view-comments {
            color: rgba(255,255,255,0.6);
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            margin-bottom: 8px;
            display: inline-block;
        }

        .beats-view-comments:active {
            color: rgba(255,255,255,0.8);
        }

        .beats-preview-comment {
            display: flex;
            gap: 8px;
            margin-bottom: 6px;
            font-size: 13px;
            line-height: 1.4;
        }

        .beats-preview-comment-author {
            color: white;
            font-weight: 700;
        }

        .beats-preview-comment-text {
            color: rgba(255,255,255,0.9);
            flex: 1;
        }

        .beats-actions {
            position: absolute;
            right: 15px;
            bottom: 100px;
            display: flex;
            flex-direction: column;
            gap: 20px;
            z-index: 10;
        }

        .beats-action-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            background: rgba(255,255,255,0.15);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 50%;
            width: 50px;
            height: 50px;
            cursor: pointer;
            color: white;
            justify-content: center;
            transition: 0.2s;
        }

        .beats-action-btn:active {
            transform: scale(0.9);
        }

        .beats-action-count {
            font-size: 11px;
            font-weight: 700;
            color: white;
            text-shadow: 0 2px 4px rgba(0,0,0,0.8);
        }

        .beats-header {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            padding: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 20;
            background: linear-gradient(to bottom, rgba(0,0,0,0.6), transparent);
        }

        .beats-logo {
            font-size: 18px;
            font-weight: 900;
            color: white;
            letter-spacing: 1px;
            text-shadow: 0 2px 8px rgba(0,0,0,0.8);
        }

        .beats-search-btn {
            background: rgba(255,255,255,0.15);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.2);
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            cursor: pointer;
        }

        .beats-placeholder {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            color: rgba(255,255,255,0.6);
            padding: 60px 20px;
            min-height: calc(100vh - 200px);
        }

        .beats-placeholder i {
            margin-bottom: 20px;
            opacity: 0.5;
        }

        .beats-placeholder h3 {
            margin: 10px 0;
            font-weight: 800;
        }

        .beats-placeholder p {
            margin: 5px 0;
            font-size: 13px;
            opacity: 0.6;
        }

        /* === BEATS COMMENT MODAL === */
        #beatsCommentModal {
            position: fixed;
            bottom: -100%;
            left: 0;
            right: 0;
            max-height: 70vh;
            background: linear-gradient(to bottom, rgba(15, 23, 42, 0.98), rgba(15, 23, 42, 1));
            backdrop-filter: blur(20px);
            border-top-left-radius: 24px;
            border-top-right-radius: 24px;
            z-index: 10000;
            transition: bottom 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            flex-direction: column;
            border-top: 1px solid rgba(255,255,255,0.1);
        }

        #beatsCommentModal.show {
            bottom: 0;
        }

        .beats-comment-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .beats-comment-header h3 {
            font-size: 16px;
            font-weight: 800;
            color: white;
            margin: 0;
        }

        .beats-comment-close {
            background: rgba(255,255,255,0.1);
            border: none;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
        }

        .beats-comment-list {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
            max-height: calc(70vh - 140px);
        }

        .beats-comment-item {
            display: flex;
            gap: 12px;
            margin-bottom: 15px;
            animation: slideInUp 0.3s ease;
        }

        @keyframes slideInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .beats-comment-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            object-fit: cover;
            flex-shrink: 0;
            cursor: pointer;
        }

        .beats-comment-content {
            flex: 1;
        }

        .beats-comment-author {
            font-size: 14px;
            font-weight: 700;
            color: white;
            margin-bottom: 4px;
        }

        .beats-comment-text {
            font-size: 13px;
            color: #cbd5e1;
            line-height: 1.4;
            word-wrap: break-word;
        }

        .beats-comment-time {
            font-size: 11px;
            color: #64748b;
            margin-top: 4px;
        }

        .beats-comment-input-area {
            padding: 15px;
            border-top: 1px solid rgba(255,255,255,0.1);
            background: rgba(15, 23, 42, 1);
        }

        .beats-comment-input-wrapper {
            display: flex;
            gap: 12px;
            align-items: center;
        }

        .beats-comment-input {
            flex: 1;
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.15);
            border-radius: 20px;
            padding: 10px 16px;
            color: white;
            font-size: 14px;
            outline: none;
        }

        .beats-comment-input::placeholder {
            color: #64748b;
        }

        .beats-comment-send {
            background: linear-gradient(135deg, var(--accent), #2563eb);
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            flex-shrink: 0;
        }

        .beats-comment-send:active {
            transform: scale(0.95);
        }

        .beats-comment-empty {
            text-align: center;
            padding: 40px 20px;
            color: #64748b;
        }

        .nd-icon { background: linear-gradient(135deg, rgba(251, 191, 36, 0.2), rgba(245, 158, 11, 0.2)); color: var(--gold); width: 45px; height: 45px; border-radius: var(--radius-md); display: flex; align-items: center; justify-content: center; flex-shrink: 0; border: 1px solid rgba(251, 191, 36, 0.4); }
        .nd-info { flex: 1; }
        .next-draw-label { font-size: 11px; font-weight: 800; color: var(--gold); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 2px; }
        .next-draw-time { font-size: 18px; font-weight: 900; color: white; text-shadow: 0 2px 5px rgba(0,0,0,0.8); }
        .container { width: 100%; max-width: 500px; margin: 0 auto; padding: var(--spacing-sm); padding-bottom: 80px; /* Space for Nav */ }
        .card { background: var(--glass-surface); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); border-radius: 24px; padding: var(--spacing-md); margin-bottom: var(--spacing-lg); border: 1px solid var(--glass-border); position: relative; transition: all 0.3s ease; box-shadow: 0 15px 35px rgba(0,0,0,0.4); }
        
        .video-feed-wrapper { margin-bottom: var(--spacing-md); border-radius: 24px; overflow: hidden; background: #000; border: 2px solid rgba(255,255,255,0.2); box-shadow: 0 10px 40px rgba(0,0,0,0.6); }
        .video-container { position: relative; width: 100%; aspect-ratio: 16 / 9; }
        .video-overlay-bl { position: absolute; bottom: 12px; left: 12px; z-index: 10; background: rgba(0,0,0,0.9); padding: 6px 12px; border-radius: var(--radius-sm); border: 1px solid var(--success); display: flex; align-items: center; gap: 5px; color: var(--success); font-size: 11px; font-weight: 800; }
        .draw-panel { display: grid; grid-template-columns: 1fr 90px; gap: var(--spacing-sm); margin-bottom: var(--spacing-lg); }
        .prev-balls { background: rgba(0,0,0,0.4); border-radius: var(--radius-lg); padding: var(--spacing-sm); display: flex; align-items: center; gap: var(--spacing-xs); overflow-x: auto; scrollbar-width: none; border: 1px solid rgba(255,255,255,0.1); }
        .ball-small { min-width: 40px; height: 40px; background: linear-gradient(135deg, #334155, #1e293b); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 14px; font-weight: 900; border: 1px solid rgba(255,255,255,0.3); color: white; box-shadow: 0 4px 10px rgba(0,0,0,0.3); text-shadow: 0 1px 2px black; }
        .current-ball-box { background: linear-gradient(135deg, var(--accent), #2563eb); border-radius: var(--radius-lg); height: 90px; display: flex; flex-direction: column; align-items: center; justify-content: center; box-shadow: 0 8px 25px rgba(59, 130, 246, 0.5); border: 2px solid rgba(255,255,255,0.4); position: relative; overflow: hidden; }
        .current-ball-box::before { content: ''; position: absolute; top: -50%; left: -50%; width: 200%; height: 200%; background: linear-gradient(45deg, transparent, rgba(255,255,255,0.3), transparent); animation: shine 3s infinite; }
        @keyframes shine { 0% { transform: translateX(-100%); } 100% { transform: translateX(100%); } }
        .bingo-header { display: grid; grid-template-columns: repeat(5, 1fr); gap: 4px; margin-bottom: var(--spacing-sm); }
        .letter { text-align: center; font-size: 24px; font-weight: 900; color: var(--gold); text-shadow: 0 2px 10px rgba(251, 191, 36, 0.8); -webkit-text-stroke: 1px rgba(0,0,0,0.5); }
        .grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 4px; position: relative; }
        .cell { aspect-ratio: 1; background: rgba(255,255,255,0.1); border-radius: var(--radius-md); display: flex; align-items: center; justify-content: center; font-weight: 800; font-size: 16px; border: 1px solid rgba(255,255,255,0.15); transition: all 0.3s; z-index: 2; position: relative; overflow: hidden; box-shadow: inset 0 2px 5px rgba(255,255,255,0.05); color: white; text-shadow: 0 2px 3px black; }
        /* HIT VISIBILITY FIX */
        .cell.hit { 
            background: linear-gradient(135deg, var(--accent), #2563eb) !important; 
            color: white !important; 
            transform: scale(1.05); 
            border-color: rgba(255,255,255,0.6) !important; 
            box-shadow: 0 5px 15px rgba(59, 130, 246, 0.6) !important; 
            text-shadow: 0 2px 2px rgba(0,0,0,0.5) !important;
            opacity: 1 !important;
        }
        .cell.hit::after {
            content: '';
            position: absolute; inset: 2px;
            border: 2px solid rgba(255,255,255,0.8);
            border-radius: var(--radius-sm);
            pointer-events: none;
        }
        
        .card.card-win { border: 3px solid var(--success) !important; box-shadow: 0 0 50px rgba(16, 185, 129, 0.5); animation: pulse-win 2s infinite; background: rgba(16, 185, 129, 0.2); }
        .card.card-lost { opacity: 0.6; filter: grayscale(0.8); pointer-events: none; }
        .card.card-puro { border: 2px solid var(--gold) !important; box-shadow: 0 0 40px rgba(251, 191, 36, 0.4); animation: pulse-gold 1.5s infinite; }
        .cell.cell-waiting { background: #fffbeb !important; color: #b45309 !important; border: 2px dashed #f59e0b; animation: flash-waiting 1s infinite; z-index: 5; font-weight: 900; transform: scale(1.1); box-shadow: 0 0 20px rgba(251, 191, 36, 0.8); text-shadow: none; }
        .cell.win-glow { background: #10b981 !important; color: white; z-index: 3; border: 2px solid #fff; box-shadow: 0 0 25px var(--success), inset 0 0 15px rgba(255,255,255,0.3); animation: popWin 0.4s ease forwards; }
        .cell.win-glow::after { opacity: 0; animation: fadeInLine 0.5s forwards; }
        .cell.win-line-h::after { content:''; position:absolute; top:50%; left:0; right:0; height:6px; background:var(--gold); transform:translateY(-50%); box-shadow:0 0 10px rgba(0,0,0,0.5); z-index:10; border-radius: var(--radius-sm); }
        .cell.win-line-v::after { content:''; position:absolute; top:0; bottom:0; left:50%; width:6px; background:var(--gold); transform:translateX(-50%); box-shadow:0 0 10px rgba(0,0,0,0.5); z-index:10; border-radius: var(--radius-sm); }
        .cell.win-line-d1::after { content:''; position:absolute; top:50%; left:-50%; right:-50%; height:6px; background:var(--gold); transform:translateY(-50%) rotate(45deg); box-shadow:0 0 10px rgba(0,0,0,0.5); z-index:10; }
        .cell.win-line-d2::after { content:''; position:absolute; top:50%; left:-50%; right:-50%; height:6px; background:var(--gold); transform:translateY(-50%) rotate(-45deg); box-shadow:0 0 10px rgba(0,0,0,0.5); z-index:10; }
        .late-overlay, .game-over-overlay { position: absolute; inset: 0; background: rgba(15, 23, 42, 0.95); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px); z-index: 100; display: none; flex-direction: column; align-items: center; justify-content: center; text-align: center; padding: var(--spacing-lg); border-radius: var(--radius-xl); border: 1px solid rgba(255,255,255,0.2); }
        .late-text { font-weight: 800; font-size: 20px; color: white; margin-bottom: var(--spacing-xs); text-shadow: 0 4px 10px rgba(0,0,0,0.8); }
        .late-subtext { font-size: 14px; opacity: 1; color: #cbd5e1; text-shadow: 0 2px 4px black; }
        #winnerBanner { display: none; background: linear-gradient(135deg, #10b981, #059669); color: white; padding: var(--spacing-md); border-radius: var(--radius-lg); text-align: center; font-weight: 900; margin-bottom: var(--spacing-md); animation: slideDown 0.5s ease; border: 2px solid #a7f3d0; box-shadow: 0 10px 30px rgba(16, 185, 129, 0.4); text-shadow: 0 1px 2px rgba(0,0,0,0.5); }
        .winner-line { font-size: 13px; opacity: 1; margin-top: 5px; display: block; font-weight: 600; }
        @keyframes slideDown { from { transform: translateY(-10px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .chat-box { height: 480px; display: flex; flex-direction: column; background: #111827; border-radius: var(--radius-xl); border: 1px solid rgba(255,255,255,0.1); overflow: hidden; box-shadow: 0 20px 50px rgba(0,0,0,0.5); position: relative; }
        .chat-header { padding: var(--spacing-md) 20px; background: rgba(31, 41, 55, 0.95); border-bottom: 1px solid rgba(255,255,255,0.08); display: flex; align-items: center; gap: var(--spacing-sm); z-index: 10; box-shadow: 0 2px 10px rgba(0,0,0,0.2); }
        .chat-header h3 { margin: 0; font-size: 14px; font-weight: 800; letter-spacing: 0.5px; color: var(--accent-glow); text-transform: uppercase; }
        #chatList { flex: 1; overflow-y: auto; padding: var(--spacing-md); display: flex; flex-direction: column; gap: var(--spacing-sm); scroll-behavior: smooth; background: #0f172a; }
        .chat-row { display: flex; gap: var(--spacing-sm); max-width: 100%; animation: fadeIn 0.3s ease; align-items: flex-end; }
        .chat-pfp { width: 32px; height: 32px; border-radius: 50%; border: 1px solid rgba(255,255,255,0.2); flex-shrink: 0; object-fit: cover; cursor: pointer; }
        .chat-content { display: flex; flex-direction: column; max-width: 80%; }
        .bubble { padding: var(--spacing-sm) 14px; font-size: 13px; line-height: 1.4; color: #e2e8f0; word-break: break-word; font-weight: 500; box-shadow: 0 2px 5px rgba(0,0,0,0.1); position: relative; }
        .chat-row[style*="row-reverse"] .bubble { background: linear-gradient(135deg, var(--accent), #2563eb); color: white; border-radius: var(--radius-lg) 18px 4px 18px; text-shadow: 0 1px 2px rgba(0,0,0,0.2); }
        .chat-row:not([style*="row-reverse"]) .bubble { background: #374151; color: #f3f4f6; border-radius: var(--radius-lg) 18px 18px 4px; border: 1px solid var(--glass-border); }
        .chat-name { font-size: 10px; font-weight: 700; color: #94a3b8; margin-bottom: 4px; cursor:pointer; margin-left: 2px; }
        .chat-row[style*="row-reverse"] .chat-name { display: none; }
        .chat-input-area { background: #1f2937; padding: var(--spacing-sm); border-top: 1px solid rgba(255,255,255,0.08); display: flex; gap: var(--spacing-sm); align-items: center; }
        .input-wrapper { flex: 1; display: flex; gap: var(--spacing-sm); background: #374151; padding: 0 15px; border-radius: 24px; border: 1px solid transparent; transition: 0.3s; align-items: center; height: 42px; }
        .input-wrapper:focus-within { border-color: var(--accent); background: #4b5563; }
        .input-wrapper input { flex: 1; background: none; border: none; color: white; outline: none; font-size: 13px; height: 100%; }
        .send-btn { background: var(--accent); color: white; border: none; width: 40px; height: 40px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: 0.2s; box-shadow: 0 4px 12px rgba(14, 165, 233, 0.3); }
        .send-btn:hover { transform: scale(1.05); }
        
        /* === PROFESSIONAL MESSENGER - Legacy classes kept for compatibility === */
        .pm-container { width: 100%; height: 100%; display: flex; flex-direction: column; overflow: hidden; }
        .pm-messages { flex: 1; overflow-y: auto; padding: var(--spacing-md); display: flex; flex-direction: column; gap: 4px; }
        .msg-bubble { padding: var(--spacing-sm) 16px; font-size: 15px; max-width: 75%; word-break: break-word; line-height: 1.4; margin-bottom: 2px; position: relative; }
        .msg-me { align-self: flex-end; background: var(--messenger-blue); color: white; border-radius: 18px 18px 4px 18px; }
        .msg-them { align-self: flex-start; background: var(--messenger-grey); color: white; border-radius: 18px 18px 18px 4px; }
        .unread-dot { width: 10px; height: 10px; background: var(--accent); border-radius: 50%; display: inline-block; flex-shrink: 0; }
        
        /* PWA Banner */
        #pwaInstallBanner { position: fixed; bottom: calc(80px + env(safe-area-inset-bottom)); left: 0; right: 0; background: linear-gradient(135deg, #0f172a, #1e293b); border-top: 1px solid rgba(255,255,255,0.2); padding: var(--spacing-md) 20px; display: none; align-items: center; justify-content: space-between; z-index: 9999; box-shadow: 0 -10px 30px rgba(0,0,0,0.8); animation: slideUp 0.5s ease; }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
        .pwa-text { font-size: 14px; font-weight: 800; color: white; }
        .pwa-sub { font-size: 11px; color: #cbd5e1; display: block; }
        .pwa-btn { background: var(--accent); color: white; border: none; padding: var(--spacing-sm) 20px; border-radius: var(--radius-md); font-weight: 900; font-size: 13px; cursor: pointer; box-shadow: 0 4px 15px rgba(59, 130, 246, 0.4); }
        .install-tabs { display: flex; gap: var(--spacing-sm); margin-bottom: var(--spacing-lg); background: rgba(0,0,0,0.3); padding: 5px; border-radius: var(--radius-md); }
        .install-tab-btn { flex: 1; padding: var(--spacing-sm); border: none; background: transparent; color: #94a3b8; font-weight: 800; border-radius: var(--radius-sm); cursor: pointer; }
        .install-tab-btn.active { background: var(--accent); color: white; }
        .guide-step { display: flex; align-items: center; gap: var(--spacing-md); margin-bottom: var(--spacing-md); background: rgba(255,255,255,0.05); padding: var(--spacing-md); border-radius: var(--radius-md); border: 1px solid rgba(255,255,255,0.1); }
        .step-num { width: 30px; height: 30px; background: var(--gold); color: black; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 900; flex-shrink: 0; }
        .step-text { font-size: 13px; line-height: 1.4; color: #e2e8f0; }
        #customConfirmModal { position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 100000; display: none; align-items: center; justify-content: center; padding: var(--spacing-lg); backdrop-filter: blur(10px); }
        .conf-content { background: rgba(30, 41, 59, 0.95); border: 1px solid rgba(255,255,255,0.2); border-radius: 24px; padding: 25px; width: 100%; max-width: 320px; text-align: center; box-shadow: 0 25px 60px rgba(0,0,0,0.8); transform: scale(0.9); animation: popScale 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; }
        .conf-title { font-size: 18px; font-weight: 900; color: white; margin: 0 0 10px 0; }
        .conf-msg { font-size: 13px; color: #cbd5e1; margin-bottom: 25px; line-height: 1.5; white-space: pre-wrap; }
        .conf-actions { display: flex; gap: var(--spacing-sm); justify-content: center; }
        .btn-conf-yes { background: var(--accent); color: white; flex: 1; padding: var(--spacing-sm); border: none; border-radius: var(--radius-md); font-weight: 800; cursor: pointer; box-shadow: 0 4px 15px rgba(59, 130, 246, 0.4); }
        .btn-conf-no { background: rgba(255,255,255,0.1); color: #94a3b8; flex: 1; padding: var(--spacing-sm); border: 1px solid rgba(255,255,255,0.1); border-radius: var(--radius-md); font-weight: 800; cursor: pointer; }
        #grandJackpotModal { position: fixed; inset: 0; z-index: 99999; background: rgba(0,0,0,0.95); display: none; align-items: center; justify-content: center; flex-direction: column; overflow: hidden; perspective: 1000px; }
        .jackpot-rays { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 200vmax; height: 200vmax; background: conic-gradient(from 0deg, transparent 0deg, rgba(251, 191, 36, 0.1) 10deg, transparent 20deg, rgba(251, 191, 36, 0.1) 30deg, transparent 40deg, rgba(251, 191, 36, 0.1) 50deg, transparent 60deg, rgba(251, 191, 36, 0.1) 70deg, transparent 80deg, rgba(251, 191, 36, 0.1) 90deg, transparent 100deg, rgba(251, 191, 36, 0.1) 110deg, transparent 120deg, rgba(251, 191, 36, 0.1) 130deg, transparent 140deg, rgba(251, 191, 36, 0.1) 150deg, transparent 160deg, rgba(251, 191, 36, 0.1) 170deg, transparent 180deg, rgba(251, 191, 36, 0.1) 190deg, transparent 200deg, rgba(251, 191, 36, 0.1) 210deg, transparent 220deg, rgba(251, 191, 36, 0.1) 230deg, transparent 240deg, rgba(251, 191, 36, 0.1) 250deg, transparent 260deg, rgba(251, 191, 36, 0.1) 270deg, transparent 280deg, rgba(251, 191, 36, 0.1) 290deg, transparent 300deg, rgba(251, 191, 36, 0.1) 310deg, transparent 320deg, rgba(251, 191, 36, 0.1) 330deg, transparent 340deg, rgba(251, 191, 36, 0.1) 350deg, transparent 360deg); animation: spinRays 20s linear infinite; pointer-events: none; }
        @keyframes spinRays { from { transform: translate(-50%, -50%) rotate(0deg); } to { transform: translate(-50%, -50%) rotate(360deg); } }
        .jackpot-content { position: relative; z-index: 10; text-align: center; animation: jpPopIn 0.8s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        @keyframes jpPopIn { 0% { transform: scale(0); opacity: 0; } 100% { transform: scale(1); opacity: 1; } 100% { transform: scale(1); opacity: 1; } }
        .jp-title { font-size: 40px; font-weight: 900; color: #fbbf24; text-transform: uppercase; letter-spacing: 2px; text-shadow: 0 0 20px rgba(251, 191, 36, 0.8), 0 0 40px rgba(251, 191, 36, 0.4); margin-bottom: var(--spacing-sm); animation: pulseText 1s infinite alternate; }
        .jp-amount { font-size: 56px; font-weight: 900; color: white; background: linear-gradient(135deg, #fff, #fcd34d); -webkit-background-clip: text; -webkit-text-fill-color: transparent; text-shadow: 0 10px 30px rgba(0,0,0,0.5); margin: 0; line-height: 1; }
        .jp-name { font-size: 18px; color: #cbd5e1; margin-top: 15px; font-weight: 600; letter-spacing: 1px; text-transform: uppercase; }
        .icon-glow { filter: drop-shadow(0 0 20px rgba(251, 191, 36, 0.8)); animation: bounceIcon 2s infinite ease-in-out; color: #fbbf24; }
        @keyframes bounceIcon { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-15px); } }
        @keyframes pulseText { from { transform: scale(1); } to { transform: scale(1.05); } }
        @keyframes pulse-ring { 0% { box-shadow: 0 0 0 0 rgba(255,255,255,0.1); } 70% { box-shadow: 0 0 0 15px rgba(255,255,255,0); } 100% { box-shadow: 0 0 0 0 rgba(255,255,255,0); } }
        .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 6000; display: none; align-items: center; justify-content: center; padding: var(--spacing-md); backdrop-filter: blur(15px); }
        .modal-content { background: rgba(30, 41, 59, 0.95); border-radius: 30px; width: 100%; max-width: 450px; padding: 25px; border: 1px solid rgba(255,255,255,0.2); max-height: 90vh; overflow-y: auto; box-shadow: 0 25px 60px rgba(0,0,0,0.8); -webkit-backdrop-filter: blur(20px); backdrop-filter: blur(20px); }
        
        /* === FULL SCREEN STORE MODAL === */
        #storeModal {
            padding: 0;
            align-items: stretch;
            justify-content: stretch;
            background: #020617;
        }
        
        #storeModal .modal-content {
            max-width: 100%;
            max-height: 100%;
            height: 100%;
            width: 100%;
            border-radius: 0;
            padding: 0;
            overflow-y: auto;
            background: linear-gradient(180deg, #0f172a 0%, #020617 100%);
            border: none;
            box-shadow: none;
            display: flex;
            flex-direction: column;
        }
        
        /* Store Header - Fixed at top */
        .store-header {
            position: sticky;
            top: 0;
            z-index: 100;
            background: linear-gradient(145deg, rgba(30, 41, 59, 0.98), rgba(22, 27, 34, 0.98));
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            padding: 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        }
        
        .store-header-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }
        
        .store-back-btn {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: rgba(59, 130, 246, 0.1);
            border: 1.5px solid rgba(59, 130, 246, 0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
            color: #60a5fa;
        }
        .store-back-btn:hover {
            background: rgba(59, 130, 246, 0.2);
            transform: scale(1.08);
            border-color: rgba(59, 130, 246, 0.5);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
        }
        .store-back-btn:active {
            transform: scale(0.95);
        }
        .store-back-btn i {
            width: 20px;
            height: 20px;
        }
        
        .store-title-section {
            flex: 1;
            text-align: center;
        }
        
        .store-title-section h3 {
            margin: 0;
            font-size: 24px;
            font-weight: 900;
            background: linear-gradient(135deg, #60a5fa, #3b82f6);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            letter-spacing: 0.5px;
        }
        
        .store-title-section p {
            margin: 4px 0 0 0;
            font-size: 12px;
            opacity: 0.7;
            font-weight: 600;
        }
        
        .points-badge {
            min-width: 100px;
        }
        
        /* Store Body - Scrollable content */
        .store-body {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            padding-bottom: calc(20px + env(safe-area-inset-bottom));
        }
        .reward-grid { display: grid; grid-template-columns: 1fr; gap: 16px; margin-top: 20px; }
        .reward-item { 
            background: linear-gradient(145deg, rgba(30, 41, 59, 0.95), rgba(22, 27, 34, 0.95));
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            padding: 18px; 
            border-radius: 16px; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            border: 1px solid rgba(255, 255, 255, 0.1); 
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); 
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        }
        .reward-item:hover { 
            transform: translateY(-3px); 
            border-color: rgba(59, 130, 246, 0.4); 
            box-shadow: 0 8px 25px rgba(59, 130, 246, 0.2);
        }
        .reward-main { display: flex; align-items: center; gap: 14px; }
        .reward-icon-box { 
            width: 48px; 
            height: 48px; 
            background: rgba(59, 130, 246, 0.15); 
            border-radius: 12px; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            color: #60a5fa; 
            border: 1.5px solid rgba(59, 130, 246, 0.3);
            transition: all 0.3s ease;
        }
        .reward-item:hover .reward-icon-box {
            transform: scale(1.1);
            background: rgba(59, 130, 246, 0.25);
        }
        .reward-info b { 
            font-size: 16px; 
            display: block; 
            color: white; 
            letter-spacing: 0.3px; 
            text-shadow: 0 2px 2px rgba(0, 0, 0, 0.5); 
            font-weight: 700;
        }
        .reward-info small { 
            color: var(--gold); 
            font-weight: 700; 
            font-size: 12px; 
            display: flex; 
            align-items: center; 
            gap: 4px; 
            margin-top: 4px; 
        }
        .btn-redeem { 
            background: linear-gradient(135deg, #3b82f6, #2563eb); 
            color: white; 
            border: none; 
            padding: 10px 20px; 
            border-radius: 12px; 
            font-weight: 800; 
            font-size: 13px; 
            cursor: pointer; 
            box-shadow: 0 4px 14px rgba(59, 130, 246, 0.4),
                        inset 0 1px 0 rgba(255, 255, 255, 0.2); 
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); 
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.5);
            letter-spacing: 0.3px;
        }
        .btn-redeem:hover {
            background: linear-gradient(135deg, #2563eb, #1d4ed8);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(59, 130, 246, 0.5),
                        inset 0 1px 0 rgba(255, 255, 255, 0.2);
        }
        .btn-redeem:active { 
            transform: translateY(0) scale(0.98); 
        }
        
        /* === PROFESSIONAL PROFILE PAGE (REDESIGNED HIGH END - MOBILE OPTIMIZED) === */
        .profile-page-container { 
            position: fixed; inset: 0; background: #020617; z-index: 6000; 
            display: none; flex-direction: column; overflow-y: auto; 
            padding-bottom: calc(80px + env(safe-area-inset-bottom)); 
            scroll-behavior: smooth;
        }
        
        /* Profile Cover - modern responsive background */
        .profile-cover {
            height: 35vh;
            min-height: 200px;
            max-height: 280px;
            background-size: cover; /* Maintains aspect ratio while filling container */
            background-position: center;
            background-repeat: no-repeat;
            position: relative;
            background-color: #334155;
        }
        /* Gradient overlay for smooth transition */
        .profile-cover::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 120px;
            background: linear-gradient(to bottom, transparent, #020617);
            pointer-events: none;
        }

        .profile-nav-back {
            position: absolute; top: 15px; left: 15px; z-index: 20;
            width: 44px; height: 44px; border-radius: 50%; background: rgba(0,0,0,0.5);
            backdrop-filter: blur(15px); border: 1px solid rgba(255,255,255,0.15);
            color: white; display: flex; align-items: center; justify-content: center; cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }
        .profile-nav-back:hover { background: rgba(0,0,0,0.6); transform: scale(1.05); }
        .profile-nav-back:active { transform: scale(0.95); }
        
        /* Profile Menu Button (3-dot) */
        .profile-menu-btn {
            position: absolute; top: 15px; right: 15px; z-index: 20;
            width: 44px; height: 44px; border-radius: 50%; background: rgba(0,0,0,0.5);
            backdrop-filter: blur(15px); border: 1px solid rgba(255,255,255,0.15);
            color: white; display: flex; align-items: center; justify-content: center; cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }
        .profile-menu-btn:hover { background: rgba(0,0,0,0.6); transform: scale(1.05); }
        .profile-menu-btn:active { transform: scale(0.95); }
        
        /* Dropdown Menu */
        .profile-dropdown {
            position: absolute; top: 65px; right: 15px; z-index: 30;
            background: rgba(15, 23, 42, 0.95);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255,255,255,0.15);
            border-radius: var(--radius-lg);
            overflow: hidden;
            display: none;
            box-shadow: 0 10px 40px rgba(0,0,0,0.5);
            min-width: 240px;
        }
        .profile-dropdown.show { display: block; animation: slideIn 0.2s ease; }
        @keyframes slideIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
        
        .dropdown-item {
            padding: 15px 20px;
            display: flex;
            align-items: center;
            gap: 12px;
            cursor: pointer;
            transition: background 0.2s;
            border-bottom: 1px solid rgba(255,255,255,0.05);
            color: white;
            font-weight: 600;
            font-size: 14px;
        }
        .dropdown-item:last-child { border-bottom: none; }
        .dropdown-item:hover { background: rgba(255,255,255,0.08); }
        .dropdown-item:active { background: rgba(255,255,255,0.12); transform: scale(0.98); }
        .dropdown-item i { width: 18px; height: 18px; }
        
        /* Verification Badge (Blue Checkmark) */
        .verified-badge {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 16px;
            height: 16px;
            background: linear-gradient(135deg, #3b82f6, #2563eb);
            border-radius: 50%;
            margin-left: 4px;
            box-shadow: 0 2px 8px rgba(59, 130, 246, 0.4);
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .verified-badge:hover {
            transform: scale(1.15);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.6);
        }
        .verified-badge i {
            width: 10px;
            height: 10px;
            color: white;
        }
        
        /* Verification Badge Tooltip */
        .verification-tooltip {
            position: fixed;
            background: rgba(15, 23, 42, 0.98);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(59, 130, 246, 0.3);
            border-radius: var(--radius-lg);
            padding: 20px;
            max-width: 300px;
            z-index: 10000;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
            display: none;
            animation: tooltipFadeIn 0.2s ease;
        }
        @keyframes tooltipFadeIn {
            from { opacity: 0; transform: translateY(-5px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .verification-tooltip h4 {
            margin: 0 0 10px 0;
            color: #3b82f6;
            font-size: 14px;
            font-weight: 800;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .verification-tooltip p {
            margin: 0;
            font-size: 12px;
            line-height: 1.6;
            color: #cbd5e1;
        }
        
        /* Textarea in confirmation modal */
        .conf-textarea {
            width: 100%;
            background: rgba(0, 0, 0, 0.4);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: var(--radius-md);
            padding: 12px;
            color: white;
            font-family: 'Inter', sans-serif;
            font-size: 13px;
            resize: vertical;
            min-height: 80px;
            margin-top: 15px;
            outline: none;
        }
        .conf-textarea:focus {
            border-color: var(--accent);
            background: rgba(0, 0, 0, 0.6);
        }
        .conf-textarea::placeholder {
            color: rgba(255, 255, 255, 0.4);
        }
        
        .profile-info-section {
            padding: 0 20px;
            margin-top: -80px; /* Elegant avatar overlap with cover photo */
            position: relative;
            z-index: 10;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        .profile-avatar-container {
            position: relative;
            margin-bottom: var(--spacing-md);
        }
        
        /* Avatar frame styling for profile page - cleaner border and glow */
        /* Note: !important is required to override inline styles set by renderAvatarWithBadge JS function */
        .profile-avatar-container .avatar-frame {
            width: 120px !important;
            height: 120px !important;
            filter: drop-shadow(0 8px 24px rgba(0,0,0,0.4));
        }
        .profile-avatar-container .avatar-frame img {
            border: 4px solid white !important;
            box-shadow: 0 0 30px rgba(59, 130, 246, 0.3);
        }
        
        .profile-rank-ring {
            position: absolute; inset: -8px; border-radius: 50%;
            border: 2px solid rgba(255,255,255,0.2);
            animation: spin 20s linear infinite;
            pointer-events: none;
        }

        .profile-page-name { 
            font-size: 28px; font-weight: 900; color: white; 
            margin: 0 0 8px 0; letter-spacing: 0.5px; 
            display: flex; align-items: center; gap: var(--spacing-xs); justify-content: center; 
            text-shadow: 0 2px 8px rgba(0,0,0,0.6), 0 4px 16px rgba(0,0,0,0.3); 
            text-align: center; 
        }
        .profile-page-bio { 
            font-size: 15px; color: #cbd5e1; 
            margin: 0 0 25px 0; text-align: center; 
            max-width: 320px; line-height: 1.6;
            text-shadow: 0 1px 3px rgba(0,0,0,0.5);
        }
        
        .profile-action-btn {
            padding: 14px 32px;
            width: 100%;
            max-width: 280px;
            background: linear-gradient(135deg, #3b82f6, #2563eb);
            color: white;
            border: none;
            border-radius: 50px;
            font-size: 14px; font-weight: 700; 
            cursor: pointer; 
            box-shadow: 0 4px 20px rgba(59, 130, 246, 0.4);
            transition: all 0.3s ease; 
            margin-bottom: var(--spacing-sm);
            text-transform: uppercase; 
            letter-spacing: 1px;
        }
        .profile-action-btn:hover { 
            box-shadow: 0 6px 30px rgba(59, 130, 246, 0.5); 
            transform: translateY(-2px);
        }
        .profile-action-btn:active { transform: scale(0.97); }
        .profile-action-btn.secondary { 
            background: rgba(255,255,255,0.08); 
            border: 1px solid rgba(255,255,255,0.15); 
            box-shadow: none; 
            color: white; 
            backdrop-filter: blur(12px);
        }
        .profile-action-btn.secondary:hover {
            background: rgba(255,255,255,0.12);
            border-color: rgba(255,255,255,0.25);
        }
        
        .profile-stats-card {
            display: flex; justify-content: space-around;
            background: rgba(15, 23, 42, 0.6);
            border: 1px solid var(--glass-border);
            backdrop-filter: blur(20px);
            padding: var(--spacing-lg) 15px;
            border-radius: var(--radius-xl);
            width: 100%;
            margin-bottom: var(--spacing-lg);
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }
        .stat-item { text-align: center; flex: 1; position: relative; }
        .stat-item:not(:last-child)::after {
            content: ''; position: absolute; right: 0; top: 10%; bottom: 10%; width: 1px; background: rgba(255,255,255,0.08);
        }
        .stat-val { font-size: 20px; font-weight: 900; color: white; display: block; margin-bottom: 4px; letter-spacing: 0.5px; }
        .stat-lbl { font-size: 11px; color: #94a3b8; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; }
        
        .profile-feed-section {
            padding: 0 10px;
            width: 100%;
        }
        
        .profile-feed-section::before {
            content: 'Posts';
            display: block;
            font-size: 16px;
            font-weight: 800;
            color: white;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: var(--spacing-md);
            padding-bottom: 12px;
            border-bottom: 2px solid rgba(255,255,255,0.1);
        }
        
        .profile-header { display: flex; align-items: center; gap: var(--spacing-md); margin-bottom: 25px; padding-bottom: 15px; border-bottom: 1px solid rgba(255,255,255,0.1); }
        .profile-img-large { width: 70px; height: 70px; border-radius: 22px; border: 3px solid var(--accent); box-shadow: 0 0 20px rgba(59, 130, 246, 0.3); object-fit: cover; }
        .profile-name-info { flex: 1; }
        .profile-name { font-size: 20px; font-weight: 900; margin: 0; text-shadow: 0 2px 4px rgba(0,0,0,0.8); }
        .profile-uid { font-size: 11px; opacity: 0.8; text-transform: uppercase; letter-spacing: 1px; color: #cbd5e1; }
        .gcash-section { background: rgba(59, 130, 246, 0.15); padding: var(--spacing-md); border-radius: var(--radius-lg); margin-bottom: var(--spacing-md); border: 1px solid rgba(59, 130, 246, 0.3); }
        .styled-input { width: 100%; background: rgba(0,0,0,0.4); border: 1px solid rgba(255,255,255,0.2); padding: var(--spacing-sm) 15px; border-radius: var(--radius-md); color: white; font-weight: 700; outline: none; font-size: 14px; box-shadow: inset 0 2px 5px rgba(0,0,0,0.3); text-shadow: none; }
        .styled-input:focus { border-color: var(--accent); background: rgba(0,0,0,0.6); }
        .ref-container { background: linear-gradient(135deg, rgba(16, 185, 129, 0.15), rgba(59, 130, 246, 0.15)); border: 1px solid rgba(16, 185, 129, 0.3); padding: var(--spacing-md); border-radius: var(--radius-lg); margin-bottom: var(--spacing-md); }
        .history-box { margin-top: var(--spacing-lg); background: rgba(0,0,0,0.3); border-radius: var(--radius-xl); padding: var(--spacing-lg); border: 1px solid rgba(255,255,255,0.1); }
        .history-list { max-height: 250px; overflow-y: auto; padding-right: 5px; }
        .history-item { display: flex; justify-content: space-between; align-items: center; padding: var(--spacing-sm) 0; border-bottom: 1px solid rgba(255,255,255,0.1); }
        .btn-change { background: rgba(59, 130, 246, 0.2); color: var(--accent-glow); border: 1px solid var(--accent); height: 40px; padding: 0 15px; border-radius: var(--radius-md); font-size: 11px; font-weight: 800; cursor: pointer; display: flex; align-items: center; gap: 5px; transition: 0.2s; box-shadow: 0 4px 10px rgba(0,0,0,0.2); text-shadow: 0 1px 2px black; }
        .btn-change:hover { background: var(--accent); color: white; }
        .btn-change:disabled { opacity: 0.5; cursor: not-allowed; border-color: #475569; color: #94a3b8; background: none; }
        .pattern-box { background: rgba(0,0,0,0.4); height: 40px; padding: 0 15px; border-radius: var(--radius-md); display: flex; align-items: center; gap: var(--spacing-xs); border: 1px solid rgba(255,255,255,0.1); backdrop-filter: blur(5px); }
        .pattern-dot { width: 8px; height: 8px; border-radius: 50%; background: var(--gold); box-shadow: 0 0 10px var(--gold); }
        .pattern-text { font-size: 11px; font-weight: 800; color: var(--gold); text-transform: uppercase; letter-spacing: 0.5px; }
        .notif-card-new { background: rgba(255,255,255,0.1); padding: var(--spacing-md); border-radius: var(--radius-lg); margin-bottom: 12px; border: 1px solid rgba(255,255,255,0.15); position: relative; transition: 0.2s; backdrop-filter: blur(5px); }
        .notif-card-new:hover { background: rgba(255,255,255,0.15); border-color: var(--accent); }
        .notif-header-new { display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--spacing-xs); }
        .notif-title { font-size: 12px; font-weight: 800; color: var(--accent-glow); display: flex; align-items: center; gap: 5px; }
        .notif-time { font-size: 10px; opacity: 0.6; color: #cbd5e1; }
        .notif-body { font-size: 13px; line-height: 1.5; color: #ffffff; text-shadow: 0 1px 2px black; }
        .btn-del-notif { background: none; border: none; color: #94a3b8; cursor: pointer; padding: 4px; transition: 0.2s; }
        .btn-del-notif:hover { color: var(--danger); }
        .result-modal { position: absolute; inset: 0; background: rgba(0,0,0,0.85); display: none; align-items: center; justify-content: center; flex-direction: column; z-index: 50; border-radius: 30px; backdrop-filter: blur(8px); animation: fadeIn 0.3s; }
        .res-title { font-size: 38px; font-weight: 900; margin-bottom: 5px; text-transform: uppercase; letter-spacing: 1px; }
        .res-win { color: #fbbf24; text-shadow: 0 0 30px #fbbf24; }
        .res-loss { color: #ef4444; text-shadow: 0 0 20px rgba(239, 68, 68, 0.5); }
        .res-pts { font-size: 16px; color: white; opacity: 1; margin-bottom: 25px; text-shadow: 0 2px 4px black; }
        .btn-play-again { background: white; color: black; border: none; padding: var(--spacing-sm) 25px; border-radius: 30px; font-weight: 900; font-size: 12px; cursor: pointer; box-shadow: 0 0 20px rgba(255,255,255,0.3); transition: 0.2s; }
        .btn-play-again:hover { transform: scale(1.1); box-shadow: 0 0 30px rgba(255,255,255,0.5); }
        @keyframes blink { from { opacity: 0.5; } to { opacity: 1; } }

        /* === NEW SOCIAL ECOSYSTEM STYLES === */
        .social-feed-container { margin-top: 15px; display: flex; flex-direction: column; gap: var(--spacing-md); }
        
        /* Modern Feed Sort Pills */
        .feed-sort-modern {
            display: flex; 
            align-items: center; 
            justify-content: center; 
            gap: 0;
            margin: 15px auto; 
            padding: 4px; 
            background: rgba(30, 41, 59, 0.8); 
            border-radius: 50px; 
            border: 1px solid rgba(255,255,255,0.1);
            width: fit-content;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
        }
        .sort-btn {
            display: flex; 
            align-items: center; 
            gap: var(--spacing-xs); 
            padding: var(--spacing-sm) 28px;
            border-radius: 50px; 
            border: none; 
            background: transparent;
            color: #94a3b8; 
            font-size: 12px; 
            font-weight: 800; 
            cursor: pointer; 
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .sort-btn.active {
            background: linear-gradient(135deg, var(--accent), #2563eb);
            color: white;
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4);
            transform: scale(1.02);
        }
        .sort-btn:hover:not(.active) { 
            color: white; 
            background: rgba(255,255,255,0.05);
        }

        /* Post Card - Modern Social Media Style */
        .post-card { 
            background: linear-gradient(145deg, rgba(30, 41, 59, 0.95), rgba(22, 27, 34, 0.95));
            backdrop-filter: blur(20px);
            border-radius: 20px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            overflow: hidden;
            margin-bottom: 20px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.4), 
                        0 0 0 1px rgba(59, 130, 246, 0.05);
        }
        .post-card:hover {
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.5),
                        0 0 0 1px rgba(59, 130, 246, 0.2);
            transform: translateY(-2px);
        }

        .post-header { 
            padding: 18px 20px;
            display: flex;
            align-items: center;
            gap: 12px;
            border-bottom: none;
        }
        
        .post-avatar { 
            width: 44px;
            height: 44px;
            border-radius: 50%;
            object-fit: cover;
            border: 2.5px solid rgba(59, 130, 246, 0.3);
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            flex-shrink: 0;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4),
                        0 0 0 3px rgba(59, 130, 246, 0.1);
        }
        .post-avatar:hover {
            transform: scale(1.08);
            border-color: rgba(59, 130, 246, 0.6);
            box-shadow: 0 6px 20px rgba(59, 130, 246, 0.3),
                        0 0 0 3px rgba(59, 130, 246, 0.2);
        }
        
        .post-meta { 
            flex: 1;
            min-width: 0;
        }
        
        .post-author { 
            font-size: 15px;
            font-weight: 700;
            color: white;
            display: flex;
            align-items: center;
            gap: 6px;
            line-height: 1.3;
        }
        
        .add-friend-icon-btn {
            background: rgba(59, 130, 246, 0.12);
            border: 1.5px solid rgba(59, 130, 246, 0.3);
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
            color: #60a5fa;
        }
        .add-friend-icon-btn:hover {
            background: rgba(59, 130, 246, 0.25);
            border-color: rgba(59, 130, 246, 0.5);
            transform: scale(1.15);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
        }
        .add-friend-icon-btn:active {
            transform: scale(1.0);
        }
        .add-friend-icon-btn i {
            width: 14px;
            height: 14px;
        }
        
        .friend-badge { 
            display: none; /* Remove friend badge text */
        }
        
        .post-time { 
            font-size: 12px;
            color: rgba(255, 255, 255, 0.45);
            display: flex;
            align-items: center;
            gap: 5px;
            margin-top: 3px;
            font-weight: 500;
            line-height: 1;
        }
        
        .visibility-badge { 
            font-size: 11px;
            opacity: 0.8;
            display: inline-flex;
            align-items: center;
            line-height: 1;
        }
        .visibility-badge i {
            width: 11px;
            height: 11px;
            display: block;
        }
        
        .mood-display { 
            font-size: 11px;
            background: rgba(59, 130, 246, 0.15);
            padding: 3px 10px;
            border-radius: 12px;
            margin-top: 4px;
            display: inline-block;
            color: rgba(59, 130, 246, 0.9);
            border: 1px solid rgba(59, 130, 246, 0.2);
            font-weight: 600;
        }
        
        .post-content { 
            padding: 0 16px 16px 16px;
            font-size: 15px;
            line-height: 1.5;
            color: rgba(255, 255, 255, 0.9);
            word-break: break-word;
        }
        
        .post-image-container { 
            width: 100%;
            max-height: 400px;
            overflow: hidden;
            display: flex;
            justify-content: center;
            background: #000;
            margin: 0;
            border-top: 1px solid rgba(255, 255, 255, 0.05);
        }
        
        .post-image { 
            max-width: 100%;
            max-height: 400px;
            object-fit: cover;
            width: 100%;
        }
        
        .post-actions { 
            display: flex;
            align-items: center;
            padding: 4px 8px;
            border-top: 1px solid rgba(255, 255, 255, 0.06);
        }
        
        .action-btn { 
            flex: 1;
            background: transparent;
            border: none;
            color: rgba(255, 255, 255, 0.6);
            padding: 10px 12px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: all 0.2s ease;
            position: relative;
            border-radius: 8px;
            margin: 0 2px;
        }
        
        .action-btn:hover { 
            background: rgba(59, 130, 246, 0.1);
            color: rgba(59, 130, 246, 0.9);
            transform: scale(1.05);
        }
        
        .action-btn:active {
            transform: scale(0.95);
        }
        
        .action-btn.liked { 
            color: #f472b6;
            background: rgba(244, 114, 182, 0.1);
        }
        
        .action-btn.liked:hover {
            background: rgba(244, 114, 182, 0.15);
            color: #fb7bca;
        }
        
        .action-btn.delete-btn {
            color: #ef4444;
        }
        
        .action-btn.delete-btn:hover {
            background: rgba(239, 68, 68, 0.1);
            color: #f87171;
        }

        /* Overflow Menu Styles - Modern Dropdown */
        .post-overflow-btn {
            background: transparent;
            border: none;
            color: rgba(255, 255, 255, 0.5);
            cursor: pointer;
            padding: 8px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            position: relative;
        }
        .post-overflow-btn:hover {
            background: rgba(255, 255, 255, 0.1);
            color: rgba(59, 130, 246, 0.9);
        }
        .post-overflow-menu {
            position: absolute;
            top: 100%;
            right: 0;
            background: rgba(22, 27, 34, 0.98);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.6);
            min-width: 180px;
            z-index: 1000;
            display: none;
            overflow: hidden;
            animation: slideIn 0.2s ease;
        }
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-8px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        .post-overflow-menu.show {
            display: block;
        }
        .overflow-menu-item {
            width: 100%;
            padding: 12px 16px;
            background: transparent;
            border: none;
            color: white;
            text-align: left;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.2s ease;
        }
        .overflow-menu-item:hover {
            background: rgba(59, 130, 246, 0.1);
        }
        .overflow-menu-item.delete-item {
            color: #ef4444;
        }
        .overflow-menu-item.delete-item:hover {
            background: rgba(239, 68, 68, 0.1);
        }

        .shared-post-container {
            margin: 0 16px 16px 16px;
            padding: 12px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            background: rgba(0, 0, 0, 0.25);
            font-size: 13px;
            color: rgba(255, 255, 255, 0.7);
        }
        
        /* Reaction Popup */
        .reaction-popup {
            position: absolute;
            bottom: 100%; left: 10px;
            background: rgba(30, 41, 59, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 50px;
            padding: 5px 10px;
            display: none;
            gap: 5px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.5);
            border: 1px solid rgba(255,255,255,0.1);
            animation: popIn 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            z-index: 10;
        }
        .reaction-emoji {
            font-size: 20px;
            cursor: pointer;
            transition: transform 0.2s;
        }
        .reaction-emoji:hover { transform: scale(1.3); }

        .comment-preview-area {
            padding: 12px 16px;
            border-top: 1px solid rgba(255, 255, 255, 0.06);
            background: rgba(0, 0, 0, 0.15);
        }
        .preview-item { 
            display: flex;
            gap: 8px;
            font-size: 13px;
            align-items: center;
        }
        .preview-user { 
            font-weight: 700;
            color: white;
            cursor: pointer;
            transition: color 0.2s;
        }
        .preview-user:hover {
            color: rgba(59, 130, 246, 0.9);
        }
        .preview-text { 
            color: rgba(255, 255, 255, 0.6);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 220px;
        }
        
        /* Support Ticket Styles */
        .ticket-item {
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: var(--radius-md);
            padding: var(--spacing-sm);
            margin-bottom: var(--spacing-sm);
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .ticket-item:hover {
            background: rgba(255,255,255,0.08);
            border-color: var(--accent);
            transform: translateX(4px);
        }
        .ticket-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 5px;
        }
        .ticket-subject {
            font-weight: 800;
            font-size: 12px;
            color: white;
        }
        .ticket-status {
            font-size: 9px;
            padding: 3px 8px;
            border-radius: var(--radius-sm);
            font-weight: 800;
            text-transform: uppercase;
        }
        .ticket-status.open {
            background: rgba(251, 191, 36, 0.2);
            color: var(--gold);
        }
        .ticket-status.closed {
            background: rgba(100, 116, 139, 0.2);
            color: #94a3b8;
        }
        .ticket-time {
            font-size: 10px;
            color: #64748b;
            margin-top: 5px;
        }
        .ticket-reply-count {
            font-size: 10px;
            color: var(--accent-glow);
            display: flex;
            align-items: center;
            gap: 4px;
        }
        
        .ticket-reply-item {
            background: rgba(0,0,0,0.3);
            border: 1px solid var(--glass-border);
            border-radius: var(--radius-md);
            padding: var(--spacing-sm);
            margin-bottom: 12px;
        }
        .ticket-reply-header {
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
            margin-bottom: var(--spacing-xs);
        }
        .ticket-reply-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid rgba(255,255,255,0.2);
        }
        .ticket-reply-author {
            font-weight: 800;
            font-size: 12px;
            color: white;
        }
        .ticket-reply-admin-badge {
            background: var(--accent);
            color: white;
            font-size: 8px;
            padding: 2px 6px;
            border-radius: 4px;
            font-weight: 900;
            text-transform: uppercase;
        }
        .ticket-reply-time {
            font-size: 10px;
            color: #64748b;
            margin-left: auto;
        }
        .ticket-reply-content {
            font-size: 12px;
            line-height: 1.5;
            color: #e2e8f0;
        }
        .ticket-original-message {
            background: rgba(59, 130, 246, 0.1);
            border: 1px solid rgba(59, 130, 246, 0.3);
            border-radius: var(--radius-md);
            padding: var(--spacing-sm);
            margin-bottom: var(--spacing-md);
        }
        .ticket-original-label {
            font-size: 10px;
            font-weight: 800;
            color: var(--accent-glow);
            margin-bottom: var(--spacing-xs);
            text-transform: uppercase;
        }


        /* Friend Request Notification in Feed */
        .friend-req-card { background: rgba(14, 165, 233, 0.1); border: 1px solid var(--accent); padding: var(--spacing-sm); border-radius: var(--radius-md); display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--spacing-md); }
        .req-info { display: flex; align-items: center; gap: var(--spacing-sm); }
        .req-actions { display: flex; gap: 5px; }
        .btn-accept { background: var(--success); color: white; border: none; padding: 6px 12px; border-radius: var(--radius-sm); font-weight: 700; font-size: 11px; cursor: pointer; }
        .btn-decline { background: rgba(255,255,255,0.1); color: white; border: none; padding: 6px 12px; border-radius: var(--radius-sm); font-weight: 700; font-size: 11px; cursor: pointer; }

        /* User Options Modal */
        .user-opt-btn { width: 100%; padding: var(--spacing-md); border: none; background: rgba(255,255,255,0.05); color: white; font-weight: 700; margin-bottom: var(--spacing-xs); border-radius: var(--radius-md); text-align: left; display: flex; align-items: center; gap: var(--spacing-sm); cursor: pointer; }
        .user-opt-btn:hover { background: rgba(255,255,255,0.1); }

        /* UPDATED MESSENGER STYLES */
        .active-friends-bar {
            display: flex; gap: var(--spacing-md); overflow-x: auto; padding: var(--spacing-md); background: #0f172a; border-bottom: 1px solid #1e293b; scrollbar-width: none;
        }
        .active-friend-item {
            display: flex; flex-direction: column; align-items: center; min-width: 60px; cursor: pointer;
        }
        .active-img-wrap { position: relative; width: 50px; height: 50px; }
        .active-img { width: 50px; height: 50px; border-radius: 50%; border: 2px solid var(--messenger-blue); object-fit: cover; }
        .online-dot-large { position: absolute; bottom: 2px; right: 2px; width: 12px; height: 12px; background: #31a24c; border: 2px solid #000; border-radius: 50%; }
        .active-name { font-size: 11px; color: #e4e6eb; margin-top: 5px; max-width: 60px; overflow: hidden; white-space: nowrap; text-overflow: ellipsis; }

        /* NEW BOTTOM SHEET COMMENTS STYLE (TIKTOK/FB STYLE) */
        .comment-modal { 
            position: fixed; inset: auto; bottom: 0; left: 0; right: 0; height: 70vh; 
            background: #1e293b; z-index: 7000; display: none; flex-direction: column; 
            border-radius: var(--radius-xl) 20px 0 0; border-top: 1px solid rgba(255,255,255,0.1);
            animation: slideUpModal 0.3s cubic-bezier(0.16, 1, 0.3, 1);
            box-shadow: 0 -10px 50px rgba(0,0,0,0.5);
        }
        @keyframes slideUpModal { from { transform: translateY(100%); } to { transform: translateY(0); } }
        .comment-modal-backdrop { position: fixed; inset: 0; background: rgba(0,0,0,0.7); z-index: 6999; display: none; backdrop-filter: blur(2px); }

        .comment-header { padding: var(--spacing-md); background: #1e293b; border-bottom: 1px solid rgba(255,255,255,0.1); display: flex; justify-content: space-between; align-items: center; border-radius: var(--radius-xl) 20px 0 0; }
        .comment-list { flex: 1; overflow-y: auto; padding: var(--spacing-md); display: flex; flex-direction: column; gap: var(--spacing-md); }
        .comment-item { display: flex; gap: var(--spacing-sm); align-items: flex-start; }
        .comment-avatar { width: 32px; height: 32px; border-radius: 50%; flex-shrink: 0; }
        .comment-content-block { display: flex; flex-direction: column; max-width: 85%; }
        .comment-bubble { background: #334155; padding: 8px 12px; border-radius: var(--radius-md); margin-bottom: 2px; }
        .comment-author { font-size: 11px; font-weight: 800; color: white; margin-bottom: 2px; display: flex; align-items: center; gap: 5px; }
        .comment-text { font-size: 13px; color: #cbd5e1; word-break: break-word; }
        .comment-actions { display: flex; gap: var(--spacing-md); font-size: 10px; font-weight: 700; color: #94a3b8; padding-left: 5px; }
        .cmt-action-btn { background: none; border: none; padding: 0; color: #94a3b8; font-size: 10px; font-weight: 700; cursor: pointer; }
        .cmt-action-btn:hover { color: white; }
        
        .comment-input-area { padding: var(--spacing-sm); background: #1e293b; display: flex; flex-direction: column; gap: var(--spacing-sm); border-top: 1px solid rgba(255,255,255,0.05); padding-bottom: calc(10px + env(safe-area-inset-bottom)); }
        .comment-input-row { display: flex; gap: var(--spacing-sm); }
        .comment-input { flex: 1; background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.1); padding: var(--spacing-sm) 15px; border-radius: var(--radius-xl); color: white; outline: none; }
        
        .comment-preview-box { display: none; background: rgba(0,0,0,0.2); border: 1px solid var(--glass-border); border-radius: var(--radius-md); padding: var(--spacing-sm) 15px; margin-top: 5px; }
        .comment-preview-label { font-size: 9px; font-weight: 700; color: #94a3b8; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 5px; }
        .comment-preview-content { display: flex; gap: var(--spacing-xs); align-items: flex-start; }
        .comment-preview-avatar { width: 24px; height: 24px; border-radius: 50%; object-fit: cover; border: 1px solid rgba(255,255,255,0.1); }
        .comment-preview-bubble { background: #334155; padding: 6px 10px; border-radius: var(--radius-sm); max-width: 100%; }
        .comment-preview-text { font-size: 12px; color: #cbd5e1; word-break: break-word; line-height: 1.4; }

        /* SHARE POST MODAL */
        .share-modal { 
            position: fixed; inset: auto; bottom: 0; left: 0; right: 0; height: auto; max-height: 60vh;
            background: #1e293b; z-index: 7000; display: none; flex-direction: column; 
            border-radius: var(--radius-xl) 20px 0 0; border-top: 1px solid rgba(255,255,255,0.1);
            animation: slideUpModal 0.3s cubic-bezier(0.16, 1, 0.3, 1);
            box-shadow: 0 -10px 50px rgba(0,0,0,0.5);
        }
        .share-modal-backdrop { position: fixed; inset: 0; background: rgba(0,0,0,0.7); z-index: 6999; display: none; backdrop-filter: blur(2px); }
        .share-header { padding: var(--spacing-md); background: #1e293b; border-bottom: 1px solid rgba(255,255,255,0.1); display: flex; justify-content: space-between; align-items: center; border-radius: var(--radius-xl) 20px 0 0; }
        .share-content { padding: var(--spacing-lg) 20px calc(20px + env(safe-area-inset-bottom)) 20px; display: flex; flex-direction: column; gap: var(--spacing-md); }
        .share-btn-option { background: rgba(59, 130, 246, 0.1); border: 1px solid rgba(59, 130, 246, 0.3); color: white; padding: var(--spacing-md); border-radius: var(--radius-md); font-weight: 700; cursor: pointer; transition: 0.2s; display: flex; align-items: center; gap: var(--spacing-sm); }
        .share-btn-option:hover { background: rgba(59, 130, 246, 0.2); transform: translateY(-2px); }
        .share-post-preview { background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.1); padding: var(--spacing-sm); border-radius: var(--radius-md); margin-bottom: var(--spacing-sm); }
        .share-post-preview-author { font-size: 12px; font-weight: 700; color: #cbd5e1; margin-bottom: 5px; }
        .share-post-preview-content { font-size: 11px; color: #94a3b8; overflow: hidden; text-overflow: ellipsis; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; }

        .image-preview-container { 
            display: none; 
            position: relative; 
            margin: var(--spacing-md) 0;
            border-radius: var(--radius-lg);
            overflow: hidden;
            animation: fadeIn 0.3s ease;
        }
        .image-preview-img { 
            max-height: 250px; 
            width: 100%;
            object-fit: cover;
            border-radius: var(--radius-lg);
            border: 1px solid rgba(59, 130, 246, 0.2);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }
        .btn-remove-img { 
            position: absolute; 
            top: 8px; 
            right: 8px; 
            background: rgba(239, 68, 68, 0.95);
            backdrop-filter: blur(10px);
            color: white; 
            border-radius: 50%; 
            width: 32px; 
            height: 32px; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            cursor: pointer; 
            border: 2px solid rgba(255, 255, 255, 0.3);
            font-size: 14px;
            transition: all 0.2s ease;
        }
        .btn-remove-img:hover {
            background: rgba(220, 38, 38, 1);
            transform: scale(1.1) rotate(90deg);
        }
        .btn-remove-img:active {
            transform: scale(0.95);
        }

        /* EDIT PROFILE MODAL */
        .edit-input { width: 100%; background: #334155; border: 1px solid rgba(255,255,255,0.1); padding: var(--spacing-sm); border-radius: var(--radius-md); color: white; margin-bottom: var(--spacing-md); outline: none; }
        .edit-label { font-size: 11px; color: #94a3b8; margin-bottom: 5px; display: block; font-weight: 700; text-transform: uppercase; }

        /* SEARCH MODAL */
        .search-modal-container { position: fixed; inset: 0; background: #0f172a; z-index: 7000; display: none; flex-direction: column; }
        .search-header { padding: var(--spacing-md); background: #1e293b; display: flex; gap: var(--spacing-sm); align-items: center; border-bottom: 1px solid rgba(255,255,255,0.1); }
        .search-bar-wrap { flex: 1; background: rgba(0,0,0,0.3); border-radius: var(--radius-xl); padding: 8px 15px; display: flex; align-items: center; gap: var(--spacing-xs); border: 1px solid rgba(255,255,255,0.1); }
        .search-input { background: none; border: none; color: white; outline: none; width: 100%; font-size: 14px; }
        .search-results { flex: 1; overflow-y: auto; padding: var(--spacing-md); }
        .search-res-item { display: flex; align-items: center; gap: var(--spacing-sm); padding: var(--spacing-sm); border-bottom: 1px solid rgba(255,255,255,0.05); cursor: pointer; }
        .search-res-img { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; }

        /* VIEW TOGGLING */
        #view-home, #view-bingo { display: none; animation: fadeIn 0.3s ease; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* REACTION VIEWER MODAL */
        .reaction-viewer-modal {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            height: 60vh;
            background: #1e293b;
            z-index: 8000;
            display: none;
            flex-direction: column;
            border-radius: var(--radius-xl) 20px 0 0;
            border-top: 1px solid rgba(255,255,255,0.1);
            animation: slideUpModal 0.3s cubic-bezier(0.16, 1, 0.3, 1);
            box-shadow: 0 -10px 50px rgba(0,0,0,0.5);
        }
        .reaction-viewer-backdrop {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.7);
            z-index: 7999;
            display: none;
            backdrop-filter: blur(2px);
        }
        .reaction-viewer-header {
            padding: var(--spacing-md);
            background: #1e293b;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-radius: var(--radius-xl) 20px 0 0;
        }
        .reaction-viewer-list {
            flex: 1;
            overflow-y: auto;
            padding: var(--spacing-md);
            display: flex;
            flex-direction: column;
            gap: var(--spacing-sm);
        }
        .reaction-viewer-item {
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
            padding: var(--spacing-sm);
            background: rgba(0,0,0,0.2);
            border-radius: var(--radius-md);
            cursor: pointer;
            transition: background 0.2s;
        }
        .reaction-viewer-item:hover {
            background: rgba(255,255,255,0.05);
        }
        .reaction-viewer-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid rgba(255,255,255,0.1);
        }
        .reaction-viewer-info {
            flex: 1;
        }
        .reaction-viewer-name {
            font-size: 13px;
            font-weight: 700;
            color: white;
        }
        .reaction-viewer-emoji {
            font-size: 20px;
        }

        /* === REACTION SUMMARY BAR (Twitter/FB Style) === */
        .reaction-summary-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 20px;
            font-size: 12px;
            color: rgba(255, 255, 255, 0.5);
            cursor: pointer;
            transition: all 0.2s ease;
            font-weight: 500;
        }
        .reaction-summary-bar:hover {
            background: rgba(255, 255, 255, 0.03);
        }
        .reaction-summary-bar:empty { display: none; }
        
        .reaction-emojis-group {
            display: flex;
            align-items: center;
            margin-right: 3px;
        }
        .reaction-emojis-group span {
            font-size: 16px;
            line-height: 1;
            width: 22px;
            height: 22px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            background: rgba(30, 41, 59, 0.95);
            border-radius: 50%;
            border: 1.5px solid rgba(15, 23, 42, 0.9);
            margin-left: -6px;
            transition: transform 0.2s ease;
        }
        .reaction-emojis-group span:first-child {
            margin-left: 0;
            z-index: 3;
        }
        .reaction-emojis-group span:nth-child(2) {
            z-index: 2;
        }
        .reaction-emojis-group span:nth-child(3) {
            z-index: 1;
        }
        .reaction-emojis-group:hover span {
            margin-left: 2px;
        }
        .reaction-emojis-group:hover span:first-child {
            margin-left: 0;
        }
        .reaction-count-text {
            margin-left: 8px;
            font-size: 12px;
            color: rgba(255, 255, 255, 0.5);
            font-weight: 500;
        }
        .comment-count-text {
            font-size: 12px;
            color: rgba(255, 255, 255, 0.5);
            font-weight: 500;
        }
        
        .reaction-summary-item {
            display: none; /* Hide old individual count items */
        }

        /* === PEOPLE YOU MAY KNOW (PYMK) === */
        /* === PYMK SECTION - Facebook-Inspired Design === */
        .pymk-section { margin-bottom: var(--spacing-lg); }
        .pymk-title { padding: 0 var(--spacing-sm); margin-bottom: var(--spacing-md); font-size: 15px; font-weight: 900; color: white; display: flex; align-items: center; gap: 8px; }
        .pymk-title i { color: var(--accent); }
        .pymk-scroll { display: flex; gap: var(--spacing-md); overflow-x: auto; padding: 0 var(--spacing-sm) 10px; scrollbar-width: none; }
        .pymk-scroll::-webkit-scrollbar { display: none; }
        
        /* Facebook-style card with cover and avatar */
        .pymk-card { 
            background: rgba(30, 41, 59, 0.6);
            border: 1px solid rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            min-width: 180px; 
            width: 180px; 
            border-radius: var(--radius-lg); 
            display: flex; 
            flex-direction: column; 
            position: relative;
            overflow: hidden;
            transition: all 0.3s ease;
        }
        .pymk-card:hover {
            transform: translateY(-4px);
            border-color: rgba(14, 165, 233, 0.3);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.3);
        }
        
        /* Cover photo area */
        .pymk-cover {
            height: 70px;
            background: linear-gradient(135deg, rgba(14, 165, 233, 0.4), rgba(56, 189, 248, 0.2));
            position: relative;
        }
        
        /* Avatar positioned over cover */
        .pymk-avatar-container {
            position: absolute;
            top: 35px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 2;
        }
        .pymk-img { 
            width: 70px; 
            height: 70px; 
            border-radius: 50%; 
            object-fit: cover; 
            border: 3px solid rgba(30, 41, 59, 0.9);
            background: #1e293b;
        }
        
        /* Card content */
        .pymk-content {
            padding: 45px var(--spacing-sm) var(--spacing-md);
            text-align: center;
            display: flex;
            flex-direction: column;
            gap: var(--spacing-xs);
        }
        .pymk-name { 
            font-size: 14px; 
            font-weight: 700; 
            color: white; 
            overflow: hidden; 
            text-overflow: ellipsis; 
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            line-height: 1.3;
            min-height: 36px;
        }
        .pymk-mutual {
            font-size: 11px;
            color: rgba(255, 255, 255, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 4px;
        }
        .pymk-mutual i {
            width: 12px;
            height: 12px;
            color: var(--accent);
        }
        .btn-add-friend-sm { background: rgba(14, 165, 233, 0.2); color: var(--accent-glow); border: 1px solid var(--accent); padding: 6px 12px; border-radius: var(--radius-xl); font-size: 11px; font-weight: 800; cursor: pointer; width: 100%; }
        .btn-add-friend-sm:hover { background: var(--accent); color: white; }

        /* === GLOBAL HORIZONTAL BUTTON GROUP === */
        .btn-group-horizontal {
            display: flex;
            gap: var(--spacing-sm);
            width: 100%;
            justify-content: center;
            flex-wrap: wrap;
        }
        .btn-group-horizontal > * {
            flex: 1;
            min-width: 0;
            white-space: nowrap;
        }

        /* === PROFILE BUTTON GROUP === */
        .profile-btn-group {
            display: flex;
            gap: var(--spacing-sm);
            width: 100%;
            max-width: 360px;
            margin-bottom: var(--spacing-md);
            justify-content: center;
            flex-wrap: wrap;
        }
        .profile-btn-group .profile-action-btn,
        .profile-btn-group .btn-unfriend-modern {
            flex: 1;
            min-width: 0;
            max-width: none;
            width: auto;
            margin-bottom: 0;
            padding: var(--spacing-sm) 16px;
            font-size: 12px;
            white-space: nowrap;
        }

        /* MOBILE SPECIFIC OPTIMIZATIONS */
        @media (max-width: 480px) {
            /* === POST CREATOR MOBILE === */
            .post-creator-modern {
                border-radius: 16px;
                margin-bottom: 16px;
            }
            
            .post-creator-header {
                padding: 16px 16px 0 16px;
                gap: 12px;
            }
            
            .post-creator-avatar {
                width: 40px;
                height: 40px;
                border-width: 2px;
            }
            
            .post-input-modern {
                font-size: 15px;
                min-height: 60px;
            }
            
            .image-preview-container {
                margin: 12px 16px;
                border-radius: 12px;
            }
            
            .image-preview-container img {
                max-height: 300px;
            }
            
            .btn-remove-img {
                width: 32px;
                height: 32px;
                top: 10px;
                right: 10px;
            }
            .btn-remove-img i {
                width: 16px;
                height: 16px;
            }
            
            .post-tools {
                padding: 12px 16px 16px 16px;
                flex-wrap: nowrap;
                gap: 8px;
                align-items: center;
            }
            
            .post-actions-left {
                gap: 6px;
                flex-shrink: 1;
            }
            
            .tool-btn {
                width: 36px;
                height: 36px;
                padding: 6px;
                flex-shrink: 0;
            }
            .tool-btn i {
                width: 20px;
                height: 20px;
            }
            
            .btn-post-modern {
                padding: 9px 20px;
                font-size: 14px;
                border-radius: 20px;
                min-width: 75px;
                flex-shrink: 0;
                white-space: nowrap;
            }
            
            /* === POST CARD MOBILE === */
            .post-card {
                border-radius: 16px;
                margin-bottom: 16px;
            }
            
            .post-header {
                padding: 14px 16px;
                gap: 10px;
            }
            
            .post-avatar {
                width: 40px;
                height: 40px;
                border-width: 2px;
            }
            
            .post-author {
                font-size: 14px;
                gap: 5px;
            }
            
            .add-friend-icon-btn {
                width: 22px;
                height: 22px;
                border-width: 1.5px;
            }
            .add-friend-icon-btn i {
                width: 12px;
                height: 12px;
            }
            
            .verified-badge i {
                width: 9px !important;
                height: 9px !important;
            }
            
            .post-time {
                font-size: 11px;
                gap: 4px;
                margin-top: 2px;
            }
            
            .visibility-badge i {
                width: 10px;
                height: 10px;
            }
            
            .mood-display {
                font-size: 10px;
                padding: 2px 8px;
                border-radius: 10px;
                margin-top: 3px;
            }
            
            .post-content {
                padding: 0 16px 14px 16px;
                font-size: 14px;
                line-height: 1.5;
                word-break: break-word;
                overflow-wrap: break-word;
            }
            
            .post-image-container {
                max-height: 350px;
            }
            
            .post-image {
                max-height: 350px;
            }
            
            /* === REACTION SUMMARY MOBILE === */
            .reaction-summary-bar {
                padding: 8px 16px;
                font-size: 11px;
            }
            
            .reaction-emojis-group span {
                font-size: 14px;
                width: 20px;
                height: 20px;
                margin-left: -5px;
                border-width: 1.5px;
            }
            .reaction-emojis-group span:first-child {
                margin-left: 0;
            }
            
            .reaction-count-text {
                margin-left: 6px;
                font-size: 11px;
            }
            
            .comment-count-text {
                font-size: 11px;
            }
            
            /* === POST ACTIONS MOBILE === */
            .post-actions {
                padding: 4px 6px;
            }
            
            .action-btn {
                padding: 8px 10px;
                font-size: 12px;
                gap: 6px;
                border-radius: 6px;
                margin: 0 1px;
            }
            
            .action-btn i {
                width: 13px !important;
                height: 13px !important;
            }
            
            .reaction-popup {
                bottom: 45px;
                gap: 8px;
                padding: 8px 12px;
            }
            
            .reaction-emoji {
                font-size: 22px;
                width: 36px;
                height: 36px;
            }
            
            .post-overflow-btn {
                padding: 6px;
            }
            .post-overflow-btn i {
                width: 16px !important;
                height: 16px !important;
            }
            
            /* === SHARED POSTS MOBILE === */
            .shared-post-container {
                margin: 0 16px 14px 16px;
                padding: 12px;
                font-size: 12px;
            }
            
            .shared-post-container img {
                width: 28px !important;
                height: 28px !important;
            }
            
            .shared-post-container .post-image {
                max-height: 250px;
            }
            
            /* === PROFILE & OTHER ELEMENTS === */
            .profile-avatar-container .avatar-frame { width: 100px !important; height: 100px !important; }
            .profile-page-name { font-size: 24px; }
            .profile-cover { height: 22vh; min-height: 160px; }
            .profile-info-section { margin-top: -50px; }
            .profile-stats-card { padding: var(--spacing-sm) 10px; }
            .stat-val { font-size: 18px; }
            .stat-lbl { font-size: 10px; }
            .profile-action-btn, .btn-unfriend-modern { 
                max-width: 100%; 
                padding: var(--spacing-sm) 24px; 
                font-size: 13px;
            }
            .profile-btn-group { max-width: 100%; }
            .profile-btn-group .profile-action-btn,
            .profile-btn-group .btn-unfriend-modern {
                padding: var(--spacing-sm) 12px;
                font-size: 11px;
            }
            .app-logo-lg { font-size: 40px; }
            .modal-content { max-height: 85vh; width: 95%; }
            .container { padding-bottom: 70px; }
            
            /* === STORE MOBILE === */
            .store-header {
                padding: 16px;
            }
            
            .store-header-top {
                margin-bottom: 12px;
            }
            
            .store-back-btn {
                width: 36px;
                height: 36px;
            }
            .store-back-btn i {
                width: 18px;
                height: 18px;
            }
            
            .store-title-section h3 {
                font-size: 20px;
            }
            
            .store-title-section p {
                font-size: 11px;
            }
            
            .store-nav {
                gap: 6px;
                padding: 5px;
            }
            
            .store-tab-btn {
                padding: 10px;
                font-size: 11px;
            }
            
            .store-body {
                padding: 16px;
            }
            
            .reward-item {
                padding: 14px;
            }
            
            .reward-icon-box {
                width: 40px;
                height: 40px;
            }
            
            .reward-info b {
                font-size: 14px;
            }
            
            .reward-info small {
                font-size: 11px;
            }
            
            .btn-redeem {
                padding: 10px 16px;
                font-size: 12px;
            }
        }
        
        /* === EXTRA SMALL MOBILE (iPhone SE, etc) === */
        @media (max-width: 375px) {
            .post-creator-header {
                padding: 14px 14px 0 14px;
            }
            
            .post-creator-avatar {
                width: 38px;
                height: 38px;
                min-width: 38px;
                min-height: 38px;
            }
            
            .post-input-modern {
                font-size: 14px;
            }
            
            .post-tools {
                padding: 10px 14px 14px 14px;
            }
            
            .tool-btn {
                min-width: 36px;
                min-height: 36px;
            }
            
            .btn-post-modern {
                padding: 8px 18px;
                font-size: 13px;
                min-width: 70px;
                min-height: 36px;
            }
            
            .post-header {
                padding: 12px 14px;
            }
            
            .post-avatar {
                width: 38px;
                height: 38px;
                min-width: 38px;
                min-height: 38px;
            }
            
            .post-author {
                font-size: 13px;
            }
            
            .add-friend-icon-btn {
                min-width: 22px;
                min-height: 22px;
            }
            
            .post-time {
                font-size: 10px;
            }
            
            .post-content {
                padding: 0 14px 12px 14px;
                font-size: 13px;
            }
            
            .reaction-summary-bar {
                padding: 7px 14px;
                min-height: 36px;
            }
            
            .reaction-emojis-group span {
                font-size: 13px;
                width: 18px;
                height: 18px;
                min-width: 18px;
                min-height: 18px;
                margin-left: -4px;
            }
            
            .reaction-count-text,
            .comment-count-text {
                font-size: 10px;
            }
            
            .action-btn {
                padding: 7px 8px;
                font-size: 11px;
                gap: 5px;
                min-height: 36px;
            }
            
            .action-btn i {
                width: 12px !important;
                height: 12px !important;
            }
            
            .post-overflow-btn {
                min-width: 32px;
                min-height: 32px;
            }
            
            /* === SHARED POSTS EXTRA SMALL === */
            .shared-post-container {
                margin: 0 14px 12px 14px;
                padding: 10px;
                font-size: 11px;
            }
            
            .shared-post-container img {
                width: 26px !important;
                height: 26px !important;
            }
            
            /* === STORE EXTRA SMALL === */
            .store-header {
                padding: 14px;
            }
            
            .store-back-btn {
                width: 34px;
                height: 34px;
            }
            .store-back-btn i {
                width: 16px;
                height: 16px;
            }
            
            .store-title-section h3 {
                font-size: 18px;
            }
            
            .store-body {
                padding: 14px;
            }
        }
        
        /* === MOBILE TOUCH IMPROVEMENTS === */
        @media (hover: none) and (pointer: coarse) {
            /* Ensure all interactive elements are touch-friendly */
            .tool-btn,
            .action-btn,
            .add-friend-icon-btn,
            .post-overflow-btn,
            .btn-post-modern {
                cursor: pointer;
                -webkit-user-select: none;
                user-select: none;
            }
            
            /* Smoother tap feedback */
            .tool-btn:active,
            .action-btn:active,
            .add-friend-icon-btn:active {
                transform: scale(0.92);
                transition: transform 0.1s ease;
            }
            
            /* Better visibility for reactions on touch */
            .reaction-popup {
                padding: 10px 14px;
                gap: 10px;
            }
            
            .reaction-emoji {
                min-width: 40px;
                min-height: 40px;
            }
        }
        
        /* === LANDSCAPE MOBILE === */
        @media (max-width: 812px) and (orientation: landscape) {
            .post-creator-modern,
            .post-card {
                margin-bottom: 12px;
            }
            
            .post-creator-header,
            .post-header {
                padding-top: 12px;
                padding-bottom: 8px;
            }
            
            .image-preview-container img,
            .post-image {
                max-height: 200px;
            }
        }
        
        /* ===================================== */
        /* CONTENT CREATOR STYLES */
        /* ===================================== */
        
        .creator-badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            background: linear-gradient(135deg, #f59e0b, #d97706);
            padding: 3px 10px;
            border-radius: 12px;
            font-size: 9px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            box-shadow: 0 2px 8px rgba(245, 158, 11, 0.5);
            color: white;
        }
        
        .creator-badge i {
            width: 12px;
            height: 12px;
        }
        
        .creator-profile-header {
            background: linear-gradient(135deg, rgba(245, 158, 11, 0.2), rgba(217, 119, 6, 0.1));
            border: 2px solid rgba(245, 158, 11, 0.3);
        }
        
        .follow-btn {
            background: linear-gradient(135deg, #f59e0b, #d97706);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            font-weight: 700;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.3s;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .follow-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(245, 158, 11, 0.5);
        }
        
        .follow-btn.following {
            background: rgba(245, 158, 11, 0.2);
            border: 2px solid #f59e0b;
            color: #f59e0b;
        }
        
        .follower-count {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            font-weight: 700;
            color: #f59e0b;
        }
        
        .points-multiplier-badge {
            background: linear-gradient(135deg, #10b981, #059669);
            padding: 4px 10px;
            border-radius: 8px;
            font-size: 10px;
            font-weight: 700;
            display: inline-block;
            box-shadow: 0 2px 8px rgba(16, 185, 129, 0.4);
            margin-top: 8px;
        }
        
        .creator-post {
            border-left: 3px solid #f59e0b !important;
            background: linear-gradient(135deg, rgba(245, 158, 11, 0.05), rgba(0, 0, 0, 0.1));
        }
        
        /* Enhanced Creator Profile Styles */
        .creator-profile-enhanced {
            position: relative;
            overflow: visible;
        }
        
        .creator-glow-border {
            position: absolute;
            inset: -2px;
            background: linear-gradient(135deg, #f59e0b, #d97706, #f59e0b);
            background-size: 200% 200%;
            border-radius: inherit;
            z-index: -1;
            animation: gradientShift 3s ease infinite;
            opacity: 0.5;
        }
        
        .creator-action-buttons {
            display: flex;
            gap: var(--spacing-sm);
            margin-top: var(--spacing-md);
        }
        
        .creator-action-btn {
            flex: 1;
            padding: var(--spacing-sm) var(--spacing-md);
            border: none;
            border-radius: var(--radius-md);
            font-weight: 700;
            font-size: 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .creator-action-btn.message-btn {
            background: linear-gradient(135deg, var(--accent), var(--accent-glow));
            color: white;
            box-shadow: 0 4px 15px rgba(14, 165, 233, 0.3);
        }
        
        .creator-action-btn.message-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(14, 165, 233, 0.4);
        }
        
        .creator-action-btn.share-btn {
            background: rgba(255, 255, 255, 0.1);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .creator-action-btn.share-btn:hover {
            background: rgba(255, 255, 255, 0.15);
        }
        
        .creator-stats-mini {
            display: flex;
            justify-content: space-around;
            margin-top: var(--spacing-md);
            padding-top: var(--spacing-md);
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .creator-stat-mini {
            text-align: center;
        }
        
        .creator-stat-mini-value {
            display: block;
            font-size: 16px;
            font-weight: 900;
            color: #f59e0b;
            text-shadow: 0 0 10px rgba(245, 158, 11, 0.3);
        }
        
        .creator-stat-mini-label {
            display: block;
            font-size: 9px;
            color: rgba(255, 255, 255, 0.6);
            margin-top: 2px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        /* ==========================================
           DAILY LOGIN STREAK STYLES
        ========================================== */
        .streak-modal-overlay {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.85);
            z-index: 99998;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(10px);
        }
        .streak-modal-overlay.active { display: flex; }
        .streak-modal {
            background: linear-gradient(135deg, #1e293b, #0f172a);
            border: 1px solid rgba(251, 191, 36, 0.3);
            border-radius: 24px;
            padding: 32px 24px;
            max-width: 340px;
            width: 90%;
            text-align: center;
            position: relative;
            box-shadow: 0 0 60px rgba(251,191,36,0.2);
            animation: popScale 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        .streak-flame {
            font-size: 72px;
            line-height: 1;
            margin-bottom: 8px;
            filter: drop-shadow(0 0 20px rgba(251,191,36,0.8));
            animation: flamePulse 1.5s ease-in-out infinite;
        }
        @keyframes flamePulse {
            0%,100% { transform: scale(1); }
            50% { transform: scale(1.1) rotate(-3deg); }
        }
        .streak-number {
            font-size: 64px;
            font-weight: 900;
            background: linear-gradient(135deg, #fbbf24, #f59e0b, #ef4444);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            line-height: 1;
        }
        .streak-label {
            font-size: 14px;
            color: rgba(255,255,255,0.6);
            text-transform: uppercase;
            letter-spacing: 2px;
            margin: 4px 0 20px;
        }
        .streak-reward-box {
            background: rgba(251,191,36,0.1);
            border: 1px solid rgba(251,191,36,0.3);
            border-radius: 12px;
            padding: 16px;
            margin: 16px 0;
        }
        .streak-reward-coins {
            font-size: 32px;
            font-weight: 900;
            color: #fbbf24;
        }
        .streak-days-row {
            display: flex;
            justify-content: center;
            gap: 6px;
            margin: 16px 0;
        }
        .streak-day-dot {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.1);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            font-weight: 700;
            color: rgba(255,255,255,0.4);
            flex-direction: column;
            gap: 2px;
        }
        .streak-day-dot.completed {
            background: linear-gradient(135deg, #f59e0b, #ef4444);
            border-color: transparent;
            color: white;
        }
        .streak-day-dot.today {
            background: rgba(251,191,36,0.2);
            border: 2px solid #fbbf24;
            color: #fbbf24;
            box-shadow: 0 0 12px rgba(251,191,36,0.4);
        }
        .streak-claim-btn {
            width: 100%;
            padding: 16px;
            background: linear-gradient(135deg, #f59e0b, #d97706);
            border: none;
            border-radius: 12px;
            color: white;
            font-size: 16px;
            font-weight: 900;
            cursor: pointer;
            letter-spacing: 1px;
            text-transform: uppercase;
            box-shadow: 0 4px 20px rgba(245,158,11,0.4);
            transition: all 0.3s;
        }
        .streak-claim-btn:hover { transform: translateY(-2px); box-shadow: 0 8px 30px rgba(245,158,11,0.5); }

        /* Streak widget in home feed */
        .streak-home-widget {
            background: linear-gradient(135deg, rgba(245,158,11,0.15), rgba(239,68,68,0.1));
            border: 1px solid rgba(245,158,11,0.3);
            border-radius: 16px;
            padding: 16px;
            margin: 12px 0;
            display: flex;
            align-items: center;
            gap: 12px;
            cursor: pointer;
            transition: all 0.3s;
        }
        .streak-home-widget:hover { transform: translateY(-2px); }

        /* ==========================================
           LEADERBOARD STYLES
        ========================================== */
        .leaderboard-page {
            display: none;
            position: fixed;
            inset: 0;
            background: #0f172a;
            z-index: 8000;
            flex-direction: column;
            overflow: hidden;
        }
        .leaderboard-page.active { display: flex; }
        .leaderboard-header {
            background: linear-gradient(135deg, rgba(15,23,42,0.98), rgba(30,41,59,0.95));
            border-bottom: 1px solid rgba(255,255,255,0.1);
            padding: 16px;
            padding-top: max(16px, env(safe-area-inset-top));
            display: flex;
            align-items: center;
            gap: 12px;
            flex-shrink: 0;
        }
        .leaderboard-body {
            overflow-y: auto;
            flex: 1;
            padding-bottom: 20px;
        }
        .lb-tabs {
            display: flex;
            gap: 8px;
            padding: 12px 16px;
            background: rgba(15,23,42,0.8);
            border-bottom: 1px solid rgba(255,255,255,0.05);
            overflow-x: auto;
            flex-shrink: 0;
        }
        .lb-tab {
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 700;
            border: 1px solid rgba(255,255,255,0.15);
            background: none;
            color: rgba(255,255,255,0.6);
            cursor: pointer;
            white-space: nowrap;
            transition: all 0.2s;
        }
        .lb-tab.active {
            background: linear-gradient(135deg, #fbbf24, #f59e0b);
            border-color: transparent;
            color: white;
        }
        .lb-podium {
            display: flex;
            justify-content: center;
            align-items: flex-end;
            gap: 8px;
            padding: 20px 16px 0;
            margin-bottom: 8px;
        }
        .podium-slot {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 6px;
        }
        .podium-slot:nth-child(1) { order: 2; }
        .podium-slot:nth-child(2) { order: 1; }
        .podium-slot:nth-child(3) { order: 3; }
        .podium-avatar {
            border-radius: 50%;
            object-fit: cover;
            border: 3px solid #94a3b8;
        }
        .podium-slot:nth-child(1) .podium-avatar {
            border-color: #fbbf24;
            width: 70px; height: 70px;
            box-shadow: 0 0 20px rgba(251,191,36,0.5);
        }
        .podium-slot:nth-child(2) .podium-avatar {
            border-color: #fbbf24;
            width: 80px; height: 80px;
            box-shadow: 0 0 30px rgba(251,191,36,0.6);
        }
        .podium-slot:nth-child(3) .podium-avatar {
            border-color: #9ca3af;
            width: 60px; height: 60px;
        }
        .podium-crown { font-size: 24px; }
        .podium-name { font-size: 10px; font-weight: 700; color: white; text-align: center; max-width: 80px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .podium-val { font-size: 11px; font-weight: 700; color: #fbbf24; }
        .podium-base {
            border-radius: 8px 8px 0 0;
            width: 80px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            font-weight: 900;
        }
        .podium-slot:nth-child(2) .podium-base { background: linear-gradient(135deg, #fbbf24, #f59e0b); height: 60px; }
        .podium-slot:nth-child(1) .podium-base { background: linear-gradient(135deg, #94a3b8, #64748b); height: 40px; }
        .podium-slot:nth-child(3) .podium-base { background: linear-gradient(135deg, #92400e, #78350f); height: 30px; }
        .lb-list { padding: 0 16px; }
        .lb-row {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            border-radius: 12px;
            margin-bottom: 8px;
            background: rgba(30,41,59,0.5);
            border: 1px solid rgba(255,255,255,0.05);
            transition: all 0.2s;
            cursor: pointer;
        }
        .lb-row.is-me { border-color: rgba(14,165,233,0.4); background: rgba(14,165,233,0.1); }
        .lb-rank { font-size: 16px; font-weight: 900; color: rgba(255,255,255,0.4); width: 28px; text-align: center; flex-shrink: 0; }
        .lb-avatar { width: 44px; height: 44px; border-radius: 50%; object-fit: cover; flex-shrink: 0; }
        .lb-info { flex: 1; min-width: 0; }
        .lb-username { font-size: 14px; font-weight: 700; color: white; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .lb-sub { font-size: 11px; color: rgba(255,255,255,0.4); }
        .lb-score { font-size: 16px; font-weight: 900; color: #fbbf24; flex-shrink: 0; }
        .lb-my-rank {
            margin: 0 16px 16px;
            padding: 12px 16px;
            background: linear-gradient(135deg, rgba(14,165,233,0.2), rgba(14,165,233,0.05));
            border: 1px solid rgba(14,165,233,0.4);
            border-radius: 12px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        /* ==========================================
           TOURNAMENT STYLES
        ========================================== */
        .tournament-page {
            display: none;
            position: fixed;
            inset: 0;
            background: #0f172a;
            z-index: 8000;
            flex-direction: column;
            overflow: hidden;
        }
        .tournament-page.active { display: flex; }
        .tournament-header {
            background: linear-gradient(135deg, rgba(15,23,42,0.98), rgba(30,41,59,0.95));
            border-bottom: 1px solid rgba(255,255,255,0.1);
            padding: 16px;
            padding-top: max(16px, env(safe-area-inset-top));
            display: flex;
            align-items: center;
            gap: 12px;
            flex-shrink: 0;
        }
        .tournament-body { overflow-y: auto; flex: 1; padding: 16px; }
        .tourn-card {
            background: linear-gradient(135deg, rgba(30,41,59,0.8), rgba(15,23,42,0.6));
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 20px;
            padding: 20px;
            margin-bottom: 16px;
            position: relative;
            overflow: hidden;
            transition: all 0.3s;
        }
        .tourn-card::before {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0;
            height: 3px;
            background: linear-gradient(90deg, #fbbf24, #f59e0b, #ef4444);
        }
        .tourn-card.active-tourn::before { animation: gradientShift 2s ease infinite; background-size: 200% 200%; }
        .tourn-badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 10px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 8px;
        }
        .tourn-badge.upcoming { background: rgba(14,165,233,0.2); border: 1px solid rgba(14,165,233,0.4); color: #38bdf8; }
        .tourn-badge.live { background: rgba(239,68,68,0.2); border: 1px solid rgba(239,68,68,0.4); color: #f87171; animation: pulse-ring 1.5s infinite; }
        .tourn-badge.finished { background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); color: rgba(255,255,255,0.4); }
        .tourn-name { font-size: 20px; font-weight: 900; color: white; margin-bottom: 4px; }
        .tourn-prize-box {
            background: linear-gradient(135deg, rgba(251,191,36,0.2), rgba(245,158,11,0.1));
            border: 1px solid rgba(251,191,36,0.3);
            border-radius: 12px;
            padding: 12px 16px;
            margin: 12px 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .tourn-prize-amount { font-size: 28px; font-weight: 900; color: #fbbf24; }
        .tourn-info-row {
            display: flex;
            gap: 12px;
            margin-bottom: 12px;
            flex-wrap: wrap;
        }
        .tourn-info-chip {
            display: flex;
            align-items: center;
            gap: 4px;
            background: rgba(255,255,255,0.05);
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 11px;
            color: rgba(255,255,255,0.7);
        }
        .tourn-register-btn {
            width: 100%;
            padding: 14px;
            background: linear-gradient(135deg, #f59e0b, #d97706);
            border: none;
            border-radius: 12px;
            color: white;
            font-size: 14px;
            font-weight: 900;
            cursor: pointer;
            letter-spacing: 1px;
            text-transform: uppercase;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        .tourn-register-btn:disabled {
            background: rgba(255,255,255,0.1);
            color: rgba(255,255,255,0.4);
            cursor: not-allowed;
        }
        .tourn-register-btn.registered {
            background: linear-gradient(135deg, #10b981, #059669);
            box-shadow: 0 4px 15px rgba(16,185,129,0.3);
        }
        .tourn-participants {
            display: flex;
            align-items: center;
            gap: -8px;
            margin-top: 8px;
        }
        .tourn-participant-avatar {
            width: 28px; height: 28px;
            border-radius: 50%;
            border: 2px solid #0f172a;
            object-fit: cover;
            margin-left: -8px;
        }
        .tourn-participant-avatar:first-child { margin-left: 0; }
        .tourn-empty {
            text-align: center;
            padding: 60px 20px;
            opacity: 0.5;
        }
        .tourn-timer {
            font-size: 28px;
            font-weight: 900;
            color: #fbbf24;
            text-align: center;
            margin: 8px 0;
            font-variant-numeric: tabular-nums;
        }
        .tourn-tab-nav {
            display: flex;
            gap: 8px;
            margin-bottom: 16px;
        }
        .tourn-tab-btn {
            flex: 1;
            padding: 10px;
            border-radius: 10px;
            font-size: 12px;
            font-weight: 700;
            border: 1px solid rgba(255,255,255,0.1);
            background: rgba(255,255,255,0.05);
            color: rgba(255,255,255,0.5);
            cursor: pointer;
            transition: all 0.2s;
        }
        .tourn-tab-btn.active {
            background: linear-gradient(135deg, #fbbf24, #f59e0b);
            border-color: transparent;
            color: white;
        }
        /* Bingo tab quick-action buttons */
        .bingo-quick-actions {
            display: flex;
            gap: 10px;
            padding: 12px 16px;
            overflow-x: auto;
        }
        .bingo-quick-btn {
            flex-shrink: 0;
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 16px;
            border-radius: 12px;
            border: 1px solid rgba(255,255,255,0.1);
            background: rgba(30,41,59,0.6);
            color: white;
            font-size: 12px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s;
            backdrop-filter: blur(10px);
        }
        .bingo-quick-btn.gold { border-color: rgba(251,191,36,0.3); background: rgba(251,191,36,0.1); color: #fbbf24; }
        .bingo-quick-btn.blue { border-color: rgba(14,165,233,0.3); background: rgba(14,165,233,0.1); color: #38bdf8; }
        /* ============================================
            BENTO CARD GRID SYSTEM
        ============================================ */

        /* The wrapper that holds all cards + buy button */
        .bento-cards-wrapper { margin-bottom: var(--spacing-lg); }

        /* Default: single card, full width  no bento yet */
        .bento-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 10px;
            transition: all 0.4s ease;
        }

        /* 2 cards: 2 equal columns */
        .bento-grid.cards-2 {
            grid-template-columns: 1fr 1fr;
        }
        /* 3 cards: all equal 2-col */
        .bento-grid.cards-3 {
            grid-template-columns: 1fr 1fr;
        }
        /* 4 cards: 2x2 grid */
        .bento-grid.cards-4 {
            grid-template-columns: 1fr 1fr;
        }
        /* 5 cards: all equal 2x2 */
        .bento-grid.cards-5 {
            grid-template-columns: 1fr 1fr;
        }

        /* Each slot */
        .bento-slot { position: relative; }

        /* Card inside bento  inherits .card styles but with size adaptation */
        .bento-slot .card {
            margin-bottom: 0;
            height: 100%;
        }

        /* When in multi-card mode, shrink fonts */
        .bento-grid.cards-2 .cell,
        .bento-grid.cards-3 .cell,
        .bento-grid.cards-4 .cell,
        .bento-grid.cards-5 .cell { font-size: 11px !important; border-radius: 6px !important; }

        .bento-grid.cards-2 .letter,
        .bento-grid.cards-3 .letter,
        .bento-grid.cards-4 .letter,
        .bento-grid.cards-5 .letter { font-size: 15px !important; }

        .bento-grid.cards-2 .bingo-header,
        .bento-grid.cards-3 .bingo-header,
        .bento-grid.cards-4 .bingo-header,
        .bento-grid.cards-5 .bingo-header { gap: 2px !important; margin-bottom: 3px !important; }

        .bento-grid.cards-2 .grid,
        .bento-grid.cards-3 .grid,
        .bento-grid.cards-4 .grid,
        .bento-grid.cards-5 .grid { gap: 2px !important; }

        .bento-grid.cards-2 .card,
        .bento-grid.cards-3 .card,
        .bento-grid.cards-4 .card,
        .bento-grid.cards-5 .card { padding: 10px !important; }

        .bento-grid.cards-2 .change-card-wrapper,
        .bento-grid.cards-3 .change-card-wrapper,
        .bento-grid.cards-4 .change-card-wrapper,
        .bento-grid.cards-5 .change-card-wrapper { padding-bottom: 8px !important; }

        .bento-grid.cards-2 .pattern-text,
        .bento-grid.cards-3 .pattern-text,
        .bento-grid.cards-4 .pattern-text,
        .bento-grid.cards-5 .pattern-text { font-size: 9px !important; }

        .bento-grid.cards-2 .btn-change,
        .bento-grid.cards-3 .btn-change,
        .bento-grid.cards-4 .btn-change,
        .bento-grid.cards-5 .btn-change { font-size: 9px !important; padding: 3px 7px !important; }

        /* All cards equal size in multi-card layout */

        /* Card number badge */
        .card-num-badge {
            position: absolute;
            top: -7px; left: 10px;
            font-size: 9px; font-weight: 900;
            color: white; letter-spacing: 0.5px;
            background: linear-gradient(135deg, var(--accent), #2563eb);
            padding: 1px 7px; border-radius: 5px;
            z-index: 5; text-transform: uppercase;
        }
        .card-num-badge.extra { background: linear-gradient(135deg, #d97706, #f59e0b); }

        /* Buy button slot in bento grid */
        .bento-buy-slot {
            min-height: 120px;
            background: rgba(251,191,36,0.07);
            border: 2px dashed rgba(251,191,36,0.35);
            border-radius: var(--radius-xl);
            display: flex; flex-direction: column;
            align-items: center; justify-content: center;
            gap: 6px; cursor: pointer;
            transition: all 0.25s;
            color: #fbbf24; font-weight: 900;
            padding: 16px 10px;
            width: 100%;
        }
        .bento-buy-slot:hover:not(:disabled) { background: rgba(251,191,36,0.14); border-color: rgba(251,191,36,0.65); transform: scale(1.02); }
        .bento-buy-slot:disabled { opacity: 0.38; cursor: not-allowed; transform: none; }
        .bento-buy-slot .buy-icon { font-size: 22px; line-height: 1; }
        .bento-buy-slot .buy-label { font-size: 12px; text-align: center; line-height: 1.3; }
        .bento-buy-slot .buy-cost { font-size: 10px; opacity: 0.75; font-weight: 700; }

        /* Standalone buy button (before any extra card  shown below main card full-width) */
        .buy-extra-card-btn { width: 100%; padding: 14px; background: rgba(251,191,36,0.08); border: 2px dashed rgba(251,191,36,0.4); border-radius: var(--radius-xl); display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 6px; cursor: pointer; transition: all 0.3s; color: #fbbf24; font-weight: 900; font-size: 13px; }
        .buy-extra-card-btn:hover { background: rgba(251,191,36,0.14); border-color: rgba(251,191,36,0.7); }
        .buy-extra-card-btn:disabled { opacity: 0.4; cursor: not-allowed; }

        /* ============================================
            STORIES
        ============================================ */
        .stories-row{display:flex;gap:10px;padding:10px 16px;overflow-x:auto;scrollbar-width:none;-ms-overflow-style:none;margin-bottom:2px;}
        .stories-row::-webkit-scrollbar{display:none;}
        .story-item{display:flex;flex-direction:column;align-items:center;gap:5px;flex-shrink:0;cursor:pointer;}
        .story-ring{width:64px;height:64px;border-radius:50%;padding:3px;background:linear-gradient(135deg,#f59e0b,#ef4444,#8b5cf6,#0ea5e9);position:relative;transition:transform 0.2s;}
        .story-ring:active{transform:scale(0.95);}
        .story-ring.seen{background:rgba(255,255,255,0.15);}
        .story-ring.add-story{background:linear-gradient(135deg,var(--accent),#38bdf8);}
        .story-ring-inner{width:100%;height:100%;border-radius:50%;border:3px solid #0f172a;overflow:hidden;background:#1e293b;display:flex;align-items:center;justify-content:center;}
        .story-ring-inner img{width:100%;height:100%;object-fit:cover;}
        .story-add-plus{position:absolute;bottom:0;right:0;width:20px;height:20px;background:var(--accent);border-radius:50%;border:2px solid #0f172a;display:flex;align-items:center;justify-content:center;font-size:14px;font-weight:900;color:white;line-height:1;}
        .story-name{font-size:10px;color:rgba(255,255,255,0.7);max-width:64px;text-align:center;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;font-weight:600;}
        /* Story Viewer */
        .story-viewer{display:none;position:fixed;inset:0;background:#000;z-index:99999;flex-direction:column;}
        .story-viewer.active{display:flex;}
        .story-viewer-bg{position:absolute;inset:0;background-size:cover;background-position:center;filter:blur(25px) brightness(0.3);transform:scale(1.1);}
        .story-viewer-content{position:relative;z-index:1;flex:1;display:flex;flex-direction:column;max-width:480px;margin:0 auto;width:100%;}
        .story-progress-bars{display:flex;gap:4px;padding:12px 12px 8px;padding-top:max(14px,env(safe-area-inset-top));}
        .story-prog-bar{flex:1;height:3px;background:rgba(255,255,255,0.3);border-radius:3px;overflow:hidden;}
        .story-prog-fill{height:100%;background:white;width:0%;transition:width 0.15s linear;}
        .story-prog-fill.done{width:100%;transition:none;}
        .story-hdr{display:flex;align-items:center;gap:10px;padding:6px 14px;}
        .story-av{width:36px;height:36px;border-radius:50%;object-fit:cover;border:2px solid white;}
        .story-close{margin-left:auto;background:none;border:none;color:white;font-size:26px;cursor:pointer;line-height:1;padding:2px 6px;}
        .story-media-area{flex:1;display:flex;align-items:center;justify-content:center;padding:8px 14px;position:relative;}
        .story-media-area img,.story-media-area video{max-width:100%;max-height:68vh;border-radius:14px;object-fit:contain;}
        .story-text-over{position:absolute;bottom:16px;left:50%;transform:translateX(-50%);background:rgba(0,0,0,0.7);color:white;padding:10px 18px;border-radius:20px;font-size:15px;font-weight:700;text-align:center;max-width:80%;word-break:break-word;backdrop-filter:blur(10px);}
        .story-pure-text{font-size:22px;font-weight:900;color:white;text-align:center;padding:40px 24px;text-shadow:0 2px 8px rgba(0,0,0,0.8);word-break:break-word;line-height:1.4;}
        .story-tap-zones{position:absolute;inset:0;display:flex;pointer-events:none;}
        .story-tap-l,.story-tap-r{flex:1;pointer-events:all;cursor:pointer;}
        .story-footer{padding:12px 16px;padding-bottom:max(16px,env(safe-area-inset-bottom));display:flex;align-items:center;gap:10px;}
        .story-reply-inp{flex:1;background:rgba(255,255,255,0.15);border:1px solid rgba(255,255,255,0.3);border-radius:24px;padding:10px 16px;color:white;font-size:14px;outline:none;backdrop-filter:blur(10px);}
        .story-reply-inp::placeholder{color:rgba(255,255,255,0.5);}
        /* Story Creator */
        .story-creator-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.92);z-index:99998;flex-direction:column;align-items:center;justify-content:center;padding:20px;}
        .story-creator-overlay.active{display:flex;}
        .story-creator-box{background:#1e293b;border-radius:24px;padding:24px;width:100%;max-width:380px;border:1px solid rgba(255,255,255,0.1);}
        .story-type-tabs{display:flex;gap:8px;margin-bottom:16px;}
        .story-type-tab{flex:1;padding:10px;border-radius:10px;border:1px solid rgba(255,255,255,0.15);background:none;color:rgba(255,255,255,0.5);font-size:12px;font-weight:700;cursor:pointer;transition:all 0.2s;}
        .story-type-tab.active{background:linear-gradient(135deg,var(--accent),#38bdf8);border-color:transparent;color:white;}
        .story-bg-opts{display:flex;gap:8px;margin:12px 0;flex-wrap:wrap;}
        .story-bg-sw{width:36px;height:36px;border-radius:8px;cursor:pointer;border:3px solid transparent;transition:all 0.2s;}
        .story-bg-sw.sel{border-color:white;transform:scale(1.1);}

        /* ============================================
            POLLS
        ============================================ */
        .poll-card{background:rgba(14,165,233,0.07);border:1px solid rgba(14,165,233,0.2);border-radius:14px;padding:14px;margin-top:10px;}
        .poll-question{font-size:15px;font-weight:800;color:white;margin-bottom:12px;line-height:1.4;}
        .poll-option{position:relative;margin-bottom:8px;border-radius:10px;overflow:hidden;cursor:pointer;transition:transform 0.15s;}
        .poll-option:active{transform:scale(0.98);}
        .poll-opt-bg{position:absolute;top:0;left:0;bottom:0;background:linear-gradient(135deg,rgba(14,165,233,0.35),rgba(56,189,248,0.2));transition:width 0.6s ease;border-radius:10px;}
        .poll-opt-lbl{position:relative;padding:11px 14px;font-size:13px;font-weight:700;color:white;display:flex;justify-content:space-between;align-items:center;border:1px solid rgba(255,255,255,0.1);border-radius:10px;background:rgba(255,255,255,0.04);}
        .poll-option.my-vote .poll-opt-lbl{border-color:var(--accent);}
        .poll-option.winner-opt .poll-opt-bg{background:linear-gradient(135deg,rgba(16,185,129,0.4),rgba(52,211,153,0.2));}
        .poll-option.winner-opt .poll-opt-lbl{border-color:var(--success);}
        .poll-pct{font-size:12px;font-weight:900;color:var(--accent);}
        .poll-total-votes{font-size:10px;color:rgba(255,255,255,0.4);margin-top:8px;text-align:right;}
        .poll-check{color:var(--accent);font-size:14px;}
        /* Poll creator */
        .poll-creator-box{background:rgba(14,165,233,0.07);border:1px dashed rgba(14,165,233,0.3);border-radius:12px;padding:14px;margin-top:10px;display:none;}
        .poll-creator-box.open{display:block;}
        .poll-opt-row{display:flex;align-items:center;gap:8px;margin-bottom:8px;}
        .poll-opt-row input{flex:1;background:rgba(255,255,255,0.06);border:1px solid rgba(255,255,255,0.15);border-radius:8px;padding:10px 12px;color:white;font-size:13px;outline:none;}
        .poll-opt-row input::placeholder{color:rgba(255,255,255,0.35);}
        .poll-rem-btn{background:none;border:none;color:rgba(255,255,255,0.4);cursor:pointer;font-size:18px;padding:4px;}
        .poll-add-btn{background:none;border:1px dashed rgba(14,165,233,0.4);color:var(--accent);border-radius:8px;padding:8px 12px;font-size:12px;font-weight:700;cursor:pointer;width:100%;margin-top:4px;transition:all 0.2s;}
        .poll-add-btn:hover{background:rgba(14,165,233,0.1);}

        /* ============================================
            BOOKMARKS
        ============================================ */
        .bookmarks-page{display:none;position:fixed;inset:0;background:#0f172a;z-index:8000;flex-direction:column;overflow:hidden;}
        .bookmarks-page.active{display:flex;}
        .bookmarks-hdr{background:rgba(15,23,42,0.98);border-bottom:1px solid rgba(255,255,255,0.08);padding:16px;padding-top:max(16px,env(safe-area-inset-top));display:flex;align-items:center;gap:12px;flex-shrink:0;backdrop-filter:blur(20px);}
        .bookmarks-body{overflow-y:auto;flex:1;padding:12px 0 80px;}
        .bookmark-btn{background:none;border:none;color:rgba(255,255,255,0.4);cursor:pointer;padding:4px;display:flex;align-items:center;transition:all 0.2s;}
        .bookmark-btn.bk-saved{color:var(--gold);}
        .bookmark-btn.bk-saved i{fill:var(--gold);}
        .bookmarks-empty{text-align:center;padding:60px 20px;opacity:0.5;}

        /* ============================================
           # HASHTAGS & @MENTIONS
        ============================================ */
        .hashtag{color:var(--accent);font-weight:700;cursor:pointer;}
        .hashtag:hover{text-decoration:underline;}
        .mention{color:#a78bfa;font-weight:700;cursor:pointer;}
        .mention:hover{text-decoration:underline;}
        .hashtag-explorer{display:none;position:fixed;inset:0;background:#0f172a;z-index:8500;flex-direction:column;overflow:hidden;}
        .hashtag-explorer.active{display:flex;}
        .hashtag-explorer-hdr{background:rgba(15,23,42,0.98);border-bottom:1px solid rgba(255,255,255,0.08);padding:16px;padding-top:max(16px,env(safe-area-inset-top));display:flex;align-items:center;gap:12px;flex-shrink:0;}
        .hashtag-explorer-body{overflow-y:auto;flex:1;padding:12px 0 80px;}
        .trending-tags-row{padding:12px 16px 0;display:flex;flex-wrap:wrap;}
        .tag-chip{display:inline-flex;align-items:center;gap:5px;padding:8px 14px;background:rgba(14,165,233,0.1);border:1px solid rgba(14,165,233,0.2);border-radius:20px;font-size:13px;font-weight:700;color:var(--accent);margin:4px;cursor:pointer;transition:all 0.2s;}
        .tag-chip:hover{background:rgba(14,165,233,0.2);transform:translateY(-1px);}
        .tag-count{font-size:10px;color:rgba(255,255,255,0.4);font-weight:600;}
        .autocomplete-drop{position:absolute;background:#1e293b;border:1px solid rgba(255,255,255,0.1);border-radius:12px;max-height:180px;overflow-y:auto;z-index:9999;box-shadow:0 8px 30px rgba(0,0,0,0.5);min-width:190px;}
        .ac-item{padding:10px 14px;cursor:pointer;font-size:13px;font-weight:700;display:flex;align-items:center;gap:8px;transition:background 0.15s;}
        .ac-item:hover{background:rgba(255,255,255,0.06);}

        /* Post interaction buttons on creator profiles */
        .post-quick-actions {
            display: flex;
            gap: 8px;
            margin-top: var(--spacing-sm);
            padding-top: var(--spacing-sm);
            border-top: 1px solid rgba(255, 255, 255, 0.05);
        }
        
        .post-quick-action-btn {
            flex: 1;
            padding: 8px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: var(--radius-sm);
            color: rgba(255, 255, 255, 0.7);
            font-size: 11px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 4px;
            transition: all 0.2s ease;
        }
        
        .post-quick-action-btn:hover {
            background: rgba(255, 255, 255, 0.1);
            color: white;
        }
        
        .post-quick-action-btn.liked {
            color: var(--danger);
            background: rgba(239, 68, 68, 0.1);
            border-color: var(--danger);
        }
        
        <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-9712694598388252"
     crossorigin="anonymous"></script>

        /* ===== RB COIN TOAST ===== */
        @keyframes rbCoinPop{from{transform:translateX(-50%) translateY(16px) scale(.8);opacity:0}to{transform:translateX(-50%) translateY(0) scale(1);opacity:1}}

        /* ===== CAMERA ===== */
        /* cam-page styles removed - camera feature replaced by store */

        /* ===== MESSENGER  MOBILE FIRST (FB Messenger Style) ===== */

        /* Modal base */
        .pm-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            width: 100%;
            height: 100vh;
            height: 100svh; /* small viewport - accounts for browser chrome */
            height: 100dvh; /* dynamic viewport - shrinks when keyboard opens (iOS 16+, Android) */
            background: #07091a;
            z-index: 7000;
            display: none;
            flex-direction: column;
            overflow: hidden;
        }

        /*  INBOX HEADER  */
        .pm-inboxhdr {
            flex-shrink: 0;
            padding: max(env(safe-area-inset-top), 14px) 14px 10px;
            display: flex;
            align-items: center;
            gap: 10px;
            background: #07091a;
            border-bottom: 1px solid rgba(255,255,255,.06);
            min-height: 60px;
        }
        .pm-inboxhdr-title {
            font-size: 22px;
            font-weight: 900;
            color: #fff;
            letter-spacing: -0.5px;
            flex: 1;
        }
        .pm-hdrbtn {
            background: rgba(255,255,255,.08);
            border: none;
            color: #fff;
            width: 38px;
            height: 38px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            flex-shrink: 0;
            transition: background 0.15s;
        }
        .pm-hdrbtn:active { background: rgba(255,255,255,.16); }

        /*  SEARCH BAR  */
        .pm-searchwrap {
            padding: 8px 14px 6px;
            background: #07091a;
        }
        .pm-searchinput {
            width: 100%;
            background: rgba(255,255,255,.07);
            border: 1px solid rgba(255,255,255,.09);
            border-radius: 24px;
            padding: 10px 16px 10px 38px;
            color: #fff;
            font-size: 14px;
            outline: none;
            font-family: inherit;
            box-sizing: border-box;
        }
        .pm-searchinput::placeholder { color: rgba(255,255,255,.35); }
        .pm-searchwrap-inner {
            position: relative;
        }
        .pm-searchwrap-inner::before {
            content: '';
            position: absolute;
            left: 12px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 13px;
            pointer-events: none;
        }

        /*  ACTIVE FRIENDS STORIES BAR  */
        .pm-activebar {
            display: flex;
            gap: 0;
            padding: 10px 10px 8px;
            overflow-x: auto;
            scrollbar-width: none;
            border-bottom: 1px solid rgba(255,255,255,.05);
            background: #07091a;
        }
        .pm-activebar::-webkit-scrollbar { display: none; }
        .pm-activelabel {
            font-size: 11px;
            color: rgba(255,255,255,.4);
            font-weight: 700;
            align-self: center;
            white-space: nowrap;
            flex-shrink: 0;
            padding: 0 6px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .pm-afitem {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
            cursor: pointer;
            flex-shrink: 0;
            padding: 0 7px;
            transition: transform 0.15s;
        }
        .pm-afitem:active { transform: scale(0.93); }
        .pm-afring {
            width: 54px;
            height: 54px;
            border-radius: 50%;
            border: 2.5px solid #22c55e;
            padding: 2px;
            position: relative;
            background: #0d1226;
        }
        .pm-afring img {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            object-fit: cover;
        }
        .pm-afdot {
            position: absolute;
            bottom: 1px;
            right: 1px;
            width: 13px;
            height: 13px;
            background: #22c55e;
            border: 2.5px solid #07091a;
            border-radius: 50%;
        }
        .pm-afname {
            font-size: 10px;
            color: rgba(255,255,255,.55);
            font-weight: 700;
            max-width: 56px;
            text-align: center;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        /*  INBOX LIST  */
        .pm-inbox-list {
            flex: 1;
            overflow-y: auto;
            background: #07091a;
            -webkit-overflow-scrolling: touch;
        }
        .pm-inbox-list::-webkit-scrollbar { display: none; }
        .pm-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 10px 14px;
            cursor: pointer;
            transition: background 0.15s;
            border-bottom: 1px solid rgba(255,255,255,.04);
            position: relative;
        }
        .pm-item:active { background: rgba(255,255,255,.05); }
        .pm-avatar {
            width: 56px;
            height: 56px;
            border-radius: 50%;
            object-fit: cover;
            flex-shrink: 0;
            border: 1.5px solid rgba(255,255,255,.08);
        }
        .pm-info {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 3px;
            min-width: 0;
        }
        .pm-name {
            font-size: 15px;
            font-weight: 700;
            color: #fff;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .pm-preview {
            font-size: 13px;
            color: rgba(255,255,255,.4);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .pm-item-time {
            font-size: 11px;
            color: rgba(255,255,255,.3);
            white-space: nowrap;
            flex-shrink: 0;
            align-self: flex-start;
            padding-top: 4px;
        }
        .pm-item .unread-dot {
            width: 10px;
            height: 10px;
            background: var(--accent);
            border-radius: 50%;
            position: absolute;
            right: 14px;
            bottom: 18px;
            box-shadow: 0 0 6px rgba(14,165,233,.6);
        }

        /*  EMPTY / LOADING STATES  */
        .pm-empty-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 60px 20px;
            gap: 12px;
            color: rgba(255,255,255,.35);
            font-size: 14px;
            font-weight: 500;
        }
        .pm-empty-icon {
            font-size: 48px;
            margin-bottom: 4px;
        }
        /* Skeleton loading shimmer */
        .pm-skeleton {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 10px 14px;
            border-bottom: 1px solid rgba(255,255,255,.04);
        }
        .pm-skel-avatar {
            width: 56px;
            height: 56px;
            border-radius: 50%;
            background: linear-gradient(90deg, rgba(255,255,255,.05) 25%, rgba(255,255,255,.1) 50%, rgba(255,255,255,.05) 75%);
            background-size: 200% 100%;
            animation: pmShimmer 1.4s ease-in-out infinite;
            flex-shrink: 0;
        }
        .pm-skel-info { flex: 1; display: flex; flex-direction: column; gap: 8px; }
        .pm-skel-line {
            height: 12px;
            border-radius: 6px;
            background: linear-gradient(90deg, rgba(255,255,255,.05) 25%, rgba(255,255,255,.1) 50%, rgba(255,255,255,.05) 75%);
            background-size: 200% 100%;
            animation: pmShimmer 1.4s ease-in-out infinite;
        }
        .pm-skel-line:nth-child(1) { width: 55%; }
        .pm-skel-line:nth-child(2) { width: 75%; }
        @keyframes pmShimmer {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }

        /*  CHAT HEADER  */
        .pm-chathdr {
            flex-shrink: 0;
            padding: max(env(safe-area-inset-top), 10px) 12px 10px;
            display: flex;
            align-items: center;
            gap: 10px;
            background: #07091a;
            border-bottom: 1px solid rgba(255,255,255,.07);
            min-height: 60px;
        }
        .pm-chatname {
            font-size: 16px;
            font-weight: 800;
            color: #fff;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .pm-chatstatus {
            font-size: 11px;
            color: rgba(255,255,255,.4);
        }
        .pm-chatstatus.online { color: #22c55e; }

        /*  MESSAGE AREA  */
        .pm-msgarea {
            flex: 1;
            min-height: 0; /* critical  prevents flex children from overflowing */
            overflow-y: auto;
            padding: 12px 10px;
            display: flex;
            flex-direction: column;
            gap: 2px;
            background: #07091a;
            -webkit-overflow-scrolling: touch;
            overscroll-behavior: contain;
        }
        .pm-msgarea::-webkit-scrollbar { width: 3px; }
        .pm-msgarea::-webkit-scrollbar-thumb { background: rgba(255,255,255,.1); border-radius: 2px; }

        /* Message wrappers */
        .pm-mwrap {
            display: flex;
            flex-direction: column;
            max-width: 78%;
            gap: 2px;
        }
        .pm-mwrap.me {
            align-self: flex-end;
            align-items: flex-end;
        }
        .pm-mwrap.them {
            align-self: flex-start;
            align-items: flex-start;
        }
        .pm-mrow {
            display: flex;
            align-items: flex-end;
            gap: 6px;
        }
        .pm-mrow.me { flex-direction: row-reverse; }
        .pm-mrow-avatar {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            object-fit: cover;
            flex-shrink: 0;
            border: 1px solid rgba(255,255,255,.1);
        }

        /* Bubbles */
        .pm-bbl {
            padding: 10px 14px;
            border-radius: 20px;
            font-size: 14.5px;
            line-height: 1.5;
            word-break: break-word;
            position: relative;
        }
        .pm-bbl.me {
            background: linear-gradient(135deg, var(--accent), #3b82f6);
            color: #fff;
            border-bottom-right-radius: 5px;
        }
        .pm-bbl.them {
            background: #1c2540;
            color: #e2e8f0;
            border-bottom-left-radius: 5px;
        }
        .pm-bbl.stk {
            background: transparent;
            padding: 0;
            font-size: 52px;
            line-height: 1;
        }

        /* Message meta */
        .pm-mtime {
            font-size: 10px;
            color: rgba(255,255,255,.28);
            margin-top: 2px;
            padding: 0 4px;
        }
        .pm-mseen {
            font-size: 10px;
            color: var(--accent);
            margin-top: 2px;
            padding: 0 4px;
        }

        /* Typing indicator */
        .pm-typing2 {
            display: none;
            align-self: flex-start;
            background: #1c2540;
            border-radius: 20px;
            border-bottom-left-radius: 5px;
            padding: 12px 18px;
            gap: 5px;
            align-items: center;
            margin-bottom: 4px;
        }
        .pm-typing2.on { display: flex; }
        .tdot2 {
            width: 7px;
            height: 7px;
            background: rgba(255,255,255,.45);
            border-radius: 50%;
            animation: tbounce2 1.2s ease-in-out infinite;
        }
        .tdot2:nth-child(2) { animation-delay: .2s; }
        .tdot2:nth-child(3) { animation-delay: .4s; }
        @keyframes tbounce2 {
            0%, 80%, 100% { transform: translateY(0); }
            40% { transform: translateY(-6px); }
        }

        /*  FOOTER  */
        .pm-footer2 {
            flex-shrink: 0; /* never compress the footer */
            padding: 8px 10px;
            padding-bottom: max(env(safe-area-inset-bottom), 10px);
            background: #07091a;
            border-top: 1px solid rgba(255,255,255,.07);
        }
        .pm-inputrow {
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .pm-newinput {
            flex: 1;
            background: #1c2540;
            border: 1.5px solid rgba(255,255,255,.1);
            border-radius: 24px;
            padding: 11px 18px;
            color: #fff;
            font-size: 14px;
            outline: none;
            font-family: inherit;
            min-height: 44px;
            max-height: 120px;
            transition: border-color 0.2s;
        }
        .pm-newinput:focus {
            border-color: rgba(14,165,233,.5);
        }
        .pm-newinput::placeholder { color: rgba(255,255,255,.3); }
        .pm-iconbtn2 {
            background: #1c2540;
            border: none;
            color: rgba(255,255,255,.6);
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            flex-shrink: 0;
            font-size: 19px;
            transition: background 0.15s, transform 0.1s;
        }
        .pm-iconbtn2:active { background: rgba(255,255,255,.15); transform: scale(0.9); }
        .pm-sendbtn2 {
            background: linear-gradient(135deg, var(--accent), #3b82f6);
            color: #fff;
            border: none;
            width: 42px;
            height: 42px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            flex-shrink: 0;
            box-shadow: 0 4px 14px rgba(14,165,233,.4);
            transition: transform 0.1s, box-shadow 0.15s;
        }
        .pm-sendbtn2:active { transform: scale(0.9); box-shadow: none; }

        /* Tight screens  shrink icon buttons so send is never cut off */
        @media (max-width: 360px) {
            .pm-iconbtn2 { width: 34px; height: 34px; }
            .pm-newinput { padding: 10px 12px; font-size: 13px; }
            .pm-sendbtn2 { width: 38px; height: 38px; }
            .pm-inputrow { gap: 4px; }
        }

        /*  PANELS (Emoji / Sticker)  */
        .pm-panel2 {
            display: none;
            flex-wrap: wrap;
            gap: 6px;
            padding: 10px 10px 6px;
            background: #0d1226;
            border-top: 1px solid rgba(255,255,255,.06);
            max-height: 160px;
            overflow-y: auto;
        }
        .pm-panel2.open { display: flex; }
        .pm-emj {
            font-size: 28px;
            cursor: pointer;
            line-height: 1;
            padding: 4px;
            border-radius: 8px;
            transition: background 0.15s;
        }
        .pm-emj:active { background: rgba(255,255,255,.1); }
        .pm-stk {
            font-size: 38px;
            cursor: pointer;
            line-height: 1;
            padding: 6px;
            border-radius: 10px;
            transition: transform 0.15s;
        }
        .pm-stk:active { transform: scale(1.2); }

        /* Voice recording */
        .pm-voiceon {
            background: linear-gradient(135deg, #ef4444, #dc2626) !important;
            color: #fff !important;
            animation: vpulse2 1s ease-in-out infinite;
        }
        @keyframes vpulse2 {
            0%, 100% { box-shadow: 0 0 0 0 rgba(239,68,68,.5); }
            50% { box-shadow: 0 0 0 8px rgba(239,68,68,0); }
        }

        /* Image strip */
        .pm-imgstrip2 { display: none; padding: 8px 10px 0; background: #07091a; }
        .pm-imgstrip2.on { display: flex; align-items: center; gap: 8px; }
        .pm-imgstrip2 img { width: 60px; height: 60px; border-radius: 12px; object-fit: cover; border: 1.5px solid rgba(255,255,255,.12); }

        /* Day divider */
        .pm-day-divider {
            text-align: center;
            font-size: 11px;
            color: rgba(255,255,255,.3);
            font-weight: 600;
            margin: 10px 0 6px;
            position: relative;
        }
        .pm-day-divider::before, .pm-day-divider::after {
            content: '';
            position: absolute;
            top: 50%;
            width: 28%;
            height: 1px;
            background: rgba(255,255,255,.07);
        }
        .pm-day-divider::before { left: 0; }
        .pm-day-divider::after { right: 0; }

        /* Heart reaction */
        .msg-heart-reaction {
            position: absolute;
            bottom: -8px;
            right: -5px;
            background: #1c2540;
            border: 1px solid #334155;
            border-radius: 10px;
            padding: 2px 5px;
            font-size: 11px;
            display: flex;
            align-items: center;
            gap: 2px;
            box-shadow: 0 2px 6px rgba(0,0,0,.4);
            animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        /* ===== RB STORE PAGE ===== */
        .rbstore-page {
            display: none;
            position: fixed;
            inset: 0;
            background: #0a0f1e;
            z-index: 9500;
            flex-direction: column;
            overflow: hidden;
        }
        .rbstore-page.active { display: flex; }

        .rbstore-header {
            background: linear-gradient(135deg, rgba(15,23,42,0.98), rgba(30,41,59,0.95));
            border-bottom: 1px solid rgba(255,255,255,0.08);
            padding: max(env(safe-area-inset-top),16px) 16px 0;
            flex-shrink: 0;
        }
        .rbstore-toprow {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 14px;
        }
        .rbstore-title {
            font-size: 22px;
            font-weight: 900;
            background: linear-gradient(135deg, #f59e0b, #ec4899);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            letter-spacing: 1px;
        }
        .rbstore-coins-badge {
            display: flex;
            align-items: center;
            gap: 7px;
            background: linear-gradient(135deg, rgba(251,191,36,0.2), rgba(245,158,11,0.1));
            border: 1px solid rgba(251,191,36,0.4);
            border-radius: 30px;
            padding: 8px 16px;
            font-size: 15px;
            font-weight: 900;
            color: #fbbf24;
        }
        .rbstore-back-btn {
            background: rgba(255,255,255,0.08);
            border: none;
            color: white;
            width: 38px;
            height: 38px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
        }
        .rbstore-tabs {
            display: flex;
            gap: 6px;
            overflow-x: auto;
            scrollbar-width: none;
            padding-bottom: 0;
        }
        .rbstore-tabs::-webkit-scrollbar { display: none; }
        .rbstore-tab {
            flex-shrink: 0;
            padding: 9px 18px;
            border: none;
            border-bottom: 3px solid transparent;
            background: none;
            color: rgba(255,255,255,0.4);
            font-size: 13px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s;
            letter-spacing: 0.5px;
        }
        .rbstore-tab.active {
            color: #f59e0b;
            border-bottom-color: #f59e0b;
        }

        .rbstore-body {
            flex: 1;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            padding: 20px 16px 30px;
        }

        /* Gift Card Grid */
        .giftcard-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 14px;
            margin-bottom: 24px;
        }
        .giftcard-item {
            position: relative;
            border-radius: 18px;
            overflow: hidden;
            cursor: pointer;
            transition: transform 0.25s cubic-bezier(0.4,0,0.2,1), box-shadow 0.25s;
            border: 1px solid rgba(255,255,255,0.08);
        }
        .giftcard-item:active { transform: scale(0.96); }
        .giftcard-inner {
            padding: 18px 14px 14px;
            display: flex;
            flex-direction: column;
            gap: 6px;
        }
        .giftcard-logo {
            font-size: 28px;
            margin-bottom: 6px;
            overflow: hidden;
        }
        .giftcard-logo svg { display: block; max-width: 100%; height: auto; }
        .giftcard-brand {
            font-size: 12px;
            font-weight: 900;
            color: white;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        .giftcard-value {
            font-size: 22px;
            font-weight: 900;
            color: white;
            text-shadow: 0 2px 8px rgba(0,0,0,0.4);
        }
        .giftcard-cost {
            display: flex;
            align-items: center;
            gap: 5px;
            background: rgba(0,0,0,0.3);
            border-radius: 20px;
            padding: 4px 10px;
            font-size: 11px;
            font-weight: 800;
            color: #fbbf24;
            width: fit-content;
            margin-top: 4px;
        }
        .giftcard-btn {
            width: 100%;
            margin-top: 10px;
            padding: 10px;
            border: none;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 900;
            cursor: pointer;
            letter-spacing: 0.5px;
            text-transform: uppercase;
            transition: all 0.2s;
        }
        .giftcard-btn.can-redeem {
            background: linear-gradient(135deg, #f59e0b, #ec4899);
            color: white;
            box-shadow: 0 4px 12px rgba(245,158,11,0.4);
        }
        .giftcard-btn.cant-redeem {
            background: rgba(255,255,255,0.08);
            color: rgba(255,255,255,0.35);
            cursor: not-allowed;
        }
        .giftcard-badge {
            background: rgba(0,0,0,0.35);
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 6px;
            padding: 2px 8px;
            font-size: 9px;
            font-weight: 800;
            color: white;
            text-transform: uppercase;
            letter-spacing: 1px;
            white-space: nowrap;
        }

        /* QR Gift Card Modal */
        .qr-modal-backdrop {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.85);
            z-index: 99000;
            backdrop-filter: blur(10px);
            align-items: center;
            justify-content: center;
        }
        .qr-modal-backdrop.show { display: flex; }
        .qr-modal-card {
            background: linear-gradient(145deg, #1e293b, #0f172a);
            border-radius: 28px;
            border: 1px solid rgba(255,255,255,0.12);
            padding: 28px 24px;
            max-width: 340px;
            width: 90%;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 16px;
            position: relative;
            box-shadow: 0 30px 80px rgba(0,0,0,0.8), 0 0 0 1px rgba(255,255,255,0.05);
            animation: qrCardPop 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        @keyframes qrCardPop {
            0% { transform: scale(0.7); opacity: 0; }
            100% { transform: scale(1); opacity: 1; }
        }
        .qr-giftcard-visual {
            width: 100%;
            border-radius: 20px;
            padding: 20px;
            text-align: center;
            position: relative;
            overflow: hidden;
        }
        .qr-giftcard-visual::before {
            content: '';
            position: absolute;
            inset: 0;
            background: rgba(255,255,255,0.05);
            border-radius: 20px;
        }
        .qr-card-title {
            font-size: 13px;
            font-weight: 900;
            color: rgba(255,255,255,0.7);
            text-transform: uppercase;
            letter-spacing: 2px;
            margin-bottom: 4px;
        }
        .qr-card-amount {
            font-size: 40px;
            font-weight: 900;
            color: white;
            text-shadow: 0 2px 10px rgba(0,0,0,0.5);
        }
        .qr-card-brand {
            font-size: 12px;
            color: rgba(255,255,255,0.6);
            margin-top: 4px;
            font-weight: 700;
        }
        .qr-code-box {
            background: white;
            border-radius: 16px;
            padding: 14px;
            width: 180px;
            height: 180px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }
        .qr-code-box canvas {
            width: 152px !important;
            height: 152px !important;
        }
        .qr-card-code {
            font-size: 16px;
            font-weight: 900;
            color: #fbbf24;
            letter-spacing: 3px;
            font-variant-numeric: tabular-nums;
            background: rgba(251,191,36,0.1);
            border: 1px solid rgba(251,191,36,0.3);
            border-radius: 10px;
            padding: 8px 20px;
        }
        .qr-expiry {
            font-size: 11px;
            color: rgba(255,255,255,0.4);
            font-weight: 600;
        }
        .qr-scan-hint {
            font-size: 12px;
            color: rgba(255,255,255,0.55);
            text-align: center;
            font-weight: 600;
        }
        .qr-close-btn {
            position: absolute;
            top: -14px;
            right: -14px;
            background: linear-gradient(135deg, #ef4444, #b91c1c);
            color: white;
            border: 2px solid white;
            border-radius: 50%;
            width: 34px;
            height: 34px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 18px;
            font-weight: 900;
            box-shadow: 0 4px 10px rgba(0,0,0,0.4);
        }
        .qr-partner-list {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            justify-content: center;
        }
        .qr-partner-chip {
            background: rgba(255,255,255,0.08);
            border: 1px solid rgba(255,255,255,0.12);
            border-radius: 20px;
            padding: 5px 12px;
            font-size: 11px;
            font-weight: 700;
            color: rgba(255,255,255,0.6);
        }

        /* Coins History Section */
        .coins-history-item {
            display: flex;
            align-items: center;
            gap: 14px;
            padding: 12px 0;
            border-bottom: 1px solid rgba(255,255,255,0.04);
        }
        .coins-hist-icon {
            width: 38px;
            height: 38px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            flex-shrink: 0;
        }
        .coins-hist-info { flex: 1; }
        .coins-hist-label { font-size: 13px; font-weight: 700; color: white; }
        .coins-hist-date { font-size: 11px; color: rgba(255,255,255,0.35); margin-top: 2px; }
        .coins-hist-amount { font-size: 15px; font-weight: 900; }
        .coins-hist-amount.earn { color: #10b981; }
        .coins-hist-amount.spend { color: #ef4444; }

        /* My Vouchers Section */
        .voucher-item {
            background: linear-gradient(135deg, rgba(30,41,59,0.9), rgba(15,23,42,0.8));
            border: 1px solid rgba(255,255,255,0.08);
            border-radius: 16px;
            padding: 16px;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 14px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .voucher-item:active { transform: scale(0.98); }
        .voucher-icon-box {
            width: 50px;
            height: 50px;
            border-radius: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            flex-shrink: 0;
        }
        .voucher-info { flex: 1; }
        .voucher-name { font-size: 14px; font-weight: 800; color: white; }
        .voucher-brand { font-size: 11px; color: rgba(255,255,255,0.4); margin-top: 2px; }
        .voucher-arrow { color: rgba(255,255,255,0.3); font-size: 20px; }

        /* === PARTNER STORE CHIP FILTERS === */
        .ps-chip {
            flex-shrink: 0;
            padding: 7px 14px;
            background: rgba(30,41,59,0.8);
            border: 1.5px solid rgba(255,255,255,0.1);
            border-radius: 50px;
            color: rgba(255,255,255,0.55);
            font-size: 12px;
            font-weight: 700;
            cursor: pointer;
            white-space: nowrap;
            transition: all 0.2s cubic-bezier(0.4,0,0.2,1);
            font-family: 'Inter', sans-serif;
        }
        .ps-chip:hover {
            background: rgba(14,165,233,0.15);
            border-color: rgba(14,165,233,0.4);
            color: white;
        }
        .ps-chip.active {
            background: linear-gradient(135deg, #0ea5e9, #6366f1);
            border-color: transparent;
            color: white;
            box-shadow: 0 4px 14px rgba(14,165,233,0.4);
        }
        #psCategoryChips::-webkit-scrollbar { display: none; }

        /* === PARTNER STORE CARD === */
        .ps-store-card {
            background: linear-gradient(145deg, rgba(30,41,59,0.95), rgba(15,23,42,0.95));
            border: 1px solid rgba(255,255,255,0.08);
            border-radius: 18px;
            padding: 16px;
            cursor: pointer;
            transition: all 0.25s cubic-bezier(0.4,0,0.2,1);
            position: relative;
            overflow: hidden;
        }
        .ps-store-card::before {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0;
            height: 2px;
            background: linear-gradient(90deg, var(--ps-c1, #0ea5e9), var(--ps-c2, #6366f1));
            opacity: 0.7;
        }
        .ps-store-card:hover {
            border-color: rgba(14,165,233,0.3);
            transform: translateY(-2px);
            box-shadow: 0 8px 28px rgba(0,0,0,0.4), 0 0 0 1px rgba(14,165,233,0.15);
        }
        .ps-store-card:active { transform: translateY(0); }
        .ps-store-icon {
            width: 52px; height: 52px;
            border-radius: 14px;
            display: flex; align-items: center; justify-content: center;
            font-size: 26px;
            flex-shrink: 0;
        }
        .ps-store-name {
            font-size: 15px;
            font-weight: 900;
            color: white;
            margin-bottom: 2px;
        }
        .ps-store-type-badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 2px 9px;
            border-radius: 20px;
            font-size: 10px;
            font-weight: 800;
            letter-spacing: 0.3px;
        }
        .ps-detail-row {
            display: flex;
            align-items: flex-start;
            gap: 8px;
            font-size: 11px;
            color: rgba(255,255,255,0.5);
            line-height: 1.5;
        }
        .ps-detail-row svg { flex-shrink: 0; margin-top: 1px; }
        .ps-voucher-btn {
            width: 100%;
            margin-top: 12px;
            padding: 10px;
            background: linear-gradient(135deg, rgba(14,165,233,0.15), rgba(99,102,241,0.15));
            border: 1px solid rgba(14,165,233,0.3);
            border-radius: 10px;
            color: #38bdf8;
            font-size: 12px;
            font-weight: 900;
            cursor: pointer;
            letter-spacing: 0.5px;
            font-family: 'Inter', sans-serif;
            transition: all 0.2s;
        }
        .ps-voucher-btn:hover {
            background: linear-gradient(135deg, rgba(14,165,233,0.3), rgba(99,102,241,0.3));
            box-shadow: 0 4px 14px rgba(14,165,233,0.2);
        }

        .section-label {
            font-size: 11px;
            font-weight: 900;
            color: rgba(255,255,255,0.35);
            text-transform: uppercase;
            letter-spacing: 1.5px;
            margin-bottom: 12px;
            margin-top: 4px;
        }

        /* === MY SHOP PRODUCT CARD === */
        .ms-product-card {
            background: linear-gradient(145deg,rgba(30,41,59,0.95),rgba(15,23,42,0.95));
            border: 1px solid rgba(255,255,255,0.08);
            border-radius: 16px;
            overflow: hidden;
            cursor: pointer;
            transition: all 0.25s cubic-bezier(0.4,0,0.2,1);
            position: relative;
            display: flex;
            flex-direction: column;
        }
        .ms-product-card:active { transform: scale(0.97); }
        .ms-product-img {
            width: 100%;
            aspect-ratio: 1/1;
            object-fit: cover;
            background: rgba(139,92,246,0.08);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 40px;
        }
        .ms-product-info { padding: 10px 12px 12px; flex: 1; display: flex; flex-direction: column; }
        .ms-product-name { font-size: 13px; font-weight: 800; color: white; margin-bottom: 3px; line-height: 1.3; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
        .ms-product-price { font-size: 14px; font-weight: 900; color: #fbbf24; margin-top: auto; padding-top: 6px; }
        .ms-product-stock { font-size: 10px; color: rgba(255,255,255,0.35); margin-top: 2px; }
        .ms-add-btn {
            width: 100%;
            padding: 9px;
            background: linear-gradient(135deg,#f472b6,#8b5cf6);
            border: none;
            border-radius: 0 0 14px 14px;
            color: white;
            font-size: 12px;
            font-weight: 900;
            cursor: pointer;
            letter-spacing: 0.5px;
            transition: all 0.2s;
        }
        .ms-add-btn:hover { filter: brightness(1.1); }
        .ms-add-btn:disabled { background: rgba(255,255,255,0.08); color: rgba(255,255,255,0.3); cursor: not-allowed; }
        .ms-sold-badge {
            position: absolute;
            top: 8px;
            right: 8px;
            background: rgba(239,68,68,0.85);
            color: white;
            font-size: 9px;
            font-weight: 900;
            padding: 2px 8px;
            border-radius: 20px;
            letter-spacing: 0.5px;
        }
        .ms-discount-badge {
            position: absolute;
            top: 8px;
            left: 8px;
            background: rgba(244,114,182,0.9);
            color: white;
            font-size: 9px;
            font-weight: 900;
            padding: 2px 8px;
            border-radius: 20px;
        }
        /* Cart item */
        .cart-item-row {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 0;
            border-bottom: 1px solid rgba(255,255,255,0.05);
        }
        .cart-item-emoji {
            width: 44px;
            height: 44px;
            background: rgba(139,92,246,0.1);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 22px;
            flex-shrink: 0;
        }
        .cart-item-img {
            width: 44px;
            height: 44px;
            border-radius: 10px;
            object-fit: cover;
            flex-shrink: 0;
        }
        .cart-qty-btn {
            width: 28px;
            height: 28px;
            background: rgba(255,255,255,0.08);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 8px;
            color: white;
            font-size: 16px;
            font-weight: 900;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .cart-qty-num {
            font-size: 14px;
            font-weight: 900;
            color: white;
            min-width: 22px;
            text-align: center;
        }
        @keyframes slideUp {
            from { transform: translateY(100%); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
    </style>
</head>
<body>

<!-- ===== DRAWER OVERLAY ===== -->
<div class="drawer-overlay" id="drawerOverlay" onclick="closeDrawer()"></div>

<!-- ===== SIDE DRAWER MENU ===== -->
<div class="side-drawer" id="sideDrawer">
    <div class="drawer-header">
        <div class="drawer-logo">RB <span>LIVE</span></div>
        <button class="drawer-close" onclick="closeDrawer()">
            <i data-lucide="x" style="width:16px;height:16px;"></i>
        </button>
    </div>
    <div class="drawer-nav">
        <button class="drawer-nav-item active" id="dnav-home" onclick="closeDrawer(); switchTab('home')">
            <i data-lucide="home"></i> Home
        </button>
        <button class="drawer-nav-item" id="dnav-bingo" onclick="closeDrawer(); switchTab('bingo')">
            <i data-lucide="play-circle"></i> Bingo
        </button>
        <button class="drawer-nav-item" id="dnav-store" onclick="closeDrawer(); openStorePage()">
            <i data-lucide="shopping-bag"></i> Store
        </button>
        <button class="drawer-nav-item" id="dnav-beats" onclick="closeDrawer(); switchTab('beats')">
            <i data-lucide="clapperboard"></i> Beats
        </button>
        <button class="drawer-nav-item" id="dnav-games" onclick="closeDrawer(); switchTab('games')">
            <i data-lucide="gamepad-2"></i> Games
        </button>
        <button class="drawer-nav-item" id="dnav-news" onclick="closeDrawer(); window.location.href='news.html'">
            <i data-lucide="newspaper"></i> News
        </button>
        <div class="drawer-divider"></div>
        <button class="drawer-nav-item" onclick="closeDrawer(); openMyProfile()">
            <i data-lucide="user"></i> My Profile
        </button>
    </div>
    <div class="drawer-footer" style="font-size:10px; color:#334155; font-weight:700; text-align:center; letter-spacing:0.5px;">
        RADIO BINGO LIVE  SOCIAL ECOSYSTEM
    </div>
</div>

<!-- ===== OLD BOTTOM NAV (hidden, kept for JS compatibility) ===== -->
<div class="bottom-nav" style="display:none!important;">
    <button class="nav-item active" onclick="switchTab('home')" id="nav-home">
        <i data-lucide="home" class="nav-icon"></i>
        <span class="nav-label">Home</span>
    </button>
    <button class="nav-item" onclick="switchTab('bingo')" id="nav-bingo">
        <i data-lucide="play-circle" class="nav-icon"></i>
        <span class="nav-label">Bingo</span>
    </button>
    <button class="nav-item" onclick="openStorePage()" id="nav-store">
        <i data-lucide="shopping-bag" class="nav-icon"></i>
        <span class="nav-label">Store</span>
    </button>
    <button class="nav-item" onclick="switchTab('beats')" id="nav-beats">
        <i data-lucide="clapperboard" class="nav-icon"></i>
        <span class="nav-label">Beats</span>
    </button>
    <button class="nav-item" onclick="switchTab('games')" id="nav-games">
        <i data-lucide="gamepad-2" class="nav-icon"></i>
        <span class="nav-label">Games</span>
    </button>
    <button class="nav-item" onclick="window.location.href='news.html'" id="nav-news">
        <i data-lucide="newspaper" class="nav-icon"></i>
        <span class="nav-label">News</span>
    </button>
    <button class="nav-item" onclick="openMyProfile()" id="nav-profile">
        <i data-lucide="user" class="nav-icon"></i>
        <span class="nav-label">Me</span>
    </button>
</div>

<!-- ===== ONLINE RADIO PLAYER BAR ===== -->
<!-- Chat Bubble FAB -->
<button class="chat-bubble-btn" id="chatBubbleBtn" onclick="openChatDrawer()">
    <i data-lucide="message-circle" style="width:24px;height:24px;"></i>
    <span class="chat-bubble-badge" id="chatBubbleBadge">0</span>
</button>

<!-- Chat Drawer Backdrop -->
<div class="chat-drawer-backdrop" id="chatDrawerBackdrop" onclick="closeChatDrawer()"></div>

<!-- Chat Drawer -->
<div class="chat-drawer" id="chatDrawer">
    <div class="chat-drawer-handle"></div>
    <div class="chat-drawer-header">
        <div class="chat-drawer-title">
            <i data-lucide="message-square" style="width:18px;color:var(--accent-glow)"></i>
            LIVE STREAM CHAT
        </div>
        <button class="chat-drawer-close" onclick="closeChatDrawer()">
            <i data-lucide="x" style="width:16px"></i>
        </button>
    </div>
    <div id="chatList" style="flex:1;overflow-y:auto;padding:var(--spacing-md);display:flex;flex-direction:column;gap:var(--spacing-sm);scroll-behavior:smooth;background:#0f172a;"></div>
    <div id="replyIndicator" class="reply-indicator" style="display:none; padding: 5px 15px; background: #374151; color: #d1d5db; font-size: 11px;">
        <span id="replyText">Replying to...</span>
        <button onclick="cancelReply()" style="background:none; border:none; color:white; cursor:pointer;"><i data-lucide="x" style="width:14px"></i></button>
    </div>
    <div class="chat-input-area" style="padding-bottom:max(12px,env(safe-area-inset-bottom));">
        <form class="input-wrapper" onsubmit="event.preventDefault(); sendChat();">
            <input type="text" id="chatIn" placeholder="Say something..." autocomplete="off">
            <button type="submit" class="send-btn">
                <i data-lucide="send" style="width:16px"></i>
            </button>
        </form>
    </div>
</div>
<div id="customPopupBanner">
    <div style="position:relative; max-width:400px; width:100%; animation: popScale 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);">
        <button onclick="closeCustomBanner()" style="position:absolute; top:-15px; right:-10px; background:linear-gradient(135deg, #ef4444, #b91c1c); color:white; border:2px solid white; border-radius:50%; width:36px; height:36px; font-weight:bold; cursor:pointer; z-index:10; display:flex; align-items:center; justify-content:center; box-shadow:0 4px 10px rgba(0,0,0,0.3);"><i data-lucide="x" style="width:20px"></i></button>
        <img id="customBannerImg" src="" style="width:100%; border-radius: var(--radius-xl); border:2px solid rgba(255,255,255,0.2); box-shadow:0 20px 50px rgba(0,0,0,0.8); cursor:pointer; object-fit:cover;" onclick="clickCustomBanner()">
    </div>
</div>

<!-- ===== SCHEDULE ANNOUNCEMENT POPUP ===== -->
<div id="scheduleAnnouncementPopup" style="display:none; position:fixed; inset:0; z-index:9999998; background:rgba(0,0,0,0.88); align-items:center; justify-content:center; flex-direction:column; padding:20px; backdrop-filter:blur(8px);">
    <div style="position:relative; max-width:400px; width:100%; background:linear-gradient(145deg, rgba(15,23,42,0.98), rgba(30,41,59,0.98)); border:2px solid rgba(139,92,246,0.5); border-radius:24px; padding:24px; box-shadow:0 0 60px rgba(139,92,246,0.4), 0 20px 60px rgba(0,0,0,0.8); animation:popScale 0.5s cubic-bezier(0.175,0.885,0.32,1.275);">
        
        <!-- Top accent -->
        <div style="position:absolute; top:0; left:0; right:0; height:3px; background:linear-gradient(90deg, #8b5cf6, #06b6d4, #fbbf24); border-radius:24px 24px 0 0;"></div>
        
        <!-- Header -->
        <div style="text-align:center; margin-bottom:20px;">
            <div style="font-size:44px; margin-bottom:8px; filter:drop-shadow(0 0 20px rgba(251,191,36,0.6));"></div>
            <div id="schedAnnTitle" style="font-size:20px; font-weight:900; color:white; letter-spacing:-0.5px; line-height:1.2;"> Draw Schedule Updated!</div>
            <div style="font-size:11px; color:rgba(255,255,255,0.4); margin-top:4px; font-weight:600; letter-spacing:0.5px;">OFFICIAL SCHEDULE ANNOUNCEMENT</div>
        </div>

        <!-- Message Body -->
        <div id="schedAnnMessage" style="background:rgba(0,0,0,0.3); border:1px solid rgba(255,255,255,0.08); border-radius:14px; padding:16px; font-size:13px; color:rgba(255,255,255,0.85); line-height:1.7; white-space:pre-line; max-height:260px; overflow-y:auto; margin-bottom:18px;"></div>

        <!-- Jackpot Highlights -->
        <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-bottom:18px;">
            <div style="background:rgba(251,191,36,0.1); border:1px solid rgba(251,191,36,0.3); border-radius:12px; padding:12px; text-align:center;">
                <div style="font-size:20px; margin-bottom:4px;"></div>
                <div style="font-size:10px; font-weight:800; color:rgba(255,255,255,0.4); letter-spacing:1px; text-transform:uppercase;">3:00 PM</div>
                <div style="font-size:14px; font-weight:900; color:#fbbf24;" id="schedAnn3pmAmt">5,000 RB</div>
                <div style="font-size:9px; color:rgba(255,255,255,0.35); font-weight:700;">JACKPOT ROUND</div>
            </div>
            <div style="background:rgba(251,191,36,0.1); border:1px solid rgba(251,191,36,0.3); border-radius:12px; padding:12px; text-align:center;">
                <div style="font-size:20px; margin-bottom:4px;"></div>
                <div style="font-size:10px; font-weight:800; color:rgba(255,255,255,0.4); letter-spacing:1px; text-transform:uppercase;">8:00 PM</div>
                <div style="font-size:14px; font-weight:900; color:#fbbf24;" id="schedAnn8pmAmt">5,000 RB</div>
                <div style="font-size:9px; color:rgba(255,255,255,0.35); font-weight:700;">JACKPOT ROUND</div>
            </div>
        </div>

        <!-- CTA Button -->
        <button onclick="closeScheduleAnnouncement()" style="width:100%; padding:14px; background:linear-gradient(135deg, #8b5cf6, #6d28d9); border:none; border-radius:12px; color:white; font-size:15px; font-weight:900; cursor:pointer; letter-spacing:0.5px; box-shadow:0 6px 20px rgba(139,92,246,0.5);">
             GOT IT  LET'S PLAY!
        </button>
        <div style="text-align:center; font-size:10px; color:rgba(255,255,255,0.3); margin-top:8px; font-weight:600;">
            Draws every 30 minutes  8:00 AM to 12:00 Midnight
        </div>
    </div>
</div>

<div id="installGate">
    <div class="gate-logo">RB<span>LIVE</span></div>
    <div class="gate-title">Install to Play</div>
    <p class="gate-desc">To access the full Radio Bingo experience, you must install the official App.</p>
    <button id="gateInstallBtn" class="gate-btn-install" onclick="triggerInstall()">
        <i data-lucide="download-cloud" style="width:20px; height:20px;"></i> INSTALL APP
    </button>
    <div id="gateIosNote" class="gate-ios-note">
        <div style="font-weight:800; color:white; margin-bottom: var(--spacing-sm); text-transform:uppercase;">iOS Instructions:</div>
        <div class="ios-step"><i data-lucide="share" class="ios-icon" style="width:16px;"></i> 1. Tap the Share button below.</div>
        <div class="ios-step"><i data-lucide="plus-square" class="ios-icon" style="width:16px;"></i> 2. Scroll down & tap 'Add to Home Screen'.</div>
        <div class="ios-step"><i data-lucide="check" class="ios-icon" style="width:16px;"></i> 3. Launch App from Home Screen.</div>
    </div>
</div>

<div id="notifBlocker">
    <div class="notif-gate-icon">
        <i data-lucide="bell-ring" style="width: 40px; height: 40px; color: #3b82f6;"></i>
    </div>
    <div class="notif-gate-title">ENABLE NOTIFICATIONS</div>
    <p class="notif-gate-desc">To ensure fairness and real-time updates for Bingo Calls, this app requires push notifications to be enabled.</p>
    <button onclick="requestGatePermission()" class="btn-allow-notif">
        <i data-lucide="check-circle" style="width:20px"></i> ALLOW NOTIFICATIONS
    </button>
    <div id="blockedHelp" class="blocked-help">
        <strong style="color:var(--danger); display:flex; align-items:center; gap:6px; margin-bottom:5px;"><i data-lucide="alert-triangle" style="width:16px;height:16px;vertical-align:middle;color:#ef4444;"></i> NOTIFICATIONS ARE BLOCKED!</strong>
        1. Click the <b>Lock <i data-lucide="lock" style="width:13px;height:13px;vertical-align:middle;color:white;"></i> or <b>Settings Icon</b> beside the URL bar.<br>
        2. Click <b>Permissions</b> or <b>Site Settings</b>.<br>
        3. Find <b>Notifications</b> and set to <b>Allow</b>.<br>
        4. Reload this page.
    </div>
</div>

<div id="splash-screen">
    <div class="splash-logo">RB<span>LIVE</span></div>
    <div class="splash-tagline">Social Ecosystem</div>
    <div class="splash-loader">
        <div class="splash-dot"></div>
        <div class="splash-dot"></div>
        <div class="splash-dot"></div>
    </div>
</div>

<div id="customToast">
    <i data-lucide="info" class="toast-icon"></i>
    <span class="toast-msg" id="toastMsg">Notification!</span>
</div>

<div id="customConfirmModal">
    <div class="conf-content">
        <i data-lucide="alert-circle" style="width: 40px; height: 40px; color: var(--gold); margin-bottom: var(--spacing-md);"></i>
        <h3 class="conf-title" id="confTitle">Confirm Action</h3>
        <p class="conf-msg" id="confMsg">Are you sure you want to proceed?</p>
        
        <!-- Optional textarea for verification reason -->
        <div id="confTextareaContainer" style="display: none; width: 100%;">
            <textarea id="confTextarea" class="conf-textarea" placeholder="Explain why you want a verification badge (e.g., active community member, content creator, streamer, etc.)"></textarea>
            <div style="font-size: 11px; color: #94a3b8; margin-top: 8px; text-align: left;">
                <i data-lucide="info" style="width: 12px; height: 12px; display: inline;"></i>
                This helps admins review your request.
            </div>
        </div>
        
        <div class="conf-actions">
            <button class="btn-conf-no" onclick="closeCustomConfirm()">CANCEL</button>
            <button class="btn-conf-yes" id="confYesBtn">CONFIRM</button>
        </div>
    </div>
</div>

<div id="loginOverlay">

    <!-- Animated background orbs -->
    <div class="login-canvas-bg">
        <div class="login-orb login-orb-1"></div>
        <div class="login-orb login-orb-2"></div>
        <div class="login-orb login-orb-3"></div>
        <div class="login-orb login-orb-4"></div>
    </div>

    <!-- Grid texture -->
    <div class="login-grid"></div>

    <!-- Hero  top half -->
    <div class="login-hero">
        <div class="login-logo-badge">
            <span>Live Now</span>
        </div>

        <div class="login-logo-main">
            <span class="rb">RB</span><span class="live">LIVE</span>
        </div>

        <p class="login-tagline">Play Bingo. Win Rewards.<br>Shop with your coins.</p>

        <div class="login-feature-row">
            <div class="login-feature-pill"> Live Bingo</div>
            <div class="login-feature-pill"> RB Coins</div>
            <div class="login-feature-pill"> My Shop</div>
            <div class="login-feature-pill"> Leaderboard</div>
        </div>
    </div>

    <!-- Bottom card  overlaps hero -->
    <div class="login-bottom-card">

        <!-- Promo ribbon -->
        <div class="login-promo-ribbon">
            <div class="login-promo-icon"></div>
            <div class="login-promo-text">
                <strong>200 Free RB Coins on Sign Up</strong>
                <span>New accounts only  Limited time offer</span>
            </div>
        </div>

        <!-- Google Sign In button -->
        <button class="btn-google-signin" onclick="login()">
            <!-- Official Google G logo (inline SVG  never breaks) -->
            <svg width="20" height="20" viewBox="0 0 48 48" xmlns="http://www.w3.org/2000/svg">
                <path fill="#EA4335" d="M24 9.5c3.54 0 6.71 1.22 9.21 3.6l6.85-6.85C35.9 2.38 30.47 0 24 0 14.62 0 6.51 5.38 2.56 13.22l7.98 6.19C12.43 13.72 17.74 9.5 24 9.5z"/>
                <path fill="#4285F4" d="M46.98 24.55c0-1.57-.15-3.09-.38-4.55H24v9.02h12.94c-.58 2.96-2.26 5.48-4.78 7.18l7.73 6c4.51-4.18 7.09-10.36 7.09-17.65z"/>
                <path fill="#FBBC05" d="M10.53 28.59c-.48-1.45-.76-2.99-.76-4.59s.27-3.14.76-4.59l-7.98-6.19C.92 16.46 0 20.12 0 24c0 3.88.92 7.54 2.56 10.78l7.97-6.19z"/>
                <path fill="#34A853" d="M24 48c6.48 0 11.93-2.13 15.89-5.81l-7.73-6c-2.18 1.48-4.97 2.31-8.16 2.31-6.26 0-11.57-4.22-13.47-9.91l-7.98 6.19C6.51 42.62 14.62 48 24 48z"/>
                <path fill="none" d="M0 0h48v48H0z"/>
            </svg>
            Continue with Google
        </button>

        <!-- Divider -->
        <div class="login-divider"><span>Secured by Firebase Auth</span></div>

        <!-- Legal footer -->
        <div class="login-legal">
            <div class="login-legal-disclaimer">For entertainment purposes only  No real money betting</div>
            <div class="login-legal-links">
                <a href="terms.html">Terms</a>
                <span></span>
                <a href="privacy.html">Privacy Policy</a>
            </div>
        </div>

    </div>

</div>

<div class="nav">
    <div style="display:flex; align-items:center; gap: var(--spacing-sm);">
        <button class="hamburger-btn" id="hamburgerBtn" onclick="toggleHamburgerMenu()" aria-label="Menu">
            <span></span><span></span><span></span>
        </button>
        <span style="font-weight: 900; font-size: 20px; text-shadow: 0 2px 5px rgba(0,0,0,0.8);">RB <span style="color:var(--accent-glow)">LIVE</span></span>
    </div>
    <div id="userPanel" style="display:none; align-items: center; gap: var(--spacing-sm);">
        <div class="user-stats">
            <div class="icon-btn" onclick="openSearch()">
                <i data-lucide="search" style="width:20px"></i>
            </div>
            <div class="icon-btn" onclick="openMessenger()">
                <i data-lucide="message-circle" style="width:20px"></i>
                <span id="pmBadge" class="notif-badge"></span>
            </div>
            <div class="icon-btn" onclick="openNotifs()">
                <i data-lucide="bell" style="width:20px"></i>
                <span id="notifDot" class="notif-badge"></span>
            </div>
        </div>
        <div id="userImgContainer" onclick="openMenuModal()"></div>
    </div>
</div>

<!-- HAMBURGER OVERLAY -->
<div class="hamburger-overlay" id="hamburgerOverlay" onclick="closeHamburgerMenu()"></div>

<!-- HAMBURGER SIDE MENU -->
<div class="hamburger-menu" id="hamburgerMenu">
    <div class="hamburger-menu-header">
        <span class="hamburger-menu-title">Navigation</span>
        <button class="hamburger-close-btn" onclick="closeHamburgerMenu()">
            <i data-lucide="x" style="width:16px;height:16px;"></i>
        </button>
    </div>
    <div class="hamburger-section-label">Main</div>
    <button class="hamburger-nav-item active" id="hmenu-home" onclick="closeHamburgerMenu(); switchTab('home')">
        <i data-lucide="home"></i> Home
    </button>
    <button class="hamburger-nav-item" id="hmenu-bingo" onclick="closeHamburgerMenu(); switchTab('bingo')">
        <i data-lucide="play-circle"></i> Bingo
    </button>
    <button class="hamburger-nav-item" id="hmenu-beats" onclick="closeHamburgerMenu(); switchTab('beats')">
        <i data-lucide="clapperboard"></i> Beats
    </button>
    <button class="hamburger-nav-item" id="hmenu-games" onclick="closeHamburgerMenu(); switchTab('games')">
        <i data-lucide="gamepad-2"></i> Games
    </button>
    <div class="hamburger-divider"></div>
    <div class="hamburger-section-label">More</div>
    <button class="hamburger-nav-item" onclick="closeHamburgerMenu(); openStorePage()">
        <i data-lucide="shopping-bag"></i> Store
    </button>
    <button class="hamburger-nav-item" onclick="closeHamburgerMenu(); window.location.href='news.html'">
        <i data-lucide="newspaper"></i> News
    </button>
    <div class="hamburger-divider"></div>
    <div class="hamburger-section-label">Account</div>
    <button class="hamburger-nav-item" onclick="closeHamburgerMenu(); openMyProfile()">
        <i data-lucide="user"></i> My Profile
    </button>
    <button class="hamburger-nav-item" onclick="closeHamburgerMenu(); openMenuModal()">
        <i data-lucide="settings"></i> Settings
    </button>
</div>

<div class="container">
    <div class="ad-container-global">
        <script type="text/javascript">
            atOptions = { 'key' : '9bf585b6ee39cb9b515e2fae1fa958c2', 'format' : 'iframe', 'height' : 50, 'width' : 320, 'params' : {} };
        </script>
        <script type="text/javascript" src="https://pl28660488.effectivegatecpm.com/9b/f5/85/9bf585b6ee39cb9b515e2fae1fa958c2.js"></script>
    </div>

    <div id="view-home" style="display:block;">
        <div id="friendRequestsSection"></div>

        <!--  STORIES ROW -->
        <div class="stories-row" id="storiesRow">
            <!-- Add Story -->
            <div class="story-item" onclick="openStoryCreator()">
                <div class="story-ring add-story">
                    <div class="story-ring-inner">
                        <img id="myStoryAvatar" src="https://via.placeholder.com/60">
                    </div>
                    <div class="story-add-plus">+</div>
                </div>
                <div class="story-name">Your Story</div>
            </div>
            <!-- Dynamic stories load here -->
        </div>

        <!-- STREAK WIDGET -->
        <div class="streak-home-widget" id="streakHomeWidget" onclick="openLeaderboard()">
            <div style="line-height:1;filter:drop-shadow(0 0 10px rgba(251,191,36,0.6));"><i data-lucide="flame" style="width:36px;height:36px;vertical-align:middle;color:#f59e0b;"></i></div>
            <div style="flex:1;">
                <div style="font-size:14px;font-weight:900;color:white;">Daily Streak</div>
                <div style="font-size:12px;color:rgba(255,255,255,0.5);">Log in daily to earn bonus coins!</div>
            </div>
            <div style="font-size:12px;color:#fbbf24;font-weight:700;"> VIEW</div>
        </div>
        
        <div class="post-creator-modern" id="mainPostCreator">
            <!-- Header with Avatar and Input -->
            <div class="post-creator-header">
                <img id="postCreatorAvatar" class="post-creator-avatar" src="https://via.placeholder.com/48" alt="Your avatar" onclick="openUserProfile(userData?.uid || '')">
                <div class="post-input-wrapper">
                    <textarea id="postInput" class="post-input-modern" placeholder="What's on your mind?" rows="1"></textarea>
                </div>
            </div>
            
            <!-- Expandable Body (shows when focused) -->
            <div class="post-creator-body">
                <div class="image-preview-container" id="imgPreviewCont">
                    <img id="postImgPreview" class="image-preview-img">
                    <div class="btn-remove-img" onclick="removePostImage()"><i data-lucide="x"></i></div>
                </div>
                
                <div class="image-preview-container" id="videoPreviewCont" style="display:none;">
                    <video id="postVideoPreview" class="image-preview-img" controls style="width:100%; max-height:300px;"></video>
                    <div class="btn-remove-img" onclick="removePostVideo()"><i data-lucide="x"></i></div>
                </div>

                <div class="mood-selector">
                    <div class="mood-chip" onclick="selectMood(this, 'Happy')"><i data-lucide="smile" style="width:14px;height:14px;vertical-align:middle;color:#fbbf24;"></i> Happy</div>
                    <div class="mood-chip" onclick="selectMood(this, 'Sad')"><i data-lucide="frown" style="width:14px;height:14px;vertical-align:middle;color:#60a5fa;"></i> Sad</div>
                    <div class="mood-chip" onclick="selectMood(this, 'Excited')"><i data-lucide="star" style="width:14px;height:14px;vertical-align:middle;color:#f59e0b;"></i> Excited</div>
                    <div class="mood-chip" onclick="selectMood(this, 'Cool')"><i data-lucide="glasses" style="width:14px;height:14px;vertical-align:middle;color:#a78bfa;"></i> Cool</div>
                    <div class="mood-chip" onclick="selectMood(this, 'Angry')"><i data-lucide="zap" style="width:14px;height:14px;vertical-align:middle;color:#ef4444;"></i> Angry</div>
                    <div class="mood-chip" onclick="selectMood(this, 'Lucky')"><i data-lucide="clover" style="width:14px;height:14px;vertical-align:middle;color:#10b981;"></i> Lucky</div>
                </div>

                <div class="post-tools">
                    <div class="post-actions-left">
                        <label for="postImgInput" class="tool-btn photo-tool">
                            <i data-lucide="image"></i>
                            <span>Photo</span>
                        </label>
                        <input type="file" id="postImgInput" accept="image/*" style="display:none" onchange="handlePostImage(this)">
                        
                        <label for="postVideoInput" class="tool-btn">
                            <i data-lucide="video"></i>
                            <span>Video</span>
                        </label>
                        <input type="file" id="postVideoInput" accept="video/*" style="display:none" onchange="handlePostVideo(this)">
                        
                        <button class="tool-btn" id="visibilityBtn" onclick="toggleVisibility()" title="Post visibility">
                            <i data-lucide="globe" id="visibilityIcon"></i>
                        </button>
                        <input type="hidden" id="postVisibility" value="public">

                        <button class="tool-btn" onclick="togglePollCreator()" id="pollToggleBtn" title="Add Poll">
                            <i data-lucide="bar-chart-2"></i>
                            <span>Poll</span>
                        </button>
                    </div>
                    
                    <button class="btn-post-modern" onclick="createPost()">
                        <span>Post</span>
                    </button>
                </div>

                <!--  Poll Creator -->
                <div class="poll-creator-box" id="pollCreatorBox">
                    <div style="font-size:12px;font-weight:800;color:var(--accent);margin-bottom:10px;display:flex;align-items:center;gap:6px;">
                        <i data-lucide="bar-chart-2" style="width:14px;"></i> CREATE POLL
                    </div>
                    <input type="text" id="pollQuestion" placeholder="Ask a question..." style="width:100%;background:rgba(255,255,255,0.06);border:1px solid rgba(14,165,233,0.3);border-radius:8px;padding:10px 12px;color:white;font-size:14px;outline:none;margin-bottom:10px;">
                    <div id="pollOptionsContainer">
                        <div class="poll-opt-row">
                            <input type="text" placeholder="Option 1" class="poll-opt-input">
                            <button class="poll-rem-btn" onclick="removePollOption(this)"></button>
                        </div>
                        <div class="poll-opt-row">
                            <input type="text" placeholder="Option 2" class="poll-opt-input">
                            <button class="poll-rem-btn" onclick="removePollOption(this)"></button>
                        </div>
                    </div>
                    <button class="poll-add-btn" onclick="addPollOption()">+ Add Option</button>
                </div>
            </div>
        </div>

        <div id="pymkSection" class="pymk-section" style="display:none;">
            <div class="pymk-title">
                <i data-lucide="users"></i>
                People You May Know
            </div>
            <div class="pymk-scroll" id="pymkList"></div>
        </div>

        <div class="feed-sort-modern">
            <button class="sort-btn active" id="sort-hype" onclick="toggleFeedSort('hype')" style="font-size:11px; padding:6px 12px;">
                <i data-lucide="flame" style="width:12px"></i> HOT
            </button>
            <button class="sort-btn" id="sort-new" onclick="toggleFeedSort('new')" style="font-size:11px; padding:6px 12px;">
                <i data-lucide="clock" style="width:12px"></i> NEW
            </button>
        </div>

        <div id="socialFeed" class="social-feed-container">
            <div style="text-align:center; padding: var(--spacing-lg); opacity:0.5;">Loading Feed...</div>
        </div>
    </div>

    <div id="view-bingo" style="display:none;">
        <!-- Quick actions -->
        <div class="bingo-quick-actions">
            <button class="bingo-quick-btn gold" onclick="openTournaments()">
                <i data-lucide="trophy" style="width:18px;height:18px;vertical-align:middle;color:#fbbf24;"></i> Tournaments
            </button>
            <button class="bingo-quick-btn blue" onclick="openLeaderboard()">
                <i data-lucide="bar-chart-2" style="width:18px;height:18px;vertical-align:middle;color:#38bdf8;"></i> Leaderboard
            </button>
            <button class="bingo-quick-btn" onclick="showStreakModal(userData.loginStreak||1, STREAK_REWARDS[Math.min((userData.loginStreak||1)-1,6)])" style="border-color:rgba(239,68,68,0.3);background:rgba(239,68,68,0.1);color:#f87171;">
                <i data-lucide="flame" style="width:18px;height:18px;vertical-align:middle;color:#f87171;"></i> My Streak
            </button>
        </div>
        <div class="video-feed-wrapper">
            <div class="video-container">
                <div class="video-overlay-bl"><i data-lucide="users" style="width:14px"></i><span id="onlineCount">0</span> ONLINE</div>
                <div id="videoOfflineState" style="display:none; position:absolute; inset:0; background:#0f172a; flex-direction:column; align-items:center; justify-content:center; z-index:20;">
                    <div style="width:60px; height:60px; background:rgba(255,255,255,0.05); border-radius:50%; display:flex; align-items:center; justify-content:center; margin-bottom: var(--spacing-md); animation:pulse-ring 2s infinite;">
                        <i data-lucide="radio" style="width:30px; height:30px; color:#94a3b8;"></i>
                    </div>
                    <h3 style="margin:0; font-size:16px; font-weight:900; color:white; letter-spacing:1px;">WAITING FOR LIVE</h3>
                    <p style="margin:5px 0 0; font-size:12px; color:#64748b;">Stand by for the next draw.</p>
                </div>
                <iframe id="liveVideoFrame" width="100%" height="100%" src="https://www.youtube.com/embed/4I_NSJTbdXo?autoplay=1&mute=1" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" referrerpolicy="strict-origin-when-cross-origin" allowfullscreen style="border:none; position:absolute; top:0; left:0; width:100%; height:100%;"></iframe>
            </div>
        </div>

        <div id="jackpotBanner">
            <div class="jp-label-new">
                <i data-lucide="crown" style="width: 16px;"></i> JACKPOT ROUND <i data-lucide="crown" style="width: 16px;"></i>
            </div>
            <span class="jackpot-amount" id="jackpotDisplayVal">5,000</span>
            <div style="font-size: 10px; opacity: 0.7; margin-top: 5px; color: #fbbf24;">RB COINS GRAND PRIZE</div>
        </div>

        <div id="nextDrawBanner" class="next-draw-container">
            <div class="nd-icon"><i data-lucide="calendar-days"></i></div>
            <div class="nd-info">
                <div class="next-draw-label">Susunod na Bola</div>
                <div id="nextDrawTime" class="next-draw-time">--:-- --</div>
            </div>
        </div>
        
        <div id="winnerBanner">
            <span><i data-lucide="party-popper" style="width:24px; height:24px;"></i> BINGO WINNER!</span>
            <span class="winner-line" id="winnerPatternLine">Pattern: Normal Bingo</span>
        </div>

        <div class="draw-panel">
            <div class="prev-balls" id="ballRow"></div>
            <div class="current-ball-box"><span style="font-size:9px; font-weight:800; opacity:0.8; color:white;">NOW DRAWN</span><span id="currentBall" style="font-size:36px; font-weight:900; color:white; text-shadow:0 2px 10px rgba(0,0,0,0.5);">--</span></div>
        </div>
        
        <!-- BENTO CARD GRID -->
        <div class="bento-cards-wrapper">
            <div class="bento-grid" id="bentoGrid">

                <!-- SLOT 0: Main Card -->
                <div class="bento-slot" id="bentoSlot0">
                    <span class="card-num-badge">Card 1</span>
                    <div class="card" id="bingoCardContainer">
                        <div id="lateOverlay" class="late-overlay">
                            <i data-lucide="lock" style="color:var(--danger); width:48px; height:48px; margin-bottom: var(--spacing-md); filter: drop-shadow(0 0 10px var(--danger));"></i>
                            <div class="late-text">GAME ONGOING</div>
                            <div class="late-subtext">Sorry, the draw is already in progress. Late entries are not allowed.</div>
                            <div style="margin-top: var(--spacing-lg); background:rgba(255,255,255,0.1); padding: var(--spacing-sm) 20px; border-radius: var(--radius-md); border:1px solid rgba(255,255,255,0.1);">
                                <span style="font-size:10px; display:block; opacity:0.7;">NEXT GAME:</span>
                                <strong id="lateNextSched" style="font-size:16px; color:var(--gold);">--:--</strong>
                            </div>
                        </div>
                        <div id="gameOverOverlay" class="game-over-overlay">
                            <i data-lucide="trophy" style="color:var(--gold); width:50px; height:50px; margin-bottom: var(--spacing-md); filter: drop-shadow(0 0 15px var(--gold));"></i>
                            <div class="late-text">Game Finished</div>
                            <div class="late-subtext" id="gameOverMsg">Better luck next time!</div>
                        </div>
                        <div class="change-card-wrapper" style="display:flex; justify-content:space-between; align-items:center; padding-bottom:15px;">
                            <div class="pattern-box">
                                <div class="pattern-dot"></div>
                                <span class="pattern-text" id="patternName">Normal Bingo</span>
                            </div>
                            <button class="btn-change" id="newCardBtn" onclick="generateNewCard()"><i data-lucide="refresh-cw" style="width:14px"></i> NEW CARD</button>
                        </div>
                        <div class="bingo-header"><div class="letter">B</div><div class="letter">I</div><div class="letter">N</div><div class="letter">G</div><div class="letter">O</div></div>
                        <div class="grid" id="bingoGrid"></div>
                    </div>
                </div>

                <!-- BUY SLOT (always last in grid) -->
                <div class="bento-slot" id="bentoBuySlot">
                    <button class="bento-buy-slot buy-extra-card-btn" id="buyExtraCardBtn" onclick="buyExtraCard()">
                        <div class="buy-icon">&#10133;</div>
                        <div class="buy-label">DAGDAG CARD</div>
                        <div class="buy-cost">100 RB Coins &bull; Max 5</div>
                        <div id="extraCardCount" style="font-size:10px; margin-top:1px; opacity:0.6;">0 extra cards</div>
                    </button>
                </div>

            </div>
        </div>
        <!-- /BENTO CARD GRID -->

    </div>

    <div id="view-beats" style="display:none;">
        <div class="beats-header">
            <div class="beats-logo">BEATS</div>
            <button class="beats-search-btn"><i data-lucide="search" style="width:18px;"></i></button>
        </div>

        <div id="beatsContainer">
            <div class="beats-placeholder">
                <i data-lucide="video" style="width:60px; height:60px; color:rgba(255,255,255,0.3);"></i>
                <h3 style="font-size:18px; margin:10px 0;">Loading Beats...</h3>
                <p style="font-size:13px; opacity:0.6;">Sandali lang...</p>
            </div>
        </div>
    </div>
</div>

<!-- ===== GAMES TAB VIEW ===== -->
<div id="view-games" style="display:none; min-height:100vh; background:#0a0f1e;">

    <!-- Header -->
    <div style="padding:20px 16px 0; background:linear-gradient(180deg,rgba(10,15,30,1) 0%,rgba(10,15,30,0) 100%);">
        <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:4px;">
            <div>
                <div style="font-size:22px; font-weight:900; letter-spacing:-0.5px; color:white;"> MINI GAMES</div>
                <div style="font-size:11px; color:rgba(255,255,255,0.35); font-weight:600; margin-top:2px;">Powered by AI  Laging bago!</div>
            </div>
            <div id="gamesCoinsDisplay" style="background:rgba(251,191,36,0.12); border:1px solid rgba(251,191,36,0.3); border-radius:20px; padding:6px 12px; display:flex; align-items:center; gap:6px;">
                <span style="font-size:14px;"></span>
                <span id="gamesCoinsAmt" style="font-size:13px; font-weight:800; color:#fbbf24;">0</span>
            </div>
        </div>
    </div>

    <!-- Game Grid -->
    <div style="padding:16px; display:grid; grid-template-columns:1fr 1fr; gap:10px;">

        <!-- Trivia Quiz -->
        <div class="game-card" onclick="openGame('trivia')" style="--gc:#8b5cf6;">
            <div class="game-card-bg"></div>
            <div class="game-card-emoji"></div>
            <div class="game-card-name">Trivia Quiz</div>
            <div class="game-card-sub">AI-generated  Filipino</div>
            <div class="game-card-badge"> AI</div>
        </div>

        <!-- Memory Flip -->
        <div class="game-card" onclick="openGame('memory')" style="--gc:#06b6d4;">
            <div class="game-card-bg"></div>
            <div class="game-card-emoji"></div>
            <div class="game-card-name">Memory Flip</div>
            <div class="game-card-sub">Match the pairs</div>
            <div class="game-card-badge"> FAST</div>
        </div>

        <!-- Word Scramble -->
        <div class="game-card" onclick="openGame('scramble')" style="--gc:#f59e0b;">
            <div class="game-card-bg"></div>
            <div class="game-card-emoji"></div>
            <div class="game-card-name">Word Scramble</div>
            <div class="game-card-sub">AI-generated words</div>
            <div class="game-card-badge"> AI</div>
        </div>

        <!-- Reaction Tap -->
        <div class="game-card" onclick="openGame('reaction')" style="--gc:#10b981;">
            <div class="game-card-bg"></div>
            <div class="game-card-emoji"></div>
            <div class="game-card-name">Reaction Tap</div>
            <div class="game-card-sub">Gaano kayo kabilis?</div>
            <div class="game-card-badge"> SPEED</div>
        </div>

        <!-- 2048 -->
        <div class="game-card" onclick="openGame('tiles2048')" style="--gc:#fbbf24;">
            <div class="game-card-bg"></div>
            <div class="game-card-emoji"></div>
            <div class="game-card-name">2048 Tiles</div>
            <div class="game-card-sub">Merge & reach 2048</div>
            <div class="game-card-badge"> PUZZLE</div>
        </div>

        <!-- Snake -->
        <div class="game-card" onclick="openGame('snake')" style="--gc:#ef4444;">
            <div class="game-card-bg"></div>
            <div class="game-card-emoji"></div>
            <div class="game-card-name">Snake</div>
            <div class="game-card-sub">Classic snake game</div>
            <div class="game-card-badge"> CLASSIC</div>
        </div>

        <!-- Emoji Guess -->
        <div class="game-card" onclick="openGame('emoji')" style="--gc:#f472b6;">
            <div class="game-card-bg"></div>
            <div class="game-card-emoji"></div>
            <div class="game-card-name">Emoji Guess</div>
            <div class="game-card-sub">AI-generated puzzles</div>
            <div class="game-card-badge"> AI</div>
        </div>

        <!-- Number Guess -->
        <div class="game-card" onclick="openGame('numguess')" style="--gc:#a78bfa;">
            <div class="game-card-bg"></div>
            <div class="game-card-emoji"></div>
            <div class="game-card-name">Number Guess</div>
            <div class="game-card-sub">Hulaan ang numero!</div>
            <div class="game-card-badge"> GUESS</div>
        </div>

        <!-- Pinoy Riddles -->
        <div class="game-card" onclick="openGame('riddles')" style="--gc:#34d399;">
            <div class="game-card-bg"></div>
            <div class="game-card-emoji"></div>
            <div class="game-card-name">Pinoy Riddles</div>
            <div class="game-card-sub">AI bugtong at palaisipan</div>
            <div class="game-card-badge"> AI</div>
        </div>

        <!-- Whack-a-Mole -->
        <div class="game-card" onclick="openGame('whack')" style="--gc:#fb923c;">
            <div class="game-card-bg"></div>
            <div class="game-card-emoji"></div>
            <div class="game-card-name">Whack-a-Mole</div>
            <div class="game-card-sub">Tapusin ang mga mole!</div>
            <div class="game-card-badge"> ACTION</div>
        </div>

    </div>
    <div style="height:20px;"></div>
</div>

<style>
.game-card {
    position: relative;
    background: rgba(255,255,255,0.04);
    border: 1px solid rgba(var(--gc-raw, 255,255,255), 0.15);
    border-color: color-mix(in srgb, var(--gc) 30%, transparent);
    border-radius: 18px;
    padding: 16px 14px 14px;
    cursor: pointer;
    overflow: hidden;
    transition: all 0.2s cubic-bezier(0.34, 1.56, 0.64, 1);
    -webkit-tap-highlight-color: transparent;
    min-height: 120px;
    display: flex;
    flex-direction: column;
}
.game-card:active { transform: scale(0.95); }
.game-card-bg {
    position: absolute;
    inset: 0;
    background: radial-gradient(circle at 80% 20%, color-mix(in srgb, var(--gc) 20%, transparent) 0%, transparent 60%);
    pointer-events: none;
}
.game-card-emoji { font-size: 32px; margin-bottom: 8px; line-height: 1; }
.game-card-name { font-size: 13px; font-weight: 800; color: white; margin-bottom: 3px; }
.game-card-sub { font-size: 10px; color: rgba(255,255,255,0.4); font-weight: 600; flex: 1; }
.game-card-badge {
    display: inline-flex;
    align-self: flex-start;
    margin-top: 10px;
    background: color-mix(in srgb, var(--gc) 20%, transparent);
    border: 1px solid color-mix(in srgb, var(--gc) 40%, transparent);
    color: color-mix(in srgb, var(--gc) 80%, white);
    font-size: 9px;
    font-weight: 800;
    padding: 2px 8px;
    border-radius: 20px;
    letter-spacing: 0.3px;
}
</style>

<!-- ===== GAME MODAL ===== -->
<div id="gameModal" style="display:none; position:fixed; inset:0; z-index:99000; background:#0a0f1e; overflow-y:auto; flex-direction:column;">
    <div style="position:sticky; top:0; background:rgba(10,15,30,0.98); backdrop-filter:blur(20px); border-bottom:1px solid rgba(255,255,255,0.08); padding:12px 16px; display:flex; align-items:center; gap:12px; z-index:10;">
        <button onclick="closeGame()" style="background:rgba(255,255,255,0.08); border:1px solid rgba(255,255,255,0.12); color:white; border-radius:10px; width:36px; height:36px; display:flex; align-items:center; justify-content:center; cursor:pointer; font-size:16px; flex-shrink:0;"></button>
        <div id="gameModalTitle" style="font-size:15px; font-weight:800; color:white; flex:1;"></div>
        <div id="gameModalScore" style="font-size:12px; font-weight:700; color:#fbbf24;"></div>
    </div>
    <div id="gameModalContent" style="padding:16px; flex:1; min-height:calc(100vh - 60px);"></div>
</div>

<!-- AI Loading Overlay -->
<div id="aiLoadingOverlay" style="display:none; position:fixed; inset:0; z-index:99500; background:rgba(10,15,30,0.95); backdrop-filter:blur(10px); align-items:center; justify-content:center; flex-direction:column; gap:16px;">
    <div style="width:56px; height:56px; border-radius:50%; background:linear-gradient(135deg,#8b5cf6,#06b6d4); display:flex; align-items:center; justify-content:center; font-size:28px; animation:aiSpin 2s linear infinite;"></div>
    <div style="font-size:15px; font-weight:700; color:white;">AI is generating...</div>
    <div style="font-size:12px; color:rgba(255,255,255,0.4);" id="aiLoadingHint">Sandali lang...</div>
</div>
<style>
@keyframes aiSpin { 0%{transform:rotate(0deg) scale(1)} 50%{transform:rotate(180deg) scale(1.1)} 100%{transform:rotate(360deg) scale(1)} }
</style>

<script>
// ============================================================
// SOUND ENGINE  Web Audio API (no external files needed)
// ============================================================
const _sfx = (function() {
    let ctx;
    function getCtx() {
        if (!ctx) { try { ctx = new (window.AudioContext || window.webkitAudioContext)(); } catch(e){} }
        return ctx;
    }
    function tone(freq, type, dur, vol, delay) {
        try {
            const c = getCtx(); if (!c) return;
            const o = c.createOscillator();
            const g = c.createGain();
            o.connect(g); g.connect(c.destination);
            o.type = type || 'sine';
            o.frequency.setValueAtTime(freq, c.currentTime + (delay||0));
            g.gain.setValueAtTime(vol||0.3, c.currentTime + (delay||0));
            g.gain.exponentialRampToValueAtTime(0.001, c.currentTime + (delay||0) + dur);
            o.start(c.currentTime + (delay||0));
            o.stop(c.currentTime + (delay||0) + dur + 0.05);
        } catch(e){}
    }
    return {
        correct() { tone(523,  'sine',   0.12, 0.3, 0); tone(659, 'sine', 0.12, 0.3, 0.1); tone(784, 'sine', 0.15, 0.35, 0.2); },
        wrong()   { tone(200,  'sawtooth',0.15, 0.3, 0); tone(150, 'sawtooth', 0.2, 0.25, 0.1); },
        flip()    { tone(440,  'sine',   0.08, 0.2, 0); },
        match()   { tone(880,  'sine',   0.1,  0.3, 0); tone(1100,'sine', 0.1, 0.3, 0.08); },
        tap()     { tone(600,  'square', 0.05, 0.15, 0); },
        win()     { [523,659,784,1047].forEach((f,i)=>tone(f,'sine',0.18,0.35,i*0.09)); },
        lose()    { tone(300,'sawtooth',0.1,0.3,0); tone(200,'sawtooth',0.2,0.3,0.1); tone(150,'sawtooth',0.25,0.25,0.25); },
        tick()    { tone(800,'square',0.04,0.1,0); },
        click()   { tone(500,'sine',0.06,0.15,0); },
        eat()     { tone(700,'sine',0.07,0.25,0); tone(900,'sine',0.07,0.2,0.05); },
        whack()   { tone(300,'sawtooth',0.08,0.35,0); tone(200,'square',0.06,0.3,0.05); },
        merge()   { tone(440,'triangle',0.1,0.3,0); tone(550,'triangle',0.1,0.25,0.06); },
        reveal()  { tone(350,'sine',0.06,0.2,0); }
    };
})();

// ============================================================
// AI ENGINE  Anthropic API
// ============================================================
async function aiGenerate(prompt, hint) {
    document.getElementById('aiLoadingOverlay').style.display = 'flex';
    if (hint) document.getElementById('aiLoadingHint').textContent = hint;
    try {
        const res = await fetch('https://api.anthropic.com/v1/messages', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'x-api-key': window._RBAI_KEY || '',
                'anthropic-version': '2023-06-01',
                'anthropic-dangerous-direct-browser-access': 'true'
            },
            body: JSON.stringify({
                model: 'claude-haiku-4-5-20251001',
                max_tokens: 1000,
                messages: [{ role: 'user', content: prompt }]
            })
        });
        const data = await res.json();
        document.getElementById('aiLoadingOverlay').style.display = 'none';
        const text = (data.content || []).map(b => b.text || '').join('');
        return text;
    } catch(e) {
        document.getElementById('aiLoadingOverlay').style.display = 'none';
        return null;
    }
}

// ============================================================
// GAME POINTS HELPER  Awards coins to the current user
// ============================================================
function awardGamePoints(pts, reason) {
    if (!pts || pts <= 0) return;
    var db = window.db; var auth = window.auth;
    if (!db || !auth || !auth.currentUser) return;
    // Security: clamp points to reasonable per-award max
    pts = Math.min(Math.abs(parseInt(pts) || 0), 200);
    if (pts <= 0) return;
    // Security: daily earnings cap (client-side soft limit)
    if (!canEarnPoints(pts)) { console.log('[Security] Daily point cap reached.'); return; }
    trackPointsEarned(pts);
    var uid = auth.currentUser.uid;
    db.ref('users/' + uid + '/points').transaction(function(p) { return (p || 0) + pts; });
    db.ref('coinHistory/' + uid).push({ label: ' ' + (reason || 'Mini-Game Reward'), amount: pts, type: 'earn', timestamp: Date.now() });
    // Update in-memory and display
    if (window.userData) {
        window.userData.points = (window.userData.points || 0) + pts;
        document.querySelectorAll('#rbStoreCoins, #gamesCoinsAmt, #gamesRbCoins').forEach(function(el) {
            if (el) el.textContent = Number(window.userData.points).toLocaleString();
        });
    }
    // Visual feedback
    if (typeof spawnFlyingCoins === 'function') spawnFlyingCoins(Math.min(pts, 30));
    if (typeof showToast === 'function') showToast(' +' + pts + ' RB Coins! ' + (reason || ''));
}

function parseAIJson(text) {
    if (!text) return null;
    try {
        const clean = text.replace(/```json|```/g, '').trim();
        return JSON.parse(clean);
    } catch(e) {
        // Try to extract JSON from text
        const m = text.match(/\[[\s\S]*\]|\{[\s\S]*\}/);
        if (m) { try { return JSON.parse(m[0]); } catch(e2) {} }
        return null;
    }
}

// ============================================================
// GAMES ENGINE
// ============================================================
function openGame(gameId) {
    _sfx.click();
    const modal = document.getElementById('gameModal');
    modal.style.display = 'flex';
    const titles = {
        trivia:' Trivia Quiz', memory:' Memory Flip', scramble:' Word Scramble',
        reaction:' Reaction Tap', tiles2048:' 2048', snake:' Snake',
        emoji:' Emoji Guess', numguess:' Number Guess', riddles:' Pinoy Riddles', whack:' Whack-a-Mole'
    };
    document.getElementById('gameModalTitle').textContent = titles[gameId] || 'Game';
    document.getElementById('gameModalScore').textContent = '';
    document.getElementById('gameModalContent').innerHTML = '';
    const fns = { trivia:loadTrivia, memory:loadMemory, scramble:loadScramble, reaction:loadReaction,
        tiles2048:load2048, snake:loadSnake, emoji:loadEmoji, numguess:loadNumGuess,
        riddles:loadRiddles, whack:loadWhack };
    if (fns[gameId]) fns[gameId]();
    // update coins display
    if (window.userData) document.getElementById('gamesCoinsAmt').textContent = Number(window.userData.points||0).toLocaleString();
}

function closeGame() {
    _sfx.click();
    document.getElementById('gameModal').style.display = 'none';
    document.getElementById('gameModalContent').innerHTML = '';
    if (window._snakeInterval) { clearInterval(window._snakeInterval); window._snakeInterval = null; }
    if (window._whackInterval) { clearInterval(window._whackInterval); window._whackInterval = null; }
    if (window._2048KeyHandler) { document.removeEventListener('keydown', window._2048KeyHandler); window._2048KeyHandler = null; }
}

function gHTML(html) { document.getElementById('gameModalContent').innerHTML = html; }
function gScore(txt) { document.getElementById('gameModalScore').textContent = txt; }

// ============================================================
// 1. TRIVIA QUIZ  AI-powered
// ============================================================
async function loadTrivia() {
    const FALLBACK = [
        {q:"Ano ang kabisera ng Pilipinas?",choices:["Cebu","Manila","Davao","Quezon City"],a:1},
        {q:"Ilang pulo ang Pilipinas?",choices:["5,000","7,107","10,000","3,500"],a:1},
        {q:"Sino ang sumulat ng 'Noli Me Tangere'?",choices:["A. Bonifacio","E. Aguinaldo","J. Rizal","A. Mabini"],a:2},
        {q:"Ano ang pambansang ibon ng Pilipinas?",choices:["Maya","Philippine Eagle","Kalapati","Tikling"],a:1},
        {q:"Ilang bituin ang bandila ng Pilipinas?",choices:["3","5","8","12"],a:2},
        {q:"Ano ang pambansang hayop ng Pilipinas?",choices:["Carabao","Tamaraw","Tarsier","Eagle"],a:0},
        {q:"Saan matatagpuan ang Mayon Volcano?",choices:["Batangas","Albay","Cavite","Quezon"],a:1},
        {q:"Alin ang pinakamalaking lawa sa Pilipinas?",choices:["Laguna de Bay","Taal Lake","Lanao","Buhi"],a:0},
        {q:"Sino ang unang Pangulo ng Pilipinas?",choices:["M. Quezon","E. Aguinaldo","S. Osmea","J. Laurel"],a:1},
        {q:"Ilang miyembro ang Senado ng Pilipinas?",choices:["12","24","300","50"],a:1},
    ];
    
    gHTML(`<div style="text-align:center;padding:40px 20px;"><div style="font-size:40px;margin-bottom:12px;"></div><div style="font-size:14px;color:rgba(255,255,255,0.6);">Ginagawa ng AI ang mga tanong...</div></div>`);
    
    const prompt = `Generate 10 Filipino trivia questions about Philippines history, culture, geography, or famous Filipinos. Return ONLY valid JSON array, no other text:
[{"q":"question in Filipino or English","choices":["A","B","C","D"],"a":0}]
where "a" is the index (0-3) of the correct answer. Make questions fun and educational. Mix easy and medium difficulty.`;
    
    const raw = await aiGenerate(prompt, 'Gumagawa ng bagong trivia questions...');
    let questions = parseAIJson(raw);
    if (!questions || !Array.isArray(questions) || questions.length < 5) questions = FALLBACK;
    
    let idx = 0, score = 0;
    const el = document.getElementById('gameModalContent');

    function render() {
        if (idx >= questions.length) {
            _sfx.win();
            gScore('');
            const earnedPts = score * 5;
            awardGamePoints(earnedPts, 'Trivia Quiz (' + score + '/' + questions.length + ')');
            gHTML(`<div style="text-align:center;padding:40px 20px;">
                <div style="font-size:64px;margin-bottom:16px;">${score >= questions.length*0.8?'':score>=questions.length*0.5?'':''}</div>
                <div style="font-size:26px;font-weight:900;color:white;margin-bottom:8px;">TAPOS!</div>
                <div style="font-size:20px;color:#fbbf24;font-weight:800;margin-bottom:6px;">${score} / ${questions.length}</div>
                <div style="font-size:13px;color:rgba(255,255,255,0.5);margin-bottom:8px;">${score>=questions.length*0.8?'Kahanga-hanga! Expert ka!':score>=questions.length*0.5?'Magaling! Subukan pa ulit!':'Mag-aral pa, subukan ulit!'}</div>
                <div style="background:rgba(251,191,36,0.15);border:1px solid rgba(251,191,36,0.3);border-radius:12px;padding:10px 16px;margin-bottom:24px;font-size:15px;font-weight:800;color:#fbbf24;"> +${earnedPts} RB Coins nakuha!</div>
                <button onclick="loadTrivia()" style="background:linear-gradient(135deg,#8b5cf6,#6d28d9);border:none;color:white;font-size:14px;font-weight:800;padding:14px 32px;border-radius:14px;cursor:pointer;margin-bottom:12px;width:100%;"> Bagong AI Questions</button>
                <button onclick="closeGame()" style="background:rgba(255,255,255,0.07);border:1px solid rgba(255,255,255,0.12);color:rgba(255,255,255,0.6);font-size:13px;font-weight:700;padding:12px 24px;border-radius:12px;cursor:pointer;width:100%;"> Bumalik sa Games</button>
            </div>`);
            return;
        }
        const q = questions[idx];
        gScore(`${idx+1}/${questions.length}  ${score} pts`);
        el.innerHTML = `
            <div style="max-width:500px;margin:0 auto;">
                <div style="background:rgba(139,92,246,0.1);border:1px solid rgba(139,92,246,0.25);border-radius:16px;padding:20px;margin-bottom:16px;">
                    <div style="font-size:10px;color:rgba(255,255,255,0.35);font-weight:700;margin-bottom:10px;letter-spacing:1px;">TANONG ${idx+1}</div>
                    <div style="font-size:15px;font-weight:700;color:white;line-height:1.5;">${q.q}</div>
                </div>
                <div style="display:grid;gap:9px;" id="triviaChoices">
                    ${q.choices.map((c,i)=>`<button onclick="checkTrivia(${i})" id="tc${i}" style="background:rgba(255,255,255,0.05);border:1.5px solid rgba(255,255,255,0.1);border-radius:12px;padding:13px 16px;color:white;font-size:13px;font-weight:600;text-align:left;cursor:pointer;transition:all 0.15s;display:flex;align-items:center;gap:10px;"><span style="background:rgba(255,255,255,0.1);border-radius:8px;min-width:28px;height:28px;display:inline-flex;align-items:center;justify-content:center;font-size:11px;font-weight:800;flex-shrink:0;">${['A','B','C','D'][i]}</span><span>${c}</span></button>`).join('')}
                </div>
            </div>`;
    }

    window.checkTrivia = function(chosen) {
        const btns = document.querySelectorAll('[id^="tc"]');
        btns.forEach(b => b.style.pointerEvents = 'none');
        const correct = questions[idx].a;
        if (chosen === correct) { score++; _sfx.correct(); btns[chosen].style.background='rgba(16,185,129,0.3)'; btns[chosen].style.borderColor='#10b981'; }
        else { _sfx.wrong(); btns[chosen].style.background='rgba(239,68,68,0.3)'; btns[chosen].style.borderColor='#ef4444'; btns[correct].style.background='rgba(16,185,129,0.2)'; btns[correct].style.borderColor='#10b981'; }
        setTimeout(() => { idx++; render(); }, 1100);
    };
    render();
}

// ============================================================
// 2. MEMORY FLIP
// ============================================================
function loadMemory() {
    const SETS = [
        ['','','','','','','',''],
        ['','','','','','','',''],
        ['','','','','','','',''],
        ['','','','','','','',''],
    ];
    const emojis = SETS[Math.floor(Math.random()*SETS.length)];
    let cards = [...emojis,...emojis].sort(()=>Math.random()-0.5).map((e,i)=>({id:i,emoji:e,flipped:false,matched:false}));
    let flipping = [], moves = 0, matched = 0, locked = false;
    const el = document.getElementById('gameModalContent');

    function render() {
        gScore(`Moves: ${moves}  ${matched/2}/${emojis.length} pairs`);
        el.innerHTML = `<div style="max-width:340px;margin:0 auto;">
            <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:8px;" id="memGrid">
                ${cards.map(c=>`<div onclick="flipCard(${c.id})" id="mc${c.id}" style="height:72px;border-radius:12px;display:flex;align-items:center;justify-content:center;font-size:28px;cursor:pointer;border:2px solid;transition:all 0.25s;${c.matched?'background:rgba(16,185,129,0.15);border-color:rgba(16,185,129,0.5);cursor:default;':c.flipped?'background:rgba(6,182,212,0.15);border-color:rgba(6,182,212,0.5);':'background:rgba(255,255,255,0.04);border-color:rgba(255,255,255,0.08);'}">${c.flipped||c.matched?c.emoji:'<span style="font-size:22px;opacity:0.3;">?</span>'}</div>`).join('')}
            </div>
            ${matched===emojis.length*2?`<div style="text-align:center;margin-top:24px;"><div style="font-size:36px;margin-bottom:8px;"></div><div style="font-size:16px;font-weight:900;color:#fbbf24;margin-bottom:16px;">Natapos sa ${moves} moves!</div><button onclick="loadMemory()" style="background:linear-gradient(135deg,#06b6d4,#0891b2);border:none;color:white;font-size:14px;font-weight:800;padding:12px 28px;border-radius:12px;cursor:pointer;"> Ulit</button></div>`:''}
        </div>`;
    }

    window.flipCard = function(id) {
        const c = cards[id];
        if (locked || c.flipped || c.matched || flipping.length >= 2) return;
        _sfx.flip();
        c.flipped = true; flipping.push(c); render();
        if (flipping.length === 2) {
            locked = true; moves++;
            if (flipping[0].emoji === flipping[1].emoji) {
                _sfx.match(); flipping[0].matched=true; flipping[1].matched=true; matched+=2; flipping=[]; locked=false;
                if(matched===emojis.length*2) { _sfx.win(); awardGamePoints(30, 'Memory Flip'); }
                render();
            } else {
                setTimeout(()=>{ flipping.forEach(f=>f.flipped=false); flipping=[]; locked=false; render(); }, 900);
            }
        }
    };
    render();
}

// ============================================================
// 3. WORD SCRAMBLE  AI-powered
// ============================================================
async function loadScramble() {
    const FALLBACK = [
        {word:'PILIPINAS',hint:' Ating bansa'},{word:'MAHAL',hint:' Damdamin'},
        {word:'KALAYAAN',hint:' Freedom'},{word:'BAYANI',hint:' Hero'},
        {word:'MAGANDA',hint:' Beautiful'},{word:'SALAMAT',hint:' Pasasalamat'},
        {word:'KAIBIGAN',hint:' Friend'},{word:'MASAYA',hint:' Happy'},
        {word:'PAMILYA',hint:' Family'},{word:'MALAKAS',hint:' Strong'},
    ];
    
    gHTML(`<div style="text-align:center;padding:40px 20px;"><div style="font-size:40px;margin-bottom:12px;"></div><div style="font-size:14px;color:rgba(255,255,255,0.6);">Gumagawa ng bagong words...</div></div>`);
    
    const prompt = `Generate 10 Filipino words for a word scramble game. Mix easy and hard words. Return ONLY valid JSON array:
[{"word":"SALITA","hint":" Brief description in Filipino"}]
Use uppercase Filipino words only, 4-12 letters. Varied topics: nature, food, emotions, places, animals.`;
    
    const raw = await aiGenerate(prompt, 'Gumagawa ng bagong Filipino words...');
    let words = parseAIJson(raw);
    if (!words || !Array.isArray(words) || words.length < 5) words = FALLBACK;
    
    let idx = 0, score = 0;
    const el = document.getElementById('gameModalContent');

    function scramble(w) {
        let a = w.split('');
        do { a.sort(()=>Math.random()-0.5); } while(a.join('')===w && w.length>1);
        return a.join('');
    }

    function render() {
        if (idx >= words.length) {
            _sfx.win(); gScore('');
            const earnedPts = score * 8;
            awardGamePoints(earnedPts, 'Word Scramble (' + score + '/' + words.length + ')');
            gHTML(`<div style="text-align:center;padding:40px 20px;">
                <div style="font-size:64px;margin-bottom:16px;"></div>
                <div style="font-size:22px;font-weight:900;color:white;margin-bottom:8px;">TAPOS!</div>
                <div style="font-size:20px;color:#fbbf24;font-weight:800;margin-bottom:8px;">${score} / ${words.length}</div>
                <div style="background:rgba(251,191,36,0.15);border:1px solid rgba(251,191,36,0.3);border-radius:12px;padding:10px 16px;margin-bottom:20px;font-size:15px;font-weight:800;color:#fbbf24;"> +${earnedPts} RB Coins nakuha!</div>
                <button onclick="loadScramble()" style="background:linear-gradient(135deg,#f59e0b,#d97706);border:none;color:white;font-size:14px;font-weight:800;padding:14px 32px;border-radius:14px;cursor:pointer;width:100%;margin-bottom:10px;"> Bagong AI Words</button>
                <button onclick="closeGame()" style="background:rgba(255,255,255,0.07);border:1px solid rgba(255,255,255,0.12);color:rgba(255,255,255,0.6);font-size:13px;padding:12px 24px;border-radius:12px;cursor:pointer;width:100%;"> Bumalik</button>
            </div>`);
            return;
        }
        const {word,hint} = words[idx];
        const sc = scramble(word);
        gScore(`${idx+1}/${words.length}  Score: ${score}`);
        el.innerHTML = `<div style="max-width:500px;margin:0 auto;">
            <div style="text-align:center;margin-bottom:24px;">
                <div style="font-size:12px;color:rgba(255,255,255,0.4);margin-bottom:6px;">${hint}</div>
                <div style="font-size:34px;font-weight:900;color:#fbbf24;letter-spacing:8px;background:rgba(251,191,36,0.08);border:1px solid rgba(251,191,36,0.2);border-radius:14px;padding:20px 16px;">${sc}</div>
            </div>
            <div style="display:flex;gap:10px;margin-bottom:12px;">
                <input id="scrIn" type="text" placeholder="I-type ang sagot..." maxlength="${word.length+2}" autocomplete="off" autocorrect="off" autocapitalize="characters" style="flex:1;background:rgba(255,255,255,0.06);border:1.5px solid rgba(255,255,255,0.15);border-radius:12px;padding:14px;color:white;font-size:16px;font-weight:700;outline:none;text-transform:uppercase;" onkeydown="if(event.key==='Enter'){_sfx.tap();checkScramble('${word}');}">
                <button onclick="_sfx.tap();checkScramble('${word}')" style="background:linear-gradient(135deg,#f59e0b,#d97706);border:none;color:white;font-size:13px;font-weight:800;padding:0 18px;border-radius:12px;cursor:pointer;">CHECK</button>
            </div>
            <button onclick="skipScramble('${word}')" style="width:100%;background:rgba(255,255,255,0.04);border:1px solid rgba(255,255,255,0.08);color:rgba(255,255,255,0.4);font-size:12px;font-weight:700;padding:11px;border-radius:12px;cursor:pointer;"> I-skip</button>
            <div id="scrMsg" style="text-align:center;margin-top:12px;font-size:13px;font-weight:700;min-height:20px;"></div>
        </div>`;
        setTimeout(()=>{ const el=document.getElementById('scrIn'); if(el) el.focus(); },100);
    }

    window.checkScramble = function(word) {
        const input = document.getElementById('scrIn'); if(!input) return;
        const val = input.value.trim().toUpperCase().replace(/\s/g,'');
        const msg = document.getElementById('scrMsg');
        if (val === word) {
            score++; _sfx.correct();
            msg.textContent=' Tama!'; msg.style.color='#10b981';
            setTimeout(()=>{idx++;render();},700);
        } else {
            _sfx.wrong();
            msg.textContent=' Mali! Subukan ulit...'; msg.style.color='#ef4444';
            input.style.borderColor='#ef4444';
            setTimeout(()=>{ input.style.borderColor='rgba(255,255,255,0.15)'; msg.textContent=''; input.value=''; },700);
        }
    };
    window.skipScramble = function(word) {
        _sfx.wrong();
        const msg=document.getElementById('scrMsg');
        msg.textContent='Sagot: '+word; msg.style.color='#fbbf24';
        setTimeout(()=>{idx++;render();},1100);
    };
    render();
}

// ============================================================
// 4. REACTION TAP
// ============================================================
function loadReaction() {
    const el = document.getElementById('gameModalContent');
    let round=0, scores=[], waiting=false, tStart=0, timer=null;
    function render() {
        if (round >= 5) {
            const avg=Math.round(scores.reduce((a,b)=>a+b,0)/scores.length);
            const best=Math.min(...scores);
            const grade=avg<200?' SUPERHERO':avg<300?' ULTRA FAST':avg<450?' MABILIS':avg<600?' AVERAGE':' MABAGAL';
            const earnedPts = avg<200?50:avg<300?40:avg<450?30:avg<600?20:10;
            _sfx.win(); gScore('');
            awardGamePoints(earnedPts, 'Reaction Tap (' + avg + 'ms avg)');
            gHTML(`<div style="text-align:center;padding:30px 20px;">
                <div style="font-size:48px;margin-bottom:12px;"></div>
                <div style="font-size:22px;font-weight:900;color:white;margin-bottom:4px;">RESULTA</div>
                <div style="font-size:40px;font-weight:900;color:#fbbf24;margin-bottom:4px;">${avg}ms</div>
                <div style="font-size:12px;color:rgba(255,255,255,0.4);margin-bottom:8px;">Average</div>
                <div style="font-size:20px;font-weight:900;margin:16px 0;color:#8b5cf6;">${grade}</div>
                <div style="background:rgba(251,191,36,0.15);border:1px solid rgba(251,191,36,0.3);border-radius:12px;padding:10px 16px;margin-bottom:16px;font-size:15px;font-weight:800;color:#fbbf24;"> +${earnedPts} RB Coins nakuha!</div>
                <div style="display:flex;flex-direction:column;gap:6px;margin-bottom:24px;max-width:260px;margin-left:auto;margin-right:auto;">
                    ${scores.map((s,i)=>`<div style="background:rgba(255,255,255,0.05);border-radius:10px;padding:8px 16px;display:flex;justify-content:space-between;"><span style="color:rgba(255,255,255,0.4);font-size:12px;">Round ${i+1}</span><span style="font-weight:800;font-size:13px;color:${s<300?'#10b981':s<500?'#fbbf24':'#ef4444'}">${s}ms</span></div>`).join('')}
                </div>
                <button onclick="loadReaction()" style="background:linear-gradient(135deg,#10b981,#059669);border:none;color:white;font-size:14px;font-weight:800;padding:14px 32px;border-radius:14px;cursor:pointer;width:100%;"> Ulit</button>
            </div>`);
            return;
        }
        gScore(`Round ${round+1}/5`);
        el.innerHTML = `<div style="text-align:center;padding:20px;max-width:340px;margin:0 auto;">
            <div id="rBox" onclick="tapReaction()" style="background:rgba(239,68,68,0.12);border:2px solid rgba(239,68,68,0.3);border-radius:24px;padding:64px 20px;cursor:pointer;transition:all 0.2s;margin-bottom:20px;">
                <div id="rEmoji" style="font-size:72px;margin-bottom:12px;"></div>
                <div id="rTxt" style="font-size:15px;font-weight:700;color:rgba(255,255,255,0.5);">Hintayin ang ...</div>
            </div>
            <div style="display:flex;gap:8px;justify-content:center;">
                ${scores.map((s,i)=>`<div style="background:${s<300?'rgba(16,185,129,0.3)':s<500?'rgba(251,191,36,0.3)':'rgba(239,68,68,0.3)'};border-radius:8px;padding:4px 10px;font-size:11px;font-weight:800;color:white;">${s}ms</div>`).join('')}
            </div>
        </div>`;
        waiting=true;
        const delay=1200+Math.random()*3000;
        timer=setTimeout(()=>{
            waiting=false; tStart=Date.now(); _sfx.tick();
            const box=document.getElementById('rBox'),emoji=document.getElementById('rEmoji'),txt=document.getElementById('rTxt');
            if(box){box.style.background='rgba(16,185,129,0.2)';box.style.borderColor='rgba(16,185,129,0.6)';}
            if(emoji) emoji.textContent='';
            if(txt){txt.textContent='TAP NGAYON!';txt.style.color='#10b981';}
        },delay);
    }
    window.tapReaction=function(){
        if(waiting){
            clearTimeout(timer); waiting=false; _sfx.wrong();
            const txt=document.getElementById('rTxt'),box=document.getElementById('rBox');
            if(txt) txt.textContent=' Maaga! Hintayin ang GREEN...';
            if(box){box.style.background='rgba(251,191,36,0.1)';box.style.borderColor='rgba(251,191,36,0.4)';}
            setTimeout(()=>render(),1000); return;
        }
        if(!tStart) return;
        const elapsed=Date.now()-tStart; tStart=0;
        scores.push(elapsed); round++;
        const txt=document.getElementById('rTxt');
        _sfx.correct();
        if(txt) txt.textContent=`${elapsed}ms! ${elapsed<250?' Sobrang bilis!':elapsed<400?' Magaling!':' OK yan!'}`;
        setTimeout(()=>render(),800);
    };
    render();
}

// ============================================================
// 5. 2048 TILES
// ============================================================
function load2048() {
    const el=document.getElementById('gameModalContent');
    let board,score,best=window._2048Best||0,gameOver;
    const TC={2:'#eee4da',4:'#ede0c8',8:'#f2b179',16:'#f59563',32:'#f67c5f',64:'#f65e3b',128:'#edcf72',256:'#edcc61',512:'#edc850',1024:'#edc53f',2048:'#edc22e'};

    function newGame(){
        board=Array(4).fill(null).map(()=>Array(4).fill(0));
        score=0;gameOver=false;addTile();addTile();render();
    }
    function addTile(){
        const e=[];for(let r=0;r<4;r++)for(let c=0;c<4;c++)if(!board[r][c])e.push([r,c]);
        if(!e.length)return;
        const[r,c]=e[Math.floor(Math.random()*e.length)];
        board[r][c]=Math.random()<0.9?2:4;
    }
    function slideRow(row){
        let arr=row.filter(x=>x),orig=row.join(',');
        for(let i=0;i<arr.length-1;i++){if(arr[i]===arr[i+1]){arr[i]*=2;score+=arr[i];arr.splice(i+1,1);}}
        while(arr.length<4)arr.push(0);
        return{row:arr,changed:arr.join(',')!==orig};
    }
    function move(dir){
        if(gameOver)return;
        let moved=false;
        function proc(rows){return rows.map(row=>{const r=slideRow(row);if(r.changed)moved=true;return r.row;});}
        if(dir==='left')board=proc(board);
        else if(dir==='right')board=proc(board.map(r=>[...r].reverse())).map(r=>r.reverse());
        else if(dir==='up'){let t=board[0].map((_,c)=>board.map(r=>r[c]));t=proc(t);board=board.map((_,r)=>t.map(col=>col[r]));}
        else{let t=board[0].map((_,c)=>board.map(r=>r[c]).reverse());t=proc(t);board=board.map((_,r)=>t.map(col=>col.reverse()[r]));}
        if(moved){_sfx.merge();addTile();if(score>best){best=score;window._2048Best=best;}render();}
        if(!canMove()){gameOver=true;_sfx.lose();awardGamePoints(Math.max(5, Math.floor(score/100)), '2048 Tiles (score:'+score+')');render();}
    }
    function canMove(){
        for(let r=0;r<4;r++)for(let c=0;c<4;c++){
            if(!board[r][c])return true;
            if(c<3&&board[r][c]===board[r][c+1])return true;
            if(r<3&&board[r][c]===board[r+1][c])return true;
        }return false;
    }
    function render(){
        gScore(`Score: ${score} | Best: ${best}`);
        el.innerHTML=`<div style="max-width:320px;margin:0 auto;">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;">
                <div style="font-size:26px;font-weight:900;color:#fbbf24;">2048</div>
                <button onclick="load2048()" style="background:rgba(255,255,255,0.08);border:1px solid rgba(255,255,255,0.12);color:white;border-radius:10px;padding:7px 14px;cursor:pointer;font-size:12px;font-weight:700;">NEW</button>
            </div>
            <div id="b2048" style="background:rgba(30,41,59,0.6);border-radius:14px;padding:8px;display:grid;grid-template-columns:repeat(4,1fr);gap:6px;touch-action:none;">
                ${board.flat().map(v=>`<div style="height:68px;border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:${v>=1024?14:v>=100?18:20}px;font-weight:900;background:${v?TC[v]||'#3c3a32':'rgba(255,255,255,0.03)'};color:${v<=4?'#776e65':'#f9f6f2'};transition:all 0.1s;">${v||''}</div>`).join('')}
            </div>
            ${gameOver?`<div style="text-align:center;margin-top:16px;"><div style="font-size:16px;font-weight:900;color:#ef4444;margin-bottom:10px;">GAME OVER!</div><button onclick="load2048()" style="background:linear-gradient(135deg,#fbbf24,#d97706);border:none;color:white;font-size:13px;font-weight:800;padding:11px 26px;border-radius:12px;cursor:pointer;"> Ulit</button></div>`:''}
            <div style="margin-top:10px;text-align:center;font-size:11px;color:rgba(255,255,255,0.25);">Swipe o arrow keys  Pagsamahin ang tiles!</div>
        </div>`;
        let sx=0,sy=0;
        const bd=document.getElementById('b2048');
        if(bd){
            bd.addEventListener('touchstart',e=>{sx=e.touches[0].clientX;sy=e.touches[0].clientY;},{passive:true});
            bd.addEventListener('touchend',e=>{const dx=e.changedTouches[0].clientX-sx,dy=e.changedTouches[0].clientY-sy;if(Math.abs(dx)>Math.abs(dy))move(dx>0?'right':'left');else move(dy>0?'down':'up');},{passive:true});
        }
    }
    window._2048KeyHandler=(e)=>{const m={ArrowLeft:'left',ArrowRight:'right',ArrowUp:'up',ArrowDown:'down'};if(m[e.key]){e.preventDefault();move(m[e.key]);}};
    document.addEventListener('keydown',window._2048KeyHandler);
    newGame();
}

// ============================================================
// 6. SNAKE
// ============================================================
function loadSnake(){
    const el=document.getElementById('gameModalContent');
    el.innerHTML=`<div style="max-width:320px;margin:0 auto;text-align:center;">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;">
            <div style="font-size:12px;color:rgba(255,255,255,0.5);">Score: <span id="sSc" style="font-weight:900;color:#10b981;font-size:14px;">0</span></div>
            <button onclick="loadSnake()" style="background:rgba(255,255,255,0.08);border:1px solid rgba(255,255,255,0.12);color:white;border-radius:8px;padding:6px 12px;cursor:pointer;font-size:11px;font-weight:700;"> Reset</button>
            <div style="font-size:12px;color:rgba(255,255,255,0.5);">Best: <span id="sBs" style="font-weight:900;color:#fbbf24;font-size:14px;">${window._snakeBest||0}</span></div>
        </div>
        <canvas id="snakeC" width="300" height="300" style="border-radius:14px;border:2px solid rgba(16,185,129,0.25);background:#050d1a;display:block;margin:0 auto;"></canvas>
        <div style="display:grid;grid-template-columns:1fr 1fr 1fr;grid-template-rows:auto auto;gap:8px;max-width:180px;margin:14px auto 0;">
            <div></div><button onclick="sD('up')" style="background:rgba(255,255,255,0.08);border:1px solid rgba(255,255,255,0.12);color:white;border-radius:10px;padding:13px;cursor:pointer;font-size:16px;"></button><div></div>
            <button onclick="sD('left')" style="background:rgba(255,255,255,0.08);border:1px solid rgba(255,255,255,0.12);color:white;border-radius:10px;padding:13px;cursor:pointer;font-size:16px;"></button>
            <button onclick="sD('down')" style="background:rgba(255,255,255,0.08);border:1px solid rgba(255,255,255,0.12);color:white;border-radius:10px;padding:13px;cursor:pointer;font-size:16px;"></button>
            <button onclick="sD('right')" style="background:rgba(255,255,255,0.08);border:1px solid rgba(255,255,255,0.12);color:white;border-radius:10px;padding:13px;cursor:pointer;font-size:16px;"></button>
        </div>
    </div>`;
    const SZ=20,C=15,R=15;
    let snake=[{x:7,y:7},{x:6,y:7},{x:5,y:7}],dir={x:1,y:0},nDir={x:1,y:0};
    let food=rFood(),score=0,alive=true,best=window._snakeBest||0;
    function rFood(){let f;do{f={x:Math.floor(Math.random()*C),y:Math.floor(Math.random()*R)};}while(snake.some(s=>s.x===f.x&&s.y===f.y));return f;}
    function draw(){
        const cv=document.getElementById('snakeC');if(!cv){clearInterval(window._snakeInterval);return;}
        const ctx=cv.getContext('2d');
        ctx.fillStyle='#050d1a';ctx.fillRect(0,0,300,300);
        ctx.strokeStyle='rgba(255,255,255,0.03)';
        for(let i=0;i<=C;i++){ctx.beginPath();ctx.moveTo(i*SZ,0);ctx.lineTo(i*SZ,300);ctx.stroke();}
        for(let i=0;i<=R;i++){ctx.beginPath();ctx.moveTo(0,i*SZ);ctx.lineTo(300,i*SZ);ctx.stroke();}
        ctx.fillStyle='#ef4444';ctx.beginPath();ctx.arc(food.x*SZ+SZ/2,food.y*SZ+SZ/2,SZ/2-2,0,Math.PI*2);ctx.fill();
        snake.forEach((s,i)=>{
            ctx.fillStyle=i===0?'#10b981':`rgba(16,185,129,${Math.max(0.2,0.9-i*0.04)})`;
            ctx.beginPath();ctx.roundRect(s.x*SZ+1,s.y*SZ+1,SZ-2,SZ-2,4);ctx.fill();
        });
        if(!alive){
            ctx.fillStyle='rgba(0,0,0,0.75)';ctx.fillRect(0,0,300,300);
            ctx.fillStyle='white';ctx.font='bold 20px sans-serif';ctx.textAlign='center';ctx.fillText('GAME OVER!',150,120);
            ctx.fillStyle='#fbbf24';ctx.font='bold 15px sans-serif';ctx.fillText('Score: '+score,150,150);
            ctx.fillStyle='rgba(255,255,255,0.5)';ctx.font='12px sans-serif';ctx.fillText('Pindutin ang Reset',150,178);
        }
    }
    function step(){
        if(!alive)return;
        dir={...nDir};
        const h={x:snake[0].x+dir.x,y:snake[0].y+dir.y};
        if(h.x<0||h.x>=C||h.y<0||h.y>=R||snake.some(s=>s.x===h.x&&s.y===h.y)){
            alive=false;_sfx.lose();awardGamePoints(Math.max(5, Math.floor(score/10)), 'Snake Game (score:'+score+')');draw();
            if(score>best){best=score;window._snakeBest=best;const el=document.getElementById('sBs');if(el)el.textContent=best;}
            return;
        }
        snake.unshift(h);
        if(h.x===food.x&&h.y===food.y){score+=10;_sfx.eat();food=rFood();const el=document.getElementById('sSc');if(el)el.textContent=score;gScore(`Score: ${score}`);}
        else snake.pop();
        draw();
    }
    window.sD=function(d){const m={up:{x:0,y:-1},down:{x:0,y:1},left:{x:-1,y:0},right:{x:1,y:0}};const nd=m[d];if(dir.x+nd.x!==0||dir.y+nd.y!==0)nDir=nd;};
    const cv=document.getElementById('snakeC');
    let ts={x:0,y:0};
    cv.addEventListener('touchstart',e=>{ts.x=e.touches[0].clientX;ts.y=e.touches[0].clientY;},{passive:true});
    cv.addEventListener('touchend',e=>{const dx=e.changedTouches[0].clientX-ts.x,dy=e.changedTouches[0].clientY-ts.y;if(Math.abs(dx)>Math.abs(dy))window.sD(dx>0?'right':'left');else window.sD(dy>0?'down':'up');},{passive:true});
    draw();
    window._snakeInterval=setInterval(step,150);
}

// ============================================================
// 7. EMOJI GUESS  AI-powered
// ============================================================
async function loadEmoji(){
    const FALLBACK=[
        {emojis:'',answer:'TITANIC',hint:' Pelikula 1997'},
        {emojis:'',answer:'LION KING',hint:' Disney Movie'},
        {emojis:'',answer:'SPIDER-MAN',hint:' Superhero'},
        {emojis:'',answer:'FROZEN',hint:' Disney Movie'},
        {emojis:'',answer:'STAR WARS',hint:' Sci-Fi'},
        {emojis:'',answer:'THE MATRIX',hint:' Sci-Fi'},
        {emojis:'',answer:'LORD OF THE RINGS',hint:' Fantasy'},
        {emojis:'',answer:'FINDING NEMO',hint:' Animated'},
        {emojis:'',answer:'AVENGERS',hint:' Marvel'},
        {emojis:'',answer:'MOANA',hint:' Disney'},
    ];
    
    gHTML(`<div style="text-align:center;padding:40px 20px;"><div style="font-size:40px;margin-bottom:12px;"></div><div style="font-size:14px;color:rgba(255,255,255,0.6);">Gumagawa ng AI emoji puzzles...</div></div>`);
    
    const prompt = `Create 10 creative emoji puzzles representing famous movies, songs, or Filipino phrases. Return ONLY valid JSON:
[{"emojis":"","answer":"TITANIC","hint":" Hollywood Movie"}]
Mix: Hollywood movies, Disney, Filipino movies/phrases, popular songs. Make them fun and recognizable. Answers in ENGLISH uppercase.`;
    
    const raw = await aiGenerate(prompt, 'Gumagawa ng emoji puzzles...');
    let puzzles = parseAIJson(raw);
    if (!puzzles || !Array.isArray(puzzles) || puzzles.length < 5) puzzles = FALLBACK;
    puzzles = puzzles.sort(()=>Math.random()-0.5);
    
    let idx=0,score=0;
    const el=document.getElementById('gameModalContent');
    
    function render(){
        if(idx>=puzzles.length){
            _sfx.win();gScore('');
            const earnedPts = score * 8;
            awardGamePoints(earnedPts, 'Emoji Guessing (' + score + '/' + puzzles.length + ')');
            gHTML(`<div style="text-align:center;padding:40px 20px;">
                <div style="font-size:64px;margin-bottom:16px;"></div>
                <div style="font-size:22px;font-weight:900;color:white;margin-bottom:8px;">TAPOS!</div>
                <div style="font-size:20px;color:#fbbf24;font-weight:800;margin-bottom:8px;">${score} / ${puzzles.length}</div>
                <div style="background:rgba(251,191,36,0.15);border:1px solid rgba(251,191,36,0.3);border-radius:12px;padding:10px 16px;margin-bottom:20px;font-size:15px;font-weight:800;color:#fbbf24;"> +${earnedPts} RB Coins nakuha!</div>
                <button onclick="loadEmoji()" style="background:linear-gradient(135deg,#f472b6,#db2777);border:none;color:white;font-size:14px;font-weight:800;padding:14px 32px;border-radius:14px;cursor:pointer;width:100%;margin-bottom:10px;"> Bagong AI Puzzles</button>
                <button onclick="closeGame()" style="background:rgba(255,255,255,0.07);border:1px solid rgba(255,255,255,0.12);color:rgba(255,255,255,0.6);font-size:13px;padding:12px 24px;border-radius:12px;cursor:pointer;width:100%;"> Bumalik</button>
            </div>`);
            return;
        }
        const p=puzzles[idx];
        const ans=p.answer.toUpperCase().replace(/[^A-Z0-9\s]/g,'');
        gScore(`${idx+1}/${puzzles.length}  ${score} pts`);
        el.innerHTML=`<div style="max-width:500px;margin:0 auto;">
            <div style="text-align:center;margin-bottom:24px;">
                <div style="font-size:12px;color:rgba(255,255,255,0.4);margin-bottom:10px;">${p.hint||' Ano ito?'}</div>
                <div style="font-size:54px;background:rgba(244,114,182,0.08);border:1px solid rgba(244,114,182,0.2);border-radius:20px;padding:24px 16px;letter-spacing:6px;">${p.emojis}</div>
            </div>
            <div style="display:flex;gap:10px;margin-bottom:12px;">
                <input id="emoIn" type="text" placeholder="Ano ito?" autocomplete="off" autocorrect="off" style="flex:1;background:rgba(255,255,255,0.06);border:1.5px solid rgba(255,255,255,0.15);border-radius:12px;padding:14px;color:white;font-size:15px;font-weight:700;outline:none;text-transform:uppercase;" onkeydown="if(event.key==='Enter'){_sfx.tap();checkEmoji('${ans.replace(/'/g,"\\'")}');}">
                <button onclick="_sfx.tap();checkEmoji('${ans.replace(/'/g,"\\'")}${""}')" style="background:linear-gradient(135deg,#f472b6,#db2777);border:none;color:white;font-size:13px;font-weight:800;padding:0 18px;border-radius:12px;cursor:pointer;">GO!</button>
            </div>
            <button onclick="skipEmoji('${p.answer.replace(/'/g,"\\'")}${""}')" style="width:100%;background:rgba(255,255,255,0.04);border:1px solid rgba(255,255,255,0.08);color:rgba(255,255,255,0.4);font-size:12px;font-weight:700;padding:11px;border-radius:12px;cursor:pointer;"> I-skip</button>
            <div id="emoMsg" style="text-align:center;margin-top:12px;font-size:13px;font-weight:700;min-height:20px;"></div>
        </div>`;
        setTimeout(()=>{const e=document.getElementById('emoIn');if(e)e.focus();},100);
    }
    window.checkEmoji=function(answer){
        const input=document.getElementById('emoIn');if(!input)return;
        const val=input.value.trim().toUpperCase().replace(/[^A-Z0-9\s]/g,'');
        const ans=answer.toUpperCase().replace(/[^A-Z0-9\s]/g,'');
        const msg=document.getElementById('emoMsg');
        if(val===ans||(val.length>3&&ans.includes(val))){
            score++;_sfx.correct();msg.textContent=' Tama! '+answer;msg.style.color='#10b981';
            setTimeout(()=>{idx++;render();},800);
        }else{_sfx.wrong();msg.textContent=' Mali!';msg.style.color='#ef4444';}
    };
    window.skipEmoji=function(answer){
        _sfx.wrong();const msg=document.getElementById('emoMsg');
        msg.textContent='Sagot: '+answer;msg.style.color='#fbbf24';
        setTimeout(()=>{idx++;render();},1100);
    };
    render();
}

// ============================================================
// 8. NUMBER GUESS
// ============================================================
function loadNumGuess(){
    const el=document.getElementById('gameModalContent');
    let target=Math.floor(Math.random()*100)+1,attempts=0,maxAttempts=7,gameOver=false;
    gScore(`${maxAttempts} tries left`);
    
    function render(msg,msgColor){
        el.innerHTML=`<div style="max-width:400px;margin:0 auto;text-align:center;">
            <div style="font-size:64px;margin-bottom:16px;filter:blur(${gameOver?0:6}px);transition:filter 0.3s;">${target}</div>
            <div style="font-size:13px;color:rgba(255,255,255,0.5);margin-bottom:20px;">Hulaan ang numero mula 1 hanggang 100</div>
            <div style="display:flex;gap:8px;margin-bottom:16px;align-items:center;justify-content:center;">
                ${Array(maxAttempts).fill(0).map((_,i)=>`<div style="width:10px;height:10px;border-radius:50%;background:${i<attempts?'rgba(239,68,68,0.7)':'rgba(255,255,255,0.15)'}"></div>`).join('')}
            </div>
            ${gameOver?'':`<div style="display:flex;gap:10px;margin-bottom:16px;">
                <input id="ngIn" type="number" min="1" max="100" placeholder="1-100" style="flex:1;background:rgba(255,255,255,0.06);border:1.5px solid rgba(255,255,255,0.15);border-radius:12px;padding:14px;color:white;font-size:18px;font-weight:800;outline:none;text-align:center;" onkeydown="if(event.key==='Enter'){_sfx.tap();guessNum();}">
                <button onclick="_sfx.tap();guessNum()" style="background:linear-gradient(135deg,#a78bfa,#7c3aed);border:none;color:white;font-size:14px;font-weight:800;padding:0 20px;border-radius:12px;cursor:pointer;">GUESS</button>
            </div>`}
            ${msg?`<div style="font-size:16px;font-weight:800;color:${msgColor||'white'};margin-bottom:16px;">${msg}</div>`:''}
            ${gameOver?`<button onclick="loadNumGuess()" style="background:linear-gradient(135deg,#a78bfa,#7c3aed);border:none;color:white;font-size:14px;font-weight:800;padding:14px 32px;border-radius:14px;cursor:pointer;width:100%;"> Bagong Laro</button>`:''}
        </div>`;
        if(!gameOver) setTimeout(()=>{const e=document.getElementById('ngIn');if(e)e.focus();},100);
    }
    
    window.guessNum=function(){
        const input=document.getElementById('ngIn');if(!input)return;
        const val=parseInt(input.value);
        if(!val||val<1||val>100){input.style.borderColor='#ef4444';setTimeout(()=>input.style.borderColor='rgba(255,255,255,0.15)',500);return;}
        attempts++;
        if(val===target){
            const earnedPts = Math.max(10, (maxAttempts - attempts + 1) * 10);
            _sfx.win();gameOver=true;gScore('');
            awardGamePoints(earnedPts, 'Number Guess ('+attempts+' tries)');
            render(` TAMA! Ang sagot ay ${target}! (+${earnedPts} coins) (${attempts} tries)`,'#10b981');
        } else if(attempts>=maxAttempts){
            _sfx.lose();gameOver=true;gScore('');
            render(` Talo ka! Ang sagot ay ${target}. Better luck next time!`,'#ef4444');
        } else {
            const diff=Math.abs(val-target);
            const hint=val<target?' Mas mataas!':' Mas mababa!';
            const temp=diff<=5?' NAPAKAINIT! Malapit ka na!':diff<=15?' Mainit...':diff<=30?' Malamig...':' Sobrang lamig!';
            _sfx.tick();
            gScore(`${maxAttempts-attempts} tries left`);
            render(`${hint} ${temp}`,'#fbbf24');
        }
    };
    render();
}

// ============================================================
// 9. PINOY RIDDLES  AI-powered
// ============================================================
async function loadRiddles(){
    const FALLBACK=[
        {riddle:'May paa ngunit hindi makalakad. Ano ito?',answer:'mesa',hint:'Gamit sa bahay'},
        {riddle:'Pumapasok nang nakatayo, lumalabas nang nakahiga. Ano ito?',answer:'pako',hint:'Gamit sa pagtatayo'},
        {riddle:'Kahit gaano katagal, hindi mapagod ang tumatakbo. Ano ito?',answer:'tubig',hint:'Likido'},
        {riddle:'Palaging nakasuot ng putong ang hari. Ano ito?',answer:'niyog',hint:'Prutas/puno'},
        {riddle:'Ang ama ko ay maitim, ang nanay ko ay pula, ako ay berde. Ano ito?',answer:'mangga',hint:'Prutas'},
        {riddle:'Isang bagay, kahit gaano karami ang nasa loob nito, hindi mapuno. Ano ito?',answer:'butas',hint:'Hindi makita pero maramdaman'},
        {riddle:'Puti kung araw, pula kung gabi. Ano ito?',answer:'kalabaw',hint:'Hayop'},
        {riddle:'Makikita ngunit hindi mahawakan. Ano ito?',answer:'anino',hint:'May liwanag'},
    ];
    
    gHTML(`<div style="text-align:center;padding:40px 20px;"><div style="font-size:40px;margin-bottom:12px;"></div><div style="font-size:14px;color:rgba(255,255,255,0.6);">Gumagawa ng Pinoy riddles...</div></div>`);
    
    const prompt=`Create 8 traditional Filipino bugtong (riddles). Return ONLY valid JSON array:
[{"riddle":"Filipino riddle text here","answer":"answer in Filipino lowercase","hint":"category hint"}]
Use authentic Filipino bugtong style. Varied topics: nature, household items, body parts, food. Make them fun and appropriate for all ages.`;
    
    const raw=await aiGenerate(prompt,'Gumagawa ng bugtong at palaisipan...');
    let riddles=parseAIJson(raw);
    if(!riddles||!Array.isArray(riddles)||riddles.length<4) riddles=FALLBACK;
    
    let idx=0,score=0,revealed=false;
    const el=document.getElementById('gameModalContent');
    
    function render(){
        if(idx>=riddles.length){
            _sfx.win();gScore('');
            const earnedPts = score * 8;
            awardGamePoints(earnedPts, 'Pinoy Riddles (' + score + '/' + riddles.length + ')');
            gHTML(`<div style="text-align:center;padding:40px 20px;">
                <div style="font-size:64px;margin-bottom:16px;"></div>
                <div style="font-size:22px;font-weight:900;color:white;margin-bottom:8px;">TAPOS!</div>
                <div style="font-size:20px;color:#fbbf24;font-weight:800;margin-bottom:8px;">${score} / ${riddles.length}</div>
                <div style="background:rgba(251,191,36,0.15);border:1px solid rgba(251,191,36,0.3);border-radius:12px;padding:10px 16px;margin-bottom:20px;font-size:15px;font-weight:800;color:#fbbf24;"> +${earnedPts} RB Coins nakuha!</div>
                <button onclick="loadRiddles()" style="background:linear-gradient(135deg,#34d399,#059669);border:none;color:white;font-size:14px;font-weight:800;padding:14px 32px;border-radius:14px;cursor:pointer;width:100%;margin-bottom:10px;"> Bagong AI Riddles</button>
                <button onclick="closeGame()" style="background:rgba(255,255,255,0.07);border:1px solid rgba(255,255,255,0.12);color:rgba(255,255,255,0.6);font-size:13px;padding:12px 24px;border-radius:12px;cursor:pointer;width:100%;"> Bumalik</button>
            </div>`);
            return;
        }
        const r=riddles[idx];
        revealed=false;
        gScore(`${idx+1}/${riddles.length}  ${score} pts`);
        el.innerHTML=`<div style="max-width:500px;margin:0 auto;">
            <div style="background:rgba(52,211,153,0.08);border:1px solid rgba(52,211,153,0.2);border-radius:18px;padding:24px;margin-bottom:20px;text-align:center;">
                <div style="font-size:11px;color:rgba(255,255,255,0.35);font-weight:700;letter-spacing:1px;margin-bottom:12px;">BUGTONG</div>
                <div style="font-size:16px;font-weight:700;color:white;line-height:1.6;font-style:italic;">"${r.riddle}"</div>
                ${r.hint?`<div style="font-size:11px;color:rgba(255,255,255,0.35);margin-top:10px;">Hint: ${r.hint}</div>`:''}
            </div>
            <div style="display:flex;gap:10px;margin-bottom:12px;">
                <input id="rdIn" type="text" placeholder="Ano ang sagot?" autocomplete="off" autocorrect="off" style="flex:1;background:rgba(255,255,255,0.06);border:1.5px solid rgba(255,255,255,0.15);border-radius:12px;padding:14px;color:white;font-size:15px;font-weight:700;outline:none;" onkeydown="if(event.key==='Enter'){_sfx.tap();checkRiddle('${r.answer.replace(/'/g,"\\'")}');}">
                <button onclick="_sfx.tap();checkRiddle('${r.answer.replace(/'/g,"\\'")}${""}')" style="background:linear-gradient(135deg,#34d399,#059669);border:none;color:white;font-size:13px;font-weight:800;padding:0 18px;border-radius:12px;cursor:pointer;">SAGOT</button>
            </div>
            <button onclick="revealRiddle('${r.answer.replace(/'/g,"\\'")}${""}')" style="width:100%;background:rgba(255,255,255,0.04);border:1px solid rgba(255,255,255,0.08);color:rgba(255,255,255,0.4);font-size:12px;font-weight:700;padding:11px;border-radius:12px;cursor:pointer;"> Ipakita ang sagot</button>
            <div id="rdMsg" style="text-align:center;margin-top:12px;font-size:14px;font-weight:700;min-height:20px;"></div>
        </div>`;
        setTimeout(()=>{const e=document.getElementById('rdIn');if(e)e.focus();},100);
    }
    window.checkRiddle=function(answer){
        if(revealed)return;
        const input=document.getElementById('rdIn');if(!input)return;
        const val=input.value.trim().toLowerCase().replace(/[^a-z\s]/g,'');
        const ans=answer.toLowerCase().replace(/[^a-z\s]/g,'');
        const msg=document.getElementById('rdMsg');
        if(val===ans||(val.length>2&&(ans.includes(val)||val.includes(ans)))){
            score++;_sfx.correct();revealed=true;msg.textContent=' Tama! Ang sagot ay: '+answer;msg.style.color='#10b981';
            setTimeout(()=>{idx++;render();},1000);
        }else{_sfx.wrong();msg.textContent=' Mali! Subukan ulit...';msg.style.color='#ef4444';}
    };
    window.revealRiddle=function(answer){
        revealed=true;_sfx.wrong();
        const msg=document.getElementById('rdMsg');
        msg.textContent='Sagot: '+answer;msg.style.color='#fbbf24';
        setTimeout(()=>{idx++;render();},1200);
    };
    render();
}

// ============================================================
// 10. WHACK-A-MOLE
// ============================================================
function loadWhack(){
    const el=document.getElementById('gameModalContent');
    let score=0,time=30,best=window._whackBest||0,active={},gameRunning=false,gameInterval,timeInterval;
    const moles=['','','','',''];
    
    function startGame(){
        score=0;time=30;active={};gameRunning=true;
        gScore(`Score: 0 |  30s`);
        renderBoard();
        clearInterval(gameInterval);clearInterval(timeInterval);
        gameInterval=setInterval(showMole,600);
        timeInterval=setInterval(()=>{
            time--;gScore(`Score: ${score} |  ${time}s`);
            const t=document.getElementById('wTime');if(t)t.textContent=time+'s';
            if(time<=0){gameRunning=false;clearInterval(gameInterval);clearInterval(timeInterval);_sfx.lose();if(score>best){best=score;window._whackBest=best;}showResult();}
        },1000);
        window._whackInterval=gameInterval;
    }
    
    function showMole(){
        if(!gameRunning)return;
        const idx=Math.floor(Math.random()*9);
        if(active[idx])return;
        active[idx]=true;
        const cell=document.getElementById('wc'+idx);
        if(!cell)return;
        const mole=moles[Math.floor(Math.random()*moles.length)];
        cell.textContent=mole;
        cell.style.background='rgba(251,191,36,0.2)';
        cell.style.borderColor='rgba(251,191,36,0.4)';
        cell.style.transform='scale(1.1)';
        setTimeout(()=>{
            if(active[idx]){
                delete active[idx];
                const c=document.getElementById('wc'+idx);
                if(c){c.textContent='';c.style.background='rgba(255,255,255,0.04)';c.style.borderColor='rgba(255,255,255,0.08)';c.style.transform='scale(1)';}
            }
        },900);
    }
    
    function renderBoard(){
        el.innerHTML=`<div style="max-width:340px;margin:0 auto;text-align:center;">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:14px;">
                <div style="font-size:22px;font-weight:900;color:#fbbf24;" id="wSc"> ${score}</div>
                <div style="background:rgba(239,68,68,0.2);border:1px solid rgba(239,68,68,0.3);border-radius:20px;padding:5px 14px;font-size:14px;font-weight:800;color:#ef4444;" id="wTime">${time}s</div>
                <div style="font-size:13px;color:rgba(255,255,255,0.4);">Best: <span style="color:#fbbf24;font-weight:800;">${best}</span></div>
            </div>
            <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-bottom:16px;">
                ${Array(9).fill(0).map((_,i)=>`<div id="wc${i}" onclick="whackMole(${i})" style="height:90px;border-radius:16px;display:flex;align-items:center;justify-content:center;font-size:38px;cursor:pointer;background:rgba(255,255,255,0.04);border:2px solid rgba(255,255,255,0.08);transition:all 0.15s;user-select:none;-webkit-tap-highlight-color:transparent;"></div>`).join('')}
            </div>
            ${!gameRunning&&time===30?`<button onclick="startGame()" style="background:linear-gradient(135deg,#fb923c,#ea580c);border:none;color:white;font-size:15px;font-weight:800;padding:14px 32px;border-radius:14px;cursor:pointer;width:100%;"> MAGLARO!</button>`:''}
        </div>`;
    }
    
    function showResult(){
        const earnedPts = Math.max(5, score * 2);
        awardGamePoints(earnedPts, 'Whack-a-Mole (score:' + score + ')');
        el.innerHTML=`<div style="text-align:center;padding:40px 20px;">
            <div style="font-size:64px;margin-bottom:16px;"></div>
            <div style="font-size:22px;font-weight:900;color:white;margin-bottom:8px;">TAPOS NA!</div>
            <div style="font-size:36px;font-weight:900;color:#fbbf24;margin-bottom:4px;">${score}</div>
            <div style="font-size:13px;color:rgba(255,255,255,0.4);margin-bottom:8px;">moles na na-whack</div>
            ${score>best?`<div style="font-size:13px;color:#10b981;font-weight:700;margin-bottom:8px;"> Bagong record!</div>`:`<div style="font-size:13px;color:rgba(255,255,255,0.4);margin-bottom:8px;">Best: ${best}</div>`}
            <div style="background:rgba(251,191,36,0.15);border:1px solid rgba(251,191,36,0.3);border-radius:12px;padding:10px 16px;margin-bottom:20px;font-size:15px;font-weight:800;color:#fbbf24;"> +${earnedPts} RB Coins nakuha!</div>
            <button onclick="loadWhack()" style="background:linear-gradient(135deg,#fb923c,#ea580c);border:none;color:white;font-size:14px;font-weight:800;padding:14px 32px;border-radius:14px;cursor:pointer;width:100%;"> Laruin Ulit</button>
        </div>`;
    }
    
    window.whackMole=function(idx){
        if(!gameRunning||!active[idx])return;
        _sfx.whack();score++;
        delete active[idx];
        const cell=document.getElementById('wc'+idx);
        if(cell){cell.textContent='';cell.style.background='rgba(239,68,68,0.3)';cell.style.transform='scale(0.9)';
        setTimeout(()=>{if(cell){cell.textContent='';cell.style.background='rgba(255,255,255,0.04)';cell.style.borderColor='rgba(255,255,255,0.08)';cell.style.transform='scale(1)';}},200);}
        gScore(`Score: ${score} |  ${time}s`);
        const sc=document.getElementById('wSc');if(sc)sc.textContent=' '+score;
    };
    
    renderBoard();
}

// Update games coins display when entering tab
document.addEventListener('DOMContentLoaded', function(){
    if(window.userData) document.getElementById('gamesCoinsAmt').textContent = Number(window.userData.points||0).toLocaleString();
});
</script>

<!-- ===== GAMES TAB ===== -->
<div id="view-games" style="display:none; min-height:100vh; padding-bottom:80px;">

    <!-- Header -->
    <div style="background:linear-gradient(180deg,rgba(13,20,35,0.99) 0%,rgba(13,20,35,0) 100%); position:sticky; top:0; z-index:10; padding:18px 16px 10px;">
        <div style="display:flex; align-items:center; justify-content:space-between;">
            <div>
                <div style="font-size:22px; font-weight:900; color:white; letter-spacing:-0.5px;"> Mini Games</div>
                <div style="font-size:11px; color:rgba(255,255,255,0.35); font-weight:600; margin-top:1px;">Play & have fun anytime!</div>
            </div>
            <div id="gamesCoinsDisplay" style="display:flex;align-items:center;gap:6px;background:rgba(251,191,36,0.1);border:1px solid rgba(251,191,36,0.25);border-radius:20px;padding:6px 12px;">
                <span style="font-size:14px;"></span>
                <span id="gamesRbCoins" style="font-size:13px;font-weight:800;color:#fbbf24;">0</span>
            </div>
        </div>
    </div>

    <div style="padding:0 12px;">
        <!-- Row 1: AI Trivia + Memory -->
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:10px;">
            <div onclick="openGame('trivia')" class="gcard" style="background:linear-gradient(145deg,#1e1b4b,#312e81);border:1px solid rgba(139,92,246,0.35);border-radius:18px;padding:18px 14px;cursor:pointer;text-align:center;">
                <div style="font-size:38px;margin-bottom:8px;"></div>
                <div style="font-size:13px;font-weight:800;color:white;margin-bottom:3px;">AI Trivia</div>
                <div style="font-size:10px;color:rgba(255,255,255,0.45);">Bagong tanong palagi!</div>
                <div style="margin-top:8px;background:rgba(139,92,246,0.25);border-radius:10px;padding:3px 8px;display:inline-block;font-size:9px;font-weight:800;color:#a78bfa;"> AI-POWERED</div>
            </div>
            <div onclick="openGame('memory')" class="gcard" style="background:linear-gradient(145deg,#0c2340,#0e3a5e);border:1px solid rgba(6,182,212,0.35);border-radius:18px;padding:18px 14px;cursor:pointer;text-align:center;">
                <div style="font-size:38px;margin-bottom:8px;"></div>
                <div style="font-size:13px;font-weight:800;color:white;margin-bottom:3px;">Memory Flip</div>
                <div style="font-size:10px;color:rgba(255,255,255,0.45);">Match the pairs!</div>
                <div style="margin-top:8px;background:rgba(6,182,212,0.2);border-radius:10px;padding:3px 8px;display:inline-block;font-size:9px;font-weight:800;color:#67e8f9;"> SOUNDS</div>
            </div>
        </div>

        <!-- Row 2: Word Scramble + Reaction -->
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:10px;">
            <div onclick="openGame('scramble')" class="gcard" style="background:linear-gradient(145deg,#1c1400,#3b2900);border:1px solid rgba(245,158,11,0.35);border-radius:18px;padding:18px 14px;cursor:pointer;text-align:center;">
                <div style="font-size:38px;margin-bottom:8px;"></div>
                <div style="font-size:13px;font-weight:800;color:white;margin-bottom:3px;">Scramble</div>
                <div style="font-size:10px;color:rgba(255,255,255,0.45);">AI Filipino words!</div>
                <div style="margin-top:8px;background:rgba(245,158,11,0.2);border-radius:10px;padding:3px 8px;display:inline-block;font-size:9px;font-weight:800;color:#fcd34d;"> AI-POWERED</div>
            </div>
            <div onclick="openGame('reaction')" class="gcard" style="background:linear-gradient(145deg,#0c2310,#0f3d1a);border:1px solid rgba(16,185,129,0.35);border-radius:18px;padding:18px 14px;cursor:pointer;text-align:center;">
                <div style="font-size:38px;margin-bottom:8px;"></div>
                <div style="font-size:13px;font-weight:800;color:white;margin-bottom:3px;">Reaction Tap</div>
                <div style="font-size:10px;color:rgba(255,255,255,0.45);">Gaano kabilis?</div>
                <div style="margin-top:8px;background:rgba(16,185,129,0.2);border-radius:10px;padding:3px 8px;display:inline-block;font-size:9px;font-weight:800;color:#6ee7b7;"> SOUNDS</div>
            </div>
        </div>

        <!-- Row 3: Snake + 2048 -->
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:10px;">
            <div onclick="openGame('snake')" class="gcard" style="background:linear-gradient(145deg,#1a0a0a,#3d1515);border:1px solid rgba(239,68,68,0.35);border-radius:18px;padding:18px 14px;cursor:pointer;text-align:center;">
                <div style="font-size:38px;margin-bottom:8px;"></div>
                <div style="font-size:13px;font-weight:800;color:white;margin-bottom:3px;">Snake</div>
                <div style="font-size:10px;color:rgba(255,255,255,0.45);">Classic snake game</div>
                <div style="margin-top:8px;background:rgba(239,68,68,0.2);border-radius:10px;padding:3px 8px;display:inline-block;font-size:9px;font-weight:800;color:#fca5a5;"> SOUNDS</div>
            </div>
            <div onclick="openGame('tiles2048')" class="gcard" style="background:linear-gradient(145deg,#1a1400,#3d3000);border:1px solid rgba(251,191,36,0.35);border-radius:18px;padding:18px 14px;cursor:pointer;text-align:center;">
                <div style="font-size:38px;margin-bottom:8px;"></div>
                <div style="font-size:13px;font-weight:800;color:white;margin-bottom:3px;">2048 Tiles</div>
                <div style="font-size:10px;color:rgba(255,255,255,0.45);">Merge para manalo!</div>
                <div style="margin-top:8px;background:rgba(251,191,36,0.2);border-radius:10px;padding:3px 8px;display:inline-block;font-size:9px;font-weight:800;color:#fde68a;"> SOUNDS</div>
            </div>
        </div>

        <!-- Row 4: Emoji Guess full width -->
        <div onclick="openGame('emoji')" class="gcard" style="background:linear-gradient(145deg,#200a1e,#4a1545);border:1px solid rgba(244,114,182,0.35);border-radius:18px;padding:16px 18px;cursor:pointer;display:flex;align-items:center;gap:14px;margin-bottom:10px;">
            <div style="font-size:44px;flex-shrink:0;"></div>
            <div style="flex:1;">
                <div style="font-size:14px;font-weight:800;color:white;margin-bottom:2px;">Emoji Guessing</div>
                <div style="font-size:11px;color:rgba(255,255,255,0.4);">Hulaan ang pelikula/salawikain!</div>
                <div style="margin-top:6px;background:rgba(244,114,182,0.2);border-radius:10px;padding:2px 8px;display:inline-block;font-size:9px;font-weight:800;color:#f9a8d4;"> AI-POWERED</div>
            </div>
            <div style="color:rgba(255,255,255,0.3);font-size:20px;"></div>
        </div>

        <!-- Row 5: Hangman + Color Match -->
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:10px;">
            <div onclick="openGame('hangman')" class="gcard" style="background:linear-gradient(145deg,#0a1520,#152535);border:1px solid rgba(96,165,250,0.35);border-radius:18px;padding:18px 14px;cursor:pointer;text-align:center;">
                <div style="font-size:38px;margin-bottom:8px;"></div>
                <div style="font-size:13px;font-weight:800;color:white;margin-bottom:3px;">Hangman</div>
                <div style="font-size:10px;color:rgba(255,255,255,0.45);">Hulaan ang salita!</div>
                <div style="margin-top:8px;background:rgba(96,165,250,0.2);border-radius:10px;padding:3px 8px;display:inline-block;font-size:9px;font-weight:800;color:#93c5fd;"> AI-POWERED</div>
            </div>
            <div onclick="openGame('colormatch')" class="gcard" style="background:linear-gradient(145deg,#0f0a20,#1e1040);border:1px solid rgba(167,139,250,0.35);border-radius:18px;padding:18px 14px;cursor:pointer;text-align:center;">
                <div style="font-size:38px;margin-bottom:8px;"></div>
                <div style="font-size:13px;font-weight:800;color:white;margin-bottom:3px;">Color Match</div>
                <div style="font-size:10px;color:rgba(255,255,255,0.45);">Tapusin bago maubusan!</div>
                <div style="margin-top:8px;background:rgba(167,139,250,0.2);border-radius:10px;padding:3px 8px;display:inline-block;font-size:9px;font-weight:800;color:#c4b5fd;"> SOUNDS</div>
            </div>
        </div>

        <!-- Row 6: Math Blitz full width -->
        <div onclick="openGame('mathblitz')" class="gcard" style="background:linear-gradient(145deg,#0a200a,#0f3a10);border:1px solid rgba(52,211,153,0.35);border-radius:18px;padding:16px 18px;cursor:pointer;display:flex;align-items:center;gap:14px;margin-bottom:10px;">
            <div style="font-size:44px;flex-shrink:0;"></div>
            <div style="flex:1;">
                <div style="font-size:14px;font-weight:800;color:white;margin-bottom:2px;">Math Blitz</div>
                <div style="font-size:11px;color:rgba(255,255,255,0.4);">Sagutan ang math bago mag-expire!</div>
                <div style="margin-top:6px;background:rgba(52,211,153,0.2);border-radius:10px;padding:2px 8px;display:inline-block;font-size:9px;font-weight:800;color:#6ee7b7;"> AI +  SOUNDS</div>
            </div>
            <div style="color:rgba(255,255,255,0.3);font-size:20px;"></div>
        </div>
    </div>
</div>

<style>
.gcard { transition: transform 0.15s, box-shadow 0.15s; }
.gcard:active { transform: scale(0.96); }
</style>

<!-- ===== GAME FULL-SCREEN MODAL ===== -->
<div id="gameModal" style="display:none;position:fixed;inset:0;z-index:99000;background:#0b1120;overflow-y:auto;flex-direction:column;">
    <div style="position:sticky;top:0;background:rgba(11,17,32,0.97);backdrop-filter:blur(20px);border-bottom:1px solid rgba(255,255,255,0.08);padding:14px 16px;display:flex;align-items:center;gap:10px;z-index:10;">
        <button onclick="closeGame()" style="background:rgba(255,255,255,0.08);border:1px solid rgba(255,255,255,0.12);color:white;border-radius:10px;width:36px;height:36px;display:flex;align-items:center;justify-content:center;cursor:pointer;font-size:16px;flex-shrink:0;"></button>
        <div id="gameModalTitle" style="font-size:16px;font-weight:800;color:white;flex:1;"></div>
        <div id="gameAiStatus" style="display:none;background:rgba(139,92,246,0.2);border:1px solid rgba(139,92,246,0.4);border-radius:20px;padding:4px 10px;font-size:10px;font-weight:800;color:#c4b5fd;"> AI</div>
    </div>
    <div id="gameModalContent" style="padding:16px;flex:1;"></div>
</div>

<script>
// ===== SOUND ENGINE (Web Audio API - no external files) =====
var _AC = null;
function getAC() { if (!_AC) _AC = new (window.AudioContext || window.webkitAudioContext)(); return _AC; }

function playTone(freq, type, dur, vol, delay) {
    try {
        var ac = getAC();
        var o = ac.createOscillator();
        var g = ac.createGain();
        o.connect(g); g.connect(ac.destination);
        o.type = type || 'sine';
        o.frequency.setValueAtTime(freq, ac.currentTime + (delay||0));
        g.gain.setValueAtTime(vol||0.3, ac.currentTime + (delay||0));
        g.gain.exponentialRampToValueAtTime(0.001, ac.currentTime + (delay||0) + dur);
        o.start(ac.currentTime + (delay||0));
        o.stop(ac.currentTime + (delay||0) + dur + 0.05);
    } catch(e){}
}

var SFX = {
    correct: function() { playTone(523,  'sine', 0.1, 0.3); playTone(659, 'sine', 0.15, 0.3, 0.1); playTone(784, 'sine', 0.2, 0.3, 0.22); },
    wrong:   function() { playTone(200,  'sawtooth', 0.15, 0.25); playTone(150, 'sawtooth', 0.2, 0.2, 0.15); },
    flip:    function() { playTone(440,  'triangle', 0.08, 0.15); },
    match:   function() { playTone(600, 'sine', 0.1, 0.25); playTone(800, 'sine', 0.15, 0.25, 0.1); },
    tick:    function() { playTone(800,  'square', 0.04, 0.1); },
    gameover:function() { playTone(300, 'sawtooth', 0.2, 0.3); playTone(200, 'sawtooth', 0.3, 0.25, 0.2); playTone(150, 'sawtooth', 0.4, 0.2, 0.45); },
    win:     function() { [523,659,784,1047].forEach(function(f,i){ playTone(f,'sine',0.25,0.3,i*0.12); }); },
    tap:     function() { playTone(600, 'sine', 0.06, 0.2); },
    move:    function() { playTone(350, 'triangle', 0.05, 0.1); },
    merge:   function() { playTone(500, 'sine', 0.12, 0.25); playTone(700, 'sine', 0.1, 0.2, 0.1); },
    countdown: function() { playTone(880, 'square', 0.08, 0.2); }
};

// ===== GAME ENGINE =====
function openGame(gameId) {
    getAC(); // unlock audio context on user gesture
    SFX.tap();
    var modal = document.getElementById('gameModal');
    modal.style.display = 'flex';
    modal.scrollTop = 0;
    var titles = { trivia:' AI Trivia Quiz', memory:' Memory Flip', scramble:' Word Scramble', reaction:' Reaction Tap', tiles2048:' 2048 Tiles', snake:' Snake Game', emoji:' Emoji Guessing', hangman:' Hangman', colormatch:' Color Match', mathblitz:' Math Blitz' };
    document.getElementById('gameModalTitle').textContent = titles[gameId] || 'Game';
    var aiGames = ['trivia','scramble','emoji','hangman','mathblitz'];
    var aiStatus = document.getElementById('gameAiStatus');
    aiStatus.style.display = aiGames.indexOf(gameId) >= 0 ? 'flex' : 'none';
    var funcs = { trivia:loadTrivia, memory:loadMemory, scramble:loadScramble, reaction:loadReaction, tiles2048:load2048, snake:loadSnake, emoji:loadEmojiGuess, hangman:loadHangman, colormatch:loadColorMatch, mathblitz:loadMathBlitz };
    if (funcs[gameId]) funcs[gameId]();
    // Update coins display
    if (window.userData) document.getElementById('gamesRbCoins').textContent = Number(window.userData.points||0).toLocaleString();
}

function closeGame() {
    SFX.tap();
    document.getElementById('gameModal').style.display = 'none';
    document.getElementById('gameModalContent').innerHTML = '';
    if (window._snakeInterval) { clearInterval(window._snakeInterval); window._snakeInterval = null; }
    if (window._reactionTimer) { clearTimeout(window._reactionTimer); window._reactionTimer = null; }
    if (window._mbTimer) { clearInterval(window._mbTimer); window._mbTimer = null; }
    if (window._cmTimer) { clearInterval(window._cmTimer); window._cmTimer = null; }
}

// Helper: AI call
function callAI(prompt, cb) {
    if (!window._RBAI_KEY) {
        console.warn('[AI] No API key set (window._RBAI_KEY). Using fallback data.');
        cb(new Error('No API key'), null);
        return;
    }
    fetch('https://api.anthropic.com/v1/messages', {
        method:'POST',
        headers:{
            'Content-Type':'application/json',
            'x-api-key': window._RBAI_KEY,
            'anthropic-version': '2023-06-01',
            'anthropic-dangerous-direct-browser-access': 'true'
        },
        body: JSON.stringify({
            model:'claude-haiku-4-5-20251001',
            max_tokens:1000,
            messages:[{role:'user',content:prompt}]
        })
    }).then(function(r){ return r.json(); })
    .then(function(d){
        try {
            if (d.error) throw new Error(d.error.message || 'AI Error');
            var txt = d.content.map(function(x){ return x.text||''; }).join('');
            var clean = txt.replace(/```json|```/g,'').trim();
            cb(null, JSON.parse(clean));
        } catch(e) { cb(e, null); }
    }).catch(function(e){ cb(e,null); });
}

function shuffleArray(arr) {
    var a = arr.slice();
    for (var i = a.length - 1; i > 0; i--) {
        var j = Math.floor(Math.random() * (i + 1));
        var tmp = a[i]; a[i] = a[j]; a[j] = tmp;
    }
    return a;
}

function showLoading(msg) {
    document.getElementById('gameModalContent').innerHTML = '<div style="text-align:center;padding:60px 20px;"><div style="font-size:40px;margin-bottom:16px;animation:spin 1s linear infinite;display:inline-block;"></div><div style="font-size:14px;color:rgba(255,255,255,0.5);font-weight:700;">' + (msg||'Loading AI...') + '</div></div><style>@keyframes spin{from{transform:rotate(0deg)}to{transform:rotate(360deg)}}</style>';
}

// ========================
// 1. AI TRIVIA QUIZ
// ========================
function loadTrivia() {
    showLoading(' AI ay gumagawa ng bagong mga tanong...');
    callAI('Generate 10 unique Filipino trivia questions. Mix topics: Philippine history, geography, culture, famous Filipinos, food, and fun facts. Return ONLY valid JSON array: [{"q":"question","choices":["A","B","C","D"],"a":0}] where "a" is the 0-based index of the correct answer. Make them interesting and educational. No markdown, no extra text.', function(err, data) {
        if (err || !data || !data.length) {
            // fallback - shuffled so order varies each play
            var fallback = [
                {q:"Sino ang unang Pangulo ng Pilipinas?",choices:["Manuel Quezon","Emilio Aguinaldo","Sergio Osmea","Jose Laurel"],a:1},
                {q:"Alin ang pinakamalaking lawa sa Pilipinas?",choices:["Laguna de Bay","Taal Lake","Lanao Lake","Buhi Lake"],a:0},
                {q:"Ano ang pambansang ibon ng Pilipinas?",choices:["Maya","Philippine Eagle","Kalapati","Ibis"],a:1},
                {q:"Ilang pulo ang Pilipinas?",choices:["5,000","7,107","10,000","3,500"],a:1},
                {q:"Sino ang nagsulat ng 'Noli Me Tangere'?",choices:["Andres Bonifacio","Emilio Aguinaldo","Jose Rizal","Apolinario Mabini"],a:2},
                {q:"Ano ang pambansang hayop ng Pilipinas?",choices:["Carabao","Tamaraw","Tarsier","Eagle"],a:0},
                {q:"Ilang bituin ang bandila ng Pilipinas?",choices:["3","5","8","12"],a:2},
                {q:"Saan matatagpuan ang Mayon Volcano?",choices:["Batangas","Albay","Cavite","Quezon"],a:1},
                {q:"Ano ang kabisera ng Pilipinas?",choices:["Cebu","Manila","Davao","Quezon City"],a:1},
                {q:"Alin ang pinakamalaking rehiyon sa Pilipinas?",choices:["NCR","CALABARZON","BARMM","Cagayan Valley"],a:2},
                {q:"Sino ang tinaguriang Bayani ng Pilipinas?",choices:["Andres Bonifacio","Jose Rizal","Apolinario Mabini","Emilio Aguinaldo"],a:1},
                {q:"Ano ang pambansang bulaklak ng Pilipinas?",choices:["Rosal","Sampaguita","Gumamela","Ilang-Ilang"],a:1},
                {q:"Saan isinilang si Jose Rizal?",choices:["Manila","Laguna","Cavite","Batangas"],a:1},
                {q:"Ano ang pinakamahal na tawiran sa Pilipinas?",choices:["San Juanico Bridge","Marcelo Fernan Bridge","Matnog","Kawit Bridge"],a:0},
                {q:"Ilang probinsya ang mayroon sa Pilipinas?",choices:["81","72","95","68"],a:0}
            ];
            data = shuffleArray(fallback).slice(0, 10);
        }
        runTrivia(data);
    });
}

function runTrivia(questions) {
    var idx = 0, score = 0, answered = false;
    var el = document.getElementById('gameModalContent');

    function render() {
        if (idx >= questions.length) {
            SFX.win();
            var trivPts = score >= 8 ? 50 : score >= 5 ? 30 : score >= 3 ? 10 : 0;
            if (trivPts > 0) awardGamePoints(trivPts, 'Trivia Quiz (' + score + '/' + questions.length + ')');
            el.innerHTML = '<div style="text-align:center;padding:40px 20px;"><div style="font-size:64px;margin-bottom:16px;">' + (score>=8?'':score>=5?'':'') + '</div><div style="font-size:26px;font-weight:900;color:white;margin-bottom:8px;">TAPOS NA!</div><div style="font-size:22px;color:#fbbf24;font-weight:800;margin-bottom:6px;">' + score + ' / ' + questions.length + '</div>' + (trivPts>0?'<div style="font-size:14px;color:#fbbf24;font-weight:800;margin-bottom:8px;">+'+trivPts+' RB Coins! </div>':'') + '<div style="font-size:13px;color:rgba(255,255,255,0.5);margin-bottom:28px;">' + (score>=8?'Kahanga-hanga! ':score>=5?'Magaling! Alam mo ang marami!':'Subukan ulit!') + '</div><button onclick="loadTrivia()" style="background:linear-gradient(135deg,#8b5cf6,#6d28d9);border:none;color:white;font-size:15px;font-weight:800;padding:14px 32px;border-radius:14px;cursor:pointer;"> Bagong Tanong ng AI</button></div>';
            return;
        }
        var q = questions[idx];
        answered = false;
        el.innerHTML = '<div style="margin-bottom:12px;"><div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:14px;"><div style="font-size:11px;color:rgba(255,255,255,0.35);font-weight:700;">Tanong ' + (idx+1) + ' / ' + questions.length + '</div><div style="background:rgba(139,92,246,0.2);border:1px solid rgba(139,92,246,0.3);border-radius:20px;padding:3px 12px;font-size:12px;font-weight:800;color:#a78bfa;">Score: ' + score + '</div></div><div style="background:rgba(255,255,255,0.04);border:1px solid rgba(255,255,255,0.08);border-radius:16px;padding:20px;margin-bottom:16px;"><div style="font-size:16px;font-weight:700;color:white;line-height:1.6;">' + q.q + '</div></div><div style="display:grid;gap:10px;" id="triviaChoices">' + q.choices.map(function(c,i){ return '<button onclick="checkTrivia('+i+')" id="tc'+i+'" style="background:rgba(255,255,255,0.04);border:1px solid rgba(255,255,255,0.12);border-radius:12px;padding:14px 16px;color:white;font-size:14px;font-weight:600;text-align:left;cursor:pointer;display:flex;align-items:center;gap:10px;transition:all 0.15s;"><span style="background:rgba(255,255,255,0.1);border-radius:8px;width:26px;height:26px;display:inline-flex;align-items:center;justify-content:center;font-size:11px;font-weight:800;flex-shrink:0;">'+['A','B','C','D'][i]+'</span>'+c+'</button>'; }).join('') + '</div></div>';
    }

    window.checkTrivia = function(chosen) {
        if (answered) return;
        answered = true;
        var correct = questions[idx].a;
        if (chosen === correct) { score++; SFX.correct(); } else { SFX.wrong(); }
        document.querySelectorAll('[id^="tc"]').forEach(function(b,i) {
            b.style.pointerEvents='none';
            if (i===correct) { b.style.background='rgba(16,185,129,0.25)'; b.style.borderColor='#10b981'; }
            else if (i===chosen) { b.style.background='rgba(239,68,68,0.25)'; b.style.borderColor='#ef4444'; }
        });
        setTimeout(function(){ idx++; render(); }, 1100);
    };
    render();
}

// ========================
// 2. MEMORY FLIP
// ========================
function loadMemory() {
    var emojis = ['','','','','','','',''];
    var cards = emojis.concat(emojis).sort(function(){ return Math.random()-0.5; }).map(function(e,i){ return {id:i,emoji:e,flipped:false,matched:false}; });
    var flipped = [], moves = 0, matched = 0, locked = false;
    var el = document.getElementById('gameModalContent');

    function render() {
        el.innerHTML = '<div style="text-align:center;"><div style="display:flex;justify-content:space-around;margin-bottom:14px;"><div style="text-align:center;"><div style="font-size:22px;font-weight:900;color:#fbbf24;">'+moves+'</div><div style="font-size:10px;color:rgba(255,255,255,0.35);font-weight:700;">MOVES</div></div><div style="text-align:center;"><div style="font-size:22px;font-weight:900;color:#10b981;">'+(matched/2)+' / '+emojis.length+'</div><div style="font-size:10px;color:rgba(255,255,255,0.35);font-weight:700;">PAIRS</div></div></div><div style="display:grid;grid-template-columns:repeat(4,1fr);gap:8px;max-width:320px;margin:0 auto;" id="memGrid">' + cards.map(function(c){ return '<div onclick="mFlip('+c.id+')" style="height:68px;border-radius:12px;cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:26px;transition:all 0.2s;border:2px solid;'+(c.matched?'background:rgba(16,185,129,0.15);border-color:#10b981;cursor:default;':(c.flipped?'background:rgba(6,182,212,0.2);border-color:#06b6d4;':'background:rgba(255,255,255,0.04);border-color:rgba(255,255,255,0.08);'))+'">'+(c.flipped||c.matched?c.emoji:'')+'</div>'; }).join('') + '</div>' + (matched===emojis.length*2?'<div style="margin-top:24px;"><div style="font-size:40px;margin-bottom:8px;"></div><div style="font-size:16px;font-weight:900;color:#fbbf24;margin-bottom:12px;">NATAPOS MO SA '+moves+' MOVES!</div><button onclick="loadMemory()" style="background:linear-gradient(135deg,#06b6d4,#0891b2);border:none;color:white;font-size:14px;font-weight:800;padding:12px 28px;border-radius:12px;cursor:pointer;"> Laruin Ulit</button></div>':'') + '</div>';
    }
    window.mFlip = function(id) {
        if (locked || cards[id].flipped || cards[id].matched || flipped.length>=2) return;
        SFX.flip();
        cards[id].flipped = true;
        flipped.push(cards[id]);
        render();
        if (flipped.length===2) {
            locked = true; moves++;
            if (flipped[0].emoji===flipped[1].emoji) {
                SFX.match();
                flipped[0].matched=true; flipped[1].matched=true;
                matched+=2; flipped=[]; locked=false;
                render();
                if (matched===emojis.length*2) { SFX.win(); awardGamePoints(30, 'Memory Flip'); }
            } else {
                setTimeout(function(){ SFX.wrong(); flipped.forEach(function(f){ f.flipped=false; }); flipped=[]; locked=false; render(); }, 800);
            }
        }
    };
    render();
}

// ========================
// 3. AI WORD SCRAMBLE
// ========================
function loadScramble() {
    showLoading(' AI ay naghahanap ng mga salita...');
    callAI('Generate 8 Filipino words or phrases to use in a word scramble game. Mix difficulty. Return ONLY valid JSON array: [{"word":"SALITA","hint":" Paraan ng pakikipag-usap"}]. Use uppercase. Include cultural words, food, places, feelings. No markdown, no extra text.', function(err, data) {
        if (err || !data || !data.length) {
            data = [
                {word:'PILIPINAS',hint:' Ating bansa'},
                {word:'MAHAL',hint:' Damdamin'},
                {word:'KALAYAAN',hint:' Pagpapalaya'},
                {word:'BAYANI',hint:' Nagsakripisyo'},
                {word:'KAIBIGAN',hint:' Espesyal na tao'},
                {word:'MASAYA',hint:' Damdaming magaan'},
                {word:'PAGMAMAHAL',hint:' Malalim na damdamin'},
                {word:'SALAMAT',hint:' Pasasalamat'}
            ];
        }
        runScramble(data);
    });
}

function runScramble(words) {
    var idx = 0, score = 0;
    var el = document.getElementById('gameModalContent');

    function scramble(w) {
        var arr = w.split('');
        do { arr.sort(function(){ return Math.random()-0.5; }); } while (arr.join('')===w);
        return arr.join('');
    }

    function render() {
        if (idx >= words.length) {
            SFX.win();
            var scPts = score >= 6 ? 40 : score >= 4 ? 20 : score >= 2 ? 10 : 0;
            if (scPts > 0) awardGamePoints(scPts, 'Word Scramble (' + score + '/' + words.length + ')');
            el.innerHTML = '<div style="text-align:center;padding:40px 20px;"><div style="font-size:64px;margin-bottom:16px;"></div><div style="font-size:24px;font-weight:900;color:white;margin-bottom:8px;">TAPOS NA!</div><div style="font-size:22px;color:#fbbf24;font-weight:800;margin-bottom:8px;">Score: '+score+' / '+words.length+'</div>' + (scPts>0?'<div style="font-size:14px;color:#fbbf24;font-weight:800;margin-bottom:16px;">+'+scPts+' RB Coins! </div>':'') + '<button onclick="loadScramble()" style="background:linear-gradient(135deg,#f59e0b,#d97706);border:none;color:white;font-size:15px;font-weight:800;padding:14px 32px;border-radius:14px;cursor:pointer;"> Bagong AI Words</button></div>';
            return;
        }
        var item = words[idx];
        var sc = scramble(item.word);
        el.innerHTML = '<div><div style="display:flex;justify-content:space-between;margin-bottom:20px;"><div style="font-size:11px;color:rgba(255,255,255,0.35);font-weight:700;">Salita '+(idx+1)+' / '+words.length+'</div><div style="background:rgba(245,158,11,0.2);border:1px solid rgba(245,158,11,0.3);border-radius:20px;padding:3px 12px;font-size:12px;font-weight:800;color:#fbbf24;">Score: '+score+'</div></div><div style="text-align:center;margin-bottom:24px;"><div style="font-size:13px;color:rgba(255,255,255,0.5);margin-bottom:10px;">'+item.hint+'</div><div style="font-size:28px;font-weight:900;color:#06b6d4;letter-spacing:6px;background:rgba(6,182,212,0.08);border:1px solid rgba(6,182,212,0.25);border-radius:14px;padding:16px;">'+sc+'</div></div><div style="display:flex;gap:10px;margin-bottom:12px;"><input id="scInput" type="text" placeholder="I-type ang sagot..." maxlength="'+item.word.length+'" style="flex:1;background:rgba(255,255,255,0.07);border:1px solid rgba(255,255,255,0.15);border-radius:12px;padding:14px;color:white;font-size:16px;font-weight:700;text-transform:uppercase;outline:none;" onkeydown="if(event.key===\'Enter\')checkSc(\''+item.word+'\')"><button onclick="checkSc(\''+item.word+'\')" style="background:linear-gradient(135deg,#f59e0b,#d97706);border:none;color:white;font-size:14px;font-weight:800;padding:14px 18px;border-radius:12px;cursor:pointer;">GO</button></div><button onclick="skipSc(\''+item.word+'\')" style="width:100%;background:rgba(255,255,255,0.04);border:1px solid rgba(255,255,255,0.08);color:rgba(255,255,255,0.4);font-size:12px;font-weight:700;padding:11px;border-radius:12px;cursor:pointer;"> Skip</button><div id="scMsg" style="text-align:center;margin-top:12px;font-size:14px;font-weight:700;min-height:20px;"></div></div>';
        setTimeout(function(){ var i=document.getElementById('scInput'); if(i) i.focus(); }, 100);
    }
    window.checkSc = function(word) {
        var input = document.getElementById('scInput'); if (!input) return;
        var val = input.value.trim().toUpperCase();
        var msg = document.getElementById('scMsg');
        if (val === word) {
            score++; SFX.correct();
            msg.textContent=' Tama!'; msg.style.color='#10b981';
            setTimeout(function(){ idx++; render(); }, 700);
        } else {
            SFX.wrong();
            msg.textContent=' Mali! Subukan ulit...'; msg.style.color='#ef4444';
            input.style.borderColor='#ef4444';
            setTimeout(function(){ input.style.borderColor='rgba(255,255,255,0.15)'; msg.textContent=''; }, 700);
        }
    };
    window.skipSc = function(word) {
        SFX.wrong();
        var msg = document.getElementById('scMsg');
        msg.textContent='Sagot: '+word; msg.style.color='#fbbf24';
        setTimeout(function(){ idx++; render(); }, 1000);
    };
    render();
}

// ========================
// 4. REACTION TAP
// ========================
function loadReaction() {
    var el = document.getElementById('gameModalContent');
    var round=0, scores=[], waiting=false, tStart=0;

    function render() {
        if (round>=5) {
            var avg=Math.round(scores.reduce(function(a,b){return a+b;},0)/scores.length);
            var best=Math.min.apply(null,scores);
            var grade=avg<200?'SUPERHERO ':avg<350?'NAPAKABILIS ':avg<500?'MAGALING ':avg<700?'AVERAGE ':'MABAGAL ';
            var rPts = avg<200?50:avg<350?35:avg<500?20:avg<700?10:5;
            SFX.win(); awardGamePoints(rPts, 'Reaction Tap (' + avg + 'ms avg)');
            el.innerHTML='<div style="text-align:center;padding:28px 16px;"><div style="font-size:48px;margin-bottom:12px;"></div><div style="font-size:20px;font-weight:900;color:white;margin-bottom:6px;">RESULTA</div><div style="font-size:38px;font-weight:900;color:#fbbf24;margin-bottom:4px;">'+avg+'<span style="font-size:18px;">ms</span></div><div style="font-size:12px;color:rgba(255,255,255,0.45);margin-bottom:8px;">Average Reaction Time</div><div style="font-size:12px;color:#10b981;font-weight:700;margin-bottom:6px;">Best: '+best+'ms</div><div style="font-size:20px;font-weight:900;margin:12px 0;color:#8b5cf6;">'+grade+'</div><div style="font-size:14px;color:#fbbf24;font-weight:800;margin-bottom:10px;">+'+rPts+' RB Coins! </div><div style="display:flex;flex-direction:column;gap:6px;margin-bottom:24px;">'+scores.map(function(s,i){ return '<div style="background:rgba(255,255,255,0.04);border-radius:10px;padding:8px 16px;display:flex;justify-content:space-between;"><span style="color:rgba(255,255,255,0.4);font-size:12px;">Round '+(i+1)+'</span><span style="font-weight:800;color:'+(s<300?'#10b981':s<500?'#fbbf24':'#ef4444')+'">'+s+'ms</span></div>'; }).join('')+'</div><button onclick="loadReaction()" style="background:linear-gradient(135deg,#10b981,#059669);border:none;color:white;font-size:15px;font-weight:800;padding:14px 32px;border-radius:14px;cursor:pointer;"> Subukan Ulit</button></div>';
            return;
        }
        el.innerHTML='<div style="text-align:center;padding:16px;"><div style="font-size:12px;color:rgba(255,255,255,0.35);font-weight:700;margin-bottom:16px;">Round '+(round+1)+' / 5</div><div id="rBox" style="background:rgba(239,68,68,0.15);border:2px solid rgba(239,68,68,0.4);border-radius:20px;padding:55px 20px;cursor:pointer;transition:all 0.2s;" onclick="tapR()"><div id="rEmoji" style="font-size:60px;margin-bottom:10px;"></div><div id="rTxt" style="font-size:15px;font-weight:800;color:rgba(255,255,255,0.5);">Hintayin ang GREEN...</div></div><div style="margin-top:14px;display:flex;gap:6px;justify-content:center;">'+scores.map(function(s,i){ return '<div style="background:'+(s<300?'rgba(16,185,129,0.3)':s<500?'rgba(251,191,36,0.3)':'rgba(239,68,68,0.3)')+';border-radius:8px;padding:3px 10px;font-size:11px;font-weight:800;color:white;">'+s+'ms</div>'; }).join('')+'</div></div>';
        waiting=true;
        var delay=1500+Math.random()*3000;
        window._reactionTimer=setTimeout(function(){
            waiting=false; tStart=Date.now();
            SFX.tick();
            var box=document.getElementById('rBox'); var em=document.getElementById('rEmoji'); var txt=document.getElementById('rTxt');
            if(box){box.style.background='rgba(16,185,129,0.25)';box.style.borderColor='rgba(16,185,129,0.5)';}
            if(em) em.textContent='';
            if(txt){txt.textContent='I-TAP NGAYON!';txt.style.color='#10b981';}
        },delay);
    }
    window.tapR=function(){
        if(waiting){
            clearTimeout(window._reactionTimer);
            SFX.wrong();
            var txt=document.getElementById('rTxt'); var box=document.getElementById('rBox');
            if(txt) txt.textContent=' Maaga! Hintay ang GREEN...';
            if(box){box.style.background='rgba(251,191,36,0.15)';box.style.borderColor='rgba(251,191,36,0.4)';}
            waiting=false; setTimeout(function(){ render(); },900); return;
        }
        if(!tStart) return;
        var elapsed=Date.now()-tStart; tStart=0;
        scores.push(elapsed); round++;
        SFX.correct();
        var txt=document.getElementById('rTxt');
        if(txt) txt.textContent=elapsed+'ms! '+(elapsed<250?' Bilis!':elapsed<400?' Magaling!':' OK yan!');
        setTimeout(function(){ render(); },700);
    };
    render();
}

// ========================
// 5. 2048 TILES
// ========================
function load2048() {
    var el=document.getElementById('gameModalContent');
    var board,score,best=window._2048best||0,over;
    function newGame(){board=[[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0]];score=0;over=false;addT();addT();render();}
    function addT(){var em=[];for(var r=0;r<4;r++)for(var c=0;c<4;c++)if(!board[r][c])em.push([r,c]);if(!em.length)return;var p=em[Math.floor(Math.random()*em.length)];board[p[0]][p[1]]=Math.random()<0.9?2:4;}
    function slideRow(row){var a=row.filter(function(x){return x;}),ch=false;for(var i=0;i<a.length-1;i++){if(a[i]===a[i+1]){a[i]*=2;score+=a[i];a.splice(i+1,1);ch=true;}}while(a.length<4)a.push(0);return{row:a,changed:ch||a.join(',')!==row.join(',')};}
    function move(d){if(over)return;var mv=false;if(d==='left'){board=board.map(function(r){var x=slideRow(r);if(x.changed)mv=true;return x.row;});}else if(d==='right'){board=board.map(function(r){var x=slideRow([...r].reverse());if(x.changed)mv=true;return x.row.reverse();});}else if(d==='up'){var t=board[0].map(function(_,c){return board.map(function(r){return r[c];});});t=t.map(function(r){var x=slideRow(r);if(x.changed)mv=true;return x.row;});board=board.map(function(_,r){return t.map(function(col){return col[r];});});}else if(d==='down'){var t2=board[0].map(function(_,c){return board.map(function(r){return r[c];}).reverse();});t2=t2.map(function(r){var x=slideRow(r);if(x.changed)mv=true;return x.row;});board=board.map(function(_,r){return t2.map(function(col){return col.reverse()[r];});});}if(mv){SFX.move();addT();if(score>best){best=score;window._2048best=best;}render();}if(!canMove()){over=true;SFX.gameover();render();}}
    function canMove(){for(var r=0;r<4;r++)for(var c=0;c<4;c++){if(!board[r][c])return true;if(c<3&&board[r][c]===board[r][c+1])return true;if(r<3&&board[r][c]===board[r+1][c])return true;}return false;}
    var tc={2:'#eee4da',4:'#ede0c8',8:'#f2b179',16:'#f59563',32:'#f67c5f',64:'#f65e3b',128:'#edcf72',256:'#edcc61',512:'#edc850',1024:'#edc53f',2048:'#edc22e'};
    function render(){el.innerHTML='<div style="max-width:320px;margin:0 auto;"><div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;"><div style="font-size:26px;font-weight:900;color:#fbbf24;">2048</div><div style="display:flex;gap:6px;"><div style="background:rgba(245,158,11,0.15);border-radius:10px;padding:6px 12px;text-align:center;"><div style="font-size:9px;color:rgba(255,255,255,0.35);font-weight:700;">SCORE</div><div style="font-size:15px;font-weight:900;color:white;">'+score+'</div></div><div style="background:rgba(255,255,255,0.04);border-radius:10px;padding:6px 12px;text-align:center;"><div style="font-size:9px;color:rgba(255,255,255,0.35);font-weight:700;">BEST</div><div style="font-size:15px;font-weight:900;color:white;">'+best+'</div></div><button onclick="load2048()" style="background:rgba(255,255,255,0.08);border:1px solid rgba(255,255,255,0.12);color:white;border-radius:8px;padding:6px 10px;cursor:pointer;font-size:11px;font-weight:700;">NEW</button></div></div><div id="b2048" style="background:rgba(20,30,50,0.9);border-radius:12px;padding:8px;display:grid;grid-template-columns:repeat(4,1fr);gap:5px;touch-action:none;">'+board.flat().map(function(v){return '<div style="height:68px;border-radius:9px;display:flex;align-items:center;justify-content:center;font-size:'+(v>=1024?14:v>=100?18:20)+'px;font-weight:900;background:'+(v?(tc[v]||'#3c3a32'):'rgba(255,255,255,0.03)')+';color:'+(v<=4?'#776e65':'#f9f6f2')+';transition:all 0.1s;">'+(v||'')+'</div>';}).join('')+'</div>'+(over?'<div style="text-align:center;margin-top:14px;"><div style="font-size:16px;font-weight:900;color:#ef4444;margin-bottom:8px;">GAME OVER!</div><button onclick="load2048()" style="background:linear-gradient(135deg,#fbbf24,#d97706);border:none;color:white;font-size:14px;font-weight:800;padding:11px 26px;border-radius:11px;cursor:pointer;"> Ulit</button></div>':'')+'<div style="margin-top:10px;text-align:center;font-size:11px;color:rgba(255,255,255,0.25);">Swipe para maglaro</div></div>';
        var sx=0,sy=0;var bd=document.getElementById('b2048');
        if(bd){bd.addEventListener('touchstart',function(e){sx=e.touches[0].clientX;sy=e.touches[0].clientY;},{passive:true});bd.addEventListener('touchend',function(e){var dx=e.changedTouches[0].clientX-sx,dy=e.changedTouches[0].clientY-sy;if(Math.abs(dx)>Math.abs(dy))move(dx>0?'right':'left');else move(dy>0?'down':'up');},{passive:true});}
    }
    newGame();
    window._2048KeyHandler=function(e){var m={ArrowLeft:'left',ArrowRight:'right',ArrowUp:'up',ArrowDown:'down'};if(m[e.key]){e.preventDefault();move(m[e.key]);}};
    document.addEventListener('keydown',window._2048KeyHandler);
}

// ========================
// 6. SNAKE GAME
// ========================
function loadSnake() {
    var el=document.getElementById('gameModalContent');
    el.innerHTML='<div style="max-width:320px;margin:0 auto;text-align:center;"><div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;"><div style="font-size:12px;color:rgba(255,255,255,0.4);">Score: <span id="sScore" style="font-weight:900;color:#10b981;">0</span></div><button onclick="loadSnake()" style="background:rgba(255,255,255,0.08);border:1px solid rgba(255,255,255,0.12);color:white;border-radius:8px;padding:5px 10px;cursor:pointer;font-size:11px;font-weight:700;"> Reset</button><div style="font-size:12px;color:rgba(255,255,255,0.4);">Best: <span id="sBest" style="font-weight:900;color:#fbbf24;">0</span></div></div><canvas id="snakeCvs" width="300" height="300" style="border-radius:12px;border:1px solid rgba(16,185,129,0.3);background:#070e1e;display:block;margin:0 auto;"></canvas><div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:6px;max-width:180px;margin:12px auto 0;"><div></div><button onclick="snakeDir(\'up\')" style="background:rgba(255,255,255,0.08);border:1px solid rgba(255,255,255,0.12);color:white;border-radius:10px;padding:14px;cursor:pointer;font-size:16px;"></button><div></div><button onclick="snakeDir(\'left\')" style="background:rgba(255,255,255,0.08);border:1px solid rgba(255,255,255,0.12);color:white;border-radius:10px;padding:14px;cursor:pointer;font-size:16px;"></button><button onclick="snakeDir(\'down\')" style="background:rgba(255,255,255,0.08);border:1px solid rgba(255,255,255,0.12);color:white;border-radius:10px;padding:14px;cursor:pointer;font-size:16px;"></button><button onclick="snakeDir(\'right\')" style="background:rgba(255,255,255,0.08);border:1px solid rgba(255,255,255,0.12);color:white;border-radius:10px;padding:14px;cursor:pointer;font-size:16px;"></button></div></div>';
    var SZ=20,COLS=15,ROWS=15;
    var snake=[{x:7,y:7},{x:6,y:7},{x:5,y:7}];
    var dir={x:1,y:0},nDir={x:1,y:0};
    var score=0,best=window._snakeBest||0,alive=true;
    document.getElementById('sBest').textContent=best;
    function rFood(){var f;do{f={x:Math.floor(Math.random()*COLS),y:Math.floor(Math.random()*ROWS)};}while(snake.some(function(s){return s.x===f.x&&s.y===f.y;}));return f;}
    var food=rFood();
    function draw(){var cv=document.getElementById('snakeCvs');if(!cv){clearInterval(window._snakeInterval);return;}var ctx=cv.getContext('2d');ctx.fillStyle='#070e1e';ctx.fillRect(0,0,300,300);ctx.strokeStyle='rgba(255,255,255,0.02)';for(var i=0;i<=COLS;i++){ctx.beginPath();ctx.moveTo(i*SZ,0);ctx.lineTo(i*SZ,300);ctx.stroke();}for(var j=0;j<=ROWS;j++){ctx.beginPath();ctx.moveTo(0,j*SZ);ctx.lineTo(300,j*SZ);ctx.stroke();}ctx.fillStyle='#ef4444';ctx.beginPath();ctx.arc(food.x*SZ+SZ/2,food.y*SZ+SZ/2,SZ/2-2,0,Math.PI*2);ctx.fill();snake.forEach(function(seg,i){ctx.fillStyle=i===0?'#10b981':'rgba(16,185,129,'+(0.9-i*0.04)+')';ctx.beginPath();ctx.roundRect(seg.x*SZ+1,seg.y*SZ+1,SZ-2,SZ-2,4);ctx.fill();});if(!alive){ctx.fillStyle='rgba(0,0,0,0.75)';ctx.fillRect(0,0,300,300);ctx.fillStyle='white';ctx.font='bold 20px sans-serif';ctx.textAlign='center';ctx.fillText('GAME OVER!',150,130);ctx.fillStyle='#fbbf24';ctx.font='bold 15px sans-serif';ctx.fillText('Score: '+score,150,162);ctx.fillStyle='rgba(255,255,255,0.5)';ctx.font='12px sans-serif';ctx.fillText('Reset para ulit',150,190);}}
    function step(){if(!alive)return;dir={...nDir};var h={x:snake[0].x+dir.x,y:snake[0].y+dir.y};if(h.x<0||h.x>=COLS||h.y<0||h.y>=ROWS||snake.some(function(s){return s.x===h.x&&s.y===h.y;})){alive=false;SFX.gameover();draw();if(score>best){best=score;window._snakeBest=best;document.getElementById('sBest').textContent=best;}return;}snake.unshift(h);if(h.x===food.x&&h.y===food.y){score+=10;SFX.match();food=rFood();document.getElementById('sScore').textContent=score;}else snake.pop();draw();}
    window.snakeDir=function(d){var m={up:{x:0,y:-1},down:{x:0,y:1},left:{x:-1,y:0},right:{x:1,y:0}};var nd=m[d];if(dir.x+nd.x!==0||dir.y+nd.y!==0)nDir=nd;};
    var ts={x:0,y:0};var cv2=document.getElementById('snakeCvs');
    cv2.addEventListener('touchstart',function(e){ts.x=e.touches[0].clientX;ts.y=e.touches[0].clientY;},{passive:true});
    cv2.addEventListener('touchend',function(e){var dx=e.changedTouches[0].clientX-ts.x,dy=e.changedTouches[0].clientY-ts.y;if(Math.abs(dx)>Math.abs(dy))window.snakeDir(dx>0?'right':'left');else window.snakeDir(dy>0?'down':'up');},{passive:true});
    draw();window._snakeInterval=setInterval(step,140);
}

// ========================
// 7. AI EMOJI GUESSING
// ========================
function loadEmojiGuess() {
    showLoading(' AI ay gumagawa ng emoji puzzles...');
    callAI('Generate 10 emoji guessing puzzles. Mix Filipino and international movies, songs, phrases, and Filipino sayings. Return ONLY valid JSON array: [{"emojis":"","answer":"TITANIC","hint":" Hollywood Movie"}]. Use uppercase for answers. Be creative and fun! No markdown, no extra text.', function(err, data) {
        if (err || !data || !data.length) {
            data = [
                {emojis:'',answer:'TITANIC',hint:' Hollywood Movie'},
                {emojis:'',answer:'LION KING',hint:' Disney Movie'},
                {emojis:'',answer:'SPIDER-MAN',hint:' Superhero'},
                {emojis:'',answer:'FROZEN',hint:' Disney Movie'},
                {emojis:'',answer:'STAR WARS',hint:' Sci-Fi'},
                {emojis:'',answer:'THE MATRIX',hint:' Sci-Fi Movie'},
                {emojis:'',answer:'FINDING NEMO',hint:' Animated'},
                {emojis:'',answer:'CHARLIE AND THE CHOCOLATE FACTORY',hint:' Movie'},
                {emojis:'',answer:'SNOW WHITE',hint:' Disney Classic'},
                {emojis:'',answer:'BATMAN',hint:' Superhero'}
            ];
        }
        runEmoji(data);
    });
}

function runEmoji(puzzles) {
    var idx=0,score=0,el=document.getElementById('gameModalContent');
    function render(){
        if(idx>=puzzles.length){SFX.win();var ePts=score>=8?40:score>=5?25:score>=3?10:0;if(ePts>0)awardGamePoints(ePts,'Emoji Guessing ('+score+'/'+puzzles.length+')');el.innerHTML='<div style="text-align:center;padding:40px 20px;"><div style="font-size:64px;margin-bottom:16px;"></div><div style="font-size:24px;font-weight:900;color:white;margin-bottom:8px;">TAPOS NA!</div><div style="font-size:22px;color:#fbbf24;font-weight:800;margin-bottom:8px;">Score: '+score+' / '+puzzles.length+'</div>'+(ePts>0?'<div style="font-size:14px;color:#fbbf24;font-weight:800;margin-bottom:16px;">+'+ePts+' RB Coins! </div>':'')+'<button onclick="loadEmojiGuess()" style="background:linear-gradient(135deg,#f472b6,#db2777);border:none;color:white;font-size:15px;font-weight:800;padding:14px 32px;border-radius:14px;cursor:pointer;"> Bagong AI Puzzles</button></div>';return;}
        var p=puzzles[idx];
        el.innerHTML='<div><div style="display:flex;justify-content:space-between;margin-bottom:18px;"><div style="font-size:11px;color:rgba(255,255,255,0.35);font-weight:700;">Puzzle '+(idx+1)+' / '+puzzles.length+'</div><div style="background:rgba(244,114,182,0.2);border:1px solid rgba(244,114,182,0.3);border-radius:20px;padding:3px 12px;font-size:12px;font-weight:800;color:#f472b6;">Score: '+score+'</div></div><div style="text-align:center;margin-bottom:22px;"><div style="font-size:12px;color:rgba(255,255,255,0.4);margin-bottom:10px;">'+p.hint+'</div><div style="font-size:52px;background:rgba(244,114,182,0.08);border:1px solid rgba(244,114,182,0.25);border-radius:18px;padding:22px;letter-spacing:6px;">'+p.emojis+'</div></div><div style="display:flex;gap:10px;margin-bottom:10px;"><input id="emIn" type="text" placeholder="Ano ito?" style="flex:1;background:rgba(255,255,255,0.06);border:1px solid rgba(255,255,255,0.14);border-radius:12px;padding:13px;color:white;font-size:15px;font-weight:700;text-transform:uppercase;outline:none;" onkeydown="if(event.key===\'Enter\')checkEm()"><button onclick="checkEm()" style="background:linear-gradient(135deg,#f472b6,#db2777);border:none;color:white;font-size:14px;font-weight:800;padding:13px 16px;border-radius:12px;cursor:pointer;">GO!</button></div><button onclick="skipEm()" style="width:100%;background:rgba(255,255,255,0.04);border:1px solid rgba(255,255,255,0.08);color:rgba(255,255,255,0.35);font-size:12px;font-weight:700;padding:11px;border-radius:12px;cursor:pointer;"> Skip</button><div id="emMsg" style="text-align:center;margin-top:10px;font-size:14px;font-weight:700;min-height:18px;"></div></div>';
        setTimeout(function(){ var i=document.getElementById('emIn'); if(i) i.focus(); }, 100);
    }
    window.checkEm=function(){
        var input=document.getElementById('emIn');if(!input)return;
        var val=input.value.trim().toUpperCase().replace(/[^A-Z0-9\s]/g,'');
        var ans=puzzles[idx].answer.toUpperCase().replace(/[^A-Z0-9\s]/g,'');
        var msg=document.getElementById('emMsg');
        if(val===ans||(val.length>3&&ans.indexOf(val)>=0)){score++;SFX.correct();msg.textContent=' Tama! '+puzzles[idx].answer;msg.style.color='#10b981';setTimeout(function(){idx++;render();},800);}
        else{SFX.wrong();msg.textContent=' Mali! Subukan ulit...';msg.style.color='#ef4444';}
    };
    window.skipEm=function(){SFX.wrong();var msg=document.getElementById('emMsg');msg.textContent='Sagot: '+puzzles[idx].answer;msg.style.color='#fbbf24';setTimeout(function(){idx++;render();},1000);};
    render();
}

// ========================
// 8. AI HANGMAN
// ========================
function loadHangman() {
    showLoading(' AI ay pumipili ng salita...');
    callAI('Generate 8 Filipino words for a hangman game. Mix difficulty (4-12 letters). Return ONLY valid JSON array: [{"word":"SALITA","hint":" Paraan ng komunikasyon","category":"Pangkalahatan"}]. Use UPPERCASE. Include categories: Pagkain, Hayop, Lugar, Damdamin, Bayani. No markdown, no extra text.', function(err, data) {
        if (err || !data || !data.length) {
            data=[{word:'KAIBIGAN',hint:' Espesyal na tao',category:'Damdamin'},{word:'PILIPINAS',hint:' Ating bansa',category:'Lugar'},{word:'ADOBO',hint:' Paboritong ulam',category:'Pagkain'},{word:'AGILA',hint:' Ibon na malakas',category:'Hayop'},{word:'MAYNILA',hint:' Kabisera ng bansa',category:'Lugar'},{word:'KALAYAAN',hint:' Pagiging malaya',category:'Damdamin'},{word:'SISIG',hint:' Pork dish mula Pampanga',category:'Pagkain'},{word:'BAYANI',hint:' Nagsakripisyo',category:'Bayani'}];
        }
        runHangman(data);
    });
}

function runHangman(words) {
    var idx=0,score=0,el=document.getElementById('gameModalContent');
    function render(){
        if(idx>=words.length){SFX.win();var hPts=score>=6?40:score>=4?25:score>=2?10:0;if(hPts>0)awardGamePoints(hPts,'Hangman ('+score+'/'+words.length+')');el.innerHTML='<div style="text-align:center;padding:40px 20px;"><div style="font-size:64px;margin-bottom:16px;"></div><div style="font-size:24px;font-weight:900;color:white;margin-bottom:8px;">TAPOS NA!</div><div style="font-size:22px;color:#fbbf24;font-weight:800;margin-bottom:8px;">Score: '+score+' / '+words.length+'</div>'+(hPts>0?'<div style="font-size:14px;color:#fbbf24;font-weight:800;margin-bottom:16px;">+'+hPts+' RB Coins! </div>':'')+'<button onclick="loadHangman()" style="background:linear-gradient(135deg,#60a5fa,#3b82f6);border:none;color:white;font-size:15px;font-weight:800;padding:14px 32px;border-radius:14px;cursor:pointer;"> Bagong AI Words</button></div>';return;}
        runHangmanRound(words[idx],function(won){if(won)score++;idx++;render();});
    }
    render();
}

function runHangmanRound(item, done) {
    var word=item.word, guessed=[], wrong=0, maxWrong=6;
    var el=document.getElementById('gameModalContent');
    var alphabet='ABCDEFGHIJKLMNOPQRSTUVWXYZ'.split('');
    var parts=['','_','( )','  |  ','  |/ ','  |/ \\'];
    var head=['','','  O  ','  O  ','  O  ','  O  '];
    var body=['','','','  |  ','  |  ','  |  '];

    function render(){
        var display=word.split('').map(function(l){ return guessed.indexOf(l)>=0?l:'_'; }).join(' ');
        var won=display.indexOf('_')<0;
        var lost=wrong>=maxWrong;
        if(won){SFX.win();}
        el.innerHTML='<div style="max-width:360px;margin:0 auto;"><div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;"><span style="font-size:11px;color:rgba(255,255,255,0.35);font-weight:700;background:rgba(96,165,250,0.15);border-radius:20px;padding:3px 10px;">'+item.category+'</span><span style="font-size:11px;color:rgba(255,255,255,0.4);">'+wrong+' / '+maxWrong+' mali</span></div><div style="background:rgba(10,25,50,0.7);border:1px solid rgba(96,165,250,0.2);border-radius:14px;padding:16px;text-align:center;margin-bottom:14px;font-family:monospace;"><pre style="color:'+(lost?'#ef4444':won?'#10b981':'white')+';font-size:13px;line-height:1.6;margin:0;">'+getFigure(wrong)+'</pre></div><div style="font-size:12px;color:rgba(255,255,255,0.45);margin-bottom:8px;text-align:center;">'+item.hint+'</div><div style="font-size:26px;font-weight:900;color:white;letter-spacing:10px;text-align:center;margin-bottom:16px;'+(won?'color:#10b981;':lost?'color:#ef4444;':'')+'">'+display+(lost?'  '+word:'')+'</div>'+(won||lost?'<div style="text-align:center;margin-bottom:12px;"><div style="font-size:22px;font-weight:900;color:'+(won?'#10b981':'#ef4444')+';margin-bottom:8px;">'+(won?' TAMA!':' TALO! Ang salita: '+word)+'</div><button onclick="window._hangDone('+(won?'true':'false')+')" style="background:linear-gradient(135deg,'+(won?'#10b981,#059669':'#3b82f6,#2563eb')+');border:none;color:white;font-size:14px;font-weight:800;padding:12px 28px;border-radius:12px;cursor:pointer;">Susunod </button></div>':'<div style="display:flex;flex-wrap:wrap;gap:5px;justify-content:center;">'+alphabet.map(function(l){var used=guessed.indexOf(l)>=0;var correct=word.indexOf(l)>=0;return '<button onclick="guessLetter(\''+l+'\')" '+(used?'disabled':'')+' style="width:36px;height:36px;border-radius:8px;font-size:13px;font-weight:800;cursor:'+(used?'default':'pointer')+';border:1px solid;background:'+(used?(correct?'rgba(16,185,129,0.3)':'rgba(239,68,68,0.2)'):'rgba(255,255,255,0.06)')+';border-color:'+(used?(correct?'#10b981':'rgba(239,68,68,0.4)'):'rgba(255,255,255,0.12)')+';color:'+(used?(correct?'#10b981':'rgba(255,255,255,0.2)'):'white')+';transition:all 0.15s;">'+l+'</button>'; }).join('')+'</div>')+'</div>';
        window._hangDone=function(w){done(w==='true');};
        window.guessLetter=function(l){if(guessed.indexOf(l)>=0)return;guessed.push(l);if(word.indexOf(l)<0){wrong++;SFX.wrong();}else{SFX.correct();}render();};
    }
    render();
}

function getFigure(n){var f=['  +---+\n  |   |\n      |\n      |\n      |\n      |\n=========','  +---+\n  |   |\n  O   |\n      |\n      |\n      |\n=========','  +---+\n  |   |\n  O   |\n  |   |\n      |\n      |\n=========','  +---+\n  |   |\n  O   |\n /|   |\n      |\n      |\n=========','  +---+\n  |   |\n  O   |\n /|\\  |\n      |\n      |\n=========','  +---+\n  |   |\n  O   |\n /|\\  |\n /    |\n      |\n=========','  +---+\n  |   |\n  O   |\n /|\\  |\n / \\  |\n      |\n========='];return f[Math.min(n,6)]||f[0];}

// ========================
// 9. COLOR MATCH
// ========================
function loadColorMatch() {
    var el=document.getElementById('gameModalContent');
    var colors=['#ef4444','#f59e0b','#10b981','#3b82f6','#8b5cf6','#f472b6','#06b6d4','#84cc16'];
    var names=['Pula','Dilaw','Berde','Asul','Lila','Pink','Cyan','Lime'];
    var score=0,lives=3,timeLeft=30,target,opts,answered;
    
    function newRound(){
        answered=false;
        var ti=Math.floor(Math.random()*colors.length);
        target=ti;
        var indices=[ti];
        while(indices.length<4){var r=Math.floor(Math.random()*colors.length);if(indices.indexOf(r)<0)indices.push(r);}
        indices.sort(function(){return Math.random()-0.5;});
        opts=indices;
        render();
    }
    function render(){
        el.innerHTML='<div style="max-width:320px;margin:0 auto;"><div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;"><div>'.repeat(lives)+'<span style="font-size:12px;color:rgba(255,255,255,0.3);">'+' '.repeat(3-lives)+'</span></div><div style="font-size:20px;font-weight:900;color:#fbbf24;">'+score+'</div><div id="cmTime" style="background:rgba(6,182,212,0.15);border:1px solid rgba(6,182,212,0.3);border-radius:20px;padding:3px 12px;font-size:13px;font-weight:800;color:#67e8f9;">'+timeLeft+'s</div></div><div style="text-align:center;margin-bottom:20px;"><div style="font-size:12px;color:rgba(255,255,255,0.4);margin-bottom:8px;">Pumili ng kulay:</div><div style="font-size:24px;font-weight:900;padding:16px 32px;border-radius:14px;border:2px solid rgba(255,255,255,0.15);display:inline-block;margin-bottom:4px;background:rgba(255,255,255,0.05);color:'+colors[target]+';text-shadow:0 0 20px '+colors[target]+'88;">'+names[target]+'</div></div><div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;">'+opts.map(function(i){return '<button onclick="pickColor('+i+')" style="height:70px;border-radius:14px;border:2px solid rgba(255,255,255,0.1);background:'+colors[i]+';cursor:pointer;transition:all 0.15s;opacity:0.9;"></button>';}).join('')+'</div></div>';
    }
    window.pickColor=function(i){
        if(answered)return;answered=true;
        if(i===target){score++;SFX.correct();if(window._cmTimer){clearInterval(window._cmTimer);}timeLeft=30;newRound();startTimer();}
        else{lives--;SFX.wrong();if(lives<=0){clearInterval(window._cmTimer);SFX.gameover();el.innerHTML='<div style="text-align:center;padding:40px 20px;"><div style="font-size:56px;margin-bottom:16px;"></div><div style="font-size:22px;font-weight:900;color:white;margin-bottom:8px;">GAME OVER!</div><div style="font-size:20px;color:#fbbf24;font-weight:800;margin-bottom:24px;">Score: '+score+'</div><button onclick="loadColorMatch()" style="background:linear-gradient(135deg,#8b5cf6,#6d28d9);border:none;color:white;font-size:15px;font-weight:800;padding:14px 32px;border-radius:14px;cursor:pointer;"> Ulit</button></div>';return;}else{newRound();}}
    };
    function startTimer(){window._cmTimer=setInterval(function(){timeLeft--;var el2=document.getElementById('cmTime');if(el2)el2.textContent=timeLeft+'s';if(timeLeft<=5)SFX.countdown();if(timeLeft<=0){clearInterval(window._cmTimer);lives--;SFX.wrong();if(lives<=0){SFX.gameover();el.innerHTML='<div style="text-align:center;padding:40px 20px;"><div style="font-size:56px;margin-bottom:16px;"></div><div style="font-size:22px;font-weight:900;color:white;margin-bottom:8px;">GAME OVER!</div><div style="font-size:20px;color:#fbbf24;font-weight:800;margin-bottom:24px;">Score: '+score+'</div><button onclick="loadColorMatch()" style="background:linear-gradient(135deg,#8b5cf6,#6d28d9);border:none;color:white;font-size:15px;font-weight:800;padding:14px 32px;border-radius:14px;cursor:pointer;"> Ulit</button></div>';return;}timeLeft=30;newRound();}},1000);}
    newRound();startTimer();
}

// ========================
// 10. AI MATH BLITZ
// ========================
function loadMathBlitz() {
    showLoading(' AI ay gumagawa ng math problems...');
    callAI('Generate 12 math problems for a fun blitz game. Mix easy to hard: addition, subtraction, multiplication, division, and simple algebra. Return ONLY valid JSON array: [{"q":"12  8 = ?","a":96}]. Numbers only as answers. No markdown, no extra text.', function(err, data) {
        if (err || !data || !data.length) {
            data=[{q:'12  8',a:96},{q:'45 + 37',a:82},{q:'100  63',a:37},{q:'9  9',a:81},{q:'144  12',a:12},{q:'7  13',a:91},{q:'250 + 175',a:425},{q:'15  15',a:225},{q:'200  84',a:116},{q:'56  7',a:8},{q:'33  3',a:99},{q:'500  237',a:263}];
        }
        runMathBlitz(data);
    });
}

function runMathBlitz(problems) {
    var el=document.getElementById('gameModalContent');
    var idx=0,score=0,timeLeft=10,streak=0;

    function render(){
        if(idx>=problems.length){SFX.win();var mPts=score>=10?50:score>=7?35:score>=4?20:score>=2?10:0;if(mPts>0)awardGamePoints(mPts,'Math Blitz ('+score+'/'+problems.length+')');el.innerHTML='<div style="text-align:center;padding:40px 20px;"><div style="font-size:64px;margin-bottom:16px;"></div><div style="font-size:24px;font-weight:900;color:white;margin-bottom:8px;">TAPOS NA!</div><div style="font-size:22px;color:#fbbf24;font-weight:800;margin-bottom:6px;">Score: '+score+' / '+problems.length+'</div>'+(mPts>0?'<div style="font-size:14px;color:#fbbf24;font-weight:800;margin-bottom:16px;">+'+mPts+' RB Coins! </div>':'')+'<button onclick="loadMathBlitz()" style="background:linear-gradient(135deg,#34d399,#059669);border:none;color:white;font-size:15px;font-weight:800;padding:14px 32px;border-radius:14px;cursor:pointer;"> Bagong AI Problems</button></div>';return;}
        var p=problems[idx];timeLeft=10;
        el.innerHTML='<div style="max-width:320px;margin:0 auto;"><div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;"><div style="font-size:11px;color:rgba(255,255,255,0.35);font-weight:700;">'+(idx+1)+' / '+problems.length+'</div><div style="font-size:12px;font-weight:800;color:#10b981;">Score: '+score+'</div><div id="mbTime" style="background:rgba(52,211,153,0.15);border:1px solid rgba(52,211,153,0.3);border-radius:20px;padding:3px 12px;font-size:14px;font-weight:900;color:#6ee7b7;">10s</div></div><div style="background:rgba(52,211,153,0.08);border:1px solid rgba(52,211,153,0.2);border-radius:18px;padding:28px;text-align:center;margin-bottom:20px;"><div style="font-size:32px;font-weight:900;color:white;margin-bottom:4px;">'+p.q+' = ?</div>'+(streak>=3?'<div style="font-size:11px;color:#fbbf24;font-weight:700;"> Streak x'+streak+'</div>':'')+'</div><div style="display:flex;gap:10px;margin-bottom:12px;"><input id="mbIn" type="number" placeholder="Sagot..." style="flex:1;background:rgba(255,255,255,0.07);border:1px solid rgba(255,255,255,0.14);border-radius:12px;padding:14px;color:white;font-size:20px;font-weight:800;outline:none;text-align:center;" onkeydown="if(event.key===\'Enter\')checkMB()"><button onclick="checkMB()" style="background:linear-gradient(135deg,#34d399,#059669);border:none;color:white;font-size:14px;font-weight:800;padding:14px 18px;border-radius:12px;cursor:pointer;">GO</button></div><div id="mbMsg" style="text-align:center;font-size:14px;font-weight:700;min-height:18px;"></div></div>';
        setTimeout(function(){ var i=document.getElementById('mbIn'); if(i)i.focus(); },100);
        if(window._mbTimer) clearInterval(window._mbTimer);
        window._mbTimer=setInterval(function(){timeLeft--;var te=document.getElementById('mbTime');if(te)te.textContent=timeLeft+'s';if(timeLeft<=3){SFX.countdown();if(te)te.style.color='#ef4444';}if(timeLeft<=0){clearInterval(window._mbTimer);SFX.wrong();streak=0;idx++;render();}},1000);
    }
    window.checkMB=function(){
        var input=document.getElementById('mbIn');if(!input)return;
        var val=parseInt(input.value);
        var msg=document.getElementById('mbMsg');
        clearInterval(window._mbTimer);
        if(val===problems[idx].a){score++;streak++;SFX.correct();msg.textContent=' Tama! '+(streak>=3?' Streak x'+streak:'');msg.style.color='#10b981';}
        else{SFX.wrong();streak=0;msg.textContent=' Mali! Sagot: '+problems[idx].a;msg.style.color='#ef4444';}
        idx++;setTimeout(function(){render();},700);
    };
    render();
}
</script>


<!-- Beats Comment Modal -->
<div id="beatsCommentBackdrop" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.7); z-index:9999; backdrop-filter:blur(5px);" onclick="closeBeatsComments()"></div>

<div id="beatsCommentModal">
    <div class="beats-comment-header">
        <h3>Comments</h3>
        <button class="beats-comment-close" onclick="closeBeatsComments()">
            <i data-lucide="x" style="width:18px;"></i>
        </button>
    </div>
    
    <div class="beats-comment-list" id="beatsCommentList">
        <div class="beats-comment-empty">
            <i data-lucide="message-circle" style="width:40px; height:40px; margin-bottom:10px;"></i>
            <p>No comments yet. Be the first!</p>
        </div>
    </div>
    
    <div class="beats-comment-input-area">
        <form class="beats-comment-input-wrapper" onsubmit="event.preventDefault(); sendBeatsComment();">
            <input 
                type="text" 
                id="beatsCommentInput" 
                class="beats-comment-input" 
                placeholder="Add a comment..."
                autocomplete="off"
            >
            <button type="submit" class="beats-comment-send">
                <i data-lucide="send" style="width:18px;"></i>
            </button>
        </form>
    </div>
</div>

<div id="grandJackpotModal" onclick="this.style.display='none'">
    <div class="jackpot-rays"></div>
    <div class="jackpot-content">
        <div class="icon-glow"><i data-lucide="crown" style="width: 80px; height: 80px;"></i></div>
        <h1 class="jp-title">JACKPOT WIN!</h1>
        <h2 class="jp-amount" id="grandPrizeAmount">10,000 RB COINS</h2>
        <div class="jp-name" id="jpWinnerName">WINNER NAME</div>
        <p style="font-size: 11px; color: white; opacity: 0.7; margin-top: var(--spacing-lg);">Tap anywhere to close</p>
    </div>
</div>

<div id="pmModal" class="pm-modal">

    <!-- INBOX VIEW -->
    <div id="pmInboxView" style="display:flex;flex-direction:column;flex:1;min-height:0;overflow:hidden;">
        <div class="pm-inboxhdr">
            <div class="pm-inboxhdr-title"> Messages</div>
            <button class="pm-hdrbtn" onclick="startCreateGroup()" title="New Group">
                <i data-lucide="users" style="width:18px;height:18px;"></i>
            </button>
            <button onclick="document.getElementById('pmModal').style.display='none'" class="pm-hdrbtn">
                <i data-lucide="x" style="width:18px;height:18px;"></i>
            </button>
        </div>
        <div class="pm-searchwrap">
            <div class="pm-searchwrap-inner">
                <input class="pm-searchinput" type="text" placeholder="Search" oninput="filterPmList(this.value)">
            </div>
        </div>
        <div class="pm-activebar" id="pmActiveFriendsBar">
            <span class="pm-activelabel">Active</span>
        </div>
        <div id="pmList" class="pm-inbox-list">
            <!-- Skeleton loading placeholders -->
            <div class="pm-skeleton"><div class="pm-skel-avatar"></div><div class="pm-skel-info"><div class="pm-skel-line"></div><div class="pm-skel-line"></div></div></div>
            <div class="pm-skeleton"><div class="pm-skel-avatar"></div><div class="pm-skel-info"><div class="pm-skel-line"></div><div class="pm-skel-line"></div></div></div>
            <div class="pm-skeleton"><div class="pm-skel-avatar"></div><div class="pm-skel-info"><div class="pm-skel-line"></div><div class="pm-skel-line"></div></div></div>
            <div class="pm-skeleton"><div class="pm-skel-avatar"></div><div class="pm-skel-info"><div class="pm-skel-line"></div><div class="pm-skel-line"></div></div></div>
        </div>
    </div>

    <!-- CHAT VIEW -->
    <div id="pmChatView" style="display:none;flex-direction:column;flex:1;min-height:0;overflow:hidden;">
        <div class="pm-chathdr">
            <button onclick="backToInbox()" class="pm-hdrbtn">
                <i data-lucide="arrow-left" style="width:18px;"></i>
            </button>
            <div id="chatTargetAvatarCont" style="width:40px;height:40px;flex-shrink:0;"></div>
            <div style="flex:1;min-width:0;margin-left:8px;">
                <div class="pm-chatname" id="chatTargetName">User</div>
                <div class="pm-chatstatus" id="chatTargetStatus">Active now</div>
            </div>
            <button onclick="deleteConversation()" class="pm-hdrbtn" style="color:var(--danger);">
                <i data-lucide="trash-2" style="width:18px;"></i>
            </button>
        </div>

        <!-- Messages -->
        <div id="pmMessages" class="pm-msgarea">
            <div id="pmTypingIndicator" class="pm-typing2">
                <div class="tdot2"></div><div class="tdot2"></div><div class="tdot2"></div>
            </div>
        </div>

        <!-- Attached image strip -->
        <div id="pmImgStrip2" class="pm-imgstrip2">
            <img id="pmImgThumb2" src="" alt="">
            <button onclick="clearPmImage()" style="background:rgba(239,68,68,.2);border:1px solid #ef4444;border-radius:50%;width:28px;height:28px;color:#ef4444;cursor:pointer;font-size:18px;display:flex;align-items:center;justify-content:center;flex-shrink:0;"></button>
        </div>

        <!-- Emoji panel -->
        <div id="pmEmojiPanel2" class="pm-panel2">
            <span class="pm-emj" onclick="insertEmoji2('')"></span><span class="pm-emj" onclick="insertEmoji2('')"></span>
            <span class="pm-emj" onclick="insertEmoji2('')"></span><span class="pm-emj" onclick="insertEmoji2('')"></span>
            <span class="pm-emj" onclick="insertEmoji2('')"></span><span class="pm-emj" onclick="insertEmoji2('')"></span>
            <span class="pm-emj" onclick="insertEmoji2('')"></span><span class="pm-emj" onclick="insertEmoji2('')"></span>
            <span class="pm-emj" onclick="insertEmoji2('')"></span><span class="pm-emj" onclick="insertEmoji2('')"></span>
            <span class="pm-emj" onclick="insertEmoji2('')"></span><span class="pm-emj" onclick="insertEmoji2('')"></span>
        </div>

        <!-- Sticker panel -->
        <div id="pmStickerPanel2" class="pm-panel2">
            <span class="pm-stk" onclick="sendSticker2('')"></span><span class="pm-stk" onclick="sendSticker2('')"></span>
            <span class="pm-stk" onclick="sendSticker2('')"></span><span class="pm-stk" onclick="sendSticker2('')"></span>
            <span class="pm-stk" onclick="sendSticker2('')"></span><span class="pm-stk" onclick="sendSticker2('')"></span>
            <span class="pm-stk" onclick="sendSticker2('')"></span><span class="pm-stk" onclick="sendSticker2('')"></span>
            <span class="pm-stk" onclick="sendSticker2('')"></span><span class="pm-stk" onclick="sendSticker2('')"></span>
            <span class="pm-stk" onclick="sendSticker2('')"></span><span class="pm-stk" onclick="sendSticker2('')"></span>
            <span class="pm-stk" onclick="sendSticker2('')"></span><span class="pm-stk" onclick="sendSticker2('')"></span>
            <span class="pm-stk" onclick="sendSticker2('')"></span><span class="pm-stk" onclick="sendSticker2('')"></span>
            <span class="pm-stk" onclick="sendSticker2('')"></span><span class="pm-stk" onclick="sendSticker2('')"></span>
            <span class="pm-stk" onclick="sendSticker2('')"></span><span class="pm-stk" onclick="sendSticker2('')"></span>
        </div>

        <!-- Footer -->
        <div class="pm-footer2">
            <div class="pm-inputrow">
                <button class="pm-iconbtn2" onclick="togglePmPanel2('emoji')" title="Emoji">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><path d="M8 13s1.5 2 4 2 4-2 4-2"/><line x1="9" y1="9" x2="9.01" y2="9"/><line x1="15" y1="9" x2="15.01" y2="9"/></svg>
                </button>
                <button class="pm-iconbtn2" onclick="togglePmPanel2('sticker')" title="Stickers">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2a10 10 0 0 1 10 10c0 5.52-4.48 10-10 10S2 17.52 2 12c0-2.76 1.12-5.26 2.93-7.07"/><path d="M12 12v.01"/><path d="M16.24 7.76A6 6 0 0 1 18 12h-6"/></svg>
                </button>
                <label for="pmImgInput" class="pm-iconbtn2" style="cursor:pointer;" title="Photo">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2"/><circle cx="8.5" cy="8.5" r="1.5"/><polyline points="21 15 16 10 5 21"/></svg>
                </label>
                <input type="file" id="pmImgInput" accept="image/*" style="display:none" onchange="handlePmImage(this)">
                <input type="text" id="pmInput" class="pm-newinput" placeholder="Aa" autocomplete="off"
                    onkeypress="if(event.key==='Enter'){event.preventDefault();sendPrivateMessage();}"
                    onfocus="setTimeout(function(){var f=document.querySelector('.pm-footer2');if(f)f.scrollIntoView({block:'end',behavior:'smooth'});},400);"
                    oninput="onPmType()">
                <button id="pmVoiceBtn2" class="pm-iconbtn2" title="Voice"
                    onmousedown="startVoice2()" onmouseup="stopVoice2()"
                    ontouchstart="event.preventDefault();startVoice2()" ontouchend="event.preventDefault();stopVoice2()">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"/><path d="M19 10v2a7 7 0 0 1-14 0v-2"/><line x1="12" y1="19" x2="12" y2="23"/><line x1="8" y1="23" x2="16" y2="23"/></svg>
                </button>
                <button class="pm-sendbtn2" onclick="sendPrivateMessage()" title="Send">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg>
                </button>
            </div>
        </div>
    </div>

    <!-- GROUP CREATE VIEW -->
    <div id="pmCreateGroupView" style="display:none;flex-direction:column;flex:1;min-height:0;overflow:hidden;background:#000;">
        <div class="pm-inboxhdr">
            <button onclick="cancelCreateGroup()" class="pm-hdrbtn"><i data-lucide="arrow-left" style="width:18px;"></i></button>
            <div style="flex:1;font-size:17px;font-weight:900;color:white;">New Group</div>
            <button onclick="finalizeCreateGroup()" style="color:var(--accent);background:none;border:none;font-weight:900;font-size:15px;cursor:pointer;">CREATE</button>
        </div>
        <div style="padding:var(--spacing-lg);">
            <input type="text" id="newGroupName" class="styled-input" placeholder="Group Name">
            <h4 style="color:#94a3b8;margin-top:var(--spacing-lg);font-size:12px;text-transform:uppercase;">Select Friends</h4>
            <div id="friendSelectContainer" style="margin-top:10px;"></div>
        </div>
    </div>
</div>
<!-- NOTIFICATION BOTTOM SHEET -->
<div id="notifOverlay" onclick="closeNotifSheet()" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.6); z-index:9998; backdrop-filter:blur(4px);"></div>
<div id="notifSheet" style="display:none; position:fixed; bottom:0; left:0; right:0; z-index:9999; background:#0f172a; border-radius:24px 24px 0 0; max-height:92vh; flex-direction:column; border-top:1px solid rgba(255,255,255,0.1); box-shadow:0 -8px 40px rgba(0,0,0,0.6);">
    <!-- Drag Handle -->
    <div style="display:flex; justify-content:center; padding:12px 0 0;" onclick="closeNotifSheet()">
        <div style="width:40px; height:4px; background:rgba(255,255,255,0.2); border-radius:2px;"></div>
    </div>
    <!-- Header -->
    <div style="display:flex; justify-content:space-between; align-items:center; padding:12px 20px 10px;">
        <div>
            <div style="font-size:20px; font-weight:900; color:white; letter-spacing:-0.4px;">Notifications</div>
            <div id="notifSubtitle" style="font-size:12px; color:rgba(255,255,255,0.4); margin-top:1px;"></div>
        </div>
        <div style="display:flex; align-items:center; gap:8px;">
            <button onclick="clearAllNotifs()" id="clearAllBtn" style="display:none; background:rgba(239,68,68,0.1); border:1px solid rgba(239,68,68,0.2); color:#f87171; border-radius:20px; padding:7px 14px; font-size:11px; font-weight:800; cursor:pointer; letter-spacing:0.3px;">Clear all</button>
            <button onclick="closeNotifSheet()" style="background:rgba(255,255,255,0.08); border:none; color:rgba(255,255,255,0.6); width:34px; height:34px; border-radius:50%; display:flex; align-items:center; justify-content:center; cursor:pointer; font-size:20px; line-height:1;"></button>
        </div>
    </div>
    <!-- Filter Pills -->
    <div style="display:flex; gap:8px; padding:0 16px 12px; overflow-x:auto; -webkit-overflow-scrolling:touch; scrollbar-width:none;">
        <button class="notif-filter-tab active" id="nftab-all"     onclick="switchNotifTab('all')">All</button>
        <button class="notif-filter-tab" id="nftab-like"    onclick="switchNotifTab('like')"><i data-lucide="heart" style="width:12px;height:12px;vertical-align:middle;color:#f87171;"></i> Reactions</button>
        <button class="notif-filter-tab" id="nftab-comment" onclick="switchNotifTab('comment')"><i data-lucide="message-circle" style="width:12px;height:12px;vertical-align:middle;color:#38bdf8;"></i> Comments</button>
        <button class="notif-filter-tab" id="nftab-mention" onclick="switchNotifTab('mention')">@ Mentions</button>
        <button class="notif-filter-tab" id="nftab-follow"  onclick="switchNotifTab('follow')"><i data-lucide="user" style="width:12px;height:12px;vertical-align:middle;color:#a3e635;"></i> Follows</button>
    </div>
    <div style="height:1px; background:rgba(255,255,255,0.07); margin:0 0 4px;"></div>
    <!-- List -->
    <div id="notifList" style="overflow-y:auto; flex:1; padding-bottom:calc(16px + env(safe-area-inset-bottom));"></div>
</div>
<!-- keep old modal ID for any legacy code that references it -->
<div id="notifModal" style="display:none;"></div>

<div id="userOptionsModal" class="modal" onclick="this.style.display='none'">
    <div class="modal-content" onclick="event.stopPropagation()" style="text-align:center;">
        <div id="optUserAvatarCont" style="display:flex; justify-content:center; margin-bottom: var(--spacing-sm);"></div>
        <h3 id="optUserName" style="margin:0 0 20px 0; color:white;">User</h3>
        
        <button class="user-opt-btn" onclick="openUserProfile(targetUserForOpt.uid)"><i data-lucide="user"></i> View Profile</button>
        <button class="user-opt-btn" onclick="optAddFriend()"><i data-lucide="user-plus"></i> Add Friend</button>
        <button class="user-opt-btn" onclick="optSendMessage()"><i data-lucide="message-circle"></i> Send Message</button>
        <button class="user-opt-btn" onclick="document.getElementById('userOptionsModal').style.display='none'"><i data-lucide="x"></i> Close</button>
    </div>
</div>

<div id="commentModalBackdrop" class="comment-modal-backdrop" onclick="closeComments()"></div>
<div id="commentModal" class="comment-modal">
    <div class="comment-header">
        <h3 style="margin:0; font-size:16px;">Comments</h3>
        <button onclick="closeComments()" style="background:none; border:none; color:white;"><i data-lucide="x"></i></button>
    </div>
    <div id="commentList" class="comment-list"></div>
    <form class="comment-input-area" onsubmit="event.preventDefault(); sendComment();">
        <div id="commentPreviewBox" class="comment-preview-box">
            <div class="comment-preview-label">Preview</div>
            <div class="comment-preview-content">
                <img id="commentPreviewAvatar" class="comment-preview-avatar" src="https://via.placeholder.com/40" alt="Your avatar">
                <div class="comment-preview-bubble">
                    <div id="commentPreviewText" class="comment-preview-text"></div>
                </div>
            </div>
        </div>
        <div class="comment-input-row">
            <input type="text" id="commentInput" class="comment-input" placeholder="Write a comment..." autocomplete="off" oninput="updateCommentPreview()">
            <button type="submit" style="background:none; border:none; color:var(--accent);"><i data-lucide="send"></i></button>
        </div>
    </form>
</div>

<div id="shareModalBackdrop" class="share-modal-backdrop" onclick="closeShareModal()"></div>
<div id="shareModal" class="share-modal">
    <div class="share-header">
        <h3 style="margin:0; font-size:16px;">Share Post</h3>
        <button onclick="closeShareModal()" style="background:none; border:none; color:white;"><i data-lucide="x"></i></button>
    </div>
    <div class="share-content">
        <div class="share-post-preview" id="sharePreview"></div>
        <textarea id="shareCaption" placeholder="Add a caption (optional)..." style="width:100%; min-height:60px; background:rgba(255,255,255,0.05); border:1px solid rgba(255,255,255,0.1); border-radius:10px; color:white; padding:10px; margin-bottom:10px; resize:vertical; font-family:'Inter',sans-serif;"></textarea>
        <button class="share-btn-option" onclick="shareToOwnProfile()">
            <i data-lucide="user" style="width:20px;"></i>
            <span>Share to My Profile</span>
        </button>
        <button class="share-btn-option" id="nativeShareBtn" onclick="shareViaWebShare()">
            <i data-lucide="share-2" style="width:20px;"></i>
            <span>Share via...</span>
        </button>
        <button class="share-btn-option" id="copyLinkBtn" onclick="copyPostLink()" style="display:none;">
            <i data-lucide="link" style="width:20px;"></i>
            <span>Copy Link</span>
        </button>
    </div>
</div>

<!-- PYMK Profile Preview Modal -->
<div id="pymkPreviewBackdrop" style="position:fixed; inset:0; background:rgba(0,0,0,0.8); z-index:9998; display:none; backdrop-filter:blur(4px);" onclick="closePYMKPreview()"></div>
<div id="pymkPreviewModal" style="position:fixed; top:50%; left:50%; transform:translate(-50%,-50%); width:90%; max-width:400px; background:linear-gradient(145deg,rgba(30,41,59,0.98),rgba(22,27,34,0.98)); border-radius:20px; border:1px solid rgba(255,255,255,0.1); z-index:9999; display:none; overflow:hidden; box-shadow:0 20px 60px rgba(0,0,0,0.6);">
    <div style="padding:24px; text-align:center;">
        <button onclick="closePYMKPreview()" style="position:absolute; top:12px; right:12px; background:rgba(255,255,255,0.1); border:none; width:32px; height:32px; border-radius:50%; color:white; display:flex; align-items:center; justify-content:center; cursor:pointer;">
            <i data-lucide="x" style="width:16px;"></i>
        </button>
        <div id="pymkPreviewContent"></div>
    </div>
</div>

<div id="reactionViewerBackdrop" class="reaction-viewer-backdrop" onclick="closeReactionViewer()"></div>
<div id="reactionViewerModal" class="reaction-viewer-modal">
    <div class="reaction-viewer-header">
        <h3 style="margin:0; font-size:16px;">Reactions</h3>
        <button onclick="closeReactionViewer()" style="background:none; border:none; color:white;" aria-label="Close reactions"><i data-lucide="x"></i></button>
    </div>
    <div id="reactionViewerList" class="reaction-viewer-list"></div>
</div>

<div id="searchModal" class="search-modal-container">
    <div class="search-header">
        <button onclick="document.getElementById('searchModal').style.display='none'" style="background:none; border:none; color:white;"><i data-lucide="arrow-left"></i></button>
        <div class="search-bar-wrap">
            <i data-lucide="search" style="width:16px; opacity:0.5;"></i>
            <input type="text" id="searchInput" class="search-input" placeholder="Search users or posts..." onkeyup="handleSearch()">
        </div>
    </div>
    <div id="searchResults" class="search-results">
        <div style="text-align:center; opacity:0.5; padding: var(--spacing-lg);">Type to search...</div>
    </div>
</div>

<div id="userProfilePage" class="profile-page-container">
    <button class="profile-nav-back" onclick="closeProfilePage()">
        <i data-lucide="arrow-left"></i>
    </button>
    
    <!-- 3-Dot Menu Button (Only shown for own profile) -->
    <button id="profileMenuBtn" class="profile-menu-btn" style="display:none;" onclick="toggleProfileMenu(event)">
        <i data-lucide="more-vertical"></i>
    </button>
    
    <!-- Dropdown Menu -->
    <div id="profileDropdown" class="profile-dropdown">
        <div class="dropdown-item" onclick="requestVerificationBadge()">
            <i data-lucide="shield-check"></i>
            <span>Request Verification Badge</span>
        </div>
        <div class="dropdown-item" onclick="openSettings()">
            <i data-lucide="settings"></i>
            <span>Settings</span>
        </div>
    </div>
    
    <div class="profile-cover" id="pageProfileCover"></div>
    
    <div class="profile-info-section">
        <div class="profile-avatar-container" id="pageProfileAvatarContainer">
             </div>
        
        <h2 id="pageProfileName" class="profile-page-name">User Name</h2>
        <p id="pageProfileBio" class="profile-page-bio">Radio Bingo Player</p>
        
        <div class="profile-btn-group">
            <button id="profileMainActionBtn" class="profile-action-btn" onclick="handleProfileMainAction()">Add Friend</button>
            
            <button id="creatorMessageBtn" class="profile-action-btn" style="display:none; background:linear-gradient(135deg, var(--accent), var(--accent-glow)); border:none; box-shadow: 0 4px 20px rgba(14, 165, 233, 0.4); color: white;">
                <i data-lucide="message-circle" style="width:16px"></i> Message
            </button>
            
            <button id="giftSkinBtn" class="profile-action-btn" style="display:none; background:linear-gradient(135deg, #f59e0b, #d97706); border:none; box-shadow: 0 4px 20px rgba(245, 158, 11, 0.4); color: white;">
                <i data-lucide="gift" style="width:16px"></i> Gift Skin
            </button>
            
            <button id="unfriendBtn" class="btn-unfriend-modern" style="display:none;" onclick="unfriendUser()">
                <i data-lucide="user-x" style="width:16px"></i> Unfriend
            </button>
        </div>
        
        <div class="profile-stats-card">
            <div class="stat-item">
                <span class="stat-val" id="statFriends">0</span>
                <span class="stat-lbl"><i data-lucide="users" style="width:12px; vertical-align:middle;"></i> Followers</span>
            </div>
            <div class="stat-item">
                <span class="stat-val" id="statLikes">0</span>
                <span class="stat-lbl"><i data-lucide="heart" style="width:12px; vertical-align:middle;"></i> Likes</span>
            </div>
             <div class="stat-item">
                <span class="stat-val" id="statPosts">0</span>
                <span class="stat-lbl"><i data-lucide="image" style="width:12px; vertical-align:middle;"></i> Posts</span>
            </div>
        </div>
        
        <div id="pageProfileFeed" class="profile-feed-section"></div>
    </div>
</div>

<div id="editProfileModal" class="modal" onclick="this.style.display='none'">
    <div class="modal-content" onclick="event.stopPropagation()">
        <h3 style="margin-top:0; color:white;">Edit Profile</h3>
        
        <label class="edit-label">Display Name</label>
        <input type="text" id="editNameIn" class="edit-input" placeholder="Your Name">
        
        <label class="edit-label">Bio</label>
        <input type="text" id="editBioIn" class="edit-input" placeholder="Short bio...">
        
        <label class="edit-label">Change Profile Picture</label>
        <input type="file" id="editProfilePicInput" class="edit-input" accept="image/*" onchange="handleProfileUpload(this, 'pfp')">
        
        <label class="edit-label">Change Cover Photo</label>
        <input type="file" id="editCoverPicInput" class="edit-input" accept="image/*" onchange="handleProfileUpload(this, 'cover')">

        <button onclick="saveProfileChanges()" style="width:100%; padding: var(--spacing-md); background:var(--accent); border:none; border-radius: var(--radius-md); font-weight:900; color:white; cursor:pointer;">SAVE CHANGES</button>
    </div>
</div>

<div id="giftSkinModal" class="modal" onclick="this.style.display='none'">
    <div class="modal-content" onclick="event.stopPropagation()">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom: var(--spacing-md); border-bottom: 1px solid rgba(255,255,255,0.05); padding-bottom: 15px;">
            <div>
                <h3 style="margin:0; font-size: 18px; font-weight: 900;" id="giftModalTitle">Gift a Skin</h3>
                <p style="margin: 5px 0 0 0; font-size: 11px; opacity: 0.8; font-weight: 600;">Select a skin to gift</p>
            </div>
            <button onclick="document.getElementById('giftSkinModal').style.display='none'" style="background:none; border:none; color:white; cursor:pointer;"><i data-lucide="x"></i></button>
        </div>
        <div id="giftableSkinsList" class="skins-grid">
            <!-- Dynamically populated -->
        </div>
    </div>
</div>

<div id="installGuideModal" class="modal" onclick="this.style.display='none'">
    <div class="modal-content" onclick="event.stopPropagation()">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom: var(--spacing-md);">
            <h3 style="margin:0; font-size:18px; font-weight:900;">INSTALL GUIDE</h3>
            <button onclick="document.getElementById('installGuideModal').style.display='none'" style="background:none; border:none; color:white;"><i data-lucide="x"></i></button>
        </div>
        <div class="install-tabs">
            <button class="install-tab-btn active" id="tabAndroid" onclick="showGuide('android')">ANDROID</button>
            <button class="install-tab-btn" id="tabIOS" onclick="showGuide('ios')">iOS</button>
        </div>
        <div id="guideAndroidContent">
            <div class="guide-step"><div class="step-num">1</div><div class="step-text">Pindutin ang <b>Three Dots ()</b> sa upper right corner ng Google Chrome browser.</div></div>
            <div class="guide-step"><div class="step-num">2</div><div class="step-text">Tap <b>"Install App"</b> or <b>"Add to Home Screen"</b>.</div></div>
            <div class="guide-step"><div class="step-num">3</div><div class="step-text">Click <b>Install</b> to add it to your home screen.</div></div>
        </div>
        <div id="guideIOSContent" style="display:none;">
            <div class="guide-step"><div class="step-num">1</div><div class="step-text">Gamitin ang <b>Safari Browser</b> at pindutin ang <b>Share Icon</b> <i data-lucide="share" style="width:12px"></i> sa ibaba.</div></div>
            <div class="guide-step"><div class="step-num">2</div><div class="step-text">Scroll down and tap <b>"Add to Home Screen"</b> <i data-lucide="plus-square" style="width:12px"></i>.</div></div>
            <div class="guide-step"><div class="step-num">3</div><div class="step-text">Click <b>Add</b> sa upper right corner.</div></div>
        </div>
    </div>
</div>

<div id="menuModal" class="modal" onclick="this.style.display='none'">
    <div class="modal-content" onclick="event.stopPropagation()">
        <div class="profile-header">
            <div id="menuAvatarContainer"></div>
            <div class="profile-name-info">
                <h2 class="profile-name" id="profileNameDisplay">User Name</h2>
                <span class="profile-uid" id="profileUidDisplay">UID: ---</span>
            </div>
            <button onclick="document.getElementById('menuModal').style.display='none'" style="background:none; border:none; color:white; opacity:0.5;"><i data-lucide="x"></i></button>
        </div>
        <div class="gcash-section">
            <span style="font-size:10px; font-weight:800; color:var(--accent-glow); text-transform:uppercase; margin-bottom: var(--spacing-sm); display:flex; align-items:center; gap:5px;"><i data-lucide="credit-card" style="width:12px"></i> Email / Redemption Info</span>
            <div style="display:flex; gap: var(--spacing-sm);">
                <input type="text" id="gcashInput" class="styled-input" placeholder="Enter email or details">
                <button onclick="saveGcash(); playSound('click');" style="background:var(--accent); border:none; color:white; padding:0 20px; border-radius: var(--radius-md); font-weight:800; font-size:12px; cursor:pointer; box-shadow:0 4px 10px rgba(59, 130, 246, 0.3);">SAVE</button>
            </div>
        </div>
        <div class="ref-container">
            <span style="font-size:10px; font-weight:800; color:var(--success); text-transform:uppercase; margin-bottom: var(--spacing-sm); display:flex; align-items:center; gap:5px;"><i data-lucide="share-2" style="width:12px"></i> Invite & Earn</span>
            <input type="text" id="refLink" readonly class="styled-input" style="background:rgba(0,0,0,0.2); text-align:center; cursor:pointer; margin-bottom: var(--spacing-sm);" onclick="this.select(); document.execCommand('copy'); showToast('Copied Link!'); playSound('click');">
            <div id="referralInputSection">
                <span style="font-size:10px; font-weight:800; color:var(--gold); text-transform:uppercase; margin-bottom: var(--spacing-sm); display:flex; align-items:center; gap:5px; margin-top:15px;"><i data-lucide="ticket" style="width:12px"></i> Claim Referral Code</span>
                <div style="display:flex; gap: var(--spacing-sm);">
                    <input type="text" id="referralInput" class="styled-input" placeholder="ENTER CODE">
                    <button onclick="claimReferral(); playSound('click');" style="background:var(--gold); border:none; color:black; padding:0 20px; border-radius: var(--radius-md); font-weight:800; font-size:12px; cursor:pointer; box-shadow:0 4px 10px rgba(251, 191, 36, 0.3);">CLAIM</button>
                </div>
            </div>
        </div>
        <div class="history-box">
            <span style="font-size:10px; font-weight:800; color:white; text-transform:uppercase; margin-bottom: var(--spacing-sm); display:flex; align-items:center; gap:5px;"><i data-lucide="history" style="width:12px"></i> Transaction History</span>
            <div id="historyList" class="history-list"></div>
        </div>
        
        <div style="margin-top:15px; border-top:1px solid rgba(255,255,255,0.1); padding-top:10px;">
            <button onclick="openBookmarks(); playSound('click');" style="display:flex; align-items:center; gap: var(--spacing-xs); color:#fbbf24; font-size:12px; padding:8px 0; text-decoration:none; background:none; border:none; cursor:pointer; width:100%; text-align:left;">
                <i data-lucide="bookmark" style="width:14px;"></i>
                Saved Posts
            </button>
            <button onclick="exploreHashtag('bingo'); playSound('click');" style="display:flex; align-items:center; gap: var(--spacing-xs); color:var(--accent); font-size:12px; padding:8px 0; text-decoration:none; background:none; border:none; cursor:pointer; width:100%; text-align:left;">
                <i data-lucide="hash" style="width:14px;"></i>
                Explore Hashtags
            </button>
            <button onclick="openSupportModal(); playSound('click');" style="display:flex; align-items:center; gap: var(--spacing-xs); color:#94a3b8; font-size:12px; padding:8px 0; text-decoration:none; background:none; border:none; cursor:pointer; width:100%; text-align:left;">
                <i data-lucide="message-square" style="width:14px;"></i>
                Contact Support
            </button>
            <a href="about.html" style="display:block; color:#94a3b8; font-size:12px; padding:8px 0; text-decoration:none;">About Us</a>
            <a href="privacy.html" style="display:block; color:#94a3b8; font-size:12px; padding:8px 0; text-decoration:none;">Privacy Policy</a>
            <a href="terms.html" style="display:block; color:#94a3b8; font-size:12px; padding:8px 0; text-decoration:none;">Terms of Service</a>
        </div>

        <button onclick="auth.signOut().then(()=>location.reload())" style="width:100%; padding:14px; background:rgba(239, 68, 68, 0.1); color:var(--danger); border:1px solid rgba(239, 68, 68, 0.2); border-radius:14px; font-weight:800; margin-top: var(--spacing-lg); cursor:pointer; display:flex; align-items:center; justify-content:center; gap: var(--spacing-xs);">
            <i data-lucide="log-out" style="width:18px"></i> Sign Out
        </button>
    </div>
</div>

<div id="storeModal" class="modal">
    <div class="modal-content" onclick="event.stopPropagation()">
        <!-- Store Header (Fixed) -->
        <div class="store-header">
            <div class="store-header-top">
                <button class="store-back-btn" onclick="document.getElementById('storeModal').style.display='none'" aria-label="Close store">
                    <i data-lucide="x"></i>
                </button>
                <div class="store-title-section">
                    <h3>MARKETPLACE</h3>
                    <p>Redeem, Shop Skins, or Earn</p>
                </div>
                <div class="points-badge" style="height:35px; border-radius: var(--radius-sm);"><i data-lucide="coins" style="width:14px"></i> <span id="storePoints">0</span></div>
            </div>
            <div class="store-nav">
                <button class="store-tab-btn active" onclick="switchStoreTab('cashout')" id="tabBtnCash">Cash Out</button>
                <button class="store-tab-btn" onclick="switchStoreTab('skins')" id="tabBtnSkins">Skins</button>
                <button class="store-tab-btn" onclick="switchStoreTab('earn')" id="tabBtnEarn" style="color:var(--gold);">Tasks</button>
            </div>
        </div>
        
        <!-- Store Body (Scrollable) -->
        <div class="store-body">
            <div class="glass-panel" style="padding: var(--spacing-md); border-radius: var(--radius-lg); margin-bottom: var(--spacing-lg); border: 1px dashed var(--gold); text-align: center; position: relative; overflow: hidden;">
                <h4 style="margin: 0 0 10px 0; color: var(--gold); font-size: 14px; text-transform: uppercase;"><i data-lucide="zap" style="width:14px;height:14px;vertical-align:middle;color:#fbbf24;"></i> FREE RB COINS</h4>
                <div id="adTimerOverlay" style="display: none; position: absolute; inset: 0; background: rgba(15, 23, 42, 0.98); z-index: 50; align-items: center; justify-content: center; flex-direction: column;">
                    <div id="adStatusIcon" style="font-size: 30px; margin-bottom: var(--spacing-sm);"><i data-lucide="tv-2" style="width:40px;height:40px;vertical-align:middle;color:#94a3b8;"></i></div>
                    <div style="font-size: 18px; font-weight: 900; color: white;" id="adCountdown">30s</div>
                    <div style="font-size: 12px; color: #ef4444; padding: 0 20px; margin-top: 5px; font-weight:800;" id="adStatusText">Do not close app or switch tabs!</div>
                </div>
                <div id="adCaptchaOverlay" style="display: none; position: absolute; inset: 0; background: rgba(15, 23, 42, 0.98); z-index: 51; align-items: center; justify-content: center; flex-direction: column;">
                    <div style="font-size: 14px; font-weight: 700; color: var(--accent-glow); margin-bottom: var(--spacing-sm);">HUMAN VERIFICATION</div>
                    <div style="background: rgba(255,255,255,0.1); padding: var(--spacing-sm); border-radius: var(--radius-md); margin-bottom: var(--spacing-sm);">
                        <span id="mathQ" style="font-size: 20px; font-weight: 900; color: white;">5 + 3 = ?</span>
                    </div>
                    <div style="display: flex; gap: 5px;">
                        <input type="number" id="mathAns" style="width: 60px; padding: 8px; border-radius: var(--radius-sm); border: 1px solid var(--accent); background: #0f172a; color: white; text-align: center; font-weight: 800;">
                        <button onclick="verifyAdMath()" style="background: var(--success); border: none; padding: 8px 12px; border-radius: var(--radius-sm); color: white; font-weight: 900;">OK</button>
                    </div>
                </div>
                <button id="btnWatchAd" onclick="startStrictWatch()" style="background: linear-gradient(135deg, #f59e0b, #b45309); width: 100%; border: none; padding: var(--spacing-md); border-radius: var(--radius-md); font-weight: 900; color: white; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: var(--spacing-sm); font-size: 14px; box-shadow: 0 5px 15px rgba(245, 158, 11, 0.4); text-shadow: 0 1px 2px black;">
                    <i data-lucide="play-circle" style="width: 20px;"></i> WATCH AD (+30 Coins)
                </button>
                <p style="font-size: 10px; opacity: 0.6; margin-top: 8px; color:var(--danger);">*Timer pauses if you leave the app!</p>
            </div>

            <div id="storeSection-cashout" style="display:block;">
                <div class="reward-grid">
                    <div class="reward-item">
                        <div class="reward-main"><div class="reward-icon-box"><i data-lucide="gift" style="width:22px"></i></div><div class="reward-info"><b>20 GCash</b><small><i data-lucide="database" style="width:10px"></i> 50,000 Coins</small></div></div>
                        <button class="btn-redeem" onclick="redeemItem('20 GCash', 50000)">Redeem</button>
                    </div>
                    <div class="reward-item">
                        <div class="reward-main"><div class="reward-icon-box" style="color:var(--gold); background:rgba(251, 191, 36, 0.1); border-color:rgba(251, 191, 36, 0.3);"><i data-lucide="gift" style="width:22px"></i></div><div class="reward-info"><b>50 GCash</b><small><i data-lucide="database" style="width:10px"></i> 150,000 Coins</small></div></div>
                        <button class="btn-redeem" onclick="redeemItem('50 GCash', 150000)">Redeem</button>
                    </div>
                    <div class="reward-item">
                        <div class="reward-main"><div class="reward-icon-box" style="color:var(--success); background:rgba(16, 185, 129, 0.1); border-color:rgba(16, 185, 129, 0.3);"><i data-lucide="gift" style="width:22px"></i></div><div class="reward-info"><b>100 GCash</b><small><i data-lucide="database" style="width:10px"></i> 250,000 Coins</small></div></div>
                        <button class="btn-redeem" onclick="redeemItem('100 GCash', 250000)">Redeem</button>
                    </div>
                </div>
                <p style="text-align: center; font-size: 10px; opacity: 0.6; margin-top: 25px; line-height: 1.5; text-shadow:0 1px 2px black;">*Processing may take 24-48 hours.<br>Make sure your redemption details are correct.</p>
            </div>

            <div id="storeSection-skins" style="display:none;">
                <p style="font-size:11px; opacity:0.7; margin-bottom: var(--spacing-md); text-align:center;">Customize your Bingo Card. Look rich, play rich.</p>
                
                <div style="margin-bottom: var(--spacing-lg); padding: var(--spacing-md); background:rgba(255,255,255,0.05); border-radius: var(--radius-md); text-align:center;">
                    <label style="font-size:12px; font-weight:700; display:block; margin-bottom: var(--spacing-sm); color:var(--accent-glow);">UPLOAD CUSTOM BACKGROUND</label>
                    <input type="file" accept="image/*" id="customSkinInput" style="display:none" onchange="handleCustomSkinUpload(this)">
                    <button onclick="document.getElementById('customSkinInput').click()" style="background:var(--accent); color:white; border:none; padding:8px 15px; border-radius: var(--radius-sm); font-weight:800; font-size:11px; cursor:pointer;">CHOOSE IMAGE</button>
                </div>

                <div class="skins-grid">
                    <div class="skin-item"><div class="skin-preview" style="background:rgba(30,41,59,0.8); border:1px solid rgba(255,255,255,0.1);">B</div><div class="skin-name">Classic</div><div class="skin-cost">Free</div><button class="btn-buy-skin equip" id="btn-skin-default" onclick="equipSkin('default')">EQUIP</button></div>
                    
                    <div class="skin-item"><div class="skin-preview" style="background:pink; border:2px solid hotpink; color:deeppink; font-family:'Comic Neue',cursive;">B</div><div class="skin-name">Hello Kitty</div><div class="skin-cost">75,000 Coins</div><button class="btn-buy-skin buy" id="btn-skin-kitty" onclick="buyOrEquipSkin('kitty', 75000)">BUY</button></div>
                    
                    <div class="skin-item"><div class="skin-preview" style="background:#0096df; border:2px solid white; color:white; border-radius:50%;">B</div><div class="skin-name">Doraemon</div><div class="skin-cost">75,000 Coins</div><button class="btn-buy-skin buy" id="btn-skin-doraemon" onclick="buyOrEquipSkin('doraemon', 75000)">BUY</button></div>
                    
                    <div class="skin-item"><div class="skin-preview" style="background:#f7f44d; border:2px dashed brown; color:brown;">B</div><div class="skin-name">SpongeBob</div><div class="skin-cost">75,000 Coins</div><button class="btn-buy-skin buy" id="btn-skin-spongebob" onclick="buyOrEquipSkin('spongebob', 75000)">BUY</button></div>
                    
                    <div class="skin-item"><div class="skin-preview" style="background:black; border:2px solid purple; color:pink;">B</div><div class="skin-name">Kuromi</div><div class="skin-cost">75,000 Coins</div><button class="btn-buy-skin buy" id="btn-skin-kuromi" onclick="buyOrEquipSkin('kuromi', 75000)">BUY</button></div>

                    <div class="skin-item"><div class="skin-preview" style="background:rgba(8,51,68,1); border:2px solid #06b6d4; color:#67e8f9; text-shadow:0 0 5px #06b6d4;">B</div><div class="skin-name">Neon City</div><div class="skin-cost">50,000 Coins</div><button class="btn-buy-skin buy" id="btn-skin-neon" onclick="buyOrEquipSkin('neon', 50000)">BUY</button></div>
                    <div class="skin-item"><div class="skin-preview" style="background:linear-gradient(135deg, #451a03, #000); border:2px solid #f59e0b; color:#fcd34d; font-family:'Times New Roman',serif;">B</div><div class="skin-name">Luxury Gold</div><div class="skin-cost">100,000 Coins</div><button class="btn-buy-skin buy" id="btn-skin-gold" onclick="buyOrEquipSkin('gold', 100000)">BUY</button></div>
                    <div class="skin-item"><div class="skin-preview" style="background:rgba(80, 7, 36, 1); border:2px solid #ec4899; color:#fbcfe8; border-radius:50%;">B</div><div class="skin-name">Kawaii Pink</div><div class="skin-cost">25,000 Coins</div><button class="btn-buy-skin buy" id="btn-skin-pink" onclick="buyOrEquipSkin('pink', 25000)">BUY</button></div>
                    
                    <div class="skin-item" id="customSkinSlot" style="display:none;"><div class="skin-preview" id="customSkinPreview" style="background-size:cover;">B</div><div class="skin-name">My Custom</div><div class="skin-cost">Owned</div><button class="btn-buy-skin equip" id="btn-skin-custom" onclick="equipSkin('custom')">EQUIP</button></div>
                </div>
            </div>
            <div id="storeSection-earn" style="display:none;">
                <p style="font-size:11px; opacity:0.7; margin-bottom: var(--spacing-md); text-align:center;">Complete tasks to earn huge coins instantly.</p>
                <div class="task-list">
                    <div class="task-item" style="border-color: #ef4444; background: linear-gradient(90deg, rgba(69,10,10,0.8), rgba(15,23,42,0.8));">
                        <div class="task-info"><h4 style="color:#fca5a5;">Watch Video Task</h4><p>Watch full video to unlock reward</p><span class="task-reward" style="background: rgba(239,68,68,0.2); border-color:#ef4444; color:#fca5a5;">+500 Coins</span></div>
                        <button class="btn-do-task" style="background:#ef4444;" id="btn-task-video" onclick="openVideoLocker('video')">WATCH</button>
                    </div>
                    <div class="task-item">
                        <div class="task-info"><h4>Premium Offer</h4><p>Complete simple offer to verify</p><span class="task-reward">+1,500 Coins</span></div>
                        <button class="btn-do-task" id="btn-task-premium" onclick="startTaskSafe('https://doctoredits.com/1874673', 1500, 'premium')">GO</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div id="supportModal" class="modal" onclick="this.style.display='none'">
    <div class="modal-content" onclick="event.stopPropagation()">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom: var(--spacing-md); border-bottom: 1px solid rgba(255,255,255,0.05); padding-bottom: 15px;">
            <div>
                <h3 style="margin:0; font-size: 20px; font-weight: 900;">CONTACT SUPPORT</h3>
                <p style="margin: 5px 0 0 0; font-size: 11px; opacity: 0.8; font-weight: 600;">Send a message to our team</p>
            </div>
            <button onclick="document.getElementById('supportModal').style.display='none'" style="background:none; border:none; color:white; cursor:pointer;"><i data-lucide="x"></i></button>
        </div>
        
        <label class="edit-label">Subject</label>
        <input type="text" id="supportSubject" class="edit-input" placeholder="Brief description of your issue">
        
        <label class="edit-label">Message</label>
        <textarea id="supportMessage" class="edit-input" rows="6" placeholder="Please describe your issue in detail..." style="resize:vertical;"></textarea>
        
        <button onclick="submitSupportRequest()" style="width:100%; padding: var(--spacing-md); background:var(--accent); border:none; border-radius: var(--radius-md); font-weight:900; color:white; cursor:pointer; display:flex; align-items:center; justify-content:center; gap: var(--spacing-xs);">
            <i data-lucide="send" style="width:16px;"></i>
            SEND MESSAGE
        </button>
        
        <div id="myTicketsSection" style="margin-top: var(--spacing-lg); padding-top: 20px; border-top: 1px solid rgba(255,255,255,0.1);">
            <h4 style="margin:0 0 15px 0; font-size: 14px; font-weight: 800; color: var(--accent-glow); display: flex; align-items: center; gap: var(--spacing-xs);">
                <i data-lucide="inbox" style="width:16px;"></i> MY TICKETS
            </h4>
            <div id="ticketsList" style="max-height: 200px; overflow-y: auto;"></div>
        </div>
    </div>
</div>

<div id="ticketDetailModal" class="modal" onclick="this.style.display='none'">
    <div class="modal-content" onclick="event.stopPropagation()" style="max-height: 80vh; overflow-y: auto;">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom: var(--spacing-md); border-bottom: 1px solid rgba(255,255,255,0.05); padding-bottom: 15px; position: sticky; top: 0; background: #1e293b; z-index: 10;">
            <div>
                <h3 style="margin:0; font-size: 18px; font-weight: 900;" id="ticketDetailSubject">Ticket Subject</h3>
                <p style="margin: 5px 0 0 0; font-size: 11px; opacity: 0.8; font-weight: 600;">
                    Status: <span id="ticketDetailStatus" style="color: var(--gold);">Open</span>
                </p>
            </div>
            <button onclick="closeTicketDetail()" style="background:none; border:none; color:white; cursor:pointer;"><i data-lucide="x"></i></button>
        </div>
        
        <div id="ticketRepliesContainer" style="margin-bottom: var(--spacing-md);"></div>
        
        <div style="border-top: 1px solid rgba(255,255,255,0.1); padding-top: 15px;">
            <label class="edit-label">Reply to Ticket</label>
            <textarea id="ticketReplyInput" class="edit-input" rows="4" placeholder="Type your reply here..." style="resize:vertical;"></textarea>
            <button onclick="submitTicketReply()" style="width:100%; padding: var(--spacing-sm); background:var(--accent); border:none; border-radius: var(--radius-md); font-weight:900; color:white; cursor:pointer; display:flex; align-items:center; justify-content:center; gap: var(--spacing-xs); margin-top:10px;">
                <i data-lucide="send" style="width:16px;"></i>
                SEND REPLY
            </button>
        </div>
    </div>
</div>

<div id="pwaInstallBanner">
    <div><span class="pwa-text">INSTALL APP</span><span class="pwa-sub">Download for better experience!</span></div>
    <button id="pwaBottomBtn" class="pwa-btn">INSTALL</button>
</div>

<script>
    /* ============================================
        CLOUDINARY CONFIGURED! (FREE CLOUD STORAGE)
       ============================================
       
        ALL IMAGES & VIDEOS NOW UPLOAD TO CLOUDINARY!
       
        YOUR CLOUD NAME: dzifutb8l (CONFIGURED!)
        USING DEFAULT PRESET: ml_default
       
       STATUS:
        Cloud name: dzifutb8l - READY!
        Upload preset: ml_default (default) - WORKING but you can create custom one
       
        NEXT STEP (OPTIONAL):
       Create your own upload preset for better control:
       1. Go to: https://console.cloudinary.com/console/dzifutb8l/settings/upload
       2. Click "Add upload preset"
       3. Name: radiobingo_uploads
       4. Signing mode: Unsigned 
       5. Save, then update line 4948 with new preset name
       
       FOR NOW: Test with 'ml_default' - it should work!
       
       BENEFITS:
        No more base64 - smaller database
        Fast CDN delivery
        Free 25GB storage & 25GB bandwidth/month
        Automatic image optimization
        Supports images & videos
       
       ============================================ */
    
    // === NOTIFICATION BLOCKER LOGIC ===
    window.addEventListener('load', () => { setTimeout(hideSplash, 2000); checkNotifGate(); checkInstallGate(); initBannerListener(); initScheduleAnnouncementListener(); loadSocialFeed(); loadPYMK(); loadCustomSkin(); });
    setTimeout(hideSplash, 5000);
    function hideSplash() { const ss = document.getElementById('splash-screen'); if(ss && ss.style.display !== 'none') { ss.style.opacity = '0'; setTimeout(() => ss.style.display = 'none', 800); } }
    
    function checkNotifGate() {
        const blocker = document.getElementById('notifBlocker');
        const help = document.getElementById('blockedHelp');
        if (!("Notification" in window)) { showToast("Notifications not supported on this device."); blocker.style.display = 'none'; return; }
        if (Notification.permission === "granted") { localStorage.setItem('notif_accepted', 'true'); blocker.style.display = 'none'; } else if (Notification.permission === "denied") { blocker.style.display = 'flex'; help.style.display = 'block'; } else { blocker.style.display = 'flex'; help.style.display = 'none'; }
    }
    function requestGatePermission() { Notification.requestPermission().then(permission => { if (permission === "granted") { localStorage.setItem('notif_accepted', 'true'); checkNotifGate(); requestNotifyPermission(); } else { checkNotifGate(); } }); }
    function showToast(msg) { const toast = document.getElementById('customToast'); document.getElementById('toastMsg').innerText = msg; toast.classList.add('show'); playSound('click'); setTimeout(() => { toast.classList.remove('show'); }, 3000); }

    let confirmCallback = null;
    function showCustomConfirm(title, msg, onYes, yesText = 'CONFIRM', noText = 'CANCEL', singleButton = false, showTextarea = false) { 
        document.getElementById('confTitle').innerText = title; 
        document.getElementById('confMsg').innerText = msg; 
        document.getElementById('customConfirmModal').style.display = 'flex'; 
        
        const yesBtn = document.getElementById('confYesBtn');
        const noBtn = document.querySelector('.btn-conf-no');
        const textareaContainer = document.getElementById('confTextareaContainer');
        const textarea = document.getElementById('confTextarea');
        
        yesBtn.innerText = yesText;
        noBtn.innerText = noText;
        
        // Show/hide textarea
        if (showTextarea) {
            textareaContainer.style.display = 'block';
            textarea.value = ''; // Clear previous value
        } else {
            textareaContainer.style.display = 'none';
        }
        
        // Single button mode - hide cancel and make confirm act as close
        if (singleButton) {
            noBtn.style.display = 'none';
            yesBtn.onclick = closeCustomConfirm;
        } else {
            noBtn.style.display = 'block';
            yesBtn.onclick = () => {
                if (onYes) {
                    // If textarea mode, pass the textarea value
                    if (showTextarea) {
                        const reason = textarea.value.trim();
                        if (!reason) {
                            showToast('Please provide a reason for your verification request');
                            return;
                        }
                        onYes(reason);
                    } else {
                        onYes();
                    }
                }
                closeCustomConfirm();
            };
        }
        
        confirmCallback = onYes; 
        playSound('click');
        
        // Re-initialize lucide icons
        setTimeout(() => lucide.createIcons(), 50);
    }
    function closeCustomConfirm() { 
        document.getElementById('customConfirmModal').style.display = 'none'; 
        document.getElementById('confTextareaContainer').style.display = 'none';
        document.getElementById('confTextarea').value = '';
        confirmCallback = null; 
    }

    let notifiedFiveMins = false; let lastCheckedSchedule = null;
    function checkFiveMinuteNotification(timeInput) { if(notifiedFiveMins && lastCheckedSchedule === timeInput) return; let drawTime = isNaN(timeInput) ? 0 : parseInt(timeInput); if(drawTime > 0) { const diff = drawTime - Date.now(); const mins = Math.floor(diff / 60000); if(mins === 5) { if(Notification.permission === "granted") { new Notification("RB LIVE BINGO", { body: "Hurry! Draw starts in 5 minutes! Open the app now." }); } showToast(" Only 5 minutes left until the draw!"); notifiedFiveMins = true; lastCheckedSchedule = timeInput; } if(mins > 5) notifiedFiveMins = false; } }

    let deferredPrompt;
    const bottomBanner = document.getElementById('pwaInstallBanner');
    const bottomBtn = document.getElementById('pwaBottomBtn');
    
    function checkInstallGate() {
        const gate = document.getElementById('installGate');
        const isStandalone = window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone === true;
        if (isStandalone) { gate.style.display = 'none'; } else { gate.style.display = 'flex'; const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream; if(isIOS) { document.getElementById('gateInstallBtn').style.display = 'none'; document.getElementById('gateIosNote').style.display = 'block'; } }
        checkInstallState();
    }
    function checkInstallState() { if (window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone === true) { if(bottomBanner) bottomBanner.style.display = 'none'; } }
    window.addEventListener('beforeinstallprompt', (e) => { e.preventDefault(); deferredPrompt = e; if(bottomBanner && document.getElementById('installGate').style.display === 'none') { bottomBanner.style.display = 'flex'; } });
    function triggerInstall() { if (deferredPrompt) { deferredPrompt.prompt(); deferredPrompt.userChoice.then((choiceResult) => { if (choiceResult.outcome === 'accepted') { if(bottomBanner) bottomBanner.style.display = 'none'; } deferredPrompt = null; }); } else { document.getElementById('installGuideModal').style.display = 'flex'; const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream; if (isIOS) { showGuide('ios'); } else { showGuide('android'); } } if(bottomBanner) bottomBanner.style.display = 'none'; }
    function showGuide(os) { document.querySelectorAll('.install-tab-btn').forEach(b => b.classList.remove('active')); if(os === 'android') { document.getElementById('tabAndroid').classList.add('active'); document.getElementById('guideAndroidContent').style.display = 'block'; document.getElementById('guideIOSContent').style.display = 'none'; } else { document.getElementById('tabIOS').classList.add('active'); document.getElementById('guideAndroidContent').style.display = 'none'; document.getElementById('guideIOSContent').style.display = 'block'; } }
    if(bottomBtn) bottomBtn.addEventListener('click', triggerInstall);

    lucide.createIcons();
    const firebaseConfig = { apiKey: "AIzaSyDIAQXJ15atKJxu7PtcFL1W9JnO1N14pVs", authDomain: "radiobingo-9ac29.firebaseapp.com", databaseURL: "https://radiobingo-9ac29-default-rtdb.asia-southeast1.firebasedatabase.app", projectId: "radiobingo-9ac29", storageBucket: "radiobingo-9ac29.firebasestorage.app", messagingSenderId: "965903993397", appId: "1:965903993397:web:f6646fa05225f147eebf7c" };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database(); const auth = firebase.auth();
    window.db = db; window.auth = auth;
    // Load AI API key from Firebase (stored at /config/aiKey)
    db.ref('config/aiKey').once('value', function(snap) {
        if (snap.exists()) window._RBAI_KEY = snap.val();
    });
    let messaging; try { messaging = firebase.messaging(); } catch(e) { console.log("Messaging failed to init", e); }
    let userData = {}; let cardNumbers = []; let marks = [12]; let gameDrawn = []; let currentPattern = "Normal Bingo"; let lastNotifiedDraw = ""; let selectedReplyId = null;
    // ===== HEADLESS DRAW ENGINE VARS (global scope) =====
    let _hdeSchedules = {};   // live copy of Firebase schedules
    let _hdeDrawSpeed = 8000; // synced from gameState/drawConfig/speed
    let _hdeIsDrawing = false;// TRUE if THIS client is currently drawing
    let _hdeInterval = null;  // setInterval handle for draw ticks
    let _hdeSchedTimer = null;// setInterval handle for schedule checker (5s)
    let _hdeInitialized = false; // guard: only init once per auth session

    // Multi-card support (up to 5 extra cards)
    let extraCards = []; // array of { numbers: [], marks: [] }
    const MAX_EXTRA_CARDS = 4; // 1 main + 4 extra = 5 total
    let currentJackpotAmount = 500; let isJackpotActive = false;
    let onlineUsers = {};
    
    // Skin Shop Data Structure
    const skinShop = {
        'kitty': { name: 'Hello Kitty', cost: 75000, preview: 'background:pink; border:2px solid hotpink; color:deeppink; font-family:\'Comic Neue\',cursive;' },
        'doraemon': { name: 'Doraemon', cost: 75000, preview: 'background:#0096df; border:2px solid white; color:white; border-radius:50%;' },
        'spongebob': { name: 'SpongeBob', cost: 75000, preview: 'background:#f7f44d; border:2px dashed brown; color:brown;' },
        'kuromi': { name: 'Kuromi', cost: 75000, preview: 'background:black; border:2px solid purple; color:pink;' },
        'neon': { name: 'Neon City', cost: 50000, preview: 'background:rgba(8,51,68,1); border:2px solid #06b6d4; color:#67e8f9; text-shadow:0 0 5px #06b6d4;' },
        'gold': { name: 'Luxury Gold', cost: 100000, preview: 'background:linear-gradient(135deg, #451a03, #000); border:2px solid #f59e0b; color:#fcd34d; font-family:\'Times New Roman\',serif;' },
        'pink': { name: 'Kawaii Pink', cost: 25000, preview: 'background:rgba(80, 7, 36, 1); border:2px solid #ec4899; color:#fbcfe8; border-radius:50%;' }
    };

    const sounds = { click: new Audio('https://cdn.pixabay.com/audio/2022/03/15/audio_2731885542.mp3'), newBall: new Audio('https://cdn.pixabay.com/audio/2022/03/10/audio_c8c8a73467.mp3'), pop: new Audio('https://cdn.freesound.org/previews/536/536108_1415754-lq.mp3'), win: new Audio('https://cdn.freesound.org/previews/270/270404_5123851-lq.mp3'), lose: new Audio('https://cdn.freesound.org/previews/76/76376_877451-lq.mp3'), spin: new Audio('https://cdn.freesound.org/previews/413/413203_5121236-lq.mp3'), cardFlip: new Audio('https://cdn.freesound.org/previews/240/240776_4107740-lq.mp3'), stop: new Audio('https://cdn.freesound.org/previews/256/256113_3263906-lq.mp3'), tumble: new Audio('https://cdn.freesound.org/previews/256/256113_3263906-lq.mp3'), drop: new Audio('https://cdn.pixabay.com/audio/2022/03/10/audio_c8c8a73467.mp3') };
    function playSound(type) { if(sounds[type]) { sounds[type].currentTime = 0; if(type === 'drop') sounds[type].volume = 0.3; else sounds[type].volume = 1.0; sounds[type].play().catch(e => console.log("Audio play error", e)); } }
    if ('serviceWorker' in navigator) { window.addEventListener('load', () => { navigator.serviceWorker.register('./sw.js').then(reg => { }).catch(err => console.log('SW Failed:', err)); }); }
    const VAPID_KEY = 'BKaRv3bFBjqNJ7zdJnUyH7g0bw0TX-7rbxNDQng8yW5JPX1Ha8jA6E_9R3vjlIU80XZjM7BNIuR2m80VDlvlepk'; // <-- PALITAN: Firebase Console  Project Settings  Cloud Messaging  Web Push Certificates  Key Pair
    function requestNotifyPermission() { if ("Notification" in window) { Notification.requestPermission().then(permission => { if (permission === "granted" && messaging) { messaging.getToken({ vapidKey: VAPID_KEY }).then((currentToken) => { if (currentToken && auth.currentUser) db.ref('users/' + auth.currentUser.uid).update({ fcmToken: currentToken }); }).catch((err) => console.log('Err token', err)); } }); } }

    function switchTab(tab) {
        document.querySelectorAll('.nav-item').forEach(b => b.classList.remove('active'));
        document.getElementById('view-home').style.display = 'none';
        document.getElementById('view-bingo').style.display = 'none';
        document.getElementById('view-beats').style.display = 'none';
        if (document.getElementById('view-games')) document.getElementById('view-games').style.display = 'none';
        
        // Pause all beats videos when leaving beats tab
        document.querySelectorAll('.beats-video').forEach(v => v.pause());
        
        if(tab === 'home') {
            document.getElementById('view-home').style.display = 'block';
            document.getElementById('nav-home').classList.add('active');
            loadSocialFeed();
            loadPYMK();
        } else if(tab === 'bingo') {
            document.getElementById('view-bingo').style.display = 'block';
            document.getElementById('nav-bingo').classList.add('active');
        } else if(tab === 'beats') {
            document.getElementById('view-beats').style.display = 'block';
            document.getElementById('nav-beats').classList.add('active');
            initBeats();
        } else if(tab === 'games') {
            if (document.getElementById('view-games')) document.getElementById('view-games').style.display = 'block';
            document.getElementById('nav-games').classList.add('active');
        }
        playSound('click');
        // Sync drawer and hamburger active states
        if (typeof updateDrawerActiveState === 'function') updateDrawerActiveState(tab);
        if (typeof updateHamburgerActive === 'function') updateHamburgerActive(tab);
    }
    // Expose globally so inline onclick handlers can call it
    window.switchTab = switchTab;

    function openPostCreator() {
        switchTab('home');
        document.getElementById('postInput').focus();
    }

    // === BEATS FUNCTIONALITY ===
    let beatsLiked = {};
    let currentBeatsVideo = null;
    let beatsVideoPosts = [];

    function initBeats() {
        loadBeatsVideos();
    }

    function loadBeatsVideos() {
        const container = document.getElementById('beatsContainer');
        container.innerHTML = `
            <div class="beats-placeholder">
                <i data-lucide="video" style="width:60px; height:60px; color:rgba(255,255,255,0.3);"></i>
                <h3 style="font-size:18px; margin:10px 0;">Loading Beats...</h3>
                <p style="font-size:13px; opacity:0.6;">Sandali lang...</p>
            </div>
        `;
        setTimeout(() => lucide.createIcons(), 50);
        
        // Fetch ALL posts from Firebase and filter for videos
        db.ref('socialPosts').once('value', snapshot => {
            beatsVideoPosts = [];
            
            if(!snapshot.exists()) {
                console.log('No posts found in database');
                container.innerHTML = `
                    <div class="beats-placeholder">
                        <i data-lucide="video-off" style="width:60px; height:60px; color:rgba(255,255,255,0.3);"></i>
                        <h3 style="font-size:18px; margin:10px 0;">No Beats Yet</h3>
                        <p style="font-size:13px; opacity:0.6;">No videos uploaded yet. Be the first!</p>
                    </div>
                `;
                setTimeout(() => lucide.createIcons(), 50);
                return;
            }
            
            // Collect ALL posts that have videos
            snapshot.forEach(child => {
                const post = child.val();
                // Check if post has video URL (any field that contains video)
                if(post && (post.videoUrl || post.video)) {
                    beatsVideoPosts.push({
                        key: child.key,
                        ...post
                    });
                }
            });
            
            console.log('Found ' + beatsVideoPosts.length + ' video posts');
            
            if(beatsVideoPosts.length === 0) {
                container.innerHTML = `
                    <div class="beats-placeholder">
                        <i data-lucide="video-off" style="width:60px; height:60px; color:rgba(255,255,255,0.3);"></i>
                        <h3 style="font-size:18px; margin:10px 0;">No Beats Yet</h3>
                        <p style="font-size:13px; opacity:0.6;">No videos uploaded yet. Be the first!</p>
                    </div>
                `;
                setTimeout(() => lucide.createIcons(), 50);
                return;
            }
            
            // Sort by timestamp (newest first)
            beatsVideoPosts.sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0));
            
            // Render beats videos
            container.innerHTML = '';
            let renderedCount = 0;
            
            beatsVideoPosts.forEach((post, index) => {
                renderBeatVideo(post, index, () => {
                    renderedCount++;
                    if(renderedCount === beatsVideoPosts.length) {
                        // All videos rendered, initialize scrolling
                        setTimeout(() => {
                            initBeatsScrolling();
                            lucide.createIcons();
                        }, 100);
                    }
                });
            });
        });
    }

    function renderBeatVideo(post, index, callback) {
        const container = document.getElementById('beatsContainer');
        const videoDiv = document.createElement('div');
        videoDiv.className = 'beats-video-container';
        videoDiv.setAttribute('data-post-key', post.key);
        
        // Get the video URL (check both videoUrl and video fields)
        const videoUrl = post.videoUrl || post.video;
        
        if(!videoUrl) {
            if(callback) callback();
            return;
        }
        
        // Get user info
        db.ref('users/' + post.uid).once('value', userSnap => {
            const user = userSnap.val();
            if(!user) {
                if(callback) callback();
                return;
            }
            
            const isFollowing = userData?.following && userData.following[post.uid];
            const isOwnPost = auth.currentUser && auth.currentUser.uid === post.uid;
            
            const sanitizedName = escapeHtml(user.name || 'Anonymous');
            const sanitizedPhoto = sanitizeUrl(user.photo || 'https://via.placeholder.com/42');
            const sanitizedContent = escapeHtml(post.content || 'Watch this amazing video!');
            const sanitizedVideo = sanitizeUrl(videoUrl);
            
            // Check if verified
            const isVerified = user.verified === true;
            const verifiedBadgeHTML = isVerified ? `<span class="verified-badge inline-badge" onmouseenter="showVerificationTooltip(event)" onmouseleave="hideVerificationTooltip()" style="margin-left:4px;"><i data-lucide="check" style="width:10px; height:10px; color:white;"></i></span>` : '';
            
            videoDiv.innerHTML = `
                <video class="beats-video" loop playsinline preload="metadata">
                    <source src="${sanitizedVideo}" type="video/mp4">
                </video>
                
                <div class="beats-overlay">
                    <div class="beats-user-info">
                        <img class="beats-avatar" src="${sanitizedPhoto}" alt="${sanitizedName}" onclick="openUserProfile('${post.uid}')">
                        <div class="beats-username">@${sanitizedName}${verifiedBadgeHTML}</div>
                        ${!isOwnPost ? `<button class="beats-follow-btn ${isFollowing ? 'following' : ''}" onclick="handleBeatsFollow('${post.uid}', this)">
                            ${isFollowing ? 'Following' : 'Follow'}
                        </button>` : ''}
                    </div>
                    <div class="beats-description">${sanitizedContent}</div>
                    <div class="beats-music">
                        <i data-lucide="music" style="width:14px;"></i>
                        <span>Original Audio</span>
                    </div>
                    
                    <div class="beats-comments-preview" id="beats-preview-${index}">
                        <div class="beats-view-comments" onclick="handleBeatsComment('${post.key}')">
                            <span id="beats-comment-preview-text-${index}">Loading comments...</span>
                        </div>
                        <div id="beats-preview-list-${index}"></div>
                    </div>
                </div>

                <div class="beats-actions">
                    <div class="beats-action-btn" onclick="handleBeatsLike('${post.key}', ${index})">
                        <i data-lucide="heart" style="width:24px;" id="beats-like-${index}"></i>
                        <span class="beats-action-count" id="beats-like-count-${index}">${post.likes || 0}</span>
                    </div>
                    <div class="beats-action-btn" onclick="handleBeatsComment('${post.key}')">
                        <i data-lucide="message-circle" style="width:24px;"></i>
                        <span class="beats-action-count" id="beats-comment-count-${index}">0</span>
                    </div>
                    <div class="beats-action-btn" onclick="handleBeatsShare('${post.key}')">
                        <i data-lucide="share-2" style="width:24px;"></i>
                        <span class="beats-action-count">Share</span>
                    </div>
                </div>
            `;
            
            container.appendChild(videoDiv);
            
            // Check if user already liked this post
            if(auth.currentUser) {
                db.ref('postLikes/' + post.key + '/' + auth.currentUser.uid).once('value', likeSnap => {
                    if(likeSnap.exists()) {
                        const likeIcon = document.getElementById('beats-like-' + index);
                        if(likeIcon) {
                            likeIcon.setAttribute('fill', '#ef4444');
                            likeIcon.style.color = '#ef4444';
                            beatsLiked[post.key] = true;
                        }
                    }
                });
            }
            
            // Get comments and display preview
            db.ref('postComments/' + post.key).limitToLast(2).once('value', commSnap => {
                const commentCount = commSnap.numChildren();
                const countEl = document.getElementById('beats-comment-count-' + index);
                const previewTextEl = document.getElementById('beats-comment-preview-text-' + index);
                const previewListEl = document.getElementById('beats-preview-list-' + index);
                
                // Get total comment count
                db.ref('postComments/' + post.key).once('value', totalSnap => {
                    const totalCount = totalSnap.numChildren();
                    
                    if(countEl) countEl.textContent = totalCount;
                    
                    if(totalCount === 0) {
                        if(previewTextEl) previewTextEl.textContent = 'Be the first to comment';
                    } else if(totalCount === 1) {
                        if(previewTextEl) previewTextEl.textContent = 'View 1 comment';
                    } else {
                        if(previewTextEl) previewTextEl.textContent = `View all ${totalCount} comments`;
                    }
                    
                    // Display preview of latest comments
                    if(commSnap.exists() && previewListEl) {
                        const comments = [];
                        commSnap.forEach(child => {
                            comments.push(child.val());
                        });
                        
                        // Show up to 2 latest comments
                        comments.slice(-2).forEach(comment => {
                            db.ref('users/' + comment.uid).once('value', userSnap => {
                                const commentUser = userSnap.val();
                                if(!commentUser) return;
                                
                                const commentDiv = document.createElement('div');
                                commentDiv.className = 'beats-preview-comment';
                                commentDiv.onclick = () => handleBeatsComment(post.key);
                                
                                const sanitizedCommentName = escapeHtml(commentUser.name || 'Anonymous');
                                const sanitizedCommentText = escapeHtml(comment.text || '');
                                
                                commentDiv.innerHTML = `
                                    <span class="beats-preview-comment-author">${sanitizedCommentName}</span>
                                    <span class="beats-preview-comment-text">${sanitizedCommentText}</span>
                                `;
                                
                                previewListEl.appendChild(commentDiv);
                            });
                        });
                    }
                });
            });
            
            setTimeout(() => lucide.createIcons(), 50);
            
            if(callback) callback();
        });
    }

    function initBeatsScrolling() {
        const beatsContainer = document.getElementById('view-beats');
        const videos = beatsContainer.querySelectorAll('.beats-video');
        
        console.log('Initializing beats scrolling with ' + videos.length + ' videos');
        
        if(videos.length === 0) return;
        
        // Play first video
        currentBeatsVideo = videos[0];
        currentBeatsVideo.play().catch(e => {
            console.log('Autoplay prevented:', e);
            // Add play button overlay if autoplay fails
            showPlayButton(currentBeatsVideo);
        });

        // Handle scroll to play/pause videos
        let scrollTimeout;
        beatsContainer.addEventListener('scroll', function() {
            clearTimeout(scrollTimeout);
            
            scrollTimeout = setTimeout(() => {
                let closestVideo = null;
                let minDistance = Infinity;

                videos.forEach(video => {
                    const rect = video.getBoundingClientRect();
                    const distance = Math.abs(rect.top);
                    
                    if(distance < minDistance) {
                        minDistance = distance;
                        closestVideo = video;
                    }
                });

                videos.forEach(video => {
                    if(video === closestVideo) {
                        video.play().catch(e => {
                            showPlayButton(video);
                        });
                        currentBeatsVideo = video;
                    } else {
                        video.pause();
                    }
                });
            }, 100);
        });

        // Tap to play/pause
        videos.forEach(video => {
            video.addEventListener('click', function(e) {
                e.stopPropagation();
                if(this.paused) {
                    this.play();
                } else {
                    this.pause();
                }
            });
        });
    }

    function showPlayButton(video) {
        // Helper function to show play button if autoplay is blocked
        const container = video.parentElement;
        if(container.querySelector('.beats-play-overlay')) return;
        
        const playOverlay = document.createElement('div');
        playOverlay.className = 'beats-play-overlay';
        playOverlay.style.cssText = `
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(255,255,255,0.9);
            width: 70px;
            height: 70px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 100;
        `;
        playOverlay.innerHTML = '<i data-lucide="play" style="width:32px; height:32px; color:#000; margin-left:4px;"></i>';
        playOverlay.onclick = () => {
            video.play();
            playOverlay.remove();
        };
        container.appendChild(playOverlay);
        setTimeout(() => lucide.createIcons(), 10);
    }

    function handleBeatsLike(postKey, index) {
        if(!auth.currentUser) return showToast("Please login first");
        
        const likeIcon = document.getElementById('beats-like-' + index);
        const countEl = document.getElementById('beats-like-count-' + index);
        const isLiked = beatsLiked[postKey];
        
        const myUid = auth.currentUser.uid;
        const likeRef = db.ref('postLikes/' + postKey + '/' + myUid);
        
        if(isLiked) {
            // Unlike
            likeRef.remove();
            db.ref('socialPosts/' + postKey + '/likes').transaction(l => Math.max(0, (l || 1) - 1));
            
            likeIcon.setAttribute('fill', 'none');
            likeIcon.style.color = 'white';
            beatsLiked[postKey] = false;
            
            // Update count
            const currentCount = parseInt(countEl.textContent) || 0;
            countEl.textContent = Math.max(0, currentCount - 1);
        } else {
            // Like with animation
            likeRef.set('');
            db.ref('socialPosts/' + postKey + '/likes').transaction(l => (l || 0) + 1);
            
            likeIcon.setAttribute('fill', '#ef4444');
            likeIcon.style.color = '#ef4444';
            beatsLiked[postKey] = true;
            
            // Animate heart
            likeIcon.style.transform = 'scale(1.3)';
            setTimeout(() => likeIcon.style.transform = 'scale(1)', 200);
            
            // Update count
            const currentCount = parseInt(countEl.textContent) || 0;
            countEl.textContent = currentCount + 1;
            
            playSound('like');
            
            // Send notification to post author
            const post = beatsVideoPosts.find(p => p.key === postKey);
            if(post && post.uid !== myUid && userData && userData.name) {
                db.ref('notifications/' + post.uid).push({
                    msg: `${userData.name} liked your Beat`,
                    time: Date.now(),
                    type: 'like',
                    from: myUid,
                    postId: postKey,
                    image: userData.photo || 'https://via.placeholder.com/40'
                });
            }
        }
    }

    let currentBeatsCommentPostKey = null;

    function handleBeatsComment(postKey) {
        if(!auth.currentUser) return showToast("Please login first");
        
        currentBeatsCommentPostKey = postKey;
        
        // Show modal and backdrop
        const modal = document.getElementById('beatsCommentModal');
        const backdrop = document.getElementById('beatsCommentBackdrop');
        
        backdrop.style.display = 'block';
        modal.classList.add('show');
        
        // Load comments
        loadBeatsComments(postKey);
        
        // Pause current video
        if(currentBeatsVideo) {
            currentBeatsVideo.pause();
        }
        
        setTimeout(() => lucide.createIcons(), 50);
    }

    function closeBeatsComments() {
        const modal = document.getElementById('beatsCommentModal');
        const backdrop = document.getElementById('beatsCommentBackdrop');
        
        modal.classList.remove('show');
        backdrop.style.display = 'none';
        
        // Clear input
        document.getElementById('beatsCommentInput').value = '';
        
        // Resume video
        if(currentBeatsVideo) {
            currentBeatsVideo.play().catch(e => {});
        }
    }

    function loadBeatsComments(postKey) {
        const list = document.getElementById('beatsCommentList');
        list.innerHTML = '<div class="beats-comment-empty"><div style="color:#64748b;">Loading comments...</div></div>';
        
        db.ref('postComments/' + postKey).orderByChild('time').once('value', snapshot => {
            list.innerHTML = '';
            
            if(!snapshot.exists()) {
                list.innerHTML = `
                    <div class="beats-comment-empty">
                        <i data-lucide="message-circle" style="width:40px; height:40px; margin-bottom:10px; color:#64748b;"></i>
                        <p style="color:#64748b;">No comments yet. Be the first!</p>
                    </div>
                `;
                setTimeout(() => lucide.createIcons(), 50);
                return;
            }
            
            const comments = [];
            snapshot.forEach(child => {
                comments.push({
                    key: child.key,
                    ...child.val()
                });
            });
            
            // Show newest first
            comments.reverse();
            
            comments.forEach(comment => {
                renderBeatsComment(comment);
            });
            
            setTimeout(() => lucide.createIcons(), 50);
        });
    }

    function renderBeatsComment(comment) {
        const list = document.getElementById('beatsCommentList');
        
        // Fetch user data
        db.ref('users/' + comment.uid).once('value', userSnap => {
            const user = userSnap.val();
            if(!user) return;
            
            const div = document.createElement('div');
            div.className = 'beats-comment-item';
            
            const sanitizedName = escapeHtml(user.name || 'Anonymous');
            const sanitizedPhoto = sanitizeUrl(user.photo || 'https://via.placeholder.com/36');
            const sanitizedText = escapeHtml(comment.text || '');
            const timeAgo = getTimeAgo(comment.time);
            
            // Check if verified
            const isVerified = user.verified === true;
            const verifiedBadgeHTML = isVerified ? `<span class="verified-badge inline-badge" onmouseenter="showVerificationTooltip(event)" onmouseleave="hideVerificationTooltip()" style="margin-left:4px;"><i data-lucide="check" style="width:8px; height:8px; color:white;"></i></span>` : '';
            
            div.innerHTML = `
                <img class="beats-comment-avatar" src="${sanitizedPhoto}" alt="${sanitizedName}" onclick="closeBeatsComments(); openUserProfile('${comment.uid}')">
                <div class="beats-comment-content">
                    <div class="beats-comment-author">${sanitizedName}${verifiedBadgeHTML}</div>
                    <div class="beats-comment-text">${sanitizedText}</div>
                    <div class="beats-comment-time">${timeAgo}</div>
                </div>
            `;
            
            list.appendChild(div);
            lucide.createIcons();
        });
    }

    function sendBeatsComment() {
        if(!auth.currentUser) return showToast("Please login first");
        if(!currentBeatsCommentPostKey) return;
        
        const input = document.getElementById('beatsCommentInput');
        const text = input.value.trim();
        
        if(!text) return;
        
        const myUid = auth.currentUser.uid;
        const commentData = {
            uid: myUid,
            text: text,
            time: Date.now()
        };
        
        // Save comment
        db.ref('postComments/' + currentBeatsCommentPostKey).push(commentData).then(() => {
            input.value = '';
            
            // Reload comments in modal
            loadBeatsComments(currentBeatsCommentPostKey);
            
            // Find the post and update UI
            const post = beatsVideoPosts.find(p => p.key === currentBeatsCommentPostKey);
            if(post) {
                const index = beatsVideoPosts.indexOf(post);
                
                // Update comment count
                const countEl = document.getElementById('beats-comment-count-' + index);
                if(countEl) {
                    const currentCount = parseInt(countEl.textContent) || 0;
                    countEl.textContent = currentCount + 1;
                }
                
                // Update preview text
                const previewTextEl = document.getElementById('beats-comment-preview-text-' + index);
                if(previewTextEl) {
                    const newCount = (parseInt(countEl?.textContent) || 0);
                    if(newCount === 1) {
                        previewTextEl.textContent = 'View 1 comment';
                    } else {
                        previewTextEl.textContent = `View all ${newCount} comments`;
                    }
                }
                
                // Update preview list - show latest comment
                const previewListEl = document.getElementById('beats-preview-list-' + index);
                if(previewListEl && userData) {
                    // Add new comment to preview
                    const commentDiv = document.createElement('div');
                    commentDiv.className = 'beats-preview-comment';
                    commentDiv.onclick = () => handleBeatsComment(currentBeatsCommentPostKey);
                    
                    const sanitizedName = escapeHtml(userData.name || 'You');
                    const sanitizedText = escapeHtml(text);
                    
                    commentDiv.innerHTML = `
                        <span class="beats-preview-comment-author">${sanitizedName}</span>
                        <span class="beats-preview-comment-text">${sanitizedText}</span>
                    `;
                    
                    // Keep only 2 latest
                    const existingComments = previewListEl.querySelectorAll('.beats-preview-comment');
                    if(existingComments.length >= 2) {
                        existingComments[0].remove();
                    }
                    
                    previewListEl.appendChild(commentDiv);
                }
            }
            
            // Send notification to post author
            if(post && post.uid !== myUid && userData && userData.name) {
                db.ref('notifications/' + post.uid).push({
                    msg: `${userData.name} commented on your Beat`,
                    time: Date.now(),
                    type: 'comment',
                    from: myUid,
                    postId: currentBeatsCommentPostKey,
                    image: userData.photo || 'https://via.placeholder.com/40'
                });
            }

            // Detect @mentions in Beats comment and notify mentioned users
            const beatsMentionMatches = text.match(/@(\w+)/g);
            if(beatsMentionMatches && userData && userData.name) {
                const uniqueBeatsMentions = [...new Set(beatsMentionMatches.map(m => m.slice(1)))];
                uniqueBeatsMentions.forEach(mentionedName => {
                    db.ref('users').orderByChild('name').equalTo(mentionedName).limitToFirst(1).once('value', snap => {
                        if(snap.exists()) {
                            const mentionedUid = Object.keys(snap.val())[0];
                            if(mentionedUid !== myUid) {
                                db.ref('notifications/' + mentionedUid).push({
                                    msg: `${userData.name} mentioned you in a comment`,
                                    time: Date.now(),
                                    type: 'mention',
                                    from: myUid,
                                    postId: currentBeatsCommentPostKey,
                                    image: userData.photo || 'https://via.placeholder.com/40'
                                });
                            }
                        }
                    });
                });
            }
            
            playSound('click');
            showToast('Comment posted!');
        });
    }

    function getTimeAgo(timestamp) {
        const now = Date.now();
        const diff = now - timestamp;
        const seconds = Math.floor(diff / 1000);
        const minutes = Math.floor(seconds / 60);
        const hours = Math.floor(minutes / 60);
        const days = Math.floor(hours / 24);
        
        if(days > 0) return days + 'd ago';
        if(hours > 0) return hours + 'h ago';
        if(minutes > 0) return minutes + 'm ago';
        return 'Just now';
    }

    function handleBeatsShare(postKey) {
        if(!auth.currentUser) return showToast("Please login first");
        
        const post = beatsVideoPosts.find(p => p.key === postKey);
        if(!post) return;
        
        // Copy link or share
        const shareUrl = window.location.origin + window.location.pathname + '?post=' + postKey;
        
        if(navigator.share) {
            navigator.share({
                title: 'Check out this Beat on Radio Bingo Live!',
                text: post.content || 'Amazing video!',
                url: shareUrl
            }).catch(e => console.log('Share canceled'));
        } else {
            // Fallback: copy to clipboard
            navigator.clipboard.writeText(shareUrl).then(() => {
                showToast('Link copied to clipboard!');
            }).catch(() => {
                showToast('Share URL: ' + shareUrl);
            });
        }
    }

    function handleBeatsFollow(targetUid, btn) {
        if(!auth.currentUser) return showToast("Please login first");
        
        const myUid = auth.currentUser.uid;
        if(myUid === targetUid) return;
        
        const isFollowing = btn.classList.contains('following');
        
        if(isFollowing) {
            // Unfollow
            db.ref('users/' + myUid + '/following/' + targetUid).remove();
            db.ref('users/' + targetUid + '/followers/' + myUid).remove();
            btn.classList.remove('following');
            btn.textContent = 'Follow';
            showToast('Unfollowed');
        } else {
            // Follow
            db.ref('users/' + myUid + '/following/' + targetUid).set(true);
            db.ref('users/' + targetUid + '/followers/' + myUid).set(true);
            btn.classList.add('following');
            btn.textContent = 'Following';
            showToast('Following!');
            
            // Send notification
            if(userData && userData.name) {
                db.ref('notifications/' + targetUid).push({
                    msg: `${userData.name} started following you`,
                    time: Date.now(),
                    type: 'follow',
                    from: myUid,
                    image: userData.photo || 'https://via.placeholder.com/40'
                });
            }
        }
    }
    
    // Toggle follow function for inline buttons (used in Beats marketplace)
    function toggleFollow(targetUid, btnId) {
        if(!auth.currentUser) return showToast("Please login first");
        
        const myUid = auth.currentUser.uid;
        if(myUid === targetUid) return;
        
        const btn = document.getElementById(btnId);
        if(!btn) return;
        
        const isFollowing = btn.classList.contains('following');
        
        if(isFollowing) {
            // Unfollow
            db.ref('users/' + myUid + '/following/' + targetUid).remove();
            db.ref('users/' + targetUid + '/followers/' + myUid).remove();
            btn.classList.remove('following');
            btn.textContent = 'Follow';
            showToast('Unfollowed');
        } else {
            // Follow
            db.ref('users/' + myUid + '/following/' + targetUid).set(true);
            db.ref('users/' + targetUid + '/followers/' + myUid).set(true);
            btn.classList.add('following');
            btn.textContent = 'Following';
            showToast('Following!');
            
            // Send notification
            if(userData && userData.name) {
                db.ref('notifications/' + targetUid).push({
                    msg: `${userData.name} started following you`,
                    time: Date.now(),
                    type: 'follow',
                    from: myUid,
                    image: userData.photo || 'https://via.placeholder.com/40'
                });
            }
        }
    }
            
    
    function switchStoreTab(tab) {
        document.querySelectorAll('.store-tab-btn').forEach(b => b.classList.remove('active'));
        document.getElementById('storeSection-cashout').style.display = 'none';
        document.getElementById('storeSection-skins').style.display = 'none';
        document.getElementById('storeSection-earn').style.display = 'none';
        if(tab === 'cashout') { document.getElementById('tabBtnCash').classList.add('active'); document.getElementById('storeSection-cashout').style.display = 'block'; } 
        else if(tab === 'skins') { document.getElementById('tabBtnSkins').classList.add('active'); document.getElementById('storeSection-skins').style.display = 'block'; updateSkinButtons(); } 
        else if(tab === 'earn') { document.getElementById('tabBtnEarn').classList.add('active'); document.getElementById('storeSection-earn').style.display = 'block'; }
        playSound('click');
    }

    function fixDate(timestamp) { if(!timestamp) return "Just now"; const d = new Date(parseInt(timestamp)); return d.toLocaleDateString('en-PH', { month: 'short', day: 'numeric' }) + " " + d.toLocaleTimeString('en-PH', { hour: '2-digit', minute: '2-digit' }); }
    function login() { playSound('click'); auth.signInWithPopup(new firebase.auth.GoogleAuthProvider()).then(() => { requestNotifyPermission(); checkNotifGate(); }); }

    auth.onAuthStateChanged(u => {
        if(u) {
            if(messaging) {
                // Save token
                messaging.getToken({ vapidKey: VAPID_KEY }).then((token) => { if(token) db.ref('users/' + u.uid).update({ fcmToken: token }); }).catch((err)=>console.log(err));
                // FIX TRIPLE NOTIF: i-unsubscribe ang lumang listener bago mag-register ng bago
                // Ang onAuthStateChanged ay pwedeng mag-trigger ng maraming beses (login, refresh, reconnect)
                // Bawat trigger = bagong onMessage listener na nag-iisa-isa = TRIPLE/QUADRUPLE notif
                if(window._msgUnsubscribe) { window._msgUnsubscribe(); window._msgUnsubscribe = null; }
                window._msgUnsubscribe = messaging.onMessage((payload) => {
                    const notifTitle = (payload.notification && payload.notification.title) ? payload.notification.title : (payload.data && payload.data.title ? payload.data.title : 'Radio Bingo');
                    const notifBody  = (payload.notification && payload.notification.body)  ? payload.notification.body  : (payload.data && payload.data.body  ? payload.data.body  : 'May bagong notification!');
                    // Toast lang kapag bukas ang app  SW na ang mag-aasikaso ng OS notification sa background
                    showToast(' ' + notifTitle + ': ' + notifBody);
                    playSound('pop');
                });
            }
            document.getElementById('loginOverlay').style.display = 'none'; document.getElementById('userPanel').style.display = 'flex';
            
            document.getElementById('userImgContainer').innerHTML = renderAvatarWithBadge(sanitizeUrl(u.photoURL), 0, 45, u.uid);

            document.getElementById('profileUidDisplay').innerText = "ID: " + u.uid.substring(0,8);
            
            const userRef = db.ref('users/'+u.uid);
            userRef.once('value', snapshot => { 
                if (!snapshot.exists()) { 
                    // New User
                    const newRefCode = Math.random().toString(36).substring(2, 8).toUpperCase(); 
                    const urlParams = new URLSearchParams(window.location.search); 
                    const referredBy = urlParams.get('ref'); 
                    userRef.set({ name: u.displayName, photo: u.photoURL, points: 200, refCode: newRefCode, referredBy: referredBy || null, last_seen: Date.now(), cardTimestamp: Date.now(), lastLoginDate: new Date().toDateString(), hasWonBringMeThisRound: false, ownedSkins: ['default'], equippedSkin: 'default' }); 
                    if (referredBy) { db.ref('users').orderByChild('refCode').equalTo(referredBy).once('value', refSnap => { if (refSnap.exists()) { const referrerUid = Object.keys(refSnap.val())[0]; db.ref('users/' + referrerUid + '/points').transaction(p => (p || 0) + 300); } }); } 
                } else { 
                    // Existing User
                    const data = snapshot.val(); 
                    const updates = { last_seen: Date.now() }; 
                    if (!data.name) updates.name = u.displayName;
                    if (!data.photo) updates.photo = u.photoURL;
                    
                    const today = new Date().toDateString();
                    if (data.lastLoginDate !== today) { 
                        // Streak system handles the login reward now
                        setTimeout(() => checkDailyStreak(u.uid, data), 1500);
                    } 
                    if (!data.refCode) updates.refCode = Math.random().toString(36).substring(2, 8).toUpperCase(); 
                    if(!data.ownedSkins) updates.ownedSkins = ['default']; 
                    if(!data.equippedSkin) updates.equippedSkin = 'default'; 
                    userRef.update(updates); 
                } 
            });
            userRef.on('value', s => { 
                if(s.exists()){ 
                    userData = s.val(); userData.uid = u.uid;
                    window.userData = userData;
                    document.getElementById('storePoints').innerText = (userData.points || 0).toLocaleString(); 
                    document.getElementById('refLink').value = window.location.origin + window.location.pathname + "?ref=" + (userData.refCode || ""); 
                    if(userData.referredBy) document.getElementById('referralInputSection').style.display = 'none'; 
                    if(userData.gcash) document.getElementById('gcashInput').value = userData.gcash; 
                    if (userData.currentCard) { cardNumbers = userData.currentCard; renderCard(); } else { generateNewCard(); }
                    // Load extra cards if any (only once on initial load)
                    if (userData.extraCards && extraCards.length === 0) {
                        const savedExtras = userData.extraCards;
                        const keys = Object.keys(savedExtras).sort((a,b) => parseInt(a) - parseInt(b));
                        keys.forEach(k => {
                            const cardData = savedExtras[k];
                            if (!cardData) return;
                            const cardIdx = extraCards.length;
                            extraCards.push({ numbers: cardData, marks: [12], won: false });
                            addExtraCardToDOM(cardIdx);
                            renderExtraCard(cardIdx);
                        });
                        updateBuyCardUI();
                        updateBentoLayout();
                    }
                    
                    const displayName = userData.name || u.displayName;
                    const displayPhoto = userData.photo || u.photoURL;
                    
                    updatePresenceData(u.uid, displayName, userData.points, displayPhoto); checkLateJoiner();
                    applySkin(userData.equippedSkin || 'default'); updateSkinButtons();
                    
                    document.getElementById('profileNameDisplay').innerText = displayName;
                    
                    // Update streak widget
                    setTimeout(() => updateStreakWidget(), 100);
                    
                    // Update Avatars with badges
                    document.getElementById('userImgContainer').innerHTML = renderAvatarWithBadge(sanitizeUrl(displayPhoto), userData.bingoWins || 0, 45, u.uid);
                    document.getElementById('menuAvatarContainer').innerHTML = renderAvatarWithBadge(sanitizeUrl(displayPhoto), userData.bingoWins || 0, 70, u.uid);
                    
                    // Update post creator avatar
                    const postCreatorAvatar = document.getElementById('postCreatorAvatar');
                    if(postCreatorAvatar) {
                        postCreatorAvatar.src = sanitizeUrl(displayPhoto);
                    }
                } 
            });
            initBingo(); setupChat(); listenForNextDraw(); setupPresence(u.uid); listenJackpot(); listenNotifications(u.uid); listenPrivateMessages(u.uid); listenVideoUpdate();
            initHeadlessDrawEngine(u.uid); // start headless draw engine
            initSocialSystem(u.uid);
            loadPYMK();
        } else { document.getElementById('loginOverlay').style.display = 'flex'; }
    });
    // === BADGE & AVATAR SYSTEM ===
    function renderAvatarWithBadge(photoUrl, wins, size, uid = null) {
        // Data attribute for online status updates - only if uid is provided
        const uidAttr = uid ? `data-uid="${uid}"` : '';
        
        // Check if user is online - only show indicator if they are active
        const isOnline = uid && onlineUsers[uid];
        const onlineClass = isOnline ? 'is-online' : '';

        setTimeout(() => lucide.createIcons(), 50);

        return `
            <div class="avatar-frame" style="width:${size}px; height:${size}px;" ${uidAttr}>
                <img src="${photoUrl}" style="width:100%; height:100%; border-radius:50%; border:2px solid var(--glass-border); object-fit:cover;">
                <div class="online-indicator ${onlineClass}"></div>
            </div>
        `;
    }
    
    function updateAllOnlineIndicators() {
        document.querySelectorAll('.avatar-frame').forEach(el => {
            const uid = el.dataset.uid;
            if(uid) {
                const dot = el.querySelector('.online-indicator');
                // Only show online indicator if user is truly online
                if(onlineUsers[uid] && onlineUsers[uid].state === 'online' && dot) {
                    dot.classList.add('is-online');
                } else if(dot) {
                    dot.classList.remove('is-online');
                }
            }
        });
    }
    
    // Helper function to format "last seen" time
    function formatLastSeen(timestamp) {
        if(!timestamp) return 'recently';
        
        const now = Date.now();
        const diffMs = now - timestamp;
        const diffMins = Math.floor(diffMs / 60000);
        const diffHours = Math.floor(diffMs / 3600000);
        const diffDays = Math.floor(diffMs / 86400000);
        
        if(diffMins < 1) return 'just now';
        if(diffMins < 60) return `${diffMins} min${diffMins > 1 ? 's' : ''}. ago`;
        if(diffHours < 24) return `${diffHours} hour${diffHours > 1 ? 's' : ''} ago`;
        if(diffDays === 1) return 'yesterday';
        if(diffDays < 7) return `${diffDays} days ago`;
        
        // Format as date for older
        const date = new Date(timestamp);
        return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
    }

    // Helper to get verification badge HTML for text
    function getBadgeHtml(wins, userData = null) {
        // Check if user is verified - this will be populated from Firebase
        if (userData && userData.verified) {
            return `<span class="verified-badge" onclick="showVerificationInfo(event)"><i data-lucide="check" style="width:10px; height:10px; color:white;"></i></span>`;
        }
        return ""; 
    }
    
    // Async version that fetches user data to check verification
    async function getVerificationBadge(uid) {
        if (!uid) return '';
        try {
            const snapshot = await firebase.database().ref(`users/${uid}`).once('value');
            const userData = snapshot.val();
            if (userData && userData.verified) {
                return `<span class="verified-badge"><i data-lucide="check" style="width:10px; height:10px; color:white;"></i></span>`;
            }
        } catch(err) {
            console.error('Error fetching verification status:', err);
        }
        return '';
    }

    // === UTILITY: TEXT SANITIZATION ===
    function escapeHtml(text) {
        if (!text) return '';
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    // ===== SECURITY UTILITIES =====
    // Rate limiter  prevents spam on key actions
    const _rl = {};
    function rateLimit(key, ms) {
        const now = Date.now();
        if (_rl[key] && (now - _rl[key]) < ms) return false;
        _rl[key] = now;
        return true;
    }

    // Strict input sanitizer  strips HTML tags, limits length
    function sanitizeInput(str, maxLen) {
        maxLen = maxLen || 200;
        if (!str) return '';
        return String(str)
            .replace(/<[^>]*>/g, '')
            .replace(/[<>"'`\\]/g, '')
            .trim()
            .substring(0, maxLen);
    }

    // Max points per day guard (client-side soft limit)
    const _pointsToday = { date: new Date().toDateString(), earned: 0 };
    const MAX_DAILY_POINTS = 2000;
    function canEarnPoints(amt) {
        const today = new Date().toDateString();
        if (_pointsToday.date !== today) { _pointsToday.date = today; _pointsToday.earned = 0; }
        return (_pointsToday.earned + amt) <= MAX_DAILY_POINTS;
    }
    function trackPointsEarned(amt) {
        const today = new Date().toDateString();
        if (_pointsToday.date !== today) { _pointsToday.date = today; _pointsToday.earned = 0; }
        _pointsToday.earned += amt;
    }
    // ===== END SECURITY UTILITIES =====
    
    // === UTILITY: FORMAT FOLLOWER COUNT ===
    // Formats large numbers with K suffix
    // Examples: 999 -> 999, 1000 -> 1K, 1500 -> 1.5K, 10000 -> 10K
    function formatFollowerCount(count) {
        if (count >= 1000000) {
            // For millions
            const mCount = (count / 1000000).toFixed(1);
            return mCount.endsWith('.0') ? mCount.slice(0, -2) + 'M' : mCount + 'M';
        } else if (count >= 1000) {
            // For thousands
            const kCount = (count / 1000).toFixed(1);
            return kCount.endsWith('.0') ? kCount.slice(0, -2) + 'K' : kCount + 'K';
        }
        return count.toString();
    }

    // === UTILITY: URL VALIDATION ===
    function sanitizeUrl(url) {
        if (!url) return 'https://via.placeholder.com/40';
        // Allow only http/https/data URLs, and Firebase storage URLs
        try {
            const urlObj = new URL(url);
            if (['http:', 'https:', 'data:'].includes(urlObj.protocol)) {
                return url;
            }
        } catch (e) {
            // Invalid URL
        }
        return 'https://via.placeholder.com/40';
    }

    // === UTILITY: IMAGE COMPRESSION ===
    function compressImage(file, maxWidth, quality) {
        return new Promise((resolve) => {
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = (event) => {
                const img = new Image();
                img.src = event.target.result;
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    let width = img.width;
                    let height = img.height;
                    if (width > maxWidth) {
                        height *= maxWidth / width;
                        width = maxWidth;
                    }
                    canvas.width = width;
                    canvas.height = height;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, width, height);
                    resolve(canvas.toDataURL('image/jpeg', quality));
                };
            };
        });
    }

    // === PYMK LOGIC ===
    function loadPYMK() {
        if(!auth.currentUser) return;
        const list = document.getElementById('pymkList');
        const container = document.getElementById('pymkSection');
        
        // Get my friends first
        db.ref('friends/' + auth.currentUser.uid).once('value', myFriendsSnap => {
            const myFriends = myFriendsSnap.exists() ? Object.keys(myFriendsSnap.val()) : [];
            
            // Calculate mutual friends for all non-friends
            const candidates = [];
            
            db.ref('users').limitToLast(100).once('value', usersSnap => {
                let processedCount = 0;
                const totalUsers = usersSnap.numChildren();
                
                usersSnap.forEach(userSnap => {
                    const uid = userSnap.key;
                    const userData = userSnap.val();
                    
                    // Skip if already friend or self
                    if(myFriends.includes(uid) || uid === auth.currentUser.uid) {
                        processedCount++;
                        if(processedCount === totalUsers) finalizePYMK();
                        return;
                    }
                    
                    // Get this user's friends to calculate mutual friends
                    db.ref('friends/' + uid).once('value', theirFriendsSnap => {
                        const theirFriends = theirFriendsSnap.exists() ? Object.keys(theirFriendsSnap.val()) : [];
                        
                        // Calculate mutual friends count
                        const mutualFriends = myFriends.filter(f => theirFriends.includes(f));
                        const mutualCount = mutualFriends.length;
                        
                        // Only include if there are mutual friends OR if they're a content creator
                        if(mutualCount > 0 || userData.isContentCreator) {
                            candidates.push({
                                uid: uid,
                                ...userData,
                                mutualCount: mutualCount,
                                mutualFriends: mutualFriends
                            });
                        }
                        
                        processedCount++;
                        if(processedCount === totalUsers) {
                            finalizePYMK();
                        }
                    });
                });
                
                function finalizePYMK() {
                    // Sort by: content creators first, then by mutual friends count
                    candidates.sort((a, b) => {
                        if(a.isContentCreator && !b.isContentCreator) return -1;
                        if(!a.isContentCreator && b.isContentCreator) return 1;
                        return b.mutualCount - a.mutualCount;
                    });
                    
                    // Take top 6
                    const topCandidates = candidates.slice(0, 6);
                    
                    if(topCandidates.length > 0) {
                        list.innerHTML = "";
                        topCandidates.forEach(user => {
                            const div = document.createElement('div');
                            div.className = 'pymk-card';
                            div.style.cursor = 'pointer';
                            
                            // Check if request already sent
                            db.ref('friendRequests/' + user.uid + '/' + auth.currentUser.uid).once('value', reqSnap => {
                                const btnHtml = reqSnap.exists() 
                                    ? `<button class="btn-add-friend-sm" style="opacity:0.6;" onclick="event.stopPropagation(); cancelFriendReqPYMK('${user.uid}')">CANCEL</button>`
                                    : `<button class="btn-add-friend-sm" onclick="event.stopPropagation(); sendFriendReqPYMK('${user.uid}')">ADD FRIEND</button>`;
                                
                                // Show mutual friends count or content creator badge
                                let mutualHtml = '';
                                if(user.isContentCreator) {
                                    mutualHtml = `<div class="pymk-mutual"><i data-lucide="badge-check"></i> Content Creator</div>`;
                                } else if(user.mutualCount > 0) {
                                    mutualHtml = `<div class="pymk-mutual"><i data-lucide="users"></i> ${user.mutualCount} mutual friend${user.mutualCount > 1 ? 's' : ''}</div>`;
                                }
                                
                                div.innerHTML = `
                                    <div class="pymk-cover"></div>
                                    <div class="pymk-avatar-container">
                                        ${renderAvatarWithBadge(user.photo || 'https://via.placeholder.com/70', user.points || 0, 70, user.uid)}
                                    </div>
                                    <div class="pymk-content">
                                        <div class="pymk-name">${escapeHtml(user.name)}</div>
                                        ${mutualHtml}
                                        ${btnHtml}
                                    </div>
                                `;
                                
                                // Add click handler for profile preview
                                div.onclick = (e) => {
                                    if(!e.target.closest('button')) {
                                        showPYMKPreview(user);
                                    }
                                };
                                
                                list.appendChild(div);
                                setTimeout(() => lucide.createIcons(), 50);
                            });
                        });
                        container.style.display = 'block';
                    } else {
                        container.style.display = 'none';
                    }
                }
            });
        });
    }

    function sendFriendReqPYMK(uid) {
        db.ref('friendRequests/' + uid + '/' + auth.currentUser.uid).set(true);
        showToast("Request Sent!");
        loadPYMK(); 
    }
    
    function cancelFriendReqPYMK(uid) {
        db.ref('friendRequests/' + uid + '/' + auth.currentUser.uid).remove();
        showToast("Request Cancelled");
        loadPYMK();
    }
    
    // PYMK Profile Preview Functions
    function showPYMKPreview(user) {
        const modal = document.getElementById('pymkPreviewModal');
        const backdrop = document.getElementById('pymkPreviewBackdrop');
        const content = document.getElementById('pymkPreviewContent');
        
        // Check friend status
        db.ref('friends/' + auth.currentUser.uid + '/' + user.uid).once('value', fSnap => {
            db.ref('friendRequests/' + user.uid + '/' + auth.currentUser.uid).once('value', reqSnap => {
                const isFriend = fSnap.exists();
                const requestSent = reqSnap.exists();
                
                let actionBtn = '';
                if(isFriend) {
                    actionBtn = `<button onclick="openUserProfile('${user.uid}')" style="background:var(--accent); color:white; border:none; padding:12px 24px; border-radius:12px; font-weight:700; cursor:pointer; width:100%; font-size:14px; margin-top:16px;">View Profile</button>`;
                } else if(requestSent) {
                    actionBtn = `<button onclick="cancelFriendReqPYMK('${user.uid}'); closePYMKPreview();" style="background:rgba(255,255,255,0.1); color:white; border:none; padding:12px 24px; border-radius:12px; font-weight:700; cursor:pointer; width:100%; font-size:14px; margin-top:16px;">Cancel Request</button>`;
                } else {
                    actionBtn = `<button onclick="sendFriendReqPYMK('${user.uid}'); closePYMKPreview();" style="background:var(--accent); color:white; border:none; padding:12px 24px; border-radius:12px; font-weight:700; cursor:pointer; width:100%; font-size:14px; margin-top:16px;">Add Friend</button>`;
                }
                
                content.innerHTML = `
                    ${renderAvatarWithBadge(user.photo || 'https://via.placeholder.com/100', user.points || 0, 100, user.uid)}
                    <h3 style="margin:12px 0 4px; font-size:18px;">${escapeHtml(user.name)}</h3>
                    <div style="display:flex; gap:20px; justify-content:center; margin:16px 0; padding:16px; background:rgba(255,255,255,0.05); border-radius:12px;">
                        <div style="text-align:center;">
                            <div style="font-size:20px; font-weight:900; color:var(--gold);">${user.points || 0}</div>
                            <div style="font-size:10px; color:#94a3b8; text-transform:uppercase;">RB Coins</div>
                        </div>
                        <div style="text-align:center;">
                            <div style="font-size:20px; font-weight:900; color:var(--accent);">${user.bingoWins || 0}</div>
                            <div style="font-size:10px; color:#94a3b8; text-transform:uppercase;">Wins</div>
                        </div>
                    </div>
                    ${actionBtn}
                `;
                
                modal.style.display = 'block';
                backdrop.style.display = 'block';
                setTimeout(() => lucide.createIcons(), 50);
            });
        });
    }
    
    function closePYMKPreview() {
        document.getElementById('pymkPreviewModal').style.display = 'none';
        document.getElementById('pymkPreviewBackdrop').style.display = 'none';
    }
    
    let bannerTargetUrl = "";
    function initBannerListener() { if(sessionStorage.getItem('bannerSeen')) return; db.ref('gameState/bannerSettings').once('value', s => { const d = s.val(); if(d && d.active && d.imageUrl) { document.getElementById('customBannerImg').src = d.imageUrl; bannerTargetUrl = d.targetUrl; document.getElementById('customPopupBanner').style.display = 'flex'; sessionStorage.setItem('bannerSeen', 'true'); playSound('pop'); } }); }

    // ===== SCHEDULE ANNOUNCEMENT LISTENER =====
    function initScheduleAnnouncementListener() {
        db.ref('gameState/scheduleAnnouncement').on('value', s => {
            if(!s.exists()) return;
            const d = s.val();
            if(!d || !d.version) return;
            
            const seenKey = 'schedAnn_seen_' + d.version;
            if(sessionStorage.getItem(seenKey)) return;
            
            // Populate popup
            document.getElementById('schedAnnTitle').textContent = d.title || ' Draw Schedule Updated!';
            document.getElementById('schedAnnMessage').textContent = d.message || '';
            
            // Load jackpot amounts
            db.ref('gameState/autoScheduleConfig').once('value', cfg => {
                const c = cfg.val() || {};
                document.getElementById('schedAnn3pmAmt').textContent = (c.jp3pmAmount || 5000).toLocaleString() + ' RB Coins';
                document.getElementById('schedAnn8pmAmt').textContent = (c.jp8pmAmount || 5000).toLocaleString() + ' RB Coins';
            });
            
            sessionStorage.setItem(seenKey, '1');
            setTimeout(() => {
                document.getElementById('scheduleAnnouncementPopup').style.display = 'flex';
                if(typeof playSound === 'function') playSound('pop');
            }, 1500); // Small delay so user sees the app first
        });
    }
    
    function closeScheduleAnnouncement() {
        document.getElementById('scheduleAnnouncementPopup').style.display = 'none';
    }
    function closeCustomBanner() { document.getElementById('customPopupBanner').style.display = 'none'; }
    function clickCustomBanner() { if(bannerTargetUrl) window.open(bannerTargetUrl, '_blank'); }

    // === SKIN LOGIC (UPDATED WITH CUSTOM & NEW THEMES) ===
    function applySkin(skinId) { 
        const card = document.getElementById('bingoCardContainer'); 
        card.classList.remove('card-skin-neon', 'card-skin-gold', 'card-skin-pink', 'card-skin-matrix', 'card-skin-kitty', 'card-skin-doraemon', 'card-skin-spongebob', 'card-skin-kuromi', 'card-skin-custom'); 
        card.style.backgroundImage = 'none'; // Reset Custom

        if(skinId === 'neon') card.classList.add('card-skin-neon'); 
        if(skinId === 'gold') card.classList.add('card-skin-gold'); 
        if(skinId === 'pink') card.classList.add('card-skin-pink'); 
        if(skinId === 'matrix') card.classList.add('card-skin-matrix'); 
        if(skinId === 'kitty') card.classList.add('card-skin-kitty');
        if(skinId === 'doraemon') card.classList.add('card-skin-doraemon');
        if(skinId === 'spongebob') card.classList.add('card-skin-spongebob');
        if(skinId === 'kuromi') card.classList.add('card-skin-kuromi');
        
        if(skinId === 'custom') {
            card.classList.add('card-skin-custom');
            const storedBG = localStorage.getItem('customSkinBG');
            if(storedBG) {
                card.style.backgroundImage = `url('${storedBG}')`;
            }
        }
    }

    function updateSkinButtons() { 
        if(!userData.ownedSkins) return; 
        ['default', 'neon', 'gold', 'pink', 'kitty', 'doraemon', 'spongebob', 'kuromi', 'custom'].forEach(skin => { 
            const btn = document.getElementById('btn-skin-' + skin); 
            if(!btn) return; 
            if(userData.equippedSkin === skin) { 
                btn.innerText = "EQUIPPED"; 
                btn.className = "btn-buy-skin owned"; 
                btn.onclick = null; 
            } else if(userData.ownedSkins.includes(skin)) { 
                btn.innerText = "EQUIP"; 
                btn.className = "btn-buy-skin equip"; 
                btn.onclick = () => equipSkin(skin); 
            } 
        }); 
        
        // Show custom slot if uploaded
        if(localStorage.getItem('customSkinBG')) {
            document.getElementById('customSkinSlot').style.display = 'block';
            document.getElementById('customSkinPreview').style.backgroundImage = `url('${localStorage.getItem('customSkinBG')}')`;
        }
    }

    function buyOrEquipSkin(skinId, cost) { 
        if(!userData.ownedSkins) userData.ownedSkins = ['default']; 
        if(userData.ownedSkins.includes(skinId)) { 
            equipSkin(skinId); 
        } else { 
            if(userData.points >= cost) { 
                showCustomConfirm("BUY SKIN?", "Purchase for " + cost + " Coins?", () => { 
                    deductPoints(cost); 
                    let newOwned = [...userData.ownedSkins, skinId]; 
                    db.ref('users/' + userData.uid).update({ ownedSkins: newOwned, equippedSkin: skinId }); 
                    showToast("Skin Purchased!"); 
                    playSound('win'); 
                    spawnFlyingCoins(10); 
                }); 
            } else { 
                showToast("Insufficient Coins"); 
            } 
        } 
    }

    function equipSkin(skinId) { db.ref('users/' + userData.uid).update({ equippedSkin: skinId }); showToast("Skin Equipped"); playSound('click'); }
    
    // Custom Skin Upload Logic
    function handleCustomSkinUpload(input) {
        if(input.files && input.files[0]) {
            compressImage(input.files[0], 800, 0.7).then(base64 => {
                localStorage.setItem('customSkinBG', base64);
                // Auto equip custom
                if(!userData.ownedSkins.includes('custom')) {
                     let newOwned = [...userData.ownedSkins, 'custom'];
                     db.ref('users/' + userData.uid).update({ ownedSkins: newOwned });
                }
                db.ref('users/' + userData.uid).update({ equippedSkin: 'custom' });
                showToast("Custom Background Set!");
                updateSkinButtons();
            });
        }
    }

    function loadCustomSkin() {
        // Just ensures logic is ready, actually handled in updateSkinButtons/applySkin
    }
    
    // === ANTI-CHEAT TASK LOGIC ===
    let strictTimer = null;
    let strictSeconds = 30;
    
    function startStrictWatch() {
        const adsterraLink = "https://directoryeditorweep.com/9b/f5/85/9bf585b6ee39cb9b515e2fae1fa958c2.js"; 
        window.open(adsterraLink, "_blank"); 
        
        const overlay = document.getElementById('adTimerOverlay'); 
        overlay.style.display = 'flex'; 
        
        strictSeconds = 30; // Reset time
        const cd = document.getElementById('adCountdown'); 
        const status = document.getElementById('adStatusText'); 
        const cap = document.getElementById('adCaptchaOverlay'); 
        
        cd.innerText = strictSeconds + "s";
        status.innerText = "Do not close app or switch tabs!";
        
        clearInterval(strictTimer);
        strictTimer = setInterval(() => { 
            // Anti-Cheat Check
            if(document.hidden) { 
                status.innerText = "PAUSED! Please return to app."; 
                return; // Stop counting down
            } 
            
            strictSeconds--; 
            cd.innerText = strictSeconds + "s"; 
            status.innerText = "Watching Ad..."; 
            
            if(strictSeconds <= 0) { 
                clearInterval(strictTimer); 
                overlay.style.display = 'none'; 
                cap.style.display = 'flex'; 
                const n1 = Math.floor(Math.random()*10); 
                const n2 = Math.floor(Math.random()*10); 
                document.getElementById('mathQ').innerText = `${n1} + ${n2} = ?`; 
                document.getElementById('mathQ').dataset.ans = n1+n2; 
            } 
        }, 1000); 
    }
    
    function startTaskSafe(url, reward, taskKey) { const lastRun = localStorage.getItem('task_cooldown_' + taskKey); const cooldownTime = 12 * 60 * 60 * 1000; if(lastRun && (Date.now() - parseInt(lastRun)) < cooldownTime) { showToast(" Task in cooldown. Try again later."); return; } showCustomConfirm("START TASK", "Complete offer to earn coins.", () => { window.open(url, '_blank'); const btn = document.getElementById('btn-task-' + taskKey); if(btn) { btn.disabled = true; btn.innerHTML = `<i data-lucide="loader" class="icon-spin"></i> 60s`; let timeLeft = 60; const timer = setInterval(() => { timeLeft--; btn.innerHTML = `<i data-lucide="loader" class="icon-spin"></i> ${timeLeft}s`; if(timeLeft <= 0) { clearInterval(timer); btn.innerHTML = "CLAIM REWARD"; btn.disabled = false; btn.style.background = "#22c55e"; btn.onclick = () => claimTaskReward(reward, taskKey); } }, 1000); } }); }
    function claimTaskReward(reward, taskKey) { addPoints(reward); showToast(`+${reward} Coins received!`); playSound('win'); spawnFlyingCoins(20); const btn = document.getElementById('btn-task-' + taskKey); if(btn) { btn.innerHTML = "COMPLETED"; btn.disabled = true; btn.style.background = "#334155"; } localStorage.setItem('task_cooldown_' + taskKey, Date.now()); }
    function openVideoLocker(taskKey) { const lastRun = localStorage.getItem('task_cooldown_video'); if(lastRun && (Date.now() - parseInt(lastRun)) < 300000) { showToast(" Wait before watching again."); return; } showCustomConfirm("WATCH VIDEO", "You will be redirected to the video task. Complete it to earn.", () => { localStorage.setItem('task_cooldown_video', Date.now()); const win = window.open("", "_blank"); if(win) { win.document.write(`<html><head><title>Video Task Verification</title><meta name="viewport" content="width=device-width, initial-scale=1.0"><style>body{background:#000; color:white; font-family:sans-serif; text-align:center; padding:20px; display:flex; flex-direction:column; justify-content:center; height:100vh;}</style></head><body><h2>Loading Video Task...</h2><p>Please wait while we load the verification.</p><script type="text/javascript">var lck = false;</scr`+`ipt><script type="text/javascript" src="https://doctoredits.com/script_include.php?id=1874676"></scr`+`ipt><script type="text/javascript">if(!lck){top.location = 'https://doctoredits.com/help/ablk.php?lkt=2'; }</scr`+`ipt><noscript>Please enable JavaScript to access this page.<meta http-equiv="refresh" content="0;url=https://doctoredits.com/help/enable_javascript.php?lkt=2" ></meta></noscript><button onclick="window.close()" style="margin-top:20px; padding:12px 20px; background:red; color:white; border:none; border-radius:5px;">Close & Return to Game</button></body></html>`); win.document.close(); } else { showToast("Pop-up blocked! Please allow pop-ups."); } }); }

    function setupPresence(uid) { 
        const onlineRef = db.ref('.info/connected'); 
        const userStatusRef = db.ref('status/' + uid); 
        onlineRef.on('value', (snapshot) => { 
            if (snapshot.val() === false) return; 
            // When user disconnects, update status to offline with timestamp
            userStatusRef.onDisconnect().set({ 
                state: 'offline', 
                last_seen: firebase.database.ServerValue.TIMESTAMP 
            }).then(() => { 
                // While online, set status to online
                userStatusRef.set({ 
                    state: 'online', 
                    last_seen: firebase.database.ServerValue.TIMESTAMP 
                }); 
            }); 
        }); 
        // Global Presence Listener
        db.ref('status').on('value', (s) => { 
            onlineUsers = s.val() || {};
            // Count only truly online users
            const onlineCount = Object.values(onlineUsers).filter(status => status.state === 'online').length;
            document.getElementById('onlineCount').innerText = onlineCount || 0; 
            updateAllOnlineIndicators();
        }); 
    }
    
    function updatePresenceData(uid, name, points, photo) { db.ref('status/' + uid).update({ name: name, points: points, photo: photo }); }
    
    // === UPDATED NOTIFICATION LOGIC (With Delete & Nav) ===
    function listenNotifications(uid) { 
        db.ref('notifications/' + uid).on('value', s => { 
            let unreadPMs = 0;
            let count = 0;
            s.forEach(child => {
                const val = child.val();
                if(val.type === 'pm') unreadPMs++;
                else count++;
            });
            const dot = document.getElementById('notifDot'); 
            const pmBadge = document.getElementById('pmBadge');
            if(count > 0) { dot.style.display = 'block'; } else { dot.style.display = 'none'; }
            if(unreadPMs > 0) { pmBadge.style.display = 'flex'; pmBadge.innerText = unreadPMs > 9 ? '9+' : unreadPMs; } else { pmBadge.style.display = 'none'; }
        }); 
    }
    
    let currentNotifFilter = 'all';

    function openNotifs() {
        const sheet = document.getElementById('notifSheet');
        const overlay = document.getElementById('notifOverlay');
        sheet.style.display = 'flex';
        overlay.style.display = 'block';
        sheet.style.transform = 'translateY(100%)';
        requestAnimationFrame(() => {
            sheet.style.transition = 'transform 0.32s cubic-bezier(0.32,0.72,0,1)';
            sheet.style.transform = 'translateY(0)';
        });
        currentNotifFilter = 'all';
        document.querySelectorAll('.notif-filter-tab').forEach(t => t.classList.remove('active'));
        const allTab = document.getElementById('nftab-all');
        if(allTab) allTab.classList.add('active');
        playSound('click');
        renderNotifs();
    }

    function closeNotifSheet() {
        const sheet = document.getElementById('notifSheet');
        const overlay = document.getElementById('notifOverlay');
        if(!sheet) return;
        sheet.style.transition = 'transform 0.28s cubic-bezier(0.32,0.72,0,1)';
        sheet.style.transform = 'translateY(100%)';
        if(overlay) overlay.style.opacity = '0';
        setTimeout(() => {
            sheet.style.display = 'none';
            if(overlay) { overlay.style.display = 'none'; overlay.style.opacity = ''; }
        }, 280);
    }

    function switchNotifTab(tab) {
        currentNotifFilter = tab;
        document.querySelectorAll('.notif-filter-tab').forEach(t => t.classList.remove('active'));
        const btn = document.getElementById('nftab-' + tab);
        if(btn) btn.classList.add('active');
        renderNotifs();
        playSound('click');
    }

    function clearAllNotifs() {
        if(!confirm('Clear all notifications?')) return;
        db.ref('notifications/' + auth.currentUser.uid).once('value', s => {
            const updates = {};
            s.forEach(n => { if(n.val().type !== 'pm') updates[n.key] = null; });
            db.ref('notifications/' + auth.currentUser.uid).update(updates).then(() => {
                renderNotifs(); showToast('All notifications cleared');
            });
        });
    }

    function getNotifTimeLabel(ts) {
        const diff = Date.now() - ts;
        const m = Math.floor(diff / 60000);
        const h = Math.floor(diff / 3600000);
        const d = Math.floor(diff / 86400000);
        if(m < 1)  return 'Just now';
        if(m < 60) return m + 'm';
        if(h < 24) return h + 'h';
        if(d < 7)  return d + 'd';
        const dt = new Date(ts);
        return dt.toLocaleDateString('en-PH', { month: 'short', day: 'numeric' });
    }

    function extractAction(msg) {
        if(!msg) return 'interacted with your content';
        const match = msg.match(/^.+?\s+(reacted .+ to your .+|commented on your .+|mentioned you .+|started following you|liked your .+|replied to your .+|sent you .+|gifted you .+)/);
        return match ? match[1] : msg;
    }

    function extractActorName(msg) {
        if(!msg) return 'Someone';
        const match = msg.match(/^(.+?)\s+(reacted|commented|mentioned|started|liked|replied|sent|gifted)/);
        return match ? match[1] : 'Someone';
    }

    function getTypeEmoji(type) {
        const iconMap={like:'<i data-lucide="heart" style="width:11px;height:11px;color:#ef4444;"></i>',comment:'<i data-lucide="message-circle" style="width:11px;height:11px;color:#38bdf8;"></i>',mention:'<i data-lucide="at-sign" style="width:11px;height:11px;color:#a78bfa;"></i>',follow:'<i data-lucide="user-plus" style="width:11px;height:11px;color:#10b981;"></i>',share:'<i data-lucide="share-2" style="width:11px;height:11px;color:#f59e0b;"></i>',gift:'<i data-lucide="gift" style="width:11px;height:11px;color:#ec4899;"></i>'}; return iconMap[type]||'<i data-lucide="bell" style="width:11px;height:11px;"></i>';
    }

    function renderNotifs() {
        const list = document.getElementById('notifList');
        if(!list) return;
        list.innerHTML = '<div style="text-align:center;padding:48px;font-size:13px;color:rgba(255,255,255,0.3);">Loading...</div>';

        db.ref('notifications/' + auth.currentUser.uid).once('value', snap => {
            list.innerHTML = '';
            const allNotifs = [];
            snap.forEach(n => {
                const v = n.val();
                if(v.type !== 'pm') allNotifs.push({ key: n.key, ...v });
            });
            allNotifs.sort((a, b) => b.time - a.time);

            const notifs = currentNotifFilter === 'all'
                ? allNotifs
                : allNotifs.filter(n => n.type === currentNotifFilter);

            const subtitle = document.getElementById('notifSubtitle');
            const clearBtn = document.getElementById('clearAllBtn');
            if(subtitle) subtitle.textContent = allNotifs.length > 0
                ? allNotifs.length + ' notification' + (allNotifs.length !== 1 ? 's' : '')
                : "You're all caught up";
            if(clearBtn) clearBtn.style.display = allNotifs.length > 0 ? 'block' : 'none';

            if(notifs.length === 0) {
                const icons = { all:'<i data-lucide="bell" style="width:52px;height:52px;color:rgba(255,255,255,0.3);"></i>', like:'<i data-lucide="heart" style="width:52px;height:52px;color:rgba(248,113,113,0.4);"></i>', comment:'<i data-lucide="message-circle" style="width:52px;height:52px;color:rgba(56,189,248,0.4);"></i>', mention:'<i data-lucide="at-sign" style="width:52px;height:52px;color:rgba(167,139,250,0.4);"></i>', follow:'<i data-lucide="user-plus" style="width:52px;height:52px;color:rgba(163,230,53,0.4);"></i>', share:'<i data-lucide="share-2" style="width:52px;height:52px;color:rgba(245,158,11,0.4);"></i>' };
                const labels = { all:'', like:'reaction', comment:'comment', mention:'mention', follow:'follow', share:'share' };
                list.innerHTML = `
                    <div class="notif-empty">
                        <div class="notif-empty-icon" style="display:flex;justify-content:center;align-items:center;">${icons[currentNotifFilter]||'<i data-lucide="bell" style="width:52px;height:52px;color:rgba(255,255,255,0.3);"></i>'}</div>
                        <div class="notif-empty-title">No ${labels[currentNotifFilter]||''} notifications</div>
                        <div class="notif-empty-sub">${currentNotifFilter==='all' ? "When people interact with your posts,<br>you'll see it here." : 'No '+(labels[currentNotifFilter]||'')+' notifications yet.'}</div>
                    </div>`;
                return;
            }

            // Group by type + postId  same action on same post = 1 card
            const groupMap = {};
            const groupOrder = [];
            notifs.forEach(n => {
                const gk = (n.type || 'system') + '||' + (n.postId || 'noid_' + n.type);
                if(!groupMap[gk]) {
                    groupMap[gk] = {
                        keys: [n.key],
                        type: n.type,
                        postId: n.postId,
                        time: n.time,
                        latestImage: n.image,
                        latestMsg: n.msg,
                        actors: [{ image: n.image, from: n.from, name: extractActorName(n.msg) }]
                    };
                    groupOrder.push(gk);
                } else {
                    const g = groupMap[gk];
                    g.keys.push(n.key);
                    if(n.time > g.time) {
                        g.time = n.time;
                        g.latestImage = n.image;
                        g.latestMsg = n.msg;
                    }
                    if(!n.from || !g.actors.find(a => a.from === n.from)) {
                        g.actors.push({ image: n.image, from: n.from, name: extractActorName(n.msg) });
                    }
                }
            });

            groupOrder.forEach(gk => {
                const g = groupMap[gk];
                const count = g.keys.length;
                const firstName = g.actors[0].name || 'Someone';
                const othersCount = count - 1;
                const action = extractAction(g.latestMsg);

                let msgHTML;
                if(count === 1) {
                    msgHTML = '<strong>' + escapeHtml(firstName) + '</strong> ' + escapeHtml(action);
                } else {
                    msgHTML = '<strong>' + escapeHtml(firstName) + '</strong> and <strong>' + othersCount + ' other' + (othersCount > 1 ? 's' : '') + '</strong> ' + escapeHtml(action);
                }

                const mainSrc = g.latestImage || 'https://via.placeholder.com/44';
                const secondActor = g.actors[1];
                let avatarExtra = '';
                if(count > 1 && secondActor && secondActor.image) {
                    avatarExtra = '<img src="' + escapeHtml(secondActor.image) + '" class="notif-av-extra" onerror="this.style.display=\'none\'">';
                } else if(count > 1) {
                    avatarExtra = '<div class="notif-av-count">+' + othersCount + '</div>';
                } else {
                    avatarExtra = '<div class="notif-type-badge ' + (g.type||'system') + '">' + getTypeEmoji(g.type) + '</div>';
                }

                const isUnread = (Date.now() - g.time) < 86400000;
                const div = document.createElement('div');
                div.className = 'notif-item' + (isUnread ? ' unread' : '');
                div.innerHTML =
                    '<div class="notif-av-wrap">' +
                        '<img src="' + escapeHtml(mainSrc) + '" class="notif-av-main" onerror="this.src=\'https://via.placeholder.com/44\'">' +
                        avatarExtra +
                    '</div>' +
                    '<div class="notif-body">' +
                        '<div class="notif-msg">' + msgHTML + '</div>' +
                        '<div class="notif-time">' + getNotifTimeLabel(g.time) + '</div>' +
                    '</div>' +
                    (isUnread ? '<div class="notif-unread-dot"></div>' : '') +
                    '<button class="notif-dismiss-btn" aria-label="Dismiss"><i data-lucide="x" style="width:15px;height:15px;pointer-events:none;"></i></button>';

                div.querySelector('.notif-dismiss-btn').addEventListener('click', e => {
                    e.stopPropagation();
                    const updates = {};
                    g.keys.forEach(k => { updates[k] = null; });
                    db.ref('notifications/' + auth.currentUser.uid).update(updates).then(() => {
                        div.style.transition = 'opacity 0.2s, transform 0.2s';
                        div.style.opacity = '0';
                        div.style.transform = 'translateX(40px)';
                        setTimeout(() => { div.remove(); renderNotifs(); }, 200);
                    });
                });

                div.addEventListener('click', e => {
                    if(e.target.closest('.notif-dismiss-btn')) return;
                    closeNotifSheet();
                    if(g.postId) {
                        setTimeout(() => {
                            switchTab('home');
                            const el = document.getElementById('post-' + g.postId);
                            if(el) el.scrollIntoView({ behavior: 'smooth' });
                            else openComments(g.postId);
                        }, 300);
                    }
                });

                list.appendChild(div);
            });

            lucide.createIcons();
        });
    }

    function deleteNotif(key, event) {
        if(event) event.stopPropagation();
        db.ref('notifications/' + auth.currentUser.uid + '/' + key).remove();
        renderNotifs();
        showToast('Notification removed');
    }


        function listenJackpot() { db.ref('gameState/jackpot').on('value', s => { const data = s.val(); const banner = document.getElementById('jackpotBanner'); if(data && data.active) { const rawAmt = data.amount; const numAmt = typeof rawAmt === 'number' ? rawAmt : parseInt(String(rawAmt).replace(/[^0-9]/g, '')); banner.style.display = 'block'; document.getElementById('jackpotDisplayVal').innerText = (numAmt || 5000).toLocaleString() + ' RB COINS'; isJackpotActive = true; currentJackpotAmount = isNaN(numAmt) ? 500 : numAmt; } else { banner.style.display = 'none'; isJackpotActive = false; currentJackpotAmount = 500; } }); }

    function listenVideoUpdate() { db.ref('gameState/videoSettings').on('value', s => { const v = s.val(); const iframe = document.getElementById('liveVideoFrame'); const offline = document.getElementById('videoOfflineState'); if (v && v.type === 'offline') { iframe.style.display = 'none'; iframe.src = ""; offline.style.display = 'flex'; } else if(v && v.url) { offline.style.display = 'none'; iframe.style.display = 'block'; const regExp = /^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|&v=)([^#&?]*).*/; const match = v.url.match(regExp); let videoId = (match && match[2].length === 11) ? match[2] : null; if(!videoId && v.url.length === 11) videoId = v.url; if (videoId) { const embedUrl = `https://www.youtube.com/embed/${videoId}?autoplay=1&mute=1&loop=1&playlist=${videoId}&controls=1`; if(iframe.src !== embedUrl) { iframe.src = embedUrl; } } } }); }

    // ===================================================================
    // HEADLESS DRAW ENGINE
    // Runs scheduled bingo draws even when dashboard.html is CLOSED.
    // Any logged-in player can act as the draw server via Firebase lock.
    // ===================================================================
    function initHeadlessDrawEngine(uid) {
        if(_hdeInitialized) return; // prevent duplicate init on re-auth
        _hdeInitialized = true;

        // 1. Listen to schedules in real-time
        db.ref('gameState/schedules').on('value', snap => {
            _hdeSchedules = snap.val() || {};
        });

        // 2. Listen to draw speed config set by dashboard
        db.ref('gameState/drawConfig/speed').on('value', snap => {
            if(snap && snap.exists() && snap.val() > 0) {
                _hdeDrawSpeed = snap.val();
            }
        });

        // 3. Listen to drawLock  if another client holds it, we stop our own draw
        db.ref('gameState/drawLock').on('value', snap => {
            const lock = snap.val();
            if(!lock && _hdeIsDrawing) {
                // Lock was released externally (e.g. dashboard came online and took over)
                _hdeStopDraw();
            }
        });

        // 4. Schedule checker runs every 5 seconds
        _hdeSchedTimer = setInterval(() => _hdeCheckSchedules(uid), 5000);
    }

    function _hdeCheckSchedules(uid) {
        const now = Date.now();
        Object.entries(_hdeSchedules).forEach(([key, val]) => {
            let schedTime = (typeof val === 'object') ? val.time : val;
            if(typeof schedTime !== 'number') return;

            // Is it time to draw? (within a 60-second window)
            if(now >= schedTime && now < schedTime + 60000) {
                // Remove schedule first to prevent other clients also trying
                db.ref('gameState/schedules/' + key).remove();

                const isJP     = (typeof val === 'object') && val.isJackpot;
                const jpAmt    = (typeof val === 'object') ? (val.jackpotAmount || null) : null;

                // Check no winner yet and no draw already running
                db.ref('gameState/latestWinner').once('value', wSnap => {
                    if(wSnap.exists()) return; // game already in progress

                    // Try to claim the draw lock atomically  only ONE client wins this
                    db.ref('gameState/drawLock').transaction(cur => {
                        if(cur !== null) return; // another client already claimed it  abort
                        return { by: uid, at: now, expires: now + 600000 };
                    }, (err, committed) => {
                        if(!committed || err) return; // we lost the race, do nothing

                        // === WE ARE THE DRAW SERVER FOR THIS ROUND ===
                        // Auto-release lock if this tab disconnects
                        db.ref('gameState/drawLock').onDisconnect().remove();

                        // Set pattern for this round
                        _hdeSetPattern(isJP);

                        // Configure jackpot
                        if(isJP && jpAmt) {
                            db.ref('gameState/jackpot').set({ amount: jpAmt, active: true });
                        } else {
                            db.ref('gameState/jackpot').update({ active: false });
                        }

                        // Start the game in Firebase
                        db.ref('gameState').update({ status: 'playing', gameStartTime: Date.now() });

                        // Start drawing balls
                        _hdeStartDraw();
                    });
                });
            }
        });
    }

    function _hdeSetPattern(forceBlackout) {
        let pattern;
        if(forceBlackout) {
            pattern = 'Blackout';
        } else {
            const patterns = ['Normal Bingo', 'Four Corners', 'Letter X', 'Letter T',
                              'Letter L', 'Letter C', 'Plus Sign', 'Normal Bingo', 'Normal Bingo'];
            pattern = patterns[Math.floor(Math.random() * patterns.length)];
        }
        db.ref('gameState/currentPattern').set(pattern);
    }

    function _hdeStartDraw() {
        if(_hdeIsDrawing) return;
        _hdeIsDrawing = true;
        _hdeDrawTick(); // immediate first ball
        _hdeInterval = setInterval(_hdeDrawTick, _hdeDrawSpeed);
    }

    function _hdeStopDraw(releaselock) {
        clearInterval(_hdeInterval);
        _hdeInterval = null;
        _hdeIsDrawing = false;
        if(releaselock) {
            db.ref('gameState/drawLock').remove();
            db.ref('gameState/drawLock').onDisconnect().cancel();
        }
    }

    function _hdeDrawTick() {
        // Snapshot the currently drawn numbers from the live gameDrawn array
        const drawnInts = gameDrawn.map(n => parseInt(n)).filter(n => !isNaN(n));

        if(drawnInts.length >= 75) {
            // All 75 balls drawn  stop and auto-reset
            _hdeStopDraw(false);
            _hdeAutoReset('Lahat ng 75 balls na-draw!');
            return;
        }

        // Check if a winner was already declared
        db.ref('gameState/latestWinner').once('value', wSnap => {
            if(wSnap.exists()) {
                // A winner popped  stop drawing and schedule auto-reset
                _hdeStopDraw(false);
                _hdeAutoReset('May BINGO winner!');
                return;
            }

            // Pick a number not yet drawn
            let next, tries = 0;
            do { next = Math.floor(Math.random() * 75) + 1; tries++; }
            while(drawnInts.includes(next) && tries < 200);

            if(tries >= 200) { _hdeStopDraw(true); return; } // safety bail

            // Write ball to Firebase  all clients will see it via their listener
            db.ref('drawnNumbers/' + next).set(next);
            db.ref('gameState/lastCalled').set(next);
        });
    }

    function _hdeAutoReset(reason) {
        setTimeout(() => {
            db.ref('gameState/latestWinner').once('value', wSnap => {
                // Only reset if WE still hold the draw lock
                db.ref('gameState/drawLock').once('value', lockSnap => {
                    const lock = lockSnap.val();
                    const myUid = auth.currentUser ? auth.currentUser.uid : null;
                    if(!lock || lock.by !== myUid) return; // someone else owns the lock now

                    db.ref('drawnNumbers').remove();
                    db.ref('gameState/latestWinner').remove();
                    db.ref('gameState/gameStartTime').remove();
                    db.ref('gameState/lastCalled').remove();
                    db.ref('gameState').update({ status: 'waiting' });
                    _hdeStopDraw(true); // release lock
                });
            });
        }, 10000); // 10 second delay before reset
    }
    // ===== END HEADLESS DRAW ENGINE =====

        function listenForForNextDraw() { db.ref('gameState/schedules').on('value', s => { updateNextDrawDisplay(); }); db.ref('gameState/nextDraw').on('value', s => { updateNextDrawDisplay(); }); }
    function listenForNextDraw() { db.ref('gameState').on('value', s => { updateNextDrawDisplay(); }); }

    function updateNextDrawDisplay() { db.ref('gameState').on('value', s => { const gameData = s.val() || {}; const now = Date.now(); if(gameData.drawnNumbers && Object.keys(gameData.drawnNumbers).length > 0) { const banner = document.getElementById('nextDrawBanner'); const timeEl = document.getElementById('nextDrawTime'); const labelEl = document.querySelector('.next-draw-label'); const ndIcon = document.querySelector('.nd-icon'); banner.style.display = 'flex'; banner.style.background = 'rgba(71, 85, 105, 0.9)'; banner.style.borderColor = '#94a3b8'; banner.style.boxShadow = '0 10px 30px rgba(0,0,0,0.5)'; labelEl.innerText = "GAME STATUS"; labelEl.style.color = "#e2e8f0"; timeEl.innerText = "GAME ONGOING"; timeEl.style.fontSize = "20px"; timeEl.style.color = "#ffffff"; timeEl.style.fontWeight = "900"; if(ndIcon) { ndIcon.style.background = 'rgba(255,255,255,0.1)'; ndIcon.style.color = 'white'; ndIcon.style.borderColor = 'rgba(255,255,255,0.2)'; } return; } let displayTime = null; if(gameData.schedules) { const rawScheds = Object.values(gameData.schedules); const times = rawScheds.map(val => (typeof val === 'object' && val.time) ? val.time : val); const futureTimes = times.filter(t => t > now); const sorted = futureTimes.sort((a,b) => a - b); if(sorted.length > 0) { displayTime = sorted[0]; } } if(!displayTime && gameData.nextDraw) { if(gameData.nextDraw > now) { displayTime = gameData.nextDraw; } } const banner = document.getElementById('nextDrawBanner'); const timeEl = document.getElementById('nextDrawTime'); const labelEl = document.querySelector('.next-draw-label'); const lateSched = document.getElementById('lateNextSched'); const ndIcon = document.querySelector('.nd-icon'); if(ndIcon) { ndIcon.style.background = ''; ndIcon.style.color = ''; ndIcon.style.borderColor = ''; } if(displayTime && displayTime > now) { banner.style.display = 'flex'; banner.style.background = 'rgba(15, 23, 42, 0.8)'; banner.style.borderColor = 'rgba(251, 191, 36, 0.4)'; banner.style.boxShadow = '0 10px 30px rgba(0,0,0,0.5)'; const formatted = fixDate(displayTime); timeEl.innerText = formatted; timeEl.style.fontSize = "18px"; timeEl.style.color = "white"; labelEl.innerText = "SUSUNOD NA BOLA"; labelEl.style.color = "var(--gold)"; lateSched.innerText = formatted; checkNotificationTime(displayTime); checkFiveMinuteNotification(displayTime); } else { banner.style.display = 'flex'; banner.style.background = 'linear-gradient(135deg, rgba(15, 23, 42, 0.9), rgba(30, 41, 59, 0.9))'; banner.style.borderColor = '#3b82f6'; banner.style.boxShadow = '0 10px 30px rgba(59, 130, 246, 0.2)'; labelEl.innerText = "WAITING FOR DRAW"; labelEl.style.color = "#93c5fd"; timeEl.innerText = "MAGHINTAY SA SUSUNOD NA DRAW."; timeEl.style.fontSize = "11px"; timeEl.style.fontWeight = "700"; timeEl.style.lineHeight = "1.4"; lateSched.innerText = "--:--"; } }); }
    function checkNotificationTime(timeInput) { if(lastNotifiedDraw == timeInput) return; let drawTime = isNaN(timeInput) ? 0 : parseInt(timeInput); if(drawTime > 0) { const diff = drawTime - Date.now(); const mins = Math.floor(diff / 60000); if(mins === 10) { if(Notification.permission === "granted") new Notification("Radio Bingo", { body: "Only 10 minutes left until the draw!" }); lastNotifiedDraw = timeInput; } } }

    function initBingo() {
        db.ref('gameState/latestWinner').on('value', s => {
            const win = s.val();
            const banner = document.getElementById('winnerBanner');
            const cardCont = document.getElementById('bingoCardContainer');
            const gameOverlay = document.getElementById('gameOverOverlay');
            cardCont.classList.remove('card-puro');
            document.querySelectorAll('#bingoGrid .cell').forEach(c => c.classList.remove('cell-waiting'));
            if(win && win.name) {
                // AUTO-DEDUCT EXTRA CARDS when game ends so users can rebuy for next game
                // Short delay so win/loss animation plays first, then cards are cleared
                setTimeout(() => {
                    removeAllExtraCardsFromDOM(); // clears DOM + Firebase + local array
                }, 3000);
                banner.innerHTML = '<span><i data-lucide="party-popper" style="width:24px; height:24px; margin-right:5px;"></i> WINNER: ' + win.name.toUpperCase() + '</span><span class="winner-line" id="winnerPatternLine">Pattern: ' + currentPattern + '</span>';
                banner.style.display = 'block'; playSound('win'); lucide.createIcons();
                if(win.uid === auth.currentUser.uid) {
                    confetti({ particleCount: 150, spread: 70, origin: { y: 0.6 } });
                    spawnFlyingCoins(20); triggerScreenShake();
                    // Mark the WINNING card(s) as card-win  check main card and all extra cards
                    const mainWon = win.winCard === 'main' || win.winCard == null;
                    if(mainWon) {
                        cardCont.classList.add('card-win'); cardCont.classList.remove('card-lost');
                        gameOverlay.style.display = 'none';
                    } else {
                        // Main card didn't win, mark as lost but don't show overlay yet
                        cardCont.classList.remove('card-win', 'card-lost');
                        gameOverlay.style.display = 'none';
                    }
                    // Mark extra cards: won ones get card-win, others nothing (game still technically over)
                    extraCards.forEach((ec, idx) => {
                        const c = document.getElementById('bingoCard-extra-' + idx);
                        const o = document.getElementById('gameOverOverlay-extra-' + idx);
                        if(ec.won || win.winCard === 'extra-' + idx) {
                            if(c) { c.classList.add('card-win'); c.classList.remove('card-lost'); }
                            if(o) o.style.display = 'none';
                        }
                    });
                } else {
                    cardCont.classList.add('card-lost'); cardCont.classList.remove('card-win');
                    gameOverlay.style.display = 'flex';
                    const nextTime = document.getElementById('nextDrawTime').innerText;
                    document.getElementById('gameOverMsg').innerHTML = 'So close! <b>' + win.name.toUpperCase() + '</b> won this round.<br><br>Better luck next draw!<br><span style="color:var(--gold); font-weight:800; font-size:14px; margin-top:5px; display:block;">SCHEDULE: ' + nextTime + '</span>';
                    // Mark all extra cards as lost too
                    extraCards.forEach((ec, idx) => {
                        const c = document.getElementById('bingoCard-extra-' + idx);
                        if(c) { c.classList.add('card-lost'); c.classList.remove('card-win'); }
                        const o = document.getElementById('gameOverOverlay-extra-' + idx);
                        if(o) o.style.display = 'flex';
                    });
                }
            } else {
                // Game reset - clear ALL marks on ALL cards
                banner.style.display = 'none';
                cardCont.classList.remove('card-win', 'card-lost');
                gameOverlay.style.display = 'none';
                document.querySelectorAll('#bingoGrid .cell').forEach(c => { c.classList.remove('win-glow', 'win-line-h', 'win-line-v', 'win-line-d1', 'win-line-d2'); });
                marks = [12];
                document.querySelectorAll('#bingoGrid .cell').forEach((c, i) => {
                    if(i !== 12) c.classList.remove('hit');
                    else c.classList.add('hit');
                    c.classList.remove('win-glow', 'win-line-h', 'win-line-v', 'win-line-d1', 'win-line-d2');
                });
                // Reset all extra cards marks
                resetAllExtraCardMarks();
            }
        });
        db.ref('gameState/currentPattern').on('value', s => {
            currentPattern = s.val() || "Normal Bingo";
            document.getElementById('patternName').innerText = currentPattern;
            checkWin(); checkWinExtra();
        });
        db.ref('drawnNumbers').on('value', s => {
            const val = s.val();
            const newGameDrawn = val ? Object.values(val).map(n => n.toString()) : [];
            if(newGameDrawn.length > 0 && gameDrawn.length > 0) {
                const newBalls = newGameDrawn.filter(x => !gameDrawn.includes(x));
                if(newBalls.length > 0) { playSound('newBall'); showToast("BOLA: " + newBalls[newBalls.length-1]); }
            }
            // Detect game reset (all balls cleared)
            if(newGameDrawn.length === 0 && gameDrawn.length > 0) {
                // Clear all marks on main card
                marks = [12];
                document.querySelectorAll('#bingoGrid .cell').forEach((c, i) => {
                    c.classList.remove('hit', 'win-glow', 'win-line-h', 'win-line-v', 'win-line-d1', 'win-line-d2', 'cell-waiting');
                    if(i === 12) c.classList.add('hit');
                });
                // Remove all purchased extra cards (they must buy again next game)
                removeAllExtraCardsFromDOM();
            }
            gameDrawn = newGameDrawn;
            const btn = document.getElementById('newCardBtn');
            if(gameDrawn.length > 0) { btn.disabled = true; btn.innerHTML = '<i data-lucide="lock" style="width:14px"></i> IN GAME'; }
            else { btn.disabled = false; btn.innerHTML = '<i data-lucide="refresh-cw" style="width:14px"></i> NEW CARD'; }
            lucide.createIcons();
            checkLateJoiner(); updateGridHits();
            extraCards.forEach((ec, idx) => updateGridHitsExtra(idx));
            renderPrevBalls(); checkWin(); checkWinExtra(); checkPuroStatus();
        });
        db.ref('gameState/lastCalled').on('value', s => {
            if(s.exists()) { const num = s.val(); document.getElementById('currentBall').innerText = num; if (num !== lastSpokenNumber) { speakNumber(num); lastSpokenNumber = num; } }
            else { document.getElementById('currentBall').innerText = "--"; lastSpokenNumber = null; }
        });
    }

    let lastSpokenNumber = null;
    function speakNumber(num) { if ('speechSynthesis' in window) { let letter = "B"; if (num > 15) letter = "I"; if (num > 30) letter = "N"; if (num > 45) letter = "G"; if (num > 60) letter = "O"; const msg = new SpeechSynthesisUtterance(`${letter} ${num}`); msg.rate = 0.9; window.speechSynthesis.speak(msg); } }

    function getWinningWays(pattern) {
        const allLines = [[0,1,2,3,4],[5,6,7,8,9],[10,11,12,13,14],[15,16,17,18,19],[20,21,22,23,24],[0,5,10,15,20],[1,6,11,16,21],[2,7,12,17,22],[3,8,13,18,23],[4,9,14,19,24],[0,6,12,18,24],[4,8,12,16,20]];
        if (pattern === "Blackout") return [Array.from({length: 25}, (_, i) => i)];
        if (pattern === "Letter X") return [[0,4,6,8,12,16,18,20,24]];
        if (pattern === "Four Corners") return [[0,4,20,24]];
        if (pattern === "Letter T") return [[0,1,2,3,4,7,12,17,22]];
        if (pattern === "Letter L") return [[0,5,10,15,20,21,22,23,24]];
        if (pattern === "Letter C") return [[0,1,2,3,4,5,10,15,20,21,22,23,24]];
        if (pattern === "Plus Sign") return [[10,11,12,13,14,2,7,17,22]];
        if (pattern === "Diamond") return [[2,6,8,11,12,13,16,18,22]];
        if (pattern === "Letter Z") return [[0,1,2,3,4,8,12,16,20,21,22,23,24]];
        if (pattern === "Outside Border") return [[0,1,2,3,4,5,9,10,14,15,19,20,21,22,23,24]];
        if (pattern === "Double Bingo") return allLines; // special: need 2 complete lines
        return allLines; // Normal Bingo
    }
    function checkWin() {
        if(userData.hasWonCurrent || gameDrawn.length === 0) return;
        db.ref('gameState/latestWinner').once('value', snap => {
            if(snap.exists()) return;
            const winningWays = getWinningWays(currentPattern);
            if (currentPattern === "Double Bingo") {
                const completed = winningWays.filter(w => w.every(idx => marks.includes(idx)));
                if (completed.length >= 2) { const allCells = [...new Set(completed.slice(0,2).flat())]; highlightWinningPattern(allCells, 0); triggerWin('main'); }
                return;
            }
            for(let i = 0; i < winningWays.length; i++) {
                let w = winningWays[i];
                if(w.every(idx => marks.includes(idx))) { highlightWinningPattern(w, i); triggerWin('main'); break; }
            }
        });
    }
    function checkWinExtra() {
        if(userData.hasWonCurrent || gameDrawn.length === 0 || extraCards.length === 0) return;
        db.ref('gameState/latestWinner').once('value', snap => {
            if(snap.exists()) return;
            extraCards.forEach((ec, cardIdx) => {
                if(ec.won) return;
                const winningWays = getWinningWays(currentPattern);
                if (currentPattern === "Double Bingo") {
                    const completed = winningWays.filter(w => w.every(idx => ec.marks.includes(idx)));
                    if (completed.length >= 2) {
                        const allCells = [...new Set(completed.slice(0,2).flat())];
                        highlightWinningPatternExtra(cardIdx, allCells, 0);
                        ec.won = true; triggerWin('extra-' + cardIdx);
                    }
                    return;
                }
                for(let i = 0; i < winningWays.length; i++) {
                    let w = winningWays[i];
                    if(w.every(idx => ec.marks.includes(idx))) {
                        highlightWinningPatternExtra(cardIdx, w, i);
                        ec.won = true; triggerWin('extra-' + cardIdx); break;
                    }
                }
            });
        });
    }
    function checkPuroStatus() {
        if(userData.hasWonCurrent || gameDrawn.length === 0) return;
        document.getElementById('bingoCardContainer').classList.remove('card-puro');
        document.querySelectorAll('#bingoGrid .cell').forEach(c => c.classList.remove('cell-waiting'));
        const winningWays = getWinningWays(currentPattern);
        if (currentPattern === "Double Bingo") {
            const allLines = [[0,1,2,3,4],[5,6,7,8,9],[10,11,12,13,14],[15,16,17,18,19],[20,21,22,23,24],[0,5,10,15,20],[1,6,11,16,21],[2,7,12,17,22],[3,8,13,18,23],[4,9,14,19,24],[0,6,12,18,24],[4,8,12,16,20]];
            const completed = allLines.filter(w => w.every(idx => marks.includes(idx)));
            const almost = allLines.filter(w => { const missing = w.filter(idx => !marks.includes(idx)); return missing.length === 1; });
            if (completed.length >= 1 && almost.length >= 1) {
                document.getElementById('bingoCardContainer').classList.add('card-puro');
                const missingIdx = almost[0].find(idx => !marks.includes(idx));
                const cells = document.querySelectorAll('#bingoGrid .cell');
                if(cells[missingIdx]) cells[missingIdx].classList.add('cell-waiting');
            }
            return;
        }
        for (let i = 0; i < winningWays.length; i++) {
            let w = winningWays[i]; let missing = w.filter(idx => !marks.includes(idx));
            if (missing.length === 1) {
                document.getElementById('bingoCardContainer').classList.add('card-puro');
                const cells = document.querySelectorAll('#bingoGrid .cell');
                if(cells[missing[0]]) cells[missing[0]].classList.add('cell-waiting');
                break;
            }
        }
    }
    function highlightWinningPattern(indices, patternType) {
        const cells = document.querySelectorAll('#bingoGrid .cell');
        indices.forEach(idx => {
            const cell = cells[idx]; if(!cell) return;
            cell.classList.add('win-glow');
            if (currentPattern === 'Normal Bingo') {
                if (patternType < 5) cell.classList.add('win-line-h');
                else if (patternType < 10) cell.classList.add('win-line-v');
                else if (patternType === 10) cell.classList.add('win-line-d1');
                else cell.classList.add('win-line-d2');
            }
        });
    }
    function highlightWinningPatternExtra(cardIdx, indices, patternType) {
        const grid = document.getElementById('bingoGrid-extra-' + cardIdx);
        if(!grid) return;
        const cells = grid.querySelectorAll('.cell');
        indices.forEach(idx => {
            const cell = cells[idx]; if(!cell) return;
            cell.classList.add('win-glow');
            if (currentPattern === 'Normal Bingo') {
                if (patternType < 5) cell.classList.add('win-line-h');
                else if (patternType < 10) cell.classList.add('win-line-v');
                else if (patternType === 10) cell.classList.add('win-line-d1');
                else cell.classList.add('win-line-d2');
            }
        });
    }
    function triggerWin(cardId) {
        const uid = auth.currentUser.uid;
        let winPrize = 300;
        if (isJackpotActive) winPrize = currentJackpotAmount;
        // cardId: 'main' or 'extra-0', 'extra-1', etc.
        db.ref('gameState/latestWinner').set({ name: userData.name, uid: uid, prize: winPrize, winCard: cardId || 'main' });
        db.ref('users/' + uid + '/points').transaction(p => (p || 0) + winPrize);
        db.ref('users/' + uid + '/bingoWins').transaction(w => (w || 0) + 1);
        db.ref('users/' + uid).update({ hasWonCurrent: true });
        userData.hasWonCurrent = true;
        if (isJackpotActive) {
            const jpModal = document.getElementById('grandJackpotModal');
            document.getElementById('grandPrizeAmount').innerText = winPrize.toLocaleString() + " RB COINS";
            document.getElementById('jpWinnerName').innerText = userData.name;
            jpModal.style.display = 'flex';
            confetti({ particleCount: 500, spread: 120, startVelocity: 60 });
        }
    }
    function generateNewCard() {
        if(gameDrawn.length > 0) return showToast("Cannot change card while a game is in progress!");
        let card = []; let cols = [[1,15],[16,30],[31,45],[46,60],[61,75]];
        cols.forEach(r => { let nums = []; while(nums.length < 5) { let n = Math.floor(Math.random() * (r[1] - r[0] + 1)) + r[0]; if(!nums.includes(n)) nums.push(n); } card.push(...nums); });
        let finalCard = []; for(let r=0; r<5; r++) { for(let c=0; c<5; c++) { finalCard.push(card[c*5 + r]); } }
        finalCard[12] = "FREE";
        db.ref('users/' + auth.currentUser.uid).update({ currentCard: finalCard, cardTimestamp: Date.now(), hasWonCurrent: false });
        cardNumbers = finalCard; renderCard(); playSound('cardFlip');
    }
    function generateExtraCardNumbers() {
        let card = []; let cols = [[1,15],[16,30],[31,45],[46,60],[61,75]];
        cols.forEach(r => { let nums = []; while(nums.length < 5) { let n = Math.floor(Math.random() * (r[1] - r[0] + 1)) + r[0]; if(!nums.includes(n)) nums.push(n); } card.push(...nums); });
        let finalCard = []; for(let r=0; r<5; r++) { for(let c=0; c<5; c++) { finalCard.push(card[c*5 + r]); } }
        finalCard[12] = "FREE";
        return finalCard;
    }
    function renderCard() {
        const grid = document.getElementById('bingoGrid'); grid.innerHTML = "";
        cardNumbers.forEach((n, i) => {
            const div = document.createElement('div'); div.className = 'cell';
            div.innerText = n === "FREE" ? "\u2605" : n;
            if(n === "FREE") { div.classList.add('hit'); if(!marks.includes(12)) marks.push(12); }
            grid.appendChild(div);
        });
        updateGridHits(); applySkin(userData.equippedSkin || 'default');
    }
    function renderExtraCard(cardIdx) {
        const ec = extraCards[cardIdx]; if(!ec) return;
        const grid = document.getElementById('bingoGrid-extra-' + cardIdx); if(!grid) return;
        grid.innerHTML = "";
        ec.numbers.forEach((n, i) => {
            const div = document.createElement('div'); div.className = 'cell';
            div.innerText = n === "FREE" ? "\u2605" : n;
            if(n === "FREE") { div.classList.add('hit'); if(!ec.marks.includes(12)) ec.marks.push(12); }
            grid.appendChild(div);
        });
        updateGridHitsExtra(cardIdx);
        // Apply skin on extra cards
        const container = document.getElementById('bingoCard-extra-' + cardIdx);
        if(container && userData.equippedSkin) { container.className = 'card card-skin-' + userData.equippedSkin; }
    }
    function updateGridHits() {
        marks = [12];
        const cells = document.querySelectorAll('#bingoGrid .cell');
        cells.forEach((c, i) => { const val = c.innerText; if(gameDrawn.includes(val) || val === "\u2605") { c.classList.add('hit'); if(!marks.includes(i)) marks.push(i); } });
    }
    function updateGridHitsExtra(cardIdx) {
        const ec = extraCards[cardIdx]; if(!ec) return;
        ec.marks = [12];
        const grid = document.getElementById('bingoGrid-extra-' + cardIdx); if(!grid) return;
        const cells = grid.querySelectorAll('.cell');
        cells.forEach((c, i) => { const val = c.innerText; if(gameDrawn.includes(val) || val === "\u2605") { c.classList.add('hit'); if(!ec.marks.includes(i)) ec.marks.push(i); } });
    }
    function renderPrevBalls() {
        const row = document.getElementById('ballRow'); row.innerHTML = "";
        const last5 = gameDrawn.slice(-5).reverse();
        last5.forEach(n => { let d = document.createElement('div'); d.className = 'ball-small'; d.innerText = n; row.appendChild(d); });
    }
    function checkLateJoiner() {
        const overlay = document.getElementById('lateOverlay');
        if(gameDrawn.length > 0 && !userData.currentCard) { overlay.style.display = 'flex'; }
        else if (gameDrawn.length > 0 && userData.cardTimestamp > db.ref('gameState/gameStartTime')) { overlay.style.display = 'none'; }
        else { overlay.style.display = 'none'; }
    }
    // === BUY EXTRA CARD ===
    function buyExtraCard() {
        if(!rateLimit('buyCard', 3000)) return showToast('Sandali lang!');
        if (extraCards.length >= MAX_EXTRA_CARDS) return showToast("Maximum na! 5 cards lang ang allowed.");
        // Block buying only when game is ACTIVELY in progress (balls drawn but no winner yet)
        // Allow buying after game ends (winner declared) so users can prepare for next round
        if (gameDrawn.length > 0 && !document.getElementById('winnerBanner').style.display.includes('block')) {
            return showToast("Hindi mabibili ang extra card habang may laro!");
        }
        const cost = 100;
        const uid = auth.currentUser.uid;
        db.ref('users/' + uid + '/points').once('value', s => {
            const pts = s.val() || 0;
            if (pts < cost) return showToast("Hindi sapat ang RB Coins! Kailangan: 100 coins.");
            db.ref('users/' + uid + '/points').transaction(p => (p || 0) - cost);
            db.ref('pointLogs/' + uid).push({ type: 'extra_card', amount: -cost, timestamp: Date.now(), note: 'Bought Extra Bingo Card' });
            const newCard = generateExtraCardNumbers();
            const cardIdx = extraCards.length;
            extraCards.push({ numbers: newCard, marks: [12], won: false });
            // Save to Firebase so dashboard can see it
            db.ref('users/' + uid + '/extraCards/' + cardIdx).set(newCard);
            addExtraCardToDOM(cardIdx);
            renderExtraCard(cardIdx);
            updateBuyCardUI();
            showToast("Extra Card #" + (cardIdx + 2) + " na-unlock! Sana manalo ka!");
            confetti({ particleCount: 80, spread: 60, origin: { y: 0.7 } });
        });
    }
    function addExtraCardToDOM(cardIdx) {
        const grid = document.getElementById('bentoGrid');
        const buySlot = document.getElementById('bentoBuySlot');
        if(!grid || !buySlot) return;

        const cardNum = cardIdx + 2; // Card 2, 3, 4, 5
        const slot = document.createElement('div');
        slot.className = 'bento-slot';
        slot.id = 'bentoSlot' + (cardIdx + 1);
        slot.innerHTML =
            '<span class="card-num-badge extra">Card ' + cardNum + '</span>' +
            '<div class="card" id="bingoCard-extra-' + cardIdx + '">' +
                '<div id="gameOverOverlay-extra-' + cardIdx + '" class="game-over-overlay" style="display:none;">' +
                    '<i data-lucide="trophy" style="color:var(--gold); width:50px; height:50px; margin-bottom:var(--spacing-md);"></i>' +
                    '<div class="late-text">Game Finished</div>' +
                    '<div class="late-subtext">Better luck next time!</div>' +
                '</div>' +
                '<div class="change-card-wrapper" style="display:flex; justify-content:space-between; align-items:center; padding-bottom:15px;">' +
                    '<div class="pattern-box"><div class="pattern-dot"></div><span class="pattern-text">Normal Bingo</span></div>' +
                    '<button class="btn-change" onclick="regenExtraCard(' + cardIdx + ')"><i data-lucide="refresh-cw" style="width:14px"></i> NEW CARD</button>' +
                '</div>' +
                '<div class="bingo-header"><div class="letter">B</div><div class="letter">I</div><div class="letter">N</div><div class="letter">G</div><div class="letter">O</div></div>' +
                '<div class="grid" id="bingoGrid-extra-' + cardIdx + '"></div>' +
            '</div>';

        // Insert before the buy slot
        grid.insertBefore(slot, buySlot);
        lucide.createIcons();
        updateBentoLayout();
    }
    function updateBentoLayout() {
        const grid = document.getElementById('bentoGrid');
        if(!grid) return;
        const totalCards = 1 + extraCards.length; // main + extras
        // Remove old class
        grid.className = 'bento-grid';
        if(totalCards > 1) grid.classList.add('cards-' + totalCards);
    }
    function updateBuyCardUI() {
        const btn = document.getElementById('buyExtraCardBtn');
        const countEl = document.getElementById('extraCardCount');
        const total = extraCards.length;
        if(countEl) countEl.innerText = total + ' extra card' + (total !== 1 ? 's' : '') + ' (' + (total + 1) + '/5 total)';
        if(total >= MAX_EXTRA_CARDS) {
            if(btn) { btn.disabled = true; btn.innerHTML = '<div class="buy-icon">&#10003;</div><div class="buy-label">MAX CARDS NA!<br>5/5 cards</div>'; }
        } else {
            if(btn) { btn.disabled = false; btn.innerHTML = '<div class="buy-icon">&#10133;</div><div class="buy-label">DAGDAG CARD</div><div class="buy-cost">100 RB Coins &bull; Max 5</div><div id="extraCardCount" style="font-size:10px; margin-top:1px; opacity:0.6;">' + total + ' extra card' + (total !== 1 ? 's' : '') + ' (' + (total + 1) + '/5 total)</div>'; }
        }
    }
    function regenExtraCard(cardIdx) {
        if(gameDrawn.length > 0) return showToast("Cannot change card while a game is in progress!");
        const newCard = generateExtraCardNumbers();
        extraCards[cardIdx].numbers = newCard;
        extraCards[cardIdx].marks = [12];
        extraCards[cardIdx].won = false;
        // Sync to Firebase
        db.ref('users/' + auth.currentUser.uid + '/extraCards/' + cardIdx).set(newCard);
        renderExtraCard(cardIdx);
        playSound('cardFlip');
    }
    function removeAllExtraCardsFromDOM() {
        // Remove all extra card slots from DOM
        extraCards.forEach((ec, cardIdx) => {
            const slot = document.getElementById('bentoSlot' + (cardIdx + 1));
            if(slot) slot.remove();
        });
        extraCards = [];
        updateBentoLayout();
        // Reset buy button to initial state
        const btn = document.getElementById('buyExtraCardBtn');
        if(btn) {
            btn.disabled = false;
            btn.innerHTML = '<div class="buy-icon">&#10133;</div><div class="buy-label">DAGDAG CARD</div><div class="buy-cost">100 RB Coins &bull; Max 5</div><div id="extraCardCount" style="font-size:10px; margin-top:1px; opacity:0.6;">0 extra cards</div>';
        }
        // Clear from Firebase
        if(auth && auth.currentUser) {
            db.ref('users/' + auth.currentUser.uid + '/extraCards').remove();
        }
    }
    function resetAllExtraCardMarks() {
        // Clear all extra card marks and win states
        extraCards.forEach((ec, cardIdx) => {
            ec.marks = [12]; ec.won = false;
            const grid = document.getElementById('bingoGrid-extra-' + cardIdx); if(!grid) return;
            const cells = grid.querySelectorAll('.cell');
            cells.forEach(c => c.classList.remove('hit', 'win-glow', 'win-line-h', 'win-line-v', 'win-line-d1', 'win-line-d2', 'cell-waiting'));
            const FREE = cells[12]; if(FREE) { FREE.classList.add('hit'); }
            const container = document.getElementById('bingoCard-extra-' + cardIdx);
            if(container) { container.classList.remove('card-win', 'card-lost', 'card-puro'); }
            const overlay = document.getElementById('gameOverOverlay-extra-' + cardIdx);
            if(overlay) overlay.style.display = 'none';
        });
    }

    let chatUnreadCount = 0;
    let chatDrawerOpen = false;

    function openChatDrawer() {
        chatDrawerOpen = true;
        chatUnreadCount = 0;
        const badge = document.getElementById('chatBubbleBadge');
        if(badge) { badge.textContent = '0'; badge.classList.remove('show'); }
        document.getElementById('chatDrawerBackdrop').classList.add('open');
        document.getElementById('chatDrawer').classList.add('open');
        lucide.createIcons();
        setTimeout(() => {
            const list = document.getElementById('chatList');
            if(list) list.scrollTop = list.scrollHeight;
        }, 100);
    }

    function closeChatDrawer() {
        chatDrawerOpen = false;
        document.getElementById('chatDrawerBackdrop').classList.remove('open');
        document.getElementById('chatDrawer').classList.remove('open');
    }

    function setupChat() {
        const list = document.getElementById('chatList');
        let isFirst = true;
        db.ref('chats').limitToLast(50).on('child_added', s => {
            const d = s.val(); const key = s.key; if(isUserMuted(d.uid)) return;
            const isMe = d.uid === auth.currentUser.uid;
            const div = document.createElement('div'); div.className = 'chat-row'; div.style.flexDirection = isMe ? 'row-reverse' : 'row';
            let replyHtml = ''; if(d.replyTo && d.replyMsg) { replyHtml = `<div style="font-size:10px; opacity:0.7; border-left:2px solid var(--accent); padding-left:5px; margin-bottom:5px; background:rgba(0,0,0,0.2); padding:4px; border-radius:4px;">Replying to: ${d.replyMsg.substring(0, 30)}...</div>`; }
            div.innerHTML = `<img class="chat-pfp" src="${d.pfp}" onclick="showUserOptions('${d.uid}', '${d.name.replace(/'/g, "\\'")}', '${d.pfp}')"><div class="chat-content"><div class="bubble">${!isMe ? `<div class="chat-name" onclick="replyTo('${key}', '${d.msg.replace(/'/g, "\\'")}')">${d.name}</div>` : ''}${replyHtml}<div class="chat-text">${d.msg}</div></div></div>`;
            list.appendChild(div); list.scrollTop = list.scrollHeight; lucide.createIcons();
            if (!isFirst && !chatDrawerOpen && !isMe) {
                chatUnreadCount++;
                const badge = document.getElementById('chatBubbleBadge');
                if(badge) { badge.textContent = chatUnreadCount > 9 ? '9+' : chatUnreadCount; badge.classList.add('show'); }
            }
            isFirst = false;
        });
    }

        function isUserMuted(uid) { const muted = localStorage.getItem('muted_users'); if(!muted) return false; return JSON.parse(muted).includes(uid); }
    function muteUser(uid) { let muted = JSON.parse(localStorage.getItem('muted_users') || "[]"); if(!muted.includes(uid)) { muted.push(uid); localStorage.setItem('muted_users', JSON.stringify(muted)); showToast("User muted locally."); } }
    function sendChat() { if(!rateLimit('chat', 1500)) return showToast('Sandali lang! Huwag mag-spam.'); const inp = document.getElementById('chatIn'); const msg = sanitizeInput(inp.value.trim(), 300); if(!msg) return; const payload = { name: sanitizeInput(userData.name, 50), msg: msg, pfp: userData.photo, uid: userData.uid, time: Date.now() }; if(selectedReplyId) { payload.replyTo = selectedReplyId; payload.replyMsg = document.getElementById('replyText').innerText.replace("Replying to: ", ""); cancelReply(); } db.ref('chats').push(payload); inp.value = ""; }
    function replyTo(key, msg) { selectedReplyId = key; document.getElementById('replyText').innerText = "Replying to: " + msg.substring(0, 20) + "..."; document.getElementById('replyIndicator').style.display = 'flex'; document.getElementById('chatIn').focus(); }
    function cancelReply() { selectedReplyId = null; document.getElementById('replyIndicator').style.display = 'none'; }

    let currentChatPartner = null;
    let isGroupChat = false;

    function openMessenger() { document.getElementById('pmModal').style.display = 'flex'; document.getElementById('pmInboxView').style.display = 'flex'; document.getElementById('pmChatView').style.display = 'none'; loadInbox(); }
    function loadInbox() { 
        const uid = auth.currentUser.uid; 
        const list = document.getElementById('pmList'); 
        list.innerHTML = `
            <div class="pm-skeleton"><div class="pm-skel-avatar"></div><div class="pm-skel-info"><div class="pm-skel-line"></div><div class="pm-skel-line"></div></div></div>
            <div class="pm-skeleton"><div class="pm-skel-avatar"></div><div class="pm-skel-info"><div class="pm-skel-line"></div><div class="pm-skel-line"></div></div></div>
            <div class="pm-skeleton"><div class="pm-skel-avatar"></div><div class="pm-skel-info"><div class="pm-skel-line"></div><div class="pm-skel-line"></div></div></div>
        `;

        // Timeout fallback  if Firebase is slow, show empty state after 8s
        const loadTimeout = setTimeout(() => {
            if (list.querySelector('.pm-skeleton')) {
                list.innerHTML = `<div class="pm-empty-state"><div class="pm-empty-icon"></div><div style="font-weight:700;color:rgba(255,255,255,.6);font-size:16px;">No conversations yet</div><div>Start chatting with a friend!</div></div>`;
            }
        }, 8000);
        
        renderActiveFriends();

        // Load Groups first, then PMs  use limitToLast to avoid reading entire messages node
        db.ref('groupMembers/' + uid).once('value', gSnap => {
            const myGroups = gSnap.exists() ? Object.keys(gSnap.val()) : [];
            
            // Query only messages involving current user  limit to recent 300 to avoid huge reads
            const msgRef = db.ref('messages').orderByChild('from').equalTo(uid).limitToLast(150);
            const msgRef2 = db.ref('messages').orderByChild('to').equalTo(uid).limitToLast(150);

            const conversations = {};
            let queriesDone = 0;

            function processMsgSnap(s) {
                s.forEach(msgSnap => {
                    const m = msgSnap.val();
                    const partner = m.from === uid ? m.to : m.from;
                    if (!partner) return;
                    if (!conversations[partner] || m.timestamp > (conversations[partner].timestamp || 0)) {
                        conversations[partner] = m;
                    }
                });
                queriesDone++;
                if (queriesDone === 2) afterMsgsLoaded();
            }

            msgRef.once('value', processMsgSnap, () => { queriesDone++; if(queriesDone===2) afterMsgsLoaded(); });
            msgRef2.once('value', processMsgSnap, () => { queriesDone++; if(queriesDone===2) afterMsgsLoaded(); });

            function afterMsgsLoaded() {
                clearTimeout(loadTimeout);
                list.innerHTML = ""; 
                
                // Render Groups First
                myGroups.forEach(groupId => {
                    db.ref('groups/' + groupId).once('value', groupSnap => {
                        const grp = groupSnap.val();
                        if(!grp) return;
                        const div = document.createElement('div');
                        div.className = 'pm-item';
                        div.onclick = () => openGroupChat(groupId, grp.name);
                        div.innerHTML = `
                            <div style="width:56px;height:56px;border-radius:50%;background:linear-gradient(135deg,#1e293b,#0f172a);display:flex;align-items:center;justify-content:center;color:#60a5fa;border:1.5px solid rgba(255,255,255,0.1);flex-shrink:0;">
                                <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>
                            </div>
                            <div class="pm-info"><span class="pm-name">${escapeHtml(grp.name)}</span><span class="pm-preview">Group Chat</span></div>
                        `;
                        list.appendChild(div);
                    });
                });

                if(Object.keys(conversations).length === 0 && myGroups.length === 0) { 
                    list.innerHTML = `<div class="pm-empty-state"><div class="pm-empty-icon"></div><div style="font-weight:700;color:rgba(255,255,255,.6);font-size:16px;">No conversations yet</div><div>Start chatting with a friend!</div></div>`; 
                    return; 
                } 
                
                // Collect all conversation data with status
                const conversationDataList = [];
                const partnerIds = Object.keys(conversations);
                let processed = 0;
                
                if (partnerIds.length === 0) return;

                partnerIds.forEach(partnerId => { 
                    db.ref('users/' + partnerId).once('value', uSnap => { 
                        const u = uSnap.val() || { name: 'Unknown', photo: '' }; 
                        const lastMsg = conversations[partnerId]; 
                        
                        // Check online status
                        db.ref('status/' + partnerId).once('value', statusSnap => {
                            const status = statusSnap.val();
                            const isOnline = status && status.state === 'online';
                            const lastSeenText = !isOnline && status && status.last_seen 
                                ? formatLastSeen(status.last_seen) 
                                : '';
                            
                            conversationDataList.push({
                                partnerId,
                                userData: u,
                                lastMsg,
                                isOnline,
                                lastSeenText,
                                timestamp: lastMsg.timestamp || status?.last_seen || 0
                            });
                            
                            processed++;
                            
                            // When all conversations are loaded, sort and render
                            if(processed === partnerIds.length) {
                                // Sort: Active users first, then by message timestamp
                                conversationDataList.sort((a, b) => {
                                    if(a.isOnline && !b.isOnline) return -1;
                                    if(!a.isOnline && b.isOnline) return 1;
                                    return b.timestamp - a.timestamp;
                                });
                                
                                // Render sorted conversations
                                conversationDataList.forEach(data => {
                                    const div = document.createElement('div'); 
                                    div.className = 'pm-item'; 
                                    div.onclick = () => openPrivateChat(data.partnerId, data.userData.name, data.userData.photo); 
                                    const previewText = data.lastMsg.image ? 'Sent a photo' : data.lastMsg.text;
                                    
                                    // Check if user is verified
                                    const isVerified = data.userData.verified === true;
                                    const verifiedBadgeHTML = isVerified ? `<span class="verified-badge inline-badge" onmouseenter="showVerificationTooltip(event)" onmouseleave="hideVerificationTooltip()"><i data-lucide="check" style="width:10px; height:10px; color:white;"></i></span>` : '';
                                    
                                    // Add online indicator wrapper to avatar
                                    const onlineDot = data.isOnline ? '<div class="online-indicator is-online"></div>' : '';
                                    const statusInfo = data.isOnline ? '<span style="color: #22c55e; font-size: 12px; font-weight: 500;">Active now</span>' : 
                                                       (data.lastSeenText ? `<span style="color: rgba(255,255,255,0.4); font-size: 11px;">Active ${data.lastSeenText}</span>` : '');
                                    
                                    div.innerHTML = `
                                        <div class="avatar-frame" data-uid="${data.partnerId}" style="position: relative; flex-shrink: 0;">
                                            <img class="pm-avatar" src="${data.userData.photo || 'https://via.placeholder.com/40'}">
                                            ${onlineDot}
                                        </div>
                                        <div class="pm-info">
                                            <div style="display: flex; align-items: center; gap: 6px;">
                                                <span class="pm-name">${data.userData.name}${verifiedBadgeHTML}</span>
                                            </div>
                                            <span class="pm-preview">${data.lastMsg.from === uid ? 'You: ' : ''}${previewText}</span>
                                            ${statusInfo}
                                        </div>
                                    `; 
                                    list.appendChild(div); 
                                });
                            }
                        });
                    }); 
                }); 
            }
        });
    }
    
    function deleteConversation() {
        if(!currentChatPartner) return;
        
        const confirmMsg = isGroupChat ? "Delete this group chat? This will remove you from the group." : "Delete this conversation? All messages will be removed.";
        
        if(!confirm(confirmMsg)) return;
        
        const myUid = auth.currentUser.uid;
        
        if(isGroupChat) {
            // Remove user from group
            db.ref('groups/' + currentChatPartner + '/members/' + myUid).remove();
            db.ref('groupMembers/' + myUid + '/' + currentChatPartner).remove();
            showToast("Left group chat");
        } else {
            // Delete all messages between users
            db.ref('messages').once('value', s => {
                const updates = {};
                s.forEach(msgSnap => {
                    const m = msgSnap.val();
                    if((m.from === myUid && m.to === currentChatPartner) || (m.from === currentChatPartner && m.to === myUid)) {
                        updates['messages/' + msgSnap.key] = null;
                    }
                });
                db.ref().update(updates);
                showToast("Conversation deleted");
            });
        }
        
        backToInbox();
    }
    
    function renderActiveFriends() {
        const bar = document.getElementById('pmActiveFriendsBar');
        bar.innerHTML = '';
        
        if(!auth.currentUser) return;
        
        db.ref('friends/' + auth.currentUser.uid).once('value', s => {
            if(!s.exists()) return;
            
            const friendsList = [];
            s.forEach(f => friendsList.push(f.key));
            
            // Check each friend's online status
            friendsList.forEach(friendId => {
                db.ref('status/' + friendId).on('value', statusSnap => {
                    const status = statusSnap.val();
                    
                    // Only show if truly online
                    if(status && status.state === 'online') {
                        db.ref('users/' + friendId).once('value', uSnap => {
                            const u = uSnap.val();
                            if(!u) return;
                            
                            // Remove existing item if present
                            const existingItem = bar.querySelector(`[data-friend-id="${friendId}"]`);
                            if(existingItem) existingItem.remove();
                            
                            const item = document.createElement('div');
                            item.className = 'active-friend-item';
                            item.dataset.friendId = friendId;
                            item.onclick = () => openPrivateChat(friendId, u.name, u.photo); 
                            item.innerHTML = `
                                <div class="active-img-wrap">
                                    <img src="${u.photo}" class="active-img">
                                    <div class="online-dot-large"></div>
                                </div>
                                <div class="active-name">${u.name.split(' ')[0]}</div>
                            `;
                            bar.appendChild(item);
                        });
                    } else {
                        // Remove from active bar if user went offline
                        const existingItem = bar.querySelector(`[data-friend-id="${friendId}"]`);
                        if(existingItem) existingItem.remove();
                    }
                });
            });
        });
    }

    // === GROUP CHAT LOGIC ===
    function startCreateGroup() {
        document.getElementById('pmInboxView').style.display = 'none';
        document.getElementById('pmCreateGroupView').style.display = 'flex';
        const container = document.getElementById('friendSelectContainer');
        container.innerHTML = "Loading friends...";
        
        db.ref('friends/' + auth.currentUser.uid).once('value', s => {
            container.innerHTML = "";
            if(!s.exists()) { container.innerHTML = "No friends found."; return; }
            s.forEach(f => {
                 db.ref('users/' + f.key).once('value', uSnap => {
                     const u = uSnap.val();
                     const div = document.createElement('div');
                     div.className = 'friend-select-item';
                     div.onclick = () => { div.classList.toggle('selected'); };
                     div.dataset.uid = f.key;
                     div.innerHTML = `
                        <div style="display:flex; align-items:center; gap: var(--spacing-sm);">
                            <img src="${u.photo}" style="width:40px; height:40px; border-radius:50%;">
                            <span>${u.name}</span>
                        </div>
                        <div class="checkbox-circle"><i data-lucide="check" style="width:12px;"></i></div>
                     `;
                     container.appendChild(div);
                     lucide.createIcons();
                 });
            });
        });
    }

    function cancelCreateGroup() {
        document.getElementById('pmCreateGroupView').style.display = 'none';
        document.getElementById('pmInboxView').style.display = 'flex';
    }

    function finalizeCreateGroup() {
        const name = document.getElementById('newGroupName').value.trim();
        if(!name) return showToast("Enter Group Name");
        
        const selected = document.querySelectorAll('.friend-select-item.selected');
        if(selected.length === 0) return showToast("Select at least 1 friend");
        
        const members = { [auth.currentUser.uid]: true };
        selected.forEach(el => members[el.dataset.uid] = true);
        
        const groupRef = db.ref('groups').push();
        groupRef.set({
            name: name,
            createdBy: auth.currentUser.uid,
            members: members
        }).then(() => {
            // Index for each member
            Object.keys(members).forEach(uid => {
                db.ref('groupMembers/' + uid + '/' + groupRef.key).set(true);
            });
            showToast("Group Created!");
            cancelCreateGroup();
            loadInbox();
        });
    }

    function openGroupChat(groupId, groupName) {
        currentChatPartner = groupId;
        isGroupChat = true;
        document.getElementById('pmInboxView').style.display = 'none'; 
        document.getElementById('pmChatView').style.display = 'flex'; 
        document.getElementById('chatTargetName').innerText = groupName; 
        document.getElementById('chatTargetStatus').innerText = "Group Chat";
        document.getElementById('chatTargetAvatarCont').innerHTML = `<div style="width:100%; height:100%; border-radius:50%; background:#334155; display:flex; align-items:center; justify-content:center;"><i data-lucide="users"></i></div>`;
        lucide.createIcons();
        
        listenGroupMessages(groupId);
    }
    
    function listenGroupMessages(groupId) {
        const chatDiv = document.getElementById('pmMessages'); 
        chatDiv.innerHTML = "";
        if(pmListenerRef) db.ref('groupMessages').off(); // Clear old listener location logic if slightly diff

        const gRef = db.ref('groupMessages/' + groupId).limitToLast(100);
        gRef.on('child_added', s => {
             const m = s.val();
             const div = document.createElement('div'); 
             div.className = `msg-bubble ${m.from === auth.currentUser.uid ? 'msg-me' : 'msg-them'}`;
             let contentHtml = '';

             if(m.isSticker) {
                 div.classList.add('msg-sticker');
                 contentHtml = `<span style="font-size:48px;line-height:1;">${m.text || ''}</span>`;
             } else if(m.isVoice && m.audio) {
                 contentHtml = `<audio controls src="${m.audio}" style="max-width:200px;height:36px;border-radius:20px;outline:none;"></audio>`;
             } else {
                 contentHtml = m.text ? escapeHtml(m.text) : '';
                 if(m.image) contentHtml += `<br><img src="${m.image}" class="msg-image-preview">`;
             }
             
             // Show sender name in group for others' messages
             if(m.from !== auth.currentUser.uid) {
                 contentHtml = `<span style="font-size:9px;color:#94a3b8;display:block;margin-bottom:2px;">${escapeHtml(m.senderName || 'User')}</span>` + contentHtml;
             }

             div.innerHTML = contentHtml;
             chatDiv.appendChild(div); 
             chatDiv.scrollTop = chatDiv.scrollHeight; 
        });
        pmListenerRef = gRef; // Hacky reference store
    }

    function openPrivateChat(uid, name, photo) { 
        if(uid === auth.currentUser.uid) return showToast("Cant msg self"); 
        currentChatPartner = uid; 
        isGroupChat = false;
        document.getElementById('pmModal').style.display = 'flex'; 
        document.getElementById('pmInboxView').style.display = 'none'; 
        document.getElementById('pmChatView').style.display = 'flex'; 
        document.getElementById('chatTargetName').innerText = name; 
        
        // Real-time status monitoring
        const statusRef = db.ref('status/' + uid);
        statusRef.on('value', statusSnap => {
            const status = statusSnap.val();
            const statusElement = document.getElementById('chatTargetStatus');
            
            if(status && status.state === 'online') {
                statusElement.innerText = "Active now";
                statusElement.style.color = "#22c55e";
            } else if(status && status.last_seen) {
                const lastSeenText = formatLastSeen(status.last_seen);
                statusElement.innerText = `Active ${lastSeenText}`;
                statusElement.style.color = "rgba(255,255,255,0.5)";
            } else {
                statusElement.innerText = "Offline";
                statusElement.style.color = "rgba(255,255,255,0.4)";
            }
        });
        
        document.getElementById('chatTargetAvatarCont').innerHTML = `<img src="${photo}" style="width:100%; height:100%; border-radius:50%; object-fit:cover;">`;
        
        db.ref('notifications/' + auth.currentUser.uid).once('value', s => {
            s.forEach(n => {
                if(n.val().type === 'pm' && n.val().from === uid) {
                    db.ref('notifications/' + auth.currentUser.uid + '/' + n.key).remove();
                }
            });
        });

        listenPrivateMessages(auth.currentUser.uid); 
    }
    
    function backToInbox() { 
        // Clean up status listener
        if(currentChatPartner) {
            db.ref('status/' + currentChatPartner).off();
        }
        
        currentChatPartner = null; 
        isGroupChat = false;
        document.getElementById('pmChatView').style.display = 'none'; 
        document.getElementById('pmInboxView').style.display = 'flex'; 
        if(pmListenerRef) pmListenerRef.off();
        loadInbox(); 
    }
    
    let pmImageBase64 = null;
    function handlePmImage(input) {
        if(input.files && input.files[0]) {
            compressImage(input.files[0], 500, 0.7).then(base64 => {
                pmImageBase64 = base64;
                window.pmImageBase64 = base64;
                const strip = document.getElementById('pmImgStrip2');
                const thumb = document.getElementById('pmImgThumb2');
                if(thumb) thumb.src = base64;
                if(strip) strip.classList.add('on');
            });
        }
    }

    function sendPrivateMessage() { 
        const inp = document.getElementById('pmInput'); 
        const text = inp.value.trim();
        const imageData = pmImageBase64 || window.pmImageBase64 || null;
        if((!text && !imageData) || !currentChatPartner) return; 
        const myUid = auth.currentUser.uid; 
        
        if(isGroupChat) {
            const msgData = { from: myUid, senderName: userData.name, text: text, image: imageData, timestamp: Date.now() };
            db.ref('groupMessages/' + currentChatPartner).push(msgData);
        } else {
            const msgData = { from: myUid, to: currentChatPartner, text: text, image: imageData, timestamp: Date.now() }; 
            db.ref('messages').push(msgData); 
            const notifMsg = imageData ? 'Sent a photo' : `New PM from ${userData.name}`;
            db.ref('notifications/' + currentChatPartner).push({ msg: notifMsg, time: Date.now(), type: 'pm', from: myUid }); 
        }

        inp.value = ''; 
        pmImageBase64 = null;
        window.pmImageBase64 = null;
        document.getElementById('pmImgInput').value = '';
        const strip = document.getElementById('pmImgStrip2');
        if(strip) strip.classList.remove('on');
    }
    
    let pmListenerRef = null;
    let isInitialLoad = true;
    function listenPrivateMessages(myUid) { 
        const chatDiv = document.getElementById('pmMessages'); 
        chatDiv.innerHTML = "";
        if(pmListenerRef) { pmListenerRef.off(); pmListenerRef = null; }
        isInitialLoad = true;

        pmListenerRef = db.ref('messages').limitToLast(100);
        pmListenerRef.on('child_added', s => { 
            const m = s.val(); 
            const key = s.key;
            
            // Play sound for new incoming messages when not in initial load
            if(!isInitialLoad && m.to === myUid && (m.timestamp > (Date.now() - 2000))) {
                playSound('pop');
                
                // Show toast notification if PM modal is closed or chat is with different user
                const pmModal = document.getElementById('pmModal');
                const isPMModalClosed = pmModal.style.display === 'none' || !pmModal.style.display;
                const isDifferentChat = currentChatPartner !== m.from;
                
                if(isPMModalClosed || isDifferentChat) {
                    // Get sender name
                    db.ref('users/' + m.from).once('value', uSnap => {
                        const sender = uSnap.val();
                        if(sender) {
                            const msgText = m.isSticker ? '(Sticker)' : m.isVoice ? '(Voice note)' : m.image ? '(Photo)' : (m.text || '');
                            const messagePreview = msgText.length > 30 ? msgText.substring(0, 30) + '...' : msgText;
                            const sanitizedName = escapeHtml(sender.name);
                            const sanitizedPreview = escapeHtml(messagePreview);
                            showToast(`${sanitizedName}: ${sanitizedPreview}`);
                        }
                    });
                }
            }

            if(!currentChatPartner) return; 
            if( (m.from === myUid && m.to === currentChatPartner) || (m.from === currentChatPartner && m.to === myUid) ) { 
                const div = document.createElement('div'); 
                div.className = `msg-bubble ${m.from === myUid ? 'msg-me' : 'msg-them'}`; 
                
                let contentHtml = '';

                if(m.isSticker) {
                    // Sticker  render large emoji
                    div.classList.add('msg-sticker');
                    contentHtml = `<span style="font-size:48px;line-height:1;">${m.text || ''}</span>`;
                } else if(m.isVoice && m.audio) {
                    // Voice note  render audio player
                    contentHtml = `<audio controls src="${m.audio}" style="max-width:200px;height:36px;border-radius:20px;outline:none;"></audio>`;
                } else {
                    contentHtml = m.text ? escapeHtml(m.text) : '';
                    if(m.image) {
                        contentHtml += `<br><img src="${m.image}" class="msg-image-preview" onclick="openFullscreenPhoto('${m.image}')">`;
                    }
                }
                
                // Heart reaction
                let heartHtml = '';
                if(m.hearted) {
                    heartHtml = `<div class="msg-heart-reaction"><i data-lucide="heart" style="width:12px;height:12px;color:#ef4444;"></i></div>`;
                }

                div.innerHTML = `${contentHtml}${heartHtml}`; 
                lucide.createIcons({ el: div });
                
                // Double-tap to heart
                div.ondblclick = () => {
                    if(!m.hearted) {
                        db.ref('messages/' + key).update({ hearted: true });
                        showToast(' Message hearted');
                    }
                };

                chatDiv.appendChild(div); 
                chatDiv.scrollTop = chatDiv.scrollHeight; 
            } 
        }); 
        
        // Listen for changes (hearts)
        pmListenerRef.on('child_changed', s => {
             // In real app, find specific bubble and update. Here we just re-render or let it slide for simplicity in one-file
        });

        setTimeout(() => { isInitialLoad = false; }, 1500);
    }

    function deductPoints(amt) { db.ref('users/' + userData.uid + '/points').transaction(p => (p || 0) - amt); spawnLossAnimation(amt); }
    function addPoints(amt) { db.ref('users/' + userData.uid + '/points').transaction(p => (p || 0) + amt); }

    function verifyAdMath() { const ans = document.getElementById('mathAns').value; const corr = document.getElementById('mathQ').dataset.ans; if(ans === corr) { document.getElementById('adCaptchaOverlay').style.display = 'none'; addPoints(30); showToast("Reward: +30 Coins Added!"); } else { showToast("Wrong Answer!"); } }
    
    function spawnFlyingCoins(amount) { const count = Math.min(amount, 15); const targetEl = document.querySelector('.points-badge') || document.querySelector('.game-balance-pill'); if(!targetEl) return; const rect = targetEl.getBoundingClientRect(); const targetX = rect.left + (rect.width / 2); const targetY = rect.top + (rect.height / 2); const startX = window.innerWidth / 2; const startY = window.innerHeight / 2; for(let i=0; i<count; i++) { setTimeout(() => { const coin = document.createElement('div'); coin.className = 'flying-coin'; coin.style.left = startX + 'px'; coin.style.top = startY + 'px'; document.body.appendChild(coin); const spread = 80; const randX = (Math.random() - 0.5) * spread; const randY = (Math.random() - 0.5) * spread; requestAnimationFrame(() => { coin.style.transition = 'transform 0.3s ease-out'; coin.style.transform = `translate(${randX}px, ${randY}px) scale(1.2)`; setTimeout(() => { coin.style.transition = 'transform 0.6s cubic-bezier(0.2, 0.8, 0.2, 1), opacity 0.6s'; const moveX = targetX - startX; const moveY = targetY - startY; coin.style.transform = `translate(${moveX}px, ${moveY}px) scale(0.5)`; coin.style.opacity = '0'; }, 300); setTimeout(() => coin.remove(), 900); }); }, i * 30); } }
    function triggerScreenShake() { const activeGame = document.querySelector('.game-overlay-fs[style*="flex"]'); const target = activeGame ? activeGame.querySelector('.roulette-table, .slot-machine-frame, .hl-table, .color-table, .l9-table, .dice-table') : document.getElementById('bingoCardContainer'); if (target) { target.classList.add('shake-effect'); setTimeout(() => target.classList.remove('shake-effect'), 300); } if (navigator.vibrate) navigator.vibrate([30, 30, 30]); }
    function spawnLossAnimation(amount) { const activeGame = document.querySelector('.game-overlay-fs[style*="flex"]'); let startX, startY; if(activeGame) { startX = window.innerWidth / 2; startY = window.innerHeight / 2; } else { const badge = document.querySelector('.points-badge'); if(badge) { const rect = badge.getBoundingClientRect(); startX = rect.left + 20; startY = rect.top + 40; } else { startX = window.innerWidth / 2; startY = window.innerHeight / 2; } } const el = document.createElement('div'); el.className = 'float-loss'; el.innerText = "-" + amount; el.style.left = startX + 'px'; el.style.top = startY + 'px'; document.body.appendChild(el); setTimeout(() => el.remove(), 1000); }

    function openMenuModal() { document.getElementById('menuModal').style.display='flex'; }
    function saveGcash() { const num = document.getElementById('gcashInput').value; if(num.length > 3) { db.ref('users/'+auth.currentUser.uid).update({ gcash: num }); showToast("Info Saved!"); } else showToast("Invalid Details"); }
    function redeemItem(name, cost) { if(!rateLimit('redeem', 10000)) return showToast('Sandali lang! Huwag mag-spam ng redeem.'); const safeName = sanitizeInput(name, 100); const safeCost = parseInt(cost); if(!safeName || isNaN(safeCost) || safeCost <= 0 || safeCost > 500000) return showToast('Invalid redemption.'); if(userData.points >= safeCost) { if(!userData.gcash) return showToast("Save redemption info first!"); showCustomConfirm("REDEEM REWARD?", "Exchange " + safeCost + " RB Coins for " + safeName + "?", () => { deductPoints(safeCost); db.ref('redemptions').push({ uid: userData.uid, name: sanitizeInput(userData.name, 50), gcash: sanitizeInput(userData.gcash, 50), item: safeName, cost: safeCost, status: 'pending', timestamp: Date.now() }); showToast("Request Sent!"); loadHistory(); }); } else { showToast("Insufficient RB Coins"); } }
    function loadHistory() { const list = document.getElementById('historyList'); db.ref('redemptions').orderByChild('uid').equalTo(auth.currentUser.uid).once('value', s => { list.innerHTML = ""; s.forEach(r => { const d = r.val(); let color = '#fbbf24'; if(d.status === 'sent') color = '#10b981'; if(d.status === 'denied') color = '#ef4444'; list.innerHTML += `<div class="history-item"><div><div style="font-weight:700; font-size:12px;">${d.item}</div><div style="font-size:10px; opacity:0.6;">${fixDate(d.timestamp)}</div></div><div style="font-size:10px; font-weight:800; color:${color}; text-transform:uppercase; border:1px solid ${color}; padding:2px 6px; border-radius:4px;">${d.status}</div></div>`; }); }); }

    // === SUPPORT CONTACT FUNCTIONS ===
    function openSupportModal() {
        document.getElementById('menuModal').style.display = 'none';
        document.getElementById('supportModal').style.display = 'flex';
        loadMyTickets(); // Load user's tickets when opening modal
        setTimeout(() => lucide.createIcons(), 50);
    }

    function submitSupportRequest() {
        const subject = document.getElementById('supportSubject').value.trim();
        const message = document.getElementById('supportMessage').value.trim();
        
        if(!subject || !message) {
            showToast("Please fill in all fields");
            return;
        }
        
        if(message.length < 10) {
            showToast("Message too short. Please provide more details.");
            return;
        }
        
        // Save to Firebase
        db.ref('supportMessages').push({
            uid: auth.currentUser.uid,
            userName: userData.name,
            userEmail: userData.gcash || 'Not provided',
            userPhoto: userData.photo,
            subject: subject,
            message: message,
            timestamp: Date.now(),
            status: 'open'
        });
        
        showToast("Message sent! We'll respond soon.");
        playSound('pop');
        
        // Clear form and refresh ticket list
        document.getElementById('supportSubject').value = '';
        document.getElementById('supportMessage').value = '';
        loadMyTickets();
    }
    
    function loadMyTickets() {
        const ticketsList = document.getElementById('ticketsList');
        ticketsList.innerHTML = '<div style="text-align:center; padding: var(--spacing-md); opacity:0.5; font-size:11px;">Loading tickets...</div>';
        
        db.ref('supportMessages').orderByChild('uid').equalTo(auth.currentUser.uid).once('value', s => {
            ticketsList.innerHTML = '';
            
            if(!s.exists()) {
                ticketsList.innerHTML = '<div style="text-align:center; padding: var(--spacing-md); opacity:0.5; font-size:11px;">No tickets yet</div>';
                return;
            }
            
            const tickets = [];
            s.forEach(child => {
                tickets.push({ key: child.key, ...child.val() });
            });
            
            // Sort by timestamp descending
            tickets.sort((a, b) => b.timestamp - a.timestamp);
            
            tickets.forEach(ticket => {
                // Count replies
                db.ref('supportTicketReplies/' + ticket.key).once('value', rSnap => {
                    const replyCount = rSnap.numChildren();
                    
                    const ticketDiv = document.createElement('div');
                    ticketDiv.className = 'ticket-item';
                    ticketDiv.onclick = () => openTicketDetail(ticket.key);
                    
                    ticketDiv.innerHTML = `
                        <div class="ticket-item-header">
                            <div class="ticket-subject">${escapeHtml(ticket.subject)}</div>
                            <div class="ticket-status ${ticket.status}">${ticket.status}</div>
                        </div>
                        <div style="display:flex; justify-content:space-between; align-items:center;">
                            <div class="ticket-time">${fixDate(ticket.timestamp)}</div>
                            ${replyCount > 0 ? `<div class="ticket-reply-count"><i data-lucide="message-circle" style="width:12px;"></i> ${replyCount}</div>` : ''}
                        </div>
                    `;
                    
                    ticketsList.appendChild(ticketDiv);
                    lucide.createIcons();
                });
            });
        });
    }
    
    let currentTicketKey = null;
    
    function openTicketDetail(ticketKey) {
        currentTicketKey = ticketKey;
        
        db.ref('supportMessages/' + ticketKey).once('value', s => {
            const ticket = s.val();
            if(!ticket) return;
            
            document.getElementById('ticketDetailSubject').innerText = ticket.subject;
            document.getElementById('ticketDetailStatus').innerText = ticket.status.toUpperCase();
            document.getElementById('ticketDetailStatus').style.color = ticket.status === 'open' ? 'var(--gold)' : '#94a3b8';
            
            const repliesContainer = document.getElementById('ticketRepliesContainer');
            repliesContainer.innerHTML = `
                <div class="ticket-original-message">
                    <div class="ticket-original-label">Original Message</div>
                    <div class="ticket-reply-content">${escapeHtml(ticket.message)}</div>
                    <div class="ticket-reply-time" style="margin-top:8px;">${fixDate(ticket.timestamp)}</div>
                </div>
            `;
            
            // Load replies
            db.ref('supportTicketReplies/' + ticketKey).orderByChild('timestamp').once('value', rSnap => {
                // Clear only replies, keep original message
                const existingOriginal = repliesContainer.querySelector('.ticket-original-message');
                repliesContainer.innerHTML = '';
                if(existingOriginal) {
                    repliesContainer.appendChild(existingOriginal);
                }
                
                if(!rSnap.exists()) {
                    repliesContainer.innerHTML += '<div style="text-align:center; padding: var(--spacing-lg); opacity:0.5; font-size:11px;">No replies yet</div>';
                } else {
                    // NORMALIZED: Fetch user data for each reply
                    rSnap.forEach(child => {
                        const reply = child.val();
                        const isAdmin = reply.isAdmin || false;
                        const adminBadge = isAdmin ? '<span class="ticket-reply-admin-badge">Support Team</span>' : '';
                        
                        // Fetch user data from users table
                        db.ref('users/' + reply.uid).once('value', userSnap => {
                            const user = userSnap.val();
                            if(!user) return;
                            
                            const replyDiv = document.createElement('div');
                            replyDiv.className = 'ticket-reply-item';
                            replyDiv.innerHTML = `
                                <div class="ticket-reply-header">
                                    <img src="${user.photo || 'https://via.placeholder.com/40'}" class="ticket-reply-avatar">
                                    <div>
                                        <div class="ticket-reply-author">${escapeHtml(user.name)} ${adminBadge}</div>
                                    </div>
                                    <div class="ticket-reply-time">${fixDate(reply.timestamp)}</div>
                                </div>
                                <div class="ticket-reply-content">${escapeHtml(reply.message)}</div>
                            `;
                            repliesContainer.appendChild(replyDiv);
                            lucide.createIcons();
                        });
                    });
                }
            });
            
            document.getElementById('ticketDetailModal').style.display = 'flex';
            setTimeout(() => lucide.createIcons(), 50);
        });
    }
    
    function closeTicketDetail() {
        document.getElementById('ticketDetailModal').style.display = 'none';
        currentTicketKey = null;
    }
    
    function submitTicketReply() {
        if(!currentTicketKey) return;
        
        const replyText = document.getElementById('ticketReplyInput').value.trim();
        
        if(!replyText) {
            showToast("Please enter a reply");
            return;
        }
        
        if(replyText.length < 5) {
            showToast("Reply too short");
            return;
        }
        
        // NORMALIZED: Add reply to Firebase with only UID
        db.ref('supportTicketReplies/' + currentTicketKey).push({
            uid: auth.currentUser.uid, // ONLY user reference
            message: replyText,
            timestamp: Date.now(),
            isAdmin: false
        }).then(() => {
            // Reload ticket detail to show new reply
            openTicketDetail(currentTicketKey);
            
            // Clear input
            document.getElementById('ticketReplyInput').value = '';
            showToast("Reply sent!");
            playSound('pop');
        });
        
        // Get ticket owner to send notification
        // Note: In a production environment, verify isAdmin flag before sending admin notifications
        db.ref('supportMessages/' + currentTicketKey).once('value', ticketSnap => {
            const ticket = ticketSnap.val();
            if(ticket && ticket.uid !== auth.currentUser.uid) {
                // Another user (likely admin/support) is replying, notify the ticket owner
                db.ref('notifications/' + ticket.uid).push({
                    msg: `Support replied to your ticket: ${ticket.subject}`,
                    time: Date.now(),
                    type: 'support_reply',
                    from: auth.currentUser.uid,
                    ticketId: currentTicketKey,
                    image: userData.photo
                });
            }
        });
        
        // Update ticket status to open if it was closed
        db.ref('supportMessages/' + currentTicketKey + '/status').set('open');
    }

    let selectedMood = null; // UPDATED DEFAULT
    let targetUserForOpt = null;
    let selectedImageBase64 = null;
    let selectedVideoBase64 = null;

    function initSocialSystem(uid) {
        db.ref('friendRequests/' + uid).on('value', s => {
            const container = document.getElementById('friendRequestsSection');
            container.innerHTML = "";
            s.forEach(req => {
                const requesterId = req.key;
                db.ref('users/' + requesterId).once('value', u => {
                    const uData = u.val();
                    const div = document.createElement('div');
                    div.className = 'friend-req-card';
                    div.innerHTML = `<div class="req-info"><img src="${uData.photo}" style="width:30px;height:30px;border-radius:50%;"><span style="font-weight:700; font-size:12px; color:white;">${uData.name} wants to be friends</span></div><div class="req-actions"><button class="btn-accept" onclick="acceptFriend('${requesterId}')">Accept</button><button class="btn-decline" onclick="declineFriend('${requesterId}')">X</button></div>`;
                    container.appendChild(div);
                });
            });
        });
    }

    function showUserOptions(uid, name, photo) {
        targetUserForOpt = { uid, name, photo };
        document.getElementById('optUserAvatarCont').innerHTML = `<img src="${photo}" style="width:60px; height:60px; border-radius:50%; border:2px solid var(--accent); object-fit:cover;">`;
        document.getElementById('optUserName').innerText = name;
        document.getElementById('userOptionsModal').style.display = 'flex';
    }

    function optSendMessage() {
        document.getElementById('userOptionsModal').style.display = 'none';
        openPrivateChat(targetUserForOpt.uid, targetUserForOpt.name, targetUserForOpt.photo);
    }

    function optAddFriend() {
        if(!targetUserForOpt) return;
        const targetUid = targetUserForOpt.uid;
        if(targetUid === auth.currentUser.uid) { showToast("That's you!"); return; }
        
        db.ref('friends/' + auth.currentUser.uid + '/' + targetUid).once('value', s => {
            if(s.exists()) {
                showToast("Already friends!");
            } else {
                db.ref('friendRequests/' + targetUid + '/' + auth.currentUser.uid).set(true);
                showToast("Friend Request Sent!");
            }
            document.getElementById('userOptionsModal').style.display = 'none';
        });
    }

    function acceptFriend(requesterUid) {
        const myUid = auth.currentUser.uid;
        db.ref('friends/' + myUid + '/' + requesterUid).set(true);
        db.ref('friends/' + requesterUid + '/' + myUid).set(true);
        db.ref('friendRequests/' + myUid + '/' + requesterUid).remove();
        showToast("You are now friends!");
        playSound('win');
    }
    
    function sendFriendRequest(targetUid) {
        if(targetUid === auth.currentUser.uid) { 
            showToast("That's you!"); 
            return; 
        }
        
        db.ref('friends/' + auth.currentUser.uid + '/' + targetUid).once('value', s => {
            if(s.exists()) {
                showToast("Already friends!");
            } else {
                db.ref('friendRequests/' + targetUid + '/' + auth.currentUser.uid).set(true);
                showToast("Friend Request Sent!");
                
                // Optionally hide the add friend button after sending request
                const addBtns = document.querySelectorAll(`.add-friend-icon-btn[onclick*="${targetUid}"]`);
                addBtns.forEach(btn => {
                    btn.style.display = 'none';
                });
            }
        });
    }

    function declineFriend(requesterUid) {
        db.ref('friendRequests/' + auth.currentUser.uid + '/' + requesterUid).remove();
    }
    
    // UNFRIEND LOGIC (Modern)
    function unfriendUser() {
        if(!currentProfileUid) return;
        showCustomConfirm("Unfriend?", "Are you sure you want to remove this friend?", () => {
             const myUid = auth.currentUser.uid;
             db.ref('friends/' + myUid + '/' + currentProfileUid).remove();
             db.ref('friends/' + currentProfileUid + '/' + myUid).remove();
             showToast("Unfriended successfully.");
             updateProfileButtonState(currentProfileUid);
        });
    }

    function selectMood(el, mood) {
        const isSelected = el.classList.contains('selected');
        document.querySelectorAll('.mood-chip').forEach(c => c.classList.remove('selected'));
        if(!isSelected) { el.classList.add('selected'); selectedMood = mood; } else { selectedMood = null; }
    }
    
    // === CLOUDINARY MEDIA UPLOAD ===
    // 
    //  CLOUDINARY CONFIGURED FOR: dzifutb8l
    // 
    
    const CLOUDINARY_CLOUD_NAME = 'dzifutb8l'; //  YOUR CLOUD NAME - READY!
    const CLOUDINARY_UPLOAD_PRESET = 'radiobingo_uploads'; // Using default preset
    
    /* 
     CLOUD NAME: SET UP 
    
     NEXT STEP: Create Upload Preset (OPTIONAL but RECOMMENDED)
    
    Your code will work with 'ml_default' preset, but for better control:
    
    1. Go to: https://console.cloudinary.com/console/dzifutb8l/settings/upload
    2. Scroll to "Upload presets"
    3. Click "Add upload preset"
    4. Settings:
        Preset name: radiobingo_uploads
        Signing mode: Unsigned  MUST BE UNSIGNED!
        Folder: (optional) radiobingo
    5. Click "Save"
    6. Update line 4948 to:
       const CLOUDINARY_UPLOAD_PRESET = 'radiobingo_uploads';
    
     FOR NOW: It will use 'ml_default' - TEST FIRST before creating custom preset!
    */
    
    async function uploadToCloudinary(file, resourceType = 'image') {
        const formData = new FormData();
        formData.append('file', file);
        formData.append('upload_preset', CLOUDINARY_UPLOAD_PRESET);
        
        const uploadUrl = `https://api.cloudinary.com/v1_1/${CLOUDINARY_CLOUD_NAME}/${resourceType}/upload`;
        
        try {
            showToast('Uploading...');
            const response = await fetch(uploadUrl, {
                method: 'POST',
                body: formData
            });
            
            const data = await response.json();
            if(data.secure_url) {
                return data.secure_url; // Return the Cloudinary URL
            } else {
                throw new Error('Upload failed');
            }
        } catch(error) {
            console.error('Cloudinary upload error:', error);
            showToast('Upload failed. Try again.');
            return null;
        }
    }
    
    function handlePostImage(input) {
        if(input.files && input.files[0]) {
            removePostVideo(); // Clear video if image is selected
            
            // Upload to Cloudinary instead of base64
            uploadToCloudinary(input.files[0], 'image').then(url => {
                if(url) {
                    selectedImageBase64 = url; // Store URL instead of base64
                    document.getElementById('postImgPreview').src = url;
                    document.getElementById('imgPreviewCont').style.display = 'block';
                    showToast('Image uploaded!');
                }
            });
        }
    }
    
    function handlePostVideo(input) {
        if(input.files && input.files[0]) {
            const videoFile = input.files[0];
            
            // Check file size (50MB max for Cloudinary free)
            if(videoFile.size > 50 * 1024 * 1024) {
                showToast("Video too large! Max 50MB");
                input.value = "";
                return;
            }
            
            // Create video element to check duration
            const video = document.createElement('video');
            video.preload = 'metadata';
            
            video.onloadedmetadata = function() {
                window.URL.revokeObjectURL(video.src);
                
                // Check duration (60 seconds max)
                if(video.duration > 60) {
                    showToast("Video too long! Max 1 minute");
                    input.value = "";
                    return;
                }
                
                removePostImage(); // Clear image if video is selected
                
                // Upload to Cloudinary
                uploadToCloudinary(videoFile, 'video').then(url => {
                    if(url) {
                        selectedVideoBase64 = url; // Store URL instead of base64
                        document.getElementById('postVideoPreview').src = url;
                        document.getElementById('videoPreviewCont').style.display = 'block';
                        showToast('Video uploaded!');
                    }
                });
            };
            
            video.src = URL.createObjectURL(videoFile);
        }
    }
    
    function removePostImage() {
        selectedImageBase64 = null;
        document.getElementById('postImgInput').value = "";
        document.getElementById('imgPreviewCont').style.display = 'none';
    }
    
    function removePostVideo() {
        selectedVideoBase64 = null;
        document.getElementById('postVideoInput').value = "";
        document.getElementById('videoPreviewCont').style.display = 'none';
    }

    function toggleVisibility() {
        const visibilityInput = document.getElementById('postVisibility');
        const visibilityIcon = document.getElementById('visibilityIcon');
        const currentValue = visibilityInput.value;
        
        // Cycle through: public -> friends -> private -> public
        if (currentValue === 'public') {
            visibilityInput.value = 'friends';
            visibilityIcon.setAttribute('data-lucide', 'users');
        } else if (currentValue === 'friends') {
            visibilityInput.value = 'private';
            visibilityIcon.setAttribute('data-lucide', 'lock');
        } else {
            visibilityInput.value = 'public';
            visibilityIcon.setAttribute('data-lucide', 'globe');
        }
        
        // Re-render the icon
        lucide.createIcons();
    }

    function createPost() {
        const txt = document.getElementById('postInput').value.trim();
        const pollData = getPollData ? getPollData() : null;
        if (pollData === false) return; // invalid poll
        if(!txt && !selectedImageBase64 && !selectedVideoBase64 && !pollData) return showToast("Type something or add media!");
        
        const visibility = document.getElementById('postVisibility').value || 'public';
        
        // Extract hashtags for indexing
        const hashtagMatches = txt.match(/#(\w+)/g) || [];
        
        // NORMALIZED: Only store UID, fetch user data when displaying
        const postData = {
            uid: auth.currentUser.uid,
            content: txt,
            mood: selectedMood,
            image: selectedImageBase64,
            video: selectedVideoBase64,
            timestamp: Date.now(),
            likes: 0,
            visibility: visibility,
            hashtags: hashtagMatches.map(h => h.slice(1).toLowerCase())
        };

        if (pollData) {
            postData.poll = {
                question: pollData.question,
                options: pollData.options,
                votes: {}
            };
        }
        
        db.ref('socialPosts').push(postData).then(ref => {
            const newPostKey = ref.key;
            // Detect @mentions in post and notify mentioned users
            const postMentionMatches = txt.match(/@(\w+)/g);
            if(postMentionMatches && userData && userData.name) {
                const uniquePostMentions = [...new Set(postMentionMatches.map(m => m.slice(1)))];
                uniquePostMentions.forEach(mentionedName => {
                    db.ref('users').orderByChild('name').equalTo(mentionedName).limitToFirst(1).once('value', snap => {
                        if(snap.exists()) {
                            const mentionedUid = Object.keys(snap.val())[0];
                            if(mentionedUid !== auth.currentUser.uid) {
                                db.ref('notifications/' + mentionedUid).push({
                                    msg: `${userData.name} mentioned you in a post`,
                                    time: Date.now(),
                                    type: 'mention',
                                    from: auth.currentUser.uid,
                                    postId: newPostKey,
                                    image: userData.photo || 'https://via.placeholder.com/40'
                                });
                            }
                        }
                    });
                });
            }
        });
        document.getElementById('postInput').value = "";
        document.getElementById('postVisibility').value = 'public';
        removePostImage();
        removePostVideo();
        document.querySelectorAll('.mood-chip').forEach(c => c.classList.remove('active'));
        selectedMood = null;

        // Reset poll
        if (pollActive) togglePollCreator();

        showToast("Posted!");
        playSound('pop');
    }

    function togglePostMenu(postKey) {
        const menu = document.getElementById('post-menu-' + postKey);
        if (!menu) return;
        
        // Close all other menus
        document.querySelectorAll('.post-overflow-menu').forEach(m => {
            if (m.id !== 'post-menu-' + postKey) {
                m.classList.remove('show');
            }
        });
        
        // Toggle current menu
        menu.classList.toggle('show');
    }

    // Close menu when clicking outside
    document.addEventListener('click', (e) => {
        if (!e.target.closest('.post-overflow-btn') && !e.target.closest('.post-overflow-menu')) {
            document.querySelectorAll('.post-overflow-menu').forEach(m => {
                m.classList.remove('show');
            });
        }
    });

    function deletePost(postKey) {
        // Close the overflow menu
        const menu = document.getElementById('post-menu-' + postKey);
        if (menu) menu.classList.remove('show');
        
        if(!confirm("Are you sure you want to delete this post?")) {
            return;
        }
        
        const ANIMATION_DURATION = 300;
        
        // Soft delete: mark as deleted instead of removing
        // Note: Firebase security rules should verify that auth.uid matches the post author's uid
        db.ref('socialPosts/' + postKey).update({
            deleted: true,
            deletedAt: Date.now()
        }).then(() => {
            // Remove from DOM immediately
            const postElement = document.getElementById('post-' + postKey);
            if(postElement) {
                postElement.style.transition = `opacity ${ANIMATION_DURATION}ms ease`;
                postElement.style.opacity = '0';
                setTimeout(() => postElement.remove(), ANIMATION_DURATION);
            }
            showToast("Post deleted");
            playSound('pop');
        }).catch(err => {
            console.error("Error deleting post:", err);
            showToast("Failed to delete post");
        });
    }

    let currentProfileUid = null;

    function openMyProfile() {
        openUserProfile(auth.currentUser.uid);
    }

    function openUserProfile(uid) {
        currentProfileUid = uid;
        document.getElementById('userOptionsModal').style.display = 'none';
        document.getElementById('userProfilePage').style.display = 'flex';
        
        document.getElementById('pageProfileFeed').innerHTML = "<div style='color:white; opacity:0.5; text-align:center; padding: var(--spacing-lg);'>Loading...</div>";
        document.getElementById('profileMainActionBtn').style.display = 'none';
        document.getElementById('unfriendBtn').style.display = 'none';

        db.ref('users/' + uid).once('value', s => {
            const u = s.val();
            const isCreator = u.isContentCreator || false;
            
            // Inject avatar (without ranking badge)
            document.getElementById('pageProfileAvatarContainer').innerHTML = renderAvatarWithBadge(sanitizeUrl(u.photo || 'https://via.placeholder.com/100'), u.bingoWins || 0, 140, uid);
            
            // Set name with verification badge and creator badge if applicable
            const verificationBadge = u.verified ? `<span class="verified-badge" onclick="showVerificationInfo(event)"><i data-lucide="check" style="width:10px; height:10px; color:white;"></i></span>` : '';
            const creatorBadge = isCreator ? `<span class="creator-badge" style="margin-left:8px;"><i data-lucide="star"></i> Creator</span>` : '';
            document.getElementById('pageProfileName').innerHTML = `${escapeHtml(u.name)}${verificationBadge}${creatorBadge}`;
            document.getElementById('pageProfileBio').innerText = u.bio || "Radio Bingo Player";
            
            // Add creator glow effect to cover if creator
            const coverEl = document.getElementById('pageProfileCover');
            if(u.cover) {
                coverEl.style.backgroundImage = `url('${u.cover}')`;
            } else {
                coverEl.style.background = '#334155';
                coverEl.style.backgroundImage = 'none';
            }
            
            // Add creator glow border effect
            if (isCreator) {
                coverEl.style.border = '3px solid rgba(245, 158, 11, 0.5)';
                coverEl.style.boxShadow = '0 0 30px rgba(245, 158, 11, 0.3)';
            } else {
                coverEl.style.border = 'none';
                coverEl.style.boxShadow = 'none';
            }
            
            updateProfileButtonState(uid);
            
            // Show followers for creators, friends for regular users
            if (isCreator) {
                const realFollowers = u.followers ? Object.keys(u.followers).length : 0;
                const fakeFollowers = u.fakeFollowers || 0;
                const totalFollowers = realFollowers + fakeFollowers;
                document.getElementById('statFriends').innerText = formatFollowerCount(totalFollowers);
                document.getElementById('statFriends').nextElementSibling.innerText = 'Followers';
            } else {
                db.ref('friends/' + uid).once('value', fSnap => {
                    document.getElementById('statFriends').innerText = fSnap.numChildren() || 0;
                    document.getElementById('statFriends').nextElementSibling.innerText = 'Friends';
                });
            }
            
            loadProfilePosts(uid);
            lucide.createIcons();
        });
    }

    function closeProfilePage() {
        document.getElementById('userProfilePage').style.display = 'none';
        currentProfileUid = null;
    }
    
    // Show verification badge info tooltip
    function showVerificationInfo(event) {
        event.stopPropagation();
        const tooltip = document.getElementById('verificationTooltip');
        const rect = event.target.getBoundingClientRect();
        
        // Position tooltip near the badge
        tooltip.style.left = rect.left + 'px';
        tooltip.style.top = (rect.bottom + 10) + 'px';
        tooltip.style.display = 'block';
        
        // Re-initialize lucide icons in tooltip
        setTimeout(() => lucide.createIcons(), 10);
        
        // Hide tooltip when clicking anywhere else
        setTimeout(() => {
            document.addEventListener('click', hideVerificationTooltip);
        }, 10);
    }
    
    function hideVerificationTooltip(event) {
        const tooltip = document.getElementById('verificationTooltip');
        if (!tooltip.contains(event.target)) {
            tooltip.style.display = 'none';
            document.removeEventListener('click', hideVerificationTooltip);
        }
    }
    
    // Toggle profile dropdown menu
    function toggleProfileMenu(event) {
        event.stopPropagation();
        const dropdown = document.getElementById('profileDropdown');
        dropdown.classList.toggle('show');
        
        // Close menu when clicking outside
        setTimeout(() => {
            document.addEventListener('click', closeProfileMenuOnClickOutside);
        }, 10);
    }
    
    function closeProfileMenuOnClickOutside(event) {
        const dropdown = document.getElementById('profileDropdown');
        const menuBtn = document.getElementById('profileMenuBtn');
        
        if (!dropdown.contains(event.target) && event.target !== menuBtn) {
            dropdown.classList.remove('show');
            document.removeEventListener('click', closeProfileMenuOnClickOutside);
        }
    }
    
    // Request verification badge with requirements
    async function requestVerificationBadge() {
        const dropdown = document.getElementById('profileDropdown');
        dropdown.classList.remove('show');
        
        const user = auth.currentUser;
        if (!user) return;
        
        try {
            // Fetch user data to check requirements
            const userSnapshot = await db.ref(`users/${user.uid}`).once('value');
            const userData = userSnapshot.val();
            
            if (userData.verified) {
                showToast('You already have a verification badge!');
                return;
            }
            
            if (userData.verificationStatus === 'pending') {
                showToast(' Your verification request is pending review');
                return;
            }
            
            // Check verification requirements
            const accountAge = Date.now() - (userData.createdAt || 0);
            const daysSinceCreation = Math.floor(accountAge / (1000 * 60 * 60 * 24));
            
            // Fetch friend count
            const friendsSnapshot = await db.ref(`friends/${user.uid}`).once('value');
            const friendCount = friendsSnapshot.numChildren();
            
            // Fetch post count
            const postsSnapshot = await db.ref('posts').orderByChild('uid').equalTo(user.uid).once('value');
            const postCount = postsSnapshot.numChildren();
            
            // Define requirements
            const REQUIREMENTS = {
                minFriends: 10,
                minPosts: 5,
                minAccountAgeDays: 7,
                minBingoWins: 3
            };
            
            // Check each requirement
            const failedRequirements = [];
            
            if (friendCount < REQUIREMENTS.minFriends) {
                failedRequirements.push(` At least ${REQUIREMENTS.minFriends} friends (You have: ${friendCount})`);
            }
            
            if (postCount < REQUIREMENTS.minPosts) {
                failedRequirements.push(` At least ${REQUIREMENTS.minPosts} posts (You have: ${postCount})`);
            }
            
            if (daysSinceCreation < REQUIREMENTS.minAccountAgeDays) {
                failedRequirements.push(` Account at least ${REQUIREMENTS.minAccountAgeDays} days old (Yours: ${daysSinceCreation} days)`);
            }
            
            if ((userData.bingoWins || 0) < REQUIREMENTS.minBingoWins) {
                failedRequirements.push(` At least ${REQUIREMENTS.minBingoWins} bingo wins (You have: ${userData.bingoWins || 0})`);
            }
            
            // If requirements not met, show detailed message
            if (failedRequirements.length > 0) {
                const requirementsList = failedRequirements.join('\n');
                showCustomConfirm(
                    'VERIFICATION REQUIREMENTS NOT MET',
                    `You need to meet these requirements to request verification:\n\n${requirementsList}\n\nKeep playing and growing your profile!`,
                    null,
                    'OK',
                    null,
                    true // Single button mode
                );
                return;
            }
            
            // All requirements met - show confirmation with textarea for reason
            const meetsRequirements = `You meet all requirements for verification:

 ${friendCount} friends (Required: ${REQUIREMENTS.minFriends})
 ${postCount} posts (Required: ${REQUIREMENTS.minPosts})
 ${daysSinceCreation} days old (Required: ${REQUIREMENTS.minAccountAgeDays})
 ${userData.bingoWins || 0} wins (Required: ${REQUIREMENTS.minBingoWins})

Please explain why you want a verification badge:`;
            
            showCustomConfirm(
                'REQUEST VERIFICATION BADGE',
                meetsRequirements,
                async (reason) => {
                    try {
                        await db.ref(`users/${user.uid}`).update({
                            verificationStatus: 'pending',
                            verificationReason: reason,
                            verificationRequestedAt: Date.now(),
                            verificationMetrics: {
                                friendsAtRequest: friendCount,
                                postsAtRequest: postCount,
                                accountAgeDaysAtRequest: daysSinceCreation,
                                winsAtRequest: userData.bingoWins || 0
                            }
                        });
                        
                        showToast('Verification request submitted! Please wait for admin approval.');
                    } catch (err) {
                        console.error('Error submitting verification request:', err);
                        showToast('Failed to submit request. Please try again.');
                    }
                },
                'SUBMIT REQUEST',
                'CANCEL',
                false,
                true // Show textarea
            );
        } catch (err) {
            console.error('Error requesting verification:', err);
            showToast('Error processing request');
        }
    }
    
    // Open settings (placeholder - you can implement later)
    function openSettings() {
        const dropdown = document.getElementById('profileDropdown');
        dropdown.classList.remove('show');
        
        // For now, just open edit profile
        openEditProfile();
    }

    function updateProfileButtonState(uid) {
        const btn = document.getElementById('profileMainActionBtn');
        const unfriendBtn = document.getElementById('unfriendBtn');
        const giftSkinBtn = document.getElementById('giftSkinBtn');
        const creatorMessageBtn = document.getElementById('creatorMessageBtn');
        const menuBtn = document.getElementById('profileMenuBtn');
        const myUid = auth.currentUser.uid;
        
        unfriendBtn.style.display = 'none';
        giftSkinBtn.style.display = 'none';
        creatorMessageBtn.style.display = 'none';
        menuBtn.style.display = 'none';
        
        if(uid === myUid) {
            btn.innerText = "Edit Profile";
            btn.className = "profile-action-btn secondary";
            btn.onclick = openEditProfile;
            btn.style.display = 'block';
            
            // Show 3-dot menu button for own profile
            menuBtn.style.display = 'flex';
        } else {
            // Check if target user is a content creator
            db.ref('users/' + uid).once('value', userSnap => {
                const targetUser = userSnap.val();
                const isCreator = targetUser && targetUser.isContentCreator;
                
                // Show Gift Skin button for other users
                giftSkinBtn.style.display = 'block';
                giftSkinBtn.onclick = () => openGiftModal(uid);
                
                if (isCreator) {
                    // For creators, show Follow button and Message button
                    db.ref('users/' + myUid + '/following/' + uid).once('value', followSnap => {
                        if (followSnap.exists()) {
                            btn.innerText = "Following";
                            btn.className = "profile-action-btn follow-btn following";
                            btn.onclick = () => {
                                toggleFollow(uid);
                                setTimeout(() => updateProfileButtonState(uid), 500);
                            };
                        } else {
                            btn.innerText = "Follow";
                            btn.className = "profile-action-btn follow-btn";
                            btn.onclick = () => {
                                toggleFollow(uid);
                                setTimeout(() => updateProfileButtonState(uid), 500);
                            };
                        }
                        btn.style.display = 'block';
                    });
                    
                    // Show message button for creators
                    creatorMessageBtn.style.display = 'block';
                    creatorMessageBtn.onclick = () => {
                        const name = document.getElementById('pageProfileName').innerText;
                        const photo = targetUser.photo || 'https://via.placeholder.com/100';
                        openPrivateChat(uid, name, photo);
                    };
                } else {
                    // For regular users, show friend system
                    db.ref('friends/' + myUid + '/' + uid).once('value', s => {
                        if(s.exists()) {
                            btn.innerText = "Message";
                            btn.className = "profile-action-btn";
                            btn.onclick = () => openPrivateChat(uid, document.getElementById('pageProfileName').innerText, document.getElementById('pageProfileImg').src); 
                            unfriendBtn.style.display = 'flex';
                        } else {
                             db.ref('friendRequests/' + uid + '/' + myUid).once('value', reqSnap => {
                                 if(reqSnap.exists()) {
                                     btn.innerText = "Cancel Request";
                                     btn.className = "profile-action-btn secondary";
                                     btn.onclick = () => {
                                         db.ref('friendRequests/' + uid + '/' + myUid).remove();
                                         updateProfileButtonState(uid);
                                         showToast("Request Cancelled");
                                     };
                                 } else {
                                     btn.innerText = "Add Friend";
                                     btn.className = "profile-action-btn";
                                     btn.onclick = () => {
                                         db.ref('friendRequests/' + uid + '/' + myUid).set(true);
                                         updateProfileButtonState(uid);
                                         showToast("Request Sent!");
                                     };
                                 }
                             });
                        }
                        btn.style.display = 'block';
                    });
                }
            });
        }
    }
    
    function loadProfilePosts(uid) {
        const container = document.getElementById('pageProfileFeed');
        
        // Check if this profile user is a friend
        db.ref('friends/' + auth.currentUser.uid + '/' + uid).once('value', friendSnap => {
            const isFriend = friendSnap.exists();
            const isMe = uid === auth.currentUser.uid;
            
            db.ref('socialPosts').orderByChild('uid').equalTo(uid).limitToLast(20).once('value', pSnap => {
                container.innerHTML = "";
                let count = 0;
                let likes = 0;
                const posts = [];
                pSnap.forEach(c => {
                    const p = c.val();
                    if(!p.deleted) {
                        posts.push({ key: c.key, ...p });
                        count++;
                        likes += (p.likes || 0);
                    }
                });
                
                document.getElementById('statPosts').innerText = count;
                document.getElementById('statLikes').innerText = likes;
                
                posts.reverse().forEach(post => {
                    const div = createPostElement(post, isFriend || isMe);
                    container.appendChild(div);
                    loadCommentPreview(post.key);
                    loadReactionSummary(post.key);
                });
                
                if(count === 0) container.innerHTML = "<div style='color:white; opacity:0.5; font-size:12px; text-align:center; padding: var(--spacing-lg);'>No posts yet</div>";
                lucide.createIcons();
            });
        });
    }

    function openEditProfile() {
        document.getElementById('editNameIn').value = userData.name;
        document.getElementById('editBioIn').value = userData.bio || "";
        document.getElementById('editProfileModal').style.display = 'flex';
    }

    function handleProfileUpload(input, type) {
        if(input.files && input.files[0]) {
            // Upload to Cloudinary
            uploadToCloudinary(input.files[0], 'image').then(url => {
                if(url) {
                    input.dataset.cloudinaryUrl = url;
                    showToast("Image uploaded! Click Save.");
                }
            });
        }
    }

    function saveProfileChanges() {
        const newName = document.getElementById('editNameIn').value.trim();
        const newBio = document.getElementById('editBioIn').value.trim();
        
        const pfpInput = document.getElementById('editProfilePicInput');
        const coverInput = document.getElementById('editCoverPicInput');
        
        if(newName.length < 2) return showToast("Name too short");
        
        const updates = {
            name: newName,
            bio: newBio
        };
        
        if(pfpInput.dataset.cloudinaryUrl) updates.photo = pfpInput.dataset.cloudinaryUrl;
        if(coverInput.dataset.cloudinaryUrl) updates.cover = coverInput.dataset.cloudinaryUrl;
        
        // Update user profile
        db.ref('users/' + auth.currentUser.uid).update(updates).then(() => {
            // Update userData object
            userData.name = newName;
            userData.bio = newBio;
            if(updates.photo) userData.photo = updates.photo;
            if(updates.cover) userData.cover = updates.cover;
            
            // NORMALIZED: No need to update posts! User data is fetched from users table.
            // When posts are displayed, they will automatically show the updated name/photo.
            showToast("Profile Updated!");
            document.getElementById('editProfileModal').style.display = 'none';
            // Clear inputs
            pfpInput.value = ""; delete pfpInput.dataset.cloudinaryUrl;
            coverInput.value = ""; delete coverInput.dataset.cloudinaryUrl;
            openMyProfile(); // Refresh
        });
    }

    // === GIFT SKIN FUNCTIONS ===
    function openGiftModal(recipientId) {
        // Fetch recipient data first
        db.ref('users/' + recipientId).once('value', recipientSnap => {
            const recipient = recipientSnap.val();
            if(!recipient) {
                showToast("User not found");
                return;
            }
            
            const recipientOwnedSkins = recipient.ownedSkins || ['default'];
            const recipientName = recipient.name;
            
            // Update modal title
            document.getElementById('giftModalTitle').innerText = `Gift a Skin to ${recipientName}`;
            
            // Populate skins list
            const skinsList = document.getElementById('giftableSkinsList');
            skinsList.innerHTML = '';
            
            Object.entries(skinShop).forEach(([skinId, skin]) => {
                const div = document.createElement('div');
                div.className = 'skin-item';
                
                const isOwned = recipientOwnedSkins.includes(skinId);
                
                div.innerHTML = `
                    <div class="skin-preview" style="${skin.preview}">B</div>
                    <div class="skin-name">${skin.name}</div>
                    <div class="skin-cost">${skin.cost.toLocaleString()} Coins</div>
                    <button class="btn-buy-skin ${isOwned ? 'owned' : 'buy'}" ${isOwned ? 'disabled' : ''}>
                        ${isOwned ? 'Already Owned' : 'GIFT'}
                    </button>
                `;
                
                if(!isOwned) {
                    const btn = div.querySelector('button');
                    btn.onclick = () => confirmSkinGift(recipientId, skinId, recipientName);
                }
                
                skinsList.appendChild(div);
            });
            
            // Show modal
            document.getElementById('giftSkinModal').style.display = 'flex';
            lucide.createIcons();
        });
    }
    
    function confirmSkinGift(recipientId, skinId, recipientName) {
        const skin = skinShop[skinId];
        if(!skin) {
            showToast("Skin not found");
            return;
        }
        
        // Check if sender has enough points
        if(userData.points < skin.cost) {
            showToast("Insufficient Coins");
            return;
        }
        
        // Show confirmation dialog
        showCustomConfirm(
            "GIFT SKIN?",
            `Gift the ${skin.name} skin to ${recipientName} for ${skin.cost.toLocaleString()} Coins?`,
            () => executeSkinGift(recipientId, skinId)
        );
    }
    
    function executeSkinGift(recipientId, skinId) {
        const skin = skinShop[skinId];
        if(!skin) {
            showToast("Skin not found");
            return;
        }
        
        const senderId = auth.currentUser.uid;
        const senderName = userData.name;
        
        // 1. Deduct points from sender using transaction
        db.ref('users/' + senderId + '/points').transaction(currentPoints => {
            const points = currentPoints || 0;
            if(points >= skin.cost) {
                return points - skin.cost;
            } else {
                return undefined; // Abort transaction explicitly
            }
        }, (error, committed, snapshot) => {
            if(error) {
                showToast("Transaction failed");
                console.error(error);
                return;
            }
            
            if(!committed) {
                showToast("Insufficient Coins");
                return;
            }
            
            // 2. Add skin to recipient's ownedSkins array
            db.ref('users/' + recipientId + '/ownedSkins').transaction(currentSkins => {
                const skins = currentSkins || ['default'];
                if(!skins.includes(skinId)) {
                    skins.push(skinId);
                }
                return skins;
            }, (error2, committed2) => {
                if(error2 || !committed2) {
                    console.error("Failed to add skin to recipient:", error2);
                    showToast("Gift failed! Contact support.");
                    // Note: In production, implement compensating transaction to refund sender
                    return;
                }
                
                // 3. Create notification for recipient (only after successful skin transfer)
                db.ref('notifications/' + recipientId).push({
                    msg: `${senderName} gifted you the ${skin.name} skin!`,
                    type: 'gift',
                    from: senderId,
                    time: Date.now()
                });
                
                // 4. Log the transaction (only after successful completion)
                db.ref('giftLogs').push({
                    from: senderId,
                    to: recipientId,
                    skinId: skinId,
                    cost: skin.cost,
                    timestamp: firebase.database.ServerValue.TIMESTAMP
                });
                
                // 5. UI Feedback
                document.getElementById('giftSkinModal').style.display = 'none';
                showToast("Gift sent successfully!");
                spawnFlyingCoins(10);
                playSound('win');
            });
        });
    }

    function openSearch() {
        document.getElementById('searchModal').style.display = 'flex';
        document.getElementById('searchInput').focus();
    }
    
    let searchTimeout = null;
    function handleSearch() {
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(() => {
            const q = document.getElementById('searchInput').value.toLowerCase().trim();
            const resDiv = document.getElementById('searchResults');
            if(q.length < 2) {
                resDiv.innerHTML = "<div style='text-align:center; opacity:0.5; padding: var(--spacing-lg);'>Type more to search...</div>";
                return;
            }
            resDiv.innerHTML = "<div style='text-align:center; opacity:0.5; padding: var(--spacing-lg);'>Searching...</div>";
            db.ref('users').once('value', s => {
                resDiv.innerHTML = "";
                let found = false;
                s.forEach(uSnap => {
                    const u = uSnap.val();
                    const uid = uSnap.key;
                    if(u.name.toLowerCase().includes(q)) {
                        found = true;
                        const div = document.createElement('div');
                        div.className = 'search-res-item';
                        div.onclick = () => {
                            document.getElementById('searchModal').style.display = 'none';
                            openUserProfile(uid);
                        };
                        div.innerHTML = `
                            <img src="${u.photo || 'https://via.placeholder.com/40'}" class="search-res-img">
                            <div style="font-size:14px; font-weight:700; color:white;">${u.name} ${getBadgeHtml(u.bingoWins || 0)}</div>
                        `;
                        resDiv.appendChild(div);
                    }
                });
                if(!found) resDiv.innerHTML = "<div style='text-align:center; opacity:0.5; padding: var(--spacing-lg);'>No users found.</div>";
                lucide.createIcons();
            });
        }, 500);
    }

    let currentOpenPostKey = null;

    function openComments(postKey) {
        currentOpenPostKey = postKey;
        const list = document.getElementById('commentList');
        list.innerHTML = "<div style='text-align:center; color:white; opacity:0.5; padding: var(--spacing-lg);'>Loading...</div>";
        document.getElementById('commentModal').style.display = 'flex';
        document.getElementById('commentModalBackdrop').style.display = 'block';
        
        db.ref('postComments/' + postKey).on('value', s => {
            list.innerHTML = "";
            if(!s.exists()) {
                list.innerHTML = "<div style='text-align:center; color:white; opacity:0.5; padding: var(--spacing-lg);'>No comments yet.</div>";
                return;
            }
            
            // NORMALIZED: Fetch user data for each comment
            s.forEach(c => {
                const com = c.val();
                
                db.ref('users/' + com.uid).once('value', userSnap => {
                    const user = userSnap.val();
                    if(!user) return;
                    
                    const div = document.createElement('div');
                    div.className = 'comment-item';
                    div.innerHTML = `
                        <img class="comment-avatar" src="${user.photo || 'https://via.placeholder.com/40'}">
                        <div class="comment-content-block">
                            <div class="comment-bubble">
                                <div class="comment-author">${escapeHtml(user.name)} ${getBadgeHtml(user.bingoWins || 0)}</div>
                                <div class="comment-text">${escapeHtml(com.text)}</div>
                            </div>
                            <div class="comment-actions">
                                <button class="cmt-action-btn" onclick="likeComment('${postKey}', '${c.key}')">Like</button>
                                <button class="cmt-action-btn" onclick="replyComment('${escapeHtml(user.name)}')">Reply</button>
                                <span>${fixDate(com.time)}</span>
                            </div>
                        </div>
                    `;
                    list.appendChild(div);
                    list.scrollTop = list.scrollHeight;
                    lucide.createIcons();
                });
            });
        });
    }
    
    function closeComments() {
        document.getElementById('commentModal').style.display = 'none';
        document.getElementById('commentModalBackdrop').style.display = 'none';
        db.ref('postComments/' + currentOpenPostKey).off(); 
        currentOpenPostKey = null;
        document.getElementById('commentInput').value = '';
        updateCommentPreview(); // Clear preview
    }

    function sendComment() {
        const txt = document.getElementById('commentInput').value.trim();
        if(!txt || !currentOpenPostKey) return;
        
        // NORMALIZED: Only store UID, fetch user data when displaying
        db.ref('postComments/' + currentOpenPostKey).push({
            uid: auth.currentUser.uid, // ONLY user reference
            text: txt,
            time: Date.now()
        });
        
        // Notify Author (Grouped logic handled in render but we push individual here)
        db.ref('socialPosts/' + currentOpenPostKey).once('value', s => {
             const p = s.val();
             if(p.uid !== auth.currentUser.uid) {
                 db.ref('notifications/' + p.uid).push({
                     msg: `${userData.name} commented on your post`,
                     time: Date.now(),
                     type: 'comment',
                     from: auth.currentUser.uid,
                     postId: currentOpenPostKey, // Link to post
                     image: userData.photo
                 });
             }
        });

        // Detect @mentions and notify each mentioned user
        const mentionMatches = txt.match(/@(\w+)/g);
        if(mentionMatches && userData && userData.name) {
            const uniqueMentions = [...new Set(mentionMatches.map(m => m.slice(1)))];
            uniqueMentions.forEach(mentionedName => {
                db.ref('users').orderByChild('name').equalTo(mentionedName).limitToFirst(1).once('value', snap => {
                    if(snap.exists()) {
                        const mentionedUid = Object.keys(snap.val())[0];
                        // Don't notify yourself or the post author (already notified above)
                        if(mentionedUid !== auth.currentUser.uid) {
                            db.ref('notifications/' + mentionedUid).push({
                                msg: `${userData.name} mentioned you in a comment`,
                                time: Date.now(),
                                type: 'mention',
                                from: auth.currentUser.uid,
                                postId: currentOpenPostKey,
                                image: userData.photo || 'https://via.placeholder.com/40'
                            });
                        }
                    }
                });
            });
        }

        document.getElementById('commentInput').value = "";
        updateCommentPreview(); // Clear preview
    }
    
    function updateCommentPreview() {
        const input = document.getElementById('commentInput');
        const previewBox = document.getElementById('commentPreviewBox');
        const previewText = document.getElementById('commentPreviewText');
        const previewAvatar = document.getElementById('commentPreviewAvatar');
        
        const txt = input.value.trim();
        
        if(txt && userData) {
            previewBox.style.display = 'block';
            previewText.textContent = txt;
            previewAvatar.src = userData.photo || 'https://via.placeholder.com/40';
        } else {
            previewBox.style.display = 'none';
            previewText.textContent = '';
        }
    }
    
    function likeComment(postKey, commentKey) {
        showToast("Liked comment!");
    }
    
    function replyComment(name) {
        document.getElementById('commentInput').value = `@${name} `;
        document.getElementById('commentInput').focus();
        updateCommentPreview(); // Show preview for reply
    }

    function loadCommentPreview(postKey) {
        const previewContainer = document.getElementById('comment-preview-' + postKey);
        const previewList = document.getElementById('preview-list-' + postKey);
        
        if(!previewContainer || !previewList) return;
        
        db.ref('postComments/' + postKey).limitToLast(2).once('value', s => {
            if(!s.exists()) {
                previewContainer.style.display = 'none';
                return;
            }
            
            previewContainer.style.display = 'block';
            previewList.innerHTML = '';
            
            const comments = [];
            s.forEach(c => {
                comments.push({ key: c.key, ...c.val() });
            });
            
            // NORMALIZED: Fetch user data for each comment
            comments.forEach(com => {
                db.ref('users/' + com.uid).once('value', userSnap => {
                    const user = userSnap.val();
                    if(!user) return;
                    
                    const div = document.createElement('div');
                    div.className = 'preview-item';
                    div.style.marginBottom = '5px';
                    
                    const truncatedText = com.text.length > 50 ? com.text.substring(0, 50) + '...' : com.text;
                    const sanitizedText = escapeHtml(truncatedText);
                    const sanitizedName = escapeHtml(user.name);
                    
                    div.innerHTML = `
                        <button class="preview-user" onclick="openUserProfile('${com.uid}')" style="background:none; border:none; padding:0; font:inherit; cursor:pointer;" aria-label="View ${sanitizedName}'s profile">${sanitizedName}</button>
                        <span class="preview-text">${sanitizedText}</span>
                    `;
                    
                    previewList.appendChild(div);
                });
            });
        });
    }


    // === SHARE POST FUNCTIONS ===
    let currentSharePostKey = null;

    function openShareModal(postKey) {
        currentSharePostKey = postKey;
        
        // Check if Web Share API is available
        const nativeShareBtn = document.getElementById('nativeShareBtn');
        const copyLinkBtn = document.getElementById('copyLinkBtn');
        
        if (navigator.share) {
            nativeShareBtn.style.display = 'flex';
            copyLinkBtn.style.display = 'none';
        } else {
            nativeShareBtn.style.display = 'none';
            copyLinkBtn.style.display = 'flex';
        }
        
        // Get post data to show preview
        db.ref('socialPosts/' + postKey).once('value', s => {
            const post = s.val();
            if(!post) return;
            
            const sanitizedAuthor = escapeHtml(post.authorName);
            const sanitizedContent = escapeHtml(post.content || '');
            const truncatedContent = sanitizedContent.length > 100 ? sanitizedContent.substring(0, 100) + '...' : sanitizedContent;
            
            document.getElementById('sharePreview').innerHTML = `
                <div class="share-post-preview-author">${sanitizedAuthor}</div>
                <div class="share-post-preview-content">${truncatedContent}</div>
            `;
            
            document.getElementById('shareModal').style.display = 'flex';
            document.getElementById('shareModalBackdrop').style.display = 'block';
            setTimeout(() => lucide.createIcons(), 50);
        });
    }

    function closeShareModal() {
        document.getElementById('shareModal').style.display = 'none';
        document.getElementById('shareModalBackdrop').style.display = 'none';
        currentSharePostKey = null;
    }

    function shareToOwnProfile() {
        if(!currentSharePostKey) return;
        if(!auth.currentUser) return showToast("Please login first");
        if(!userData || !userData.name) {
            showToast("Loading profile...");
            return;
        }
        
        const caption = document.getElementById('shareCaption').value.trim();
        
        db.ref('socialPosts/' + currentSharePostKey).once('value', s => {
            const originalPost = s.val();
            if(!originalPost) {
                showToast("Post not found");
                return;
            }
            
            // NORMALIZED: Create a new post that references the original
            const shareData = {
                uid: auth.currentUser.uid, // ONLY sharer's UID
                content: caption, // User's caption
                timestamp: Date.now(),
                likes: 0,
                visibility: 'public', // Shared posts default to public
                isShared: true,
                sharedPostKey: currentSharePostKey,
                sharedFrom: originalPost.uid, // ONLY original author's UID
                sharedContent: originalPost.content,
                sharedImage: originalPost.image,
                sharedVideo: originalPost.video,
                sharedMood: originalPost.mood
            };
            
            db.ref('socialPosts').push(shareData).then(() => {
                // Notify original author
                if(originalPost.uid !== auth.currentUser.uid) {
                    db.ref('notifications/' + originalPost.uid).push({
                        msg: `${userData.name} shared your post`,
                        time: Date.now(),
                        type: 'share',
                        from: auth.currentUser.uid,
                        postId: currentSharePostKey,
                        image: userData.photo
                    });
                }
                
                document.getElementById('shareCaption').value = ''; // Clear caption
                showToast("Post shared successfully!");
                playSound('pop');
                closeShareModal();
            }).catch(err => {
                console.error("Share error:", err);
                showToast("Failed to share. Try again.");
            });
        });
    }

    function shareViaWebShare() {
        if(!currentSharePostKey) return;
        
        db.ref('socialPosts/' + currentSharePostKey).once('value', s => {
            const post = s.val();
            if(!post) return;
            
            const shareData = {
                title: 'Check out this post!',
                text: `${post.authorName}: ${post.content || 'Shared a post'}`,
                url: window.location.origin + '/?post=' + currentSharePostKey
            };
            
            if (navigator.share) {
                navigator.share(shareData)
                    .then(() => {
                        showToast("Shared successfully!");
                        playSound('pop');
                        closeShareModal();
                    })
                    .catch((error) => {
                        // Ignore user cancellations (AbortError, NotAllowedError)
                        if (error.name !== 'AbortError' && error.name !== 'NotAllowedError') {
                            console.error('Error sharing:', error);
                            showToast("Failed to share");
                        }
                    });
            } else {
                showToast("Sharing not supported");
            }
        });
    }

    function copyPostLink() {
        if(!currentSharePostKey) return;
        
        const postUrl = window.location.origin + '/?post=' + currentSharePostKey;
        
        if (navigator.clipboard && navigator.clipboard.writeText) {
            navigator.clipboard.writeText(postUrl)
                .then(() => {
                    showToast("Link copied to clipboard!");
                    playSound('pop');
                    closeShareModal();
                })
                .catch((error) => {
                    console.error('Error copying to clipboard:', error);
                    fallbackCopyToClipboard(postUrl);
                });
        } else {
            fallbackCopyToClipboard(postUrl);
        }
    }

    function fallbackCopyToClipboard(text) {
        const textArea = document.createElement('textarea');
        textArea.value = text;
        textArea.style.position = 'fixed';
        textArea.style.left = '-9999px';
        document.body.appendChild(textArea);
        textArea.select();
        
        try {
            // Last-resort fallback using deprecated document.execCommand
            // Required for Internet Explorer and Safari versions prior to 13.1
            // This is only called after modern Clipboard API fails or is unavailable
            document.execCommand('copy');
            showToast("Link copied to clipboard!");
            playSound('pop');
            closeShareModal();
        } catch (error) {
            console.error('Fallback copy failed:', error);
            showToast("Failed to copy link");
        }
        
        document.body.removeChild(textArea);
    }


    let postListener = null;
    let feedSortMethod = 'hype';

    function toggleFeedSort(method) {
        feedSortMethod = method;
        document.getElementById('sort-hype').classList.remove('active');
        document.getElementById('sort-new').classList.remove('active');
        document.getElementById('sort-' + method).classList.add('active');
        loadSocialFeed(); // Reload with new sort
    }

    function loadSocialFeed() {
        const feedContainer = document.getElementById('socialFeed');
        if(postListener) db.ref('socialPosts').off(); // Clear old listener

        feedContainer.innerHTML = "<div style='text-align:center; padding: var(--spacing-lg); opacity:0.5;'>Loading Feed...</div>";
        
        // Get my friends list
        db.ref('friends/' + auth.currentUser.uid).once('value', fSnap => {
            const myFriends = fSnap.exists() ? Object.keys(fSnap.val()) : [];
            
            // Get all users to check content creator status
            db.ref('users').once('value', usersSnap => {
                const allUsersData = {};
                usersSnap.forEach(uSnap => {
                    allUsersData[uSnap.key] = uSnap.val();
                });
                
                postListener = db.ref('socialPosts').limitToLast(50);
                postListener.on('value', pSnap => {
                    const allPosts = [];
                    pSnap.forEach(child => { 
                        const val = child.val();
                        if(typeof val === 'object' && val !== null && !val.deleted) {
                            const likeCount = val.likes || 0;
                            const authorData = allUsersData[val.uid] || {};
                            const isContentCreator = authorData.isContentCreator || false;
                            const isFriend = myFriends.includes(val.uid);
                            const isHighEngagement = likeCount >= 5; // 5+ likes = high engagement
                            
                            // Calculate priority score
                            let priorityScore = val.timestamp; // Base: timestamp
                            
                            if(isContentCreator) {
                                // Content creators get massive boost (4 days worth)
                                priorityScore += (345600000); // 4 days in milliseconds
                            } else if(isFriend) {
                                // Friends get big boost (2 days worth)
                                priorityScore += (172800000); // 2 days in milliseconds
                            } else if(isHighEngagement) {
                                // High engagement non-friends get medium boost (1 day worth)
                                priorityScore += (86400000); // 1 day in milliseconds
                            }
                            // Non-friends with low engagement stay at base timestamp
                            
                            // Add hype score for "HOT" sorting
                            const hypeScore = val.timestamp + (likeCount * 3600000);
                            
                            allPosts.push({ 
                                key: child.key, 
                                priorityScore: priorityScore,
                                hypeScore: hypeScore,
                                isContentCreator: isContentCreator,
                                isFriend: isFriend,
                                ...val 
                            }); 
                        }
                    });
                    
                    // Sort based on selected method
                    if(feedSortMethod === 'hype') {
                        // HOT: Use hype score but still respect priority tiers
                        allPosts.sort((a, b) => {
                            // Content creators always first
                            if(a.isContentCreator && !b.isContentCreator) return -1;
                            if(!a.isContentCreator && b.isContentCreator) return 1;
                            
                            // Then friends
                            if(a.isFriend && !b.isFriend) return -1;
                            if(!a.isFriend && b.isFriend) return 1;
                            
                            // Within same tier, sort by hype score
                            return b.hypeScore - a.hypeScore;
                        });
                    } else {
                        // NEW: Use priority score (content creators > friends > high engagement > rest)
                        allPosts.sort((a, b) => b.priorityScore - a.priorityScore);
                    }
                    
                    const scrollPos = window.scrollY; 
                    
                    feedContainer.innerHTML = "";
                    if(allPosts.length === 0) {
                        feedContainer.innerHTML = "<div style='text-align:center; padding: var(--spacing-lg); opacity:0.5;'>No posts yet. Be the first!</div>";
                        return;
                    }
                    
                    let adCounter = 0;
                    
                    allPosts.forEach(post => {
                        const isFriend = myFriends.includes(post.uid);
                        const isMe = post.uid === auth.currentUser.uid;
                        
                        // === VISIBILITY FILTERING ===
                        const visibility = post.visibility || 'public'; // Default to public for old posts
                        
                        // Only Me: only author can see
                        if(visibility === 'private' && !isMe) return;
                        
                        // Friends Only: only friends and author can see
                        if(visibility === 'friends' && !isMe && !isFriend) return;
                        
                        // Public: everyone can see (no filtering needed)
                        
                        const div = createPostElement(post, isFriend || isMe);
                        feedContainer.appendChild(div);
                        loadCommentPreview(post.key);
                        loadReactionSummary(post.key);
                        
                        // === IN-FEED ADS INJECTION ===
                        adCounter++;
                        if(adCounter % 5 === 0) {
                             const adDiv = document.createElement('div');
                             adDiv.className = 'ad-container-global';
                             adDiv.style.margin = '15px auto';
                             adDiv.innerHTML = `
                                <script type="text/javascript">
                                    atOptions = { 'key' : '59f94c5cb7bcd84edb277947774c3b9d', 'format' : 'iframe', 'height' : 50, 'width' : 320, 'params' : {} };
                                <\/script>
                                <script type="text/javascript" src="https://directoryeditorweep.com/59f94c5cb7bcd84edb277947774c3b9d/invoke.js"><\/script>
                             `;
                             feedContainer.appendChild(adDiv);
                        }
                    });
                    lucide.createIcons();
                    
                    if(document.getElementById('view-home').style.display !== 'none' && window.scrollY > 200) {
                         // Only restore scroll if we are down the page
                         setTimeout(() => window.scrollTo(0, scrollPos), 10);
                    }
                });
            });
        });
    }

    // === UNIVERSAL POST RENDERER ===
    // This function is used by BOTH main feed and profile pages
    // All post styling updates should be made here for consistency
    function createPostElement(post, isFriend) {
        const postDiv = document.createElement('div');
        postDiv.className = 'post-card';
        postDiv.id = 'post-' + post.key;
        
        // NORMALIZED: Fetch user data from users/{uid} instead of from post
        db.ref('users/' + post.uid).once('value', authorSnap => {
            const author = authorSnap.val();
            if (!author) {
                console.error('Author not found:', post.uid);
                return;
            }
            
            // Add Friend Icon Button (only show if not friend and not own post)
            const isOwnPost = post.uid === auth.currentUser.uid;
            const addFriendBtn = (!isFriend && !isOwnPost) ? `<button class="add-friend-icon-btn" onclick="event.stopPropagation(); sendFriendRequest('${post.uid}')" title="Add Friend"><i data-lucide="user-plus"></i></button>` : '';
            
            const moodHtml = post.mood ? `<div class="mood-display">Feeling ${post.mood}</div>` : '';
            const imgHtml = post.image ? `<div class="post-image-container"><img src="${post.image}" class="post-image"></div>` : '';
            const videoHtml = post.video ? `<div class="post-image-container"><video src="${post.video}" class="post-image" controls style="width:100%; max-height:400px;" data-post-key="${post.key || ''}" data-owner-id="${post.uid || ''}"></video></div>` : '';
            
            // Visibility indicator
            const visibility = post.visibility || 'public';
            let visibilityIconName = 'globe'; // public
            let visibilityText = 'Public';
            if(visibility === 'friends') {
                visibilityIconName = 'users';
                visibilityText = 'Friends';
            } else if(visibility === 'private') {
                visibilityIconName = 'lock';
                visibilityText = 'Only Me';
            }
            const visibilityBadge = `<span class="visibility-badge" title="${visibilityText}" style="margin-left:4px;"><i data-lucide="${visibilityIconName}" style="width:11px; height:11px;"></i></span>`;
            
            // NORMALIZED: Check if this is a shared post - fetch shared author data
            let sharedPostHtml = '';
            if(post.isShared && post.sharedContent !== undefined && post.sharedFrom) {
                // Fetch shared author data
                db.ref('users/' + post.sharedFrom).once('value', sharedAuthorSnap => {
                    const sharedAuthor = sharedAuthorSnap.val();
                    if(sharedAuthor) {
                        const sharedImgHtml = post.sharedImage ? `<div class="post-image-container"><img src="${post.sharedImage}" class="post-image"></div>` : '';
                        const sharedVideoHtml = post.sharedVideo ? `<div class="post-image-container"><video src="${post.sharedVideo}" class="post-image" controls style="width:100%; max-height:300px;"></video></div>` : '';
                        const sharedMoodHtml = post.sharedMood ? `<div class="mood-display">Feeling ${post.sharedMood}</div>` : '';
                        
                        const sharedPostContainer = postDiv.querySelector('.shared-post-placeholder');
                        if(sharedPostContainer) {
                            sharedPostContainer.innerHTML = `
                                <div class="shared-post-container">
                                    <div style="font-size:10px; color:#94a3b8; margin-bottom: var(--spacing-xs); display:flex; align-items:center; gap:5px;">
                                        <i data-lucide="share-2" style="width:12px;"></i>
                                        <span>Shared from ${escapeHtml(sharedAuthor.name)}</span>
                                    </div>
                                    <div style="display:flex; gap: var(--spacing-sm); align-items:flex-start;">
                                        <img src="${sharedAuthor.photo || 'https://via.placeholder.com/30'}" style="width:30px; height:30px; border-radius:50%; object-fit:cover;" onclick="openUserProfile('${post.sharedFrom}')">
                                        <div style="flex:1;">
                                            <div style="font-weight:700; font-size:11px; color:white; margin-bottom:3px;">${escapeHtml(sharedAuthor.name)}</div>
                                            ${sharedMoodHtml}
                                            <div style="font-size:12px; color:#cbd5e1; margin-top:5px;">${escapeHtml(post.sharedContent || '')}</div>
                                            ${sharedImgHtml}
                                            ${sharedVideoHtml}
                                        </div>
                                    </div>
                                </div>
                            `;
                            lucide.createIcons();
                        }
                    }
                });
            }
            
            postDiv.innerHTML = `
                <div class="post-header">
                    <img class="post-avatar" src="${author.photo || 'https://via.placeholder.com/40'}" onclick="openUserProfile('${post.uid}')">
                    <div class="post-meta">
                        <div class="post-author">
                            ${escapeHtml(author.name)} 
                            ${author.verified ? '<span class="verified-badge" onclick="showVerificationInfo(event)"><i data-lucide="check" style="width:10px; height:10px; color:white;"></i></span>' : ''} 
                            ${addFriendBtn}
                        </div>
                        <div class="post-time" style="display:flex; align-items:center;">${fixDate(post.timestamp)}${visibilityBadge}</div>
                        ${moodHtml}
                    </div>
                    ${isOwnPost ? `
                    <div style="position: relative;">
                        <button class="post-overflow-btn" onclick="togglePostMenu('${post.key}')" aria-label="Post options">
                            <i data-lucide="more-vertical" style="width:18px; height:18px;"></i>
                        </button>
                        <div class="post-overflow-menu" id="post-menu-${post.key}">
                            <button class="overflow-menu-item delete-item" onclick="deletePost('${post.key}')">
                                <i data-lucide="trash-2" style="width:14px;"></i>
                                Delete Post
                            </button>
                        </div>
                    </div>
                    ` : ''}
                </div>
                <div class="post-content">${typeof formatPostContent === 'function' ? formatPostContent(post.content || '') : escapeHtml(post.content || '')}</div>
                ${imgHtml}
                ${videoHtml}
                ${post.poll ? renderPollCard(post, post.key) : ''}
                <div class="shared-post-placeholder"></div>
                <div class="reaction-summary-bar" id="reaction-summary-${post.key}" onclick="openReactionViewer('${post.key}')"></div>
                <div class="post-actions" style="position:relative;">
                    <button class="action-btn" id="like-btn-${post.key}" onclick="showReactionPopup('${post.key}')">
                        <i data-lucide="heart" id="like-icon-${post.key}" style="width:14px;"></i> 
                        <span id="like-count-wrapper-${post.key}" onclick="event.stopPropagation(); openReactionViewer('${post.key}')" onkeypress="if(event.key==='Enter'||event.key===' '){event.preventDefault();event.stopPropagation();openReactionViewer('${post.key}')}" role="button" tabindex="0" style="cursor:pointer; margin-left:4px;" aria-label="View who reacted to this post">
                            <span id="like-count-${post.key}">${post.likes || 0}</span>
                        </span>
                    </button>
                    <div id="react-pop-${post.key}" class="reaction-popup" onmouseleave="this.style.display='none'">
                        <span class="reaction-emoji" onclick="submitReaction('${post.key}', '${post.uid}', '')" title="Love"><i data-lucide="heart" style="width:20px;height:20px;color:#ef4444;pointer-events:none;"></i></span>
                        <span class="reaction-emoji" onclick="submitReaction('${post.key}', '${post.uid}', '')" title="Haha"><i data-lucide="laugh" style="width:20px;height:20px;color:#fbbf24;pointer-events:none;"></i></span>
                        <span class="reaction-emoji" onclick="submitReaction('${post.key}', '${post.uid}', '')" title="Wow"><i data-lucide="circle-alert" style="width:20px;height:20px;color:#60a5fa;pointer-events:none;"></i></span>
                        <span class="reaction-emoji" onclick="submitReaction('${post.key}', '${post.uid}', '')" title="Sad"><i data-lucide="droplets" style="width:20px;height:20px;color:#7dd3fc;pointer-events:none;"></i></span>
                    </div>
                    <button class="action-btn" onclick="openComments('${post.key}')">
                        <i data-lucide="message-circle" style="width:14px"></i> <span id="comment-btn-text-${post.key}">Comment</span>
                    </button>
                    <button class="action-btn" onclick="openShareModal('${post.key}')">
                        <i data-lucide="share-2" style="width:14px"></i> Share
                    </button>
                    <button class="action-btn bookmark-btn bk-btn-${post.key}" onclick="toggleBookmark('${post.key}')" title="Save post" style="margin-left:auto;">
                        <i data-lucide="bookmark" style="width:14px;"></i>
                    </button>
                </div>
                <div id="comment-preview-${post.key}" class="comment-preview-area" style="display:none;">
                    <div id="preview-list-${post.key}" style="margin-bottom: var(--spacing-xs);"></div>
                    <button onclick="openComments('${post.key}')" style="background:none; border:none; color:var(--accent); font-size:11px; font-weight:700; cursor:pointer; padding:0;" aria-label="View all comments for this post">View all comments</button>
                </div>
            `;
            
            lucide.createIcons();
            
            // Setup video view tracking for content creators
            if (typeof setupVideoTracking === 'function') {
                setTimeout(() => setupVideoTracking(), 200);
            }

            // Init bookmark state
            if (typeof initBookmarkStates === 'function') {
                initBookmarkStates(post.key);
            }

            // Real-time poll updates
            if (post.poll) {
                db.ref(`socialPosts/${post.key}/poll/votes`).on('value', () => {
                    db.ref(`socialPosts/${post.key}`).once('value', freshSnap => {
                        const fresh = freshSnap.val();
                        if (!fresh || !fresh.poll) return;
                        const pollEl = postDiv.querySelector('.poll-card');
                        if (pollEl) pollEl.outerHTML = renderPollCard({ ...fresh, key: post.key }, post.key);
                    });
                });
            }
            
            // Load initial state (simple check if liked)
            db.ref('postLikes/' + post.key + '/' + auth.currentUser.uid).once('value', lSnap => {
                if(lSnap.exists()) {
                    const btn = postDiv.querySelector('#like-btn-' + post.key);
                    const reaction = lSnap.val(); // Get stored emoji
                    const reactionIconMap = {'':'<i data-lucide="heart" style="width:14px;height:14px;color:#ef4444;vertical-align:middle;"></i>','':'<i data-lucide="laugh" style="width:14px;height:14px;color:#fbbf24;vertical-align:middle;"></i>','':'<i data-lucide="circle-alert" style="width:14px;height:14px;color:#60a5fa;vertical-align:middle;"></i>','':'<i data-lucide="droplets" style="width:14px;height:14px;color:#7dd3fc;vertical-align:middle;"></i>'};
        const sanitizedReaction = reactionIconMap[reaction === true ? '' : reaction] || (reaction === true ? '<i data-lucide="heart" style="width:14px;height:14px;color:#ef4444;vertical-align:middle;"></i>' : escapeHtml(reaction));
                    if(btn) {
                        btn.classList.add('liked');
                        btn.innerHTML = `<span style="font-size:16px;">${sanitizedReaction}</span> <span id="like-count-wrapper-${post.key}" onclick="event.stopPropagation(); openReactionViewer('${post.key}')" onkeypress="if(event.key==='Enter'||event.key===' '){event.preventDefault();event.stopPropagation();openReactionViewer('${post.key}')}" role="button" tabindex="0" style="cursor:pointer; margin-left:4px;" aria-label="View who reacted to this post"><span id="like-count-${post.key}">${post.likes || 0}</span></span>`;
                    }
                }
            });
            
            // Load comment count
            db.ref('postComments/' + post.key).on('value', snapshot => {
                const count = snapshot.numChildren();
                const btnText = postDiv.querySelector('#comment-btn-text-' + post.key);
                if (btnText && count > 0) {
                    btnText.textContent = `${count}`;
                }
            });
        });
        
        return postDiv;
    }

    function loadReactionSummary(postKey) {
        db.ref('postLikes/' + postKey).on('value', s => {
            const bar = document.getElementById('reaction-summary-' + postKey);
            if (!bar) return;
            
            if (!s.exists()) {
                bar.innerHTML = '';
                return;
            }

            const counts = {};
            let totalReactions = 0;
            s.forEach(child => {
                let emoji = child.val();
                // Legacy compatibility: old reactions stored as boolean true, convert to heart emoji
                if (emoji === true) emoji = '';
                counts[emoji] = (counts[emoji] || 0) + 1;
                totalReactions++;
            });

            // Sort by count descending and get top 3
            const sorted = Object.entries(counts).sort((a, b) => b[1] - a[1]);
            const topEmojis = sorted.slice(0, 3).map(([emoji]) => emoji);
            
            // Get comment count
            db.ref('postComments/' + postKey).once('value', commentSnapshot => {
                const commentCount = commentSnapshot.numChildren();
                
                // Build the reaction summary HTML
                const emojisHtml = topEmojis.map(emoji => `<span>${emoji}</span>`).join('');
                const reactionText = totalReactions === 1 ? '1 reaction' : `${totalReactions} reactions`;
                const commentText = commentCount > 0 ? (commentCount === 1 ? '1 comment' : `${commentCount} comments`) : '';
                
                bar.innerHTML = `
                    <div style="display: flex; align-items: center;">
                        <div class="reaction-emojis-group">${emojisHtml}</div>
                        <span class="reaction-count-text">${reactionText}</span>
                    </div>
                    ${commentText ? `<span class="comment-count-text">${commentText}</span>` : ''}
                `;
            });
        });
    }

    function showReactionPopup(postKey) {
        const pop = document.getElementById('react-pop-' + postKey);
        if(!pop) {
            console.error('Reaction popup not found for post:', postKey);
            return;
        }
        // Toggle
        if(pop.style.display === 'flex') pop.style.display = 'none';
        else {
            pop.style.display = 'flex';
            setTimeout(() => { 
                document.addEventListener('click', function close(e) {
                    if(!e.target.closest('#like-btn-'+postKey) && !e.target.closest('#react-pop-'+postKey)) {
                        pop.style.display = 'none';
                        document.removeEventListener('click', close);
                    }
                });
            }, 100);
        }
    }

    function submitReaction(postKey, authorUid, emoji) {
        if(!auth.currentUser) return showToast("Please login first");
        
        const myUid = auth.currentUser.uid;
        const likeRef = db.ref('postLikes/' + postKey + '/' + myUid);
        const pop = document.getElementById('react-pop-' + postKey);
        
        if(pop) pop.style.display = 'none'; // Hide popup

        likeRef.once('value', s => {
            if(s.exists() && s.val() === emoji) {
                // Remove reaction if same clicked
                likeRef.remove();
                db.ref('socialPosts/' + postKey + '/likes').transaction(l => (l || 1) - 1);
            } else {
                // New or Change reaction
                if(!s.exists()) {
                    db.ref('socialPosts/' + postKey + '/likes').transaction(l => (l || 0) + 1);
                     // Reward only on first interaction
                    const rewardHistoryRef = db.ref('rewardHistory/' + postKey + '/' + myUid);
                    rewardHistoryRef.once('value', histSnap => {
                        if(!histSnap.exists()) {
                            if(authorUid !== myUid && userData && userData.name) {
                                db.ref('users/' + authorUid + '/points').transaction(p => (p || 0) + 10);
                                db.ref('notifications/' + authorUid).push({
                                    msg: `${userData.name} reacted ${emoji} to your post`,
                                    time: Date.now(),
                                    type: 'like',
                                    from: myUid,
                                    postId: postKey,
                                    image: userData.photo || 'https://via.placeholder.com/40'
                                });
                            }
                            rewardHistoryRef.set(true); 
                        }
                    });
                }
                likeRef.set(emoji);
            }
        });
    }

    let currentReactionPostKey = null;

    function openReactionViewer(postKey) {
        currentReactionPostKey = postKey;
        const modal = document.getElementById('reactionViewerModal');
        const backdrop = document.getElementById('reactionViewerBackdrop');
        const list = document.getElementById('reactionViewerList');
        
        modal.style.display = 'flex';
        backdrop.style.display = 'block';
        list.innerHTML = "<div style='text-align:center; color:white; opacity:0.5; padding: var(--spacing-lg);'>Loading...</div>";
        
        // Fetch all reactions for this post
        db.ref('postLikes/' + postKey).once('value', s => {
            list.innerHTML = "";
            
            if(!s.exists()) {
                list.innerHTML = "<div style='text-align:center; color:white; opacity:0.5; padding: var(--spacing-lg);'>No reactions yet</div>";
                return;
            }
            
            const reactions = [];
            s.forEach(child => {
                reactions.push({
                    uid: child.key,
                    emoji: child.val()
                });
            });
            
            // Fetch user details for each reactor
            let processed = 0;
            reactions.forEach(reaction => {
                db.ref('users/' + reaction.uid).once('value', uSnap => {
                    const user = uSnap.val();
                    if(user) {
                        const div = document.createElement('div');
                        div.className = 'reaction-viewer-item';
                        div.onclick = () => {
                            closeReactionViewer();
                            openUserProfile(reaction.uid);
                        };
                        div.setAttribute('role', 'button');
                        div.setAttribute('tabindex', '0');
                        div.onkeypress = (e) => {
                            if (e.key === 'Enter' || e.key === ' ') {
                                e.preventDefault();
                                closeReactionViewer();
                                openUserProfile(reaction.uid);
                            }
                        };
                        
                        const sanitizedName = escapeHtml(user.name);
                        const sanitizedPhoto = sanitizeUrl(user.photo || 'https://via.placeholder.com/40');
                        
                        div.innerHTML = `
                            <img class="reaction-viewer-avatar" src="${sanitizedPhoto}" alt="${sanitizedName}'s profile picture">
                            <div class="reaction-viewer-info">
                                <div class="reaction-viewer-name">${sanitizedName}</div>
                            </div>
                            <div class="reaction-viewer-emoji">${{'':'<i data-lucide="heart" style="width:22px;height:22px;color:#ef4444;"></i>','':'<i data-lucide="laugh" style="width:22px;height:22px;color:#fbbf24;"></i>','':'<i data-lucide="circle-alert" style="width:22px;height:22px;color:#60a5fa;"></i>','':'<i data-lucide="droplets" style="width:22px;height:22px;color:#7dd3fc;"></i>'}[reaction.emoji === true ? '' : reaction.emoji] || escapeHtml(reaction.emoji)}</div>
                        `;
                        
                        list.appendChild(div);
                    }
                    
                    processed++;
                    if(processed === reactions.length) {
                        lucide.createIcons();
                    }
                });
            });
        });
    }

    function closeReactionViewer() {
        document.getElementById('reactionViewerModal').style.display = 'none';
        document.getElementById('reactionViewerBackdrop').style.display = 'none';
        currentReactionPostKey = null;
    }

    // Remove splash screen immediately
    setTimeout(() => {
        const ss = document.getElementById('splash-screen');
        if (ss) {
            ss.style.opacity = '0';
            setTimeout(() => ss.style.display = 'none', 500);
        }
    }, 1500); // Remove after 1.5 seconds
    
</script>

<!-- Fullscreen Photo Viewer -->
<div class="fullscreen-photo-viewer" id="fullscreenPhotoViewer">
    <div class="fullscreen-header">
        <button class="fullscreen-close-btn" onclick="closeFullscreenPhoto()">
            <i data-lucide="x"></i>
        </button>
        <div style="flex: 1;"></div>
        <button class="fullscreen-menu-btn" onclick="togglePhotoMenu(event)">
            <i data-lucide="more-vertical"></i>
            <div class="photo-menu-dropdown" id="photoMenuDropdown">
                <div class="photo-menu-item" onclick="downloadCurrentMedia()">
                    <i data-lucide="download"></i>
                    <span id="downloadMenuText">Download</span>
                </div>
            </div>
        </button>
    </div>
    
    <div class="fullscreen-photo-container" id="fullscreenMediaContainer">
        <img id="fullscreenPhotoImg" src="" alt="Fullscreen Photo" style="display:none;">
        <video id="fullscreenVideoPlayer" controls style="display:none;"></video>
    </div>
    
    <div class="fullscreen-footer">
        <button class="fullscreen-action-btn" id="fullscreenLikeBtn" onclick="handleFullscreenLike()">
            <i data-lucide="heart"></i>
            <span id="fullscreenLikeCount">Like</span>
        </button>
        <button class="fullscreen-action-btn" onclick="handleFullscreenComment()">
            <i data-lucide="message-circle"></i>
            <span id="fullscreenCommentCount">Comment</span>
        </button>
        <button class="fullscreen-action-btn" onclick="handleFullscreenShare()">
            <i data-lucide="share-2"></i>
            <span>Share</span>
        </button>
    </div>
</div>

<!-- Verification Badge Tooltip -->
<div id="verificationTooltip" class="verification-tooltip">
    <h4>
        <span class="verified-badge" style="cursor: default;">
            <i data-lucide="check" style="width:10px; height:10px; color:white;"></i>
        </span>
        Verified Account
    </h4>
    <p>This account has been verified by administrators. Verified accounts have met community standards and are confirmed to be authentic active members of the Radio Bingo Live community.</p>
</div>

<script>
    // === FULLSCREEN PHOTO/VIDEO VIEWER FUNCTIONS ===
    let currentPhotoPostKey = null;
    let currentPhotoData = null;
    let currentMediaType = 'image'; // 'image' or 'video'
    let currentMediaUrl = '';
    
    function openFullscreenPhoto(mediaUrl, postKey, mediaType = 'image') {
        currentPhotoPostKey = postKey;
        currentMediaType = mediaType;
        currentMediaUrl = mediaUrl;
        
        const viewer = document.getElementById('fullscreenPhotoViewer');
        const img = document.getElementById('fullscreenPhotoImg');
        const video = document.getElementById('fullscreenVideoPlayer');
        const downloadText = document.getElementById('downloadMenuText');
        
        // Show appropriate media element
        if (mediaType === 'video') {
            img.style.display = 'none';
            video.style.display = 'block';
            video.src = mediaUrl;
            video.load();
            downloadText.textContent = 'Download Video';
        } else {
            video.style.display = 'none';
            img.style.display = 'block';
            img.src = mediaUrl;
            downloadText.textContent = 'Download Photo';
        }
        
        viewer.classList.add('active');
        document.body.style.overflow = 'hidden';
        
        // Load post data
        loadFullscreenPostData(postKey);
        
        setTimeout(() => lucide.createIcons(), 100);
    }
    
    function closeFullscreenPhoto() {
        const viewer = document.getElementById('fullscreenPhotoViewer');
        const video = document.getElementById('fullscreenVideoPlayer');
        
        viewer.classList.remove('active');
        document.body.style.overflow = '';
        
        // Stop video if playing
        if (video) {
            video.pause();
            video.src = '';
        }
        
        currentPhotoPostKey = null;
        currentPhotoData = null;
        currentMediaType = 'image';
        currentMediaUrl = '';
        
        // Close dropdown if open
        document.getElementById('photoMenuDropdown').classList.remove('show');
    }
    
    function togglePhotoMenu(event) {
        event.stopPropagation();
        const dropdown = document.getElementById('photoMenuDropdown');
        dropdown.classList.toggle('show');
        
        if (dropdown.classList.contains('show')) {
            setTimeout(() => {
                document.addEventListener('click', function closeMenu(e) {
                    if (!e.target.closest('.photo-menu-dropdown') && !e.target.closest('.fullscreen-menu-btn')) {
                        dropdown.classList.remove('show');
                        document.removeEventListener('click', closeMenu);
                    }
                });
            }, 100);
        }
    }
    
    function downloadCurrentMedia() {
        const link = document.createElement('a');
        link.href = currentMediaUrl;
        
        if (currentMediaType === 'video') {
            link.download = `radio-bingo-video-${Date.now()}.mp4`;
            showToast('Downloading video...');
        } else {
            link.download = `radio-bingo-photo-${Date.now()}.jpg`;
            showToast('Downloading photo...');
        }
        
        link.target = '_blank';
        link.rel = 'noopener noreferrer';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        
        document.getElementById('photoMenuDropdown').classList.remove('show');
    }
    
    // Legacy function name support
    function downloadCurrentPhoto() {
        downloadCurrentMedia();
    }
    
    function loadFullscreenPostData(postKey) {
        if (!postKey) return;
        
        // Fetch post data from Firebase
        db.ref('socialPosts/' + postKey).once('value', snap => {
            if (!snap.exists()) return;
            
            currentPhotoData = snap.val();
            const likeCount = currentPhotoData.likes || 0;
            
            // Update like count display
            document.getElementById('fullscreenLikeCount').textContent = likeCount > 0 ? likeCount : 'Like';
            
            // Check if current user liked this
            if (auth.currentUser) {
                db.ref('postLikes/' + postKey + '/' + auth.currentUser.uid).once('value', likeSnap => {
                    const likeBtn = document.getElementById('fullscreenLikeBtn');
                    if (likeSnap.exists()) {
                        likeBtn.classList.add('liked');
                    } else {
                        likeBtn.classList.remove('liked');
                    }
                    lucide.createIcons();
                });
            }
            
            // Load comment count
            db.ref('postComments/' + postKey).once('value', commentSnap => {
                const commentCount = commentSnap.numChildren();
                document.getElementById('fullscreenCommentCount').textContent = commentCount > 0 ? commentCount : 'Comment';
            });
        });
    }
    
    function handleFullscreenLike() {
        if (!auth.currentUser) {
            closeFullscreenPhoto();
            return showToast("Please login first");
        }
        
        if (!currentPhotoPostKey) return;
        
        const myUid = auth.currentUser.uid;
        const likeRef = db.ref('postLikes/' + currentPhotoPostKey + '/' + myUid);
        const likeBtn = document.getElementById('fullscreenLikeBtn');
        const countSpan = document.getElementById('fullscreenLikeCount');
        
        likeRef.once('value', s => {
            if (s.exists()) {
                // Unlike
                likeRef.remove();
                db.ref('socialPosts/' + currentPhotoPostKey + '/likes').transaction(l => Math.max(0, (l || 1) - 1));
                likeBtn.classList.remove('liked');
                showToast('Like removed');
            } else {
                // Like
                likeRef.set('');
                db.ref('socialPosts/' + currentPhotoPostKey + '/likes').transaction(l => (l || 0) + 1);
                likeBtn.classList.add('liked');
                showToast('Liked!');
                
                // Reward post author
                if (currentPhotoData && currentPhotoData.uid !== myUid) {
                    const rewardHistoryRef = db.ref('rewardHistory/' + currentPhotoPostKey + '/' + myUid);
                    rewardHistoryRef.once('value', histSnap => {
                        if (!histSnap.exists() && userData && userData.name) {
                            db.ref('users/' + currentPhotoData.uid + '/points').transaction(p => (p || 0) + 10);
                            db.ref('notifications/' + currentPhotoData.uid).push({
                                msg: `${userData.name} liked your ${currentMediaType === 'video' ? 'video' : 'photo'}`,
                                time: Date.now(),
                                type: 'like',
                                from: myUid,
                                postId: currentPhotoPostKey,
                                image: userData.photo || 'https://via.placeholder.com/40'
                            });
                            rewardHistoryRef.set(true);
                        }
                    });
                }
            }
            
            // Reload data
            loadFullscreenPostData(currentPhotoPostKey);
            lucide.createIcons();
        });
    }
    
    function handleFullscreenComment() {
        if (!currentPhotoPostKey) return;
        closeFullscreenPhoto();
        
        // Open comment modal for this post
        setTimeout(() => {
            openComments(currentPhotoPostKey);
        }, 300);
    }
    
    function handleFullscreenShare() {
        if (!currentPhotoPostKey) return;
        
        const shareData = {
            title: 'Radio Bingo Live',
            text: `Check out this ${currentMediaType === 'video' ? 'video' : 'photo'} on Radio Bingo Live!`,
            url: window.location.href
        };
        
        if (navigator.share) {
            navigator.share(shareData)
                .then(() => showToast('Shared successfully!'))
                .catch(() => {});
        } else {
            // Fallback: copy link
            navigator.clipboard.writeText(window.location.href)
                .then(() => showToast('Link copied to clipboard!'))
                .catch(() => showToast('Unable to share'));
        }
    }
    
    // Add click handler to post images - wrap existing renderPosts function
    const originalRenderPosts = window.renderPosts;
    if (originalRenderPosts) {
        window.renderPosts = function(...args) {
            originalRenderPosts.apply(this, args);
            
            // Add click handlers after posts render
            setTimeout(() => {
                // Handle images
                document.querySelectorAll('.post-card img[src*="http"]').forEach(img => {
                    if (!img.dataset.fullscreenEnabled && img.closest('.post-content, .post-media')) {
                        img.dataset.fullscreenEnabled = 'true';
                        img.style.cursor = 'pointer';
                        
                        const postCard = img.closest('.post-card');
                        const postKey = postCard ? postCard.dataset.postKey : null;
                        
                        img.addEventListener('click', function(e) {
                            e.preventDefault();
                            e.stopPropagation();
                            openFullscreenPhoto(img.src, postKey, 'image');
                        });
                    }
                });
                
                // Handle videos
                document.querySelectorAll('.post-card video').forEach(video => {
                    if (!video.dataset.fullscreenEnabled) {
                        video.dataset.fullscreenEnabled = 'true';
                        
                        const postCard = video.closest('.post-card');
                        const postKey = postCard ? postCard.dataset.postKey : null;
                        
                        // Add double-click handler for fullscreen
                        video.addEventListener('dblclick', function(e) {
                            e.preventDefault();
                            e.stopPropagation();
                            openFullscreenPhoto(video.src || video.currentSrc, postKey, 'video');
                        });
                        
                        // Add fullscreen button overlay
                        const wrapper = video.parentElement;
                        if (wrapper && !wrapper.querySelector('.video-fullscreen-overlay')) {
                            const overlay = document.createElement('div');
                            overlay.className = 'video-fullscreen-overlay';
                            overlay.style.cssText = 'position:absolute; top:8px; right:8px; background:rgba(0,0,0,0.7); padding:8px; border-radius:8px; cursor:pointer; z-index:10; backdrop-filter:blur(10px);';
                            overlay.innerHTML = '<i data-lucide="maximize-2" style="width:20px; height:20px; color:white;"></i>';
                            overlay.onclick = function(e) {
                                e.preventDefault();
                                e.stopPropagation();
                                openFullscreenPhoto(video.src || video.currentSrc, postKey, 'video');
                            };
                            
                            if (wrapper.style.position !== 'relative' && wrapper.style.position !== 'absolute') {
                                wrapper.style.position = 'relative';
                            }
                            wrapper.appendChild(overlay);
                            
                            setTimeout(() => lucide.createIcons(), 100);
                        }
                    }
                });
            }, 500);
        };
    }
    
    // ===============================================
    // CONTENT CREATOR SYSTEM
    // ===============================================
    
    // Follow/Unfollow System
    function toggleFollow(targetUid) {
        if (!auth.currentUser) {
            showToast('Please login first');
            return;
        }
        
        const myUid = auth.currentUser.uid;
        
        if (myUid === targetUid) {
            showToast('Cannot follow yourself');
            return;
        }
        
        db.ref(`users/${myUid}/following/${targetUid}`).once('value').then(snap => {
            if (snap.exists()) {
                // Unfollow
                db.ref(`users/${myUid}/following/${targetUid}`).remove();
                db.ref(`users/${targetUid}/followers/${myUid}`).remove();
                showToast('Unfollowed');
                
                db.ref(`notifications/${targetUid}`).push({
                    msg: `${auth.currentUser.displayName || 'Someone'} unfollowed you`,
                    time: Date.now(),
                    type: 'unfollow',
                    from: myUid
                });
            } else {
                // Follow
                db.ref(`users/${myUid}/following/${targetUid}`).set(true);
                db.ref(`users/${targetUid}/followers/${myUid}`).set(true);
                showToast('Following!');
                
                db.ref(`notifications/${targetUid}`).push({
                    msg: `${auth.currentUser.displayName || 'Someone'} started following you!`,
                    time: Date.now(),
                    type: 'new_follower',
                    from: myUid
                });
            }
            
            if (typeof viewProfile === 'function') {
                viewProfile(targetUid);
            }
        });
    }
    
    // Award points with 2x creator multiplier
    const originalAwardPoints = typeof awardPoints !== 'undefined' ? awardPoints : null;
    function awardPoints(uid, basePoints, reason) {
        if (!uid || basePoints <= 0) return;
        
        db.ref(`users/${uid}`).once('value').then(snap => {
            const user = snap.val();
            if (!user) return;
            
            const multiplier = user.isContentCreator ? 2 : 1;
            const actualPoints = basePoints * multiplier;
            
            const currentPoints = user.points || 0;
            const newPoints = currentPoints + actualPoints;
            
            const updates = { points: newPoints };
            
            if (user.isContentCreator) {
                const creatorPoints = user.creatorPoints || 0;
                updates.creatorPoints = creatorPoints + actualPoints;
            }
            
            db.ref(`users/${uid}`).update(updates);
            
            const bonusText = multiplier > 1 ? ' (2x Creator Bonus!)' : '';
            db.ref(`notifications/${uid}`).push({
                msg: `+${actualPoints} points! ${reason}${bonusText}`,
                time: Date.now(),
                type: 'points_earned',
                points: actualPoints
            });
        });
    }
    
    // Award video view points
    function awardVideoViewPoints(videoOwnerId, viewerId, videoId) {
        if (videoOwnerId === viewerId) return;
        
        db.ref(`users/${videoOwnerId}`).once('value').then(snap => {
            const user = snap.val();
            if (!user || !user.isContentCreator) return;
            
            const viewId = `${videoId}_${viewerId}`;
            
            db.ref(`videoViews/${videoOwnerId}/${viewId}`).once('value').then(viewSnap => {
                if (viewSnap.exists()) return;
                
                db.ref(`videoViews/${videoOwnerId}/${viewId}`).set({
                    viewerId: viewerId,
                    timestamp: Date.now(),
                    videoId: videoId
                });
                
                const currentViews = user.creatorVideoViews || 0;
                db.ref(`users/${videoOwnerId}`).update({
                    creatorVideoViews: currentViews + 1
                });
                
                awardPoints(videoOwnerId, 5, 'Video view');
            });
        });
    }
    
    // ===============================================
    // DAILY LOGIN STREAK SYSTEM
    // ===============================================

    const STREAK_REWARDS = [50, 75, 100, 150, 200, 300, 500];
    const STREAK_DOT_ICONS = [
        '<i data-lucide="flame" style="width:14px;height:14px;color:#f59e0b;"></i>',
        '<i data-lucide="flame" style="width:14px;height:14px;color:#f59e0b;"></i>',
        '<i data-lucide="flame" style="width:14px;height:14px;color:#f59e0b;"></i>',
        '<i data-lucide="gem"   style="width:14px;height:14px;color:#38bdf8;"></i>',
        '<i data-lucide="gem"   style="width:14px;height:14px;color:#38bdf8;"></i>',
        '<i data-lucide="zap"   style="width:14px;height:14px;color:#a78bfa;"></i>',
        '<i data-lucide="crown" style="width:14px;height:14px;color:#fbbf24;"></i>',
    ];
    const STREAK_EMOJIS_LUCIDE = [
        '<i data-lucide="flame"    style="width:36px;height:36px;color:#f59e0b;filter:drop-shadow(0 0 10px rgba(251,191,36,0.6));"></i>',
        '<i data-lucide="flame"    style="width:36px;height:36px;color:#f59e0b;filter:drop-shadow(0 0 10px rgba(251,191,36,0.6));"></i>',
        '<i data-lucide="flame"    style="width:36px;height:36px;color:#f59e0b;filter:drop-shadow(0 0 10px rgba(251,191,36,0.6));"></i>',
        '<i data-lucide="gem"      style="width:36px;height:36px;color:#38bdf8;filter:drop-shadow(0 0 10px rgba(56,189,248,0.6));"></i>',
        '<i data-lucide="gem"      style="width:36px;height:36px;color:#38bdf8;filter:drop-shadow(0 0 10px rgba(56,189,248,0.6));"></i>',
        '<i data-lucide="zap"      style="width:36px;height:36px;color:#a78bfa;filter:drop-shadow(0 0 10px rgba(167,139,250,0.6));"></i>',
        '<i data-lucide="crown"    style="width:36px;height:36px;color:#fbbf24;filter:drop-shadow(0 0 10px rgba(251,191,36,0.8));"></i>',
    ];
    const STREAK_EMOJIS = STREAK_EMOJIS_LUCIDE;

    function checkDailyStreak(uid, userData) {
        const today      = new Date().toDateString();
        const yesterday  = new Date(Date.now() - 86400000).toDateString();
        const lastLogin  = userData.lastLoginDate;
        const streak     = userData.loginStreak || 0;

        if (lastLogin === today) return; // already claimed today

        let newStreak;
        if (lastLogin === yesterday) {
            newStreak = streak + 1; // consecutive
        } else {
            newStreak = 1; // broken  reset
        }

        const dayIndex = Math.min(newStreak - 1, STREAK_REWARDS.length - 1);
        const reward   = STREAK_REWARDS[dayIndex];

        db.ref('users/' + uid).update({
            loginStreak: newStreak,
            lastLoginDate: today,
            points: (userData.points || 0) + reward,
            longestStreak: Math.max(userData.longestStreak || 0, newStreak)
        });

        showStreakModal(newStreak, reward);
    }

    function showStreakModal(streak, reward) {
        const dayIndex = Math.min(streak - 1, STREAK_REWARDS.length - 1);
        const emoji    = STREAK_EMOJIS[dayIndex];

        const dotsHtml = STREAK_REWARDS.map((r, i) => {
            let cls = '';
            if (i < streak - 1) cls = 'completed';
            else if (i === streak - 1) cls = 'today';
            const day = i + 1;
            const emoji = STREAK_EMOJIS[i];
            return `<div class="streak-day-dot ${cls}">
                        <span style="display:flex;align-items:center;justify-content:center;">${STREAK_DOT_ICONS[Math.min(dayIndex,6)]||STREAK_DOT_ICONS[0]}</span>
                        <span>D${day}</span>
                    </div>`;
        }).join('');

        document.getElementById('streakModalBody').innerHTML = `
            <div class="streak-flame">${emoji}</div>
            <div class="streak-number">${streak}</div>
            <div class="streak-label">Day Streak <i data-lucide="flame" style="width:16px;height:16px;vertical-align:middle;color:#f59e0b;"></i></div>
            <div class="streak-days-row">${dotsHtml}</div>
            <div class="streak-reward-box">
                <div style="font-size:12px; color:rgba(255,255,255,0.6); margin-bottom:4px;">TODAY'S REWARD</div>
                <div class="streak-reward-coins">+${reward.toLocaleString()} <i data-lucide="coins" style="width:16px;height:16px;vertical-align:middle;color:#fbbf24;"></i></div>
                <div style="font-size:11px; color:rgba(255,255,255,0.4); margin-top:4px;">RB Coins added to your wallet</div>
            </div>
            ${streak === 7 ? '<div style="background:linear-gradient(135deg,rgba(251,191,36,0.3),rgba(239,68,68,0.2)); border:1px solid rgba(251,191,36,0.4); border-radius:12px; padding:10px; margin-bottom:12px; font-size:13px; font-weight:700; color:#fbbf24;"><i data-lucide="party-popper" style="width:14px;height:14px;vertical-align:middle;color:#fbbf24;"></i> PERFECT WEEK! Bonus streak reset tomorrow.</div>' : ''}
            <button class="streak-claim-btn" onclick="closeStreakModal()">CLAIM REWARD</button>
        `;

        document.getElementById('streakModalOverlay').classList.add('active');
        if (streak >= 7 || streak === 3) {
            setTimeout(() => confetti({ particleCount: 150, spread: 80, origin: { y: 0.6 }, colors: ['#fbbf24','#f59e0b','#ef4444','#ffffff'] }), 200);
        }
        lucide.createIcons();
    }

    function closeStreakModal() {
        document.getElementById('streakModalOverlay').classList.remove('active');
        updateStreakWidget();
    }

    function updateStreakWidget() {
        if (!auth.currentUser || !userData) return;
        const streak = userData.loginStreak || 0;
        const widget = document.getElementById('streakHomeWidget');
        if (!widget) return;
        const dayIndex = Math.min(streak - 1, STREAK_EMOJIS.length - 1);
        const emoji = streak > 0 ? STREAK_EMOJIS[Math.max(0,dayIndex)] : '<i data-lucide="flame" style="width:36px;height:36px;color:#f59e0b;"></i>';
        widget.innerHTML = `
            <div style="font-size:36px; line-height:1; filter:drop-shadow(0 0 10px rgba(251,191,36,0.6));">${emoji}</div>
            <div style="flex:1;">
                <div style="font-size:14px; font-weight:900; color:white;">Daily Streak</div>
                <div style="font-size:12px; color:rgba(255,255,255,0.5);">Day <strong style="color:#fbbf24;">${streak}</strong>  keep going!</div>
            </div>
            <div style="font-size:12px; color:#fbbf24; font-weight:700;"> VIEW</div>
        `;
    }

    // ===============================================
    // LEADERBOARD SYSTEM
    // ===============================================

    let currentLbTab = 'wins';

    function openLeaderboard() {
        document.getElementById('leaderboardPage').classList.add('active');
        loadLeaderboard('wins');
        lucide.createIcons();
    }

    function closeLeaderboard() {
        document.getElementById('leaderboardPage').classList.remove('active');
    }

    function switchLbTab(tab) {
        currentLbTab = tab;
        document.querySelectorAll('.lb-tab').forEach(b => b.classList.remove('active'));
        document.getElementById('lb-tab-' + tab).classList.add('active');
        loadLeaderboard(tab);
    }

    function loadLeaderboard(tab) {
        const container = document.getElementById('lbContent');
        container.innerHTML = `<div style="text-align:center; padding:40px; opacity:0.5;">Loading rankings...</div>`;

        let field, label, icon, format;
        if (tab === 'wins')    { field = 'bingoWins';    label = 'Bingo Wins';  icon = '<i data-lucide="trophy" style="width:12px;height:12px;color:#fbbf24;vertical-align:middle;"></i>'; format = v => `${v} wins`; }
        if (tab === 'points')  { field = 'points';       label = 'RB Coins';    icon = '<i data-lucide="coins" style="width:12px;height:12px;color:#fbbf24;vertical-align:middle;"></i>'; format = v => `${(v||0).toLocaleString()}`; }
        if (tab === 'streak')  { field = 'longestStreak';label = 'Best Streak'; icon = '<i data-lucide="flame" style="width:12px;height:12px;color:#f87171;vertical-align:middle;"></i>'; format = v => `${v} days`; }
        if (tab === 'creators') { field = 'creatorPoints'; label = 'Creator XP'; icon = '<i data-lucide="star" style="width:12px;height:12px;color:#fbbf24;vertical-align:middle;"></i>'; format = v => `${(v||0).toLocaleString()} XP`; }

        db.ref('users').orderByChild(field).limitToLast(50).once('value', snap => {
            const users = [];
            snap.forEach(child => {
                const u = child.val();
                if ((u[field] || 0) > 0) {
                    users.push({ uid: child.key, ...u });
                }
            });
            users.sort((a, b) => (b[field] || 0) - (a[field] || 0));
            const top50 = users.slice(0, 50);

            const myUid = auth.currentUser ? auth.currentUser.uid : null;
            const myRank = myUid ? top50.findIndex(u => u.uid === myUid) + 1 : 0;

            // Podium top 3
            let podiumHtml = '';
            if (top50.length >= 3) {
                const podiumOrder = [top50[1], top50[0], top50[2]]; // 2nd, 1st, 3rd
                const crowns = [
    '<i data-lucide="medal" style="width:28px;height:28px;color:#94a3b8;filter:drop-shadow(0 0 6px rgba(148,163,184,0.6));"></i>',
    '<i data-lucide="medal" style="width:28px;height:28px;color:#fbbf24;filter:drop-shadow(0 0 8px rgba(251,191,36,0.8));"></i>',
    '<i data-lucide="medal" style="width:28px;height:28px;color:#cd7f32;filter:drop-shadow(0 0 6px rgba(205,127,50,0.6));"></i>',
];
                const sizes  = [60, 80, 60];
                podiumHtml = `<div class="lb-podium">` +
                    podiumOrder.map((u, i) => {
                        const rank = [2,1,3][i];
                        return `
                        <div class="podium-slot">
                            <div class="podium-crown">${crowns[i]}</div>
                            <img class="podium-avatar" src="${u.photo || 'https://via.placeholder.com/80'}" style="width:${sizes[i]}px;height:${sizes[i]}px;" onclick="openUserProfile('${u.uid}')">
                            <div class="podium-name">${escapeHtml(u.name || 'Player')}</div>
                            <div class="podium-val">${format(u[field] || 0)}</div>
                            <div class="podium-base">${rank}</div>
                        </div>`;
                    }).join('') + `</div>`;
            }

            // Rank list (4th and below)
            const listHtml = top50.slice(3).map((u, i) => {
                const rank = i + 4;
                const isMe = u.uid === myUid;
                return `
                <div class="lb-row ${isMe ? 'is-me' : ''}" onclick="openUserProfile('${u.uid}')">
                    <div class="lb-rank">${rank}</div>
                    <img class="lb-avatar" src="${u.photo || 'https://via.placeholder.com/44'}">
                    <div class="lb-info">
                        <div class="lb-username">${escapeHtml(u.name || 'Player')}${u.verified ? ' <i data-lucide="check" style="width:10px;height:10px;color:#38bdf8;vertical-align:middle;"></i>' : ''}${u.isContentCreator ? ' <i data-lucide="star" style="width:10px;height:10px;color:#fbbf24;vertical-align:middle;"></i>' : ''}</div>
                        <div class="lb-sub">${icon} ${label}</div>
                    </div>
                    <div class="lb-score">${format(u[field] || 0)}</div>
                </div>`;
            }).join('');

            // My rank banner
            let myRankHtml = '';
            if (myUid && myRank > 0) {
                const me = top50[myRank - 1];
                myRankHtml = `
                <div class="lb-my-rank">
                    <div class="lb-rank" style="color:var(--accent);">#${myRank}</div>
                    <img class="lb-avatar" src="${me.photo || 'https://via.placeholder.com/44'}">
                    <div class="lb-info">
                        <div class="lb-username" style="color:var(--accent);">You</div>
                        <div class="lb-sub">${format(me[field] || 0)}</div>
                    </div>
                </div>`;
            } else if (myUid) {
                myRankHtml = `<div class="lb-my-rank"><div style="color:rgba(255,255,255,0.4); font-size:13px;">You're not ranked yet  keep playing!</div></div>`;
            }

            container.innerHTML = podiumHtml + myRankHtml + `<div class="lb-list">${listHtml || '<div style="text-align:center;padding:40px;opacity:0.5;">No data yet</div>'}</div>`;
        });
    }

    // ===============================================
    // TOURNAMENT SYSTEM
    // ===============================================

    let currentTournTab = 'upcoming';

    function openTournaments() {
        document.getElementById('tournamentPage').classList.add('active');
        // Update coins display
        const coins = userData ? (userData.points || 0) : 0;
        document.getElementById('tournCoinsDisplay').innerText = coins.toLocaleString() + ' <i data-lucide="coins" style="width:14px;height:14px;color:#fbbf24;vertical-align:middle;"></i>';
        loadTournaments('upcoming');
        lucide.createIcons();
    }

    function closeTournaments() {
        document.getElementById('tournamentPage').classList.remove('active');
    }

    function switchTournTab(tab) {
        currentTournTab = tab;
        document.querySelectorAll('.tourn-tab-btn').forEach(b => b.classList.remove('active'));
        document.getElementById('ttab-' + tab).classList.add('active');
        loadTournaments(tab);
    }

    function loadTournaments(tab) {
        const container = document.getElementById('tournContent');
        container.innerHTML = `<div style="text-align:center;padding:40px;opacity:0.5;">Loading tournaments...</div>`;

        db.ref('tournaments').orderByChild('status').once('value', snap => {
            if (!snap.exists()) {
                container.innerHTML = `<div class="tourn-empty"><div><i data-lucide="trophy" style="width:60px;height:60px;vertical-align:middle;color:rgba(251,191,36,0.5);"></i></div><div style="font-size:16px;font-weight:700;margin-top:12px;">No Tournaments Yet</div><div style="font-size:13px;margin-top:8px;color:rgba(255,255,255,0.4);">Check back soon for upcoming events!</div></div>`;
                return;
            }

            const all = [];
            snap.forEach(c => all.push({ key: c.key, ...c.val() }));

            const filtered = all.filter(t => {
                if (tab === 'upcoming') return t.status === 'upcoming';
                if (tab === 'live')     return t.status === 'live';
                if (tab === 'finished') return t.status === 'finished';
                return true;
            });

            if (filtered.length === 0) {
                container.innerHTML = `<div class="tourn-empty"><div>${tab==='live' ? '<i data-lucide="signal" style="width:60px;height:60px;color:rgba(56,189,248,0.5);"></i>' : '<i data-lucide="calendar" style="width:60px;height:60px;color:rgba(148,163,184,0.5);"></i>'}</div><div style="font-size:16px;font-weight:700;margin-top:12px;">No ${tab} tournaments</div></div>`;
                return;
            }

            container.innerHTML = filtered.sort((a,b) => (a.startTime || 0) - (b.startTime || 0))
                .map(t => renderTournCard(t)).join('');
            lucide.createIcons();
        });
    }

    function renderTournCard(t) {
        const myUid = auth.currentUser ? auth.currentUser.uid : null;
        const participants = t.participants ? Object.keys(t.participants) : [];
        const isRegistered = myUid && participants.includes(myUid);
        const isFull = t.maxParticipants && participants.length >= t.maxParticipants;
        const startDate = t.startTime ? new Date(t.startTime).toLocaleString('en-PH', { month:'short', day:'numeric', hour:'2-digit', minute:'2-digit' }) : 'TBA';

        const badgeMap = { upcoming: 'upcoming', live: 'live', finished: 'finished' };
        const badgeLabel = { upcoming: '<i data-lucide="calendar" style="width:10px;height:10px;vertical-align:middle;"></i> UPCOMING', live: '<span style="display:inline-block;width:7px;height:7px;background:#ef4444;border-radius:50%;margin-right:3px;animation:pulse-ring 1.5s infinite;"></span>LIVE', finished: '<i data-lucide="check-circle" style="width:10px;height:10px;vertical-align:middle;color:#10b981;"></i> FINISHED' };

        let actionBtn = '';
        if (t.status === 'upcoming') {
            if (isRegistered) {
                actionBtn = `<button class="tourn-register-btn registered" disabled><i data-lucide="check-circle" style="width:16px;"></i> REGISTERED</button>`;
            } else if (isFull) {
                actionBtn = `<button class="tourn-register-btn" disabled>FULL (${participants.length}/${t.maxParticipants})</button>`;
            } else {
                actionBtn = `<button class="tourn-register-btn" onclick="registerTournament('${t.key}', ${t.entryFee || 0})"><i data-lucide="zap" style="width:16px;"></i> JOIN  ${(t.entryFee||0).toLocaleString()} <i data-lucide="coins" style="width:14px;height:14px;vertical-align:middle;"></i> ENTRY</button>`;
            }
        } else if (t.status === 'live') {
            actionBtn = `<button class="tourn-register-btn" style="background:linear-gradient(135deg,#ef4444,#b91c1c);" onclick="switchTab('bingo')"><i data-lucide="play" style="width:16px;"></i> WATCH LIVE NOW</button>`;
        } else {
            actionBtn = `<div style="text-align:center;padding:12px;background:rgba(255,255,255,0.05);border-radius:12px;"><i data-lucide="trophy" style="width:20px;height:20px;color:#fbbf24;vertical-align:middle;"></i> <strong style="color:#fbbf24;">${escapeHtml(t.winnerName||'TBD')}</strong> won!</div>`;
        }

        const avatarsHtml = participants.slice(0,5).map(uid => 
            `<img class="tourn-participant-avatar" src="https://via.placeholder.com/28" data-uid="${uid}">`
        ).join('');

        return `
        <div class="tourn-card ${t.status === 'live' ? 'active-tourn' : ''}">
            <span class="tourn-badge ${badgeMap[t.status]}">${badgeLabel[t.status]}</span>
            <div class="tourn-name">${escapeHtml(t.name || 'Bingo Tournament')}</div>
            <div class="tourn-prize-box">
                <div>
                    <div style="font-size:10px;color:rgba(255,255,255,0.5);text-transform:uppercase;letter-spacing:1px;">Grand Prize</div>
                    <div class="tourn-prize-amount">${(t.prize||0).toLocaleString()} <i data-lucide="coins" style="width:14px;height:14px;color:#fbbf24;vertical-align:middle;"></i></div>
                </div>
                <div style="text-align:right;">
                    <div style="font-size:10px;color:rgba(255,255,255,0.5);">Runners-up</div>
                    <div style="font-size:13px;color:#94a3b8;font-weight:700;"><i data-lucide="medal" style="width:12px;height:12px;color:#94a3b8;vertical-align:middle;"></i> ${(t.prize2||0).toLocaleString()}  <i data-lucide="medal" style="width:12px;height:12px;color:#cd7f32;vertical-align:middle;"></i> ${(t.prize3||0).toLocaleString()}</div>
                </div>
            </div>
            <div class="tourn-info-row">
                <div class="tourn-info-chip"><i data-lucide="calendar" style="width:12px;"></i> ${startDate}</div>
                <div class="tourn-info-chip"><i data-lucide="users" style="width:12px;"></i> ${participants.length}/${t.maxParticipants||''}</div>
                <div class="tourn-info-chip"><i data-lucide="coins" style="width:12px;"></i> Entry: ${(t.entryFee||0).toLocaleString()}</div>
            </div>
            ${participants.length > 0 ? `<div style="display:flex;align-items:center;gap:8px;margin-bottom:12px;"><div style="display:flex;">${avatarsHtml}</div><span style="font-size:11px;color:rgba(255,255,255,0.4);">${participants.length} registered${isFull?'  FULL':''}</span></div>` : ''}
            ${actionBtn}
        </div>`;
    }

    function registerTournament(tournKey, entryFee) {
        if (!auth.currentUser) return showToast('Please login first');
        const myUid = auth.currentUser.uid;

        if ((userData.points || 0) < entryFee) {
            showToast(`Not enough coins to join!`);
            return;
        }

        showCustomConfirm(
            'JOIN TOURNAMENT?',
            `Entry fee: ${entryFee.toLocaleString()} RB Coins. Are you ready to compete?`,
            () => {
                db.ref(`tournaments/${tournKey}/participants/${myUid}`).set({
                    name: userData.name,
                    photo: userData.photo || '',
                    joinedAt: Date.now()
                }).then(() => {
                    db.ref(`users/${myUid}/points`).transaction(p => Math.max(0, (p||0) - entryFee));
                    showToast('Registered! Good luck!');
                    confetti({ particleCount: 80, spread: 60, origin: { y: 0.7 }, colors: ['#fbbf24','#10b981','#ffffff'] });
                    loadTournaments(currentTournTab);
                }).catch(() => showToast('Failed to register. Try again.'));
            }
        );
    }

    // Track video views
    function setupVideoTracking() {
        document.querySelectorAll('video[data-post-key]').forEach(video => {
            const postKey = video.getAttribute('data-post-key');
            const ownerId = video.getAttribute('data-owner-id');
            
            if (postKey && ownerId && auth.currentUser) {
                let viewRecorded = false;
                let playTime = 0;
                let lastTime = 0;
                
                video.addEventListener('play', () => {
                    lastTime = video.currentTime;
                });
                
                video.addEventListener('timeupdate', () => {
                    if (!viewRecorded) {
                        const currentTime = video.currentTime;
                        if (currentTime > lastTime) {
                            playTime += (currentTime - lastTime);
                        }
                        lastTime = currentTime;
                        
                        if (playTime >= 3 && auth.currentUser.uid !== ownerId) {
                            awardVideoViewPoints(ownerId, auth.currentUser.uid, postKey);
                            viewRecorded = true;
                        }
                    }
                });
            }
        });
    }

    // ================================================
    //  STORIES SYSTEM
    // ================================================
    const STORY_DURATION = 5000; // 5 seconds per story
    let storyTimer = null;
    let currentStoryGroup = []; // array of story objects for current user
    let currentStoryIdx = 0;
    let storyProgressInterval = null;
    let selectedStoryBg = 'linear-gradient(135deg,#0f172a,#1e293b)';
    let storyPhotoData = null;
    let currentStoryType = 'text';

    function loadStories() {
        const row = document.getElementById('storiesRow');
        const myUid = auth.currentUser ? auth.currentUser.uid : null;
        const cutoff = Date.now() - 24 * 60 * 60 * 1000; // 24h

        db.ref('stories').orderByChild('timestamp').startAt(cutoff).once('value', snap => {
            // Group stories by uid
            const byUser = {};
            snap.forEach(child => {
                const s = child.val();
                if (s.timestamp < cutoff) return;
                if (!byUser[s.uid]) byUser[s.uid] = [];
                byUser[s.uid].push({ key: child.key, ...s });
            });

            // Build story items (exclude my own from the list, it's already added in HTML)
            const storyItems = Object.entries(byUser)
                .filter(([uid]) => uid !== myUid)
                .map(([uid, stories]) => ({ uid, stories, latest: stories[stories.length - 1] }));

            // Remove old dynamic items
            row.querySelectorAll('.story-item-dynamic').forEach(el => el.remove());

            storyItems.forEach(({ uid, stories, latest }) => {
                db.ref('users/' + uid).once('value', uSnap => {
                    const u = uSnap.val();
                    if (!u) return;
                    const seen = latest.seenBy && latest.seenBy[myUid];
                    const div = document.createElement('div');
                    div.className = 'story-item story-item-dynamic';
                    div.onclick = () => openStoryViewer(stories, u);
                    div.innerHTML = `
                        <div class="story-ring ${seen ? 'seen' : ''}">
                            <div class="story-ring-inner"><img src="${u.photo || 'https://via.placeholder.com/60'}"></div>
                        </div>
                        <div class="story-name">${escapeHtml(u.name || 'User').split(' ')[0]}</div>
                    `;
                    row.appendChild(div);
                });
            });
        });
    }

    function openStoryCreator() {
        document.getElementById('storyCreatorOverlay').classList.add('active');
        lucide.createIcons();
    }
    function closeStoryCreator() {
        document.getElementById('storyCreatorOverlay').classList.remove('active');
        document.getElementById('storyTextInput').value = '';
        document.getElementById('storyPhotoInput').value = '';
        document.getElementById('storyPhotoCaption').value = '';
        document.getElementById('storyPhotoPreview').innerHTML = '<div style="text-align:center;color:rgba(255,255,255,0.4);"><div><i data-lucide="camera" style="width:36px;height:36px;vertical-align:middle;color:rgba(255,255,255,0.4);"></i></div><div style="font-size:13px;margin-top:6px;">Tap to choose photo</div></div>';
        storyPhotoData = null;
    }

    function switchStoryType(type, btn) {
        currentStoryType = type;
        document.querySelectorAll('.story-type-tab').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        document.getElementById('story-text-panel').style.display = type === 'text' ? 'block' : 'none';
        document.getElementById('story-photo-panel').style.display = type === 'photo' ? 'block' : 'none';
    }

    function selectStoryBg(el) {
        document.querySelectorAll('.story-bg-sw').forEach(s => s.classList.remove('sel'));
        el.classList.add('sel');
        selectedStoryBg = el.dataset.bg;
    }

    function previewStoryPhoto(input) {
        if (!input.files || !input.files[0]) return;
        const reader = new FileReader();
        reader.onload = e => {
            storyPhotoData = e.target.result;
            document.getElementById('storyPhotoPreview').innerHTML = `<img src="${e.target.result}" style="width:100%;max-height:200px;object-fit:cover;border-radius:10px;">`;
        };
        reader.readAsDataURL(input.files[0]);
    }

    function publishStory() {
        if (!auth.currentUser) return showToast('Please login first');
        const uid = auth.currentUser.uid;
        let storyData = {
            uid, timestamp: Date.now(), type: currentStoryType
        };

        if (currentStoryType === 'text') {
            const txt = document.getElementById('storyTextInput').value.trim();
            if (!txt) return showToast('Write something for your story!');
            storyData.text = txt;
            storyData.bg = selectedStoryBg;
        } else {
            if (!storyPhotoData) return showToast('Choose a photo first!');
            const caption = document.getElementById('storyPhotoCaption').value.trim();
            storyData.image = storyPhotoData;
            storyData.caption = caption;
        }

        db.ref('stories').push(storyData).then(() => {
            closeStoryCreator();
            showToast('Story posted! Visible for 24 hours.');
            playSound('pop');
            loadStories();
        });
    }

    function openStoryViewer(stories, author) {
        currentStoryGroup = stories;
        currentStoryIdx = 0;
        document.getElementById('storyViewer').classList.add('active');
        document.getElementById('storyAuthorAvatar').src = author.photo || 'https://via.placeholder.com/40';
        document.getElementById('storyAuthorName').textContent = author.name || 'User';
        renderStory(currentStoryIdx, author);

        // Mark as seen
        if (auth.currentUser) {
            stories.forEach(s => {
                db.ref(`stories/${s.key}/seenBy/${auth.currentUser.uid}`).set(true);
            });
        }
    }

    function renderStory(idx, author) {
        clearInterval(storyProgressInterval);
        clearTimeout(storyTimer);

        const s = currentStoryGroup[idx];
        if (!s) { closeStoryViewer(); return; }

        // Update time
        const diff = Date.now() - s.timestamp;
        const hrs = Math.floor(diff / 3600000);
        const mins = Math.floor(diff / 60000);
        document.getElementById('storyTimeAgo').textContent = hrs > 0 ? `${hrs}h ago` : `${mins}m ago`;

        // Progress bars
        const barsEl = document.getElementById('storyProgressBars');
        barsEl.innerHTML = currentStoryGroup.map((_, i) =>
            `<div class="story-prog-bar"><div class="story-prog-fill${i < idx ? ' done' : ''}" id="spf-${i}"></div></div>`
        ).join('');

        // Media
        const mediaEl = document.getElementById('storyMediaArea');
        if (s.type === 'photo' && s.image) {
            document.getElementById('storyViewerBg').style.backgroundImage = `url(${s.image})`;
            mediaEl.innerHTML = `
                <img src="${s.image}" style="max-width:100%;max-height:68vh;border-radius:14px;object-fit:contain;">
                ${s.caption ? `<div class="story-text-over">${escapeHtml(s.caption)}</div>` : ''}
                <div class="story-tap-zones"><div class="story-tap-l" onclick="prevStory()"></div><div class="story-tap-r" onclick="nextStory()"></div></div>
            `;
        } else {
            // Text story
            document.getElementById('storyViewerBg').style.backgroundImage = 'none';
            document.getElementById('storyViewerBg').style.background = s.bg || '#0f172a';
            mediaEl.innerHTML = `
                <div class="story-pure-text" style="background:${s.bg||'transparent'};width:100%;min-height:40vh;display:flex;align-items:center;justify-content:center;border-radius:16px;">${escapeHtml(s.text || '')}</div>
                <div class="story-tap-zones" style="position:absolute;inset:0;display:flex;pointer-events:none;"><div class="story-tap-l" style="pointer-events:all;" onclick="prevStory()"></div><div class="story-tap-r" style="pointer-events:all;" onclick="nextStory()"></div></div>
            `;
        }

        // Progress animation
        let elapsed = 0;
        const fillEl = document.getElementById('spf-' + idx);
        storyProgressInterval = setInterval(() => {
            elapsed += 100;
            if (fillEl) fillEl.style.width = Math.min(100, (elapsed / STORY_DURATION) * 100) + '%';
            if (elapsed >= STORY_DURATION) {
                clearInterval(storyProgressInterval);
                nextStory();
            }
        }, 100);
    }

    function nextStory() {
        if (!currentStoryGroup) return;
        if (currentStoryIdx < currentStoryGroup.length - 1) {
            currentStoryIdx++;
            renderStory(currentStoryIdx);
        } else {
            closeStoryViewer();
        }
    }

    function prevStory() {
        if (currentStoryIdx > 0) {
            currentStoryIdx--;
            renderStory(currentStoryIdx);
        }
    }

    function closeStoryViewer() {
        clearInterval(storyProgressInterval);
        clearTimeout(storyTimer);
        document.getElementById('storyViewer').classList.remove('active');
        currentStoryGroup = [];
        currentStoryIdx = 0;
    }

    function sendStoryReply() {
        const inp = document.getElementById('storyReplyInput');
        const msg = inp.value.trim();
        if (!msg || !currentStoryGroup[currentStoryIdx]) return;
        const s = currentStoryGroup[currentStoryIdx];
        db.ref(`notifications/${s.uid}`).push({
            msg: `${userData.name} replied to your story: "${msg}"`,
            time: Date.now(), type: 'story_reply', from: auth.currentUser.uid
        });
        inp.value = '';
        showToast('Reply sent!');
    }

    // ================================================
    //  POLLS SYSTEM
    // ================================================
    let pollActive = false;

    function togglePollCreator() {
        const box = document.getElementById('pollCreatorBox');
        pollActive = !pollActive;
        box.classList.toggle('open', pollActive);
        if (pollActive) {
            document.getElementById('pollToggleBtn').style.color = 'var(--accent)';
        } else {
            document.getElementById('pollToggleBtn').style.color = '';
            document.getElementById('pollQuestion').value = '';
            document.querySelectorAll('.poll-opt-input').forEach((inp, i) => { inp.value = ''; });
        }
        lucide.createIcons();
    }

    function addPollOption() {
        const container = document.getElementById('pollOptionsContainer');
        if (container.children.length >= 4) { showToast('Max 4 options!'); return; }
        const row = document.createElement('div');
        row.className = 'poll-opt-row';
        row.innerHTML = `<input type="text" placeholder="Option ${container.children.length + 1}" class="poll-opt-input"><button class="poll-rem-btn" onclick="removePollOption(this)"></button>`;
        container.appendChild(row);
    }

    function removePollOption(btn) {
        const container = document.getElementById('pollOptionsContainer');
        if (container.children.length <= 2) { showToast('Need at least 2 options!'); return; }
        btn.closest('.poll-opt-row').remove();
    }

    function getPollData() {
        if (!pollActive) return null;
        const question = document.getElementById('pollQuestion').value.trim();
        if (!question) { showToast('Enter a poll question!'); return false; }
        const options = [...document.querySelectorAll('.poll-opt-input')]
            .map(i => i.value.trim()).filter(v => v);
        if (options.length < 2) { showToast('Need at least 2 options!'); return false; }
        return { question, options };
    }

    function renderPollCard(post, postKey) {
        if (!post.poll) return '';
        const poll = post.poll;
        const myUid = auth.currentUser ? auth.currentUser.uid : null;
        const myVote = myUid && poll.votes ? poll.votes[myUid] : null;
        const totalVotes = poll.votes ? Object.keys(poll.votes).length : 0;

        const optsHtml = poll.options.map((opt, i) => {
            const voteCount = poll.votes ? Object.values(poll.votes).filter(v => v === i).length : 0;
            const pct = totalVotes > 0 ? Math.round((voteCount / totalVotes) * 100) : 0;
            const isMyVote = myVote === i;
            const isWinner = myVote !== null && voteCount === Math.max(...poll.options.map((_, j) => Object.values(poll.votes || {}).filter(v => v === j).length));
            return `
                <div class="poll-option${isMyVote ? ' my-vote' : ''}${isWinner && myVote !== null ? ' winner-opt' : ''}" onclick="votePoll('${postKey}', ${i})">
                    <div class="poll-opt-bg" style="width:${myVote !== null ? pct : 0}%;"></div>
                    <div class="poll-opt-lbl">
                        <span>${escapeHtml(opt)}</span>
                        <span>${myVote !== null ? `<span class="poll-pct">${pct}%</span>` : ''}${isMyVote ? ' <span class="poll-check"><i data-lucide="check" style="width:10px;height:10px;color:white;vertical-align:middle;"></i></span>' : ''}</span>
                    </div>
                </div>`;
        }).join('');

        return `<div class="poll-card">
            <div class="poll-question">${escapeHtml(poll.question)}</div>
            ${optsHtml}
            <div class="poll-total-votes">${totalVotes} ${totalVotes === 1 ? 'vote' : 'votes'}</div>
        </div>`;
    }

    function votePoll(postKey, optionIdx) {
        if (!auth.currentUser) return showToast('Login to vote!');
        const myUid = auth.currentUser.uid;
        db.ref(`socialPosts/${postKey}/poll/votes/${myUid}`).set(optionIdx).then(() => {
            showToast('Vote recorded!');
            playSound('pop');
        });
    }

    // ================================================
    //  BOOKMARKS SYSTEM
    // ================================================
    function toggleBookmark(postKey) {
        if (!auth.currentUser) return showToast('Login first!');
        const myUid = auth.currentUser.uid;
        const ref = db.ref(`bookmarks/${myUid}/${postKey}`);
        ref.once('value', snap => {
            if (snap.exists()) {
                ref.remove();
                showToast('Bookmark removed');
                updateBookmarkBtn(postKey, false);
            } else {
                ref.set({ savedAt: Date.now() });
                showToast('Post saved!');
                playSound('pop');
                updateBookmarkBtn(postKey, true);
            }
        });
    }

    function updateBookmarkBtn(postKey, saved) {
        const btn = document.querySelector(`.bk-btn-${postKey}`);
        if (btn) {
            btn.classList.toggle('bk-saved', saved);
        }
    }

    function openBookmarks() {
        document.getElementById('bookmarksPage').classList.add('active');
        loadBookmarks();
        lucide.createIcons();
    }

    function closeBookmarks() {
        document.getElementById('bookmarksPage').classList.remove('active');
    }

    function loadBookmarks() {
        if (!auth.currentUser) return;
        const myUid = auth.currentUser.uid;
        const body = document.getElementById('bookmarksBody');
        body.innerHTML = `<div style="text-align:center;padding:40px;opacity:0.4;">Loading...</div>`;

        db.ref(`bookmarks/${myUid}`).orderByChild('savedAt').once('value', snap => {
            if (!snap.exists()) {
                body.innerHTML = `<div class="bookmarks-empty"><div><i data-lucide="bookmark" style="width:50px;height:50px;vertical-align:middle;color:rgba(255,255,255,0.3);"></i></div><div style="font-size:15px;font-weight:700;margin-top:10px;">No saved posts yet</div><div style="font-size:12px;margin-top:6px;opacity:0.6;">Tap the bookmark icon on any post to save it here.</div></div>`;
                document.getElementById('bookmarkCount').textContent = '0 saved';
                return;
            }

            const keys = [];
            snap.forEach(c => keys.push(c.key));
            keys.reverse();
            document.getElementById('bookmarkCount').textContent = `${keys.length} saved`;
            body.innerHTML = '';

            let loaded = 0;
            keys.forEach(postKey => {
                db.ref(`socialPosts/${postKey}`).once('value', pSnap => {
                    loaded++;
                    if (!pSnap.exists() || pSnap.val().deleted) return;
                    const post = { key: postKey, ...pSnap.val() };
                    const div = createPostElement(post, true);
                    body.appendChild(div);
                    loadCommentPreview(postKey);
                    loadReactionSummary(postKey);
                    if (loaded === keys.length) lucide.createIcons();
                });
            });
        });
    }

    // Initialize bookmark states for feed posts
    function initBookmarkStates(postKey) {
        if (!auth.currentUser) return;
        db.ref(`bookmarks/${auth.currentUser.uid}/${postKey}`).once('value', snap => {
            if (snap.exists()) updateBookmarkBtn(postKey, true);
        });
    }

    // ================================================
    // # HASHTAGS & @ MENTIONS
    // ================================================
    function formatPostContent(text) {
        if (!text) return '';
        return escapeHtml(text)
            .replace(/#(\w+)/g, '<span class="hashtag" onclick="exploreHashtag(\'$1\')">#$1</span>')
            .replace(/@(\w+)/g, '<span class="mention" onclick="exploreMention(\'$1\')">@$1</span>');
    }

    function exploreHashtag(tag) {
        document.getElementById('explorerTitle').textContent = `#${tag}`;
        document.getElementById('explorerSubtitle').textContent = 'Loading posts...';
        document.getElementById('hashtagExplorer').classList.add('active');
        loadTrendingTags();
        loadHashtagFeed(tag);
        lucide.createIcons();
    }

    function exploreMention(name) {
        // Find user by name and open profile
        db.ref('users').orderByChild('name').equalTo(name).limitToFirst(1).once('value', snap => {
            if (snap.exists()) {
                const uid = Object.keys(snap.val())[0];
                openUserProfile(uid);
            } else {
                showToast(`@${name} not found`);
            }
        });
    }

    function closeHashtagExplorer() {
        document.getElementById('hashtagExplorer').classList.remove('active');
    }

    function loadTrendingTags() {
        const container = document.getElementById('trendingTagsRow');
        container.innerHTML = '';
        // Count hashtag usage across recent posts
        const tagCounts = {};
        db.ref('socialPosts').limitToLast(100).once('value', snap => {
            snap.forEach(c => {
                const content = c.val().content || '';
                const matches = content.match(/#(\w+)/g);
                if (matches) matches.forEach(m => {
                    const t = m.slice(1).toLowerCase();
                    tagCounts[t] = (tagCounts[t] || 0) + 1;
                });
            });
            const sorted = Object.entries(tagCounts).sort((a,b) => b[1]-a[1]).slice(0, 12);
            container.innerHTML = sorted.length > 0
                ? sorted.map(([tag, count]) =>
                    `<div class="tag-chip" onclick="exploreHashtag('${tag}')"><span>#${tag}</span><span class="tag-count">${count}</span></div>`
                  ).join('')
                : '<div style="padding:12px;opacity:0.4;font-size:13px;">No hashtags yet  use #hashtag in your posts!</div>';
        });
    }

    function loadHashtagFeed(tag) {
        const container = document.getElementById('hashtagFeed');
        container.innerHTML = `<div style="text-align:center;padding:40px;opacity:0.4;">Searching for #${tag}...</div>`;
        document.getElementById('explorerSubtitle').textContent = `Posts with #${tag}`;

        db.ref('socialPosts').limitToLast(200).once('value', snap => {
            const posts = [];
            snap.forEach(c => {
                const p = c.val();
                if (!p.deleted && p.content && p.content.toLowerCase().includes(`#${tag.toLowerCase()}`)) {
                    posts.push({ key: c.key, ...p });
                }
            });

            document.getElementById('explorerSubtitle').textContent = `${posts.length} posts with #${tag}`;

            if (posts.length === 0) {
                container.innerHTML = `<div style="text-align:center;padding:60px 20px;opacity:0.4;"><div style="font-size:40px;">#</div><div style="font-size:15px;font-weight:700;margin-top:8px;">No posts with #${tag} yet</div><div style="font-size:12px;margin-top:6px;">Be the first to use this hashtag!</div></div>`;
                return;
            }

            container.innerHTML = '';
            posts.reverse().forEach(post => {
                const div = createPostElement(post, true);
                container.appendChild(div);
                loadCommentPreview(post.key);
                loadReactionSummary(post.key);
            });
            setTimeout(() => lucide.createIcons(), 300);
        });
    }

    // Autocomplete for hashtags/mentions in post textarea
    (function setupAutoComplete() {
        const textarea = document.getElementById('postInput');
        if (!textarea) return;

        let dropdown = null;
        let lastTrigger = null;

        function destroyDropdown() {
            if (dropdown) { dropdown.remove(); dropdown = null; lastTrigger = null; }
        }

        textarea.addEventListener('input', function() {
            const val = this.value;
            const cursor = this.selectionStart;
            const textUpToCursor = val.slice(0, cursor);
            const hashMatch = textUpToCursor.match(/#(\w*)$/);
            const mentionMatch = textUpToCursor.match(/@(\w*)$/);

            if (hashMatch) {
                const query = hashMatch[1].toLowerCase();
                lastTrigger = '#';
                showTagAutocomplete(query, this);
            } else if (mentionMatch) {
                const query = mentionMatch[1].toLowerCase();
                lastTrigger = '@';
                showMentionAutocomplete(query, this);
            } else {
                destroyDropdown();
            }
        });

        textarea.addEventListener('blur', () => setTimeout(destroyDropdown, 200));

        function getDropdown(anchorEl) {
            if (!dropdown) {
                dropdown = document.createElement('div');
                dropdown.className = 'autocomplete-drop';
                const rect = anchorEl.getBoundingClientRect();
                dropdown.style.cssText = `position:fixed;bottom:${window.innerHeight - rect.top + 4}px;left:${rect.left}px;width:${Math.min(250, rect.width)}px;`;
                document.body.appendChild(dropdown);
            }
            return dropdown;
        }

        function showTagAutocomplete(query, anchorEl) {
            db.ref('socialPosts').limitToLast(100).once('value', snap => {
                const tags = new Set();
                snap.forEach(c => {
                    const content = c.val().content || '';
                    const matches = content.match(/#(\w+)/g);
                    if (matches) matches.forEach(m => {
                        if (m.slice(1).toLowerCase().startsWith(query)) tags.add(m.slice(1));
                    });
                });
                const arr = [...tags].slice(0, 6);
                if (arr.length === 0) { destroyDropdown(); return; }
                const dd = getDropdown(anchorEl);
                dd.innerHTML = arr.map(t => `<div class="ac-item" onmousedown="insertTag('#${t}')"><span style="color:var(--accent);font-weight:900;">#</span>${t}</div>`).join('');
            });
        }

        function showMentionAutocomplete(query, anchorEl) {
            if (query.length < 1) { destroyDropdown(); return; }
            db.ref('users').orderByChild('name').limitToFirst(30).once('value', snap => {
                const matches = [];
                snap.forEach(c => {
                    const u = c.val();
                    if (u.name && u.name.toLowerCase().includes(query.toLowerCase())) {
                        matches.push({ uid: c.key, name: u.name, photo: u.photo });
                    }
                });
                const top = matches.slice(0, 5);
                if (top.length === 0) { destroyDropdown(); return; }
                const dd = getDropdown(anchorEl);
                dd.innerHTML = top.map(u => `<div class="ac-item" onmousedown="insertTag('@${u.name.replace(/\s/g,'')}')"><img src="${u.photo||'https://via.placeholder.com/24'}" style="width:24px;height:24px;border-radius:50%;object-fit:cover;"><span style="color:#a78bfa;">@</span>${escapeHtml(u.name)}</div>`).join('');
            });
        }

        window.insertTag = function(tag) {
            const val = textarea.value;
            const cursor = textarea.selectionStart;
            const before = val.slice(0, cursor).replace(lastTrigger === '#' ? /#\w*$/ : /@\w*$/, '');
            textarea.value = before + tag + ' ' + val.slice(cursor);
            textarea.focus();
            destroyDropdown();
        };
    })();

    // Load stories and init bookmark states after auth
    const _origInitSocial = window.initSocialSystem;
    window.initSocialSystem = function(uid) {
        if (_origInitSocial) _origInitSocial(uid);
        setTimeout(() => {
            loadStories();
            // Update avatar in story add button
            if (userData && userData.photo) {
                const av = document.getElementById('myStoryAvatar');
                if (av) av.src = userData.photo;
            }
        }, 1000);
    };
</script>

<!-- ============================================
     DAILY LOGIN STREAK MODAL
============================================ -->
<div class="streak-modal-overlay" id="streakModalOverlay">
    <div class="streak-modal">
        <div id="streakModalBody"></div>
    </div>
</div>

<!-- ============================================
     LEADERBOARD PAGE
============================================ -->
<div class="leaderboard-page" id="leaderboardPage">
    <div class="leaderboard-header">
        <button onclick="closeLeaderboard()" style="background:rgba(255,255,255,0.1);border:none;color:white;border-radius:10px;width:36px;height:36px;display:flex;align-items:center;justify-content:center;cursor:pointer;flex-shrink:0;">
            <i data-lucide="arrow-left" style="width:18px;"></i>
        </button>
        <div>
            <div style="font-size:18px;font-weight:900;color:white;"><i data-lucide="trophy" style="width:18px;height:18px;vertical-align:middle;color:#fbbf24;"></i> Leaderboard</div>
            <div style="font-size:11px;color:rgba(255,255,255,0.5);">Top players in RB Live</div>
        </div>
    </div>
    <div class="lb-tabs">
        <button class="lb-tab active" id="lb-tab-wins"     onclick="switchLbTab('wins')"><i data-lucide="trophy" style="width:14px;height:14px;vertical-align:middle;color:#fbbf24;"></i> Bingo Wins</button>
        <button class="lb-tab"        id="lb-tab-points"   onclick="switchLbTab('points')"><i data-lucide="coins" style="width:14px;height:14px;vertical-align:middle;color:#fbbf24;"></i> Most Coins</button>
        <button class="lb-tab"        id="lb-tab-streak"   onclick="switchLbTab('streak')"><i data-lucide="flame" style="width:14px;height:14px;vertical-align:middle;color:#f87171;"></i> Best Streak</button>
        <button class="lb-tab"        id="lb-tab-creators" onclick="switchLbTab('creators')"><i data-lucide="star" style="width:14px;height:14px;vertical-align:middle;color:#fbbf24;"></i> Creators</button>
    </div>
    <div class="leaderboard-body">
        <div id="lbContent"></div>
    </div>
</div>

<!-- ============================================
     TOURNAMENT PAGE
============================================ -->
<div class="tournament-page" id="tournamentPage">
    <div class="tournament-header">
        <button onclick="closeTournaments()" style="background:rgba(255,255,255,0.1);border:none;color:white;border-radius:10px;width:36px;height:36px;display:flex;align-items:center;justify-content:center;cursor:pointer;flex-shrink:0;">
            <i data-lucide="arrow-left" style="width:18px;"></i>
        </button>
        <div style="flex:1;">
            <div style="font-size:18px;font-weight:900;color:white;"><i data-lucide="trophy" style="width:18px;height:18px;vertical-align:middle;color:#fbbf24;"></i> Tournaments</div>
            <div style="font-size:11px;color:rgba(255,255,255,0.5);">Compete for big prizes!</div>
        </div>
        <div style="text-align:right;">
            <div style="font-size:11px;color:rgba(255,255,255,0.4);">Your Coins</div>
            <div style="font-size:16px;font-weight:900;color:#fbbf24;" id="tournCoinsDisplay">0 <i data-lucide="coins" style="width:14px;height:14px;vertical-align:middle;color:#fbbf24;"></i></div>
        </div>
    </div>
    <div class="tournament-body">
        <div class="tourn-tab-nav">
            <button class="tourn-tab-btn active" id="ttab-upcoming" onclick="switchTournTab('upcoming')"><i data-lucide="calendar" style="width:14px;height:14px;vertical-align:middle;color:#38bdf8;"></i> Upcoming</button>
            <button class="tourn-tab-btn"        id="ttab-live"     onclick="switchTournTab('live')"><span style="display:inline-block;width:8px;height:8px;background:#ef4444;border-radius:50%;margin-right:4px;animation:pulse-ring 1.5s infinite;"></span> Live</button>
            <button class="tourn-tab-btn"        id="ttab-finished" onclick="switchTournTab('finished')"><i data-lucide="check-circle" style="width:14px;height:14px;vertical-align:middle;color:#10b981;"></i> Finished</button>
        </div>
        <div id="tournContent"></div>
    </div>
</div>

<!-- ====================================
      STORY VIEWER
==================================== -->
<div class="story-viewer" id="storyViewer">
    <div class="story-viewer-bg" id="storyViewerBg"></div>
    <div class="story-viewer-content">
        <div class="story-progress-bars" id="storyProgressBars"></div>
        <div class="story-hdr">
            <img class="story-av" id="storyAuthorAvatar" src="">
            <div>
                <div id="storyAuthorName" style="font-size:14px;font-weight:700;color:white;"></div>
                <div id="storyTimeAgo" style="font-size:11px;color:rgba(255,255,255,0.5);"></div>
            </div>
            <button class="story-close" onclick="closeStoryViewer()"></button>
        </div>
        <div class="story-media-area" id="storyMediaArea">
            <div class="story-tap-zones">
                <div class="story-tap-l" onclick="prevStory()"></div>
                <div class="story-tap-r" onclick="nextStory()"></div>
            </div>
        </div>
        <div class="story-footer">
            <input class="story-reply-inp" id="storyReplyInput" placeholder="Reply to story..." onkeypress="if(event.key==='Enter') sendStoryReply()">
            <button onclick="sendStoryReply()" style="background:none;border:none;color:white;cursor:pointer;"><i data-lucide="send" style="width:22px;"></i></button>
        </div>
    </div>
</div>

<!-- ====================================
      STORY CREATOR
==================================== -->
<div class="story-creator-overlay" id="storyCreatorOverlay">
    <div class="story-creator-box">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;">
            <div style="font-size:16px;font-weight:900;color:white;"><i data-lucide="camera" style="width:16px;height:16px;vertical-align:middle;color:#38bdf8;"></i> Add Story</div>
            <button onclick="closeStoryCreator()" style="background:rgba(255,255,255,0.1);border:none;color:white;border-radius:8px;width:32px;height:32px;cursor:pointer;font-size:18px;"></button>
        </div>
        <div class="story-type-tabs">
            <button class="story-type-tab active" id="stab-text" onclick="switchStoryType('text',this)"><i data-lucide="pen-line" style="width:14px;height:14px;vertical-align:middle;"></i> Text</button>
            <button class="story-type-tab" id="stab-photo" onclick="switchStoryType('photo',this)"><i data-lucide="image" style="width:14px;height:14px;vertical-align:middle;"></i> Photo</button>
        </div>

        <!-- Text Story -->
        <div id="story-text-panel">
            <textarea id="storyTextInput" placeholder="What's happening?" rows="4" style="width:100%;background:rgba(255,255,255,0.06);border:1px solid rgba(255,255,255,0.15);border-radius:10px;padding:12px;color:white;font-size:16px;font-weight:700;resize:none;outline:none;font-family:inherit;"></textarea>
            <div style="font-size:11px;color:rgba(255,255,255,0.4);margin:8px 0 4px;">Background</div>
            <div class="story-bg-opts" id="storyBgOpts">
                <div class="story-bg-sw sel" style="background:linear-gradient(135deg,#0f172a,#1e293b);" data-bg="linear-gradient(135deg,#0f172a,#1e293b)" onclick="selectStoryBg(this)"></div>
                <div class="story-bg-sw" style="background:linear-gradient(135deg,#7c3aed,#4f46e5);" data-bg="linear-gradient(135deg,#7c3aed,#4f46e5)" onclick="selectStoryBg(this)"></div>
                <div class="story-bg-sw" style="background:linear-gradient(135deg,#0ea5e9,#06b6d4);" data-bg="linear-gradient(135deg,#0ea5e9,#06b6d4)" onclick="selectStoryBg(this)"></div>
                <div class="story-bg-sw" style="background:linear-gradient(135deg,#f59e0b,#ef4444);" data-bg="linear-gradient(135deg,#f59e0b,#ef4444)" onclick="selectStoryBg(this)"></div>
                <div class="story-bg-sw" style="background:linear-gradient(135deg,#10b981,#059669);" data-bg="linear-gradient(135deg,#10b981,#059669)" onclick="selectStoryBg(this)"></div>
                <div class="story-bg-sw" style="background:linear-gradient(135deg,#ec4899,#8b5cf6);" data-bg="linear-gradient(135deg,#ec4899,#8b5cf6)" onclick="selectStoryBg(this)"></div>
            </div>
        </div>

        <!-- Photo Story -->
        <div id="story-photo-panel" style="display:none;">
            <div id="storyPhotoPreview" style="background:rgba(255,255,255,0.05);border:2px dashed rgba(255,255,255,0.15);border-radius:12px;min-height:150px;display:flex;align-items:center;justify-content:center;cursor:pointer;overflow:hidden;" onclick="document.getElementById('storyPhotoInput').click()">
                <div style="text-align:center;color:rgba(255,255,255,0.4);">
                    <div><i data-lucide="camera" style="width:36px;height:36px;vertical-align:middle;color:rgba(255,255,255,0.4);"></i></div>
                    <div style="font-size:13px;margin-top:6px;">Tap to choose photo</div>
                </div>
            </div>
            <input type="file" id="storyPhotoInput" accept="image/*" style="display:none;" onchange="previewStoryPhoto(this)">
            <input type="text" id="storyPhotoCaption" placeholder="Add caption..." style="width:100%;background:rgba(255,255,255,0.06);border:1px solid rgba(255,255,255,0.15);border-radius:8px;padding:10px 12px;color:white;font-size:13px;outline:none;margin-top:10px;">
        </div>

        <button onclick="publishStory()" style="width:100%;padding:14px;background:linear-gradient(135deg,var(--accent),#38bdf8);border:none;border-radius:12px;color:white;font-size:14px;font-weight:900;cursor:pointer;margin-top:14px;letter-spacing:0.5px;">
            <i data-lucide="zap" style="width:16px;vertical-align:middle;"></i> SHARE STORY
        </button>
    </div>
</div>

<!-- ====================================
      BOOKMARKS PAGE
==================================== -->
<div class="bookmarks-page" id="bookmarksPage">
    <div class="bookmarks-hdr">
        <button onclick="closeBookmarks()" style="background:rgba(255,255,255,0.1);border:none;color:white;border-radius:10px;width:36px;height:36px;display:flex;align-items:center;justify-content:center;cursor:pointer;flex-shrink:0;">
            <i data-lucide="arrow-left" style="width:18px;"></i>
        </button>
        <div>
            <div style="font-size:18px;font-weight:900;color:white;"><i data-lucide="bookmark" style="width:18px;height:18px;vertical-align:middle;color:#38bdf8;"></i> Saved Posts</div>
            <div id="bookmarkCount" style="font-size:11px;color:rgba(255,255,255,0.4);">0 saved</div>
        </div>
    </div>
    <div class="bookmarks-body" id="bookmarksBody">
        <div class="bookmarks-empty">
            <div><i data-lucide="bookmark" style="width:50px;height:50px;vertical-align:middle;color:rgba(255,255,255,0.3);"></i></div>
            <div style="font-size:15px;font-weight:700;margin-top:10px;">No saved posts yet</div>
            <div style="font-size:12px;margin-top:6px;opacity:0.6;">Tap the bookmark icon on any post to save it here.</div>
        </div>
    </div>
</div>

<!-- ====================================
     # HASHTAG EXPLORER
==================================== -->
<div class="hashtag-explorer" id="hashtagExplorer">
    <div class="hashtag-explorer-hdr">
        <button onclick="closeHashtagExplorer()" style="background:rgba(255,255,255,0.1);border:none;color:white;border-radius:10px;width:36px;height:36px;display:flex;align-items:center;justify-content:center;cursor:pointer;flex-shrink:0;">
            <i data-lucide="arrow-left" style="width:18px;"></i>
        </button>
        <div style="flex:1;">
            <div style="font-size:18px;font-weight:900;color:white;" id="explorerTitle"># Hashtags</div>
            <div style="font-size:11px;color:rgba(255,255,255,0.4);" id="explorerSubtitle">Trending topics</div>
        </div>
    </div>
    <div class="hashtag-explorer-body">
        <div class="trending-tags-row" id="trendingTagsRow"></div>
        <div id="hashtagFeed" style="padding:0 0 20px;"></div>
    </div>
</div>
<!-- ===== CAMERA PAGE ===== -->


<!-- ===== RB STORE PAGE ===== -->
<div class="rbstore-page" id="rbStorePage">
    <!-- Header -->
    <div class="rbstore-header">
        <div class="rbstore-toprow">
            <button class="rbstore-back-btn" onclick="closeStorePage()">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M19 12H5M12 5l-7 7 7 7"/></svg>
            </button>
            <div class="rbstore-title">RB STORE</div>
            <div class="rbstore-coins-badge">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="#fbbf24" stroke="#f59e0b" stroke-width="1"><circle cx="12" cy="12" r="10"/><path d="M12 6v12M9 9h4.5a2.5 2.5 0 010 5H9" stroke="white" stroke-width="1.5" fill="none"/></svg>
                <span id="rbStoreCoins">0</span>
            </div>
        </div>
        <div class="rbstore-tabs">
            <button class="rbstore-tab active" onclick="switchStoreSection('cashout')" id="rstab-cashout">Redeem</button>
            <button class="rbstore-tab" onclick="switchStoreSection('wallet')" id="rstab-wallet">Wallet</button>
            <button class="rbstore-tab" onclick="switchStoreSection('vouchers')" id="rstab-vouchers">My Vouchers</button>
            <button class="rbstore-tab" onclick="switchStoreSection('partners')" id="rstab-partners">Partner Stores</button>
            <button class="rbstore-tab" onclick="switchStoreSection('myshop')" id="rstab-myshop" style="color:#f472b6;"> My Shop</button>
            <button class="rbstore-tab" onclick="switchStoreSection('history')" id="rstab-history">Coin History</button>
        </div>
    </div>

    <!-- Body -->
    <div class="rbstore-body">

        <!-- === VOUCHER REDEEM SECTION === -->
        <div id="rs-section-cashout">
            <div class="section-label">REDEEM VOUCHER  For Partner Stores</div>
            <div style="background:rgba(16,185,129,0.08);border:1px solid rgba(16,185,129,0.2);border-radius:10px;padding:10px 14px;margin-bottom:14px;font-size:11px;color:rgba(255,255,255,0.6);display:flex;align-items:center;gap:8px;">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="#10b981" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>
                <span>Redeem at our <b style="color:#10b981;">Partner Stores</b>  valid for groceries, food, and other products. This is <b style="color:#fbbf24;">not cash</b>, it is a voucher for goods.</span>
            </div>

            <!-- Store Voucher Cards -->
            <div style="margin-bottom:10px;font-size:11px;font-weight:800;color:rgba(255,255,255,0.35);letter-spacing:1px;text-transform:uppercase;display:flex;align-items:center;gap:8px;">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="rgba(255,255,255,0.35)" stroke-width="2"><path d="M20 12V22H4V12"/><path d="M22 7H2v5h20V7z"/><path d="M12 22V7"/><path d="M12 7H7.5a2.5 2.5 0 010-5C11 2 12 7 12 7z"/><path d="M12 7h4.5a2.5 2.5 0 000-5C13 2 12 7 12 7z"/></svg>
                STORE VOUCHERS
            </div>
            <!-- Store Voucher Cards -->
            <div class="giftcard-grid" style="margin-bottom:20px;">

                <div class="giftcard-item" style="background:linear-gradient(135deg,#065f46,#10b981);" onclick="redeemGiftCard('Voucher','20','Store Voucher',50000,'voucher','#065f46','#10b981')">
                    <div class="giftcard-inner">
                        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px;">
                            <span style="font-size:20px;line-height:1;"></span>
                            <span style="background:rgba(0,0,0,0.35);border:1px solid rgba(255,255,255,0.2);border-radius:6px;padding:2px 8px;font-size:9px;font-weight:800;color:white;letter-spacing:1px;text-transform:uppercase;">Starter</span>
                        </div>
                        <div class="giftcard-brand">STORE VOUCHER</div>
                        <div class="giftcard-value">20</div>
                        <div class="giftcard-cost">
                            <svg width="11" height="11" viewBox="0 0 24 24" fill="#fbbf24"><circle cx="12" cy="12" r="10"/><path d="M12 6v12M9 9h4.5a2.5 2.5 0 010 5H9" stroke="white" stroke-width="1.5" fill="none"/></svg>
                            50,000
                        </div>
                        <button class="giftcard-btn can-redeem" onclick="event.stopPropagation();redeemGiftCard('Voucher','20','Store Voucher',50000,'voucher','#065f46','#10b981')">Redeem</button>
                    </div>
                </div>

                <div class="giftcard-item" style="background:linear-gradient(135deg,#1d4ed8,#3b82f6);" onclick="redeemGiftCard('Voucher','50','Store Voucher',150000,'voucher','#1d4ed8','#3b82f6')">
                    <div class="giftcard-inner">
                        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px;">
                            <span style="font-size:20px;line-height:1;"></span>
                            <span style="background:rgba(0,0,0,0.35);border:1px solid rgba(255,255,255,0.2);border-radius:6px;padding:2px 8px;font-size:9px;font-weight:800;color:white;letter-spacing:1px;text-transform:uppercase;">Popular</span>
                        </div>
                        <div class="giftcard-brand">STORE VOUCHER</div>
                        <div class="giftcard-value">50</div>
                        <div class="giftcard-cost">
                            <svg width="11" height="11" viewBox="0 0 24 24" fill="#fbbf24"><circle cx="12" cy="12" r="10"/><path d="M12 6v12M9 9h4.5a2.5 2.5 0 010 5H9" stroke="white" stroke-width="1.5" fill="none"/></svg>
                            150,000
                        </div>
                        <button class="giftcard-btn can-redeem" onclick="event.stopPropagation();redeemGiftCard('Voucher','50','Store Voucher',150000,'voucher','#1d4ed8','#3b82f6')">Redeem</button>
                    </div>
                </div>

                <div class="giftcard-item" style="background:linear-gradient(135deg,#7c3aed,#a855f7);" onclick="redeemGiftCard('Voucher','100','Store Voucher',250000,'voucher','#7c3aed','#a855f7')">
                    <div class="giftcard-inner">
                        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px;">
                            <span style="font-size:20px;line-height:1;"></span>
                            <span style="background:rgba(0,0,0,0.35);border:1px solid rgba(255,255,255,0.2);border-radius:6px;padding:2px 8px;font-size:9px;font-weight:800;color:white;letter-spacing:1px;text-transform:uppercase;">Best Value</span>
                        </div>
                        <div class="giftcard-brand">STORE VOUCHER</div>
                        <div class="giftcard-value">100</div>
                        <div class="giftcard-cost">
                            <svg width="11" height="11" viewBox="0 0 24 24" fill="#fbbf24"><circle cx="12" cy="12" r="10"/><path d="M12 6v12M9 9h4.5a2.5 2.5 0 010 5H9" stroke="white" stroke-width="1.5" fill="none"/></svg>
                            250,000
                        </div>
                        <button class="giftcard-btn can-redeem" onclick="event.stopPropagation();redeemGiftCard('Voucher','100','Store Voucher',250000,'voucher','#7c3aed','#a855f7')">Redeem</button>
                    </div>
                </div>

                <div class="giftcard-item" style="background:linear-gradient(135deg,#b45309,#f59e0b);" onclick="redeemGiftCard('Voucher','200','Store Voucher',500000,'voucher','#b45309','#f59e0b')">
                    <div class="giftcard-inner">
                        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px;">
                            <span style="font-size:20px;line-height:1;"></span>
                            <span style="background:rgba(0,0,0,0.35);border:1px solid rgba(255,255,255,0.2);border-radius:6px;padding:2px 8px;font-size:9px;font-weight:800;color:white;letter-spacing:1px;text-transform:uppercase;">Premium</span>
                        </div>
                        <div class="giftcard-brand">STORE VOUCHER</div>
                        <div class="giftcard-value">200</div>
                        <div class="giftcard-cost">
                            <svg width="11" height="11" viewBox="0 0 24 24" fill="#fbbf24"><circle cx="12" cy="12" r="10"/><path d="M12 6v12M9 9h4.5a2.5 2.5 0 010 5H9" stroke="white" stroke-width="1.5" fill="none"/></svg>
                            500,000
                        </div>
                        <button class="giftcard-btn can-redeem" onclick="event.stopPropagation();redeemGiftCard('Voucher','200','Store Voucher',500000,'voucher','#b45309','#f59e0b')">Redeem</button>
                    </div>
                </div>

            </div>

            <!-- How it works -->
            <div style="background:rgba(251,191,36,0.07);border:1px solid rgba(251,191,36,0.2);border-radius:14px;padding:14px 16px;margin-top:4px;">
                <div style="font-size:12px;font-weight:800;color:#fbbf24;margin-bottom:8px;display:flex;align-items:center;gap:6px;">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="#fbbf24" stroke-width="2.5"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>
                    HOW TO REDEEM
                </div>
                <div style="font-size:11px;color:rgba(255,255,255,0.6);line-height:1.9;">
                    <div style="display:flex;gap:8px;align-items:flex-start;margin-bottom:4px;"><span style="background:rgba(251,191,36,0.2);color:#fbbf24;font-weight:900;min-width:20px;height:20px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:10px;flex-shrink:0;">1</span>Select an amount and tap Redeem</div>
                    <div style="display:flex;gap:8px;align-items:flex-start;margin-bottom:4px;"><span style="background:rgba(251,191,36,0.2);color:#fbbf24;font-weight:900;min-width:20px;height:20px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:10px;flex-shrink:0;">2</span>A QR Code and Voucher Code will be generated</div>
                    <div style="display:flex;gap:8px;align-items:flex-start;margin-bottom:4px;"><span style="background:rgba(251,191,36,0.2);color:#fbbf24;font-weight:900;min-width:20px;height:20px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:10px;flex-shrink:0;">3</span>Visit the nearest <b style="color:#fbbf24;">Partner Store</b> and show your voucher to the cashier</div>
                    <div style="display:flex;gap:8px;align-items:flex-start;"><span style="background:rgba(251,191,36,0.2);color:#fbbf24;font-weight:900;min-width:20px;height:20px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:10px;flex-shrink:0;">4</span>Each voucher is valid for one-time use</div>
                </div>
            </div>
        </div>

        <!-- === MY VOUCHERS SECTION === -->
        <div id="rs-section-vouchers" style="display:none;">
            <div class="section-label">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align:middle;opacity:0.5;"><rect x="1" y="4" width="22" height="16" rx="2"/><line x1="1" y1="10" x2="23" y2="10"/></svg>
                My Vouchers
            </div>
            <div id="rbVouchersList">
                <div style="text-align:center;padding:50px 20px;opacity:0.4;">
                    <svg width="50" height="50" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" style="display:block;margin:0 auto 12px;"><rect x="1" y="4" width="22" height="16" rx="2"/><line x1="1" y1="10" x2="23" y2="10"/></svg>
                    <div style="font-size:14px;font-weight:700;">You have no vouchers yet</div>
                    <div style="font-size:12px;margin-top:6px;opacity:0.7;">Redeem a voucher to get started!</div>
                </div>
            </div>
        </div>

        <!-- === PARTNER STORES  COMING SOON === -->
        <div id="rs-section-partners" style="display:none;">
            <!-- Partner Stores Header -->
            <div style="margin-bottom:16px;">
                <div style="font-size:20px;font-weight:900;color:white;margin-bottom:4px;">Partner Stores</div>
                <div style="font-size:12px;color:rgba(255,255,255,0.45);">Stores that accept RB Vouchers as payment</div>
            </div>

            <!-- Search Bar -->
            <div style="position:relative;margin-bottom:14px;">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="rgba(255,255,255,0.35)" stroke-width="2" style="position:absolute;left:14px;top:50%;transform:translateY(-50%);pointer-events:none;"><circle cx="11" cy="11" r="8"/><path d="M21 21l-4.35-4.35"/></svg>
                <input id="psSearchInput" type="text" placeholder="Search stores..." oninput="filterPartnerStores()" style="width:100%;background:rgba(30,41,59,0.8);border:1px solid rgba(255,255,255,0.1);border-radius:12px;padding:11px 14px 11px 40px;color:white;font-size:13px;outline:none;box-sizing:border-box;font-family:Inter,sans-serif;">
            </div>

            <!-- Category Filter Chips -->
            <div id="psCategoryChips" style="display:flex;gap:8px;overflow-x:auto;padding-bottom:4px;margin-bottom:16px;scrollbar-width:none;">
                <button class="ps-chip active" onclick="setPSCategory('all', this)">All</button>
                <button class="ps-chip" onclick="setPSCategory('sari-sari', this)"> Sari-Sari Store</button>
                <button class="ps-chip" onclick="setPSCategory('grocery', this)"> Grocery</button>
                <button class="ps-chip" onclick="setPSCategory('food', this)"> Food</button>
                <button class="ps-chip" onclick="setPSCategory('pharmacy', this)"> Pharmacy</button>
                <button class="ps-chip" onclick="setPSCategory('clothing', this)"> Clothing</button>
                <button class="ps-chip" onclick="setPSCategory('electronics', this)"> Electronics</button>
                <button class="ps-chip" onclick="setPSCategory('school', this)"> School</button>
                <button class="ps-chip" onclick="setPSCategory('beauty', this)"> Beauty</button>
                <button class="ps-chip" onclick="setPSCategory('other', this)"> Others</button>
            </div>

            <!-- Store Count Badge -->
            <div id="psStoreCountBadge" style="font-size:11px;color:rgba(255,255,255,0.4);margin-bottom:12px;font-weight:700;letter-spacing:0.5px;"></div>

            <!-- Store List -->
            <div id="psStoreList" style="display:flex;flex-direction:column;gap:12px;">
                <div style="text-align:center;padding:40px 20px;">
                    <div style="font-size:28px;margin-bottom:8px;opacity:0.5;"></div>
                    <div style="font-size:13px;color:rgba(255,255,255,0.3);font-weight:700;">Loading partner stores...</div>
                </div>
            </div>

            <!-- Partner Application Form -->
            <div style="margin-top:24px;">
                <div style="display:flex;align-items:center;gap:10px;margin-bottom:14px;">
                    <div style="flex:1;height:1px;background:rgba(255,255,255,0.1);"></div>
                    <div style="font-size:10px;font-weight:800;color:rgba(255,255,255,0.3);letter-spacing:1.5px;text-transform:uppercase;">Want to join?</div>
                    <div style="flex:1;height:1px;background:rgba(255,255,255,0.1);"></div>
                </div>
                <div style="background:linear-gradient(135deg,rgba(245,158,11,0.08),rgba(236,72,153,0.05));border:1px solid rgba(245,158,11,0.2);border-radius:20px;padding:18px;">
                    <div style="display:flex;align-items:center;gap:10px;margin-bottom:14px;">
                        <div style="width:40px;height:40px;background:linear-gradient(135deg,#f59e0b,#ec4899);border-radius:12px;display:flex;align-items:center;justify-content:center;flex-shrink:0;"></div>
                        <div>
                            <div style="font-size:14px;font-weight:900;color:white;">BECOME A PARTNER STORE</div>
                            <div style="font-size:11px;color:rgba(255,255,255,0.5);">Accept RB Vouchers at your store</div>
                        </div>
                    </div>
                    <div id="partnerFormWrap" style="display:flex;flex-direction:column;gap:10px;">
                        <div>
                            <div style="font-size:10px;font-weight:800;color:rgba(255,255,255,0.4);letter-spacing:1px;text-transform:uppercase;margin-bottom:5px;">Store Name *</div>
                            <input id="pf_storeName" type="text" placeholder="e.g. Juan's Store" style="width:100%;background:rgba(15,23,42,0.6);border:1px solid rgba(255,255,255,0.1);border-radius:10px;padding:11px 14px;color:white;font-size:13px;outline:none;box-sizing:border-box;">
                        </div>
                        <div>
                            <div style="font-size:10px;font-weight:800;color:rgba(255,255,255,0.4);letter-spacing:1px;text-transform:uppercase;margin-bottom:5px;">Store Type *</div>
                            <select id="pf_storeType" style="width:100%;background:rgba(15,23,42,0.9);border:1px solid rgba(255,255,255,0.1);border-radius:10px;padding:11px 14px;color:white;font-size:13px;outline:none;-webkit-appearance:none;box-sizing:border-box;">
                                <option value="" style="background:#1e293b;">Select store type</option>
                                <option value="sari-sari" style="background:#1e293b;"> Sari-Sari Store</option>
                                <option value="grocery" style="background:#1e293b;"> Grocery / Supermarket</option>
                                <option value="food" style="background:#1e293b;"> Food / Restaurant</option>
                                <option value="pharmacy" style="background:#1e293b;"> Pharmacy / Drugstore</option>
                                <option value="clothing" style="background:#1e293b;"> Clothing / Apparel</option>
                                <option value="electronics" style="background:#1e293b;"> Electronics / Gadgets</option>
                                <option value="school" style="background:#1e293b;"> School Supplies</option>
                                <option value="beauty" style="background:#1e293b;"> Beauty / Personal Care</option>
                                <option value="other" style="background:#1e293b;"> Others</option>
                            </select>
                        </div>
                        <div>
                            <div style="font-size:10px;font-weight:800;color:rgba(255,255,255,0.4);letter-spacing:1px;text-transform:uppercase;margin-bottom:5px;">Complete Address *</div>
                            <textarea id="pf_address" placeholder="Blk/Lot, Street, Barangay, City/Municipality, Province" rows="2" style="width:100%;background:rgba(15,23,42,0.6);border:1px solid rgba(255,255,255,0.1);border-radius:10px;padding:11px 14px;color:white;font-size:13px;outline:none;resize:none;box-sizing:border-box;"></textarea>
                        </div>
                        <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;">
                            <div>
                                <div style="font-size:10px;font-weight:800;color:rgba(255,255,255,0.4);letter-spacing:1px;text-transform:uppercase;margin-bottom:5px;">Owner's Name *</div>
                                <input id="pf_ownerName" type="text" placeholder="Full name" style="width:100%;background:rgba(15,23,42,0.6);border:1px solid rgba(255,255,255,0.1);border-radius:10px;padding:11px 14px;color:white;font-size:13px;outline:none;box-sizing:border-box;">
                            </div>
                            <div>
                                <div style="font-size:10px;font-weight:800;color:rgba(255,255,255,0.4);letter-spacing:1px;text-transform:uppercase;margin-bottom:5px;">Contact Number *</div>
                                <input id="pf_contact" type="tel" placeholder="09XXXXXXXXX" style="width:100%;background:rgba(15,23,42,0.6);border:1px solid rgba(255,255,255,0.1);border-radius:10px;padding:11px 14px;color:white;font-size:13px;outline:none;box-sizing:border-box;">
                            </div>
                        </div>
                        <button onclick="submitPartnerApplication()" id="pfSubmitBtn" style="width:100%;padding:14px;background:linear-gradient(135deg,#f59e0b,#ec4899);border:none;border-radius:14px;color:white;font-size:14px;font-weight:900;cursor:pointer;letter-spacing:0.5px;">
                             SUBMIT APPLICATION
                        </button>
                    </div>
                    <div id="partnerFormSuccess" style="display:none;text-align:center;padding:20px;">
                        <div style="font-size:44px;margin-bottom:12px;"></div>
                        <div style="font-size:16px;font-weight:900;color:white;margin-bottom:8px;">APPLICATION RECEIVED!</div>
                        <div style="font-size:12px;color:rgba(255,255,255,0.5);line-height:1.7;">Our team will reach out within 35 business days.</div>
                        <button onclick="resetPartnerForm()" style="margin-top:16px;padding:10px 24px;background:rgba(255,255,255,0.1);border:1px solid rgba(255,255,255,0.2);border-radius:20px;color:white;font-size:12px;font-weight:700;cursor:pointer;">Apply Again</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- === WALLET SECTION === -->
        <div id="rs-section-wallet" style="display:none;">

            <div class="section-label"> Virtual RB Coins Card</div>

            <!-- THE CARD -->
            <div id="rbVirtualCard" onclick="toggleWalletQR()" style="position:relative;background:linear-gradient(135deg,#0ea5e9 0%,#6366f1 55%,#f59e0b 100%);border-radius:20px;padding:22px 22px 18px;box-shadow:0 8px 32px rgba(14,165,233,0.35);overflow:hidden;cursor:pointer;min-height:190px;display:flex;flex-direction:column;justify-content:space-between;margin-bottom:4px;">
                <div style="position:absolute;top:-40px;right:-40px;width:160px;height:160px;border-radius:50%;background:rgba(255,255,255,0.07);pointer-events:none;"></div>
                <div style="position:absolute;bottom:-50px;left:-30px;width:180px;height:180px;border-radius:50%;background:rgba(255,255,255,0.05);pointer-events:none;"></div>
                <div style="display:flex;justify-content:space-between;align-items:center;position:relative;z-index:2;">
                    <div style="display:flex;align-items:center;gap:8px;">
                        <svg width="28" height="28" viewBox="0 0 24 24" fill="#fbbf24" stroke="#f59e0b" stroke-width="0.8"><circle cx="12" cy="12" r="10"/><path d="M12 6v12M9 9h4.5a2.5 2.5 0 010 5H9" stroke="white" stroke-width="1.5" fill="none"/></svg>
                        <div style="font-size:13px;font-weight:900;color:white;letter-spacing:1.5px;">RB COINS</div>
                    </div>
                    <div style="background:rgba(255,255,255,0.15);border-radius:8px;padding:4px 10px;font-size:10px;font-weight:800;color:white;letter-spacing:1px;">DEBIT</div>
                </div>
                <div style="position:relative;z-index:2;margin-top:8px;">
                    <div style="width:38px;height:28px;background:linear-gradient(135deg,#fcd34d,#d97706);border-radius:5px;"></div>
                </div>
                <div style="position:relative;z-index:2;">
                    <div id="walletCardAccNo" style="font-size:15px;font-weight:700;color:rgba(255,255,255,0.95);letter-spacing:3px;font-family:'Courier New',monospace;">   </div>
                    <div style="font-size:9px;color:rgba(255,255,255,0.5);margin-top:2px;letter-spacing:1px;">ACCOUNT NUMBER</div>
                </div>
                <div style="display:flex;justify-content:space-between;align-items:flex-end;position:relative;z-index:2;">
                    <div>
                        <div style="font-size:9px;color:rgba(255,255,255,0.5);letter-spacing:1px;">CARDHOLDER</div>
                        <div id="walletCardName" style="font-size:12px;font-weight:800;color:white;letter-spacing:1px;text-transform:uppercase;">LOADING...</div>
                    </div>
                    <div style="text-align:right;">
                        <div style="font-size:9px;color:rgba(255,255,255,0.5);letter-spacing:1px;">BALANCE</div>
                        <div id="walletCardBalance" style="font-size:18px;font-weight:900;color:#fbbf24;">0</div>
                        <div style="font-size:8px;color:rgba(255,255,255,0.4);">RB COINS</div>
                    </div>
                </div>
            </div>
            <div style="font-size:11px;color:rgba(255,255,255,0.3);text-align:center;margin-bottom:16px;">Tap the card to view the QR Code for the partner store</div>

            <!-- QR Panel -->
            <div id="walletQRPanel" style="display:none;text-align:center;padding:20px;background:rgba(30,41,59,0.8);border:1px solid rgba(255,255,255,0.1);border-radius:16px;margin-bottom:16px;">
                <div style="font-size:12px;font-weight:800;color:#fbbf24;margin-bottom:10px;letter-spacing:1px;">SCAN AT PARTNER STORE</div>
                <canvas id="walletQRCanvas" style="border-radius:8px;background:white;padding:8px;display:block;margin:0 auto;"></canvas>
                <div id="walletQRAccNo" style="font-family:'Courier New',monospace;font-size:14px;font-weight:900;color:white;margin-top:10px;letter-spacing:3px;"></div>
                <div style="font-size:10px;color:rgba(255,255,255,0.4);margin-top:4px;">Show this QR to the cashier at any partner store to pay with RB Coins</div>
            </div>

            <!-- Quick Actions -->
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:20px;">
                <button onclick="openSendCoinsModal()" style="background:linear-gradient(135deg,rgba(14,165,233,0.15),rgba(99,102,241,0.15));border:1px solid rgba(14,165,233,0.3);border-radius:14px;padding:16px 12px;cursor:pointer;text-align:center;">
                    <div style="font-size:24px;margin-bottom:6px;"></div>
                    <div style="font-size:12px;font-weight:900;color:white;">SEND COINS</div>
                    <div style="font-size:10px;color:rgba(255,255,255,0.4);margin-top:3px;">Transfer to another user</div>
                </button>
                <button onclick="showReceiveInfo()" style="background:linear-gradient(135deg,rgba(16,185,129,0.15),rgba(5,150,105,0.15));border:1px solid rgba(16,185,129,0.3);border-radius:14px;padding:16px 12px;cursor:pointer;text-align:center;">
                    <div style="font-size:24px;margin-bottom:6px;"></div>
                    <div style="font-size:12px;font-weight:900;color:white;">RECEIVE</div>
                    <div style="font-size:10px;color:rgba(255,255,255,0.4);margin-top:3px;">Share your account number</div>
                </button>
            </div>

            <!-- Wallet Transactions -->
            <div class="section-label">Wallet Transactions</div>
            <div id="walletTxList">
                <div style="text-align:center;padding:30px 20px;opacity:0.4;">
                    <div style="font-size:36px;margin-bottom:8px;"></div>
                    <div style="font-size:13px;font-weight:700;">No transactions yet</div>
                </div>
            </div>
        </div>

        <!-- === COIN HISTORY SECTION === -->
        <div id="rs-section-history" style="display:none;">
            <div class="section-label">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align:middle;opacity:0.5;"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
                Coin History
            </div>
            <div id="rbCoinHistoryList">
                <div style="text-align:center;padding:50px 20px;opacity:0.4;">
                    <svg width="50" height="50" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" style="display:block;margin:0 auto 12px;"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
                    <div style="font-size:14px;font-weight:700;">No history yet</div>
                    <div style="font-size:12px;margin-top:6px;opacity:0.7;">Earn and spend coins to see your history here</div>
                </div>
            </div>
        </div>

        <!-- ===== MY SHOP SECTION ===== -->
        <div id="rs-section-myshop" style="display:none;">
            <!-- Hero Banner -->
            <div style="background:linear-gradient(135deg,rgba(244,114,182,0.15),rgba(139,92,246,0.12));border:1px solid rgba(244,114,182,0.25);border-radius:18px;padding:16px 18px;margin-bottom:18px;display:flex;align-items:center;gap:14px;">
                <div style="font-size:36px;flex-shrink:0;"></div>
                <div>
                    <div style="font-size:16px;font-weight:900;color:white;margin-bottom:2px;">RB Shop</div>
                    <div style="font-size:11px;color:rgba(255,255,255,0.5);">Pay with RB Coins  fast and secure!</div>
                </div>
                <div id="myShopCartBtn" onclick="openShopCart()" style="margin-left:auto;position:relative;background:linear-gradient(135deg,#f472b6,#8b5cf6);border:none;border-radius:50%;width:44px;height:44px;display:flex;align-items:center;justify-content:center;cursor:pointer;flex-shrink:0;">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2.5"><path d="M6 2L3 6v14a2 2 0 002 2h14a2 2 0 002-2V6l-3-4z"/><line x1="3" y1="6" x2="21" y2="6"/><path d="M16 10a4 4 0 01-8 0"/></svg>
                    <span id="myShopCartCount" style="display:none;position:absolute;top:-4px;right:-4px;background:#ef4444;color:white;font-size:9px;font-weight:900;width:18px;height:18px;border-radius:50%;display:flex;align-items:center;justify-content:center;border:2px solid #0a0f1e;">0</span>
                </div>
            </div>

            <!-- Category Filter -->
            <div id="myShopCatChips" style="display:flex;gap:8px;overflow-x:auto;padding-bottom:4px;margin-bottom:16px;scrollbar-width:none;-webkit-overflow-scrolling:touch;">
                <button class="ps-chip active" onclick="filterMyShop('all',this)">All</button>
                <button class="ps-chip" onclick="filterMyShop('grocery',this)"> Grocery</button>
                <button class="ps-chip" onclick="filterMyShop('food',this)"> Food</button>
                <button class="ps-chip" onclick="filterMyShop('snacks',this)"> Snacks</button>
                <button class="ps-chip" onclick="filterMyShop('personal',this)"> Personal</button>
                <button class="ps-chip" onclick="filterMyShop('clothing',this)"> Clothing</button>
                <button class="ps-chip" onclick="filterMyShop('electronics',this)"> Electronics</button>
                <button class="ps-chip" onclick="filterMyShop('other',this)"> Others</button>
            </div>

            <!-- Search -->
            <div style="position:relative;margin-bottom:16px;">
                <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="rgba(255,255,255,0.3)" stroke-width="2" style="position:absolute;left:12px;top:50%;transform:translateY(-50%);pointer-events:none;"><circle cx="11" cy="11" r="8"/><path d="M21 21l-4.35-4.35"/></svg>
                <input id="myShopSearch" type="text" placeholder="Search products..." oninput="renderMyShopProducts()" style="width:100%;background:rgba(30,41,59,0.8);border:1px solid rgba(255,255,255,0.1);border-radius:12px;padding:10px 12px 10px 36px;color:white;font-size:13px;outline:none;box-sizing:border-box;font-family:Inter,sans-serif;">
            </div>

            <!-- Product Grid -->
            <div id="myShopProductGrid" style="display:grid;grid-template-columns:1fr 1fr;gap:12px;">
                <div style="grid-column:1/-1;text-align:center;padding:50px 20px;opacity:0.4;">
                    <div style="font-size:36px;margin-bottom:10px;"></div>
                    <div style="font-size:13px;font-weight:700;">Loading products...</div>
                </div>
            </div>

            <!-- My Orders Link -->
            <div id="myShopOrdersSection" style="margin-top:24px;">
                <div style="font-size:11px;font-weight:900;color:rgba(255,255,255,0.3);text-transform:uppercase;letter-spacing:1.5px;margin-bottom:12px;"> MY ORDERS</div>
                <div id="myShopOrdersList">
                    <div style="text-align:center;padding:30px;opacity:0.35;font-size:13px;font-weight:700;">Loading orders...</div>
                </div>
            </div>
        </div>

    </div>
</div>

<!-- ===== MY SHOP CART MODAL ===== -->
<div id="myShopCartModal" style="display:none;position:fixed;inset:0;z-index:99500;background:rgba(0,0,0,0.75);backdrop-filter:blur(8px);" onclick="if(event.target===this)closeShopCart()">
    <div style="position:absolute;bottom:0;left:0;right:0;background:linear-gradient(180deg,#0f1829,#0a0f1e);border-radius:24px 24px 0 0;max-height:90vh;display:flex;flex-direction:column;overflow:hidden;animation:slideUp 0.3s cubic-bezier(0.4,0,0.2,1);">
        <!-- Cart Header -->
        <div style="padding:16px 20px 12px;display:flex;align-items:center;justify-content:space-between;border-bottom:1px solid rgba(255,255,255,0.07);flex-shrink:0;">
            <div style="display:flex;align-items:center;gap:10px;">
                <div style="font-size:22px;"></div>
                <div>
                    <div style="font-size:16px;font-weight:900;color:white;">Cart</div>
                    <div id="cartItemCountLabel" style="font-size:11px;color:rgba(255,255,255,0.4);">0 items</div>
                </div>
            </div>
            <button onclick="closeShopCart()" style="background:rgba(255,255,255,0.08);border:none;color:white;width:34px;height:34px;border-radius:50%;font-size:18px;cursor:pointer;display:flex;align-items:center;justify-content:center;"></button>
        </div>
        <!-- Cart Items -->
        <div id="cartItemsContainer" style="flex:1;overflow-y:auto;padding:16px 20px;-webkit-overflow-scrolling:touch;"></div>
        <!-- Delivery Address -->
        <div style="padding:0 20px 12px;flex-shrink:0;">
            <div style="font-size:10px;font-weight:800;color:rgba(255,255,255,0.35);letter-spacing:1px;text-transform:uppercase;margin-bottom:6px;">Delivery Address</div>
            <input id="shopDeliveryAddr" type="text" placeholder="Enter your delivery address..." style="width:100%;background:rgba(30,41,59,0.8);border:1px solid rgba(255,255,255,0.1);border-radius:10px;padding:10px 13px;color:white;font-size:13px;outline:none;box-sizing:border-box;font-family:Inter,sans-serif;">
        </div>
        <!-- Voucher Input -->
        <div style="padding:0 20px 12px;flex-shrink:0;">
            <div style="font-size:10px;font-weight:800;color:rgba(255,255,255,0.35);letter-spacing:1px;text-transform:uppercase;margin-bottom:6px;">Voucher Code</div>
            <div style="display:flex;gap:8px;">
                <input id="shopVoucherInput" type="text" placeholder="ENTER CODE HERE" oninput="this.value=this.value.toUpperCase()" style="flex:1;background:rgba(30,41,59,0.8);border:1px solid rgba(255,255,255,0.1);border-radius:10px;padding:10px 13px;color:#fbbf24;font-size:13px;font-weight:800;letter-spacing:2px;outline:none;box-sizing:border-box;font-family:Inter,sans-serif;">
                <button onclick="applyShopVoucher()" style="padding:10px 16px;background:rgba(251,191,36,0.15);border:1px solid rgba(251,191,36,0.35);border-radius:10px;color:#fbbf24;font-size:12px;font-weight:900;cursor:pointer;white-space:nowrap;">APPLY</button>
            </div>
            <div id="shopVoucherMsg" style="font-size:11px;margin-top:5px;display:none;"></div>
        </div>
        <!-- Order Summary -->
        <div style="padding:12px 20px;border-top:1px solid rgba(255,255,255,0.07);background:rgba(0,0,0,0.2);flex-shrink:0;">
            <div style="display:flex;justify-content:space-between;font-size:12px;color:rgba(255,255,255,0.5);margin-bottom:5px;">
                <span>Subtotal</span><span id="cartSubtotalLine"> 0</span>
            </div>
            <div style="display:flex;justify-content:space-between;font-size:12px;color:rgba(255,255,255,0.5);margin-bottom:5px;">
                <span>Delivery Fee</span><span id="cartDeliveryLine"> 0</span>
            </div>
            <div id="cartDiscountRow" style="display:none;justify-content:space-between;font-size:12px;color:#10b981;margin-bottom:5px;">
                <span id="cartDiscountLabel">Voucher Discount</span><span id="cartDiscountLine">- 0</span>
            </div>
            <div style="display:flex;justify-content:space-between;font-size:16px;font-weight:900;color:white;margin-top:8px;padding-top:8px;border-top:1px solid rgba(255,255,255,0.1);">
                <span>Total</span><span id="cartTotalLine" style="color:#fbbf24;"> 0</span>
            </div>
        </div>
        <!-- Checkout Button -->
        <div style="padding:12px 20px calc(20px + env(safe-area-inset-bottom));flex-shrink:0;">
            <button onclick="checkoutShop()" id="shopCheckoutBtn" style="width:100%;padding:16px;background:linear-gradient(135deg,#f472b6,#8b5cf6);border:none;border-radius:16px;color:white;font-size:15px;font-weight:900;cursor:pointer;letter-spacing:0.5px;box-shadow:0 4px 20px rgba(244,114,182,0.4);">
                 PLACE ORDER
            </button>
        </div>
    </div>
</div>

<!-- ===== PRODUCT DETAIL MODAL ===== -->
<div id="shopProductModal" style="display:none;position:fixed;inset:0;z-index:99600;background:rgba(0,0,0,0.85);backdrop-filter:blur(10px);" onclick="if(event.target===this)closeShopProductModal()">
    <div style="position:absolute;bottom:0;left:0;right:0;background:#0f1829;border-radius:24px 24px 0 0;max-height:85vh;display:flex;flex-direction:column;overflow:hidden;animation:slideUp 0.3s cubic-bezier(0.4,0,0.2,1);">
        <div id="shopProductModalBody" style="flex:1;overflow-y:auto;"></div>
    </div>
</div>

<!-- QR Gift Card Modal -->
<div class="qr-modal-backdrop" id="qrGiftCardModal" onclick="closeQrModal()">
    <div class="qr-modal-card" onclick="event.stopPropagation()">
        <button class="qr-close-btn" onclick="closeQrModal()">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2.5"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
        </button>

        <!-- Gift card visual -->
        <div class="qr-giftcard-visual" id="qrCardVisual">
            <div style="display:flex;align-items:center;justify-content:center;gap:10px;margin-bottom:6px;">
                <div id="qrCardIconSvg" style="width:36px;height:36px;"></div>
                <div style="text-align:left;">
                    <div class="qr-card-title" id="qrCardTitle">STORE VOUCHER</div>
                    <div class="qr-card-brand" id="qrCardBrand">Partner Stores</div>
                </div>
            </div>
            <div class="qr-card-amount" id="qrCardAmount">100</div>
        </div>

        <!-- QR Code -->
        <div class="qr-code-box">
            <canvas id="qrCodeCanvas"></canvas>
        </div>

        <!-- Voucher Code -->
        <div class="qr-card-code" id="qrCardCode">RBGC-XXXX-XXXX</div>

        <!-- Scan hint -->
        <div class="qr-scan-hint">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align:middle;display:inline;"><rect x="5" y="2" width="14" height="20" rx="2"/><line x1="12" y1="18" x2="12.01" y2="18" stroke-width="3"/></svg>
            Scan the QR or show the voucher code<br>to the <strong>Partner Store Cashier</strong> to claim
        </div>

        <!-- Expiry -->
        <div class="qr-expiry" id="qrCardExpiry">Valid for 30 days</div>

        <!-- Save button -->
        <button onclick="saveVoucherAndClose()" style="width:100%;padding:14px;background:linear-gradient(135deg,#065f46,#10b981);border:none;border-radius:14px;color:white;font-size:14px;font-weight:900;cursor:pointer;letter-spacing:0.5px;box-shadow:0 4px 15px rgba(16,185,129,0.4);display:flex;align-items:center;justify-content:center;gap:8px;">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2.5"><polyline points="20 6 9 17 4 12"/></svg>
            SAVE VOUCHER
        </button>
    </div>
</div>

<!-- ===== ALL NEW FEATURES JS (separate script  splash screen untouched above) ===== -->
<script data-cfasync="false" src="/cdn-cgi/scripts/5c5dd728/cloudflare-static/email-decode.min.js"></script><script>
// These resolve at call-time via window  safe even if Firebase inits later
function _db()   { return window.db; }
function _auth() { return window.auth; }
function _user() { return window.userData; }
// ================================================
//  RB COINS  1 per comment/react/share, max 10/day
// ================================================
function awardRbCoin(action) {
    if (!_auth() || !_auth().currentUser || !_user()) return;
    var uid = _auth().currentUser.uid;
    var today = new Date().toDateString();
    _db().ref('engCoins/' + uid + '/' + today).transaction(function(cur) {
        var n = cur || 0;
        if (n >= 10) return n;
        return n + 1;
    }, function(err, committed, snap) {
        if (err || !committed) return;
        var earned = snap.val();
        if (earned <= 10) {
            _db().ref('users/' + uid + '/points').transaction(function(p) { return (p || 0) + 1; });
            showRbCoinToast(action, earned);
        }
    });
}
function showRbCoinToast(action, earned) {
    var labels = { comment: 'Commented', react: 'Reacted', share: 'Shared' };
    var el = document.createElement('div');
    el.style.cssText = 'position:fixed;bottom:90px;left:50%;transform:translateX(-50%);background:linear-gradient(135deg,rgba(251,191,36,.97),rgba(245,158,11,.93));color:#0f172a;padding:9px 20px;border-radius:30px;font-size:13px;font-weight:900;z-index:99999;display:flex;align-items:center;gap:8px;box-shadow:0 4px 20px rgba(251,191,36,.5);animation:rbCoinPop .35s cubic-bezier(.175,.885,.32,1.275);white-space:nowrap;pointer-events:none;';
    el.innerHTML = ' +1 RB Coin &nbsp;&nbsp; ' + (labels[action] || action) + ' <span style="opacity:.6;font-size:11px;margin-left:4px;">(' + earned + '/10 today)</span>';
    document.body.appendChild(el);
    setTimeout(function() { el.style.opacity = '0'; el.style.transition = 'opacity .4s'; setTimeout(function() { el.remove(); }, 400); }, 2600);
}

// Hook comment coins (run after DOM ready)
(function hookCoins() {
    // Intercept sendComment
    var _origSendComment = window.sendComment;
    if (typeof _origSendComment === 'function') {
        window.sendComment = function() {
            _origSendComment.apply(this, arguments);
            awardRbCoin('comment');
        };
    }
    // Intercept submitReaction
    var _origSubmitReaction = window.submitReaction;
    if (typeof _origSubmitReaction === 'function') {
        window.submitReaction = function() {
            _origSubmitReaction.apply(this, arguments);
            awardRbCoin('react');
        };
    }
    // Intercept sharePost
    var _origSharePost = window.sharePost;
    if (typeof _origSharePost === 'function') {
        window.sharePost = function() {
            _origSharePost.apply(this, arguments);
            awardRbCoin('share');
        };
    }
})();

// ================================================
//  RB STORE PAGE
// ================================================

var _rbStorePendingCard = null; // holds the card data before confirming redeem

// === QR Code Generator (lightweight, no library needed) ===
function generateQRCode(canvas, text) {
    // Use a simple QR-code-like pattern using the qrcode-generator approach
    // We'll load qrcode.js from CDN dynamically if not loaded
    if (window.qrcode) {
        _drawQR(canvas, text);
    } else {
        var s = document.createElement('script');
        s.src = 'https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js';
        s.onload = function() { _drawQR(canvas, text); };
        s.onerror = function() { _drawFallbackQR(canvas, text); };
        document.head.appendChild(s);
    }
}

function _drawQR(canvas, text) {
    try {
        // Clear canvas area, use a temp div
        var tempDiv = document.createElement('div');
        tempDiv.style.cssText = 'position:absolute;left:-9999px;top:-9999px;';
        document.body.appendChild(tempDiv);
        var qr = new QRCode(tempDiv, {
            text: text,
            width: 152,
            height: 152,
            colorDark: '#000000',
            colorLight: '#ffffff',
            correctLevel: QRCode.CorrectLevel.H
        });
        setTimeout(function() {
            var img = tempDiv.querySelector('img') || tempDiv.querySelector('canvas');
            if (img) {
                var ctx = canvas.getContext('2d');
                canvas.width = 152;
                canvas.height = 152;
                var src = img.src || img.toDataURL();
                var i = new Image();
                i.onload = function() { ctx.drawImage(i, 0, 0, 152, 152); };
                i.src = src;
            }
            tempDiv.remove();
        }, 200);
    } catch(e) { _drawFallbackQR(canvas, text); }
}

function _drawFallbackQR(canvas, text) {
    // Fallback: draw a stylized "QR" placeholder grid
    canvas.width = 152;
    canvas.height = 152;
    var ctx = canvas.getContext('2d');
    ctx.fillStyle = '#ffffff';
    ctx.fillRect(0, 0, 152, 152);
    // Draw a simple grid pattern
    ctx.fillStyle = '#000000';
    var size = 8;
    var seed = 0;
    for (var i = 0; i < text.length; i++) seed += text.charCodeAt(i);
    for (var row = 0; row < 19; row++) {
        for (var col = 0; col < 19; col++) {
            // Corner squares (finder patterns)
            var inCorner = (row < 7 && col < 7) || (row < 7 && col > 11) || (row > 11 && col < 7);
            var on = inCorner ? _qrCornerPx(row, col) : ((seed * row * col + row + col * 7 + seed) % 3 === 0);
            if (on) ctx.fillRect(4 + col * size, 4 + row * size, size - 1, size - 1);
        }
    }
}
function _qrCornerPx(r, c) {
    // Adjust col for right corner
    var cc = c > 11 ? c - 12 : c;
    var rr = r > 11 ? r - 12 : r;
    return (rr === 0 || rr === 6 || cc === 0 || cc === 6) ||
           (rr >= 2 && rr <= 4 && cc >= 2 && cc <= 4);
}

function openStorePage() {
    var page = document.getElementById('rbStorePage');
    if (!page) { console.error('RB Store page not found'); return; }
    page.classList.add('active');
    // Scroll to top
    var body = page.querySelector('.rbstore-body');
    if (body) body.scrollTop = 0;
    // Read coins
    var el = document.getElementById('rbStoreCoins');
    var pts = (window.userData && window.userData.points) ? window.userData.points : 0;
    if (el) el.textContent = Number(pts).toLocaleString();
    // Live Firebase sync
    if (window.db && window.auth && window.auth.currentUser) {
        window.db.ref('users/' + window.auth.currentUser.uid + '/points').once('value', function(snap) {
            var livePts = snap.val() || 0;
            if (el) el.textContent = Number(livePts).toLocaleString();
            if (window.userData) window.userData.points = livePts;
        });
    }
    try { loadRbVouchers(); } catch(e) {}
    try { loadCoinHistory(); } catch(e) {}
    switchStoreSection('cashout');
}

function closeStorePage() {
    var page = document.getElementById('rbStorePage');
    if (page) page.classList.remove('active');
}

function switchStoreSection(section) {
    var sections = ['cashout', 'vouchers', 'partners', 'history', 'wallet', 'myshop'];
    sections.forEach(function(s) {
        var el = document.getElementById('rs-section-' + s);
        var tab = document.getElementById('rstab-' + s);
        if (el) el.style.display = (s === section) ? 'block' : 'none';
        if (tab) tab.classList.toggle('active', s === section);
    });
    if (section === 'wallet') { try { loadWalletTab(); } catch(e) {} }
    if (section === 'partners') { try { loadApprovedPartnerStores(); } catch(e) {} }
    if (section === 'myshop') { try { loadMyShopProducts(); } catch(e) {} }
}

// === PARTNER STORES: Store type metadata ===
var _psTypeInfo = {
    'sari-sari':   { label: 'Corner Store',  icon: '', c1: '#065f46', c2: '#10b981' },
    'grocery':     { label: 'Grocery',           icon: '', c1: '#1d4ed8', c2: '#3b82f6' },
    'food':        { label: 'Food & Restaurant', icon: '', c1: '#b45309', c2: '#f59e0b' },
    'pharmacy':    { label: 'Pharmacy',          icon: '', c1: '#7c3aed', c2: '#a855f7' },
    'clothing':    { label: 'Clothing',    icon: '', c1: '#be185d', c2: '#ec4899' },
    'electronics': { label: 'Electronics',       icon: '', c1: '#0e7490', c2: '#06b6d4' },
    'school':      { label: 'School Supplies',   icon: '', c1: '#1e40af', c2: '#60a5fa' },
    'beauty':      { label: 'Beauty/Personal',   icon: '', c1: '#9d174d', c2: '#f472b6' },
    'other':       { label: 'Others',            icon: '', c1: '#374151', c2: '#6b7280' }
};

var _psAllStores = [];
var _psCurrentCategory = 'all';

function loadApprovedPartnerStores() {
    var list = document.getElementById('psStoreList');
    if (!list) return;
    list.innerHTML = '<div style="text-align:center;padding:40px 20px;">'
        + '<div style="font-size:28px;margin-bottom:8px;animation:pulse 1.5s infinite;"></div>'
        + '<div style="font-size:12px;color:rgba(255,255,255,0.35);font-weight:700;">Loading partner stores...</div>'
        + '</div>';
    if (!window.db) { list.innerHTML = _psEmptyHTML('Unable to connect to the database.'); return; }
    db.ref('partnerApplications').orderByChild('status').equalTo('approved').once('value', function(snap) {
        _psAllStores = [];
        if (snap.exists()) {
            snap.forEach(function(child) {
                var d = child.val();
                d._key = child.key;
                _psAllStores.push(d);
            });
            _psAllStores.reverse();
        }
        _psRenderStores();
    });
}

function setPSCategory(cat, btn) {
    _psCurrentCategory = cat;
    document.querySelectorAll('.ps-chip').forEach(function(c) { c.classList.remove('active'); });
    if (btn) btn.classList.add('active');
    _psRenderStores();
}

function filterPartnerStores() {
    _psRenderStores();
}

function _psEsc(str) {
    if (!str) return '';
    return String(str).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

function _psEmptyHTML(msg) {
    return '<div style="text-align:center;padding:50px 20px;">'
        + '<div style="font-size:40px;margin-bottom:10px;opacity:0.4;"></div>'
        + '<div style="font-size:13px;color:rgba(255,255,255,0.3);font-weight:700;">' + (msg || 'No partner stores found.') + '</div>'
        + '</div>';
}

function _psRenderStores() {
    var list = document.getElementById('psStoreList');
    var badge = document.getElementById('psStoreCountBadge');
    if (!list) return;
    var searchVal = (document.getElementById('psSearchInput') ? document.getElementById('psSearchInput').value : '').trim().toLowerCase();
    var filtered = _psAllStores.filter(function(s) {
        var catMatch = _psCurrentCategory === 'all' || s.storeType === _psCurrentCategory;
        var searchMatch = !searchVal
            || (s.storeName || '').toLowerCase().includes(searchVal)
            || (s.address || '').toLowerCase().includes(searchVal)
            || (s.storeType || '').toLowerCase().includes(searchVal)
            || (s.ownerName || '').toLowerCase().includes(searchVal);
        return catMatch && searchMatch;
    });
    if (badge) badge.textContent = filtered.length + ' store' + (filtered.length !== 1 ? 's' : '') + ' accepting RB Vouchers';
    if (filtered.length === 0) { list.innerHTML = _psEmptyHTML(); return; }
    var html = '';
    filtered.forEach(function(store) {
        var t = _psTypeInfo[store.storeType] || _psTypeInfo['other'];
        html += '<div class="ps-store-card" style="--ps-c1:' + t.c1 + ';--ps-c2:' + t.c2 + ';">'
            + '<div style="display:flex;gap:13px;align-items:flex-start;">'
            + '<div class="ps-store-icon" style="background:linear-gradient(135deg,' + t.c1 + '80,' + t.c2 + '40);border:1px solid ' + t.c2 + '50;">' + t.icon + '</div>'
            + '<div style="flex:1;min-width:0;">'
            + '<div class="ps-store-name">' + _psEsc(store.storeName || '') + '</div>'
            + '<span class="ps-store-type-badge" style="background:' + t.c1 + '40;color:' + t.c2 + ';border:1px solid ' + t.c2 + '50;margin-bottom:8px;">' + t.icon + ' ' + _psEsc(t.label) + '</span>'
            + '<div style="display:flex;flex-direction:column;gap:5px;margin-top:6px;">'
            + '<div class="ps-detail-row">'
            + '<svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="rgba(255,255,255,0.4)" stroke-width="2"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0118 0z"/><circle cx="12" cy="10" r="3"/></svg>'
            + '<span>' + _psEsc(store.address || 'Address not provided') + '</span>'
            + '</div>'
            + '<div class="ps-detail-row">'
            + '<svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="rgba(255,255,255,0.4)" stroke-width="2"><path d="M22 16.92v3a2 2 0 01-2.18 2 19.79 19.79 0 01-8.63-3.07 19.5 19.5 0 01-6-6 19.79 19.79 0 01-3.07-8.67A2 2 0 014.11 2h3a2 2 0 012 1.72 12.84 12.84 0 00.7 2.81 2 2 0 01-.45 2.11L8.09 9.91a16 16 0 006 6l1.27-1.27a2 2 0 012.11-.45 12.84 12.84 0 002.81.7A2 2 0 0122 16.92z"/></svg>'
            + '<span>' + _psEsc(store.contact || 'Contact not provided') + '</span>'
            + '</div>'
            + '<div class="ps-detail-row">'
            + '<svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="rgba(255,255,255,0.4)" stroke-width="2"><path d="M20 21v-2a4 4 0 00-4-4H8a4 4 0 00-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>'
            + '<span>' + _psEsc(store.ownerName || 'Owner not provided') + '</span>'
            + '</div>'
            + '</div>'
            + '</div>'
            + '</div>'
            + '<button class="ps-voucher-btn" onclick="switchStoreSection(\'cashout\')">'
            + ' Get Voucher for This Store'
            + '</button>'
            + '</div>';
    });
    list.innerHTML = html;
}

function redeemGiftCard(brand, value, typeName, cost, emoji, color1, color2) {
    if (!_auth() || !_auth().currentUser) { showToast('Please log in first.'); return; }
    var pts = (_user() && _user().points) ? _user().points : 0;
    if (pts < cost) {
        showToast(' Insufficient RB Coins! Required: ' + Number(cost).toLocaleString() + ' coins');
        return;
    }
    _rbStorePendingCard = { brand: brand, value: value, typeName: typeName, cost: cost, emoji: emoji, color1: color1, color2: color2 };
    showCustomConfirm(
        ' I-Redeem ang ' + typeName + '?',
        'This will use ' + Number(cost).toLocaleString() + ' of your RB Coins for a ' + value + ' Store Voucher. Can be used at Partner Stores for groceries or any product. This cannot be undone!',
        function() { processGiftCardRedemption(); }
    );
}

function processGiftCardRedemption() {
    if (!_rbStorePendingCard) return;
    var card = _rbStorePendingCard;
    var uid = _auth().currentUser.uid;
    var cost = card.cost;
    // Deduct coins atomically in Firebase
    _db().ref('users/' + uid + '/points').transaction(function(current) {
        var pts = current || 0;
        if (pts < cost) return; // abort if insufficient
        return pts - cost;
    }, function(err, committed, snap) {
        if (err || !committed) { showToast(' Something went wrong. Please try again.'); return; }
        // Generate voucher code
        var code = 'RBGC-' + Math.random().toString(36).toUpperCase().substr(2,4) + '-' + Math.random().toString(36).toUpperCase().substr(2,4) + '-' + Date.now().toString(36).toUpperCase().substr(-4);
        var voucherData = {
            brand: card.brand,
            value: card.value,
            typeName: card.typeName,
            cost: cost,
            emoji: card.emoji,
            color1: card.color1,
            color2: card.color2,
            code: code,
            timestamp: Date.now(),
            used: false,
            uid: uid
        };
        // Save voucher to Firebase
        _db().ref('rbVouchers/' + uid).push(voucherData);
        // Update local userData
        if (window.userData) window.userData.points = (window.userData.points || 0) - cost;
        // Update RB Store coins display
        var el = document.getElementById('rbStoreCoins');
        if (el) el.textContent = Number(window.userData.points).toLocaleString();
        // Update top nav coins display
        var sp = document.getElementById('storePoints');
        if (sp) sp.textContent = Number(window.userData.points).toLocaleString();
        // Log to coin history
        _db().ref('rbCoinHistory/' + uid).push({
            type: 'spend',
            amount: cost,
            label: 'Redeemed ' + card.brand + ' ' + card.value,
            timestamp: Date.now()
        });
        // Show QR modal
        showQrModal(voucherData);
        _rbStorePendingCard = null;
        showToast(' Your Store Voucher has been redeemed! Take a screenshot and use it at Partner Stores.');
        loadRbVouchers();
    });
}

function showQrModal(voucherData) {
    var modal = document.getElementById('qrGiftCardModal');
    if (!modal) return;
    // Visual background
    var vis = document.getElementById('qrCardVisual');
    if (vis) vis.style.background = 'linear-gradient(135deg,' + voucherData.color1 + ',' + voucherData.color2 + ')';
    // Brand icon SVG
    var iconEl = document.getElementById('qrCardIconSvg');
    if (iconEl) {
        var isGcash = voucherData.brand === 'GCash';
        var isMaya = voucherData.brand === 'Maya';
        var isVoucher = voucherData.brand === 'Voucher' || (!isGcash && !isMaya);
        if (isVoucher) {
            iconEl.innerHTML = '<div style="display:flex;align-items:center;gap:8px;background:rgba(255,255,255,0.15);border-radius:10px;padding:4px 12px;">'
                + '<span style="font-size:20px;"></span>'
                + '<span style="font-size:16px;font-weight:900;color:white;letter-spacing:1px;">STORE VOUCHER</span>'
                + '</div>';
        } else if (isGcash) {
            iconEl.innerHTML = '<svg width="54" height="22" viewBox="0 0 130 48" fill="none" xmlns="http://www.w3.org/2000/svg"><rect width="130" height="48" rx="10" fill="rgba(255,255,255,0.2)"/><path d="M24 8C15.163 8 8 15.163 8 24C8 32.837 15.163 40 24 40C32.837 40 40 32.837 40 24V21H24V27H33.5C32.2 31.5 28.5 34.5 24 34.5C18.201 34.5 13.5 29.799 13.5 24C13.5 18.201 18.201 13.5 24 13.5C26.7 13.5 29.2 14.5 31.1 16.2L35.1 12.2C32.3 9.7 28.3 8 24 8Z" fill="white"/><text x="46" y="33" font-size="19" font-weight="900" fill="white" font-family="Arial, sans-serif" letter-spacing="-0.5">GCash</text></svg>';
        } else {
            iconEl.innerHTML = '<svg width="60" height="22" viewBox="0 0 150 48" fill="none" xmlns="http://www.w3.org/2000/svg"><rect width="150" height="48" rx="10" fill="rgba(255,255,255,0.2)"/><path d="M12 24C12 24 16 14 24 18C24 18 22 26 16 28C16 28 12 27 12 24Z" fill="white" fill-opacity="0.9"/><path d="M36 24C36 24 32 14 24 18C24 18 26 26 32 28C32 28 36 27 36 24Z" fill="white" fill-opacity="0.9"/><path d="M12 24C12 24 16 34 24 30C24 30 22 22 16 20C16 20 12 21 12 24Z" fill="white" fill-opacity="0.6"/><path d="M36 24C36 24 32 34 24 30C24 30 26 22 32 20C32 20 36 21 36 24Z" fill="white" fill-opacity="0.6"/><text x="44" y="33" font-size="20" font-weight="900" fill="white" font-family="Arial, sans-serif" letter-spacing="1">maya</text></svg>';
        }
    }
    var titleEl = document.getElementById('qrCardTitle');
    if (titleEl) titleEl.textContent = voucherData.typeName;
    var amtEl = document.getElementById('qrCardAmount');
    if (amtEl) amtEl.textContent = voucherData.value;
    var brandEl = document.getElementById('qrCardBrand');
    if (brandEl) brandEl.textContent = voucherData.brand;
    // Code
    var codeEl = document.getElementById('qrCardCode');
    if (codeEl) codeEl.textContent = voucherData.code;
    // Expiry
    var exp = new Date(voucherData.timestamp + 30 * 24 * 60 * 60 * 1000);
    var expEl = document.getElementById('qrCardExpiry');
    if (expEl) expEl.textContent = 'Valid until: ' + exp.toLocaleDateString('en-PH', { year:'numeric', month:'long', day:'numeric' });
    // QR Code
    var canvas = document.getElementById('qrCodeCanvas');
    if (canvas) generateQRCode(canvas, voucherData.code + '|' + voucherData.brand + '|' + voucherData.value);
    // Show modal
    modal.classList.add('show');
    window._currentVoucherForSave = voucherData;
}

function closeQrModal() {
    var modal = document.getElementById('qrGiftCardModal');
    if (modal) modal.classList.remove('show');
    window._currentVoucherForSave = null;
}

function saveVoucherAndClose() {
    closeQrModal();
    switchStoreSection('vouchers');
    showToast(' Voucher saved to the "My Vouchers" tab!');
}

function loadRbVouchers() {
    if (!_auth() || !_auth().currentUser) return;
    var uid = _auth().currentUser.uid;
    var list = document.getElementById('rbVouchersList');
    if (!list) return;
    list.innerHTML = '<div style="text-align:center;padding:30px;opacity:0.4;font-size:13px;">Loading...</div>';
    _db().ref('rbVouchers/' + uid).orderByChild('timestamp').once('value', function(snap) {
        if (!snap.exists()) {
            list.innerHTML = '<div style="text-align:center;padding:50px 20px;opacity:0.4;"><svg width="50" height="50" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" style="display:block;margin:0 auto 12px;"><rect x="1" y="4" width="22" height="16" rx="2"/><line x1="1" y1="10" x2="23" y2="10"/></svg><div style="font-size:14px;font-weight:700;">You have no vouchers yet</div><div style="font-size:12px;margin-top:6px;opacity:0.7;">Redeem GCash or Maya to get started!</div></div>';
            return;
        }
        var vouchers = [];
        snap.forEach(function(c) { vouchers.unshift({ key: c.key, ...c.val() }); });
        list.innerHTML = vouchers.map(function(v) {
            var exp = new Date(v.timestamp + 30 * 24 * 60 * 60 * 1000);
            var isExpired = exp < new Date();
            var statusColor = v.used ? '#ef4444' : (isExpired ? '#f59e0b' : '#10b981');
            var statusLabel = v.used ? 'Used' : (isExpired ? 'Expired' : 'Active');
            var isGcash = v.brand === 'GCash';
            var iconSvg = isGcash
                ? '<svg width="26" height="26" viewBox="0 0 40 40" fill="none"><rect width="40" height="40" rx="10" fill="rgba(255,255,255,0.2)"/><text x="20" y="27" text-anchor="middle" font-size="18" font-weight="900" fill="white" font-family="Arial">G</text></svg>'
                : '<svg width="26" height="26" viewBox="0 0 40 40" fill="none"><rect width="40" height="40" rx="10" fill="rgba(255,255,255,0.2)"/><text x="20" y="27" text-anchor="middle" font-size="13" font-weight="900" fill="white" font-family="Arial">M</text></svg>';
            return '<div class="voucher-item" onclick="reopenVoucher(\'' + v.key + '\')" style="border-left:3px solid ' + statusColor + ';">' +
                '<div class="voucher-icon-box" style="background:linear-gradient(135deg,' + (v.color1||'#334155') + ',' + (v.color2||'#1e293b') + ');">' + iconSvg + '</div>' +
                '<div class="voucher-info">' +
                '<div class="voucher-name">' + v.brand + ' ' + v.value + '</div>' +
                '<div class="voucher-brand">' + v.code + '</div>' +
                '<div style="font-size:10px;margin-top:4px;color:' + statusColor + ';font-weight:700;">' + statusLabel + '  Exp: ' + exp.toLocaleDateString('en-PH') + '</div>' +
                '</div>' +
                '<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="rgba(255,255,255,0.3)" stroke-width="2"><polyline points="9 18 15 12 9 6"/></svg>' +
                '</div>';
        }).join('');
    });
}

function reopenVoucher(key) {
    if (!_auth() || !_auth().currentUser) return;
    _db().ref('rbVouchers/' + _auth().currentUser.uid + '/' + key).once('value', function(snap) {
        if (snap.exists()) showQrModal(snap.val());
    });
}

function loadCoinHistory() {
    if (!_auth() || !_auth().currentUser) return;
    var uid = _auth().currentUser.uid;
    var list = document.getElementById('rbCoinHistoryList');
    if (!list) return;
    list.innerHTML = '<div style="text-align:center;padding:30px;opacity:0.4;font-size:13px;">Loading...</div>';
    _db().ref('rbCoinHistory/' + uid).orderByChild('timestamp').limitToLast(30).once('value', function(snap) {
        if (!snap.exists()) {
            list.innerHTML = '<div style="text-align:center;padding:50px 20px;opacity:0.4;"><svg width="50" height="50" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" style="display:block;margin:0 auto 12px;"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg><div style="font-size:14px;font-weight:700;">No history yet</div><div style="font-size:12px;margin-top:6px;opacity:0.7;">Earn and spend coins to see your history here</div></div>';
            return;
        }
        var items = [];
        snap.forEach(function(c) { items.unshift(c.val()); });
        var earnIcon = '<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#10b981" stroke-width="2"><polyline points="23 6 13.5 15.5 8.5 10.5 1 18"/><polyline points="17 6 23 6 23 12"/></svg>';
        var spendIcon = '<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#ef4444" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M12 8v4M12 6v2" stroke-width="3" stroke-linecap="round"/><circle cx="12" cy="16" r="1" fill="#ef4444"/></svg>';
        list.innerHTML = items.map(function(item) {
            var isEarn = item.type === 'earn' || (item.amount > 0 && item.type !== 'spend');
            var svgIcon = isEarn ? earnIcon : spendIcon;
            var color = isEarn ? '#10b981' : '#ef4444';
            var prefix = isEarn ? '+' : '-';
            var d = new Date(item.timestamp);
            var dateStr = d.toLocaleDateString('en-PH', { month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' });
            return '<div class="coins-history-item">' +
                '<div class="coins-hist-icon" style="background:' + (isEarn ? 'rgba(16,185,129,0.12)' : 'rgba(239,68,68,0.12)') + ';">' + svgIcon + '</div>' +
                '<div class="coins-hist-info">' +
                '<div class="coins-hist-label">' + (item.label || 'Transaction') + '</div>' +
                '<div class="coins-hist-date">' + dateStr + '</div>' +
                '</div>' +
                '<div class="coins-hist-amount ' + (isEarn ? 'earn' : 'spend') + '">' + prefix + Number(item.amount).toLocaleString() + '</div>' +
                '</div>';
        }).join('');
    });
}

// ================================================
//  MESSENGER NEW FEATURES
// ================================================
var _pmEmojiOpen = false;
var _pmStkOpen = false;
var _pmVoiceRec = null;
var _pmVoiceChunks = [];
var _pmTypeTimer = null;

// Override openMessenger to also load active friends
var _origOpenMessenger = window.openMessenger;
window.openMessenger = function() {
    if (typeof _origOpenMessenger === 'function') _origOpenMessenger();
    loadPmActiveFriends();
    if (window.lucide) lucide.createIcons();
};

function loadPmActiveFriends() {
    if (!auth || !auth.currentUser) return;
    var bar = document.getElementById('pmActiveFriendsBar');
    if (!bar) return;
    var myUid = auth.currentUser.uid;
    // Reset bar
    bar.innerHTML = '<span class="pm-activelabel">Active</span>';
    db.ref('friends/' + myUid).once('value', function(snap) {
        if (!snap.exists()) return;
        Object.keys(snap.val()).forEach(function(uid) {
            if (!window.onlineUsers || !window.onlineUsers[uid] || window.onlineUsers[uid].state !== 'online') return;
            db.ref('users/' + uid).once('value', function(us) {
                var u = us.val(); if (!u) return;
                var item = document.createElement('div');
                item.className = 'pm-afitem';
                item.onclick = function() { openPrivateChat(uid, u.name, u.photo || ''); };
                item.innerHTML = '<div class="pm-afring"><img src="' + (u.photo || 'https://via.placeholder.com/44') + '" alt=""><div class="pm-afdot"></div></div><div class="pm-afname">' + escapeHtml((u.name || '').split(' ')[0]) + '</div>';
                bar.appendChild(item);
            });
        });
    });
}

function filterPmList(q) {
    document.querySelectorAll('.pm-item, .pm-inbox-item').forEach(function(el) {
        var name = el.querySelector('.pm-name, .pm-inbox-name');
        if (!name) return;
        el.style.display = name.textContent.toLowerCase().includes(q.toLowerCase()) ? '' : 'none';
    });
}

function togglePmPanel2(type) {
    if (type === 'emoji') {
        _pmEmojiOpen = !_pmEmojiOpen; _pmStkOpen = false;
    } else {
        _pmStkOpen = !_pmStkOpen; _pmEmojiOpen = false;
    }
    var ep = document.getElementById('pmEmojiPanel2');
    var sp = document.getElementById('pmStickerPanel2');
    if (ep) ep.classList.toggle('open', _pmEmojiOpen);
    if (sp) sp.classList.toggle('open', _pmStkOpen);
}

function insertEmoji2(e) {
    var inp = document.getElementById('pmInput');
    if (inp) { inp.value += e; inp.focus(); }
}

function sendSticker2(emoji) {
    if (!window.currentChatPartner || !auth || !auth.currentUser) return showToast('Open a chat first!');
    var myUid = auth.currentUser.uid;
    var msg = { from: myUid, text: emoji, isSticker: true, timestamp: Date.now() };
    if (window.isGroupChat) {
        msg.senderName = (window.userData && window.userData.name) || 'User';
        db.ref('groupMessages/' + currentChatPartner).push(msg);
    } else {
        msg.to = currentChatPartner;
        db.ref('messages').push(msg);
    }
    var sp = document.getElementById('pmStickerPanel2');
    if (sp) sp.classList.remove('open');
    _pmStkOpen = false;
}

function clearPmImage() {
    window.pmImageBase64 = null;
    var inp = document.getElementById('pmImgInput');
    if (inp) inp.value = '';
    var strip = document.getElementById('pmImgStrip2');
    if (strip) strip.classList.remove('on');
}

// Override handlePmImage to sync window.pmImageBase64 (for legacy compat)
var _origHandlePmImage = window.handlePmImage;
window.handlePmImage = function(input) {
    if (typeof _origHandlePmImage === 'function') _origHandlePmImage(input);
    // window.pmImageBase64 is set inside the original now
};

function onPmType() {
    if (!window.currentChatPartner || window.isGroupChat || !auth || !auth.currentUser) return;
    db.ref('typing/' + currentChatPartner + '/' + auth.currentUser.uid).set(true);
    clearTimeout(_pmTypeTimer);
    _pmTypeTimer = setTimeout(function() {
        db.ref('typing/' + currentChatPartner + '/' + auth.currentUser.uid).remove();
    }, 2000);
}

// Start typing listener when a private chat opens
var _origOpenPrivateChat = window.openPrivateChat;
window.openPrivateChat = function(uid, name, photo) {
    if (typeof _origOpenPrivateChat === 'function') _origOpenPrivateChat.apply(this, arguments);
    // Listen for partner typing
    if (auth && auth.currentUser) {
        db.ref('typing/' + auth.currentUser.uid + '/' + uid).on('value', function(snap) {
            var el = document.getElementById('pmTypingIndicator');
            if (el) el.classList.toggle('on', snap.exists() && snap.val() === true);
        });
    }
};

function startVoice2() {
    if (!navigator.mediaDevices || !window.MediaRecorder) return showToast('Voice recording not supported.');
    navigator.mediaDevices.getUserMedia({ audio: true }).then(function(stream) {
        _pmVoiceChunks = [];
        _pmVoiceRec = new MediaRecorder(stream);
        _pmVoiceRec.ondataavailable = function(e) { _pmVoiceChunks.push(e.data); };
        _pmVoiceRec.onstop = function() {
            var blob = new Blob(_pmVoiceChunks, { type: 'audio/webm' });
            var reader = new FileReader();
            reader.onload = function(ev) {
                if (!window.currentChatPartner || !auth || !auth.currentUser) return;
                var myUid = auth.currentUser.uid;
                var msg = { from: myUid, audio: ev.target.result, isVoice: true, timestamp: Date.now() };
                if (window.isGroupChat) {
                    msg.senderName = (window.userData && window.userData.name) || 'User';
                    db.ref('groupMessages/' + currentChatPartner).push(msg);
                } else {
                    msg.to = currentChatPartner;
                    db.ref('messages').push(msg);
                }
                showToast(' Voice note sent!');
            };
            reader.readAsDataURL(blob);
            stream.getTracks().forEach(function(t) { t.stop(); });
        };
        _pmVoiceRec.start();
        var btn = document.getElementById('pmVoiceBtn2');
        if (btn) btn.classList.add('pm-voiceon');
        showToast(' Recording release to send');
    }).catch(function() { showToast('Microphone access denied.'); });
}
function stopVoice2() {
    if (_pmVoiceRec && _pmVoiceRec.state === "recording") {
        _pmVoiceRec.stop();
        var btn = document.getElementById("pmVoiceBtn2");
        if (btn) btn.classList.remove("pm-voiceon");
    }
}

//  iOS KEYBOARD FIX 
// iOS Safari does NOT shrink position:fixed elements when the keyboard opens.
// The keyboard slides over the bottom, burying the input and send button.
//
// Fix strategy:
//  1. On input FOCUS -> wait 350ms (keyboard animation) then clamp modal height
//  2. On visualViewport RESIZE -> same with timeout (catches all edge cases)
//  3. On input BLUR / modal close -> restore full screen
//  4. window.scrollTo(0,0) stops iOS scrolling the body instead of the modal
//  5. Scroll pmMessages to bottom so latest message is always visible
(function() {
    var modal   = document.getElementById('pmModal');
    var pmInput = document.getElementById('pmInput');
    if (!modal || !pmInput) return;

    var _kbTimer = null;
    var _isKeyboardOpen = false;

    function applyKeyboardHeight() {
        if (!modal || modal.style.display === 'none') return;

        var vh, vt;
        if (window.visualViewport) {
            vh = window.visualViewport.height;
            vt = window.visualViewport.offsetTop || 0;
        } else {
            vh = window.innerHeight;
            vt = 0;
        }

        // Stop iOS from scrolling the body upward when keyboard appears
        window.scrollTo(0, 0);
        if (document.body) document.body.scrollTop = 0;

        modal.style.position = 'fixed';
        modal.style.top      = vt + 'px';
        modal.style.height   = vh + 'px';
        modal.style.left     = '0';
        modal.style.right    = '0';

        // Keep latest message in view
        var msgs = document.getElementById('pmMessages');
        if (msgs) msgs.scrollTop = msgs.scrollHeight;
    }

    function resetKeyboardHeight() {
        if (!modal) return;
        modal.style.top    = '';
        modal.style.height = '';
        _isKeyboardOpen    = false;
        var msgs = document.getElementById('pmMessages');
        if (msgs) setTimeout(function() { msgs.scrollTop = msgs.scrollHeight; }, 50);
    }

    // INPUT FOCUS  most reliable iOS trigger. Keyboard takes ~350ms to finish.
    pmInput.addEventListener('focus', function() {
        _isKeyboardOpen = true;
        clearTimeout(_kbTimer);
        _kbTimer = setTimeout(applyKeyboardHeight, 350);
    });

    // INPUT BLUR  keyboard dismissed
    pmInput.addEventListener('blur', function() {
        _isKeyboardOpen = false;
        clearTimeout(_kbTimer);
        _kbTimer = setTimeout(resetKeyboardHeight, 100);
    });

    // VISUAL VIEWPORT RESIZE  backup trigger for all other cases
    if (window.visualViewport) {
        window.visualViewport.addEventListener('resize', function() {
            clearTimeout(_kbTimer);
            if (_isKeyboardOpen) {
                _kbTimer = setTimeout(applyKeyboardHeight, 100);
            } else {
                _kbTimer = setTimeout(resetKeyboardHeight, 100);
            }
        });
    }

    // Patch openMessenger and backToInbox so height resets when navigating
    var _oOM = window.openMessenger;
    window.openMessenger = function() {
        resetKeyboardHeight();
        if (typeof _oOM === 'function') _oOM.apply(this, arguments);
    };

    var _oBTI = window.backToInbox;
    window.backToInbox = function() {
        resetKeyboardHeight();
        if (typeof _oBTI === 'function') _oBTI.apply(this, arguments);
    };
})();
</script>

<!-- ===== SEND COINS MODAL ===== -->
<div id="sendCoinsModal" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.85);z-index:99995;align-items:center;justify-content:center;padding:20px;" onclick="closeSendCoinsModal()">
    <div style="background:linear-gradient(145deg,#1e293b,#0f172a);border:1px solid rgba(255,255,255,0.1);border-radius:24px;padding:24px;max-width:360px;width:100%;box-shadow:0 24px 64px rgba(0,0,0,0.6);" onclick="event.stopPropagation()">
        <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:20px;">
            <div style="font-size:16px;font-weight:900;color:white;"> SEND RB COINS</div>
            <button onclick="closeSendCoinsModal()" style="background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.1);border-radius:8px;width:32px;height:32px;cursor:pointer;color:white;font-size:18px;line-height:1;"></button>
        </div>
        <div style="margin-bottom:14px;">
            <div style="font-size:10px;font-weight:800;color:rgba(255,255,255,0.4);letter-spacing:1px;text-transform:uppercase;margin-bottom:6px;">Recipient Account Number *</div>
            <input id="sendToAccNo" type="text" placeholder="RB-XXXX-XXXX-XXXX" maxlength="20" oninput="lookupSendRecipient(this.value)" style="width:100%;background:rgba(15,23,42,0.8);border:1px solid rgba(255,255,255,0.1);border-radius:10px;padding:12px 14px;color:white;font-size:14px;font-family:'Courier New',monospace;outline:none;letter-spacing:2px;box-sizing:border-box;">
            <div id="sendRecipientPreview" style="margin-top:8px;padding:10px;background:rgba(14,165,233,0.08);border:1px solid rgba(14,165,233,0.2);border-radius:8px;display:none;font-size:12px;color:white;font-weight:700;"></div>
        </div>
        <div style="margin-bottom:18px;">
            <div style="font-size:10px;font-weight:800;color:rgba(255,255,255,0.4);letter-spacing:1px;text-transform:uppercase;margin-bottom:6px;">Amount of RB Coins *</div>
            <input id="sendCoinsAmount" type="number" placeholder="e.g. 1000" min="1" style="width:100%;background:rgba(15,23,42,0.8);border:1px solid rgba(255,255,255,0.1);border-radius:10px;padding:12px 14px;color:#fbbf24;font-size:18px;font-weight:900;outline:none;box-sizing:border-box;">
            <div style="font-size:10px;color:rgba(255,255,255,0.3);margin-top:5px;">Your balance: <span id="sendModalBalance" style="color:#fbbf24;font-weight:800;">0</span> RB Coins</div>
        </div>
        <button onclick="executeSendCoins()" style="width:100%;padding:14px;background:linear-gradient(135deg,#0ea5e9,#6366f1);border:none;border-radius:14px;color:white;font-size:14px;font-weight:900;cursor:pointer;">SEND COINS</button>
    </div>
</div>

<!-- ===== RECEIVE INFO MODAL ===== -->
<div id="receiveInfoModal" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.85);z-index:99995;align-items:center;justify-content:center;padding:20px;" onclick="this.style.display='none'">
    <div style="background:linear-gradient(145deg,#1e293b,#0f172a);border:1px solid rgba(255,255,255,0.1);border-radius:24px;padding:24px;max-width:360px;width:100%;box-shadow:0 24px 64px rgba(0,0,0,0.6);text-align:center;" onclick="event.stopPropagation()">
        <div style="font-size:16px;font-weight:900;color:white;margin-bottom:16px;"> YOUR ACCOUNT NUMBER</div>
        <div style="background:rgba(16,185,129,0.08);border:1px solid rgba(16,185,129,0.2);border-radius:14px;padding:20px;">
            <canvas id="receiveQRCanvas" style="border-radius:8px;background:white;padding:6px;display:block;margin:0 auto 12px;"></canvas>
            <div id="receiveAccNoText" style="font-family:'Courier New',monospace;font-size:15px;font-weight:900;color:white;letter-spacing:3px;margin-bottom:8px;"></div>
            <div style="font-size:11px;color:rgba(255,255,255,0.4);">Share to receive RB Coins from other users</div>
        </div>
        <button onclick="copyMyAccNo()" style="margin-top:14px;width:100%;padding:12px;background:rgba(16,185,129,0.15);border:1px solid rgba(16,185,129,0.3);border-radius:12px;color:#10b981;font-size:13px;font-weight:900;cursor:pointer;"> COPY ACCOUNT NUMBER</button>
        <button onclick="document.getElementById('receiveInfoModal').style.display='none'" style="margin-top:8px;width:100%;padding:10px;background:transparent;border:1px solid rgba(255,255,255,0.1);border-radius:12px;color:rgba(255,255,255,0.4);font-size:12px;cursor:pointer;">Close</button>
    </div>
</div>

<script>
// ================================================
//  WALLET FEATURE
// ================================================

function _rbGenAccNo(uid) {
    var h = 0;
    for (var i = 0; i < uid.length; i++) { h = Math.imul(31, h) + uid.charCodeAt(i) | 0; }
    var n = Math.abs(h).toString().padStart(12,'0').slice(0,12);
    return 'RB-' + n.slice(0,4) + '-' + n.slice(4,8) + '-' + n.slice(8,12);
}

function _rbEnsureAccNo(uid, cb) {
    if (!uid || !window.db) return;
    db.ref('users/' + uid + '/accountNumber').once('value', function(s) {
        if (s.exists()) { if (cb) cb(s.val()); }
        else { var a = _rbGenAccNo(uid); db.ref('users/' + uid + '/accountNumber').set(a, function() { if (cb) cb(a); }); }
    });
}

function loadWalletTab() {
    if (!window.auth || !window.auth.currentUser) return;
    var uid = window.auth.currentUser.uid;
    _rbEnsureAccNo(uid, function(accNo) {
        var name = (window.userData && window.userData.name) ? window.userData.name.toUpperCase() : 'USER';
        var pts  = (window.userData && window.userData.points) ? Number(window.userData.points) : 0;
        var elAcc = document.getElementById('walletCardAccNo');
        var elName = document.getElementById('walletCardName');
        var elBal  = document.getElementById('walletCardBalance');
        var elSBal = document.getElementById('sendModalBalance');
        if (elAcc)  elAcc.textContent  = accNo;
        if (elName) elName.textContent = name;
        if (elBal)  elBal.textContent  = pts.toLocaleString();
        if (elSBal) elSBal.textContent = pts.toLocaleString();
        // Live sync balance
        db.ref('users/' + uid + '/points').on('value', function(s) {
            var p = Number(s.val() || 0);
            if (elBal)  elBal.textContent  = p.toLocaleString();
            if (elSBal) elSBal.textContent = p.toLocaleString();
        });
        loadWalletTx(uid);
    });
}

var _wQRVisible = false;
function toggleWalletQR() {
    var panel = document.getElementById('walletQRPanel');
    if (!panel) return;
    _wQRVisible = !_wQRVisible;
    panel.style.display = _wQRVisible ? 'block' : 'none';
    if (!_wQRVisible) return;
    if (!window.auth || !window.auth.currentUser) return;
    _rbEnsureAccNo(window.auth.currentUser.uid, function(accNo) {
        var el = document.getElementById('walletQRAccNo');
        if (el) el.textContent = accNo;
        var canvas = document.getElementById('walletQRCanvas');
        if (canvas) _rbDrawQR(canvas, 'RBCOINS:' + accNo + ':PAY');
    });
}

function _rbDrawQR(canvas, text) {
    if (window.QRCode) { _rbDoQR(canvas, text); return; }
    var s = document.createElement('script');
    s.src = 'https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js';
    s.onload = function() { _rbDoQR(canvas, text); };
    s.onerror = function() { _rbFallbackQR(canvas, text); };
    document.head.appendChild(s);
}
function _rbDoQR(canvas, text) {
    try {
        var d = document.createElement('div');
        d.style.cssText = 'position:absolute;left:-9999px;';
        document.body.appendChild(d);
        new QRCode(d, { text: text, width:148, height:148, colorDark:'#000', colorLight:'#fff', correctLevel: QRCode.CorrectLevel.H });
        setTimeout(function() {
            var img = d.querySelector('img') || d.querySelector('canvas');
            if (img) {
                canvas.width = 148; canvas.height = 148;
                var ci = new Image();
                ci.onload = function() { canvas.getContext('2d').drawImage(ci, 0, 0, 148, 148); };
                ci.src = img.src || img.toDataURL();
            }
            d.remove();
        }, 200);
    } catch(e) { _rbFallbackQR(canvas, text); }
}
function _rbFallbackQR(canvas, text) {
    canvas.width = 148; canvas.height = 148;
    var ctx = canvas.getContext('2d');
    ctx.fillStyle = '#fff'; ctx.fillRect(0,0,148,148);
    ctx.fillStyle = '#000';
    var seed = 0; for (var i=0;i<text.length;i++) seed += text.charCodeAt(i);
    for (var r=0;r<18;r++) for (var col=0;col<18;col++) {
        if ((seed*r*col+r+col*7)%3===0) ctx.fillRect(4+col*8, 4+r*8, 7, 7);
    }
}

function loadWalletTx(uid) {
    var el = document.getElementById('walletTxList');
    if (!el || !window.db) return;
    db.ref('walletTx/' + uid).orderByChild('timestamp').limitToLast(20).once('value', function(snap) {
        if (!snap.exists()) return;
        var items = [];
        snap.forEach(function(c) { items.push(c.val()); });
        items.reverse();
        el.innerHTML = items.map(function(item) {
            var isSend = item.type === 'send';
            var d = new Date(item.timestamp);
            var ds = d.toLocaleDateString('tl-PH',{month:'short',day:'numeric',hour:'2-digit',minute:'2-digit'});
            return '<div style="display:flex;align-items:center;gap:12px;padding:12px 0;border-bottom:1px solid rgba(255,255,255,0.05);">'
                + '<div style="width:36px;height:36px;border-radius:50%;background:' + (isSend?'rgba(239,68,68,0.15)':'rgba(16,185,129,0.15)') + ';display:flex;align-items:center;justify-content:center;font-size:16px;flex-shrink:0;">' + (isSend?'':'') + '</div>'
                + '<div style="flex:1;"><div style="font-size:13px;font-weight:700;color:white;">' + (item.label||'Transaction') + '</div><div style="font-size:10px;color:rgba(255,255,255,0.35);margin-top:2px;">' + ds + '</div></div>'
                + '<div style="font-size:15px;font-weight:900;color:' + (isSend?'#ef4444':'#10b981') + ';">' + (isSend?'-':'+') + Number(item.amount).toLocaleString() + '</div>'
                + '</div>';
        }).join('');
    });
}

// SEND COINS
function openSendCoinsModal() {
    var m = document.getElementById('sendCoinsModal'); if (!m) return;
    m.style.display = 'flex';
    var pts = (window.userData && window.userData.points) ? Number(window.userData.points) : 0;
    var el = document.getElementById('sendModalBalance'); if (el) el.textContent = pts.toLocaleString();
    document.getElementById('sendToAccNo').value = '';
    document.getElementById('sendCoinsAmount').value = '';
    document.getElementById('sendRecipientPreview').style.display = 'none';
    window._rbSendToUid = null; window._rbSendToName = null;
}
function closeSendCoinsModal() {
    var m = document.getElementById('sendCoinsModal'); if (m) m.style.display = 'none';
}

var _rbLookupTimer = null;
function lookupSendRecipient(val) {
    clearTimeout(_rbLookupTimer);
    val = (val||'').trim().toUpperCase();
    var prev = document.getElementById('sendRecipientPreview');
    if (!val || val.length < 10) { if (prev) prev.style.display = 'none'; window._rbSendToUid = null; return; }
    _rbLookupTimer = setTimeout(function() {
        if (!window.db) return;
        db.ref('users').orderByChild('accountNumber').equalTo(val).once('value', function(snap) {
            if (!prev) return;
            if (snap.exists()) {
                var uid = Object.keys(snap.val())[0];
                var u = snap.val()[uid];
                if (window.auth && window.auth.currentUser && uid === window.auth.currentUser.uid) {
                    prev.textContent = ' You cannot send coins to yourself';
                    window._rbSendToUid = null;
                } else {
                    prev.textContent = ' ' + (u.name || 'Unknown User');
                    window._rbSendToUid = uid;
                    window._rbSendToName = u.name;
                }
            } else {
                prev.textContent = ' Account number not found';
                window._rbSendToUid = null;
            }
            prev.style.display = 'block';
        });
    }, 600);
}

function executeSendCoins() {
    if (!window.auth || !window.auth.currentUser) return showToast('Please log in first!');
    if (!window._rbSendToUid) return showToast(' No valid recipient found!');
    var amount = parseInt(document.getElementById('sendCoinsAmount').value);
    if (!amount || amount < 1) return showToast(' Please enter an amount!');
    var myPts = (window.userData && window.userData.points) ? Number(window.userData.points) : 0;
    if (amount > myPts) return showToast(' Insufficient RB Coins!');
    var myUid = window.auth.currentUser.uid;
    var toUid = window._rbSendToUid;
    var toName = window._rbSendToName || 'User';
    var myName = (window.userData && window.userData.name) || 'User';
    showCustomConfirm('SEND RB COINS?',
        'You are about to send ' + amount.toLocaleString() + ' RB Coins to ' + toName + '. This cannot be undone!',
        function() {
            var ts = Date.now();
            db.ref('users/' + myUid + '/points').transaction(function(p) { return Math.max(0,(p||0)-amount); });
            db.ref('users/' + toUid + '/points').transaction(function(p) { return (p||0)+amount; });
            db.ref('walletTx/' + myUid).push({ type:'send', amount:amount, withUid:toUid, withName:toName, timestamp:ts, label:'Sent to '+toName });
            db.ref('walletTx/' + toUid).push({ type:'receive', amount:amount, withUid:myUid, withName:myName, timestamp:ts, label:'From '+myName });
            db.ref('coinHistory/' + myUid).push({ label:' Sent to '+toName, amount:amount, type:'spend', timestamp:ts });
            db.ref('coinHistory/' + toUid).push({ label:' From '+myName, amount:amount, type:'earn', timestamp:ts });
            showToast(' Sent! ' + amount.toLocaleString() + ' coins to ' + toName);
            closeSendCoinsModal();
            loadWalletTab();
        }
    );
}

// RECEIVE
function showReceiveInfo() {
    var m = document.getElementById('receiveInfoModal'); if (!m) return;
    m.style.display = 'flex';
    if (!window.auth || !window.auth.currentUser) return;
    _rbEnsureAccNo(window.auth.currentUser.uid, function(accNo) {
        var el = document.getElementById('receiveAccNoText'); if (el) el.textContent = accNo;
        var canvas = document.getElementById('receiveQRCanvas');
        if (canvas) _rbDrawQR(canvas, 'RBCOINS:' + accNo + ':PAY');
        window._rbMyAccNo = accNo;
    });
}
function copyMyAccNo() {
    if (!window._rbMyAccNo) return;
    if (navigator.clipboard) {
        navigator.clipboard.writeText(window._rbMyAccNo).then(function() { showToast(' Account Number copied!'); });
    } else { showToast(window._rbMyAccNo); }
}

// PARTNER APPLICATION
function submitPartnerApplication() {
    var sName = (document.getElementById('pf_storeName').value||'').trim();
    var sType = document.getElementById('pf_storeType').value;
    var addr  = (document.getElementById('pf_address').value||'').trim();
    var oName = (document.getElementById('pf_ownerName').value||'').trim();
    var cont  = (document.getElementById('pf_contact').value||'').trim();
    if (!sName) return showToast(' Please enter the store name!');
    if (!sType) return showToast(' Please select the store type!');
    if (!addr)  return showToast(' Please enter the address!');
    if (!oName) return showToast(' Please enter the owner\'s name!');
    if (!cont)  return showToast(' Please enter a contact number!');
    var btn = document.getElementById('pfSubmitBtn');
    if (btn) { btn.textContent = 'Submitting...'; btn.disabled = true; }
    var uid = (window.auth && window.auth.currentUser) ? window.auth.currentUser.uid : 'guest';
    if (window.db) {
        db.ref('partnerApplications').push({ storeName:sName, storeType:sType, address:addr, ownerName:oName, contact:cont, uid:uid, status:'pending', timestamp:Date.now() }, function(err) {
            if (err) {
                showToast(' An error occurred. Please try again!');
                if (btn) { btn.textContent = ' SUBMIT APPLICATION'; btn.disabled = false; }
            } else {
                document.getElementById('partnerFormWrap').style.display = 'none';
                document.getElementById('partnerFormSuccess').style.display = 'block';
            }
        });
    } else {
        showToast(' Not connected. Please try again!');
        if (btn) { btn.textContent = ' SUBMIT APPLICATION'; btn.disabled = false; }
    }
}
function resetPartnerForm() {
    ['pf_storeName','pf_address','pf_ownerName','pf_contact'].forEach(function(id) { var el=document.getElementById(id); if(el) el.value=''; });
    var st = document.getElementById('pf_storeType'); if(st) st.value='';
    var btn = document.getElementById('pfSubmitBtn');
    if (btn) { btn.textContent = ' SUBMIT APPLICATION'; btn.disabled = false; }
    document.getElementById('partnerFormWrap').style.display = 'flex';
    document.getElementById('partnerFormSuccess').style.display = 'none';
}

// Ensure account number is created on store open
(function() {
    var _orig = window.openStorePage;
    window.openStorePage = function() {
        if (typeof _orig === 'function') _orig.call(this);
        try { if (window.auth && window.auth.currentUser) _rbEnsureAccNo(window.auth.currentUser.uid, function(){}); } catch(e) {}
    };
})();

// ============================================================
// ===           MY SHOP  PLAYER-FACING JS                ===
// ============================================================

var _myShopAllProducts = [];
var _myShopCart = []; // [{id, name, emoji, image, price, deliveryFee, qty}]
var _myShopCurrentCat = 'all';
var _myShopAppliedVoucher = null; // {code, discount, minOrder}

// --- LOAD PRODUCTS ---
function loadMyShopProducts() {
    var grid = document.getElementById('myShopProductGrid');
    if (!grid) return;
    grid.innerHTML = '<div style="grid-column:1/-1;text-align:center;padding:50px 20px;opacity:0.4;"><div style="font-size:36px;margin-bottom:10px;"></div><div style="font-size:13px;font-weight:700;">Loading products...</div></div>';
    if (!window.db) { grid.innerHTML = '<div style="grid-column:1/-1;text-align:center;padding:50px 20px;opacity:0.4;font-size:13px;font-weight:700;">Cannot connect to store.</div>'; return; }
    window.db.ref('shopProducts').orderByChild('isActive').equalTo(true).once('value', function(snap) {
        _myShopAllProducts = [];
        if (snap.exists()) {
            snap.forEach(function(c) { var d = c.val(); d._key = c.key; if (d.isActive) _myShopAllProducts.push(d); });
        }
        renderMyShopProducts();
        loadMyOrders();
    });
}

function filterMyShop(cat, btn) {
    _myShopCurrentCat = cat;
    var chips = document.querySelectorAll('#myShopCatChips .ps-chip');
    chips.forEach(function(c) { c.classList.remove('active'); });
    if (btn) btn.classList.add('active');
    renderMyShopProducts();
}

function renderMyShopProducts() {
    var grid = document.getElementById('myShopProductGrid');
    if (!grid) return;
    var search = (document.getElementById('myShopSearch') ? document.getElementById('myShopSearch').value : '').trim().toLowerCase();
    var filtered = _myShopAllProducts.filter(function(p) {
        var catMatch = _myShopCurrentCat === 'all' || p.category === _myShopCurrentCat;
        var sMatch = !search || (p.name || '').toLowerCase().includes(search) || (p.description || '').toLowerCase().includes(search);
        return catMatch && sMatch;
    });
    if (filtered.length === 0) {
        grid.innerHTML = '<div style="grid-column:1/-1;text-align:center;padding:50px 20px;opacity:0.4;"><div style="font-size:36px;margin-bottom:10px;"></div><div style="font-size:13px;font-weight:700;">No products in this category.</div></div>';
        return;
    }
    var html = '';
    filtered.forEach(function(p) {
        var outOfStock = (p.stock !== undefined && p.stock !== null && p.stock <= 0);
        html += '<div class="ms-product-card" onclick="openShopProduct(\'' + _msEsc(p._key) + '\')">';
        // Image area
        if (p.image) {
            html += '<img class="ms-product-img" src="' + _msEsc(p.image) + '" alt="' + _msEsc(p.name) + '" onerror="this.outerHTML=\'<div class=&quot;ms-product-img&quot; style=&quot;font-size:44px;&quot;>' + (p.emoji || '') + '</div>\'">';
        } else {
            html += '<div class="ms-product-img">' + (p.emoji || '') + '</div>';
        }
        if (outOfStock) html += '<div class="ms-sold-badge">SOLD OUT</div>';
        html += '<div class="ms-product-info">';
        html += '<div class="ms-product-name">' + _msEsc(p.name || '') + '</div>';
        if (p.description) html += '<div style="font-size:10px;color:rgba(255,255,255,0.35);margin-top:2px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">' + _msEsc(p.description) + '</div>';
        html += '<div class="ms-product-price"> ' + Number(p.price || 0).toLocaleString() + '</div>';
        html += '<div class="ms-product-stock">' + (p.deliveryFee > 0 ? ' Delivery: ' + Number(p.deliveryFee).toLocaleString() : ' Free delivery') + '</div>';
        html += '</div>';
        html += '<button class="ms-add-btn" ' + (outOfStock ? 'disabled' : 'onclick="event.stopPropagation();addToShopCart(\'' + _msEsc(p._key) + '\',true)"') + '>' + (outOfStock ? 'Out of Stock' : ' Add to Cart') + '</button>';
        html += '</div>';
    });
    grid.innerHTML = html;
}

function _msEsc(str) {
    if (!str) return '';
    return String(str).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#39;');
}

// --- PRODUCT DETAIL MODAL ---
function openShopProduct(key) {
    var p = _myShopAllProducts.find(function(x) { return x._key === key; });
    if (!p) return;
    var outOfStock = (p.stock !== undefined && p.stock !== null && p.stock <= 0);
    var modal = document.getElementById('shopProductModal');
    var body = document.getElementById('shopProductModalBody');
    if (!modal || !body) return;
    var html = '';
    // Image / emoji
    if (p.image) {
        html += '<img src="' + _msEsc(p.image) + '" style="width:100%;max-height:260px;object-fit:cover;" onerror="this.outerHTML=\'<div style=&quot;width:100%;height:200px;background:rgba(139,92,246,0.1);display:flex;align-items:center;justify-content:center;font-size:80px;&quot;>' + (p.emoji||'') + '</div>\'">';
    } else {
        html += '<div style="width:100%;height:200px;background:rgba(139,92,246,0.08);display:flex;align-items:center;justify-content:center;font-size:90px;">' + (p.emoji || '') + '</div>';
    }
    // Close button overlay
    html += '<button onclick="closeShopProductModal()" style="position:absolute;top:14px;right:14px;background:rgba(0,0,0,0.6);border:none;color:white;width:34px;height:34px;border-radius:50%;font-size:18px;cursor:pointer;display:flex;align-items:center;justify-content:center;"></button>';
    // Info
    html += '<div style="padding:20px;">';
    var catLabels = { grocery:' Grocery', food:' Food', snacks:' Snacks', personal:' Personal Care', clothing:' Clothing', electronics:' Electronics', school:' School', other:' Others' };
    html += '<div style="font-size:10px;color:rgba(255,255,255,0.35);font-weight:700;letter-spacing:1px;margin-bottom:6px;">' + (catLabels[p.category]||' Others') + '</div>';
    html += '<div style="font-size:20px;font-weight:900;color:white;margin-bottom:8px;">' + _msEsc(p.name||'') + '</div>';
    if (p.description) html += '<div style="font-size:13px;color:rgba(255,255,255,0.6);line-height:1.7;margin-bottom:16px;">' + _msEsc(p.description) + '</div>';
    // Price + delivery
    html += '<div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:20px;">';
    html += '<div style="background:rgba(251,191,36,0.1);border:1px solid rgba(251,191,36,0.25);border-radius:12px;padding:12px;text-align:center;">';
    html += '<div style="font-size:10px;color:rgba(255,255,255,0.4);font-weight:700;letter-spacing:1px;margin-bottom:4px;">PRICE</div>';
    html += '<div style="font-size:20px;font-weight:900;color:#fbbf24;"> ' + Number(p.price||0).toLocaleString() + '</div></div>';
    html += '<div style="background:rgba(6,182,212,0.08);border:1px solid rgba(6,182,212,0.2);border-radius:12px;padding:12px;text-align:center;">';
    html += '<div style="font-size:10px;color:rgba(255,255,255,0.4);font-weight:700;letter-spacing:1px;margin-bottom:4px;">DELIVERY</div>';
    html += '<div style="font-size:20px;font-weight:900;color:#06b6d4;">' + (p.deliveryFee > 0 ? ' ' + Number(p.deliveryFee).toLocaleString() : ' FREE') + '</div></div>';
    html += '</div>';
    html += '<div style="font-size:12px;color:rgba(255,255,255,0.4);margin-bottom:20px;">Stock: <b style="color:' + ((p.stock||0) > 0 ? '#10b981' : '#ef4444') + ';">' + (p.stock||0) + ' available</b></div>';
    html += '<button onclick="addToShopCart(\'' + _msEsc(key) + '\',false);closeShopProductModal();" ' + (outOfStock ? 'disabled style="width:100%;padding:16px;background:rgba(255,255,255,0.08);border:none;border-radius:14px;color:rgba(255,255,255,0.3);font-size:15px;font-weight:900;cursor:not-allowed;"' : 'style="width:100%;padding:16px;background:linear-gradient(135deg,#f472b6,#8b5cf6);border:none;border-radius:14px;color:white;font-size:15px;font-weight:900;cursor:pointer;box-shadow:0 4px 20px rgba(244,114,182,0.4);"') + '>' + (outOfStock ? ' Out of Stock' : ' Add to Cart') + '</button>';
    html += '</div>';
    body.innerHTML = html;
    modal.style.display = 'block';
}

function closeShopProductModal() {
    var m = document.getElementById('shopProductModal');
    if (m) m.style.display = 'none';
}

// --- CART ---
function addToShopCart(key, showToastFlag) {
    var p = _myShopAllProducts.find(function(x) { return x._key === key; });
    if (!p) return;
    var existing = _myShopCart.find(function(c) { return c.id === key; });
    if (existing) {
        existing.qty++;
    } else {
        _myShopCart.push({ id:key, name:p.name, emoji:p.emoji||'', image:p.image||'', price:p.price||0, deliveryFee:p.deliveryFee||0, qty:1 });
    }
    updateCartBadge();
    if (showToastFlag && typeof showToast === 'function') showToast(' ' + (p.name||'Item') + ' added!');
    renderCartItems();
    calculateCartTotal();
}

function updateCartBadge() {
    var total = _myShopCart.reduce(function(s,i){ return s+i.qty; },0);
    var badge = document.getElementById('myShopCartCount');
    if (badge) {
        badge.textContent = total;
        badge.style.display = total > 0 ? 'flex' : 'none';
    }
    var label = document.getElementById('cartItemCountLabel');
    if (label) label.textContent = total + ' item' + (total !== 1 ? 's' : '');
}

function openShopCart() {
    var m = document.getElementById('myShopCartModal');
    if (!m) return;
    m.style.display = 'block';
    renderCartItems();
    calculateCartTotal();
}

function closeShopCart() {
    var m = document.getElementById('myShopCartModal');
    if (m) m.style.display = 'none';
}

function changeCartQty(key, delta) {
    var item = _myShopCart.find(function(c) { return c.id === key; });
    if (!item) return;
    item.qty += delta;
    if (item.qty <= 0) _myShopCart = _myShopCart.filter(function(c) { return c.id !== key; });
    updateCartBadge();
    renderCartItems();
    calculateCartTotal();
}

function renderCartItems() {
    var container = document.getElementById('cartItemsContainer');
    if (!container) return;
    if (_myShopCart.length === 0) {
        container.innerHTML = '<div style="text-align:center;padding:40px 20px;opacity:0.35;"><div style="font-size:40px;margin-bottom:10px;"></div><div style="font-size:13px;font-weight:700;">Your cart is empty.</div></div>';
        return;
    }
    var html = '';
    _myShopCart.forEach(function(item) {
        html += '<div class="cart-item-row">';
        if (item.image) {
            html += '<img class="cart-item-img" src="' + _msEsc(item.image) + '" onerror="this.outerHTML=\'<div class=&quot;cart-item-emoji&quot;>' + (item.emoji||'') + '</div>\'">';
        } else {
            html += '<div class="cart-item-emoji">' + (item.emoji||'') + '</div>';
        }
        html += '<div style="flex:1;">';
        html += '<div style="font-size:13px;font-weight:700;color:white;">' + _msEsc(item.name) + '</div>';
        html += '<div style="font-size:12px;color:#fbbf24;font-weight:800;"> ' + Number(item.price * item.qty).toLocaleString() + '</div>';
        html += '</div>';
        html += '<div style="display:flex;align-items:center;gap:8px;">';
        html += '<button class="cart-qty-btn" onclick="changeCartQty(\'' + _msEsc(item.id) + '\',-1)"></button>';
        html += '<span class="cart-qty-num">' + item.qty + '</span>';
        html += '<button class="cart-qty-btn" onclick="changeCartQty(\'' + _msEsc(item.id) + '\',1)">+</button>';
        html += '</div></div>';
    });
    container.innerHTML = html;
}

// --- VOUCHER ---
function applyShopVoucher() {
    var code = (document.getElementById('shopVoucherInput') ? document.getElementById('shopVoucherInput').value : '').trim().toUpperCase();
    var msg = document.getElementById('shopVoucherMsg');
    if (!code) { if(msg){msg.textContent='Enter a voucher code first.';msg.style.color='#ef4444';msg.style.display='block';} return; }
    if (!window.db) return;
    window.db.ref('shopVouchers/' + code).once('value', function(snap) {
        if (!snap.exists()) {
            _myShopAppliedVoucher = null;
            if(msg){msg.textContent=' Invalid voucher code.';msg.style.color='#ef4444';msg.style.display='block';}
            calculateCartTotal();
            return;
        }
        var v = snap.val();
        if (v.isActive === false) {
            _myShopAppliedVoucher = null;
            if(msg){msg.textContent=' This voucher is no longer active.';msg.style.color='#ef4444';msg.style.display='block';}
            calculateCartTotal();
            return;
        }
        // Check min order
        var subtotal = _myShopCart.reduce(function(s,i){ return s+(i.price*i.qty); },0);
        if (v.minOrder && subtotal < v.minOrder) {
            _myShopAppliedVoucher = null;
            if(msg){msg.textContent=' Minimum order: ' + Number(v.minOrder).toLocaleString() + '. Your subtotal is ' + Number(subtotal).toLocaleString() + '.';msg.style.color='#ef4444';msg.style.display='block';}
            calculateCartTotal();
            return;
        }
        _myShopAppliedVoucher = { code:v.code, discount:v.discount, minOrder:v.minOrder||0 };
        if(msg){msg.textContent=' ' + v.code + ' applied! ' + v.discount + '% discount.';msg.style.color='#10b981';msg.style.display='block';}
        calculateCartTotal();
    });
}

function calculateCartTotal() {
    var subtotal = _myShopCart.reduce(function(s,i){ return s+(i.price*i.qty); },0);
    // Delivery fee = max delivery fee among items
    var deliveryFee = 0;
    _myShopCart.forEach(function(i){ if(i.deliveryFee > deliveryFee) deliveryFee = i.deliveryFee; });
    var discount = 0;
    var discRow = document.getElementById('cartDiscountRow');
    if (_myShopAppliedVoucher) {
        discount = Math.floor(subtotal * _myShopAppliedVoucher.discount / 100);
        if (discRow) { discRow.style.display = 'flex'; document.getElementById('cartDiscountLabel').textContent = 'Voucher (-' + _myShopAppliedVoucher.discount + '%)'; document.getElementById('cartDiscountLine').textContent = '- ' + Number(discount).toLocaleString(); }
    } else {
        if (discRow) discRow.style.display = 'none';
    }
    var total = subtotal + deliveryFee - discount;
    var stEl = document.getElementById('cartSubtotalLine');
    var dlEl = document.getElementById('cartDeliveryLine');
    var totEl = document.getElementById('cartTotalLine');
    if (stEl) stEl.textContent = ' ' + Number(subtotal).toLocaleString();
    if (dlEl) dlEl.textContent = deliveryFee > 0 ? ' ' + Number(deliveryFee).toLocaleString() : ' FREE';
    if (totEl) totEl.textContent = ' ' + Number(total).toLocaleString();
    return { subtotal: subtotal, deliveryFee: deliveryFee, discount: discount, total: total };
}

// --- CHECKOUT ---
function checkoutShop() {
    if (!window.auth || !window.auth.currentUser) { if(typeof showToast==='function') showToast('Please log in first!'); return; }
    if (_myShopCart.length === 0) { if(typeof showToast==='function') showToast(' Cart is empty!'); return; }
    var addr = (document.getElementById('shopDeliveryAddr') ? document.getElementById('shopDeliveryAddr').value : '').trim();
    if (!addr) { if(typeof showToast==='function') showToast(' Enter your delivery address!'); return; }
    var costs = calculateCartTotal();
    var myPts = (window.userData && window.userData.points) ? Number(window.userData.points) : 0;
    if (costs.total > myPts) { if(typeof showToast==='function') showToast(' Insufficient RB Coins! Need ' + Number(costs.total).toLocaleString()); return; }
    if (typeof showCustomConfirm !== 'function') {
        if (!confirm('ORDER FOR ' + Number(costs.total).toLocaleString() + ' RB Coins?\n\n' + _myShopCart.map(function(i){return i.emoji+' '+i.name+' x'+i.qty;}).join('\n') + '\n\nDelivery to: ' + addr)) return;
        processShopOrder(costs, addr);
        return;
    }
    showCustomConfirm(' Confirm Order?',
        'You will pay  ' + Number(costs.total).toLocaleString() + ' RB Coins.\n\n' + _myShopCart.map(function(i){return i.emoji+' '+i.name+' '+i.qty;}).join('\n'),
        function() { processShopOrder(costs, addr); }
    );
}

function processShopOrder(costs, addr) {
    var uid = window.auth.currentUser.uid;
    var ts = Date.now();
    var itemsCopy = _myShopCart.map(function(i){ return { id:i.id, name:i.name, emoji:i.emoji, price:i.price, qty:i.qty }; });
    var orderData = {
        buyerUid: uid,
        buyerName: (window.userData && window.userData.name) || 'User',
        items: itemsCopy,
        subtotal: costs.subtotal,
        deliveryFee: costs.deliveryFee,
        discountPct: _myShopAppliedVoucher ? _myShopAppliedVoucher.discount : 0,
        discountAmt: costs.discount,
        voucherCode: _myShopAppliedVoucher ? _myShopAppliedVoucher.code : '',
        totalCoins: costs.total,
        address: addr,
        status: 'pending',
        timestamp: ts
    };
    var btn = document.getElementById('shopCheckoutBtn');
    if (btn) { btn.textContent = 'Processing...'; btn.disabled = true; }
    // Deduct coins
    window.db.ref('users/' + uid + '/points').transaction(function(p) { return Math.max(0, (p||0) - costs.total); });
    // Save order
    window.db.ref('shopOrders').push(orderData, function(err) {
        if (btn) { btn.textContent = ' PLACE ORDER'; btn.disabled = false; }
        if (err) { if(typeof showToast==='function') showToast(' Error: ' + err.message); return; }
        // Log coin history
        window.db.ref('coinHistory/' + uid).push({ label:' Shop Order: ' + itemsCopy.map(function(i){return i.name;}).join(', '), amount:costs.total, type:'spend', timestamp:ts });
        // Update wallet tx
        window.db.ref('walletTx/' + uid).push({ type:'send', amount:costs.total, withUid:'SHOP', withName:'RB Shop', timestamp:ts, label:'Paid for shop order' });
        // Update RB coins display
        if (window.userData) window.userData.points = Math.max(0, (window.userData.points||0) - costs.total);
        var coinEls = document.querySelectorAll('#rbStoreCoins');
        coinEls.forEach(function(el){ if(el) el.textContent = Number(window.userData.points||0).toLocaleString(); });
        // Reset cart
        _myShopCart = [];
        _myShopAppliedVoucher = null;
        if (document.getElementById('shopVoucherInput')) document.getElementById('shopVoucherInput').value = '';
        if (document.getElementById('shopVoucherMsg')) document.getElementById('shopVoucherMsg').style.display = 'none';
        if (document.getElementById('shopDeliveryAddr')) document.getElementById('shopDeliveryAddr').value = '';
        updateCartBadge();
        closeShopCart();
        if(typeof showToast==='function') showToast(' Order placed! Waiting for confirmation.');
        loadMyOrders();
    });
}

// ============================================================
//                
//              
//          
//          
//           
//            
// ANTI-BUG SYSTEM v2.0  Radio Bingo Live
// Protects against: JS errors, Promise rejections, Firebase drops,
// Network issues, DOM failures, memory leaks, and more.
// ============================================================
(function() {
    'use strict';

    //  CONFIGURATION 
    var ABS = {
        version: '2.0',
        maxErrorsPerMin: 5,       // max toasts per minute
        reconnectDelay: 3000,     // ms before reconnect attempt
        maxReconnectAttempts: 10,
        heartbeatInterval: 30000, // ms between Firebase pings
        errorLog: [],             // rolling error log
        errorCount: 0,
        errorResetTimer: null,
        reconnectAttempts: 0,
        isOnline: navigator.onLine,
        firebaseConnected: false,
        heartbeatTimer: null,
        suppressedErrors: [
            'ResizeObserver loop',
            'Non-Error promise rejection',
            'Script error.',
            'NetworkError when attempting to fetch',
            'Load failed',
            'cancelled',
            'AbortError'
        ]
    };

    //  UTILITY: Safe toast caller (won't crash if showToast not ready) 
    function absToast(msg, isError) {
        if (ABS.errorCount >= ABS.maxErrorsPerMin) return;
        try {
            if (typeof showToast === 'function') {
                showToast(msg);
            } else {
                console.warn('[ABS] Toast not ready:', msg);
            }
        } catch(e) { /* silent */ }
    }

    //  UTILITY: Throttle error toasts 
    function absThrottledError(msg) {
        ABS.errorCount++;
        if (!ABS.errorResetTimer) {
            ABS.errorResetTimer = setTimeout(function() {
                ABS.errorCount = 0;
                ABS.errorResetTimer = null;
            }, 60000);
        }
        if (ABS.errorCount <= ABS.maxErrorsPerMin) {
            absToast(msg);
        } else if (ABS.errorCount === ABS.maxErrorsPerMin + 1) {
            absToast(' Maraming errors ang nangyari. Tingnan ang console.');
        }
    }

    //  UTILITY: Log to internal error log 
    function absLog(type, msg, detail) {
        var entry = {
            type: type,
            msg: msg,
            detail: detail || '',
            ts: new Date().toISOString()
        };
        ABS.errorLog.push(entry);
        if (ABS.errorLog.length > 100) ABS.errorLog.shift(); // keep last 100
        console.warn('[ABS][' + type + '] ' + msg, detail || '');
    }

    //  UTILITY: Check if error is suppressed 
    function isSuppressed(msg) {
        if (!msg) return true;
        var s = String(msg);
        for (var i = 0; i < ABS.suppressedErrors.length; i++) {
            if (s.indexOf(ABS.suppressedErrors[i]) !== -1) return true;
        }
        return false;
    }

    //  1. GLOBAL JS ERROR HANDLER 
    var _origOnerror = window.onerror;
    window.onerror = function(msg, src, line, col, err) {
        if (isSuppressed(msg)) return false;
        absLog('JS_ERROR', msg, src + ':' + line);
        // Only show toast for truly unexpected errors
        if (msg && String(msg).indexOf('undefined') !== -1) {
            absThrottledError(' May natuklasang bug. Nire-refresh ang ilang bahagi...');
            absAutoRecover();
        }
        if (typeof _origOnerror === 'function') _origOnerror.apply(this, arguments);
        return false; // don't suppress browser default behavior
    };

    //  2. UNHANDLED PROMISE REJECTION HANDLER 
    window.addEventListener('unhandledrejection', function(e) {
        var reason = e.reason ? (e.reason.message || String(e.reason)) : 'Unknown';
        if (isSuppressed(reason)) return;
        absLog('PROMISE_REJECTION', reason);
        // Firebase permission errors
        if (reason.indexOf('permission') !== -1 || reason.indexOf('PERMISSION_DENIED') !== -1) {
            absLog('FIREBASE_PERM', 'Permission denied - user may need to re-login');
            absThrottledError(' Permission denied. Subukan mag-login ulit.');
        } else if (reason.indexOf('network') !== -1 || reason.indexOf('fetch') !== -1) {
            absLog('NETWORK_ERR', 'Network error in promise');
        }
    });

    //  3. NETWORK MONITORING 
    window.addEventListener('online', function() {
        ABS.isOnline = true;
        absLog('NETWORK', 'Connection restored');
        absToast(' Nakabalik na ang internet!');
        absReconnectFirebase();
    });

    window.addEventListener('offline', function() {
        ABS.isOnline = false;
        absLog('NETWORK', 'Connection lost');
        absToast(' Nawala ang internet connection. Naghihintay...');
    });

    //  4. FIREBASE CONNECTION MONITORING 
    function absInitFirebaseMonitor() {
        if (!window.db) {
            setTimeout(absInitFirebaseMonitor, 2000);
            return;
        }
        try {
            window.db.ref('.info/connected').on('value', function(snap) {
                var connected = snap.val();
                if (connected === true) {
                    if (!ABS.firebaseConnected) {
                        ABS.firebaseConnected = true;
                        ABS.reconnectAttempts = 0;
                        absLog('FIREBASE', 'Connected to Firebase');
                        if (ABS.reconnectAttempts > 0) {
                            absToast(' Nakakonekta na ulit sa Firebase!');
                        }
                    }
                } else {
                    if (ABS.firebaseConnected) {
                        ABS.firebaseConnected = false;
                        absLog('FIREBASE', 'Disconnected from Firebase');
                        if (ABS.isOnline) {
                            absThrottledError(' Nawala ang koneksyon sa server. Nagre-reconnect...');
                        }
                        absScheduleReconnect();
                    }
                }
            });
            absStartHeartbeat();
        } catch(e) {
            absLog('FIREBASE_MONITOR_ERR', e.message);
        }
    }

    function absScheduleReconnect() {
        if (ABS.reconnectAttempts >= ABS.maxReconnectAttempts) {
            absLog('FIREBASE', 'Max reconnect attempts reached');
            absThrottledError(' Hindi makakonekta sa server. I-refresh ang page.');
            return;
        }
        var delay = ABS.reconnectDelay * Math.pow(1.5, Math.min(ABS.reconnectAttempts, 5));
        ABS.reconnectAttempts++;
        setTimeout(absReconnectFirebase, delay);
    }

    function absReconnectFirebase() {
        if (!window.db) return;
        try {
            absLog('FIREBASE', 'Attempting reconnect #' + ABS.reconnectAttempts);
            // Firebase auto-reconnects but we can force a ping
            window.db.ref('.info/serverTimeOffset').once('value', function(snap) {
                absLog('FIREBASE', 'Reconnect ping successful');
            }, function(err) {
                absLog('FIREBASE_ERR', 'Reconnect ping failed: ' + err.message);
                absScheduleReconnect();
            });
        } catch(e) {
            absScheduleReconnect();
        }
    }

    //  5. HEARTBEAT (keeps Firebase alive) 
    function absStartHeartbeat() {
        if (ABS.heartbeatTimer) clearInterval(ABS.heartbeatTimer);
        ABS.heartbeatTimer = setInterval(function() {
            if (!ABS.isOnline || !window.db) return;
            try {
                window.db.ref('.info/serverTimeOffset').once('value', function() {
                    // heartbeat ok
                }, function(err) {
                    absLog('HEARTBEAT_FAIL', err.message);
                });
            } catch(e) { /* silent */ }
        }, ABS.heartbeatInterval);
    }

    //  6. SAFE DOM WRAPPER 
    window.safeQuery = function(selector, parent) {
        try {
            return (parent || document).querySelector(selector);
        } catch(e) {
            absLog('DOM_ERR', 'safeQuery failed: ' + selector, e.message);
            return null;
        }
    };

    window.safeQueryAll = function(selector, parent) {
        try {
            return (parent || document).querySelectorAll(selector);
        } catch(e) {
            absLog('DOM_ERR', 'safeQueryAll failed: ' + selector, e.message);
            return [];
        }
    };

    //  7. SAFE FIREBASE OPERATION WRAPPER 
    window.safeFirebase = function(fn, fallback) {
        if (!window.db) {
            absLog('FIREBASE_ERR', 'DB not ready for operation');
            if (typeof fallback === 'function') fallback(new Error('DB not ready'));
            return;
        }
        try {
            fn();
        } catch(e) {
            absLog('FIREBASE_OP_ERR', e.message);
            if (typeof fallback === 'function') fallback(e);
        }
    };

    //  8. AUTO-RECOVERY SYSTEM 
    function absAutoRecover() {
        try {
            // Re-render Lucide icons if they got wiped
            if (typeof lucide !== 'undefined' && lucide.createIcons) {
                setTimeout(function() {
                    try { lucide.createIcons(); } catch(e) {}
                }, 500);
            }
        } catch(e) { /* silent */ }
    }

    //  9. MEMORY LEAK GUARD  Warn on excessive listeners 
    var _listenerCounts = {};
    var _origDbRef = null;
    function absMonitorListeners() {
        if (!window.db) { setTimeout(absMonitorListeners, 3000); return; }
        // Simple: track .on() calls count per path
        var _origOn = firebase.database.Reference.prototype.on;
        firebase.database.Reference.prototype.on = function(event, cb, cancelCb, context) {
            var path = this.toString();
            _listenerCounts[path] = (_listenerCounts[path] || 0) + 1;
            if (_listenerCounts[path] > 20) {
                absLog('MEMORY_WARN', 'High listener count on: ' + path + ' (' + _listenerCounts[path] + ')');
            }
            return _origOn.call(this, event, cb, cancelCb, context);
        };
        var _origOff = firebase.database.Reference.prototype.off;
        firebase.database.Reference.prototype.off = function(event, cb, context) {
            var path = this.toString();
            if (_listenerCounts[path] > 0) _listenerCounts[path]--;
            return _origOff.call(this, event, cb, context);
        };
    }

    //  10. PAGE VISIBILITY  Reconnect when tab comes back 
    document.addEventListener('visibilitychange', function() {
        if (!document.hidden && !ABS.firebaseConnected && ABS.isOnline) {
            absLog('VISIBILITY', 'Tab active, attempting Firebase reconnect');
            absReconnectFirebase();
        }
        if (!document.hidden) {
            absAutoRecover();
        }
    });

    //  11. CONSOLE ERROR INTERCEPTOR 
    var _origConsoleError = console.error;
    console.error = function() {
        var args = Array.prototype.slice.call(arguments);
        var msg = args.join(' ');
        if (!isSuppressed(msg)) {
            absLog('CONSOLE_ERR', msg.substring(0, 200));
        }
        _origConsoleError.apply(console, arguments);
    };

    //  12. ABS DIAGNOSTICS (accessible via console) 
    window.ABSDiagnostics = function() {
        return {
            version: ABS.version,
            online: ABS.isOnline,
            firebaseConnected: ABS.firebaseConnected,
            reconnectAttempts: ABS.reconnectAttempts,
            errorCount: ABS.errorCount,
            recentErrors: ABS.errorLog.slice(-10),
            listenerCounts: _listenerCounts
        };
    };

    //  INIT 
    window.addEventListener('load', function() {
        absInitFirebaseMonitor();
        setTimeout(absMonitorListeners, 4000);
        absLog('SYSTEM', 'Anti-Bug Shield v' + ABS.version + ' initialized ');
    });

    console.log('%c Anti-Bug System v2.0 Loaded', 'color:#10b981;font-weight:bold;font-size:14px;');
    console.log('%cType ABSDiagnostics() sa console para makita ang status.', 'color:#94a3b8;font-size:11px;');

})(); // End of Anti-Bug System
// ============================================================

// --- MY ORDERS ---
function loadMyOrders() {
    var list = document.getElementById('myShopOrdersList');
    if (!list) return;
    if (!window.auth || !window.auth.currentUser) { list.innerHTML = '<div style="text-align:center;padding:20px;opacity:0.35;font-size:12px;font-weight:700;">Login to see your orders.</div>'; return; }
    var uid = window.auth.currentUser.uid;
    window.db.ref('shopOrders').orderByChild('buyerUid').equalTo(uid).limitToLast(20).once('value', function(snap) {
        if (!snap.exists()) { list.innerHTML = '<div style="text-align:center;padding:30px 20px;opacity:0.35;"><div style="font-size:30px;margin-bottom:8px;"></div><div style="font-size:13px;font-weight:700;">No orders yet.</div></div>'; return; }
        var orders = [];
        snap.forEach(function(c) { var d = c.val(); d._key = c.key; orders.push(d); });
        orders.reverse();
        var statusColor = { pending:'#fbbf24', processing:'#06b6d4', completed:'#10b981', cancelled:'#ef4444' };
        var statusEmoji = { pending:'', processing:'', completed:'', cancelled:'' };
        var html = '';
        orders.forEach(function(o) {
            var sc = statusColor[o.status||'pending'] || '#94a3b8';
            var se = statusEmoji[o.status||'pending'] || '';
            var date = o.timestamp ? new Date(o.timestamp).toLocaleDateString('en-PH',{month:'short',day:'numeric',hour:'2-digit',minute:'2-digit'}) : '';
            html += '<div style="background:rgba(30,41,59,0.5);border:1px solid rgba(255,255,255,0.07);border-radius:12px;padding:14px;margin-bottom:10px;">';
            html += '<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">';
            html += '<div style="font-size:11px;color:rgba(255,255,255,0.35);">Order #' + (o._key||'').slice(-8).toUpperCase() + '  ' + date + '</div>';
            html += '<span style="background:' + sc + '20;border:1px solid ' + sc + '50;color:' + sc + ';font-size:10px;font-weight:900;padding:2px 9px;border-radius:20px;">' + se + ' ' + (o.status||'pending').toUpperCase() + '</span>';
            html += '</div>';
            if (o.items && o.items.length) {
                o.items.forEach(function(it) {
                    html += '<div style="font-size:12px;color:rgba(255,255,255,0.6);">' + (it.emoji||'') + ' ' + _msEsc(it.name||'Item') + ' ' + (it.qty||1) + '</div>';
                });
            }
            html += '<div style="font-size:13px;font-weight:900;color:#fbbf24;margin-top:8px;">Total:  ' + Number(o.totalCoins||0).toLocaleString() + '</div>';
            html += '</div>';
        });
        list.innerHTML = html;
    });
}

// ============================================================
// ===== HAMBURGER DRAWER SYSTEM =====
// ============================================================
function toggleDrawer() {
    var drawer = document.getElementById('sideDrawer');
    var overlay = document.getElementById('drawerOverlay');
    var btn = document.getElementById('hamburgerBtn');
    var isOpen = drawer.classList.contains('open');
    if (isOpen) {
        closeDrawer();
    } else {
        drawer.classList.add('open');
        overlay.classList.add('open');
        btn.classList.add('open');
        try { lucide.createIcons(); } catch(e) {}
    }
}
function closeDrawer() {
    var drawer = document.getElementById('sideDrawer');
    var overlay = document.getElementById('drawerOverlay');
    var btn = document.getElementById('hamburgerBtn');
    drawer.classList.remove('open');
    overlay.classList.remove('open');
    if(btn) btn.classList.remove('open');
}

// Sync drawer active state with tab switches (handled directly inside switchTab now)
function updateDrawerActiveState(tab) {
    document.querySelectorAll('.drawer-nav-item').forEach(function(el) { el.classList.remove('active'); });
    var target = document.getElementById('dnav-' + tab);
    if (target) target.classList.add('active');
}

// ============================================================
// ===== HAMBURGER MENU SYSTEM =====
// ============================================================
function toggleHamburgerMenu() {
    var menu = document.getElementById('hamburgerMenu');
    var overlay = document.getElementById('hamburgerOverlay');
    var btn = document.getElementById('hamburgerBtn');
    if (!menu) return;
    var isOpen = menu.classList.contains('open');
    if (isOpen) {
        menu.classList.remove('open');
        overlay.classList.remove('open');
        btn.classList.remove('open');
    } else {
        menu.classList.add('open');
        overlay.classList.add('open');
        btn.classList.add('open');
        if (typeof lucide !== 'undefined') lucide.createIcons();
    }
}
function closeHamburgerMenu() {
    var menu = document.getElementById('hamburgerMenu');
    var overlay = document.getElementById('hamburgerOverlay');
    var btn = document.getElementById('hamburgerBtn');
    if (menu) menu.classList.remove('open');
    if (overlay) overlay.classList.remove('open');
    if (btn) btn.classList.remove('open');
}
// updateHamburgerActive is called directly inside switchTab
function updateHamburgerActive(tab) {
    var items = document.querySelectorAll('.hamburger-nav-item[id^="hmenu-"]');
    items.forEach(function(el) { el.classList.remove('active'); });
    var target = document.getElementById('hmenu-' + tab);
    if (target) target.classList.add('active');
}
// ============================================================
</script>
</body>
</html>
