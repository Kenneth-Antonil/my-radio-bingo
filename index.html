<!DOCTYPE html>
<html lang="tl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Radio Bingo Live | Official</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/coco-ssd"></script>

    <style>
        :root { --bg: #0b1120; --surface: #1e293b; --surface-br: #334155; --accent: #3b82f6; --text: #f8fafc; --gold: #fbbf24; --success: #10b981; --danger: #ef4444; --bringme: #8b5cf6; --bringme-dark: #4c1d95; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { font-family: 'Inter', sans-serif; background: var(--bg); color: var(--text); margin: 0; padding-bottom: 20px; overflow-x: hidden; }

        /* PINAGANDANG LOGIN SECTION */
        #loginOverlay { 
            position: fixed; 
            inset: 0; 
            background: linear-gradient(rgba(11, 17, 32, 0.8), rgba(11, 17, 32, 0.8)), url('https://images.unsplash.com/photo-1596715094285-1d4b83d9539d?q=80&w=2072&auto=format&fit=crop'); 
            background-size: cover;
            background-position: center;
            z-index: 9999; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            padding: 20px; 
        }
        .login-card { 
            background: rgba(30, 41, 59, 0.7); 
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            padding: 50px 30px; 
            border-radius: 40px; 
            width: 100%; 
            max-width: 400px; 
            text-align: center; 
            border: 1px solid rgba(255,255,255,0.15); 
            box-shadow: 0 25px 50px rgba(0,0,0,0.6); 
        }
        .login-logo { font-size: 42px; font-weight: 900; margin-bottom: 10px; letter-spacing: -2px; }
        .login-logo span { color: var(--accent); }
        .login-sub { font-size: 15px; opacity: 0.9; margin-bottom: 35px; line-height: 1.6; font-weight: 500; }
        .btn-google { background: white; color: #000; border: none; width: 100%; padding: 16px; border-radius: 16px; font-weight: 800; display: flex; align-items: center; justify-content: center; gap: 12px; cursor: pointer; font-size: 16px; transition: 0.3s; box-shadow: 0 10px 20px rgba(0,0,0,0.2); }
        .btn-google:hover { transform: translateY(-2px); box-shadow: 0 15px 25px rgba(0,0,0,0.3); }

        .nav { background: var(--surface); padding: 0 15px; display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 100; border-bottom: 1px solid rgba(255,255,255,0.1); height: 65px; }
        .user-stats { display: flex; align-items: center; gap: 10px; }
        .icon-btn { background: var(--surface-br); color: white; border: 1px solid rgba(255,255,255,0.1); width: 40px; height: 40px; border-radius: 12px; cursor: pointer; position: relative; display: flex; align-items: center; justify-content: center; }
        .notif-badge { position: absolute; top: 8px; right: 8px; background: var(--danger); width: 8px; height: 8px; border-radius: 50%; border: 2px solid var(--surface); display: none; }
        .points-badge { background: rgba(251, 191, 36, 0.1); color: var(--gold); padding: 0 15px; height: 40px; border-radius: 12px; font-weight: 800; border: 1px solid var(--gold); font-size: 13px; cursor: pointer; display: flex; align-items: center; gap: 6px; }
        .points-badge i { width: 16px; height: 16px; }
        .tab-container { display: flex; gap: 10px; margin: 20px 15px; }
        .tab-btn { flex: 1; padding: 14px; border-radius: 14px; border: none; font-weight: 800; cursor: pointer; background: var(--surface); color: #94a3b8; }
        .tab-btn.active { background: var(--accent); color: white; }

        .content { padding: 0 15px; }
        .card { background: var(--surface); border-radius: 24px; padding: 20px; margin-bottom: 20px; border: 1px solid rgba(255,255,255,0.08); }
        .card h3 { margin-top: 0; margin-bottom: 10px; display: flex; align-items: center; gap: 8px; }
        .bingo-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 8px; margin-top: 15px; }
        .bingo-cell { background: var(--surface-br); border-radius: 12px; aspect-ratio: 1; display: flex; align-items: center; justify-content: center; font-weight: 900; font-size: 18px; color: #64748b; }
        .bingo-cell.active { background: var(--accent); color: white; box-shadow: 0 0 15px var(--accent); }

        .bringme-box { background: linear-gradient(135deg, var(--bringme), var(--bringme-dark)); border-radius: 24px; padding: 20px; color: white; }
        .bringme-box h3 { margin-top: 0; }
        .bringme-box button { background: white; color: var(--bringme-dark); border: none; padding: 14px; border-radius: 14px; font-weight: 900; cursor: pointer; width: 100%; }

        .camera-wrap { margin-top: 15px; background: rgba(0,0,0,0.3); border-radius: 16px; overflow: hidden; position: relative; }
        video { width: 100%; display: block; }
        canvas { position: absolute; inset: 0; }

        .hidden { display: none; }
    </style>
</head>
<body>

<div id="loginOverlay">
    <div class="login-card">
        <div class="login-logo">RADIO <span>BINGO</span></div>
        <div class="login-sub">Mag-login gamit ang Google upang makasali sa live Radio Bingo!</div>
        <button class="btn-google" onclick="loginGoogle()">
            <img src="https://www.svgrepo.com/show/475656/google-color.svg" width="22">
            Continue with Google
        </button>
    </div>
</div>

<div class="nav">
    <div style="font-weight:900">RADIO BINGO</div>
    <div class="user-stats">
        <div class="points-badge" id="pointsBadge">
            <i data-lucide="star"></i>
            <span id="userPoints">0</span>
        </div>
        <button class="icon-btn" onclick="openNotifications()">
            <i data-lucide="bell"></i>
            <span class="notif-badge" id="notifDot"></span>
        </button>
        <button class="icon-btn" onclick="logout()">
            <i data-lucide="log-out"></i>
        </button>
    </div>
</div>

<div class="tab-container">
    <button class="tab-btn active" onclick="switchTab('bingo')">BINGO</button>
    <button class="tab-btn" onclick="switchTab('bringme')">BRING ME</button>
</div>

<div class="content">
    <div id="bingoTab">
        <div class="card">
            <h3><i data-lucide="grid"></i> Bingo Card</h3>
            <div class="bingo-grid" id="bingoGrid"></div>
        </div>
    </div>

    <div id="bringmeTab" class="hidden">
        <div class="bringme-box">
            <h3><i data-lucide="camera"></i> Bring Me Challenge</h3>
            <div id="bringMeItemText">Walang active na challenge</div>
            <button onclick="openCamera()">Submit Photo</button>
        </div>

        <div class="camera-wrap hidden" id="cameraWrap">
            <video id="video" autoplay playsinline></video>
            <canvas id="canvas"></canvas>
            <button class="btn-google" style="margin-top:15px" onclick="capture()">CAPTURE</button>
        </div>
    </div>
</div>
<script>
    const firebaseConfig = {
        databaseURL: "https://radiobingo-68749-default-rtdb.firebaseio.com/"
    };
    firebase.initializeApp(firebaseConfig);

    const db = firebase.database();
    const auth = firebase.auth();

    let currentUser = null;
    let currentTab = 'bingo';

    /* ================= ORIGINAL LOGIC ================= */

    auth.onAuthStateChanged(user => {
        if (user) {
            currentUser = user;
            document.getElementById('loginOverlay').style.display = 'none';
            syncUser();
            trackPresence();
        } else {
            document.getElementById('loginOverlay').style.display = 'flex';
        }
    });

    function loginGoogle() {
        const provider = new firebase.auth.GoogleAuthProvider();
        auth.signInWithPopup(provider);
    }

    function logout() {
        auth.signOut();
    }

    function switchTab(tab) {
        currentTab = tab;
        document.getElementById('bingoTab').classList.toggle('hidden', tab !== 'bingo');
        document.getElementById('bringmeTab').classList.toggle('hidden', tab !== 'bringme');
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        event.target.classList.add('active');
    }

    /* ================= BINGO SYNC ================= */

    const bingoGrid = document.getElementById('bingoGrid');
    for (let i = 1; i <= 25; i++) {
        const cell = document.createElement('div');
        cell.className = 'bingo-cell';
        cell.innerText = i;
        cell.id = 'cell-' + i;
        bingoGrid.appendChild(cell);
    }

    db.ref('bingoBalls').on('value', s => {
        const balls = s.val() || {};
        Object.keys(balls).forEach(num => {
            const el = document.getElementById('cell-' + num);
            if (el && balls[num]) el.classList.add('active');
        });
    });

    /* ================= USER DATA ================= */

    function syncUser() {
        db.ref('users/' + currentUser.uid).once('value', s => {
            if (!s.exists()) {
                db.ref('users/' + currentUser.uid).set({
                    name: currentUser.displayName,
                    points: 0
                });
            }
        });

        db.ref('users/' + currentUser.uid + '/points').on('value', s => {
            document.getElementById('userPoints').innerText = s.val() || 0;
        });
    }

    /* ================= BRING ME ================= */

    db.ref('bringMe').on('value', s => {
        const data = s.val();
        const txt = document.getElementById('bringMeItemText');
        if (!data || !data.active) {
            txt.innerText = "Walang active na challenge";
        } else {
            txt.innerText = "Hanapin at kunan ng larawan: " + data.item;
        }
    });

    let video = document.getElementById('video');
    let canvas = document.getElementById('canvas');
    let ctx = canvas.getContext('2d');

    function openCamera() {
        document.getElementById('cameraWrap').classList.remove('hidden');
        navigator.mediaDevices.getUserMedia({ video: true })
            .then(stream => video.srcObject = stream);
    }

    function capture() {
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        ctx.drawImage(video, 0, 0);
        canvas.toBlob(blob => {
            const ref = db.ref('bringMeSubmissions').push();
            ref.set({
                uid: currentUser.uid,
                userName: currentUser.displayName,
                img: URL.createObjectURL(blob),
                time: Date.now()
            });
            alert("Submitted!");
        });
    }

    /* ================= NOTIFICATIONS ================= */

    function openNotifications() {
        db.ref('notifications/' + currentUser.uid).once('value', s => {
            let msg = "Notifications:\n\n";
            s.forEach(n => msg += "• " + n.val().msg + "\n");
            alert(msg || "Wala pa");
            document.getElementById('notifDot').style.display = 'none';
        });
    }

    /* ================= PRESENCE ================= */

    function trackPresence() {
        const ref = db.ref('presence/' + currentUser.uid);
        firebase.database().ref('.info/connected').on('value', snap => {
            if (snap.val()) {
                ref.set(true);
                ref.onDisconnect().remove();
            }
        });
    }

    lucide.createIcons();
</script>

<!-- ===================================================== -->
<!-- =============== APPENDED NEW FEATURES ================ -->
<!-- =============== (ADD ONLY – SAFE) =================== -->
<!-- ===================================================== -->

<script>
/* ===== OFFLINE / ONLINE DETECTOR ===== */
window.addEventListener('offline', () => {
    alert("⚠️ Offline ka. Hintayin bumalik ang internet.");
});
window.addEventListener('online', () => {
    alert("✅ Online na ulit!");
});

/* ===== SESSION GUARD ===== */
setInterval(() => {
    if (currentUser && auth.currentUser && currentUser.uid !== auth.currentUser.uid) {
        alert("Session error. Please login again.");
        logout();
    }
}, 5000);

/* ===== LOCAL CACHE OPTIMIZER ===== */
db.ref('bingoBalls').once('value', s => {
    localStorage.setItem('cachedBalls', JSON.stringify(s.val() || {}));
});

/* ===== ANTI DOUBLE SUBMIT ===== */
let submitting = false;
const _origCapture = capture;
capture = function() {
    if (submitting) return alert("Submitting…");
    submitting = true;
    _origCapture();
    setTimeout(() => submitting = false, 3000);
};

/* ===== SAFE ERROR LOGGER ===== */
window.addEventListener('error', e => {
    console.error("Soft Error:", e.message);
});

/* ===== DOM READY SAFE ===== */
document.addEventListener('DOMContentLoaded', () => {
    console.log("Radio Bingo Ready");
});
</script>

</body>
</html>
