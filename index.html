<!DOCTYPE html>
<html lang="tl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Radio Bingo Live | Home</title>
    <link href="style.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;900&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-messaging.js"></script>
</head>
<body>

<div id="splash-screen">
    <div class="splash-logo">RB<span>LIVE</span></div>
    <div class="splash-loader"></div>
</div>

<div id="notifBlocker">
    <div class="notif-gate-icon"><i data-lucide="bell-ring" style="width:40px;height:40px;color:#3b82f6;"></i></div>
    <div class="notif-gate-title">ENABLE NOTIFICATIONS</div>
    <p class="notif-gate-desc">Required ang notifications para sa real-time updates.</p>
    <button onclick="requestGatePermission()" class="btn-allow-notif">ALLOW NOTIFICATIONS</button>
    <div id="blockedHelp" class="blocked-help">
        <strong style="color:var(--danger)">‚ö†Ô∏è BLOCKED!</strong><br>Check site settings/permissions.
    </div>
</div>

<div id="customToast"><i data-lucide="info" class="toast-icon"></i><span class="toast-msg" id="toastMsg">Notification</span></div>
<div id="customConfirmModal">
    <div class="conf-content">
        <h3 class="conf-title" id="confTitle">Confirm</h3>
        <p class="conf-msg" id="confMsg">Proceed?</p>
        <div class="conf-actions">
            <button class="btn-conf-no" onclick="closeCustomConfirm()">CANCEL</button>
            <button class="btn-conf-yes" id="confYesBtn">CONFIRM</button>
        </div>
    </div>
</div>

<div id="loginOverlay">
    <div class="login-bg-blob blob-1"></div>
    <div class="login-bg-blob blob-2"></div>
    <div class="login-app-container">
        <div class="app-logo-lg">RB<span>LIVE</span></div>
        <p class="app-tagline">Play, Win, and Connect.</p>
        <div class="auth-btn-group">
            <button class="btn-main-auth" onclick="login()">
                <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/action/google.svg" style="width:20px"> Sign in with Google
            </button>
        </div>
    </div>
</div>

<div class="nav">
    <div style="display:flex; align-items:center; gap:10px;">
        <span style="font-weight: 900; font-size: 20px;">RB <span style="color:var(--accent-glow)">LIVE</span></span>
    </div>
    <div id="userPanel" style="display:none; align-items: center; gap: 10px;">
        <div class="user-stats">
            <div class="icon-btn" onclick="openSearch()"><i data-lucide="search" style="width:20px"></i></div>
            <div class="icon-btn" onclick="openNotifs()">
                <i data-lucide="bell" style="width:20px"></i>
                <span id="notifDot" class="notif-badge"></span>
            </div>
            <div class="points-badge" onclick="window.location.href='store.html'"><i data-lucide="coins" style="width:18px"></i> <span id="userPoints">0</span></div>
        </div>
        <img id="userImg" src="" style="width:45px; height:45px; border-radius:50%; border:2px solid var(--accent);" onclick="window.location.href='me.html'">
    </div>
</div>

<div class="container">
    <div id="friendRequestsSection"></div>

    <div class="post-creator" id="mainPostCreator">
        <h4 style="margin:0 0 10px 0; color:white; font-size:14px;">Post Something</h4>
        <textarea id="postInput" class="post-input" placeholder="What's on your mind?"></textarea>
        
        <div class="image-preview-container" id="imgPreviewCont">
            <img id="postImgPreview" class="image-preview-img">
            <div class="btn-remove-img" onclick="removePostImage()">X</div>
        </div>

        <div style="display:flex; justify-content:space-between; align-items:center; margin-top:5px;">
            <label for="postImgInput" style="cursor:pointer; color:var(--accent-glow); font-size:12px; font-weight:700; display:flex; align-items:center; gap:5px;">
                <i data-lucide="image" style="width:16px;"></i> Photo
            </label>
            <input type="file" id="postImgInput" accept="image/*" style="display:none" onchange="handlePostImage(this)">
        </div>
        
        <div class="mood-selector" style="margin-top:10px;">
            <div class="mood-chip" onclick="selectMood(this, 'Happy')">üòä Happy</div>
            <div class="mood-chip" onclick="selectMood(this, 'Sad')">üòî Sad</div>
            <div class="mood-chip" onclick="selectMood(this, 'Excited')">ü§© Excited</div>
            <div class="mood-chip" onclick="selectMood(this, 'Chill')">üòé Chill</div>
        </div>
        <button class="btn-post" onclick="createPost()">POST</button>
    </div>

    <div id="pymkSection" class="pymk-section" style="display:none;">
        <div class="pymk-title">People You May Know</div>
        <div class="pymk-scroll" id="pymkList"></div>
    </div>

    <div id="socialFeed" class="social-feed-container">
        <div style="text-align:center; padding:20px; opacity:0.5;">Loading Feed...</div>
    </div>
</div>

<div class="bottom-nav">
    <button class="nav-item active" onclick="window.location.href='index.html'">
        <i data-lucide="home" class="nav-icon"></i><span class="nav-label">Home</span>
    </button>
    <button class="nav-item" onclick="window.location.href='bingo.html'">
        <i data-lucide="play-circle" class="nav-icon"></i><span class="nav-label">Bingo</span>
    </button>
    <div class="nav-center" onclick="document.getElementById('postInput').focus()">
        <div class="nav-icon-bg"><i data-lucide="plus" style="width:28px; height:28px;"></i></div>
    </div>
    <button class="nav-item" onclick="window.location.href='store.html'">
        <i data-lucide="shopping-bag" class="nav-icon"></i><span class="nav-label">Store</span>
    </button>
    <button class="nav-item" onclick="window.location.href='me.html'">
        <i data-lucide="user" class="nav-icon"></i><span class="nav-label">Me</span>
    </button>
</div>

<div id="searchModal" class="search-modal-container">
    <div class="search-header">
        <button onclick="document.getElementById('searchModal').style.display='none'" style="background:none; border:none; color:white;"><i data-lucide="arrow-left"></i></button>
        <div class="search-bar-wrap">
            <i data-lucide="search" style="width:16px; opacity:0.5;"></i>
            <input type="text" id="searchInput" class="search-input" placeholder="Search users..." onkeyup="handleSearch()">
        </div>
    </div>
    <div id="searchResults" class="search-results">
        <div style="text-align:center; opacity:0.5; padding:20px;">Type to search...</div>
    </div>
</div>

<div id="commentModalBackdrop" class="comment-modal-backdrop" onclick="closeComments()"></div>
<div id="commentModal" class="comment-modal">
    <div class="comment-header">
        <h3 style="margin:0; font-size:16px;">Comments</h3>
        <button onclick="closeComments()" style="background:none; border:none; color:white;"><i data-lucide="x"></i></button>
    </div>
    <div id="commentList" class="comment-list"></div>
    <form class="comment-input-area" onsubmit="event.preventDefault(); sendComment();">
        <input type="text" id="commentInput" class="comment-input" placeholder="Write a comment..." autocomplete="off">
        <button type="submit" style="background:none; border:none; color:var(--accent);"><i data-lucide="send"></i></button>
    </form>
</div>

<div id="notifModal" class="modal" onclick="this.style.display='none'">
    <div class="modal-content" onclick="event.stopPropagation()">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px; border-bottom:1px solid rgba(255,255,255,0.1); padding-bottom:15px;">
            <h3 style="margin:0;">Notifications</h3>
            <button onclick="document.getElementById('notifModal').style.display='none'" style="background:none; border:none; color:white;"><i data-lucide="x"></i></button>
        </div>
        <div id="notifList"></div>
    </div>
</div>

<div id="userOptionsModal" class="modal" onclick="this.style.display='none'">
    <div class="modal-content" onclick="event.stopPropagation()" style="text-align:center;">
        <img id="optUserImg" style="width:60px; height:60px; border-radius:50%; border:2px solid var(--accent); margin-bottom:10px;">
        <h3 id="optUserName" style="margin:0 0 20px 0; color:white;">User</h3>
        <button class="user-opt-btn" onclick="openUserProfile(targetUserForOpt.uid)"><i data-lucide="user"></i> View Profile</button>
        <button class="user-opt-btn" onclick="optAddFriend()"><i data-lucide="user-plus"></i> Add Friend</button>
        <button class="user-opt-btn" onclick="document.getElementById('userOptionsModal').style.display='none'"><i data-lucide="x"></i> Close</button>
    </div>
</div>

<div id="userProfilePage" class="profile-page-container">
    <button class="profile-nav-back" onclick="closeProfilePage()"><i data-lucide="arrow-left"></i></button>
    <div class="profile-cover" id="pageProfileCover"></div>
    <div class="profile-info-section">
        <div class="profile-header-row"><img id="pageProfileImg" class="profile-page-img" src=""></div>
        <h2 id="pageProfileName" class="profile-page-name">User Name</h2>
        <button id="profileMainActionBtn" class="profile-action-btn">Add Friend</button>
        <p id="pageProfileBio" class="profile-page-bio">Radio Bingo Player</p>
        <div class="profile-stats">
            <div class="stat-item"><div class="stat-val" id="statFriends">0</div><div class="stat-lbl">Friends</div></div>
            <div class="stat-item"><div class="stat-val" id="statLikes">0</div><div class="stat-lbl">Likes</div></div>
            <div class="stat-item"><div class="stat-val" id="statPosts">0</div><div class="stat-lbl">Posts</div></div>
        </div>
        <div id="pageProfileFeed" class="profile-feed-section"></div>
    </div>
</div>

<script>
    // --- GLOBAL VARIABLES & CONFIG ---
    window.addEventListener('load', () => { setTimeout(hideSplash, 2000); checkNotifGate(); });
    function hideSplash() { const ss = document.getElementById('splash-screen'); if(ss) { ss.style.opacity = '0'; setTimeout(() => ss.style.display = 'none', 800); } }
    
    // Notification Blocker Logic
    function checkNotifGate() {
        const blocker = document.getElementById('notifBlocker');
        if (!("Notification" in window)) { blocker.style.display = 'none'; return; }
        if (Notification.permission === "granted") { blocker.style.display = 'none'; } 
        else if (Notification.permission === "denied") { blocker.style.display = 'flex'; document.getElementById('blockedHelp').style.display = 'block'; } 
        else { blocker.style.display = 'flex'; document.getElementById('blockedHelp').style.display = 'none'; }
    }
    function requestGatePermission() { Notification.requestPermission().then(permission => { if (permission === "granted") { checkNotifGate(); requestNotifyPermission(); } else { checkNotifGate(); } }); }
    
    // Sounds & Toast
    const sounds = { click: new Audio('https://cdn.pixabay.com/audio/2022/03/15/audio_2731885542.mp3'), pop: new Audio('https://cdn.freesound.org/previews/536/536108_1415754-lq.mp3'), win: new Audio('https://cdn.freesound.org/previews/270/270404_5123851-lq.mp3') };
    function playSound(type) { if(sounds[type]) { sounds[type].currentTime = 0; sounds[type].play().catch(e=>{}); } }
    function showToast(msg) { const toast = document.getElementById('customToast'); document.getElementById('toastMsg').innerText = msg; toast.classList.add('show'); playSound('click'); setTimeout(() => { toast.classList.remove('show'); }, 3000); }
    
    let confirmCallback = null;
    function showCustomConfirm(title, msg, onYes) { document.getElementById('confTitle').innerText = title; document.getElementById('confMsg').innerText = msg; document.getElementById('customConfirmModal').style.display = 'flex'; confirmCallback = onYes; playSound('click'); }
    function closeCustomConfirm() { document.getElementById('customConfirmModal').style.display = 'none'; confirmCallback = null; }
    document.getElementById('confYesBtn').addEventListener('click', () => { if(confirmCallback) confirmCallback(); closeCustomConfirm(); });

    // Firebase Init
    const firebaseConfig = { apiKey: "AIzaSyDIAQXJ15atKJxu7PtcFL1W9JnO1N14pVs", authDomain: "radiobingo-9ac29.firebaseapp.com", databaseURL: "https://radiobingo-9ac29-default-rtdb.asia-southeast1.firebasedatabase.app", projectId: "radiobingo-9ac29", storageBucket: "radiobingo-9ac29.firebasestorage.app", messagingSenderId: "965903993397", appId: "1:965903993397:web:f6646fa05225f147eebf7c" };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database(); const auth = firebase.auth();
    let messaging; try { messaging = firebase.messaging(); } catch(e) {}
    let userData = {};

    function requestNotifyPermission() { if ("Notification" in window && messaging) { Notification.requestPermission().then(permission => { if (permission === "granted") { messaging.getToken().then((token) => { if (token && auth.currentUser) db.ref('users/' + auth.currentUser.uid).update({ fcmToken: token }); }); } }); } }

    function login() { playSound('click'); auth.signInWithPopup(new firebase.auth.GoogleAuthProvider()).then(() => { requestNotifyPermission(); checkNotifGate(); }); }

    // AUTH STATE & INITIALIZATION
    auth.onAuthStateChanged(u => {
        if(u) {
            if(messaging) { messaging.getToken().then(t => { if(t) db.ref('users/'+u.uid).update({fcmToken:t}); }); messaging.onMessage(p => { showToast((p.notification?p.notification.title:"New") + ": " + (p.notification?p.notification.body:"Message")); playSound('pop'); }); }
            document.getElementById('loginOverlay').style.display = 'none';
            document.getElementById('userPanel').style.display = 'flex';
            document.getElementById('userImg').src = u.photoURL;
            
            // Check User DB
            const userRef = db.ref('users/'+u.uid);
            userRef.once('value', s => {
                if(!s.exists()) {
                    const refCode = Math.random().toString(36).substring(2,8).toUpperCase();
                    userRef.set({ name: u.displayName, photo: u.photoURL, points: 500, refCode: refCode, last_seen: Date.now(), ownedSkins:['default'], equippedSkin:'default' });
                } else {
                    const d = s.val();
                    const updates = { last_seen: Date.now() };
                    if(!d.name) updates.name = u.displayName;
                    if(!d.photo) updates.photo = u.photoURL;
                    if(d.lastLoginDate !== new Date().toDateString()) { updates.points = (d.points||0)+200; updates.lastLoginDate = new Date().toDateString(); showToast("üéÅ Daily Bonus: +200 Coins"); playSound('win'); }
                    userRef.update(updates);
                }
            });
            userRef.on('value', s => { 
                if(s.exists()){ 
                    userData = s.val(); userData.uid = u.uid; 
                    document.getElementById('userPoints').innerText = (userData.points || 0).toLocaleString();
                    updatePresenceData(u.uid, userData.name, userData.points, userData.photo);
                } 
            });
            
            // Initialize Feed features
            initSocialSystem(u.uid);
            loadSocialFeed();
            loadPYMK();
            listenNotifications(u.uid);
            lucide.createIcons();
        } else {
            document.getElementById('loginOverlay').style.display = 'flex';
        }
    });

    // --- SOCIAL FEED LOGIC ---
    let postListener = null;
    let selectedMood = null;
    let selectedImageBase64 = null;

    function initSocialSystem(uid) {
        db.ref('friendRequests/' + uid).on('value', s => {
            const c = document.getElementById('friendRequestsSection'); c.innerHTML = "";
            s.forEach(req => {
                const rUid = req.key;
                db.ref('users/' + rUid).once('value', u => {
                    const d = u.val();
                    const div = document.createElement('div'); div.className = 'friend-req-card';
                    div.innerHTML = `<div class="req-info"><img src="${d.photo}" style="width:30px;height:30px;border-radius:50%;"><span>${d.name} sent request</span></div><div class="req-actions"><button class="btn-accept" onclick="acceptFriend('${rUid}')">Accept</button><button class="btn-decline" onclick="declineFriend('${rUid}')">X</button></div>`;
                    c.appendChild(div);
                });
            });
        });
    }

    function acceptFriend(rUid) { db.ref('friends/'+auth.currentUser.uid+'/'+rUid).set(true); db.ref('friends/'+rUid+'/'+auth.currentUser.uid).set(true); db.ref('friendRequests/'+auth.currentUser.uid+'/'+rUid).remove(); showToast("Friends Connected!"); }
    function declineFriend(rUid) { db.ref('friendRequests/'+auth.currentUser.uid+'/'+rUid).remove(); }

    function loadSocialFeed() {
        const c = document.getElementById('socialFeed');
        if(postListener) return;
        postListener = db.ref('socialPosts').limitToLast(50);
        postListener.on('value', snap => {
            const all = []; snap.forEach(x => all.push({key:x.key, ...x.val()}));
            all.sort((a,b) => b.timestamp - a.timestamp);
            c.innerHTML = "";
            if(all.length===0) { c.innerHTML = "<div style='text-align:center;opacity:0.5;padding:20px;'>No posts yet.</div>"; return; }
            
            db.ref('friends/'+auth.currentUser.uid).once('value', fSnap => {
                const friends = fSnap.exists() ? Object.keys(fSnap.val()) : [];
                let adCount = 0;
                all.forEach(p => {
                    const isFriend = friends.includes(p.uid);
                    const isMe = p.uid === auth.currentUser.uid;
                    const badge = (isFriend || isMe) ? `<span class="friend-badge">${isMe?'YOU':'FRIEND'}</span>` : '';
                    const div = document.createElement('div'); div.className = 'post-card';
                    const imgH = p.image ? `<div class="post-image-container"><img src="${p.image}" class="post-image"></div>` : '';
                    div.innerHTML = `
                        <div class="post-header">
                            <img class="post-avatar" src="${p.authorPhoto}" onclick="showUserOptions('${p.uid}', '${p.authorName.replace(/'/g,"\\'")}', '${p.authorPhoto}')">
                            <div class="post-meta"><div class="post-author">${p.authorName} ${getBadgeHtml(p.authorPoints||0)} ${badge}</div><div class="post-time">${fixDate(p.timestamp)}</div>${p.mood?`<div class="mood-display">Feeling ${p.mood}</div>`:''}</div>
                        </div>
                        <div class="post-content">${p.content}</div>${imgH}
                        <div class="post-actions">
                            <button class="action-btn" id="like-${p.key}" onclick="toggleLike('${p.key}','${p.uid}')"><i data-lucide="heart" style="width:14px"></i> <span id="lc-${p.key}">${p.likes||0}</span></button>
                            <button class="action-btn" onclick="openComments('${p.key}')"><i data-lucide="message-circle" style="width:14px"></i> Comment</button>
                        </div>
                    `;
                    c.appendChild(div);
                    // Check liked
                    db.ref('postLikes/'+p.key+'/'+auth.currentUser.uid).once('value', l=>{ if(l.exists()){ document.getElementById('like-'+p.key).classList.add('liked'); document.getElementById('like-'+p.key).querySelector('svg').style.fill='var(--minigame)'; }});
                });
                lucide.createIcons();
            });
        });
    }

    // --- POST CREATION ---
    function selectMood(el, m) { document.querySelectorAll('.mood-chip').forEach(x=>x.classList.remove('active')); if(selectedMood===m){selectedMood=null;}else{el.classList.add('active'); selectedMood=m;} }
    function handlePostImage(input) { if(input.files[0]) compressImage(input.files[0], 800, 0.7).then(b64 => { selectedImageBase64=b64; document.getElementById('postImgPreview').src=b64; document.getElementById('imgPreviewCont').style.display='block'; }); }
    function removePostImage() { selectedImageBase64=null; document.getElementById('postImgInput').value=""; document.getElementById('imgPreviewCont').style.display='none'; }
    function createPost() {
        const t = document.getElementById('postInput').value.trim();
        if(!t && !selectedImageBase64) return showToast("Empty post!");
        db.ref('socialPosts').push({ uid:auth.currentUser.uid, authorName:userData.name, authorPhoto:userData.photo, authorPoints:userData.points, content:t, mood:selectedMood, image:selectedImageBase64, timestamp:Date.now(), likes:0 });
        document.getElementById('postInput').value=""; removePostImage(); document.querySelectorAll('.mood-chip').forEach(x=>x.classList.remove('active')); selectedMood=null; showToast("Posted!"); playSound('pop');
    }

    // --- LIKES & COMMENTS ---
    function toggleLike(key, authUid) {
        const uid = auth.currentUser.uid; const ref = db.ref('postLikes/'+key+'/'+uid);
        ref.once('value', s => {
            if(s.exists()){ ref.remove(); db.ref('socialPosts/'+key+'/likes').transaction(x=>(x||1)-1); document.getElementById('like-'+key).classList.remove('liked'); document.getElementById('like-'+key).querySelector('svg').style.fill='none'; }
            else { ref.set(true); db.ref('socialPosts/'+key+'/likes').transaction(x=>(x||0)+1); document.getElementById('like-'+key).classList.add('liked'); document.getElementById('like-'+key).querySelector('svg').style.fill='var(--minigame)'; if(authUid!==uid) { db.ref('users/'+authUid+'/points').transaction(p=>(p||0)+10); } }
        });
    }
    let curPostKey = null;
    function openComments(k) { curPostKey=k; document.getElementById('commentModal').style.display='flex'; document.getElementById('commentModalBackdrop').style.display='block'; loadComments(k); }
    function closeComments() { document.getElementById('commentModal').style.display='none'; document.getElementById('commentModalBackdrop').style.display='none'; curPostKey=null; }
    function loadComments(k) {
        const l = document.getElementById('commentList'); l.innerHTML = "Loading...";
        db.ref('postComments/'+k).on('value', s => {
            l.innerHTML=""; if(!s.exists()) { l.innerHTML="No comments yet."; return; }
            s.forEach(c => { const d=c.val(); l.innerHTML += `<div class="comment-item"><img class="comment-avatar" src="${d.uPhoto}"><div class="comment-content-block"><div class="comment-bubble"><div class="comment-author">${d.uName}</div><div class="comment-text">${d.text}</div></div></div></div>`; });
        });
    }
    function sendComment() { const t=document.getElementById('commentInput').value.trim(); if(!t||!curPostKey) return; db.ref('postComments/'+curPostKey).push({uid:auth.currentUser.uid, uName:userData.name, uPhoto:userData.photo, text:t, time:Date.now()}); document.getElementById('commentInput').value=""; }

    // --- SEARCH & PYMK ---
    function loadPYMK() {
        const list = document.getElementById('pymkList');
        db.ref('users').limitToLast(20).once('value', s => {
            db.ref('friends/'+auth.currentUser.uid).once('value', fSnap => {
                const f = fSnap.exists()?Object.keys(fSnap.val()):[]; f.push(auth.currentUser.uid);
                const cand = []; s.forEach(u=>{if(!f.includes(u.key)) cand.push({uid:u.key, ...u.val()})});
                const shuf = cand.sort(()=>0.5-Math.random()).slice(0,5);
                if(shuf.length>0) { list.innerHTML=""; shuf.forEach(u => { list.innerHTML+=`<div class="pymk-card"><img src="${u.photo}" class="pymk-img" onclick="openUserProfile('${u.uid}')"><div class="pymk-name">${u.name}</div><button class="btn-add-friend-sm" onclick="sendFriendReqPYMK('${u.uid}')">ADD</button></div>`; }); document.getElementById('pymkSection').style.display='block'; }
            });
        });
    }
    function sendFriendReqPYMK(uid) { db.ref('friendRequests/'+uid+'/'+auth.currentUser.uid).set(true); showToast("Request Sent!"); loadPYMK(); }
    
    function openSearch() { document.getElementById('searchModal').style.display='flex'; document.getElementById('searchInput').focus(); }
    function handleSearch() {
        const q = document.getElementById('searchInput').value.toLowerCase(); const r = document.getElementById('searchResults');
        if(q.length<2) return;
        db.ref('users').once('value', s => {
            r.innerHTML=""; let found=false;
            s.forEach(u => {
                const d = u.val();
                if(d.name.toLowerCase().includes(q)) { found=true; r.innerHTML+=`<div class="search-res-item" onclick="openUserProfile('${u.key}')"><img src="${d.photo}" class="search-res-img"><div>${d.name}</div></div>`; }
            });
            if(!found) r.innerHTML="No result.";
        });
    }

    // --- NOTIFICATIONS ---
    function listenNotifications(uid) { db.ref('notifications/'+uid).on('value', s=>{ const dot=document.getElementById('notifDot'); let has=false; s.forEach(x=>{if(x.val().type!=='pm') has=true;}); dot.style.display=has?'block':'none'; }); }
    function openNotifs() { document.getElementById('notifModal').style.display='flex'; renderNotifs(); }
    function renderNotifs() { 
        const l=document.getElementById('notifList'); l.innerHTML="";
        db.ref('notifications/'+auth.currentUser.uid).once('value', s=>{
            if(!s.exists()){ l.innerHTML="No notifications."; return; }
            s.forEach(n=>{ const d=n.val(); if(d.type==='pm')return; l.innerHTML+=`<div class="notif-card-new"><div class="notif-header-new"><div class="notif-title">SYSTEM</div><button class="btn-del-notif" onclick="delNotif('${n.key}')">Del</button></div><div class="notif-body">${d.msg}</div></div>`; });
        });
    }
    function delNotif(k) { db.ref('notifications/'+auth.currentUser.uid+'/'+k).remove(); renderNotifs(); }

    // --- USER OPTIONS & PROFILE VIEW ---
    let targetUserForOpt = null;
    function showUserOptions(uid, name, photo) { targetUserForOpt={uid,name,photo}; document.getElementById('optUserImg').src=photo; document.getElementById('optUserName').innerText=name; document.getElementById('userOptionsModal').style.display='flex'; }
    function optAddFriend() { if(targetUserForOpt) sendFriendReqPYMK(targetUserForOpt.uid); document.getElementById('userOptionsModal').style.display='none'; }
    
    function openUserProfile(uid) {
        document.getElementById('userOptionsModal').style.display='none'; document.getElementById('searchModal').style.display='none'; document.getElementById('userProfilePage').style.display='flex';
        db.ref('users/'+uid).once('value', s => {
            const u=s.val(); document.getElementById('pageProfileImg').src=u.photo; document.getElementById('pageProfileName').innerHTML=u.name + " " + getBadgeHtml(u.points);
            document.getElementById('pageProfileBio').innerText=u.bio||"Radio Bingo Player";
            document.getElementById('pageProfileCover').style.backgroundImage = u.cover ? `url('${u.cover}')` : 'none';
            // Stats
            db.ref('friends/'+uid).once('value', f=>document.getElementById('statFriends').innerText=f.numChildren());
            loadProfilePosts(uid);
            
            // Button Logic
            const btn = document.getElementById('profileMainActionBtn');
            if(uid === auth.currentUser.uid) { btn.innerText="Edit Profile"; btn.onclick=()=>window.location.href='me.html'; }
            else {
                db.ref('friends/'+auth.currentUser.uid+'/'+uid).once('value', f=>{
                    if(f.exists()) { btn.innerText="Friends"; btn.className="profile-action-btn secondary"; }
                    else { btn.innerText="Add Friend"; btn.className="profile-action-btn"; btn.onclick=()=>sendFriendReqPYMK(uid); }
                });
            }
        });
    }
    function closeProfilePage() { document.getElementById('userProfilePage').style.display='none'; }
    function loadProfilePosts(uid) {
        const c=document.getElementById('pageProfileFeed'); c.innerHTML="Loading...";
        db.ref('socialPosts').orderByChild('uid').equalTo(uid).limitToLast(10).once('value', s=>{
            c.innerHTML=""; if(!s.exists()){c.innerHTML="No posts.";return;}
            const p=[]; s.forEach(x=>p.push(x.val())); p.reverse().forEach(x=>{ c.innerHTML+=`<div class="post-card"><div class="post-content">${x.content}</div></div>`; });
        });
    }

    // --- UTILS ---
    function compressImage(file, w, q) { return new Promise(r => { const rd = new FileReader(); rd.readAsDataURL(file); rd.onload=e=>{ const i=new Image(); i.src=e.target.result; i.onload=()=>{ const c=document.createElement('canvas'); let wt=i.width, ht=i.height; if(wt>w){ht*=w/wt; wt=w;} c.width=wt; c.height=ht; c.getContext('2d').drawImage(i,0,0,wt,ht); r(c.toDataURL('image/jpeg',q)); }}; }); }
    function fixDate(t) { return new Date(t).toLocaleDateString() + " " + new Date(t).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}); }
    function getBadgeHtml(p) { let c='tier-bronze'; if(p>100000)c='tier-diamond'; else if(p>50000)c='tier-platinum'; else if(p>25000)c='tier-gold'; else if(p>10000)c='tier-silver'; return `<span class="badge-tier ${c}"><i data-lucide="badge-check" class="badge-icon"></i></span>`; }
    function updatePresenceData(uid,n,p,ph) { db.ref('status/'+uid).update({name:n,points:p,photo:ph,state:'online',last_changed:firebase.database.ServerValue.TIMESTAMP}); db.ref('.info/connected').on('value', s=>{ if(s.val()===false)return; db.ref('status/'+uid).onDisconnect().remove(); }); }

</script>
</body>
</html>
