<!DOCTYPE html>
<html lang="tl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Radio Bingo Live | Official</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <style>
        :root { --bg: #0b1120; --surface: #1e293b; --surface-br: #334155; --accent: #3b82f6; --text: #f8fafc; --gold: #fbbf24; --success: #10b981; --danger: #ef4444; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { font-family: 'Inter', sans-serif; background: var(--bg); color: var(--text); margin: 0; padding-bottom: 20px; overflow-x: hidden; }

        /* Login */
        #loginOverlay { position: fixed; inset: 0; background: var(--bg); z-index: 9999; display: flex; align-items: center; justify-content: center; padding: 20px; }
        .login-card { background: var(--surface); padding: 40px 30px; border-radius: 30px; width: 100%; max-width: 400px; text-align: center; border: 1px solid rgba(255,255,255,0.1); }
        .btn-google { background: white; color: #000; border: none; width: 100%; padding: 14px; border-radius: 12px; font-weight: 700; display: flex; align-items: center; justify-content: center; gap: 10px; cursor: pointer; }

        /* Navigation */
        .nav { background: var(--surface); padding: 0 15px; display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 100; border-bottom: 1px solid rgba(255,255,255,0.1); height: 65px; }
        .icon-btn { background: var(--surface-br); color: white; border: 1px solid rgba(255,255,255,0.1); width: 40px; height: 40px; border-radius: 12px; cursor: pointer; position: relative; display: flex; align-items: center; justify-content: center; }
        .notif-badge { position: absolute; top: 8px; right: 8px; background: var(--danger); width: 8px; height: 8px; border-radius: 50%; border: 2px solid var(--surface); display: none; }
        .points-badge { background: rgba(251, 191, 36, 0.1); color: var(--gold); padding: 0 15px; height: 40px; border-radius: 12px; font-weight: 800; border: 1px solid var(--gold); font-size: 13px; display: flex; align-items: center; gap: 6px; }

        /* Layout */
        .container { width: 100%; max-width: 500px; margin: 0 auto; padding: 12px; }
        .card { background: var(--surface); border-radius: 20px; padding: 15px; margin-bottom: 15px; border: 1px solid rgba(255,255,255,0.05); }
        
        /* Banner Style */
        .ref-container { background: linear-gradient(135deg, rgba(59, 130, 246, 0.1), rgba(16, 185, 129, 0.1)); border: 1px solid var(--accent); padding: 15px; border-radius: 16px; margin-bottom: 15px; text-align: center; }
        #nextDrawBanner { background: linear-gradient(135deg, #1e293b, #0f172a); border: 2px solid var(--gold); }

        /* Bingo Grid */
        .grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 6px; }
        .cell { aspect-ratio: 1; background: var(--surface-br); border-radius: 8px; display: flex; align-items: center; justify-content: center; font-weight: 800; font-size: 18px; border: 1px solid rgba(255,255,255,0.05); }
        .cell.hit { background: var(--accent); color: white; }

        /* Modal */
        .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 1000; display: none; align-items: center; justify-content: center; padding: 15px; backdrop-filter: blur(10px); }
        .modal-content { background: var(--surface); border-radius: 28px; width: 100%; max-width: 450px; padding: 25px; max-height: 90vh; overflow-y: auto; }
        .history-box { margin-top: 15px; background: rgba(0,0,0,0.2); border-radius: 15px; padding: 12px; border: 1px solid rgba(255,255,255,0.05); }
    </style>
</head>
<body>

<div id="loginOverlay">
    <div class="login-card">
        <h2 style="margin:0 0 10px 0;">RADIO BINGO</h2>
        <p style="opacity:0.7; font-size:14px; margin-bottom:25px;">Sign in to start winning!</p>
        <button class="btn-google" onclick="login()">Sign in with Google</button>
    </div>
</div>

<div class="nav">
    <div style="font-weight:900;">RADIO<span style="color:var(--accent)">BINGO</span></div>
    <div id="userPanel" style="display:none; align-items:center; gap:10px;">
        <div class="icon-btn" onclick="openNotifs()"><i data-lucide="bell"></i><span id="notifDot" class="notif-badge"></span></div>
        <div class="points-badge" onclick="document.getElementById('storeModal').style.display='flex'"><span id="userPoints">0</span></div>
        <img id="userImg" onclick="openMenuModal()" style="width:40px; height:40px; border-radius:12px; cursor:pointer; border:2px solid var(--accent);">
    </div>
</div>

<div class="container">
    <div id="nextDrawBanner" class="ref-container" style="display:none;">
        <div style="font-size:10px; font-weight:800; color:var(--gold);">NEXT GAME SCHEDULE</div>
        <div id="nextDrawTime" style="font-size:24px; font-weight:900; color:#fff; margin:5px 0;">--:-- --</div>
    </div>

    <div class="card">
        <div id="currentBall" style="font-size:40px; font-weight:900; text-align:center; color:var(--gold);">--</div>
        <div style="text-align:center; font-size:10px; opacity:0.6;">CURRENT BALL</div>
    </div>

    <div class="card">
        <div class="grid" id="bingoGrid"></div>
        <button id="newCardBtn" onclick="generateNewCard()" style="width:100%; margin-top:15px; padding:12px; border-radius:10px; border:none; background:var(--accent); color:white; font-weight:800;">NEW CARD</button>
    </div>
</div>

<div id="notifModal" class="modal" onclick="this.style.display='none'">
    <div class="modal-content" onclick="event.stopPropagation()">
        <h3>Notifications</h3>
        <div id="notifList"></div>
    </div>
</div>

<div id="menuModal" class="modal" onclick="this.style.display='none'">
    <div class="modal-content" onclick="event.stopPropagation()">
        <h3>My Profile</h3>
        <div class="history-box">
            <h4 style="margin:0 0 10px 0; font-size:12px; color:var(--accent);">TRANSACTION HISTORY</h4>
            <div id="historyList"></div>
        </div>
        <button onclick="auth.signOut().then(()=>location.reload())" style="width:100%; margin-top:20px; padding:12px; border:1px solid var(--danger); background:none; color:var(--danger); border-radius:10px;">Sign Out</button>
    </div>
</div>

<script>
    lucide.createIcons();
    // Firebase Config
    const firebaseConfig = { apiKey: "AIzaSyDIAQXJ15atKJxu7PtcFL1W9JnO1N14pVs", authDomain: "radiobingo-9ac29.firebaseapp.com", databaseURL: "https://radiobingo-9ac29-default-rtdb.asia-southeast1.firebasedatabase.app", projectId: "radiobingo-9ac29", storageBucket: "radiobingo-9ac29.firebasestorage.app", messagingSenderId: "965903993397", appId: "1:965903993397:web:f6646fa05225f147eebf7c" };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database(); const auth = firebase.auth();
    
    let userData = {}; let cardNumbers = []; let gameDrawn = [];

    function login() { auth.signInWithPopup(new firebase.auth.GoogleAuthProvider()); }

    auth.onAuthStateChanged(u => {
        if(u) {
            document.getElementById('loginOverlay').style.display = 'none';
            document.getElementById('userPanel').style.display = 'flex';
            document.getElementById('userImg').src = u.photoURL;

            db.ref('users/'+u.uid).on('value', s => {
                if(s.exists()){
                    userData = s.val(); userData.uid = u.uid;
                    document.getElementById('userPoints').innerText = (userData.points || 0).toLocaleString();
                    if(userData.currentCard) { cardNumbers = userData.currentCard; renderCard(); } else { generateNewCard(); }
                }
            });

            listenForNextDraw();
            setupNotifBadge();
            initBingoListeners();
        }
    });

    function listenForNextDraw() {
        db.ref('gameState/nextDraw').on('value', s => {
            const time = s.val();
            const banner = document.getElementById('nextDrawBanner');
            if(time) {
                banner.style.display = 'block';
                document.getElementById('nextDrawTime').innerText = time;
            } else { banner.style.display = 'none'; }
        });
    }

    function setupNotifBadge() {
        db.ref('notifications/' + auth.currentUser.uid).on('value', s => {
            document.getElementById('notifDot').style.display = s.exists() ? 'block' : 'none';
        });
    }

    // FIX: Dito natin ginagawang Petsa ang mga Numero
    function renderNotifs() {
        const list = document.getElementById('notifList');
        db.ref('notifications/' + auth.currentUser.uid).on('value', s => {
            list.innerHTML = "";
            if(!s.exists()) { list.innerHTML = "No notifications"; return; }
            s.forEach(child => {
                const val = child.val();
                // CONVERT TIMESTAMP TO DATE
                const dateObj = new Date(val.time);
                const readableDate = dateObj.toLocaleDateString() + " " + dateObj.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});

                const div = document.createElement('div');
                div.style.cssText = "background:var(--surface-br); padding:10px; border-radius:10px; margin-bottom:8px; border-left:3px solid var(--accent);";
                div.innerHTML = `
                    <div style="font-size:13px;">${val.msg}</div>
                    <div style="font-size:10px; opacity:0.5; margin-top:5px;">${readableDate}</div>
                `;
                list.prepend(div);
            });
        });
    }

    function openNotifs() {
        document.getElementById('notifModal').style.display = 'flex';
        renderNotifs();
    }

    // FIX: Petsa para sa Transaction History
    function openMenuModal() {
        document.getElementById('menuModal').style.display = 'flex';
        const hist = document.getElementById('historyList');
        db.ref('redemptions').orderByChild('uid').equalTo(auth.currentUser.uid).once('value', s => {
            hist.innerHTML = "";
            if(!s.exists()) { hist.innerHTML = "No transactions"; return; }
            s.forEach(child => {
                const v = child.val();
                // CONVERT TIMESTAMP TO DATE
                const dateObj = new Date(v.time || v.timestamp);
                const readableDate = dateObj.toLocaleDateString() + " " + dateObj.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});

                const d = document.createElement('div');
                d.style.cssText = "padding:8px 0; border-bottom:1px solid rgba(255,255,255,0.05); font-size:12px;";
                d.innerHTML = `
                    <div style="display:flex; justify-content:space-between;">
                        <span>${v.item}</span>
                        <span style="color:var(--gold)">${v.status.toUpperCase()}</span>
                    </div>
                    <div style="font-size:10px; opacity:0.4;">${readableDate}</div>
                `;
                hist.prepend(d);
            });
        });
    }

    function initBingoListeners() {
        db.ref('drawnNumbers').on('value', s => {
            const val = s.val();
            gameDrawn = val ? Object.values(val).map(n => n.toString()) : [];
            document.getElementById('currentBall').innerText = gameDrawn.length ? gameDrawn[gameDrawn.length-1] : "--";
            document.getElementById('newCardBtn').disabled = gameDrawn.length > 0;
            updateHits();
        });
    }

    function generateNewCard() {
        const getCol = (min, max) => {
            let nums = []; while(nums.length < 5) {
                let r = Math.floor(Math.random() * (max - min + 1)) + min;
                if(!nums.includes(r)) nums.push(r);
            } return nums.sort((a,b) => a-b);
        };
        const b = getCol(1, 15), i = getCol(16, 30), n = getCol(31, 45), g = getCol(46, 60), o = getCol(61, 75);
        n[2] = "FREE"; cardNumbers = [];
        for(let row=0; row<5; row++) cardNumbers.push(b[row], i[row], n[row], g[row], o[row]);
        db.ref('users/'+auth.currentUser.uid).update({ currentCard: cardNumbers });
    }

    function renderCard() {
        const grid = document.getElementById('bingoGrid'); grid.innerHTML = "";
        cardNumbers.forEach((n, i) => {
            let d = document.createElement('div');
            d.className = 'cell'; d.id = 'c-'+i;
            d.innerText = n==="FREE"?"â˜…":n;
            grid.appendChild(d);
        });
        updateHits();
    }

    function updateHits() {
        cardNumbers.forEach((n, i) => {
            const el = document.getElementById('c-'+i);
            if(i === 12 || gameDrawn.includes(n.toString())) { if(el) el.classList.add('hit'); }
            else { if(el) el.classList.remove('hit'); }
        });
    }
</script>
</body>
</html>
