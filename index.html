<!DOCTYPE html>
<html lang="tl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Radio Bingo | Live Points & Referrals</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&display=swap" rel="stylesheet">
    
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

    <style>
        :root { 
            --bg: #0b0e14; --surface: #1a1e29; --surface-br: #2d3345;
            --accent: #3b82f6; --text: #f8fafc; --text-dim: #94a3b8; 
            --success: #10b981; --gold: #fbbf24;
        }

        body { font-family: 'Inter', sans-serif; background: var(--bg); color: var(--text); margin: 0; }
        .nav { background: var(--surface); padding: 0 30px; height: 70px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid rgba(255,255,255,0.1); }
        
        .points-badge { background: rgba(251, 191, 36, 0.1); color: var(--gold); padding: 8px 15px; border-radius: 12px; font-weight: 800; border: 1px solid var(--gold); display: flex; align-items: center; gap: 8px; }
        
        .game-wrapper { max-width: 1400px; margin: 30px auto; padding: 0 20px; display: grid; grid-template-columns: 1fr; gap: 30px; }
        @media (min-width: 1024px) { .game-wrapper { grid-template-columns: 1.8fr 1fr; } }

        .card { background: var(--surface); border-radius: 25px; padding: 25px; border: 1px solid rgba(255,255,255,0.05); }
        
        /* Referral Box */
        .referral-box { background: rgba(59, 130, 246, 0.1); border: 1px dashed var(--accent); padding: 15px; border-radius: 15px; margin-bottom: 20px; text-align: center; }
        .ref-code { font-family: monospace; font-size: 18px; color: var(--accent); font-weight: 900; background: #000; padding: 5px 10px; border-radius: 5px; }

        /* Bingo Grid */
        .grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 10px; }
        .cell { aspect-ratio: 1; background: var(--surface-br); border-radius: 12px; display: flex; align-items: center; justify-content: center; font-weight: 800; font-size: 20px; cursor: pointer; border: 1px solid rgba(255,255,255,0.05); }
        .cell.hit { background: var(--accent); color: white; transform: scale(1.05); }
        
        /* Chat */
        .chat-box { height: 500px; display: flex; flex-direction: column; }
        #chatList { flex: 1; overflow-y: auto; padding: 15px; }
        .msg { margin-bottom: 10px; font-size: 14px; background: rgba(255,255,255,0.05); padding: 10px; border-radius: 10px; }
        
        .input-group { display: flex; gap: 10px; padding: 15px; background: rgba(0,0,0,0.2); }
        input { flex: 1; background: var(--bg); border: 1px solid var(--surface-br); padding: 12px; color: white; border-radius: 10px; }
        button { background: var(--accent); color: white; border: none; padding: 10px 20px; border-radius: 10px; cursor: pointer; font-weight: 700; }
    </style>
</head>
<body>

<div class="nav">
    <div style="font-weight: 900; font-size: 20px; color: var(--accent);">BINGO LIVE</div>
    <div id="userPanel" style="display:none; display:flex; gap:15px; align-items:center;">
        <div class="points-badge">ðŸ’° <span id="userPoints">0</span> pts</div>
        <img id="userImg" style="width:35px; border-radius:50%;">
    </div>
</div>

<div id="loginView" style="text-align:center; padding: 100px 20px;">
    <div class="card" style="max-width:400px; margin:auto;">
        <h2>Welcome Back</h2>
        <input type="text" id="refInput" placeholder="Referral Code (Optional)" style="margin-bottom:15px; width:100%;">
        <button onclick="login()" style="width:100%;">Login with Google</button>
    </div>
</div>

<div id="gameUI" class="game-wrapper" style="display:none;">
    <div class="left-col">
        <div class="card referral-box">
            <span style="font-size:12px; font-weight:700;">SHARE & EARN: </span>
            <span class="ref-code" id="myRefCode">------</span>
            <p style="font-size:11px; margin-top:10px; color:var(--text-dim);">Earn 100 points for every friend who joins!</p>
        </div>

        <div class="card">
            <div id="patternDisplay" style="text-align:center; font-size:24px; font-weight:900; margin-bottom:20px; color:var(--accent);">PATTERN: ANY LINE</div>
            <div class="grid" id="bingoGrid"></div>
        </div>
    </div>

    <div class="right-col">
        <div class="card chat-box">
            <div id="chatList"></div>
            <div class="input-group">
                <input type="text" id="chatIn" placeholder="Comment live...">
                <button onclick="sendChat()">Send</button>
            </div>
        </div>
    </div>
</div>

<script>
    // --- FIREBASE SETUP ---
    const firebaseConfig = {
      apiKey: "AIzaSyDIAQXJ15atKJxu7PtcFL1W9JnO1N14pVs",
      authDomain: "radiobingo-9ac29.firebaseapp.com",
      databaseURL: "https://radiobingo-9ac29-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "radiobingo-9ac29",
      storageBucket: "radiobingo-9ac29.firebasestorage.app",
      messagingSenderId: "965903993397",
      appId: "1:965903993397:web:f6646fa05225f147eebf7c"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const auth = firebase.auth();

    let userData = { points: 0, uid: null };
    let marks = [12];
    let cardNumbers = [];

    // --- AUTH & REFERRAL SYSTEM ---
    async function login() {
        const provider = new firebase.auth.GoogleAuthProvider();
        const refCodeUsed = document.getElementById('refInput').value.trim();
        
        auth.signInWithPopup(provider).then(async (result) => {
            const user = result.user;
            const userRef = db.ref('users/' + user.uid);
            
            const snapshot = await userRef.once('value');
            if (!snapshot.exists()) {
                // New User: Process Referral
                let initialPoints = 0;
                if (refCodeUsed) {
                    const refs = await db.ref('referralCodes').once('value');
                    const ownerUid = refs.val() ? refs.val()[refCodeUsed] : null;
                    if (ownerUid && ownerUid !== user.uid) {
                        // Reward the referrer
                        db.ref('users/' + ownerUid + '/points').transaction(p => (p || 0) + 100);
                        initialPoints = 50; // Bonus for the new user
                    }
                }
                
                const myNewCode = user.uid.substring(0, 6).toUpperCase();
                await userRef.set({
                    name: user.displayName,
                    points: initialPoints,
                    refCode: myNewCode
                });
                await db.ref('referralCodes/' + myNewCode).set(user.uid);
            }
            location.reload();
        });
    }

    auth.onAuthStateChanged(user => {
        if (user) {
            document.getElementById('loginView').style.display = 'none';
            document.getElementById('gameUI').style.display = 'grid';
            document.getElementById('userPanel').style.display = 'flex';
            document.getElementById('userImg').src = user.photoURL;
            
            db.ref('users/' + user.uid).on('value', s => {
                const data = s.val();
                document.getElementById('userPoints').innerText = data.points || 0;
                document.getElementById('myRefCode').innerText = data.refCode;
                userData = data;
                userData.uid = user.uid;
            });
            
            generateCard();
            listenForGame();
        }
    });

    // --- BINGO LOGIC ---
    function generateCard() {
        const grid = document.getElementById('bingoGrid');
        grid.innerHTML = "";
        // Simple card generator
        cardNumbers = Array.from({length: 25}, () => Math.floor(Math.random() * 75) + 1);
        cardNumbers[12] = "FREE";
        
        cardNumbers.forEach((num, i) => {
            const cell = document.createElement('div');
            cell.className = 'cell' + (i === 12 ? ' hit' : '');
            cell.id = 'cell-' + i;
            cell.innerText = num === "FREE" ? "â˜…" : num;
            grid.appendChild(cell);
        });
    }

    function listenForGame() {
        db.ref('drawnNumbers').on('value', s => {
            const drawn = s.val() || [];
            cardNumbers.forEach((n, i) => {
                if(drawn.includes(n) && !marks.includes(i)) {
                    marks.push(i);
                    document.getElementById('cell-'+i).classList.add('hit');
                    checkWin();
                }
            });
        });
    }

    function checkWin() {
        const winPatterns = [[0,1,2,3,4], [0,5,10,15,20], [0,6,12,18,24]]; // Simplified for demo
        const isBingo = winPatterns.some(p => p.every(idx => marks.includes(idx)));
        
        if (isBingo && !window.hasWon) {
            window.hasWon = true;
            confetti();
            // Reward Points
            db.ref('users/' + auth.currentUser.uid + '/points').transaction(p => (p || 0) + 500);
            alert("BINGO! You earned 500 points!");
        }
    }

    // --- CHAT LOGIC ---
    function sendChat() {
        const msg = document.getElementById('chatIn').value;
        if (!msg) return;
        db.ref('chat').push({
            name: auth.currentUser.displayName,
            text: msg,
            time: Date.now()
        });
        document.getElementById('chatIn').value = "";
    }

    db.ref('chat').limitToLast(10).on('child_added', s => {
        const d = s.val();
        const div = document.createElement('div');
        div.className = 'msg';
        div.innerHTML = `<b>${d.name}:</b> ${d.text}`;
        const list = document.getElementById('chatList');
        list.appendChild(div);
        list.scrollTop = list.scrollHeight;
    });
</script>

</body>
</html>
