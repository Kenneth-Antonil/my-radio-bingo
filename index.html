<!DOCTYPE html>
<html lang="tl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Radio Bingo Live</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <style>
        :root { --primary: #00f2fe; --accent: #ff4757; --bg: #0f172a; }
        body { font-family: sans-serif; background: var(--bg); color: white; margin: 0; padding: 0; overflow-x: hidden; }
        
        /* LOGIN SCREEN */
        #loginScreen { position: fixed; inset: 0; background: var(--bg); display: flex; align-items: center; justify-content: center; z-index: 1000; flex-direction: column; padding: 20px; }
        .login-box { background: #1e293b; padding: 30px; border-radius: 20px; text-align: center; box-shadow: 0 10px 40px rgba(0,0,0,0.5); width: 100%; max-width: 350px; }
        .login-box input { width: 90%; padding: 12px; margin: 15px 0; border-radius: 8px; border: 1px solid var(--primary); background: #0f172a; color: white; text-align: center; font-size: 1.1rem; }
        .login-box button { width: 100%; padding: 12px; background: var(--primary); color: #000; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; font-size: 1rem; }

        /* MAIN APP */
        #gameUI { display: none; flex-direction: column; min-height: 100vh; }
        .main-layout { display: flex; flex-wrap: wrap; flex: 1; }
        
        .left-panel { flex: 1.5; display: flex; flex-direction: column; min-width: 320px; border-right: 1px solid #1e293b; }
        .video-box { width: 100%; aspect-ratio: 16/9; background: #000; }
        .chat-box { height: 300px; display: flex; flex-direction: column; background: #111827; }
        #chatMsgs { flex: 1; overflow-y: auto; padding: 10px; font-size: 0.9rem; border-bottom: 1px solid #1e293b; }
        .chat-input { display: flex; padding: 10px; gap: 5px; background: #1e293b; }
        .chat-input input { flex: 1; padding: 8px; border-radius: 5px; border: none; background: #0f172a; color: white; }

        .right-panel { flex: 1; min-width: 320px; padding: 20px; display: flex; flex-direction: column; align-items: center; background: #0f172a; }
        .bingo-card { background: white; padding: 12px; border-radius: 15px; width: 280px; box-shadow: 0 0 20px rgba(0,0,0,0.5); }
        .grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 4px; }
        .cell { aspect-ratio: 1; background: #f1f5f9; border: 1px solid #ddd; display: flex; align-items: center; justify-content: center; font-weight: bold; color: #333; border-radius: 5px; font-size: 1rem; }
        .cell.marked { background: var(--primary); color: black; border: none; transform: scale(0.95); box-shadow: 0 0 8px var(--primary); }
        .btn-bingo { width: 280px; padding: 15px; background: var(--accent); color: white; border: none; border-radius: 12px; font-weight: bold; margin-top: 15px; cursor: pointer; font-size: 1.2rem; }

        @media (max-width: 768px) { .main-layout { flex-direction: column; } .left-panel { border-right: none; border-bottom: 1px solid #1e293b; } }
    </style>
</head>
<body>

<div id="loginScreen">
    <div class="login-box">
        <h2 style="color:var(--primary); margin:0;">BINGO LIVE</h2>
        <p>Enter your name to play:</p>
        <input type="text" id="userInput" placeholder="Your Name" maxlength="20">
        <button onclick="joinGame()">JOIN NOW</button>
    </div>
</div>

<div id="gameUI">
    <header style="padding: 10px; text-align: center; background: #1e293b; border-bottom: 1px solid #334155;">
        <span style="font-weight: bold;">ðŸ“» RADIO BINGO: <span style="color:var(--primary)" id="pNameDisp">---</span></span>
    </header>

    <div class="main-layout">
        <div class="left-panel">
            <div class="video-box">
                <iframe src="PASTE_YOUR_VIDEO_EMBED_LINK_HERE" width="100%" height="100%" frameborder="0" allowfullscreen></iframe>
            </div>
            <div class="chat-box">
                <div id="chatMsgs"></div>
                <div class="chat-input">
                    <input type="text" id="chatInp" placeholder="Comment..." onkeypress="if(event.key==='Enter') sendChat()">
                    <button onclick="sendChat()" style="background:var(--primary); border:none; padding:8px 12px; border-radius:5px; cursor:pointer;">Send</button>
                </div>
            </div>
        </div>

        <div class="right-panel">
            <div class="bingo-card">
                <div style="display:flex; justify-content:space-between; margin-bottom:10px; font-weight:900; color:#334155;">
                    <span>B</span><span>I</span><span>N</span><span>G</span><span>O</span>
                </div>
                <div class="grid" id="bingoGrid"></div>
            </div>
            <button class="btn-bingo" onclick="claimBingo()">BINGO!</button>
        </div>
    </div>
</div>

<script>
    const firebaseConfig = {
      apiKey: "AIzaSyDIAQXJ15atKJxu7PtcFL1W9JnO1N14pVs",
      authDomain: "radiobingo-9ac29.firebaseapp.com",
      databaseURL: "https://radiobingo-9ac29-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "radiobingo-9ac29",
      storageBucket: "radiobingo-9ac29.firebasestorage.app",
      messagingSenderId: "965903993397",
      appId: "1:965903993397:web:f6646fa05225f147eebf7c",
      measurementId: "G-RR2EG93C43"
    };

    firebase.initializeApp(firebaseConfig);
    const database = firebase.database();

    let myName = "";
    let cardNumbers = [];
    let markedIndices = [12];
    let uid = "";

    function joinGame() {
        const input = document.getElementById('userInput').value.trim();
        if (input.length < 2) return alert("Enter your name!");
        
        myName = input;
        uid = myName.replace(/\s+/g, '_') + "_" + Date.now();
        
        document.getElementById('loginScreen').style.display = 'none';
        document.getElementById('gameUI').style.display = 'flex';
        document.getElementById('pNameDisp').innerText = myName;

        initCard();
        setupAutoMark();
        setupChat();
        
        // Auto-remove when the user closes the site
        database.ref('players/' + uid).onDisconnect().remove();
    }

    function initCard() {
        const grid = document.getElementById('bingoGrid');
        grid.innerHTML = "";
        let pool = Array.from({length: 75}, (_, i) => i + 1).sort(() => Math.random() - 0.5);
        cardNumbers = pool.slice(0, 25);
        cardNumbers[12] = "FREE";

        cardNumbers.forEach((num, idx) => {
            let cell = document.createElement('div');
            cell.className = 'cell' + (idx === 12 ? ' marked' : '');
            cell.id = 'cell-' + idx;
            cell.innerText = num === "FREE" ? "FR" : num;
            grid.appendChild(cell);
        });
        sync();
    }

    function setupAutoMark() {
        database.ref('drawnNumbers').on('value', (snap) => {
            const drawn = snap.val() || [];
            cardNumbers.forEach((num, idx) => {
                if (drawn.includes(num) || idx === 12) {
                    const el = document.getElementById('cell-' + idx);
                    if(el) {
                        el.classList.add('marked');
                        if (!markedIndices.includes(idx)) {
                            markedIndices.push(idx);
                            sync();
                        }
                    }
                }
            });
        });
    }

    function sync() {
        if(!uid) return;
        database.ref('players/' + uid).set({ name: myName, cardNumbers, markedIndices });
    }

    function claimBingo() {
        database.ref('winners/').push({ name: myName, time: Date.now() });
        alert("BINGO SHOUTED! ðŸ“¢");
    }

    function setupChat() {
        database.ref('chat').limitToLast(15).on('child_added', (snap) => {
            const c = snap.val();
            const div = document.createElement('div');
            div.style.padding = "2px 0";
            div.innerHTML = `<small style="color:var(--primary)">${c.name}:</small> <span style="color:#ddd">${c.msg}</span>`;
            const chatBox = document.getElementById('chatMsgs');
            chatBox.appendChild(div);
            chatBox.scrollTop = chatBox.scrollHeight;
        });
    }

    function sendChat() {
        const inp = document.getElementById('chatInp');
        if(!inp.value.trim()) return;
        database.ref('chat').push({ name: myName, msg: inp.value });
        inp.value = "";
    }

    // FIXED RESET: Listen but don't loop
    database.ref('gameStatus/reset').on('value', (snap) => {
        if(snap.val() === true) {
            // Re-sync logic: refresh only once
            window.location.replace(window.location.href);
        }
    });
</script>
</body>
</html>
