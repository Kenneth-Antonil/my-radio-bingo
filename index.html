<!DOCTYPE html>
<html lang="tl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#0f172a">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Radio Bingo Live | Social Ecosystem</title>
    
    <script>
        if (window.location.pathname.endsWith("index.html")) {
            var newPath = window.location.pathname.replace(/index\.html$/, "");
            window.history.replaceState({}, document.title, newPath);
        }
    </script>

    <link rel="icon" type="image/png" href="https://i.imgur.com/7D8u8h6.png">
    <link rel="apple-touch-icon" href="https://i.imgur.com/7D8u8h6.png">
    <link rel="manifest" href="manifest.json">
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;900&family=Comic+Neue:wght@700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-messaging.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

    <script src="https://pl28660488.effectivegatecpm.com/9b/f5/85/9bf585b6ee39cb9b515e2fae1fa958c2.js"></script>
    <script src="https://pl28660496.effectivegatecpm.com/a6/64/bf/a664bf7e7084386b4f4b428590030df3.js"></script>

    <style>
        /* === CORE VARIABLES === */
        :root { 
    
    <!-- 
    ╔══════════════════════════════════════════════════════════════════╗
    ║  DATABASE NORMALIZATION - PROPER 3NF STRUCTURE                   ║
    ╠══════════════════════════════════════════════════════════════════╣
    ║                                                                   ║
    ║  ALL DATA IS PROPERLY NORMALIZED - NO REDUNDANCY!                ║
    ║                                                                   ║
    ║  ✓ socialPosts: Only stores UID (no name, photo, etc)           ║
    ║  ✓ postComments: Only stores UID (no name, photo, etc)          ║
    ║  ✓ supportTicketReplies: Only stores UID                        ║
    ║  ✓ User data fetched from users/{uid} when displaying           ║
    ║                                                                   ║
    ║  BENEFITS:                                                       ║
    ║  • No data duplication                                           ║
    ║  • Profile updates automatically reflect everywhere              ║
    ║  • Smaller database size                                         ║
    ║  • Easier maintenance                                            ║
    ║  • Single source of truth for user data                          ║
    ║                                                                   ║
    ║  DATABASE STRUCTURE:                                             ║
    ║                                                                   ║
    ║  socialPosts/{postKey}                                           ║
    ║    ├─ uid (REFERENCE to users/{uid})                             ║
    ║    ├─ content                                                    ║
    ║    ├─ mood                                                       ║
    ║    ├─ image                                                      ║
    ║    ├─ video                                                      ║
    ║    ├─ timestamp                                                  ║
    ║    ├─ likes                                                      ║
    ║    ├─ visibility                                                 ║
    ║    ├─ isShared (if shared)                                      ║
    ║    ├─ sharedFrom (UID REFERENCE, if shared)                      ║
    ║    └─ sharedPostKey (if shared)                                  ║
    ║                                                                   ║
    ║  postComments/{postKey}/{commentKey}                             ║
    ║    ├─ uid (REFERENCE to users/{uid})                             ║
    ║    ├─ text                                                       ║
    ║    └─ time                                                       ║
    ║                                                                   ║
    ║  supportTicketReplies/{ticketKey}/{replyKey}                     ║
    ║    ├─ uid (REFERENCE to users/{uid})                             ║
    ║    ├─ message                                                    ║
    ║    ├─ timestamp                                                  ║
    ║    └─ isAdmin                                                    ║
    ║                                                                   ║
    ║  users/{uid}                                                     ║
    ║    ├─ name                                                       ║
    ║    ├─ photo                                                      ║
    ║    ├─ bio                                                        ║
    ║    ├─ verified                                                   ║
    ║    ├─ points                                                     ║
    ║    ├─ bingoWins                                                  ║
    ║    └─ ... (all user data)                                        ║
    ║                                                                   ║
    ╚══════════════════════════════════════════════════════════════════╝
    -->

            --bg-overlay: rgba(15, 23, 42, 0.95); 
            --glass-surface: rgba(30, 41, 59, 0.75);
            --glass-border: rgba(255, 255, 255, 0.1);
            
            --accent: #0ea5e9; /* Ocean Blue */
            --accent-glow: #38bdf8;
            --text: #ffffff; 
            --gold: #fbbf24; 
            --gold-shine: #fcd34d;
            --success: #10b981; 
            --danger: #ef4444; 
            --minigame: #f472b6;
            
            /* Messenger Colors */
            --messenger-blue: #3b82f6;
            --messenger-grey: #334155;
            --messenger-bg: #020617;
            
            /* Spacing System */
            --spacing-xs: 8px;
            --spacing-sm: 12px;
            --spacing-md: 16px;
            --spacing-lg: 20px;
            --spacing-xl: 24px;
            
            /* Border Radius */
            --radius-sm: 8px;
            --radius-md: 12px;
            --radius-lg: 16px;
            --radius-xl: 20px;
            --radius-full: 50px;
        }
        
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; user-select: none; }
        
        body { 
            font-family: 'Inter', sans-serif; 
            background: #0f172a;
            color: var(--text); 
            margin: 0; 
            padding-bottom: calc(65px + env(safe-area-inset-bottom)); 
            overflow-x: hidden; 
            min-height: 100vh;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.5);
        }

        /* === FULLSCREEN PHOTO VIEWER === */
        .fullscreen-photo-viewer {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.98);
            z-index: 99999;
            flex-direction: column;
        }
        .fullscreen-photo-viewer.active { display: flex; }
        
        .fullscreen-header {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            padding: var(--spacing-md);
            padding-top: max(var(--spacing-md), env(safe-area-inset-top));
            background: linear-gradient(180deg, rgba(0,0,0,0.8) 0%, transparent 100%);
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 10;
        }
        
        .fullscreen-close-btn {
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.2);
            color: white;
            font-size: 24px;
            cursor: pointer;
            padding: 8px;
            border-radius: var(--radius-sm);
            display: flex;
            align-items: center;
            justify-content: center;
            width: 40px;
            height: 40px;
            backdrop-filter: blur(10px);
        }
        
        .fullscreen-menu-btn {
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.2);
            color: white;
            cursor: pointer;
            padding: 8px;
            border-radius: var(--radius-sm);
            display: flex;
            align-items: center;
            justify-content: center;
            width: 40px;
            height: 40px;
            position: relative;
            backdrop-filter: blur(10px);
        }
        
        .photo-menu-dropdown {
            display: none;
            position: absolute;
            top: 100%;
            right: 0;
            margin-top: 8px;
            background: rgba(30, 41, 59, 0.98);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: var(--radius-md);
            min-width: 200px;
            overflow: hidden;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(20px);
            z-index: 100;
        }
        .photo-menu-dropdown.show { display: block; }
        
        .photo-menu-item {
            padding: var(--spacing-md);
            color: white;
            display: flex;
            align-items: center;
            gap: 12px;
            cursor: pointer;
            transition: background 0.2s;
            font-size: 14px;
            font-weight: 500;
        }
        .photo-menu-item:hover { background: rgba(255, 255, 255, 0.1); }
        .photo-menu-item i { width: 20px; height: 20px; }
        
        .fullscreen-photo-container {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 80px var(--spacing-xl) 120px;
            overflow: hidden;
        }
        
        .fullscreen-photo-container img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
            user-select: none;
            border-radius: var(--radius-md);
        }
        
        .fullscreen-photo-container video {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
            border-radius: var(--radius-md);
        }
        
        .fullscreen-footer {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            padding: var(--spacing-lg);
            padding-bottom: max(var(--spacing-lg), env(safe-area-inset-bottom));
            background: linear-gradient(0deg, rgba(0,0,0,0.8) 0%, transparent 100%);
            display: flex;
            justify-content: center;
            gap: 40px;
            z-index: 10;
        }
        
        .fullscreen-action-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 6px;
            background: none;
            border: none;
            color: white;
            cursor: pointer;
            padding: 8px;
            transition: all 0.2s;
        }
        .fullscreen-action-btn:hover { transform: scale(1.1); }
        .fullscreen-action-btn i { width: 32px; height: 32px; }
        .fullscreen-action-btn.liked i { color: #ef4444; fill: #ef4444; }
        .fullscreen-action-btn span {
            font-size: 13px;
            font-weight: 600;
            text-shadow: 0 2px 4px rgba(0,0,0,0.8);
        }

        /* === BADGE & ONLINE SYSTEM === */
        .avatar-frame {
            position: relative;
            display: inline-block;
            flex-shrink: 0;
            cursor: pointer;
        }
        .avatar-frame img {
            display: block;
            border-radius: 50%;
            border: 2px solid rgba(255,255,255,0.1);
            object-fit: cover;
        }
        
        /* UPDATED: Green Online Dot */
        .online-indicator {
            position: absolute;
            bottom: 2px;
            right: 2px;
            width: 14px;
            height: 14px;
            background-color: #22c55e;
            border: 2px solid #0f172a;
            border-radius: 50%;
            z-index: 20;
            display: none; /* Hidden by default */
            box-shadow: 0 0 5px rgba(34, 197, 94, 0.5);
        }
        .online-indicator.is-online { display: block; }

        /* Inline Follow Button - for Beats tab */
        .inline-follow-btn {
            padding: 4px 12px;
            background: var(--accent);
            color: white;
            border: none;
            border-radius: var(--radius-full);
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            margin-left: 8px;
            transition: all 0.2s;
        }
        .inline-follow-btn:hover {
            background: var(--accent-glow);
            transform: scale(1.05);
        }
        .inline-follow-btn.following {
            background: var(--glass-surface);
            border: 1px solid var(--glass-border);
        }
        .inline-follow-btn.following:hover {
            background: var(--danger);
            border-color: var(--danger);
        }

        /* Inline Verification Badge */
        .inline-badge {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            margin-left: 4px;
            vertical-align: middle;
        }

        .avatar-badge-icon {
            position: absolute;
            bottom: -2px;
            left: -2px; /* Changed from right to left to avoid overlap with online indicator */
            width: 40%; /* Scales relative to image */
            height: 40%;
            border-radius: 50%;
            background: #0f172a; /* Background to make it pop */
            border: 2px solid #0f172a;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            z-index: 10;
            box-shadow: 0 2px 5px rgba(0,0,0,0.5);
            font-size: 10px;
        }
        .tier-bronze-bg { background: linear-gradient(135deg, #cd7f32, #a0522d); }
        .tier-silver-bg { background: linear-gradient(135deg, #e0e0e0, #9ca3af); }
        .tier-gold-bg { background: linear-gradient(135deg, #fcd34d, #b45309); border: 1px solid #fcd34d; }
        .tier-platinum-bg { background: linear-gradient(135deg, #e5e4e2, #64748b); border: 1px solid white; }
        .tier-diamond-bg { background: linear-gradient(135deg, #b9f2ff, #06b6d4); box-shadow: 0 0 5px #06b6d4; border: 1px solid #06b6d4; }

        /* === MODERN POST CREATOR (Premium Social Media Style) === */
        .post-creator-modern {
            background: linear-gradient(145deg, rgba(30, 41, 59, 0.95), rgba(22, 27, 34, 0.95));
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            padding: 0;
            border-radius: 20px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            margin-bottom: 20px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.4), 
                        0 0 0 1px rgba(59, 130, 246, 0.05);
            overflow: hidden;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .post-creator-modern:hover {
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.5),
                        0 0 0 1px rgba(59, 130, 246, 0.2);
            transform: translateY(-2px);
        }

        /* Post Creator Header with Avatar */
        .post-creator-header {
            display: flex;
            align-items: flex-start;
            gap: 14px;
            padding: 20px 20px 0 20px;
        }

        .post-creator-avatar {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            object-fit: cover;
            border: 2.5px solid rgba(59, 130, 246, 0.3);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4),
                        0 0 0 3px rgba(59, 130, 246, 0.1);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            cursor: pointer;
            flex-shrink: 0;
        }
        .post-creator-avatar:hover {
            transform: scale(1.08);
            border-color: rgba(59, 130, 246, 0.6);
            box-shadow: 0 6px 20px rgba(59, 130, 246, 0.3),
                        0 0 0 3px rgba(59, 130, 246, 0.2);
        }
        .post-creator-avatar:active {
            transform: scale(1.02);
        }

        .post-input-wrapper {
            flex: 1;
            position: relative;
        }

        .post-input-modern {
            background: transparent;
            border: none;
            border-radius: 0;
            padding: 0;
            color: rgba(255, 255, 255, 0.95);
            font-family: 'Inter', sans-serif;
            font-size: 16px;
            line-height: 1.6;
            width: 100%;
            resize: none;
            min-height: 70px;
            max-height: 350px;
            outline: none;
            font-weight: 400;
            transition: all 0.2s ease;
        }
        .post-input-modern::placeholder {
            color: rgba(255, 255, 255, 0.4);
            font-weight: 400;
        }
        .post-input-modern:focus {
            color: rgba(255, 255, 255, 1);
        }
        .post-input-modern:focus::placeholder {
            color: rgba(255, 255, 255, 0.25);
        }

        /* Always visible action bar - no dropdown */
        .post-creator-body {
            display: block !important;
            padding: 0;
        }

        /* Image Preview */
        .image-preview-container {
            position: relative;
            margin: 16px 20px;
            border-radius: 16px;
            overflow: hidden;
            background: rgba(0, 0, 0, 0.4);
            border: 1.5px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            display: none;
        }
        .image-preview-container.show {
            display: block;
        }
        .image-preview-img {
            width: 100%;
            max-height: 450px;
            object-fit: cover;
            display: block;
        }
        .btn-remove-img {
            position: absolute;
            top: 12px;
            right: 12px;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: rgba(15, 23, 42, 0.95);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1.5px solid rgba(255, 255, 255, 0.15);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
            color: white;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5);
        }
        .btn-remove-img:hover {
            background: linear-gradient(135deg, #ef4444, #dc2626);
            transform: scale(1.1) rotate(90deg);
            border-color: rgba(239, 68, 68, 0.5);
            box-shadow: 0 6px 16px rgba(239, 68, 68, 0.4);
        }
        .btn-remove-img:active {
            transform: scale(1.0) rotate(90deg);
        }
        .btn-remove-img i {
            width: 18px;
            height: 18px;
        }
        
        /* Hide mood selector - keep it simple */
        .mood-selector {
            display: none;
        }
        .mood-selector::-webkit-scrollbar {
            height: 4px;
        }
        .mood-selector::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 2px;
        }
        .mood-selector::-webkit-scrollbar-thumb {
            background: rgba(59, 130, 246, 0.3);
            border-radius: 2px;
        }
        .mood-selector::-webkit-scrollbar-thumb:hover {
            background: rgba(59, 130, 246, 0.5);
        }
        
        .mood-chip {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.1), rgba(59, 130, 246, 0.05));
            border: 1.5px solid rgba(59, 130, 246, 0.2);
            padding: 10px 18px;
            border-radius: 24px;
            font-size: 13px;
            font-weight: 600;
            color: rgba(255, 255, 255, 0.7);
            white-space: nowrap;
            cursor: pointer;
            transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            flex-shrink: 0;
            position: relative;
            overflow: hidden;
        }
        .mood-chip::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.1), transparent);
            transition: left 0.5s;
        }
        .mood-chip:hover::before {
            left: 100%;
        }
        .mood-chip:hover {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.25), rgba(59, 130, 246, 0.15));
            border-color: rgba(59, 130, 246, 0.4);
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
        }
        .mood-chip:active {
            transform: translateY(0) scale(0.98);
        }
        .mood-chip.selected {
            background: linear-gradient(135deg, #3b82f6, #2563eb);
            border-color: #3b82f6;
            color: white;
            box-shadow: 0 4px 16px rgba(59, 130, 246, 0.5), 0 0 20px rgba(59, 130, 246, 0.3);
            animation: pulseGlow 2s infinite;
        }
        @keyframes pulseGlow {
            0%, 100% { box-shadow: 0 4px 16px rgba(59, 130, 246, 0.5), 0 0 20px rgba(59, 130, 246, 0.3); }
            50% { box-shadow: 0 4px 20px rgba(59, 130, 246, 0.6), 0 0 24px rgba(59, 130, 246, 0.4); }
        }

        /* Modern Action Bar */
        .post-tools {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 8px;
            padding: 16px 20px 18px 20px;
            background: rgba(15, 23, 42, 0.3);
            border-top: 1px solid rgba(255, 255, 255, 0.06);
        }
        
        .post-actions-left {
            display: flex;
            gap: 4px;
            align-items: center;
        }

        .tool-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            background: transparent;
            border: none;
            border-radius: 50%;
            padding: 8px;
            width: 40px;
            height: 40px;
            color: #60a5fa;
            cursor: pointer;
            transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
        }
        .tool-btn:hover {
            background: rgba(59, 130, 246, 0.12);
            color: #3b82f6;
            transform: scale(1.1);
        }
        .tool-btn:active {
            transform: scale(0.95);
        }
        .tool-btn svg {
            width: 22px;
            height: 22px;
        }
        .tool-btn i {
            width: 22px;
            height: 22px;
        }
        .tool-btn span {
            display: none; /* Hide text labels, show only icons */
        }


        .btn-post-modern {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            color: white;
            border: none;
            border-radius: 24px;
            padding: 10px 28px;
            font-weight: 600;
            font-size: 15px;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 4px 14px rgba(59, 130, 246, 0.4),
                        inset 0 1px 0 rgba(255, 255, 255, 0.2);
            letter-spacing: 0.3px;
            position: relative;
            overflow: hidden;
            min-width: 90px;
        }
        .btn-post-modern::before {
            content: '';
            position: absolute;
            inset: 0;
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.2), transparent);
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        .btn-post-modern:hover:not(:disabled)::before {
            opacity: 1;
        }
        .btn-post-modern:hover:not(:disabled) { 
            background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%);
            box-shadow: 0 6px 20px rgba(59, 130, 246, 0.5),
                        inset 0 1px 0 rgba(255, 255, 255, 0.2);
            transform: translateY(-2px);
        }
        .btn-post-modern:active:not(:disabled) {
            transform: translateY(0) scale(0.98);
        }
        .btn-post-modern:disabled {
            background: linear-gradient(135deg, rgba(71, 85, 105, 0.5), rgba(51, 65, 85, 0.5));
            color: rgba(255, 255, 255, 0.3);
            cursor: not-allowed;
            box-shadow: none;
            transform: none;
        }

        /* === MESSENGER MODERN === */
        .msg-image-preview {
            max-width: 200px;
            border-radius: var(--radius-md);
            border: 1px solid rgba(255,255,255,0.1);
            margin-top: 5px;
        }
        .msg-heart-reaction {
            position: absolute;
            bottom: -8px;
            right: -5px;
            background: #1e293b;
            border: 1px solid #334155;
            border-radius: var(--radius-sm);
            padding: 2px 4px;
            font-size: 10px;
            display: flex;
            align-items: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
            animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        @keyframes popIn { 0% { transform: scale(0); } 100% { transform: scale(1); } }
        
        .pm-footer-modern {
            padding: var(--spacing-sm);
            background: #0f172a;
            display: flex;
            gap: var(--spacing-sm);
            align-items: center;
            border-top: 1px solid #1e293b;
            padding-bottom: calc(15px + env(safe-area-inset-bottom));
        }
        .pm-attach-btn {
            background: none;
            border: none;
            color: #64748b;
            cursor: pointer;
            padding: 5px;
        }
        
        /* === NOTIFICATION UPDATES === */
        .notif-card-grouped {
            background: rgba(30, 41, 59, 0.4);
            border-left: 3px solid var(--accent);
            margin-bottom: var(--spacing-xs);
            padding: var(--spacing-sm);
            border-radius: 0 12px 12px 0;
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
            cursor: pointer;
            transition: 0.2s;
            position: relative;
        }
        .notif-card-grouped:active { background: rgba(30, 41, 59, 0.8); transform: scale(0.98); }
        .notif-img { width: 36px; height: 36px; border-radius: 50%; object-fit: cover; border: 1px solid rgba(255,255,255,0.1); }
        .notif-content-wrap { flex: 1; padding-right: 25px; } /* padding for delete btn */
        .btn-delete-notif {
            position: absolute; right: 10px; top: 50%; transform: translateY(-50%);
            background: rgba(239, 68, 68, 0.1); color: #ef4444; border: none;
            width: 24px; height: 24px; border-radius: 50%; display: flex; align-items: center; justify-content: center;
            cursor: pointer;
        }

        /* Modern Unfriend Button */
        .btn-unfriend-modern {
            background: rgba(239, 68, 68, 0.12);
            color: #f87171;
            border: 1px solid rgba(239, 68, 68, 0.25);
            padding: 14px 32px;
            border-radius: 50px;
            font-weight: 700;
            font-size: 14px;
            cursor: pointer;
            margin-bottom: var(--spacing-sm);
            width: 100%;
            max-width: 280px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: var(--spacing-xs);
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        .btn-unfriend-modern:hover {
            background: rgba(239, 68, 68, 0.18);
            border-color: rgba(239, 68, 68, 0.4);
            box-shadow: 0 4px 15px rgba(239, 68, 68, 0.15);
        }
        .btn-unfriend-modern:active {
            transform: scale(0.97);
        }

        /* Group Chat UI */
        .group-create-btn {
            padding: 8px 15px;
            background: var(--accent);
            color: white;
            border-radius: var(--radius-xl);
            font-size: 11px;
            font-weight: 800;
            border: none;
            cursor: pointer;
            box-shadow: 0 4px 10px rgba(14, 165, 233, 0.3);
        }
        
        .friend-select-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: var(--spacing-sm);
            border-bottom: 1px solid rgba(255,255,255,0.05);
            cursor: pointer;
        }
        .friend-select-item.selected { background: rgba(14, 165, 233, 0.1); }
        .checkbox-circle {
            width: 20px; height: 20px;
            border: 2px solid #475569;
            border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
        }
        .friend-select-item.selected .checkbox-circle {
            background: var(--accent); border-color: var(--accent);
        }

        #customPopupBanner { display: none; position: fixed; inset: 0; z-index: 9999999; background: rgba(0,0,0,0.85); align-items: center; justify-content: center; flex-direction: column; padding: var(--spacing-lg); backdrop-filter: blur(5px); }
        
        /* === CARD SKINS === */
        .card-skin-neon { border: 2px solid #06b6d4 !important; box-shadow: 0 0 20px #06b6d4, inset 0 0 20px rgba(6, 182, 212, 0.2) !important; background: rgba(8, 51, 68, 0.9) !important; }
        .card-skin-neon .cell { border-color: #06b6d4 !important; color: #67e8f9 !important; text-shadow: 0 0 5px #06b6d4 !important; }
        
        .card-skin-gold { border: 2px solid #f59e0b !important; box-shadow: 0 0 25px #f59e0b, inset 0 0 10px #f59e0b !important; background: linear-gradient(135deg, #451a03, #000) !important; }
        .card-skin-gold .cell { border-color: #fbbf24 !important; color: #fcd34d !important; font-family: 'Times New Roman', serif; }
        
        .card-skin-pink { border: 2px solid #ec4899 !important; box-shadow: 0 0 20px #ec4899 !important; background: rgba(80, 7, 36, 0.9) !important; }
        .card-skin-pink .cell { border-color: #f472b6 !important; color: #fbcfe8 !important; border-radius: 50% !important; }
        
        .card-skin-matrix { border: 2px solid #22c55e !important; box-shadow: 0 0 15px #22c55e !important; background: black !important; font-family: 'Courier New', monospace; }
        .card-skin-matrix .cell { border-color: #22c55e !important; color: #4ade80 !important; border-radius: 0 !important; }

        /* CHARACTER THEMES */
        .card-skin-kitty { border: 4px solid #ffc0cb !important; background: radial-gradient(circle, #fff0f5, #ff69b4) !important; box-shadow: 0 0 20px #ff69b4 !important; font-family: 'Comic Neue', cursive; }
        .card-skin-kitty .cell { background: white !important; color: #ff1493 !important; border: 2px solid #ffc0cb !important; border-radius: 15px !important; }
        .card-skin-kitty .bingo-header .letter { color: #ff1493 !important; text-shadow: 2px 2px 0px white !important; }

        .card-skin-doraemon { border: 4px solid #0096df !important; background: linear-gradient(180deg, #0096df 0%, #ffffff 100%) !important; box-shadow: 0 0 20px #dd1616 !important; }
        .card-skin-doraemon .cell { background: rgba(255,255,255,0.9) !important; color: #0096df !important; border: 2px solid #dd1616 !important; border-radius: 50% !important; }
        .card-skin-doraemon .bingo-header .letter { color: #dd1616 !important; text-shadow: 2px 2px 0px white !important; }

        .card-skin-spongebob { border: 4px solid #f7f44d !important; background: url('https://upload.wikimedia.org/wikipedia/commons/thumb/e/e6/SpongeBob_SquarePants_logo.svg/1200px-SpongeBob_SquarePants_logo.svg.png'), #f7f44d !important; background-size: cover !important; box-shadow: 0 0 20px #f7f44d !important; }
        .card-skin-spongebob .cell { background: rgba(255,255,255,0.8) !important; color: #7d5837 !important; border: 2px dashed #7d5837 !important; }
        
        .card-skin-kuromi { border: 4px solid #000000 !important; background: linear-gradient(135deg, #000000, #4b0082) !important; box-shadow: 0 0 20px #ea65a2 !important; }
        .card-skin-kuromi .cell { background: rgba(234, 101, 162, 0.2) !important; color: #ea65a2 !important; border: 1px solid #ea65a2 !important; border-radius: var(--radius-sm) 0 8px 0 !important; }

        /* CUSTOM BACKGROUND SKIN */
        .card-skin-custom { background-size: cover !important; background-position: center !important; border: 2px solid rgba(255,255,255,0.5) !important; box-shadow: 0 0 30px rgba(0,0,0,0.8) !important; }
        .card-skin-custom .cell { background: rgba(0,0,0,0.6) !important; backdrop-filter: blur(4px); color: white !important; border: 1px solid rgba(255,255,255,0.3) !important; }

        .store-nav { 
            display: flex; 
            gap: 8px; 
            margin-bottom: 20px; 
            background: rgba(0, 0, 0, 0.3); 
            padding: 6px; 
            border-radius: 14px;
            border: 1px solid rgba(255, 255, 255, 0.05);
        }
        .store-tab-btn { 
            flex: 1; 
            padding: 12px; 
            border: none; 
            background: transparent; 
            color: rgba(255, 255, 255, 0.5); 
            font-weight: 800; 
            border-radius: 10px; 
            cursor: pointer; 
            font-size: 12px; 
            text-transform: uppercase; 
            transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
            letter-spacing: 0.5px;
        }
        .store-tab-btn:hover {
            background: rgba(59, 130, 246, 0.1);
            color: rgba(255, 255, 255, 0.8);
        }
        .store-tab-btn.active { 
            background: linear-gradient(135deg, #3b82f6, #2563eb); 
            color: white; 
            box-shadow: 0 4px 14px rgba(59, 130, 246, 0.4),
                        inset 0 1px 0 rgba(255, 255, 255, 0.2);
            transform: translateY(-1px);
        }
        .skins-grid { display: grid; grid-template-columns: 1fr 1fr; gap: var(--spacing-sm); }
        .skin-item { background: rgba(255,255,255,0.05); padding: var(--spacing-sm); border-radius: var(--radius-lg); border: 1px solid rgba(255,255,255,0.1); text-align: center; position: relative; overflow: hidden; }
        .skin-preview { height: 60px; border-radius: var(--radius-sm); margin-bottom: var(--spacing-xs); display: flex; align-items: center; justify-content: center; font-size: 20px; font-weight: 900; background-size: cover; background-position: center; }
        .skin-name { font-size: 12px; font-weight: 800; color: white; margin-bottom: 4px; }
        .skin-cost { font-size: 10px; color: var(--gold); margin-bottom: var(--spacing-xs); font-weight: 700; }
        .btn-buy-skin { width: 100%; padding: 8px; border: none; border-radius: var(--radius-sm); font-weight: 800; font-size: 10px; cursor: pointer; }
        .btn-buy-skin.owned { background: rgba(255,255,255,0.1); color: #cbd5e1; cursor: default; }
        .btn-buy-skin.buy { background: var(--gold); color: black; }
        .btn-buy-skin.equip { background: var(--success); color: white; }
        .task-list { display: flex; flex-direction: column; gap: var(--spacing-sm); }
        .task-item { background: linear-gradient(135deg, rgba(30,41,59,0.9), rgba(15,23,42,0.95)); padding: var(--spacing-md); border-radius: var(--radius-lg); border: 1px solid rgba(255,255,255,0.1); display: flex; justify-content: space-between; align-items: center; position: relative; overflow: hidden; }
        .task-info h4 { margin: 0; font-size: 13px; font-weight: 900; color: white; letter-spacing: 0.5px; }
        .task-info p { margin: 3px 0 0; font-size: 10px; color: #94a3b8; }
        .task-reward { background: rgba(251, 191, 36, 0.15); color: var(--gold); padding: 4px 8px; border-radius: 6px; font-size: 10px; font-weight: 800; margin-top: 5px; display: inline-block; border: 1px solid rgba(251, 191, 36, 0.3); }
        .btn-do-task { background: var(--accent); color: white; border: none; padding: var(--spacing-sm) 18px; border-radius: var(--radius-sm); font-weight: 800; font-size: 11px; cursor: pointer; transition: 0.2s; box-shadow: 0 4px 10px rgba(14, 165, 233, 0.3); min-width: 80px; z-index: 2; }
        .btn-do-task:hover { transform: translateY(-2px); }
        .btn-do-task:disabled { background: #334155; color: #94a3b8; cursor: not-allowed; transform: none; box-shadow: none; }
        .flying-coin { position: fixed; width: 24px; height: 24px; background-image: url('https://cdn-icons-png.flaticon.com/512/217/217853.png'); background-size: contain; background-repeat: no-repeat; z-index: 99999; pointer-events: none; will-change: transform, opacity; }
        @keyframes shake-hard { 0% { transform: translate(0, 0); } 25% { transform: translate(-3px, 3px); } 50% { transform: translate(3px, -3px); } 75% { transform: translate(-3px, -3px); } 100% { transform: translate(0, 0); } }
        .shake-effect { animation: shake-hard 0.3s ease-in-out; will-change: transform; }
        .float-loss { position: fixed; color: #ef4444; font-weight: 900; font-size: 18px; z-index: 100000; pointer-events: none; animation: floatDownFade 1s ease-out forwards; text-shadow: 0 1px 2px black; }
        @keyframes floatDownFade { 0% { transform: translateY(0) scale(1); opacity: 1; } 100% { transform: translateY(40px) scale(0.8); opacity: 0; } }
        #installGate { position: fixed; inset: 0; z-index: 2147483647; background: #0f172a; background-image: radial-gradient(circle at top right, rgba(14, 165, 233, 0.2), transparent 40%), radial-gradient(circle at bottom left, rgba(251, 191, 36, 0.1), transparent 40%); display: none; flex-direction: column; align-items: center; justify-content: center; text-align: center; padding: 30px; }
        .gate-logo { font-size: 64px; font-weight: 900; letter-spacing: -3px; color: white; margin-bottom: var(--spacing-sm); text-shadow: 0 0 40px rgba(14, 165, 233, 0.6); animation: floatLogo 3s ease-in-out infinite; }
        .gate-logo span { color: var(--accent-glow); }
        @keyframes floatLogo { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }
        .gate-title { font-size: 24px; font-weight: 800; color: white; margin-bottom: var(--spacing-md); line-height: 1.3; }
        .gate-desc { font-size: 14px; color: #cbd5e1; max-width: 320px; margin-bottom: 40px; line-height: 1.6; opacity: 0.8; }
        .gate-btn-install { background: linear-gradient(135deg, var(--accent), #2563eb); color: white; border: none; padding: var(--spacing-lg) 40px; border-radius: 50px; font-weight: 900; font-size: 16px; cursor: pointer; box-shadow: 0 0 30px rgba(14, 165, 233, 0.5); transition: transform 0.2s; display: flex; align-items: center; gap: var(--spacing-sm); border: 2px solid rgba(255,255,255,0.2); animation: pulseBtn 2s infinite; }
        .gate-btn-install:active { transform: scale(0.95); }
        @keyframes pulseBtn { 0% { box-shadow: 0 0 0 0 rgba(14, 165, 233, 0.7); } 70% { box-shadow: 0 0 0 20px rgba(14, 165, 233, 0); } 100% { box-shadow: 0 0 0 0 rgba(14, 165, 233, 0); } }
        .gate-ios-note { margin-top: var(--spacing-xl); background: rgba(255,255,255,0.05); padding: var(--spacing-lg); border-radius: var(--radius-lg); border: 1px solid rgba(255,255,255,0.1); max-width: 320px; text-align: left; display: none; }
        .ios-step { display: flex; gap: var(--spacing-sm); margin-bottom: var(--spacing-sm); align-items: center; font-size: 13px; color: #e2e8f0; }
        .ios-icon { color: var(--accent-glow); }
        #notifBlocker { position: fixed; inset: 0; z-index: 9999999; background: rgba(15, 23, 42, 0.98); display: none; flex-direction: column; align-items: center; justify-content: center; text-align: center; padding: 30px; backdrop-filter: blur(10px); }
        .notif-gate-icon { width: 80px; height: 80px; background: rgba(59, 130, 246, 0.2); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-bottom: var(--spacing-lg); box-shadow: 0 0 30px rgba(59, 130, 246, 0.4); animation: pulseGate 2s infinite; }
        @keyframes pulseGate { 0% { transform: scale(1); } 50% { transform: scale(1.1); } 100% { transform: scale(1); } }
        .notif-gate-title { font-size: 24px; font-weight: 900; margin-bottom: var(--spacing-sm); color: white; }
        .notif-gate-desc { font-size: 14px; color: #cbd5e1; margin-bottom: 30px; line-height: 1.6; max-width: 300px; }
        .btn-allow-notif { background: linear-gradient(135deg, var(--accent), #2563eb); color: white; border: none; padding: var(--spacing-md) 30px; border-radius: var(--radius-lg); font-weight: 800; font-size: 16px; cursor: pointer; box-shadow: 0 10px 30px rgba(59, 130, 246, 0.4); transition: 0.3s; width: 100%; max-width: 250px; display: flex; align-items: center; justify-content: center; gap: var(--spacing-sm); }
        .btn-allow-notif:hover { transform: translateY(-3px); }
        .blocked-help { display: none; background: rgba(239, 68, 68, 0.1); border: 1px solid rgba(239, 68, 68, 0.3); padding: var(--spacing-md); border-radius: var(--radius-md); margin-top: var(--spacing-lg); font-size: 12px; text-align: left; }
        /* === SPLASH SCREEN - PROFESSIONAL & BONGGA === */
        #splash-screen { 
            position: fixed; 
            inset: 0; 
            background: linear-gradient(135deg, #020617 0%, #0f172a 50%, #1e293b 100%);
            z-index: 99999; 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            justify-content: center; 
            transition: opacity 0.8s ease, visibility 0.8s;
            overflow: hidden;
        }
        
        /* Animated gradient orbs */
        #splash-screen::before {
            content: '';
            position: absolute;
            width: 300px;
            height: 300px;
            background: radial-gradient(circle, #0ea5e9 0%, transparent 70%);
            border-radius: 50%;
            filter: blur(60px);
            opacity: 0.3;
            top: -150px;
            left: -150px;
            animation: float-orb 8s ease-in-out infinite;
        }
        #splash-screen::after {
            content: '';
            position: absolute;
            width: 400px;
            height: 400px;
            background: radial-gradient(circle, #8b5cf6 0%, transparent 70%);
            border-radius: 50%;
            filter: blur(60px);
            opacity: 0.3;
            bottom: -200px;
            right: -200px;
            animation: float-orb 8s ease-in-out infinite 2s;
        }
        
        .splash-logo { 
            position: relative;
            z-index: 2;
            font-size: clamp(52px, 15vw, 72px);
            font-weight: 900; 
            letter-spacing: -3px; 
            background: linear-gradient(135deg, #ffffff 0%, #38bdf8 50%, #0ea5e9 100%);
            background-size: 200% 200%;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            animation: gradient-shift 3s ease-in-out infinite, pulseLogo 2s infinite ease-in-out;
            text-shadow: 0 0 30px rgba(14, 165, 233, 0.5);
            margin-bottom: 8px;
        }
        .splash-logo span { 
            background: linear-gradient(135deg, var(--gold), var(--gold-shine));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .splash-tagline {
            position: relative;
            z-index: 2;
            font-size: 14px;
            color: rgba(255, 255, 255, 0.6);
            font-weight: 500;
            letter-spacing: 2px;
            text-transform: uppercase;
            margin-bottom: 32px;
            animation: fade-in-up 1s ease-out 0.3s both;
        }
        
        .splash-loader { 
            position: relative;
            z-index: 2;
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }
        
        .splash-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            animation: bounce-dot 1.4s ease-in-out infinite;
        }
        
        .splash-dot:nth-child(1) {
            background: linear-gradient(135deg, var(--accent), var(--accent-glow));
            box-shadow: 0 0 15px var(--accent);
            animation-delay: 0s;
        }
        .splash-dot:nth-child(2) {
            background: linear-gradient(135deg, var(--gold), var(--gold-shine));
            box-shadow: 0 0 15px var(--gold);
            animation-delay: 0.2s;
        }
        .splash-dot:nth-child(3) {
            background: linear-gradient(135deg, #8b5cf6, #a78bfa);
            box-shadow: 0 0 15px #8b5cf6;
            animation-delay: 0.4s;
        }
        
        /* Animations */
        @keyframes float-orb {
            0%, 100% { transform: translate(0, 0) scale(1); }
            33% { transform: translate(30px, -30px) scale(1.1); }
            66% { transform: translate(-30px, 30px) scale(0.9); }
        }
        
        @keyframes gradient-shift {
            0%, 100% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
        }
        
        @keyframes bounce-dot {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-20px); }
        }
        
        @keyframes fade-in-up {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* Mobile optimizations */
        @media (max-width: 480px) {
            #splash-screen::before { width: 200px; height: 200px; }
            #splash-screen::after { width: 300px; height: 300px; }
        }
        @keyframes pulseLogo { 0%, 100% { transform: scale(1); filter: drop-shadow(0 0 10px rgba(56,189,248,0.2)); } 50% { transform: scale(1.1); filter: drop-shadow(0 0 30px rgba(56,189,248,0.8)); } }
        @keyframes spin { 100% { transform: rotate(360deg); } }
        #customToast { position: fixed; top: 20px; left: 50%; transform: translateX(-50%) translateY(-150%); background: rgba(15, 23, 42, 0.95); border: 1px solid var(--accent); padding: 16px 24px; border-radius: var(--radius-lg); z-index: 100000; display: flex; align-items: center; justify-content: center; text-align: center; gap: var(--spacing-sm); box-shadow: 0 10px 40px rgba(0,0,0,0.8); backdrop-filter: blur(12px); transition: transform 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); min-width: 280px; max-width: 90%; }
        #customToast.show { transform: translateX(-50%) translateY(0); }
        .toast-icon { color: var(--gold); flex-shrink: 0; }
        .toast-msg { font-size: 14px; font-weight: 700; color: white; line-height: 1.4; }
        .glass-panel { background: var(--glass-surface); backdrop-filter: blur(16px); -webkit-backdrop-filter: blur(16px); border: 1px solid var(--glass-border); box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.5); }
        
        .ad-container-global { position: relative; z-index: 10 !important; width: 320px; height: 50px; display: flex; justify-content: center; align-items: center; margin: 10px auto; background: rgba(0,0,0,0.4); border-radius: 4px; border: 1px dashed rgba(255,255,255,0.3); text-align: center; overflow: hidden; clear: both; }

        #jackpotBanner { background: linear-gradient(135deg, #271a00 0%, #451a03 50%, #000000 100%); border: 2px solid #fbbf24; color: #fbbf24; padding: var(--spacing-md); text-align: center; border-radius: var(--radius-lg); box-shadow: 0 0 25px rgba(251, 191, 36, 0.3), inset 0 0 20px rgba(251, 191, 36, 0.1); display: none; margin-bottom: var(--spacing-md); position: relative; overflow: hidden; animation: pulse-border 2s infinite; }
        #jackpotBanner::before { content: ''; position: absolute; top: -50%; left: -50%; width: 200%; height: 200%; background: linear-gradient(45deg, transparent, rgba(251, 191, 36, 0.2), transparent); animation: shimmer 3s infinite linear; }
        @keyframes shimmer { 0% { transform: translateX(-100%); } 100% { transform: translateX(100%); } }
        @keyframes pulse-border { 0% { box-shadow: 0 0 15px rgba(251, 191, 36, 0.2); border-color: #b45309; } 50% { box-shadow: 0 0 35px rgba(251, 191, 36, 0.6); border-color: #fbbf24; } 100% { box-shadow: 0 0 15px rgba(251, 191, 36, 0.2); border-color: #b45309; } }
        .jp-label-new { font-size: 11px; font-weight: 900; letter-spacing: 3px; text-transform: uppercase; display: flex; align-items: center; justify-content: center; gap: var(--spacing-xs); margin-bottom: var(--spacing-xs); color: #fcd34d; text-shadow: 0 2px 4px rgba(0,0,0,0.8); }
        .jackpot-amount { font-size: 32px; color: #ffffff; display: block; font-weight: 900; text-shadow: 0 2px 15px rgba(251, 191, 36, 0.8); font-family: 'Inter', sans-serif; background: linear-gradient(to bottom, #ffffff, #fcd34d); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        #loginOverlay { position: fixed; inset: 0; background: radial-gradient(circle at top right, #1e293b, #0f172a 70%); z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: var(--spacing-lg); overflow: hidden; }
        .login-bg-blob { position: absolute; border-radius: 50%; filter: blur(80px); opacity: 0.4; z-index: -1; }
        .blob-1 { width: 300px; height: 300px; background: var(--accent); top: -100px; right: -50px; animation: floatBlob 10s infinite alternate; }
        .blob-2 { width: 250px; height: 250px; background: var(--minigame); bottom: -50px; left: -50px; animation: floatBlob 12s infinite alternate-reverse; }
        @keyframes floatBlob { from { transform: translate(0,0); } to { transform: translate(30px, 50px); } }
        .login-app-container { width: 100%; max-width: 400px; display: flex; flex-direction: column; align-items: center; text-align: center; animation: slideUpFade 0.8s cubic-bezier(0.16, 1, 0.3, 1); }
        @keyframes slideUpFade { from { transform: translateY(50px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .app-logo-lg { font-size: 56px; font-weight: 900; letter-spacing: -3px; color: white; margin-bottom: var(--spacing-sm); text-shadow: 0 10px 30px rgba(14, 165, 233, 0.3); }
        .app-logo-lg span { color: var(--accent-glow); }
        .app-tagline { font-size: 16px; color: #cbd5e1; font-weight: 500; margin-bottom: 40px; line-height: 1.5; opacity: 0.9; }
        .promo-badge { background: linear-gradient(90deg, rgba(251, 191, 36, 0.1), rgba(251, 191, 36, 0.2)); border: 1px solid rgba(251, 191, 36, 0.3); color: var(--gold); padding: 8px 16px; border-radius: var(--radius-xl); font-size: 12px; font-weight: 800; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 30px; display: flex; align-items: center; gap: var(--spacing-xs); box-shadow: 0 0 15px rgba(251, 191, 36, 0.1); }
        .auth-btn-group { width: 100%; display: flex; flex-direction: column; gap: var(--spacing-md); margin-bottom: 40px; }
        .btn-main-auth { background: white; color: black; border: none; width: 100%; padding: var(--spacing-lg); border-radius: var(--radius-lg); font-weight: 800; font-size: 16px; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: var(--spacing-sm); transition: 0.3s; box-shadow: 0 10px 25px rgba(0,0,0,0.3); }
        .btn-main-auth:hover { transform: translateY(-3px); box-shadow: 0 15px 35px rgba(0,0,0,0.4); }
        .btn-sec-auth { background: rgba(255,255,255,0.1); color: white; border: 1px solid rgba(255,255,255,0.2); width: 100%; padding: var(--spacing-lg); border-radius: var(--radius-lg); font-weight: 700; font-size: 16px; cursor: pointer; backdrop-filter: blur(10px); transition: 0.3s; }
        .btn-sec-auth:hover { background: rgba(255,255,255,0.15); border-color: white; }
        .login-footer-legal { position: absolute; bottom: 20px; left: 0; right: 0; text-align: center; padding: 0 20px; }
        .legal-text { font-size: 10px; color: #64748b; line-height: 1.4; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; display: flex; flex-direction: column; gap: 5px; align-items: center; }
        .nav { background: rgba(15, 23, 42, 0.95); backdrop-filter: blur(15px); padding: var(--spacing-sm) 15px; display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 100; border-bottom: 1px solid rgba(255,255,255,0.1); height: auto; min-height: 60px; }
        .user-stats { display: flex; align-items: center; gap: var(--spacing-xs); }
        .icon-btn { background: rgba(255,255,255,0.1); color: white; border: 1px solid rgba(255,255,255,0.15); width: 38px; height: 38px; border-radius: var(--radius-md); cursor: pointer; position: relative; display: flex; align-items: center; justify-content: center; transition: 0.2s; }
        .icon-btn:active { transform: scale(0.95); }
        .notif-badge { position: absolute; top: 8px; right: 8px; background: var(--danger); width: 8px; height: 8px; border-radius: 50%; border: 1px solid var(--surface); display: none; z-index: 10; box-shadow: 0 0 10px var(--danger); }
        .points-badge { background: linear-gradient(135deg, rgba(251, 191, 36, 0.2), rgba(245, 158, 11, 0.4)); color: #fff; padding: 0 12px; height: 38px; border-radius: var(--radius-md); font-weight: 800; border: 1px solid rgba(251, 191, 36, 0.6); font-size: 13px; cursor: pointer; display: flex; align-items: center; gap: 6px; text-shadow: 0 1px 2px rgba(0,0,0,0.8); box-shadow: 0 4px 15px rgba(245, 158, 11, 0.3); }
        #userImg { width: 45px; height: 45px; border-radius: 50%; cursor: pointer; border: 2px solid var(--accent); object-fit: cover; box-shadow: 0 4px 15px rgba(0,0,0,0.3); }
        
        /* BOTTOM NAVIGATION - OPTIMIZED FOR MOBILE */
        .bottom-nav { position: fixed; bottom: 0; left: 0; right: 0; background: rgba(15, 23, 42, 0.95); backdrop-filter: blur(15px); border-top: 1px solid rgba(255,255,255,0.1); height: calc(65px + env(safe-area-inset-bottom)); display: flex; justify-content: space-around; align-items: flex-start; z-index: 5000; padding-top: 10px; padding-bottom: env(safe-area-inset-bottom); }
        .nav-item { display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 4px; color: #94a3b8; width: 20%; height: 50px; border: none; background: none; cursor: pointer; transition: 0.2s; }
        .nav-item.active { color: var(--accent-glow); }
        .nav-item.active i { transform: translateY(-2px); }
        .nav-icon { width: 24px; height: 24px; transition: 0.2s; }
        .nav-label { font-size: 10px; font-weight: 700; }

        .next-draw-container { background: rgba(15, 23, 42, 0.8); border: 1px solid rgba(251, 191, 36, 0.4); padding: var(--spacing-md); border-radius: var(--radius-xl); margin-bottom: var(--spacing-md); display: flex; align-items: center; gap: var(--spacing-md); box-shadow: 0 10px 30px rgba(0,0,0,0.5); backdrop-filter: blur(10px); }

        /* === BEATS SECTION (Vertical Video Feed) === */
        #view-beats {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 65px;
            background: #000;
            overflow-y: scroll;
            scroll-snap-type: y mandatory;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: none;
        }
        #view-beats::-webkit-scrollbar { display: none; }

        .beats-video-container {
            position: relative;
            width: 100%;
            height: calc(100vh - 65px);
            scroll-snap-align: start;
            background: #000;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .beats-video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .beats-overlay {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            padding: 20px;
            background: linear-gradient(to top, rgba(0,0,0,0.9), transparent);
            z-index: 10;
        }

        .beats-user-info {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 12px;
        }

        .beats-avatar {
            width: 42px;
            height: 42px;
            border-radius: 50%;
            border: 2px solid rgba(255,255,255,0.3);
            cursor: pointer;
            flex-shrink: 0;
        }

        .beats-username {
            font-size: 15px;
            font-weight: 700;
            color: white;
            text-shadow: 0 2px 8px rgba(0,0,0,0.8);
            flex: 1;
        }

        .beats-follow-btn {
            background: linear-gradient(135deg, #ef4444, #dc2626);
            color: white;
            border: none;
            padding: 8px 20px;
            border-radius: 6px;
            font-weight: 700;
            font-size: 13px;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(239, 68, 68, 0.4);
            flex-shrink: 0;
            white-space: nowrap;
        }

        .beats-follow-btn.following {
            background: rgba(255,255,255,0.2);
            border: 1px solid rgba(255,255,255,0.3);
        }

        .beats-description {
            font-size: 14px;
            color: white;
            margin-bottom: 12px;
            text-shadow: 0 2px 6px rgba(0,0,0,0.8);
            line-height: 1.4;
        }

        .beats-music {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 12px;
            color: rgba(255,255,255,0.8);
        }

        .beats-comments-preview {
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid rgba(255,255,255,0.1);
        }

        .beats-view-comments {
            color: rgba(255,255,255,0.6);
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            margin-bottom: 8px;
            display: inline-block;
        }

        .beats-view-comments:active {
            color: rgba(255,255,255,0.8);
        }

        .beats-preview-comment {
            display: flex;
            gap: 8px;
            margin-bottom: 6px;
            font-size: 13px;
            line-height: 1.4;
        }

        .beats-preview-comment-author {
            color: white;
            font-weight: 700;
        }

        .beats-preview-comment-text {
            color: rgba(255,255,255,0.9);
            flex: 1;
        }

        .beats-actions {
            position: absolute;
            right: 15px;
            bottom: 100px;
            display: flex;
            flex-direction: column;
            gap: 20px;
            z-index: 10;
        }

        .beats-action-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            background: rgba(255,255,255,0.15);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 50%;
            width: 50px;
            height: 50px;
            cursor: pointer;
            color: white;
            justify-content: center;
            transition: 0.2s;
        }

        .beats-action-btn:active {
            transform: scale(0.9);
        }

        .beats-action-count {
            font-size: 11px;
            font-weight: 700;
            color: white;
            text-shadow: 0 2px 4px rgba(0,0,0,0.8);
        }

        .beats-header {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            padding: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 20;
            background: linear-gradient(to bottom, rgba(0,0,0,0.6), transparent);
        }

        .beats-logo {
            font-size: 18px;
            font-weight: 900;
            color: white;
            letter-spacing: 1px;
            text-shadow: 0 2px 8px rgba(0,0,0,0.8);
        }

        .beats-search-btn {
            background: rgba(255,255,255,0.15);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.2);
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            cursor: pointer;
        }

        .beats-placeholder {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            color: rgba(255,255,255,0.6);
            padding: 60px 20px;
            min-height: calc(100vh - 200px);
        }

        .beats-placeholder i {
            margin-bottom: 20px;
            opacity: 0.5;
        }

        .beats-placeholder h3 {
            margin: 10px 0;
            font-weight: 800;
        }

        .beats-placeholder p {
            margin: 5px 0;
            font-size: 13px;
            opacity: 0.6;
        }

        /* === BEATS COMMENT MODAL === */
        #beatsCommentModal {
            position: fixed;
            bottom: -100%;
            left: 0;
            right: 0;
            max-height: 70vh;
            background: linear-gradient(to bottom, rgba(15, 23, 42, 0.98), rgba(15, 23, 42, 1));
            backdrop-filter: blur(20px);
            border-top-left-radius: 24px;
            border-top-right-radius: 24px;
            z-index: 10000;
            transition: bottom 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            flex-direction: column;
            border-top: 1px solid rgba(255,255,255,0.1);
        }

        #beatsCommentModal.show {
            bottom: 0;
        }

        .beats-comment-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .beats-comment-header h3 {
            font-size: 16px;
            font-weight: 800;
            color: white;
            margin: 0;
        }

        .beats-comment-close {
            background: rgba(255,255,255,0.1);
            border: none;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
        }

        .beats-comment-list {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
            max-height: calc(70vh - 140px);
        }

        .beats-comment-item {
            display: flex;
            gap: 12px;
            margin-bottom: 15px;
            animation: slideInUp 0.3s ease;
        }

        @keyframes slideInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .beats-comment-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            object-fit: cover;
            flex-shrink: 0;
            cursor: pointer;
        }

        .beats-comment-content {
            flex: 1;
        }

        .beats-comment-author {
            font-size: 14px;
            font-weight: 700;
            color: white;
            margin-bottom: 4px;
        }

        .beats-comment-text {
            font-size: 13px;
            color: #cbd5e1;
            line-height: 1.4;
            word-wrap: break-word;
        }

        .beats-comment-time {
            font-size: 11px;
            color: #64748b;
            margin-top: 4px;
        }

        .beats-comment-input-area {
            padding: 15px;
            border-top: 1px solid rgba(255,255,255,0.1);
            background: rgba(15, 23, 42, 1);
        }

        .beats-comment-input-wrapper {
            display: flex;
            gap: 12px;
            align-items: center;
        }

        .beats-comment-input {
            flex: 1;
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.15);
            border-radius: 20px;
            padding: 10px 16px;
            color: white;
            font-size: 14px;
            outline: none;
        }

        .beats-comment-input::placeholder {
            color: #64748b;
        }

        .beats-comment-send {
            background: linear-gradient(135deg, var(--accent), #2563eb);
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            flex-shrink: 0;
        }

        .beats-comment-send:active {
            transform: scale(0.95);
        }

        .beats-comment-empty {
            text-align: center;
            padding: 40px 20px;
            color: #64748b;
        }

        .nd-icon { background: linear-gradient(135deg, rgba(251, 191, 36, 0.2), rgba(245, 158, 11, 0.2)); color: var(--gold); width: 45px; height: 45px; border-radius: var(--radius-md); display: flex; align-items: center; justify-content: center; flex-shrink: 0; border: 1px solid rgba(251, 191, 36, 0.4); }
        .nd-info { flex: 1; }
        .next-draw-label { font-size: 11px; font-weight: 800; color: var(--gold); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 2px; }
        .next-draw-time { font-size: 18px; font-weight: 900; color: white; text-shadow: 0 2px 5px rgba(0,0,0,0.8); }
        .container { width: 100%; max-width: 500px; margin: 0 auto; padding: var(--spacing-sm); padding-bottom: 80px; /* Space for Nav */ }
        .card { background: var(--glass-surface); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); border-radius: 24px; padding: var(--spacing-md); margin-bottom: var(--spacing-lg); border: 1px solid var(--glass-border); position: relative; transition: all 0.3s ease; box-shadow: 0 15px 35px rgba(0,0,0,0.4); }
        
        .video-feed-wrapper { margin-bottom: var(--spacing-md); border-radius: 24px; overflow: hidden; background: #000; border: 2px solid rgba(255,255,255,0.2); box-shadow: 0 10px 40px rgba(0,0,0,0.6); }
        .video-container { position: relative; width: 100%; aspect-ratio: 16 / 9; }
        .video-overlay-bl { position: absolute; bottom: 12px; left: 12px; z-index: 10; background: rgba(0,0,0,0.9); padding: 6px 12px; border-radius: var(--radius-sm); border: 1px solid var(--success); display: flex; align-items: center; gap: 5px; color: var(--success); font-size: 11px; font-weight: 800; }
        .draw-panel { display: grid; grid-template-columns: 1fr 90px; gap: var(--spacing-sm); margin-bottom: var(--spacing-lg); }
        .prev-balls { background: rgba(0,0,0,0.4); border-radius: var(--radius-lg); padding: var(--spacing-sm); display: flex; align-items: center; gap: var(--spacing-xs); overflow-x: auto; scrollbar-width: none; border: 1px solid rgba(255,255,255,0.1); }
        .ball-small { min-width: 40px; height: 40px; background: linear-gradient(135deg, #334155, #1e293b); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 14px; font-weight: 900; border: 1px solid rgba(255,255,255,0.3); color: white; box-shadow: 0 4px 10px rgba(0,0,0,0.3); text-shadow: 0 1px 2px black; }
        .current-ball-box { background: linear-gradient(135deg, var(--accent), #2563eb); border-radius: var(--radius-lg); height: 90px; display: flex; flex-direction: column; align-items: center; justify-content: center; box-shadow: 0 8px 25px rgba(59, 130, 246, 0.5); border: 2px solid rgba(255,255,255,0.4); position: relative; overflow: hidden; }
        .current-ball-box::before { content: ''; position: absolute; top: -50%; left: -50%; width: 200%; height: 200%; background: linear-gradient(45deg, transparent, rgba(255,255,255,0.3), transparent); animation: shine 3s infinite; }
        @keyframes shine { 0% { transform: translateX(-100%); } 100% { transform: translateX(100%); } }
        .bingo-header { display: grid; grid-template-columns: repeat(5, 1fr); gap: 4px; margin-bottom: var(--spacing-sm); }
        .letter { text-align: center; font-size: 24px; font-weight: 900; color: var(--gold); text-shadow: 0 2px 10px rgba(251, 191, 36, 0.8); -webkit-text-stroke: 1px rgba(0,0,0,0.5); }
        .grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 4px; position: relative; }
        .cell { aspect-ratio: 1; background: rgba(255,255,255,0.1); border-radius: var(--radius-md); display: flex; align-items: center; justify-content: center; font-weight: 800; font-size: 16px; border: 1px solid rgba(255,255,255,0.15); transition: all 0.3s; z-index: 2; position: relative; overflow: hidden; box-shadow: inset 0 2px 5px rgba(255,255,255,0.05); color: white; text-shadow: 0 2px 3px black; }
        /* HIT VISIBILITY FIX */
        .cell.hit { 
            background: linear-gradient(135deg, var(--accent), #2563eb) !important; 
            color: white !important; 
            transform: scale(1.05); 
            border-color: rgba(255,255,255,0.6) !important; 
            box-shadow: 0 5px 15px rgba(59, 130, 246, 0.6) !important; 
            text-shadow: 0 2px 2px rgba(0,0,0,0.5) !important;
            opacity: 1 !important;
        }
        .cell.hit::after {
            content: '';
            position: absolute; inset: 2px;
            border: 2px solid rgba(255,255,255,0.8);
            border-radius: var(--radius-sm);
            pointer-events: none;
        }
        
        .card.card-win { border: 3px solid var(--success) !important; box-shadow: 0 0 50px rgba(16, 185, 129, 0.5); animation: pulse-win 2s infinite; background: rgba(16, 185, 129, 0.2); }
        .card.card-lost { opacity: 0.6; filter: grayscale(0.8); pointer-events: none; }
        .card.card-puro { border: 2px solid var(--gold) !important; box-shadow: 0 0 40px rgba(251, 191, 36, 0.4); animation: pulse-gold 1.5s infinite; }
        .cell.cell-waiting { background: #fffbeb !important; color: #b45309 !important; border: 2px dashed #f59e0b; animation: flash-waiting 1s infinite; z-index: 5; font-weight: 900; transform: scale(1.1); box-shadow: 0 0 20px rgba(251, 191, 36, 0.8); text-shadow: none; }
        .cell.win-glow { background: #10b981 !important; color: white; z-index: 3; border: 2px solid #fff; box-shadow: 0 0 25px var(--success), inset 0 0 15px rgba(255,255,255,0.3); animation: popWin 0.4s ease forwards; }
        .cell.win-glow::after { opacity: 0; animation: fadeInLine 0.5s forwards; }
        .cell.win-line-h::after { content:''; position:absolute; top:50%; left:0; right:0; height:6px; background:var(--gold); transform:translateY(-50%); box-shadow:0 0 10px rgba(0,0,0,0.5); z-index:10; border-radius: var(--radius-sm); }
        .cell.win-line-v::after { content:''; position:absolute; top:0; bottom:0; left:50%; width:6px; background:var(--gold); transform:translateX(-50%); box-shadow:0 0 10px rgba(0,0,0,0.5); z-index:10; border-radius: var(--radius-sm); }
        .cell.win-line-d1::after { content:''; position:absolute; top:50%; left:-50%; right:-50%; height:6px; background:var(--gold); transform:translateY(-50%) rotate(45deg); box-shadow:0 0 10px rgba(0,0,0,0.5); z-index:10; }
        .cell.win-line-d2::after { content:''; position:absolute; top:50%; left:-50%; right:-50%; height:6px; background:var(--gold); transform:translateY(-50%) rotate(-45deg); box-shadow:0 0 10px rgba(0,0,0,0.5); z-index:10; }
        .late-overlay, .game-over-overlay { position: absolute; inset: 0; background: rgba(15, 23, 42, 0.95); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px); z-index: 100; display: none; flex-direction: column; align-items: center; justify-content: center; text-align: center; padding: var(--spacing-lg); border-radius: var(--radius-xl); border: 1px solid rgba(255,255,255,0.2); }
        .late-text { font-weight: 800; font-size: 20px; color: white; margin-bottom: var(--spacing-xs); text-shadow: 0 4px 10px rgba(0,0,0,0.8); }
        .late-subtext { font-size: 14px; opacity: 1; color: #cbd5e1; text-shadow: 0 2px 4px black; }
        #winnerBanner { display: none; background: linear-gradient(135deg, #10b981, #059669); color: white; padding: var(--spacing-md); border-radius: var(--radius-lg); text-align: center; font-weight: 900; margin-bottom: var(--spacing-md); animation: slideDown 0.5s ease; border: 2px solid #a7f3d0; box-shadow: 0 10px 30px rgba(16, 185, 129, 0.4); text-shadow: 0 1px 2px rgba(0,0,0,0.5); }
        .winner-line { font-size: 13px; opacity: 1; margin-top: 5px; display: block; font-weight: 600; }
        @keyframes slideDown { from { transform: translateY(-10px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .chat-box { height: 480px; display: flex; flex-direction: column; background: #111827; border-radius: var(--radius-xl); border: 1px solid rgba(255,255,255,0.1); overflow: hidden; box-shadow: 0 20px 50px rgba(0,0,0,0.5); position: relative; }
        .chat-header { padding: var(--spacing-md) 20px; background: rgba(31, 41, 55, 0.95); border-bottom: 1px solid rgba(255,255,255,0.08); display: flex; align-items: center; gap: var(--spacing-sm); z-index: 10; box-shadow: 0 2px 10px rgba(0,0,0,0.2); }
        .chat-header h3 { margin: 0; font-size: 14px; font-weight: 800; letter-spacing: 0.5px; color: var(--accent-glow); text-transform: uppercase; }
        #chatList { flex: 1; overflow-y: auto; padding: var(--spacing-md); display: flex; flex-direction: column; gap: var(--spacing-sm); scroll-behavior: smooth; background: #0f172a; }
        .chat-row { display: flex; gap: var(--spacing-sm); max-width: 100%; animation: fadeIn 0.3s ease; align-items: flex-end; }
        .chat-pfp { width: 32px; height: 32px; border-radius: 50%; border: 1px solid rgba(255,255,255,0.2); flex-shrink: 0; object-fit: cover; cursor: pointer; }
        .chat-content { display: flex; flex-direction: column; max-width: 80%; }
        .bubble { padding: var(--spacing-sm) 14px; font-size: 13px; line-height: 1.4; color: #e2e8f0; word-break: break-word; font-weight: 500; box-shadow: 0 2px 5px rgba(0,0,0,0.1); position: relative; }
        .chat-row[style*="row-reverse"] .bubble { background: linear-gradient(135deg, var(--accent), #2563eb); color: white; border-radius: var(--radius-lg) 18px 4px 18px; text-shadow: 0 1px 2px rgba(0,0,0,0.2); }
        .chat-row:not([style*="row-reverse"]) .bubble { background: #374151; color: #f3f4f6; border-radius: var(--radius-lg) 18px 18px 4px; border: 1px solid var(--glass-border); }
        .chat-name { font-size: 10px; font-weight: 700; color: #94a3b8; margin-bottom: 4px; cursor:pointer; margin-left: 2px; }
        .chat-row[style*="row-reverse"] .chat-name { display: none; }
        .chat-input-area { background: #1f2937; padding: var(--spacing-sm); border-top: 1px solid rgba(255,255,255,0.08); display: flex; gap: var(--spacing-sm); align-items: center; }
        .input-wrapper { flex: 1; display: flex; gap: var(--spacing-sm); background: #374151; padding: 0 15px; border-radius: 24px; border: 1px solid transparent; transition: 0.3s; align-items: center; height: 42px; }
        .input-wrapper:focus-within { border-color: var(--accent); background: #4b5563; }
        .input-wrapper input { flex: 1; background: none; border: none; color: white; outline: none; font-size: 13px; height: 100%; }
        .send-btn { background: var(--accent); color: white; border: none; width: 40px; height: 40px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: 0.2s; box-shadow: 0 4px 12px rgba(14, 165, 233, 0.3); }
        .send-btn:hover { transform: scale(1.05); }
        
        /* === PROFESSIONAL MESSENGER (FULL PAGE) === */
        /* FIX: INCREASED Z-INDEX TO COVER NAV BAR */
        .pm-modal { position: fixed; inset: 0; background: #000000; z-index: 7000; display: none; align-items: flex-start; justify-content: flex-start; flex-direction: column; overflow: hidden; }
        .pm-container { width: 100%; height: 100%; background: #000000; display: flex; flex-direction: column; overflow: hidden; }
        .pm-header { padding: var(--spacing-md) 15px; display: flex; justify-content: space-between; align-items: center; background: #0f172a; border-bottom: 1px solid #1e293b; height: 60px; z-index: 50; }
        .pm-header h3 { font-size: 22px; font-weight: 800; color: white; }
        .pm-inbox-list { flex: 1; overflow-y: auto; padding: 0; background: #000000; }
        .pm-item { display: flex; align-items: center; gap: var(--spacing-sm); padding: var(--spacing-md) 15px; transition: 0.2s; cursor: pointer; border-bottom: 1px solid #111; }
        .pm-item:hover { background: #111; }
        .pm-avatar { width: 55px; height: 55px; border-radius: 50%; object-fit: cover; }
        .pm-info { flex: 1; display: flex; flex-direction: column; gap: 3px; min-width: 0; }
        .pm-name { font-size: 16px; font-weight: 700; color: white; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .pm-preview { font-size: 14px; color: #909090; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 250px; }
        
        .pm-chat-view { display: none; flex-direction: column; height: 100%; background: #000000; position: absolute; inset: 0; z-index: 60; }
        .pm-chat-header { display: flex; align-items: center; justify-content:flex-start; padding: var(--spacing-sm) 15px; border-bottom: 1px solid #1e293b; background: rgba(15, 23, 42, 0.95); backdrop-filter: blur(10px); height: 60px; }
        .pm-messages { flex: 1; overflow-y: auto; padding: var(--spacing-md); display: flex; flex-direction: column; gap: 4px; background: #000000; }
        .msg-bubble { padding: var(--spacing-sm) 16px; font-size: 15px; max-width: 75%; word-break: break-word; line-height: 1.4; margin-bottom: 2px; position: relative; }
        .msg-me { align-self: flex-end; background: var(--messenger-blue); color: white; border-radius: var(--radius-lg) 18px 4px 18px; }
        .msg-them { align-self: flex-start; background: var(--messenger-grey); color: white; border-radius: var(--radius-lg) 18px 18px 4px; }
        .pm-input-area { padding: var(--spacing-sm); background: #0f172a; display: flex; gap: var(--spacing-sm); align-items: center; border-top: 1px solid #1e293b; padding-bottom: calc(10px + env(safe-area-inset-bottom)); }
        .pm-styled-input { flex: 1; background: #1e293b; border: 1px solid #334155; padding: var(--spacing-sm) 20px; border-radius: 25px; color: white; font-size: 15px; outline: none; height: 45px; }
        
        .unread-dot { width: 12px; height: 12px; background: var(--messenger-blue); border-radius: 50%; display: inline-block; box-shadow: 0 0 5px var(--messenger-blue); }
        
        /* PWA Banner */
        #pwaInstallBanner { position: fixed; bottom: calc(80px + env(safe-area-inset-bottom)); left: 0; right: 0; background: linear-gradient(135deg, #0f172a, #1e293b); border-top: 1px solid rgba(255,255,255,0.2); padding: var(--spacing-md) 20px; display: none; align-items: center; justify-content: space-between; z-index: 9999; box-shadow: 0 -10px 30px rgba(0,0,0,0.8); animation: slideUp 0.5s ease; }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
        .pwa-text { font-size: 14px; font-weight: 800; color: white; }
        .pwa-sub { font-size: 11px; color: #cbd5e1; display: block; }
        .pwa-btn { background: var(--accent); color: white; border: none; padding: var(--spacing-sm) 20px; border-radius: var(--radius-md); font-weight: 900; font-size: 13px; cursor: pointer; box-shadow: 0 4px 15px rgba(59, 130, 246, 0.4); }
        .install-tabs { display: flex; gap: var(--spacing-sm); margin-bottom: var(--spacing-lg); background: rgba(0,0,0,0.3); padding: 5px; border-radius: var(--radius-md); }
        .install-tab-btn { flex: 1; padding: var(--spacing-sm); border: none; background: transparent; color: #94a3b8; font-weight: 800; border-radius: var(--radius-sm); cursor: pointer; }
        .install-tab-btn.active { background: var(--accent); color: white; }
        .guide-step { display: flex; align-items: center; gap: var(--spacing-md); margin-bottom: var(--spacing-md); background: rgba(255,255,255,0.05); padding: var(--spacing-md); border-radius: var(--radius-md); border: 1px solid rgba(255,255,255,0.1); }
        .step-num { width: 30px; height: 30px; background: var(--gold); color: black; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 900; flex-shrink: 0; }
        .step-text { font-size: 13px; line-height: 1.4; color: #e2e8f0; }
        #customConfirmModal { position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 100000; display: none; align-items: center; justify-content: center; padding: var(--spacing-lg); backdrop-filter: blur(10px); }
        .conf-content { background: rgba(30, 41, 59, 0.95); border: 1px solid rgba(255,255,255,0.2); border-radius: 24px; padding: 25px; width: 100%; max-width: 320px; text-align: center; box-shadow: 0 25px 60px rgba(0,0,0,0.8); transform: scale(0.9); animation: popScale 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; }
        .conf-title { font-size: 18px; font-weight: 900; color: white; margin: 0 0 10px 0; }
        .conf-msg { font-size: 13px; color: #cbd5e1; margin-bottom: 25px; line-height: 1.5; white-space: pre-wrap; }
        .conf-actions { display: flex; gap: var(--spacing-sm); justify-content: center; }
        .btn-conf-yes { background: var(--accent); color: white; flex: 1; padding: var(--spacing-sm); border: none; border-radius: var(--radius-md); font-weight: 800; cursor: pointer; box-shadow: 0 4px 15px rgba(59, 130, 246, 0.4); }
        .btn-conf-no { background: rgba(255,255,255,0.1); color: #94a3b8; flex: 1; padding: var(--spacing-sm); border: 1px solid rgba(255,255,255,0.1); border-radius: var(--radius-md); font-weight: 800; cursor: pointer; }
        #grandJackpotModal { position: fixed; inset: 0; z-index: 99999; background: rgba(0,0,0,0.95); display: none; align-items: center; justify-content: center; flex-direction: column; overflow: hidden; perspective: 1000px; }
        .jackpot-rays { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 200vmax; height: 200vmax; background: conic-gradient(from 0deg, transparent 0deg, rgba(251, 191, 36, 0.1) 10deg, transparent 20deg, rgba(251, 191, 36, 0.1) 30deg, transparent 40deg, rgba(251, 191, 36, 0.1) 50deg, transparent 60deg, rgba(251, 191, 36, 0.1) 70deg, transparent 80deg, rgba(251, 191, 36, 0.1) 90deg, transparent 100deg, rgba(251, 191, 36, 0.1) 110deg, transparent 120deg, rgba(251, 191, 36, 0.1) 130deg, transparent 140deg, rgba(251, 191, 36, 0.1) 150deg, transparent 160deg, rgba(251, 191, 36, 0.1) 170deg, transparent 180deg, rgba(251, 191, 36, 0.1) 190deg, transparent 200deg, rgba(251, 191, 36, 0.1) 210deg, transparent 220deg, rgba(251, 191, 36, 0.1) 230deg, transparent 240deg, rgba(251, 191, 36, 0.1) 250deg, transparent 260deg, rgba(251, 191, 36, 0.1) 270deg, transparent 280deg, rgba(251, 191, 36, 0.1) 290deg, transparent 300deg, rgba(251, 191, 36, 0.1) 310deg, transparent 320deg, rgba(251, 191, 36, 0.1) 330deg, transparent 340deg, rgba(251, 191, 36, 0.1) 350deg, transparent 360deg); animation: spinRays 20s linear infinite; pointer-events: none; }
        @keyframes spinRays { from { transform: translate(-50%, -50%) rotate(0deg); } to { transform: translate(-50%, -50%) rotate(360deg); } }
        .jackpot-content { position: relative; z-index: 10; text-align: center; animation: jpPopIn 0.8s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        @keyframes jpPopIn { 0% { transform: scale(0); opacity: 0; } 100% { transform: scale(1); opacity: 1; } 100% { transform: scale(1); opacity: 1; } }
        .jp-title { font-size: 40px; font-weight: 900; color: #fbbf24; text-transform: uppercase; letter-spacing: 2px; text-shadow: 0 0 20px rgba(251, 191, 36, 0.8), 0 0 40px rgba(251, 191, 36, 0.4); margin-bottom: var(--spacing-sm); animation: pulseText 1s infinite alternate; }
        .jp-amount { font-size: 56px; font-weight: 900; color: white; background: linear-gradient(135deg, #fff, #fcd34d); -webkit-background-clip: text; -webkit-text-fill-color: transparent; text-shadow: 0 10px 30px rgba(0,0,0,0.5); margin: 0; line-height: 1; }
        .jp-name { font-size: 18px; color: #cbd5e1; margin-top: 15px; font-weight: 600; letter-spacing: 1px; text-transform: uppercase; }
        .icon-glow { filter: drop-shadow(0 0 20px rgba(251, 191, 36, 0.8)); animation: bounceIcon 2s infinite ease-in-out; color: #fbbf24; }
        @keyframes bounceIcon { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-15px); } }
        @keyframes pulseText { from { transform: scale(1); } to { transform: scale(1.05); } }
        @keyframes pulse-ring { 0% { box-shadow: 0 0 0 0 rgba(255,255,255,0.1); } 70% { box-shadow: 0 0 0 15px rgba(255,255,255,0); } 100% { box-shadow: 0 0 0 0 rgba(255,255,255,0); } }
        .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 6000; display: none; align-items: center; justify-content: center; padding: var(--spacing-md); backdrop-filter: blur(15px); }
        .modal-content { background: rgba(30, 41, 59, 0.95); border-radius: 30px; width: 100%; max-width: 450px; padding: 25px; border: 1px solid rgba(255,255,255,0.2); max-height: 90vh; overflow-y: auto; box-shadow: 0 25px 60px rgba(0,0,0,0.8); -webkit-backdrop-filter: blur(20px); backdrop-filter: blur(20px); }
        
        /* === FULL SCREEN STORE MODAL === */
        #storeModal {
            padding: 0;
            align-items: stretch;
            justify-content: stretch;
            background: #020617;
        }
        
        #storeModal .modal-content {
            max-width: 100%;
            max-height: 100%;
            height: 100%;
            width: 100%;
            border-radius: 0;
            padding: 0;
            overflow-y: auto;
            background: linear-gradient(180deg, #0f172a 0%, #020617 100%);
            border: none;
            box-shadow: none;
            display: flex;
            flex-direction: column;
        }
        
        /* Store Header - Fixed at top */
        .store-header {
            position: sticky;
            top: 0;
            z-index: 100;
            background: linear-gradient(145deg, rgba(30, 41, 59, 0.98), rgba(22, 27, 34, 0.98));
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            padding: 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        }
        
        .store-header-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }
        
        .store-back-btn {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: rgba(59, 130, 246, 0.1);
            border: 1.5px solid rgba(59, 130, 246, 0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
            color: #60a5fa;
        }
        .store-back-btn:hover {
            background: rgba(59, 130, 246, 0.2);
            transform: scale(1.08);
            border-color: rgba(59, 130, 246, 0.5);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
        }
        .store-back-btn:active {
            transform: scale(0.95);
        }
        .store-back-btn i {
            width: 20px;
            height: 20px;
        }
        
        .store-title-section {
            flex: 1;
            text-align: center;
        }
        
        .store-title-section h3 {
            margin: 0;
            font-size: 24px;
            font-weight: 900;
            background: linear-gradient(135deg, #60a5fa, #3b82f6);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            letter-spacing: 0.5px;
        }
        
        .store-title-section p {
            margin: 4px 0 0 0;
            font-size: 12px;
            opacity: 0.7;
            font-weight: 600;
        }
        
        .points-badge {
            min-width: 100px;
        }
        
        /* Store Body - Scrollable content */
        .store-body {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            padding-bottom: calc(20px + env(safe-area-inset-bottom));
        }
        .reward-grid { display: grid; grid-template-columns: 1fr; gap: 16px; margin-top: 20px; }
        .reward-item { 
            background: linear-gradient(145deg, rgba(30, 41, 59, 0.95), rgba(22, 27, 34, 0.95));
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            padding: 18px; 
            border-radius: 16px; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            border: 1px solid rgba(255, 255, 255, 0.1); 
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); 
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        }
        .reward-item:hover { 
            transform: translateY(-3px); 
            border-color: rgba(59, 130, 246, 0.4); 
            box-shadow: 0 8px 25px rgba(59, 130, 246, 0.2);
        }
        .reward-main { display: flex; align-items: center; gap: 14px; }
        .reward-icon-box { 
            width: 48px; 
            height: 48px; 
            background: rgba(59, 130, 246, 0.15); 
            border-radius: 12px; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            color: #60a5fa; 
            border: 1.5px solid rgba(59, 130, 246, 0.3);
            transition: all 0.3s ease;
        }
        .reward-item:hover .reward-icon-box {
            transform: scale(1.1);
            background: rgba(59, 130, 246, 0.25);
        }
        .reward-info b { 
            font-size: 16px; 
            display: block; 
            color: white; 
            letter-spacing: 0.3px; 
            text-shadow: 0 2px 2px rgba(0, 0, 0, 0.5); 
            font-weight: 700;
        }
        .reward-info small { 
            color: var(--gold); 
            font-weight: 700; 
            font-size: 12px; 
            display: flex; 
            align-items: center; 
            gap: 4px; 
            margin-top: 4px; 
        }
        .btn-redeem { 
            background: linear-gradient(135deg, #3b82f6, #2563eb); 
            color: white; 
            border: none; 
            padding: 10px 20px; 
            border-radius: 12px; 
            font-weight: 800; 
            font-size: 13px; 
            cursor: pointer; 
            box-shadow: 0 4px 14px rgba(59, 130, 246, 0.4),
                        inset 0 1px 0 rgba(255, 255, 255, 0.2); 
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); 
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.5);
            letter-spacing: 0.3px;
        }
        .btn-redeem:hover {
            background: linear-gradient(135deg, #2563eb, #1d4ed8);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(59, 130, 246, 0.5),
                        inset 0 1px 0 rgba(255, 255, 255, 0.2);
        }
        .btn-redeem:active { 
            transform: translateY(0) scale(0.98); 
        }
        
        /* === PROFESSIONAL PROFILE PAGE (REDESIGNED HIGH END - MOBILE OPTIMIZED) === */
        .profile-page-container { 
            position: fixed; inset: 0; background: #020617; z-index: 6000; 
            display: none; flex-direction: column; overflow-y: auto; 
            padding-bottom: calc(80px + env(safe-area-inset-bottom)); 
            scroll-behavior: smooth;
        }
        
        /* Profile Cover - modern responsive background */
        .profile-cover {
            height: 35vh;
            min-height: 200px;
            max-height: 280px;
            background-size: cover; /* Maintains aspect ratio while filling container */
            background-position: center;
            background-repeat: no-repeat;
            position: relative;
            background-color: #334155;
        }
        /* Gradient overlay for smooth transition */
        .profile-cover::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 120px;
            background: linear-gradient(to bottom, transparent, #020617);
            pointer-events: none;
        }

        .profile-nav-back {
            position: absolute; top: 15px; left: 15px; z-index: 20;
            width: 44px; height: 44px; border-radius: 50%; background: rgba(0,0,0,0.5);
            backdrop-filter: blur(15px); border: 1px solid rgba(255,255,255,0.15);
            color: white; display: flex; align-items: center; justify-content: center; cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }
        .profile-nav-back:hover { background: rgba(0,0,0,0.6); transform: scale(1.05); }
        .profile-nav-back:active { transform: scale(0.95); }
        
        /* Profile Menu Button (3-dot) */
        .profile-menu-btn {
            position: absolute; top: 15px; right: 15px; z-index: 20;
            width: 44px; height: 44px; border-radius: 50%; background: rgba(0,0,0,0.5);
            backdrop-filter: blur(15px); border: 1px solid rgba(255,255,255,0.15);
            color: white; display: flex; align-items: center; justify-content: center; cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }
        .profile-menu-btn:hover { background: rgba(0,0,0,0.6); transform: scale(1.05); }
        .profile-menu-btn:active { transform: scale(0.95); }
        
        /* Dropdown Menu */
        .profile-dropdown {
            position: absolute; top: 65px; right: 15px; z-index: 30;
            background: rgba(15, 23, 42, 0.95);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255,255,255,0.15);
            border-radius: var(--radius-lg);
            overflow: hidden;
            display: none;
            box-shadow: 0 10px 40px rgba(0,0,0,0.5);
            min-width: 240px;
        }
        .profile-dropdown.show { display: block; animation: slideIn 0.2s ease; }
        @keyframes slideIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
        
        .dropdown-item {
            padding: 15px 20px;
            display: flex;
            align-items: center;
            gap: 12px;
            cursor: pointer;
            transition: background 0.2s;
            border-bottom: 1px solid rgba(255,255,255,0.05);
            color: white;
            font-weight: 600;
            font-size: 14px;
        }
        .dropdown-item:last-child { border-bottom: none; }
        .dropdown-item:hover { background: rgba(255,255,255,0.08); }
        .dropdown-item:active { background: rgba(255,255,255,0.12); transform: scale(0.98); }
        .dropdown-item i { width: 18px; height: 18px; }
        
        /* Verification Badge (Blue Checkmark) */
        .verified-badge {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 16px;
            height: 16px;
            background: linear-gradient(135deg, #3b82f6, #2563eb);
            border-radius: 50%;
            margin-left: 4px;
            box-shadow: 0 2px 8px rgba(59, 130, 246, 0.4);
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .verified-badge:hover {
            transform: scale(1.15);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.6);
        }
        .verified-badge i {
            width: 10px;
            height: 10px;
            color: white;
        }
        
        /* Verification Badge Tooltip */
        .verification-tooltip {
            position: fixed;
            background: rgba(15, 23, 42, 0.98);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(59, 130, 246, 0.3);
            border-radius: var(--radius-lg);
            padding: 20px;
            max-width: 300px;
            z-index: 10000;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
            display: none;
            animation: tooltipFadeIn 0.2s ease;
        }
        @keyframes tooltipFadeIn {
            from { opacity: 0; transform: translateY(-5px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .verification-tooltip h4 {
            margin: 0 0 10px 0;
            color: #3b82f6;
            font-size: 14px;
            font-weight: 800;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .verification-tooltip p {
            margin: 0;
            font-size: 12px;
            line-height: 1.6;
            color: #cbd5e1;
        }
        
        /* Textarea in confirmation modal */
        .conf-textarea {
            width: 100%;
            background: rgba(0, 0, 0, 0.4);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: var(--radius-md);
            padding: 12px;
            color: white;
            font-family: 'Inter', sans-serif;
            font-size: 13px;
            resize: vertical;
            min-height: 80px;
            margin-top: 15px;
            outline: none;
        }
        .conf-textarea:focus {
            border-color: var(--accent);
            background: rgba(0, 0, 0, 0.6);
        }
        .conf-textarea::placeholder {
            color: rgba(255, 255, 255, 0.4);
        }
        
        .profile-info-section {
            padding: 0 20px;
            margin-top: -80px; /* Elegant avatar overlap with cover photo */
            position: relative;
            z-index: 10;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        .profile-avatar-container {
            position: relative;
            margin-bottom: var(--spacing-md);
        }
        
        /* Avatar frame styling for profile page - cleaner border and glow */
        /* Note: !important is required to override inline styles set by renderAvatarWithBadge JS function */
        .profile-avatar-container .avatar-frame {
            width: 120px !important;
            height: 120px !important;
            filter: drop-shadow(0 8px 24px rgba(0,0,0,0.4));
        }
        .profile-avatar-container .avatar-frame img {
            border: 4px solid white !important;
            box-shadow: 0 0 30px rgba(59, 130, 246, 0.3);
        }
        
        .profile-rank-ring {
            position: absolute; inset: -8px; border-radius: 50%;
            border: 2px solid rgba(255,255,255,0.2);
            animation: spin 20s linear infinite;
            pointer-events: none;
        }

        .profile-page-name { 
            font-size: 28px; font-weight: 900; color: white; 
            margin: 0 0 8px 0; letter-spacing: 0.5px; 
            display: flex; align-items: center; gap: var(--spacing-xs); justify-content: center; 
            text-shadow: 0 2px 8px rgba(0,0,0,0.6), 0 4px 16px rgba(0,0,0,0.3); 
            text-align: center; 
        }
        .profile-page-bio { 
            font-size: 15px; color: #cbd5e1; 
            margin: 0 0 25px 0; text-align: center; 
            max-width: 320px; line-height: 1.6;
            text-shadow: 0 1px 3px rgba(0,0,0,0.5);
        }
        
        .profile-action-btn {
            padding: 14px 32px;
            width: 100%;
            max-width: 280px;
            background: linear-gradient(135deg, #3b82f6, #2563eb);
            color: white;
            border: none;
            border-radius: 50px;
            font-size: 14px; font-weight: 700; 
            cursor: pointer; 
            box-shadow: 0 4px 20px rgba(59, 130, 246, 0.4);
            transition: all 0.3s ease; 
            margin-bottom: var(--spacing-sm);
            text-transform: uppercase; 
            letter-spacing: 1px;
        }
        .profile-action-btn:hover { 
            box-shadow: 0 6px 30px rgba(59, 130, 246, 0.5); 
            transform: translateY(-2px);
        }
        .profile-action-btn:active { transform: scale(0.97); }
        .profile-action-btn.secondary { 
            background: rgba(255,255,255,0.08); 
            border: 1px solid rgba(255,255,255,0.15); 
            box-shadow: none; 
            color: white; 
            backdrop-filter: blur(12px);
        }
        .profile-action-btn.secondary:hover {
            background: rgba(255,255,255,0.12);
            border-color: rgba(255,255,255,0.25);
        }
        
        .profile-stats-card {
            display: flex; justify-content: space-around;
            background: rgba(15, 23, 42, 0.6);
            border: 1px solid var(--glass-border);
            backdrop-filter: blur(20px);
            padding: var(--spacing-lg) 15px;
            border-radius: var(--radius-xl);
            width: 100%;
            margin-bottom: var(--spacing-lg);
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }
        .stat-item { text-align: center; flex: 1; position: relative; }
        .stat-item:not(:last-child)::after {
            content: ''; position: absolute; right: 0; top: 10%; bottom: 10%; width: 1px; background: rgba(255,255,255,0.08);
        }
        .stat-val { font-size: 20px; font-weight: 900; color: white; display: block; margin-bottom: 4px; letter-spacing: 0.5px; }
        .stat-lbl { font-size: 11px; color: #94a3b8; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; }
        
        .profile-feed-section {
            padding: 0 10px;
            width: 100%;
        }
        
        .profile-feed-section::before {
            content: 'Posts';
            display: block;
            font-size: 16px;
            font-weight: 800;
            color: white;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: var(--spacing-md);
            padding-bottom: 12px;
            border-bottom: 2px solid rgba(255,255,255,0.1);
        }
        
        .profile-header { display: flex; align-items: center; gap: var(--spacing-md); margin-bottom: 25px; padding-bottom: 15px; border-bottom: 1px solid rgba(255,255,255,0.1); }
        .profile-img-large { width: 70px; height: 70px; border-radius: 22px; border: 3px solid var(--accent); box-shadow: 0 0 20px rgba(59, 130, 246, 0.3); object-fit: cover; }
        .profile-name-info { flex: 1; }
        .profile-name { font-size: 20px; font-weight: 900; margin: 0; text-shadow: 0 2px 4px rgba(0,0,0,0.8); }
        .profile-uid { font-size: 11px; opacity: 0.8; text-transform: uppercase; letter-spacing: 1px; color: #cbd5e1; }
        .gcash-section { background: rgba(59, 130, 246, 0.15); padding: var(--spacing-md); border-radius: var(--radius-lg); margin-bottom: var(--spacing-md); border: 1px solid rgba(59, 130, 246, 0.3); }
        .styled-input { width: 100%; background: rgba(0,0,0,0.4); border: 1px solid rgba(255,255,255,0.2); padding: var(--spacing-sm) 15px; border-radius: var(--radius-md); color: white; font-weight: 700; outline: none; font-size: 14px; box-shadow: inset 0 2px 5px rgba(0,0,0,0.3); text-shadow: none; }
        .styled-input:focus { border-color: var(--accent); background: rgba(0,0,0,0.6); }
        .ref-container { background: linear-gradient(135deg, rgba(16, 185, 129, 0.15), rgba(59, 130, 246, 0.15)); border: 1px solid rgba(16, 185, 129, 0.3); padding: var(--spacing-md); border-radius: var(--radius-lg); margin-bottom: var(--spacing-md); }
        .history-box { margin-top: var(--spacing-lg); background: rgba(0,0,0,0.3); border-radius: var(--radius-xl); padding: var(--spacing-lg); border: 1px solid rgba(255,255,255,0.1); }
        .history-list { max-height: 250px; overflow-y: auto; padding-right: 5px; }
        .history-item { display: flex; justify-content: space-between; align-items: center; padding: var(--spacing-sm) 0; border-bottom: 1px solid rgba(255,255,255,0.1); }
        .btn-change { background: rgba(59, 130, 246, 0.2); color: var(--accent-glow); border: 1px solid var(--accent); height: 40px; padding: 0 15px; border-radius: var(--radius-md); font-size: 11px; font-weight: 800; cursor: pointer; display: flex; align-items: center; gap: 5px; transition: 0.2s; box-shadow: 0 4px 10px rgba(0,0,0,0.2); text-shadow: 0 1px 2px black; }
        .btn-change:hover { background: var(--accent); color: white; }
        .btn-change:disabled { opacity: 0.5; cursor: not-allowed; border-color: #475569; color: #94a3b8; background: none; }
        .pattern-box { background: rgba(0,0,0,0.4); height: 40px; padding: 0 15px; border-radius: var(--radius-md); display: flex; align-items: center; gap: var(--spacing-xs); border: 1px solid rgba(255,255,255,0.1); backdrop-filter: blur(5px); }
        .pattern-dot { width: 8px; height: 8px; border-radius: 50%; background: var(--gold); box-shadow: 0 0 10px var(--gold); }
        .pattern-text { font-size: 11px; font-weight: 800; color: var(--gold); text-transform: uppercase; letter-spacing: 0.5px; }
        .notif-card-new { background: rgba(255,255,255,0.1); padding: var(--spacing-md); border-radius: var(--radius-lg); margin-bottom: 12px; border: 1px solid rgba(255,255,255,0.15); position: relative; transition: 0.2s; backdrop-filter: blur(5px); }
        .notif-card-new:hover { background: rgba(255,255,255,0.15); border-color: var(--accent); }
        .notif-header-new { display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--spacing-xs); }
        .notif-title { font-size: 12px; font-weight: 800; color: var(--accent-glow); display: flex; align-items: center; gap: 5px; }
        .notif-time { font-size: 10px; opacity: 0.6; color: #cbd5e1; }
        .notif-body { font-size: 13px; line-height: 1.5; color: #ffffff; text-shadow: 0 1px 2px black; }
        .btn-del-notif { background: none; border: none; color: #94a3b8; cursor: pointer; padding: 4px; transition: 0.2s; }
        .btn-del-notif:hover { color: var(--danger); }
        .result-modal { position: absolute; inset: 0; background: rgba(0,0,0,0.85); display: none; align-items: center; justify-content: center; flex-direction: column; z-index: 50; border-radius: 30px; backdrop-filter: blur(8px); animation: fadeIn 0.3s; }
        .res-title { font-size: 38px; font-weight: 900; margin-bottom: 5px; text-transform: uppercase; letter-spacing: 1px; }
        .res-win { color: #fbbf24; text-shadow: 0 0 30px #fbbf24; }
        .res-loss { color: #ef4444; text-shadow: 0 0 20px rgba(239, 68, 68, 0.5); }
        .res-pts { font-size: 16px; color: white; opacity: 1; margin-bottom: 25px; text-shadow: 0 2px 4px black; }
        .btn-play-again { background: white; color: black; border: none; padding: var(--spacing-sm) 25px; border-radius: 30px; font-weight: 900; font-size: 12px; cursor: pointer; box-shadow: 0 0 20px rgba(255,255,255,0.3); transition: 0.2s; }
        .btn-play-again:hover { transform: scale(1.1); box-shadow: 0 0 30px rgba(255,255,255,0.5); }
        @keyframes blink { from { opacity: 0.5; } to { opacity: 1; } }

        /* === NEW SOCIAL ECOSYSTEM STYLES === */
        .social-feed-container { margin-top: 15px; display: flex; flex-direction: column; gap: var(--spacing-md); }
        
        /* Modern Feed Sort Pills */
        .feed-sort-modern {
            display: flex; 
            align-items: center; 
            justify-content: center; 
            gap: 0;
            margin: 15px auto; 
            padding: 4px; 
            background: rgba(30, 41, 59, 0.8); 
            border-radius: 50px; 
            border: 1px solid rgba(255,255,255,0.1);
            width: fit-content;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
        }
        .sort-btn {
            display: flex; 
            align-items: center; 
            gap: var(--spacing-xs); 
            padding: var(--spacing-sm) 28px;
            border-radius: 50px; 
            border: none; 
            background: transparent;
            color: #94a3b8; 
            font-size: 12px; 
            font-weight: 800; 
            cursor: pointer; 
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .sort-btn.active {
            background: linear-gradient(135deg, var(--accent), #2563eb);
            color: white;
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4);
            transform: scale(1.02);
        }
        .sort-btn:hover:not(.active) { 
            color: white; 
            background: rgba(255,255,255,0.05);
        }

        /* Post Card - Modern Social Media Style */
        .post-card { 
            background: linear-gradient(145deg, rgba(30, 41, 59, 0.95), rgba(22, 27, 34, 0.95));
            backdrop-filter: blur(20px);
            border-radius: 20px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            overflow: hidden;
            margin-bottom: 20px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.4), 
                        0 0 0 1px rgba(59, 130, 246, 0.05);
        }
        .post-card:hover {
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.5),
                        0 0 0 1px rgba(59, 130, 246, 0.2);
            transform: translateY(-2px);
        }

        .post-header { 
            padding: 18px 20px;
            display: flex;
            align-items: center;
            gap: 12px;
            border-bottom: none;
        }
        
        .post-avatar { 
            width: 44px;
            height: 44px;
            border-radius: 50%;
            object-fit: cover;
            border: 2.5px solid rgba(59, 130, 246, 0.3);
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            flex-shrink: 0;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4),
                        0 0 0 3px rgba(59, 130, 246, 0.1);
        }
        .post-avatar:hover {
            transform: scale(1.08);
            border-color: rgba(59, 130, 246, 0.6);
            box-shadow: 0 6px 20px rgba(59, 130, 246, 0.3),
                        0 0 0 3px rgba(59, 130, 246, 0.2);
        }
        
        .post-meta { 
            flex: 1;
            min-width: 0;
        }
        
        .post-author { 
            font-size: 15px;
            font-weight: 700;
            color: white;
            display: flex;
            align-items: center;
            gap: 6px;
            line-height: 1.3;
        }
        
        .add-friend-icon-btn {
            background: rgba(59, 130, 246, 0.12);
            border: 1.5px solid rgba(59, 130, 246, 0.3);
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
            color: #60a5fa;
        }
        .add-friend-icon-btn:hover {
            background: rgba(59, 130, 246, 0.25);
            border-color: rgba(59, 130, 246, 0.5);
            transform: scale(1.15);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
        }
        .add-friend-icon-btn:active {
            transform: scale(1.0);
        }
        .add-friend-icon-btn i {
            width: 14px;
            height: 14px;
        }
        
        .friend-badge { 
            display: none; /* Remove friend badge text */
        }
        
        .post-time { 
            font-size: 12px;
            color: rgba(255, 255, 255, 0.45);
            display: flex;
            align-items: center;
            gap: 5px;
            margin-top: 3px;
            font-weight: 500;
            line-height: 1;
        }
        
        .visibility-badge { 
            font-size: 11px;
            opacity: 0.8;
            display: inline-flex;
            align-items: center;
            line-height: 1;
        }
        .visibility-badge i {
            width: 11px;
            height: 11px;
            display: block;
        }
        
        .mood-display { 
            font-size: 11px;
            background: rgba(59, 130, 246, 0.15);
            padding: 3px 10px;
            border-radius: 12px;
            margin-top: 4px;
            display: inline-block;
            color: rgba(59, 130, 246, 0.9);
            border: 1px solid rgba(59, 130, 246, 0.2);
            font-weight: 600;
        }
        
        .post-content { 
            padding: 0 16px 16px 16px;
            font-size: 15px;
            line-height: 1.5;
            color: rgba(255, 255, 255, 0.9);
            word-break: break-word;
        }
        
        .post-image-container { 
            width: 100%;
            max-height: 400px;
            overflow: hidden;
            display: flex;
            justify-content: center;
            background: #000;
            margin: 0;
            border-top: 1px solid rgba(255, 255, 255, 0.05);
        }
        
        .post-image { 
            max-width: 100%;
            max-height: 400px;
            object-fit: cover;
            width: 100%;
        }
        
        .post-actions { 
            display: flex;
            align-items: center;
            padding: 4px 8px;
            border-top: 1px solid rgba(255, 255, 255, 0.06);
        }
        
        .action-btn { 
            flex: 1;
            background: transparent;
            border: none;
            color: rgba(255, 255, 255, 0.6);
            padding: 10px 12px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: all 0.2s ease;
            position: relative;
            border-radius: 8px;
            margin: 0 2px;
        }
        
        .action-btn:hover { 
            background: rgba(59, 130, 246, 0.1);
            color: rgba(59, 130, 246, 0.9);
            transform: scale(1.05);
        }
        
        .action-btn:active {
            transform: scale(0.95);
        }
        
        .action-btn.liked { 
            color: #f472b6;
            background: rgba(244, 114, 182, 0.1);
        }
        
        .action-btn.liked:hover {
            background: rgba(244, 114, 182, 0.15);
            color: #fb7bca;
        }
        
        .action-btn.delete-btn {
            color: #ef4444;
        }
        
        .action-btn.delete-btn:hover {
            background: rgba(239, 68, 68, 0.1);
            color: #f87171;
        }

        /* Overflow Menu Styles - Modern Dropdown */
        .post-overflow-btn {
            background: transparent;
            border: none;
            color: rgba(255, 255, 255, 0.5);
            cursor: pointer;
            padding: 8px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            position: relative;
        }
        .post-overflow-btn:hover {
            background: rgba(255, 255, 255, 0.1);
            color: rgba(59, 130, 246, 0.9);
        }
        .post-overflow-menu {
            position: absolute;
            top: 100%;
            right: 0;
            background: rgba(22, 27, 34, 0.98);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.6);
            min-width: 180px;
            z-index: 1000;
            display: none;
            overflow: hidden;
            animation: slideIn 0.2s ease;
        }
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-8px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        .post-overflow-menu.show {
            display: block;
        }
        .overflow-menu-item {
            width: 100%;
            padding: 12px 16px;
            background: transparent;
            border: none;
            color: white;
            text-align: left;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.2s ease;
        }
        .overflow-menu-item:hover {
            background: rgba(59, 130, 246, 0.1);
        }
        .overflow-menu-item.delete-item {
            color: #ef4444;
        }
        .overflow-menu-item.delete-item:hover {
            background: rgba(239, 68, 68, 0.1);
        }

        .shared-post-container {
            margin: 0 16px 16px 16px;
            padding: 12px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            background: rgba(0, 0, 0, 0.25);
            font-size: 13px;
            color: rgba(255, 255, 255, 0.7);
        }
        
        /* Reaction Popup */
        .reaction-popup {
            position: absolute;
            bottom: 100%; left: 10px;
            background: rgba(30, 41, 59, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 50px;
            padding: 5px 10px;
            display: none;
            gap: 5px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.5);
            border: 1px solid rgba(255,255,255,0.1);
            animation: popIn 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            z-index: 10;
        }
        .reaction-emoji {
            font-size: 20px;
            cursor: pointer;
            transition: transform 0.2s;
        }
        .reaction-emoji:hover { transform: scale(1.3); }

        .comment-preview-area {
            padding: 12px 16px;
            border-top: 1px solid rgba(255, 255, 255, 0.06);
            background: rgba(0, 0, 0, 0.15);
        }
        .preview-item { 
            display: flex;
            gap: 8px;
            font-size: 13px;
            align-items: center;
        }
        .preview-user { 
            font-weight: 700;
            color: white;
            cursor: pointer;
            transition: color 0.2s;
        }
        .preview-user:hover {
            color: rgba(59, 130, 246, 0.9);
        }
        .preview-text { 
            color: rgba(255, 255, 255, 0.6);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 220px;
        }
        
        /* Support Ticket Styles */
        .ticket-item {
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: var(--radius-md);
            padding: var(--spacing-sm);
            margin-bottom: var(--spacing-sm);
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .ticket-item:hover {
            background: rgba(255,255,255,0.08);
            border-color: var(--accent);
            transform: translateX(4px);
        }
        .ticket-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 5px;
        }
        .ticket-subject {
            font-weight: 800;
            font-size: 12px;
            color: white;
        }
        .ticket-status {
            font-size: 9px;
            padding: 3px 8px;
            border-radius: var(--radius-sm);
            font-weight: 800;
            text-transform: uppercase;
        }
        .ticket-status.open {
            background: rgba(251, 191, 36, 0.2);
            color: var(--gold);
        }
        .ticket-status.closed {
            background: rgba(100, 116, 139, 0.2);
            color: #94a3b8;
        }
        .ticket-time {
            font-size: 10px;
            color: #64748b;
            margin-top: 5px;
        }
        .ticket-reply-count {
            font-size: 10px;
            color: var(--accent-glow);
            display: flex;
            align-items: center;
            gap: 4px;
        }
        
        .ticket-reply-item {
            background: rgba(0,0,0,0.3);
            border: 1px solid var(--glass-border);
            border-radius: var(--radius-md);
            padding: var(--spacing-sm);
            margin-bottom: 12px;
        }
        .ticket-reply-header {
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
            margin-bottom: var(--spacing-xs);
        }
        .ticket-reply-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid rgba(255,255,255,0.2);
        }
        .ticket-reply-author {
            font-weight: 800;
            font-size: 12px;
            color: white;
        }
        .ticket-reply-admin-badge {
            background: var(--accent);
            color: white;
            font-size: 8px;
            padding: 2px 6px;
            border-radius: 4px;
            font-weight: 900;
            text-transform: uppercase;
        }
        .ticket-reply-time {
            font-size: 10px;
            color: #64748b;
            margin-left: auto;
        }
        .ticket-reply-content {
            font-size: 12px;
            line-height: 1.5;
            color: #e2e8f0;
        }
        .ticket-original-message {
            background: rgba(59, 130, 246, 0.1);
            border: 1px solid rgba(59, 130, 246, 0.3);
            border-radius: var(--radius-md);
            padding: var(--spacing-sm);
            margin-bottom: var(--spacing-md);
        }
        .ticket-original-label {
            font-size: 10px;
            font-weight: 800;
            color: var(--accent-glow);
            margin-bottom: var(--spacing-xs);
            text-transform: uppercase;
        }


        /* Friend Request Notification in Feed */
        .friend-req-card { background: rgba(14, 165, 233, 0.1); border: 1px solid var(--accent); padding: var(--spacing-sm); border-radius: var(--radius-md); display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--spacing-md); }
        .req-info { display: flex; align-items: center; gap: var(--spacing-sm); }
        .req-actions { display: flex; gap: 5px; }
        .btn-accept { background: var(--success); color: white; border: none; padding: 6px 12px; border-radius: var(--radius-sm); font-weight: 700; font-size: 11px; cursor: pointer; }
        .btn-decline { background: rgba(255,255,255,0.1); color: white; border: none; padding: 6px 12px; border-radius: var(--radius-sm); font-weight: 700; font-size: 11px; cursor: pointer; }

        /* User Options Modal */
        .user-opt-btn { width: 100%; padding: var(--spacing-md); border: none; background: rgba(255,255,255,0.05); color: white; font-weight: 700; margin-bottom: var(--spacing-xs); border-radius: var(--radius-md); text-align: left; display: flex; align-items: center; gap: var(--spacing-sm); cursor: pointer; }
        .user-opt-btn:hover { background: rgba(255,255,255,0.1); }

        /* UPDATED MESSENGER STYLES */
        .active-friends-bar {
            display: flex; gap: var(--spacing-md); overflow-x: auto; padding: var(--spacing-md); background: #0f172a; border-bottom: 1px solid #1e293b; scrollbar-width: none;
        }
        .active-friend-item {
            display: flex; flex-direction: column; align-items: center; min-width: 60px; cursor: pointer;
        }
        .active-img-wrap { position: relative; width: 50px; height: 50px; }
        .active-img { width: 50px; height: 50px; border-radius: 50%; border: 2px solid var(--messenger-blue); object-fit: cover; }
        .online-dot-large { position: absolute; bottom: 2px; right: 2px; width: 12px; height: 12px; background: #31a24c; border: 2px solid #000; border-radius: 50%; }
        .active-name { font-size: 11px; color: #e4e6eb; margin-top: 5px; max-width: 60px; overflow: hidden; white-space: nowrap; text-overflow: ellipsis; }

        /* NEW BOTTOM SHEET COMMENTS STYLE (TIKTOK/FB STYLE) */
        .comment-modal { 
            position: fixed; inset: auto; bottom: 0; left: 0; right: 0; height: 70vh; 
            background: #1e293b; z-index: 7000; display: none; flex-direction: column; 
            border-radius: var(--radius-xl) 20px 0 0; border-top: 1px solid rgba(255,255,255,0.1);
            animation: slideUpModal 0.3s cubic-bezier(0.16, 1, 0.3, 1);
            box-shadow: 0 -10px 50px rgba(0,0,0,0.5);
        }
        @keyframes slideUpModal { from { transform: translateY(100%); } to { transform: translateY(0); } }
        .comment-modal-backdrop { position: fixed; inset: 0; background: rgba(0,0,0,0.7); z-index: 6999; display: none; backdrop-filter: blur(2px); }

        .comment-header { padding: var(--spacing-md); background: #1e293b; border-bottom: 1px solid rgba(255,255,255,0.1); display: flex; justify-content: space-between; align-items: center; border-radius: var(--radius-xl) 20px 0 0; }
        .comment-list { flex: 1; overflow-y: auto; padding: var(--spacing-md); display: flex; flex-direction: column; gap: var(--spacing-md); }
        .comment-item { display: flex; gap: var(--spacing-sm); align-items: flex-start; }
        .comment-avatar { width: 32px; height: 32px; border-radius: 50%; flex-shrink: 0; }
        .comment-content-block { display: flex; flex-direction: column; max-width: 85%; }
        .comment-bubble { background: #334155; padding: 8px 12px; border-radius: var(--radius-md); margin-bottom: 2px; }
        .comment-author { font-size: 11px; font-weight: 800; color: white; margin-bottom: 2px; display: flex; align-items: center; gap: 5px; }
        .comment-text { font-size: 13px; color: #cbd5e1; word-break: break-word; }
        .comment-actions { display: flex; gap: var(--spacing-md); font-size: 10px; font-weight: 700; color: #94a3b8; padding-left: 5px; }
        .cmt-action-btn { background: none; border: none; padding: 0; color: #94a3b8; font-size: 10px; font-weight: 700; cursor: pointer; }
        .cmt-action-btn:hover { color: white; }
        
        .comment-input-area { padding: var(--spacing-sm); background: #1e293b; display: flex; flex-direction: column; gap: var(--spacing-sm); border-top: 1px solid rgba(255,255,255,0.05); padding-bottom: calc(10px + env(safe-area-inset-bottom)); }
        .comment-input-row { display: flex; gap: var(--spacing-sm); }
        .comment-input { flex: 1; background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.1); padding: var(--spacing-sm) 15px; border-radius: var(--radius-xl); color: white; outline: none; }
        
        .comment-preview-box { display: none; background: rgba(0,0,0,0.2); border: 1px solid var(--glass-border); border-radius: var(--radius-md); padding: var(--spacing-sm) 15px; margin-top: 5px; }
        .comment-preview-label { font-size: 9px; font-weight: 700; color: #94a3b8; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 5px; }
        .comment-preview-content { display: flex; gap: var(--spacing-xs); align-items: flex-start; }
        .comment-preview-avatar { width: 24px; height: 24px; border-radius: 50%; object-fit: cover; border: 1px solid rgba(255,255,255,0.1); }
        .comment-preview-bubble { background: #334155; padding: 6px 10px; border-radius: var(--radius-sm); max-width: 100%; }
        .comment-preview-text { font-size: 12px; color: #cbd5e1; word-break: break-word; line-height: 1.4; }

        /* SHARE POST MODAL */
        .share-modal { 
            position: fixed; inset: auto; bottom: 0; left: 0; right: 0; height: auto; max-height: 60vh;
            background: #1e293b; z-index: 7000; display: none; flex-direction: column; 
            border-radius: var(--radius-xl) 20px 0 0; border-top: 1px solid rgba(255,255,255,0.1);
            animation: slideUpModal 0.3s cubic-bezier(0.16, 1, 0.3, 1);
            box-shadow: 0 -10px 50px rgba(0,0,0,0.5);
        }
        .share-modal-backdrop { position: fixed; inset: 0; background: rgba(0,0,0,0.7); z-index: 6999; display: none; backdrop-filter: blur(2px); }
        .share-header { padding: var(--spacing-md); background: #1e293b; border-bottom: 1px solid rgba(255,255,255,0.1); display: flex; justify-content: space-between; align-items: center; border-radius: var(--radius-xl) 20px 0 0; }
        .share-content { padding: var(--spacing-lg) 20px calc(20px + env(safe-area-inset-bottom)) 20px; display: flex; flex-direction: column; gap: var(--spacing-md); }
        .share-btn-option { background: rgba(59, 130, 246, 0.1); border: 1px solid rgba(59, 130, 246, 0.3); color: white; padding: var(--spacing-md); border-radius: var(--radius-md); font-weight: 700; cursor: pointer; transition: 0.2s; display: flex; align-items: center; gap: var(--spacing-sm); }
        .share-btn-option:hover { background: rgba(59, 130, 246, 0.2); transform: translateY(-2px); }
        .share-post-preview { background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.1); padding: var(--spacing-sm); border-radius: var(--radius-md); margin-bottom: var(--spacing-sm); }
        .share-post-preview-author { font-size: 12px; font-weight: 700; color: #cbd5e1; margin-bottom: 5px; }
        .share-post-preview-content { font-size: 11px; color: #94a3b8; overflow: hidden; text-overflow: ellipsis; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; }

        .image-preview-container { 
            display: none; 
            position: relative; 
            margin: var(--spacing-md) 0;
            border-radius: var(--radius-lg);
            overflow: hidden;
            animation: fadeIn 0.3s ease;
        }
        .image-preview-img { 
            max-height: 250px; 
            width: 100%;
            object-fit: cover;
            border-radius: var(--radius-lg);
            border: 1px solid rgba(59, 130, 246, 0.2);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }
        .btn-remove-img { 
            position: absolute; 
            top: 8px; 
            right: 8px; 
            background: rgba(239, 68, 68, 0.95);
            backdrop-filter: blur(10px);
            color: white; 
            border-radius: 50%; 
            width: 32px; 
            height: 32px; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            cursor: pointer; 
            border: 2px solid rgba(255, 255, 255, 0.3);
            font-size: 14px;
            transition: all 0.2s ease;
        }
        .btn-remove-img:hover {
            background: rgba(220, 38, 38, 1);
            transform: scale(1.1) rotate(90deg);
        }
        .btn-remove-img:active {
            transform: scale(0.95);
        }

        /* EDIT PROFILE MODAL */
        .edit-input { width: 100%; background: #334155; border: 1px solid rgba(255,255,255,0.1); padding: var(--spacing-sm); border-radius: var(--radius-md); color: white; margin-bottom: var(--spacing-md); outline: none; }
        .edit-label { font-size: 11px; color: #94a3b8; margin-bottom: 5px; display: block; font-weight: 700; text-transform: uppercase; }

        /* SEARCH MODAL */
        .search-modal-container { position: fixed; inset: 0; background: #0f172a; z-index: 7000; display: none; flex-direction: column; }
        .search-header { padding: var(--spacing-md); background: #1e293b; display: flex; gap: var(--spacing-sm); align-items: center; border-bottom: 1px solid rgba(255,255,255,0.1); }
        .search-bar-wrap { flex: 1; background: rgba(0,0,0,0.3); border-radius: var(--radius-xl); padding: 8px 15px; display: flex; align-items: center; gap: var(--spacing-xs); border: 1px solid rgba(255,255,255,0.1); }
        .search-input { background: none; border: none; color: white; outline: none; width: 100%; font-size: 14px; }
        .search-results { flex: 1; overflow-y: auto; padding: var(--spacing-md); }
        .search-res-item { display: flex; align-items: center; gap: var(--spacing-sm); padding: var(--spacing-sm); border-bottom: 1px solid rgba(255,255,255,0.05); cursor: pointer; }
        .search-res-img { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; }

        /* VIEW TOGGLING */
        #view-home, #view-bingo { display: none; animation: fadeIn 0.3s ease; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* REACTION VIEWER MODAL */
        .reaction-viewer-modal {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            height: 60vh;
            background: #1e293b;
            z-index: 8000;
            display: none;
            flex-direction: column;
            border-radius: var(--radius-xl) 20px 0 0;
            border-top: 1px solid rgba(255,255,255,0.1);
            animation: slideUpModal 0.3s cubic-bezier(0.16, 1, 0.3, 1);
            box-shadow: 0 -10px 50px rgba(0,0,0,0.5);
        }
        .reaction-viewer-backdrop {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.7);
            z-index: 7999;
            display: none;
            backdrop-filter: blur(2px);
        }
        .reaction-viewer-header {
            padding: var(--spacing-md);
            background: #1e293b;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-radius: var(--radius-xl) 20px 0 0;
        }
        .reaction-viewer-list {
            flex: 1;
            overflow-y: auto;
            padding: var(--spacing-md);
            display: flex;
            flex-direction: column;
            gap: var(--spacing-sm);
        }
        .reaction-viewer-item {
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
            padding: var(--spacing-sm);
            background: rgba(0,0,0,0.2);
            border-radius: var(--radius-md);
            cursor: pointer;
            transition: background 0.2s;
        }
        .reaction-viewer-item:hover {
            background: rgba(255,255,255,0.05);
        }
        .reaction-viewer-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid rgba(255,255,255,0.1);
        }
        .reaction-viewer-info {
            flex: 1;
        }
        .reaction-viewer-name {
            font-size: 13px;
            font-weight: 700;
            color: white;
        }
        .reaction-viewer-emoji {
            font-size: 20px;
        }

        /* === REACTION SUMMARY BAR (Twitter/FB Style) === */
        .reaction-summary-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 20px;
            font-size: 12px;
            color: rgba(255, 255, 255, 0.5);
            cursor: pointer;
            transition: all 0.2s ease;
            font-weight: 500;
        }
        .reaction-summary-bar:hover {
            background: rgba(255, 255, 255, 0.03);
        }
        .reaction-summary-bar:empty { display: none; }
        
        .reaction-emojis-group {
            display: flex;
            align-items: center;
            margin-right: 3px;
        }
        .reaction-emojis-group span {
            font-size: 16px;
            line-height: 1;
            width: 22px;
            height: 22px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            background: rgba(30, 41, 59, 0.95);
            border-radius: 50%;
            border: 1.5px solid rgba(15, 23, 42, 0.9);
            margin-left: -6px;
            transition: transform 0.2s ease;
        }
        .reaction-emojis-group span:first-child {
            margin-left: 0;
            z-index: 3;
        }
        .reaction-emojis-group span:nth-child(2) {
            z-index: 2;
        }
        .reaction-emojis-group span:nth-child(3) {
            z-index: 1;
        }
        .reaction-emojis-group:hover span {
            margin-left: 2px;
        }
        .reaction-emojis-group:hover span:first-child {
            margin-left: 0;
        }
        .reaction-count-text {
            margin-left: 8px;
            font-size: 12px;
            color: rgba(255, 255, 255, 0.5);
            font-weight: 500;
        }
        .comment-count-text {
            font-size: 12px;
            color: rgba(255, 255, 255, 0.5);
            font-weight: 500;
        }
        
        .reaction-summary-item {
            display: none; /* Hide old individual count items */
        }

        /* === PEOPLE YOU MAY KNOW (PYMK) === */
        .pymk-section { margin-bottom: var(--spacing-lg); }
        .pymk-title { padding: 0 5px; margin-bottom: var(--spacing-sm); font-size: 14px; font-weight: 800; color: #cbd5e1; }
        .pymk-scroll { display: flex; gap: var(--spacing-sm); overflow-x: auto; padding-bottom: 10px; scrollbar-width: none; }
        .pymk-card { background: #1e293b; border: 1px solid var(--glass-border); min-width: 140px; width: 140px; padding: var(--spacing-md); border-radius: var(--radius-lg); display: flex; flex-direction: column; align-items: center; text-align: center; position: relative; }
        .pymk-img { width: 60px; height: 60px; border-radius: 50%; object-fit: cover; margin-bottom: var(--spacing-sm); border: 2px solid rgba(255,255,255,0.1); }
        .pymk-name { font-size: 13px; font-weight: 700; color: white; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; width: 100%; margin-bottom: var(--spacing-xs); }
        .btn-add-friend-sm { background: rgba(14, 165, 233, 0.2); color: var(--accent-glow); border: 1px solid var(--accent); padding: 6px 12px; border-radius: var(--radius-xl); font-size: 11px; font-weight: 800; cursor: pointer; width: 100%; }
        .btn-add-friend-sm:hover { background: var(--accent); color: white; }

        /* === GLOBAL HORIZONTAL BUTTON GROUP === */
        .btn-group-horizontal {
            display: flex;
            gap: var(--spacing-sm);
            width: 100%;
            justify-content: center;
            flex-wrap: wrap;
        }
        .btn-group-horizontal > * {
            flex: 1;
            min-width: 0;
            white-space: nowrap;
        }

        /* === PROFILE BUTTON GROUP === */
        .profile-btn-group {
            display: flex;
            gap: var(--spacing-sm);
            width: 100%;
            max-width: 360px;
            margin-bottom: var(--spacing-md);
            justify-content: center;
            flex-wrap: wrap;
        }
        .profile-btn-group .profile-action-btn,
        .profile-btn-group .btn-unfriend-modern {
            flex: 1;
            min-width: 0;
            max-width: none;
            width: auto;
            margin-bottom: 0;
            padding: var(--spacing-sm) 16px;
            font-size: 12px;
            white-space: nowrap;
        }

        /* MOBILE SPECIFIC OPTIMIZATIONS */
        @media (max-width: 480px) {
            /* === POST CREATOR MOBILE === */
            .post-creator-modern {
                border-radius: 16px;
                margin-bottom: 16px;
            }
            
            .post-creator-header {
                padding: 16px 16px 0 16px;
                gap: 12px;
            }
            
            .post-creator-avatar {
                width: 40px;
                height: 40px;
                border-width: 2px;
            }
            
            .post-input-modern {
                font-size: 15px;
                min-height: 60px;
            }
            
            .image-preview-container {
                margin: 12px 16px;
                border-radius: 12px;
            }
            
            .image-preview-container img {
                max-height: 300px;
            }
            
            .btn-remove-img {
                width: 32px;
                height: 32px;
                top: 10px;
                right: 10px;
            }
            .btn-remove-img i {
                width: 16px;
                height: 16px;
            }
            
            .post-tools {
                padding: 12px 16px 16px 16px;
                flex-wrap: nowrap;
                gap: 8px;
                align-items: center;
            }
            
            .post-actions-left {
                gap: 6px;
                flex-shrink: 1;
            }
            
            .tool-btn {
                width: 36px;
                height: 36px;
                padding: 6px;
                flex-shrink: 0;
            }
            .tool-btn i {
                width: 20px;
                height: 20px;
            }
            
            .btn-post-modern {
                padding: 9px 20px;
                font-size: 14px;
                border-radius: 20px;
                min-width: 75px;
                flex-shrink: 0;
                white-space: nowrap;
            }
            
            /* === POST CARD MOBILE === */
            .post-card {
                border-radius: 16px;
                margin-bottom: 16px;
            }
            
            .post-header {
                padding: 14px 16px;
                gap: 10px;
            }
            
            .post-avatar {
                width: 40px;
                height: 40px;
                border-width: 2px;
            }
            
            .post-author {
                font-size: 14px;
                gap: 5px;
            }
            
            .add-friend-icon-btn {
                width: 22px;
                height: 22px;
                border-width: 1.5px;
            }
            .add-friend-icon-btn i {
                width: 12px;
                height: 12px;
            }
            
            .verified-badge i {
                width: 9px !important;
                height: 9px !important;
            }
            
            .post-time {
                font-size: 11px;
                gap: 4px;
                margin-top: 2px;
            }
            
            .visibility-badge i {
                width: 10px;
                height: 10px;
            }
            
            .mood-display {
                font-size: 10px;
                padding: 2px 8px;
                border-radius: 10px;
                margin-top: 3px;
            }
            
            .post-content {
                padding: 0 16px 14px 16px;
                font-size: 14px;
                line-height: 1.5;
                word-break: break-word;
                overflow-wrap: break-word;
            }
            
            .post-image-container {
                max-height: 350px;
            }
            
            .post-image {
                max-height: 350px;
            }
            
            /* === REACTION SUMMARY MOBILE === */
            .reaction-summary-bar {
                padding: 8px 16px;
                font-size: 11px;
            }
            
            .reaction-emojis-group span {
                font-size: 14px;
                width: 20px;
                height: 20px;
                margin-left: -5px;
                border-width: 1.5px;
            }
            .reaction-emojis-group span:first-child {
                margin-left: 0;
            }
            
            .reaction-count-text {
                margin-left: 6px;
                font-size: 11px;
            }
            
            .comment-count-text {
                font-size: 11px;
            }
            
            /* === POST ACTIONS MOBILE === */
            .post-actions {
                padding: 4px 6px;
            }
            
            .action-btn {
                padding: 8px 10px;
                font-size: 12px;
                gap: 6px;
                border-radius: 6px;
                margin: 0 1px;
            }
            
            .action-btn i {
                width: 13px !important;
                height: 13px !important;
            }
            
            .reaction-popup {
                bottom: 45px;
                gap: 8px;
                padding: 8px 12px;
            }
            
            .reaction-emoji {
                font-size: 22px;
                width: 36px;
                height: 36px;
            }
            
            .post-overflow-btn {
                padding: 6px;
            }
            .post-overflow-btn i {
                width: 16px !important;
                height: 16px !important;
            }
            
            /* === SHARED POSTS MOBILE === */
            .shared-post-container {
                margin: 0 16px 14px 16px;
                padding: 12px;
                font-size: 12px;
            }
            
            .shared-post-container img {
                width: 28px !important;
                height: 28px !important;
            }
            
            .shared-post-container .post-image {
                max-height: 250px;
            }
            
            /* === PROFILE & OTHER ELEMENTS === */
            .profile-avatar-container .avatar-frame { width: 100px !important; height: 100px !important; }
            .profile-page-name { font-size: 24px; }
            .profile-cover { height: 22vh; min-height: 160px; }
            .profile-info-section { margin-top: -50px; }
            .profile-stats-card { padding: var(--spacing-sm) 10px; }
            .stat-val { font-size: 18px; }
            .stat-lbl { font-size: 10px; }
            .profile-action-btn, .btn-unfriend-modern { 
                max-width: 100%; 
                padding: var(--spacing-sm) 24px; 
                font-size: 13px;
            }
            .profile-btn-group { max-width: 100%; }
            .profile-btn-group .profile-action-btn,
            .profile-btn-group .btn-unfriend-modern {
                padding: var(--spacing-sm) 12px;
                font-size: 11px;
            }
            .app-logo-lg { font-size: 40px; }
            .modal-content { max-height: 85vh; width: 95%; }
            .container { padding-bottom: 70px; }
            
            /* === STORE MOBILE === */
            .store-header {
                padding: 16px;
            }
            
            .store-header-top {
                margin-bottom: 12px;
            }
            
            .store-back-btn {
                width: 36px;
                height: 36px;
            }
            .store-back-btn i {
                width: 18px;
                height: 18px;
            }
            
            .store-title-section h3 {
                font-size: 20px;
            }
            
            .store-title-section p {
                font-size: 11px;
            }
            
            .store-nav {
                gap: 6px;
                padding: 5px;
            }
            
            .store-tab-btn {
                padding: 10px;
                font-size: 11px;
            }
            
            .store-body {
                padding: 16px;
            }
            
            .reward-item {
                padding: 14px;
            }
            
            .reward-icon-box {
                width: 40px;
                height: 40px;
            }
            
            .reward-info b {
                font-size: 14px;
            }
            
            .reward-info small {
                font-size: 11px;
            }
            
            .btn-redeem {
                padding: 10px 16px;
                font-size: 12px;
            }
        }
        
        /* === EXTRA SMALL MOBILE (iPhone SE, etc) === */
        @media (max-width: 375px) {
            .post-creator-header {
                padding: 14px 14px 0 14px;
            }
            
            .post-creator-avatar {
                width: 38px;
                height: 38px;
                min-width: 38px;
                min-height: 38px;
            }
            
            .post-input-modern {
                font-size: 14px;
            }
            
            .post-tools {
                padding: 10px 14px 14px 14px;
            }
            
            .tool-btn {
                min-width: 36px;
                min-height: 36px;
            }
            
            .btn-post-modern {
                padding: 8px 18px;
                font-size: 13px;
                min-width: 70px;
                min-height: 36px;
            }
            
            .post-header {
                padding: 12px 14px;
            }
            
            .post-avatar {
                width: 38px;
                height: 38px;
                min-width: 38px;
                min-height: 38px;
            }
            
            .post-author {
                font-size: 13px;
            }
            
            .add-friend-icon-btn {
                min-width: 22px;
                min-height: 22px;
            }
            
            .post-time {
                font-size: 10px;
            }
            
            .post-content {
                padding: 0 14px 12px 14px;
                font-size: 13px;
            }
            
            .reaction-summary-bar {
                padding: 7px 14px;
                min-height: 36px;
            }
            
            .reaction-emojis-group span {
                font-size: 13px;
                width: 18px;
                height: 18px;
                min-width: 18px;
                min-height: 18px;
                margin-left: -4px;
            }
            
            .reaction-count-text,
            .comment-count-text {
                font-size: 10px;
            }
            
            .action-btn {
                padding: 7px 8px;
                font-size: 11px;
                gap: 5px;
                min-height: 36px;
            }
            
            .action-btn i {
                width: 12px !important;
                height: 12px !important;
            }
            
            .post-overflow-btn {
                min-width: 32px;
                min-height: 32px;
            }
            
            /* === SHARED POSTS EXTRA SMALL === */
            .shared-post-container {
                margin: 0 14px 12px 14px;
                padding: 10px;
                font-size: 11px;
            }
            
            .shared-post-container img {
                width: 26px !important;
                height: 26px !important;
            }
            
            /* === STORE EXTRA SMALL === */
            .store-header {
                padding: 14px;
            }
            
            .store-back-btn {
                width: 34px;
                height: 34px;
            }
            .store-back-btn i {
                width: 16px;
                height: 16px;
            }
            
            .store-title-section h3 {
                font-size: 18px;
            }
            
            .store-body {
                padding: 14px;
            }
        }
        
        /* === MOBILE TOUCH IMPROVEMENTS === */
        @media (hover: none) and (pointer: coarse) {
            /* Ensure all interactive elements are touch-friendly */
            .tool-btn,
            .action-btn,
            .add-friend-icon-btn,
            .post-overflow-btn,
            .btn-post-modern {
                cursor: pointer;
                -webkit-user-select: none;
                user-select: none;
            }
            
            /* Smoother tap feedback */
            .tool-btn:active,
            .action-btn:active,
            .add-friend-icon-btn:active {
                transform: scale(0.92);
                transition: transform 0.1s ease;
            }
            
            /* Better visibility for reactions on touch */
            .reaction-popup {
                padding: 10px 14px;
                gap: 10px;
            }
            
            .reaction-emoji {
                min-width: 40px;
                min-height: 40px;
            }
        }
        
        /* === LANDSCAPE MOBILE === */
        @media (max-width: 812px) and (orientation: landscape) {
            .post-creator-modern,
            .post-card {
                margin-bottom: 12px;
            }
            
            .post-creator-header,
            .post-header {
                padding-top: 12px;
                padding-bottom: 8px;
            }
            
            .image-preview-container img,
            .post-image {
                max-height: 200px;
            }
        }
        
        <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-9712694598388252"
     crossorigin="anonymous"></script>
        
    </style>
</head>
<body>

<div class="bottom-nav">
    <button class="nav-item active" onclick="switchTab('home')" id="nav-home">
        <i data-lucide="home" class="nav-icon"></i>
        <span class="nav-label">Home</span>
    </button>
    <button class="nav-item" onclick="switchTab('bingo')" id="nav-bingo">
        <i data-lucide="play-circle" class="nav-icon"></i>
        <span class="nav-label">Bingo</span>
    </button>
    <button class="nav-item" onclick="switchTab('beats')" id="nav-beats">
        <i data-lucide="clapperboard" class="nav-icon"></i>
        <span class="nav-label">Beats</span>
    </button>
    <button class="nav-item" onclick="document.getElementById('storeModal').style.display='flex'; setTimeout(() => lucide.createIcons(), 50);" id="nav-store">
        <i data-lucide="shopping-bag" class="nav-icon"></i>
        <span class="nav-label">Store</span>
    </button>
    <button class="nav-item" onclick="openMyProfile()" id="nav-profile">
        <i data-lucide="user" class="nav-icon"></i>
        <span class="nav-label">Me</span>
    </button>
</div>
<div id="customPopupBanner">
    <div style="position:relative; max-width:400px; width:100%; animation: popScale 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);">
        <button onclick="closeCustomBanner()" style="position:absolute; top:-15px; right:-10px; background:linear-gradient(135deg, #ef4444, #b91c1c); color:white; border:2px solid white; border-radius:50%; width:36px; height:36px; font-weight:bold; cursor:pointer; z-index:10; display:flex; align-items:center; justify-content:center; box-shadow:0 4px 10px rgba(0,0,0,0.3);"><i data-lucide="x" style="width:20px"></i></button>
        <img id="customBannerImg" src="" style="width:100%; border-radius: var(--radius-xl); border:2px solid rgba(255,255,255,0.2); box-shadow:0 20px 50px rgba(0,0,0,0.8); cursor:pointer; object-fit:cover;" onclick="clickCustomBanner()">
    </div>
</div>

<div id="installGate">
    <div class="gate-logo">RB<span>LIVE</span></div>
    <div class="gate-title">Install to Play</div>
    <p class="gate-desc">To access the full Radio Bingo experience, you must install the official App.</p>
    <button id="gateInstallBtn" class="gate-btn-install" onclick="triggerInstall()">
        <i data-lucide="download-cloud" style="width:20px; height:20px;"></i> INSTALL APP
    </button>
    <div id="gateIosNote" class="gate-ios-note">
        <div style="font-weight:800; color:white; margin-bottom: var(--spacing-sm); text-transform:uppercase;">iOS Instructions:</div>
        <div class="ios-step"><i data-lucide="share" class="ios-icon" style="width:16px;"></i> 1. Tap the Share button below.</div>
        <div class="ios-step"><i data-lucide="plus-square" class="ios-icon" style="width:16px;"></i> 2. Scroll down & tap 'Add to Home Screen'.</div>
        <div class="ios-step"><i data-lucide="check" class="ios-icon" style="width:16px;"></i> 3. Launch App from Home Screen.</div>
    </div>
</div>

<div id="notifBlocker">
    <div class="notif-gate-icon">
        <i data-lucide="bell-ring" style="width: 40px; height: 40px; color: #3b82f6;"></i>
    </div>
    <div class="notif-gate-title">ENABLE NOTIFICATIONS</div>
    <p class="notif-gate-desc">To ensure fairness and real-time updates for Bingo Calls, this app requires push notifications to be enabled.</p>
    <button onclick="requestGatePermission()" class="btn-allow-notif">
        <i data-lucide="check-circle" style="width:20px"></i> ALLOW NOTIFICATIONS
    </button>
    <div id="blockedHelp" class="blocked-help">
        <strong style="color:var(--danger); display:block; margin-bottom:5px;">⚠️ NOTIFICATIONS ARE BLOCKED!</strong>
        1. Click the <b>Lock Icon 🔒</b> or <b>Settings Icon</b> beside the URL bar.<br>
        2. Click <b>Permissions</b> or <b>Site Settings</b>.<br>
        3. Find <b>Notifications</b> and set to <b>Allow</b>.<br>
        4. Reload this page.
    </div>
</div>

<div id="splash-screen">
    <div class="splash-logo">RB<span>LIVE</span></div>
    <div class="splash-tagline">Social Ecosystem</div>
    <div class="splash-loader">
        <div class="splash-dot"></div>
        <div class="splash-dot"></div>
        <div class="splash-dot"></div>
    </div>
</div>

<div id="customToast">
    <i data-lucide="info" class="toast-icon"></i>
    <span class="toast-msg" id="toastMsg">Notification!</span>
</div>

<div id="customConfirmModal">
    <div class="conf-content">
        <i data-lucide="alert-circle" style="width: 40px; height: 40px; color: var(--gold); margin-bottom: var(--spacing-md);"></i>
        <h3 class="conf-title" id="confTitle">Confirm Action</h3>
        <p class="conf-msg" id="confMsg">Are you sure you want to proceed?</p>
        
        <!-- Optional textarea for verification reason -->
        <div id="confTextareaContainer" style="display: none; width: 100%;">
            <textarea id="confTextarea" class="conf-textarea" placeholder="Explain why you want a verification badge (e.g., active community member, content creator, streamer, etc.)"></textarea>
            <div style="font-size: 11px; color: #94a3b8; margin-top: 8px; text-align: left;">
                <i data-lucide="info" style="width: 12px; height: 12px; display: inline;"></i>
                This helps admins review your request.
            </div>
        </div>
        
        <div class="conf-actions">
            <button class="btn-conf-no" onclick="closeCustomConfirm()">CANCEL</button>
            <button class="btn-conf-yes" id="confYesBtn">CONFIRM</button>
        </div>
    </div>
</div>

<div id="loginOverlay">
    <div class="login-bg-blob blob-1"></div>
    <div class="login-bg-blob blob-2"></div>
    <div class="login-app-container">
        <div class="app-logo-lg">RB<span>LIVE</span></div>
        <p class="app-tagline">The ultimate live bingo experience.<br>Play, Win, and Redeem Rewards.</p>
        <div class="promo-badge">
            <i data-lucide="gift" style="width:16px"></i> 
            <span>Register now & Get 500 Free RB Coins</span>
        </div>
        <div class="auth-btn-group">
            <button class="btn-main-auth" onclick="login()">
                <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/action/google.svg" alt="Google" style="width:20px">
                Sign in with Google
            </button>
        </div>
    </div>
    <div class="login-footer-legal">
        <div class="legal-text">
            <span>⚠️ DISCLAIMER: NOT A GAMBLING SITE</span>
            <span style="opacity: 0.6; font-size: 9px;">For entertainment purposes only. No real money betting.</span>
            <div style="margin-top: 5px; opacity: 0.8; font-size: 10px;">
                <a href="terms.html" style="color:#cbd5e1; text-decoration:none; margin:0 5px;">Terms</a> |
                <a href="privacy.html" style="color:#cbd5e1; text-decoration:none; margin:0 5px;">Privacy</a>
            </div>
        </div>
    </div>
</div>

<div class="nav">
    <div style="display:flex; align-items:center; gap: var(--spacing-sm);">
        <span style="font-weight: 900; font-size: 20px; text-shadow: 0 2px 5px rgba(0,0,0,0.8);">RB <span style="color:var(--accent-glow)">LIVE</span></span>
    </div>
    <div id="userPanel" style="display:none; align-items: center; gap: var(--spacing-sm);">
        <div class="user-stats">
            <div class="icon-btn" onclick="openSearch()">
                <i data-lucide="search" style="width:20px"></i>
            </div>
            <div class="icon-btn" onclick="openMessenger()">
                <i data-lucide="message-circle" style="width:20px"></i>
                <span id="pmBadge" class="notif-badge"></span>
            </div>
            <div class="icon-btn" onclick="openNotifs()">
                <i data-lucide="bell" style="width:20px"></i>
                <span id="notifDot" class="notif-badge"></span>
            </div>
        </div>
        <div id="userImgContainer" onclick="openMenuModal()"></div>
    </div>
</div>

<div class="container">
    <div class="ad-container-global">
        <script type="text/javascript">
            atOptions = { 'key' : '9bf585b6ee39cb9b515e2fae1fa958c2', 'format' : 'iframe', 'height' : 50, 'width' : 320, 'params' : {} };
        </script>
        <script type="text/javascript" src="https://pl28660488.effectivegatecpm.com/9b/f5/85/9bf585b6ee39cb9b515e2fae1fa958c2.js"></script>
    </div>

    <div id="view-home" style="display:block;">
        <div id="friendRequestsSection"></div>
        
        <div class="post-creator-modern" id="mainPostCreator">
            <!-- Header with Avatar and Input -->
            <div class="post-creator-header">
                <img id="postCreatorAvatar" class="post-creator-avatar" src="https://via.placeholder.com/48" alt="Your avatar" onclick="openUserProfile(userData?.uid || '')">
                <div class="post-input-wrapper">
                    <textarea id="postInput" class="post-input-modern" placeholder="What's on your mind?" rows="1"></textarea>
                </div>
            </div>
            
            <!-- Expandable Body (shows when focused) -->
            <div class="post-creator-body">
                <div class="image-preview-container" id="imgPreviewCont">
                    <img id="postImgPreview" class="image-preview-img">
                    <div class="btn-remove-img" onclick="removePostImage()"><i data-lucide="x"></i></div>
                </div>
                
                <div class="image-preview-container" id="videoPreviewCont" style="display:none;">
                    <video id="postVideoPreview" class="image-preview-img" controls style="width:100%; max-height:300px;"></video>
                    <div class="btn-remove-img" onclick="removePostVideo()"><i data-lucide="x"></i></div>
                </div>

                <div class="mood-selector">
                    <div class="mood-chip" onclick="selectMood(this, 'Happy')">😊 Happy</div>
                    <div class="mood-chip" onclick="selectMood(this, 'Sad')">😔 Sad</div>
                    <div class="mood-chip" onclick="selectMood(this, 'Excited')">🤩 Excited</div>
                    <div class="mood-chip" onclick="selectMood(this, 'Cool')">😎 Cool</div>
                    <div class="mood-chip" onclick="selectMood(this, 'Angry')">😡 Angry</div>
                    <div class="mood-chip" onclick="selectMood(this, 'Lucky')">🍀 Lucky</div>
                </div>

                <div class="post-tools">
                    <div class="post-actions-left">
                        <label for="postImgInput" class="tool-btn photo-tool">
                            <i data-lucide="image"></i>
                            <span>Photo</span>
                        </label>
                        <input type="file" id="postImgInput" accept="image/*" style="display:none" onchange="handlePostImage(this)">
                        
                        <label for="postVideoInput" class="tool-btn">
                            <i data-lucide="video"></i>
                            <span>Video</span>
                        </label>
                        <input type="file" id="postVideoInput" accept="video/*" style="display:none" onchange="handlePostVideo(this)">
                        
                        <button class="tool-btn" id="visibilityBtn" onclick="toggleVisibility()" title="Post visibility">
                            <i data-lucide="globe" id="visibilityIcon"></i>
                        </button>
                        <input type="hidden" id="postVisibility" value="public">
                    </div>
                    
                    <button class="btn-post-modern" onclick="createPost()">
                        <span>Post</span>
                    </button>
                </div>
            </div>
        </div>

        <div id="pymkSection" class="pymk-section" style="display:none;">
            <div class="pymk-title">People You May Know</div>
            <div class="pymk-scroll" id="pymkList"></div>
        </div>

        <div class="feed-sort-modern">
            <button class="sort-btn active" id="sort-hype" onclick="toggleFeedSort('hype')" style="font-size:11px; padding:6px 12px;">
                <i data-lucide="flame" style="width:12px"></i> HOT
            </button>
            <button class="sort-btn" id="sort-new" onclick="toggleFeedSort('new')" style="font-size:11px; padding:6px 12px;">
                <i data-lucide="clock" style="width:12px"></i> NEW
            </button>
        </div>

        <div id="socialFeed" class="social-feed-container">
            <div style="text-align:center; padding: var(--spacing-lg); opacity:0.5;">Loading Feed...</div>
        </div>
    </div>

    <div id="view-bingo" style="display:none;">
        <div class="video-feed-wrapper">
            <div class="video-container">
                <div class="video-overlay-bl"><i data-lucide="users" style="width:14px"></i><span id="onlineCount">0</span> ONLINE</div>
                <div id="videoOfflineState" style="display:none; position:absolute; inset:0; background:#0f172a; flex-direction:column; align-items:center; justify-content:center; z-index:20;">
                    <div style="width:60px; height:60px; background:rgba(255,255,255,0.05); border-radius:50%; display:flex; align-items:center; justify-content:center; margin-bottom: var(--spacing-md); animation:pulse-ring 2s infinite;">
                        <i data-lucide="radio" style="width:30px; height:30px; color:#94a3b8;"></i>
                    </div>
                    <h3 style="margin:0; font-size:16px; font-weight:900; color:white; letter-spacing:1px;">WAITING FOR LIVE</h3>
                    <p style="margin:5px 0 0; font-size:12px; color:#64748b;">Stand by for the next draw.</p>
                </div>
                <iframe id="liveVideoFrame" width="100%" height="100%" src="https://www.youtube.com/embed/4I_NSJTbdXo?autoplay=1&mute=1" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" referrerpolicy="strict-origin-when-cross-origin" allowfullscreen style="border:none; position:absolute; top:0; left:0; width:100%; height:100%;"></iframe>
            </div>
        </div>

        <div id="jackpotBanner">
            <div class="jp-label-new">
                <i data-lucide="crown" style="width: 16px;"></i> JACKPOT ROUND <i data-lucide="crown" style="width: 16px;"></i>
            </div>
            <span class="jackpot-amount" id="jackpotDisplayVal">5,000</span>
            <div style="font-size: 10px; opacity: 0.7; margin-top: 5px; color: #fbbf24;">RB COINS GRAND PRIZE</div>
        </div>

        <div id="nextDrawBanner" class="next-draw-container">
            <div class="nd-icon"><i data-lucide="calendar-days"></i></div>
            <div class="nd-info">
                <div class="next-draw-label">Susunod na Bola</div>
                <div id="nextDrawTime" class="next-draw-time">--:-- --</div>
            </div>
        </div>
        
        <div id="winnerBanner">
            <span><i data-lucide="party-popper" style="width:24px; height:24px;"></i> BINGO WINNER!</span>
            <span class="winner-line" id="winnerPatternLine">Pattern: Normal Bingo</span>
        </div>

        <div class="draw-panel">
            <div class="prev-balls" id="ballRow"></div>
            <div class="current-ball-box"><span style="font-size:9px; font-weight:800; opacity:0.8; color:white;">NOW DRAWN</span><span id="currentBall" style="font-size:36px; font-weight:900; color:white; text-shadow:0 2px 10px rgba(0,0,0,0.5);">--</span></div>
        </div>
        
        <div class="card" id="bingoCardContainer">
            <div id="lateOverlay" class="late-overlay">
                <i data-lucide="lock" style="color:var(--danger); width:48px; height:48px; margin-bottom: var(--spacing-md); filter: drop-shadow(0 0 10px var(--danger));"></i>
                <div class="late-text">GAME ONGOING</div>
                <div class="late-subtext">Sorry, ongoing na ang bola. Bawal na sumali ang late.</div>
                <div style="margin-top: var(--spacing-lg); background:rgba(255,255,255,0.1); padding: var(--spacing-sm) 20px; border-radius: var(--radius-md); border:1px solid rgba(255,255,255,0.1);">
                    <span style="font-size:10px; display:block; opacity:0.7;">NEXT GAME:</span>
                    <strong id="lateNextSched" style="font-size:16px; color:var(--gold);">--:--</strong>
                </div>
            </div>
            <div id="gameOverOverlay" class="game-over-overlay">
                <i data-lucide="trophy" style="color:var(--gold); width:50px; height:50px; margin-bottom: var(--spacing-md); filter: drop-shadow(0 0 15px var(--gold));"></i>
                <div class="late-text">Game Finished</div>
                <div class="late-subtext" id="gameOverMsg">Better luck next time!</div>
            </div>
            <div class="change-card-wrapper" style="display:flex; justify-content:space-between; align-items:center; padding-bottom:15px;">
                <div class="pattern-box">
                    <div class="pattern-dot"></div>
                    <span class="pattern-text" id="patternName">Normal Bingo</span>
                </div>
                <button class="btn-change" id="newCardBtn" onclick="generateNewCard()"><i data-lucide="refresh-cw" style="width:14px"></i> NEW CARD</button>
            </div>
            <div class="bingo-header"><div class="letter">B</div><div class="letter">I</div><div class="letter">N</div><div class="letter">G</div><div class="letter">O</div></div>
            <div class="grid" id="bingoGrid"></div>
        </div>
        
        <div class="chat-box" style="margin-top:15px;">
            <div class="chat-header">
                <i data-lucide="message-square" style="width:18px; color:var(--accent-glow)"></i>
                <h3>LIVE STREAM CHAT</h3>
            </div>
            <div id="chatList"></div>
            <div id="replyIndicator" class="reply-indicator" style="display:none; padding: 5px 15px; background: #374151; color: #d1d5db; font-size: 11px;">
                <span id="replyText">Replying to...</span>
                <button onclick="cancelReply()" style="background:none; border:none; color:white; cursor:pointer;"><i data-lucide="x" style="width:14px"></i></button>
            </div>
            <div class="chat-input-area">
                <form class="input-wrapper" onsubmit="event.preventDefault(); sendChat();">
                    <input type="text" id="chatIn" placeholder="Say something..." autocomplete="off">
                    <button type="submit" class="send-btn">
                        <i data-lucide="send" style="width:16px"></i>
                    </button>
                </form>
            </div>
        </div>
    </div>

    <div id="view-beats" style="display:none;">
        <div class="beats-header">
            <div class="beats-logo">BEATS</div>
            <button class="beats-search-btn"><i data-lucide="search" style="width:18px;"></i></button>
        </div>

        <div id="beatsContainer">
            <div class="beats-placeholder">
                <i data-lucide="video" style="width:60px; height:60px; color:rgba(255,255,255,0.3);"></i>
                <h3 style="font-size:18px; margin:10px 0;">Loading Beats...</h3>
                <p style="font-size:13px; opacity:0.6;">Sandali lang...</p>
            </div>
        </div>
    </div>
</div>

<!-- Beats Comment Modal -->
<div id="beatsCommentBackdrop" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.7); z-index:9999; backdrop-filter:blur(5px);" onclick="closeBeatsComments()"></div>

<div id="beatsCommentModal">
    <div class="beats-comment-header">
        <h3>Comments</h3>
        <button class="beats-comment-close" onclick="closeBeatsComments()">
            <i data-lucide="x" style="width:18px;"></i>
        </button>
    </div>
    
    <div class="beats-comment-list" id="beatsCommentList">
        <div class="beats-comment-empty">
            <i data-lucide="message-circle" style="width:40px; height:40px; margin-bottom:10px;"></i>
            <p>No comments yet. Be the first!</p>
        </div>
    </div>
    
    <div class="beats-comment-input-area">
        <form class="beats-comment-input-wrapper" onsubmit="event.preventDefault(); sendBeatsComment();">
            <input 
                type="text" 
                id="beatsCommentInput" 
                class="beats-comment-input" 
                placeholder="Add a comment..."
                autocomplete="off"
            >
            <button type="submit" class="beats-comment-send">
                <i data-lucide="send" style="width:18px;"></i>
            </button>
        </form>
    </div>
</div>

<div id="grandJackpotModal" onclick="this.style.display='none'">
    <div class="jackpot-rays"></div>
    <div class="jackpot-content">
        <div class="icon-glow"><i data-lucide="crown" style="width: 80px; height: 80px;"></i></div>
        <h1 class="jp-title">JACKPOT WIN!</h1>
        <h2 class="jp-amount" id="grandPrizeAmount">10,000 RB COINS</h2>
        <div class="jp-name" id="jpWinnerName">WINNER NAME</div>
        <p style="font-size: 11px; color: white; opacity: 0.7; margin-top: var(--spacing-lg);">Tap anywhere to close</p>
    </div>
</div>

<div id="pmModal" class="pm-modal">
    <div class="pm-container">
        <div id="pmInboxView" style="display:flex; flex-direction:column; height:100%;">
            <div class="pm-header">
                <div style="display:flex; align-items:center; gap: var(--spacing-sm); flex:1;">
                    <h3>Chats</h3>
                    <button class="group-create-btn" onclick="startCreateGroup()"><i data-lucide="users" style="width:14px"></i> Group</button>
                </div>
                <div style="display:flex; gap: var(--spacing-sm);">
                    <button onclick="document.getElementById('pmModal').style.display='none'" style="background:rgba(255,255,255,0.1); border:none; width:30px; height:30px; border-radius:50%; color:white; display:flex; align-items:center; justify-content:center;"><i data-lucide="x" style="width:16px;"></i></button>
                </div>
            </div>
            <div class="active-friends-bar" id="activeFriendsBar"></div>
            <div id="pmList" class="pm-inbox-list"></div>
        </div>
        
        <div id="pmChatView" class="pm-chat-view">
            <div class="pm-chat-header">
                <button onclick="backToInbox()" style="background:none; border:none; color:var(--messenger-blue);"><i data-lucide="arrow-left"></i></button>
                <div style="display:flex; align-items:center; flex:1;">
                     <div id="chatTargetAvatarCont" style="width:36px; height:36px; margin-left:5px;"></div>
                     <div style="display:flex; flex-direction:column; margin-left:10px;">
                        <span id="chatTargetName" style="font-weight:700; font-size:15px; color:white;">User</span>
                        <span id="chatTargetStatus" style="font-size:11px; color:#b0b3b8;">Active now</span>
                     </div>
                </div>
                <button onclick="deleteConversation()" style="background:none; border:none; color:var(--danger); margin-left:auto;"><i data-lucide="trash-2"></i></button>
            </div>
            <div id="pmMessages" class="pm-messages"></div>
            
            <div class="pm-footer-modern">
                <label for="pmImgInput" class="pm-attach-btn">
                    <i data-lucide="image" style="width:24px;"></i>
                </label>
                <input type="file" id="pmImgInput" accept="image/*" style="display:none" onchange="handlePmImage(this)">
                
                <form onsubmit="event.preventDefault(); sendPrivateMessage();" style="flex:1; display:flex; gap: var(--spacing-sm);">
                    <input type="text" id="pmInput" class="pm-styled-input" placeholder="Type a message..." autocomplete="off">
                    <button type="submit" style="background:none; border:none; color:var(--messenger-blue); cursor:pointer;"><i data-lucide="send" style="width:24px"></i></button>
                </form>
            </div>
            <div id="pmImgPreviewCont" style="padding: var(--spacing-sm); background:#0f172a; display:none;">
                <span style="font-size:10px; color:var(--accent-glow);">Image attached</span>
            </div>
        </div>

        <div id="pmCreateGroupView" style="display:none; flex-direction:column; height:100%; background:#000;">
            <div class="pm-header">
                <button onclick="cancelCreateGroup()" style="background:none; border:none; color:white;"><i data-lucide="arrow-left"></i></button>
                <h3>New Group</h3>
                <button onclick="finalizeCreateGroup()" style="color:var(--accent); background:none; border:none; font-weight:800;">CREATE</button>
            </div>
            <div style="padding: var(--spacing-lg);">
                <input type="text" id="newGroupName" class="styled-input" placeholder="Group Name">
                <h4 style="color:#94a3b8; margin-top: var(--spacing-lg); font-size:12px; text-transform:uppercase;">Select Friends</h4>
                <div id="friendSelectContainer" style="margin-top:10px;"></div>
            </div>
        </div>
    </div>
</div>
    <div id="notifModal" class="modal" onclick="this.style.display='none'">
    <div class="modal-content" onclick="event.stopPropagation()">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom: var(--spacing-lg); border-bottom:1px solid rgba(255,255,255,0.1); padding-bottom:15px;">
            <div style="display:flex; align-items:center; gap: var(--spacing-sm);">
                <div style="background:rgba(255,255,255,0.1); padding:8px; border-radius: var(--radius-sm);"><i data-lucide="bell" style="width:20px;"></i></div>
                <h3 style="margin:0; font-size:18px;">Notifications</h3>
            </div>
            <button onclick="document.getElementById('notifModal').style.display='none'" style="background:none; border:none; color:white;"><i data-lucide="x"></i></button>
        </div>
        <div id="notifList"></div>
    </div>
</div>

<div id="userOptionsModal" class="modal" onclick="this.style.display='none'">
    <div class="modal-content" onclick="event.stopPropagation()" style="text-align:center;">
        <div id="optUserAvatarCont" style="display:flex; justify-content:center; margin-bottom: var(--spacing-sm);"></div>
        <h3 id="optUserName" style="margin:0 0 20px 0; color:white;">User</h3>
        
        <button class="user-opt-btn" onclick="openUserProfile(targetUserForOpt.uid)"><i data-lucide="user"></i> View Profile</button>
        <button class="user-opt-btn" onclick="optAddFriend()"><i data-lucide="user-plus"></i> Add Friend</button>
        <button class="user-opt-btn" onclick="optSendMessage()"><i data-lucide="message-circle"></i> Send Message</button>
        <button class="user-opt-btn" onclick="document.getElementById('userOptionsModal').style.display='none'"><i data-lucide="x"></i> Close</button>
    </div>
</div>

<div id="commentModalBackdrop" class="comment-modal-backdrop" onclick="closeComments()"></div>
<div id="commentModal" class="comment-modal">
    <div class="comment-header">
        <h3 style="margin:0; font-size:16px;">Comments</h3>
        <button onclick="closeComments()" style="background:none; border:none; color:white;"><i data-lucide="x"></i></button>
    </div>
    <div id="commentList" class="comment-list"></div>
    <form class="comment-input-area" onsubmit="event.preventDefault(); sendComment();">
        <div id="commentPreviewBox" class="comment-preview-box">
            <div class="comment-preview-label">Preview</div>
            <div class="comment-preview-content">
                <img id="commentPreviewAvatar" class="comment-preview-avatar" src="https://via.placeholder.com/40" alt="Your avatar">
                <div class="comment-preview-bubble">
                    <div id="commentPreviewText" class="comment-preview-text"></div>
                </div>
            </div>
        </div>
        <div class="comment-input-row">
            <input type="text" id="commentInput" class="comment-input" placeholder="Write a comment..." autocomplete="off" oninput="updateCommentPreview()">
            <button type="submit" style="background:none; border:none; color:var(--accent);"><i data-lucide="send"></i></button>
        </div>
    </form>
</div>

<div id="shareModalBackdrop" class="share-modal-backdrop" onclick="closeShareModal()"></div>
<div id="shareModal" class="share-modal">
    <div class="share-header">
        <h3 style="margin:0; font-size:16px;">Share Post</h3>
        <button onclick="closeShareModal()" style="background:none; border:none; color:white;"><i data-lucide="x"></i></button>
    </div>
    <div class="share-content">
        <div class="share-post-preview" id="sharePreview"></div>
        <textarea id="shareCaption" placeholder="Add a caption (optional)..." style="width:100%; min-height:60px; background:rgba(255,255,255,0.05); border:1px solid rgba(255,255,255,0.1); border-radius:10px; color:white; padding:10px; margin-bottom:10px; resize:vertical; font-family:'Inter',sans-serif;"></textarea>
        <button class="share-btn-option" onclick="shareToOwnProfile()">
            <i data-lucide="user" style="width:20px;"></i>
            <span>Share to My Profile</span>
        </button>
        <button class="share-btn-option" id="nativeShareBtn" onclick="shareViaWebShare()">
            <i data-lucide="share-2" style="width:20px;"></i>
            <span>Share via...</span>
        </button>
        <button class="share-btn-option" id="copyLinkBtn" onclick="copyPostLink()" style="display:none;">
            <i data-lucide="link" style="width:20px;"></i>
            <span>Copy Link</span>
        </button>
    </div>
</div>

<!-- PYMK Profile Preview Modal -->
<div id="pymkPreviewBackdrop" style="position:fixed; inset:0; background:rgba(0,0,0,0.8); z-index:9998; display:none; backdrop-filter:blur(4px);" onclick="closePYMKPreview()"></div>
<div id="pymkPreviewModal" style="position:fixed; top:50%; left:50%; transform:translate(-50%,-50%); width:90%; max-width:400px; background:linear-gradient(145deg,rgba(30,41,59,0.98),rgba(22,27,34,0.98)); border-radius:20px; border:1px solid rgba(255,255,255,0.1); z-index:9999; display:none; overflow:hidden; box-shadow:0 20px 60px rgba(0,0,0,0.6);">
    <div style="padding:24px; text-align:center;">
        <button onclick="closePYMKPreview()" style="position:absolute; top:12px; right:12px; background:rgba(255,255,255,0.1); border:none; width:32px; height:32px; border-radius:50%; color:white; display:flex; align-items:center; justify-content:center; cursor:pointer;">
            <i data-lucide="x" style="width:16px;"></i>
        </button>
        <div id="pymkPreviewContent"></div>
    </div>
</div>

<div id="reactionViewerBackdrop" class="reaction-viewer-backdrop" onclick="closeReactionViewer()"></div>
<div id="reactionViewerModal" class="reaction-viewer-modal">
    <div class="reaction-viewer-header">
        <h3 style="margin:0; font-size:16px;">Reactions</h3>
        <button onclick="closeReactionViewer()" style="background:none; border:none; color:white;" aria-label="Close reactions"><i data-lucide="x"></i></button>
    </div>
    <div id="reactionViewerList" class="reaction-viewer-list"></div>
</div>

<div id="searchModal" class="search-modal-container">
    <div class="search-header">
        <button onclick="document.getElementById('searchModal').style.display='none'" style="background:none; border:none; color:white;"><i data-lucide="arrow-left"></i></button>
        <div class="search-bar-wrap">
            <i data-lucide="search" style="width:16px; opacity:0.5;"></i>
            <input type="text" id="searchInput" class="search-input" placeholder="Search users or posts..." onkeyup="handleSearch()">
        </div>
    </div>
    <div id="searchResults" class="search-results">
        <div style="text-align:center; opacity:0.5; padding: var(--spacing-lg);">Type to search...</div>
    </div>
</div>

<div id="userProfilePage" class="profile-page-container">
    <button class="profile-nav-back" onclick="closeProfilePage()">
        <i data-lucide="arrow-left"></i>
    </button>
    
    <!-- 3-Dot Menu Button (Only shown for own profile) -->
    <button id="profileMenuBtn" class="profile-menu-btn" style="display:none;" onclick="toggleProfileMenu(event)">
        <i data-lucide="more-vertical"></i>
    </button>
    
    <!-- Dropdown Menu -->
    <div id="profileDropdown" class="profile-dropdown">
        <div class="dropdown-item" onclick="requestVerificationBadge()">
            <i data-lucide="shield-check"></i>
            <span>Request Verification Badge</span>
        </div>
        <div class="dropdown-item" onclick="openSettings()">
            <i data-lucide="settings"></i>
            <span>Settings</span>
        </div>
    </div>
    
    <div class="profile-cover" id="pageProfileCover"></div>
    
    <div class="profile-info-section">
        <div class="profile-avatar-container" id="pageProfileAvatarContainer">
             </div>
        
        <h2 id="pageProfileName" class="profile-page-name">User Name</h2>
        <p id="pageProfileBio" class="profile-page-bio">Radio Bingo Player</p>
        
        <div class="profile-btn-group">
            <button id="profileMainActionBtn" class="profile-action-btn" onclick="handleProfileMainAction()">Add Friend</button>
            
            <button id="giftSkinBtn" class="profile-action-btn" style="display:none; background:linear-gradient(135deg, #f59e0b, #d97706); border:none; box-shadow: 0 4px 20px rgba(245, 158, 11, 0.4); color: white;">
                <i data-lucide="gift" style="width:16px"></i> Gift Skin
            </button>
            
            <button id="unfriendBtn" class="btn-unfriend-modern" style="display:none;" onclick="unfriendUser()">
                <i data-lucide="user-x" style="width:16px"></i> Unfriend
            </button>
        </div>
        
        <div class="profile-stats-card">
            <div class="stat-item">
                <span class="stat-val" id="statFriends">0</span>
                <span class="stat-lbl"><i data-lucide="users" style="width:12px; vertical-align:middle;"></i> Friends</span>
            </div>
            <div class="stat-item">
                <span class="stat-val" id="statLikes">0</span>
                <span class="stat-lbl"><i data-lucide="heart" style="width:12px; vertical-align:middle;"></i> Likes</span>
            </div>
             <div class="stat-item">
                <span class="stat-val" id="statPosts">0</span>
                <span class="stat-lbl"><i data-lucide="image" style="width:12px; vertical-align:middle;"></i> Posts</span>
            </div>
        </div>
        
        <div id="pageProfileFeed" class="profile-feed-section"></div>
    </div>
</div>

<div id="editProfileModal" class="modal" onclick="this.style.display='none'">
    <div class="modal-content" onclick="event.stopPropagation()">
        <h3 style="margin-top:0; color:white;">Edit Profile</h3>
        
        <label class="edit-label">Display Name</label>
        <input type="text" id="editNameIn" class="edit-input" placeholder="Your Name">
        
        <label class="edit-label">Bio</label>
        <input type="text" id="editBioIn" class="edit-input" placeholder="Short bio...">
        
        <label class="edit-label">Change Profile Picture</label>
        <input type="file" id="editProfilePicInput" class="edit-input" accept="image/*" onchange="handleProfileUpload(this, 'pfp')">
        
        <label class="edit-label">Change Cover Photo</label>
        <input type="file" id="editCoverPicInput" class="edit-input" accept="image/*" onchange="handleProfileUpload(this, 'cover')">

        <button onclick="saveProfileChanges()" style="width:100%; padding: var(--spacing-md); background:var(--accent); border:none; border-radius: var(--radius-md); font-weight:900; color:white; cursor:pointer;">SAVE CHANGES</button>
    </div>
</div>

<div id="giftSkinModal" class="modal" onclick="this.style.display='none'">
    <div class="modal-content" onclick="event.stopPropagation()">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom: var(--spacing-md); border-bottom: 1px solid rgba(255,255,255,0.05); padding-bottom: 15px;">
            <div>
                <h3 style="margin:0; font-size: 18px; font-weight: 900;" id="giftModalTitle">Gift a Skin</h3>
                <p style="margin: 5px 0 0 0; font-size: 11px; opacity: 0.8; font-weight: 600;">Select a skin to gift</p>
            </div>
            <button onclick="document.getElementById('giftSkinModal').style.display='none'" style="background:none; border:none; color:white; cursor:pointer;"><i data-lucide="x"></i></button>
        </div>
        <div id="giftableSkinsList" class="skins-grid">
            <!-- Dynamically populated -->
        </div>
    </div>
</div>

<div id="installGuideModal" class="modal" onclick="this.style.display='none'">
    <div class="modal-content" onclick="event.stopPropagation()">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom: var(--spacing-md);">
            <h3 style="margin:0; font-size:18px; font-weight:900;">INSTALL GUIDE</h3>
            <button onclick="document.getElementById('installGuideModal').style.display='none'" style="background:none; border:none; color:white;"><i data-lucide="x"></i></button>
        </div>
        <div class="install-tabs">
            <button class="install-tab-btn active" id="tabAndroid" onclick="showGuide('android')">ANDROID</button>
            <button class="install-tab-btn" id="tabIOS" onclick="showGuide('ios')">iOS</button>
        </div>
        <div id="guideAndroidContent">
            <div class="guide-step"><div class="step-num">1</div><div class="step-text">Pindutin ang <b>Three Dots (⋮)</b> sa upper right corner ng Google Chrome browser.</div></div>
            <div class="guide-step"><div class="step-num">2</div><div class="step-text">Hanapin at pindutin ang <b>"Install App"</b> o <b>"Add to Home Screen"</b>.</div></div>
            <div class="guide-step"><div class="step-num">3</div><div class="step-text">Click <b>Install</b> para mapunta ito sa iyong home screen.</div></div>
        </div>
        <div id="guideIOSContent" style="display:none;">
            <div class="guide-step"><div class="step-num">1</div><div class="step-text">Gamitin ang <b>Safari Browser</b> at pindutin ang <b>Share Icon</b> <i data-lucide="share" style="width:12px"></i> sa ibaba.</div></div>
            <div class="guide-step"><div class="step-num">2</div><div class="step-text">Mag-scroll pababa at hanapin ang <b>"Add to Home Screen"</b> <i data-lucide="plus-square" style="width:12px"></i>.</div></div>
            <div class="guide-step"><div class="step-num">3</div><div class="step-text">Click <b>Add</b> sa upper right corner.</div></div>
        </div>
    </div>
</div>

<div id="menuModal" class="modal" onclick="this.style.display='none'">
    <div class="modal-content" onclick="event.stopPropagation()">
        <div class="profile-header">
            <div id="menuAvatarContainer"></div>
            <div class="profile-name-info">
                <h2 class="profile-name" id="profileNameDisplay">User Name</h2>
                <span class="profile-uid" id="profileUidDisplay">UID: ---</span>
            </div>
            <button onclick="document.getElementById('menuModal').style.display='none'" style="background:none; border:none; color:white; opacity:0.5;"><i data-lucide="x"></i></button>
        </div>
        <div class="gcash-section">
            <span style="font-size:10px; font-weight:800; color:var(--accent-glow); text-transform:uppercase; margin-bottom: var(--spacing-sm); display:flex; align-items:center; gap:5px;"><i data-lucide="credit-card" style="width:12px"></i> Email / Redemption Info</span>
            <div style="display:flex; gap: var(--spacing-sm);">
                <input type="text" id="gcashInput" class="styled-input" placeholder="Enter email or details">
                <button onclick="saveGcash(); playSound('click');" style="background:var(--accent); border:none; color:white; padding:0 20px; border-radius: var(--radius-md); font-weight:800; font-size:12px; cursor:pointer; box-shadow:0 4px 10px rgba(59, 130, 246, 0.3);">SAVE</button>
            </div>
        </div>
        <div class="ref-container">
            <span style="font-size:10px; font-weight:800; color:var(--success); text-transform:uppercase; margin-bottom: var(--spacing-sm); display:flex; align-items:center; gap:5px;"><i data-lucide="share-2" style="width:12px"></i> Invite & Earn</span>
            <input type="text" id="refLink" readonly class="styled-input" style="background:rgba(0,0,0,0.2); text-align:center; cursor:pointer; margin-bottom: var(--spacing-sm);" onclick="this.select(); document.execCommand('copy'); showToast('Copied Link!'); playSound('click');">
            <div id="referralInputSection">
                <span style="font-size:10px; font-weight:800; color:var(--gold); text-transform:uppercase; margin-bottom: var(--spacing-sm); display:flex; align-items:center; gap:5px; margin-top:15px;"><i data-lucide="ticket" style="width:12px"></i> Claim Referral Code</span>
                <div style="display:flex; gap: var(--spacing-sm);">
                    <input type="text" id="referralInput" class="styled-input" placeholder="ENTER CODE">
                    <button onclick="claimReferral(); playSound('click');" style="background:var(--gold); border:none; color:black; padding:0 20px; border-radius: var(--radius-md); font-weight:800; font-size:12px; cursor:pointer; box-shadow:0 4px 10px rgba(251, 191, 36, 0.3);">CLAIM</button>
                </div>
            </div>
        </div>
        <div class="history-box">
            <span style="font-size:10px; font-weight:800; color:white; text-transform:uppercase; margin-bottom: var(--spacing-sm); display:flex; align-items:center; gap:5px;"><i data-lucide="history" style="width:12px"></i> Transaction History</span>
            <div id="historyList" class="history-list"></div>
        </div>
        
        <div style="margin-top:15px; border-top:1px solid rgba(255,255,255,0.1); padding-top:10px;">
            <button onclick="openSupportModal(); playSound('click');" style="display:flex; align-items:center; gap: var(--spacing-xs); color:#94a3b8; font-size:12px; padding:8px 0; text-decoration:none; background:none; border:none; cursor:pointer; width:100%; text-align:left;">
                <i data-lucide="message-square" style="width:14px;"></i>
                Contact Support
            </button>
            <a href="about.html" style="display:block; color:#94a3b8; font-size:12px; padding:8px 0; text-decoration:none;">About Us</a>
            <a href="privacy.html" style="display:block; color:#94a3b8; font-size:12px; padding:8px 0; text-decoration:none;">Privacy Policy</a>
            <a href="terms.html" style="display:block; color:#94a3b8; font-size:12px; padding:8px 0; text-decoration:none;">Terms of Service</a>
        </div>

        <button onclick="auth.signOut().then(()=>location.reload())" style="width:100%; padding:14px; background:rgba(239, 68, 68, 0.1); color:var(--danger); border:1px solid rgba(239, 68, 68, 0.2); border-radius:14px; font-weight:800; margin-top: var(--spacing-lg); cursor:pointer; display:flex; align-items:center; justify-content:center; gap: var(--spacing-xs);">
            <i data-lucide="log-out" style="width:18px"></i> Sign Out
        </button>
    </div>
</div>

<div id="storeModal" class="modal">
    <div class="modal-content" onclick="event.stopPropagation()">
        <!-- Store Header (Fixed) -->
        <div class="store-header">
            <div class="store-header-top">
                <button class="store-back-btn" onclick="document.getElementById('storeModal').style.display='none'" aria-label="Close store">
                    <i data-lucide="x"></i>
                </button>
                <div class="store-title-section">
                    <h3>MARKETPLACE</h3>
                    <p>Redeem, Shop Skins, or Earn</p>
                </div>
                <div class="points-badge" style="height:35px; border-radius: var(--radius-sm);"><i data-lucide="coins" style="width:14px"></i> <span id="storePoints">0</span></div>
            </div>
            <div class="store-nav">
                <button class="store-tab-btn active" onclick="switchStoreTab('cashout')" id="tabBtnCash">Cash Out</button>
                <button class="store-tab-btn" onclick="switchStoreTab('skins')" id="tabBtnSkins">Skins</button>
                <button class="store-tab-btn" onclick="switchStoreTab('earn')" id="tabBtnEarn" style="color:var(--gold);">Tasks</button>
            </div>
        </div>
        
        <!-- Store Body (Scrollable) -->
        <div class="store-body">
            <div class="glass-panel" style="padding: var(--spacing-md); border-radius: var(--radius-lg); margin-bottom: var(--spacing-lg); border: 1px dashed var(--gold); text-align: center; position: relative; overflow: hidden;">
                <h4 style="margin: 0 0 10px 0; color: var(--gold); font-size: 14px; text-transform: uppercase;">⚡ FREE RB COINS ⚡</h4>
                <div id="adTimerOverlay" style="display: none; position: absolute; inset: 0; background: rgba(15, 23, 42, 0.98); z-index: 50; align-items: center; justify-content: center; flex-direction: column;">
                    <div id="adStatusIcon" style="font-size: 30px; margin-bottom: var(--spacing-sm);">📺</div>
                    <div style="font-size: 18px; font-weight: 900; color: white;" id="adCountdown">30s</div>
                    <div style="font-size: 12px; color: #ef4444; padding: 0 20px; margin-top: 5px; font-weight:800;" id="adStatusText">Do not close app or switch tabs!</div>
                </div>
                <div id="adCaptchaOverlay" style="display: none; position: absolute; inset: 0; background: rgba(15, 23, 42, 0.98); z-index: 51; align-items: center; justify-content: center; flex-direction: column;">
                    <div style="font-size: 14px; font-weight: 700; color: var(--accent-glow); margin-bottom: var(--spacing-sm);">HUMAN VERIFICATION</div>
                    <div style="background: rgba(255,255,255,0.1); padding: var(--spacing-sm); border-radius: var(--radius-md); margin-bottom: var(--spacing-sm);">
                        <span id="mathQ" style="font-size: 20px; font-weight: 900; color: white;">5 + 3 = ?</span>
                    </div>
                    <div style="display: flex; gap: 5px;">
                        <input type="number" id="mathAns" style="width: 60px; padding: 8px; border-radius: var(--radius-sm); border: 1px solid var(--accent); background: #0f172a; color: white; text-align: center; font-weight: 800;">
                        <button onclick="verifyAdMath()" style="background: var(--success); border: none; padding: 8px 12px; border-radius: var(--radius-sm); color: white; font-weight: 900;">OK</button>
                    </div>
                </div>
                <button id="btnWatchAd" onclick="startStrictWatch()" style="background: linear-gradient(135deg, #f59e0b, #b45309); width: 100%; border: none; padding: var(--spacing-md); border-radius: var(--radius-md); font-weight: 900; color: white; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: var(--spacing-sm); font-size: 14px; box-shadow: 0 5px 15px rgba(245, 158, 11, 0.4); text-shadow: 0 1px 2px black;">
                    <i data-lucide="play-circle" style="width: 20px;"></i> WATCH AD (+50 Coins)
                </button>
                <p style="font-size: 10px; opacity: 0.6; margin-top: 8px; color:var(--danger);">*Timer pauses if you leave the app!</p>
            </div>

            <div id="storeSection-cashout" style="display:block;">
                <div class="reward-grid">
                    <div class="reward-item">
                        <div class="reward-main"><div class="reward-icon-box"><i data-lucide="gift" style="width:22px"></i></div><div class="reward-info"><b>₱20 Gift Card</b><small><i data-lucide="database" style="width:10px"></i> 50,000 Coins</small></div></div>
                        <button class="btn-redeem" onclick="redeemItem('₱20 Gift Card', 50000)">Redeem</button>
                    </div>
                    <div class="reward-item">
                        <div class="reward-main"><div class="reward-icon-box" style="color:var(--gold); background:rgba(251, 191, 36, 0.1); border-color:rgba(251, 191, 36, 0.3);"><i data-lucide="gift" style="width:22px"></i></div><div class="reward-info"><b>₱50 Gift Card</b><small><i data-lucide="database" style="width:10px"></i> 125,000 Coins</small></div></div>
                        <button class="btn-redeem" onclick="redeemItem('₱50 Gift Card', 125000)">Redeem</button>
                    </div>
                    <div class="reward-item">
                        <div class="reward-main"><div class="reward-icon-box" style="color:var(--success); background:rgba(16, 185, 129, 0.1); border-color:rgba(16, 185, 129, 0.3);"><i data-lucide="gift" style="width:22px"></i></div><div class="reward-info"><b>₱100 Gift Card</b><small><i data-lucide="database" style="width:10px"></i> 250,000 Coins</small></div></div>
                        <button class="btn-redeem" onclick="redeemItem('₱100 Gift Card', 250000)">Redeem</button>
                    </div>
                </div>
                <p style="text-align: center; font-size: 10px; opacity: 0.6; margin-top: 25px; line-height: 1.5; text-shadow:0 1px 2px black;">*Processing may take 24-48 hours.<br>Make sure your redemption details are correct.</p>
            </div>

            <div id="storeSection-skins" style="display:none;">
                <p style="font-size:11px; opacity:0.7; margin-bottom: var(--spacing-md); text-align:center;">Customize your Bingo Card. Look rich, play rich.</p>
                
                <div style="margin-bottom: var(--spacing-lg); padding: var(--spacing-md); background:rgba(255,255,255,0.05); border-radius: var(--radius-md); text-align:center;">
                    <label style="font-size:12px; font-weight:700; display:block; margin-bottom: var(--spacing-sm); color:var(--accent-glow);">UPLOAD CUSTOM BACKGROUND</label>
                    <input type="file" accept="image/*" id="customSkinInput" style="display:none" onchange="handleCustomSkinUpload(this)">
                    <button onclick="document.getElementById('customSkinInput').click()" style="background:var(--accent); color:white; border:none; padding:8px 15px; border-radius: var(--radius-sm); font-weight:800; font-size:11px; cursor:pointer;">CHOOSE IMAGE</button>
                </div>

                <div class="skins-grid">
                    <div class="skin-item"><div class="skin-preview" style="background:rgba(30,41,59,0.8); border:1px solid rgba(255,255,255,0.1);">B</div><div class="skin-name">Classic</div><div class="skin-cost">Free</div><button class="btn-buy-skin equip" id="btn-skin-default" onclick="equipSkin('default')">EQUIP</button></div>
                    
                    <div class="skin-item"><div class="skin-preview" style="background:pink; border:2px solid hotpink; color:deeppink; font-family:'Comic Neue',cursive;">B</div><div class="skin-name">Hello Kitty</div><div class="skin-cost">75,000 Coins</div><button class="btn-buy-skin buy" id="btn-skin-kitty" onclick="buyOrEquipSkin('kitty', 75000)">BUY</button></div>
                    
                    <div class="skin-item"><div class="skin-preview" style="background:#0096df; border:2px solid white; color:white; border-radius:50%;">B</div><div class="skin-name">Doraemon</div><div class="skin-cost">75,000 Coins</div><button class="btn-buy-skin buy" id="btn-skin-doraemon" onclick="buyOrEquipSkin('doraemon', 75000)">BUY</button></div>
                    
                    <div class="skin-item"><div class="skin-preview" style="background:#f7f44d; border:2px dashed brown; color:brown;">B</div><div class="skin-name">SpongeBob</div><div class="skin-cost">75,000 Coins</div><button class="btn-buy-skin buy" id="btn-skin-spongebob" onclick="buyOrEquipSkin('spongebob', 75000)">BUY</button></div>
                    
                    <div class="skin-item"><div class="skin-preview" style="background:black; border:2px solid purple; color:pink;">B</div><div class="skin-name">Kuromi</div><div class="skin-cost">75,000 Coins</div><button class="btn-buy-skin buy" id="btn-skin-kuromi" onclick="buyOrEquipSkin('kuromi', 75000)">BUY</button></div>

                    <div class="skin-item"><div class="skin-preview" style="background:rgba(8,51,68,1); border:2px solid #06b6d4; color:#67e8f9; text-shadow:0 0 5px #06b6d4;">B</div><div class="skin-name">Neon City</div><div class="skin-cost">50,000 Coins</div><button class="btn-buy-skin buy" id="btn-skin-neon" onclick="buyOrEquipSkin('neon', 50000)">BUY</button></div>
                    <div class="skin-item"><div class="skin-preview" style="background:linear-gradient(135deg, #451a03, #000); border:2px solid #f59e0b; color:#fcd34d; font-family:'Times New Roman',serif;">B</div><div class="skin-name">Luxury Gold</div><div class="skin-cost">100,000 Coins</div><button class="btn-buy-skin buy" id="btn-skin-gold" onclick="buyOrEquipSkin('gold', 100000)">BUY</button></div>
                    <div class="skin-item"><div class="skin-preview" style="background:rgba(80, 7, 36, 1); border:2px solid #ec4899; color:#fbcfe8; border-radius:50%;">B</div><div class="skin-name">Kawaii Pink</div><div class="skin-cost">25,000 Coins</div><button class="btn-buy-skin buy" id="btn-skin-pink" onclick="buyOrEquipSkin('pink', 25000)">BUY</button></div>
                    
                    <div class="skin-item" id="customSkinSlot" style="display:none;"><div class="skin-preview" id="customSkinPreview" style="background-size:cover;">B</div><div class="skin-name">My Custom</div><div class="skin-cost">Owned</div><button class="btn-buy-skin equip" id="btn-skin-custom" onclick="equipSkin('custom')">EQUIP</button></div>
                </div>
            </div>
            <div id="storeSection-earn" style="display:none;">
                <p style="font-size:11px; opacity:0.7; margin-bottom: var(--spacing-md); text-align:center;">Complete tasks to earn huge coins instantly.</p>
                <div class="task-list">
                    <div class="task-item" style="border-color: #ef4444; background: linear-gradient(90deg, rgba(69,10,10,0.8), rgba(15,23,42,0.8));">
                        <div class="task-info"><h4 style="color:#fca5a5;">Watch Video Task</h4><p>Watch full video to unlock reward</p><span class="task-reward" style="background: rgba(239,68,68,0.2); border-color:#ef4444; color:#fca5a5;">+2,000 Coins</span></div>
                        <button class="btn-do-task" style="background:#ef4444;" id="btn-task-video" onclick="openVideoLocker('video')">WATCH</button>
                    </div>
                    <div class="task-item">
                        <div class="task-info"><h4>Premium Offer</h4><p>Complete simple offer to verify</p><span class="task-reward">+5,000 Coins</span></div>
                        <button class="btn-do-task" id="btn-task-premium" onclick="startTaskSafe('https://doctoredits.com/1874673', 5000, 'premium')">GO</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div id="supportModal" class="modal" onclick="this.style.display='none'">
    <div class="modal-content" onclick="event.stopPropagation()">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom: var(--spacing-md); border-bottom: 1px solid rgba(255,255,255,0.05); padding-bottom: 15px;">
            <div>
                <h3 style="margin:0; font-size: 20px; font-weight: 900;">CONTACT SUPPORT</h3>
                <p style="margin: 5px 0 0 0; font-size: 11px; opacity: 0.8; font-weight: 600;">Send a message to our team</p>
            </div>
            <button onclick="document.getElementById('supportModal').style.display='none'" style="background:none; border:none; color:white; cursor:pointer;"><i data-lucide="x"></i></button>
        </div>
        
        <label class="edit-label">Subject</label>
        <input type="text" id="supportSubject" class="edit-input" placeholder="Brief description of your issue">
        
        <label class="edit-label">Message</label>
        <textarea id="supportMessage" class="edit-input" rows="6" placeholder="Please describe your issue in detail..." style="resize:vertical;"></textarea>
        
        <button onclick="submitSupportRequest()" style="width:100%; padding: var(--spacing-md); background:var(--accent); border:none; border-radius: var(--radius-md); font-weight:900; color:white; cursor:pointer; display:flex; align-items:center; justify-content:center; gap: var(--spacing-xs);">
            <i data-lucide="send" style="width:16px;"></i>
            SEND MESSAGE
        </button>
        
        <div id="myTicketsSection" style="margin-top: var(--spacing-lg); padding-top: 20px; border-top: 1px solid rgba(255,255,255,0.1);">
            <h4 style="margin:0 0 15px 0; font-size: 14px; font-weight: 800; color: var(--accent-glow); display: flex; align-items: center; gap: var(--spacing-xs);">
                <i data-lucide="inbox" style="width:16px;"></i> MY TICKETS
            </h4>
            <div id="ticketsList" style="max-height: 200px; overflow-y: auto;"></div>
        </div>
    </div>
</div>

<div id="ticketDetailModal" class="modal" onclick="this.style.display='none'">
    <div class="modal-content" onclick="event.stopPropagation()" style="max-height: 80vh; overflow-y: auto;">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom: var(--spacing-md); border-bottom: 1px solid rgba(255,255,255,0.05); padding-bottom: 15px; position: sticky; top: 0; background: #1e293b; z-index: 10;">
            <div>
                <h3 style="margin:0; font-size: 18px; font-weight: 900;" id="ticketDetailSubject">Ticket Subject</h3>
                <p style="margin: 5px 0 0 0; font-size: 11px; opacity: 0.8; font-weight: 600;">
                    Status: <span id="ticketDetailStatus" style="color: var(--gold);">Open</span>
                </p>
            </div>
            <button onclick="closeTicketDetail()" style="background:none; border:none; color:white; cursor:pointer;"><i data-lucide="x"></i></button>
        </div>
        
        <div id="ticketRepliesContainer" style="margin-bottom: var(--spacing-md);"></div>
        
        <div style="border-top: 1px solid rgba(255,255,255,0.1); padding-top: 15px;">
            <label class="edit-label">Reply to Ticket</label>
            <textarea id="ticketReplyInput" class="edit-input" rows="4" placeholder="Type your reply here..." style="resize:vertical;"></textarea>
            <button onclick="submitTicketReply()" style="width:100%; padding: var(--spacing-sm); background:var(--accent); border:none; border-radius: var(--radius-md); font-weight:900; color:white; cursor:pointer; display:flex; align-items:center; justify-content:center; gap: var(--spacing-xs); margin-top:10px;">
                <i data-lucide="send" style="width:16px;"></i>
                SEND REPLY
            </button>
        </div>
    </div>
</div>

<div id="pwaInstallBanner">
    <div><span class="pwa-text">INSTALL APP</span><span class="pwa-sub">Download for better experience!</span></div>
    <button id="pwaBottomBtn" class="pwa-btn">INSTALL</button>
</div>

<script>
    /* ============================================
       ✅ CLOUDINARY CONFIGURED! (FREE CLOUD STORAGE)
       ============================================
       
       📸 ALL IMAGES & VIDEOS NOW UPLOAD TO CLOUDINARY!
       
       ✅ YOUR CLOUD NAME: dzifutb8l (CONFIGURED!)
       ⚠️ USING DEFAULT PRESET: ml_default
       
       STATUS:
       ✅ Cloud name: dzifutb8l - READY!
       ⚠️ Upload preset: ml_default (default) - WORKING but you can create custom one
       
       🎯 NEXT STEP (OPTIONAL):
       Create your own upload preset for better control:
       1. Go to: https://console.cloudinary.com/console/dzifutb8l/settings/upload
       2. Click "Add upload preset"
       3. Name: radiobingo_uploads
       4. Signing mode: Unsigned ⚠️
       5. Save, then update line 4948 with new preset name
       
       FOR NOW: Test with 'ml_default' - it should work!
       
       BENEFITS:
       ✅ No more base64 - smaller database
       ✅ Fast CDN delivery
       ✅ Free 25GB storage & 25GB bandwidth/month
       ✅ Automatic image optimization
       ✅ Supports images & videos
       
       ============================================ */
    
    // === NOTIFICATION BLOCKER LOGIC ===
    window.addEventListener('load', () => { setTimeout(hideSplash, 2000); checkNotifGate(); checkInstallGate(); initBannerListener(); loadSocialFeed(); loadPYMK(); loadCustomSkin(); });
    setTimeout(hideSplash, 5000);
    function hideSplash() { const ss = document.getElementById('splash-screen'); if(ss && ss.style.display !== 'none') { ss.style.opacity = '0'; setTimeout(() => ss.style.display = 'none', 800); } }
    
    function checkNotifGate() {
        const blocker = document.getElementById('notifBlocker');
        const help = document.getElementById('blockedHelp');
        if (!("Notification" in window)) { showToast("Notifications not supported on this device."); blocker.style.display = 'none'; return; }
        if (Notification.permission === "granted") { localStorage.setItem('notif_accepted', 'true'); blocker.style.display = 'none'; } else if (Notification.permission === "denied") { blocker.style.display = 'flex'; help.style.display = 'block'; } else { blocker.style.display = 'flex'; help.style.display = 'none'; }
    }
    function requestGatePermission() { Notification.requestPermission().then(permission => { if (permission === "granted") { localStorage.setItem('notif_accepted', 'true'); checkNotifGate(); requestNotifyPermission(); } else { checkNotifGate(); } }); }
    function showToast(msg) { const toast = document.getElementById('customToast'); document.getElementById('toastMsg').innerText = msg; toast.classList.add('show'); playSound('click'); setTimeout(() => { toast.classList.remove('show'); }, 3000); }

    let confirmCallback = null;
    function showCustomConfirm(title, msg, onYes, yesText = 'CONFIRM', noText = 'CANCEL', singleButton = false, showTextarea = false) { 
        document.getElementById('confTitle').innerText = title; 
        document.getElementById('confMsg').innerText = msg; 
        document.getElementById('customConfirmModal').style.display = 'flex'; 
        
        const yesBtn = document.getElementById('confYesBtn');
        const noBtn = document.querySelector('.btn-conf-no');
        const textareaContainer = document.getElementById('confTextareaContainer');
        const textarea = document.getElementById('confTextarea');
        
        yesBtn.innerText = yesText;
        noBtn.innerText = noText;
        
        // Show/hide textarea
        if (showTextarea) {
            textareaContainer.style.display = 'block';
            textarea.value = ''; // Clear previous value
        } else {
            textareaContainer.style.display = 'none';
        }
        
        // Single button mode - hide cancel and make confirm act as close
        if (singleButton) {
            noBtn.style.display = 'none';
            yesBtn.onclick = closeCustomConfirm;
        } else {
            noBtn.style.display = 'block';
            yesBtn.onclick = () => {
                if (onYes) {
                    // If textarea mode, pass the textarea value
                    if (showTextarea) {
                        const reason = textarea.value.trim();
                        if (!reason) {
                            showToast('⚠️ Please provide a reason for your verification request');
                            return;
                        }
                        onYes(reason);
                    } else {
                        onYes();
                    }
                }
                closeCustomConfirm();
            };
        }
        
        confirmCallback = onYes; 
        playSound('click');
        
        // Re-initialize lucide icons
        setTimeout(() => lucide.createIcons(), 50);
    }
    function closeCustomConfirm() { 
        document.getElementById('customConfirmModal').style.display = 'none'; 
        document.getElementById('confTextareaContainer').style.display = 'none';
        document.getElementById('confTextarea').value = '';
        confirmCallback = null; 
    }

    let notifiedFiveMins = false; let lastCheckedSchedule = null;
    function checkFiveMinuteNotification(timeInput) { if(notifiedFiveMins && lastCheckedSchedule === timeInput) return; let drawTime = isNaN(timeInput) ? 0 : parseInt(timeInput); if(drawTime > 0) { const diff = drawTime - Date.now(); const mins = Math.floor(diff / 60000); if(mins === 5) { if(Notification.permission === "granted") { new Notification("RB LIVE BINGO", { body: "Dali! 5 minutes na lang bola na! Buksan na ang app." }); } showToast("⚠️ 5 minutes na lang, bola na!"); notifiedFiveMins = true; lastCheckedSchedule = timeInput; } if(mins > 5) notifiedFiveMins = false; } }

    let deferredPrompt;
    const bottomBanner = document.getElementById('pwaInstallBanner');
    const bottomBtn = document.getElementById('pwaBottomBtn');
    
    function checkInstallGate() {
        const gate = document.getElementById('installGate');
        const isStandalone = window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone === true;
        if (isStandalone) { gate.style.display = 'none'; } else { gate.style.display = 'flex'; const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream; if(isIOS) { document.getElementById('gateInstallBtn').style.display = 'none'; document.getElementById('gateIosNote').style.display = 'block'; } }
        checkInstallState();
    }
    function checkInstallState() { if (window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone === true) { if(bottomBanner) bottomBanner.style.display = 'none'; } }
    window.addEventListener('beforeinstallprompt', (e) => { e.preventDefault(); deferredPrompt = e; if(bottomBanner && document.getElementById('installGate').style.display === 'none') { bottomBanner.style.display = 'flex'; } });
    function triggerInstall() { if (deferredPrompt) { deferredPrompt.prompt(); deferredPrompt.userChoice.then((choiceResult) => { if (choiceResult.outcome === 'accepted') { if(bottomBanner) bottomBanner.style.display = 'none'; } deferredPrompt = null; }); } else { document.getElementById('installGuideModal').style.display = 'flex'; const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream; if (isIOS) { showGuide('ios'); } else { showGuide('android'); } } if(bottomBanner) bottomBanner.style.display = 'none'; }
    function showGuide(os) { document.querySelectorAll('.install-tab-btn').forEach(b => b.classList.remove('active')); if(os === 'android') { document.getElementById('tabAndroid').classList.add('active'); document.getElementById('guideAndroidContent').style.display = 'block'; document.getElementById('guideIOSContent').style.display = 'none'; } else { document.getElementById('tabIOS').classList.add('active'); document.getElementById('guideAndroidContent').style.display = 'none'; document.getElementById('guideIOSContent').style.display = 'block'; } }
    if(bottomBtn) bottomBtn.addEventListener('click', triggerInstall);

    lucide.createIcons();
    const firebaseConfig = { apiKey: "AIzaSyDIAQXJ15atKJxu7PtcFL1W9JnO1N14pVs", authDomain: "radiobingo-9ac29.firebaseapp.com", databaseURL: "https://radiobingo-9ac29-default-rtdb.asia-southeast1.firebasedatabase.app", projectId: "radiobingo-9ac29", storageBucket: "radiobingo-9ac29.firebasestorage.app", messagingSenderId: "965903993397", appId: "1:965903993397:web:f6646fa05225f147eebf7c" };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database(); const auth = firebase.auth();
    let messaging; try { messaging = firebase.messaging(); } catch(e) { console.log("Messaging failed to init", e); }
    let userData = {}; let cardNumbers = []; let marks = [12]; let gameDrawn = []; let currentPattern = "Normal Bingo"; let lastNotifiedDraw = ""; let selectedReplyId = null;
    let currentJackpotAmount = 500; let isJackpotActive = false;
    let onlineUsers = {};
    
    // Skin Shop Data Structure
    const skinShop = {
        'kitty': { name: 'Hello Kitty', cost: 75000, preview: 'background:pink; border:2px solid hotpink; color:deeppink; font-family:\'Comic Neue\',cursive;' },
        'doraemon': { name: 'Doraemon', cost: 75000, preview: 'background:#0096df; border:2px solid white; color:white; border-radius:50%;' },
        'spongebob': { name: 'SpongeBob', cost: 75000, preview: 'background:#f7f44d; border:2px dashed brown; color:brown;' },
        'kuromi': { name: 'Kuromi', cost: 75000, preview: 'background:black; border:2px solid purple; color:pink;' },
        'neon': { name: 'Neon City', cost: 50000, preview: 'background:rgba(8,51,68,1); border:2px solid #06b6d4; color:#67e8f9; text-shadow:0 0 5px #06b6d4;' },
        'gold': { name: 'Luxury Gold', cost: 100000, preview: 'background:linear-gradient(135deg, #451a03, #000); border:2px solid #f59e0b; color:#fcd34d; font-family:\'Times New Roman\',serif;' },
        'pink': { name: 'Kawaii Pink', cost: 25000, preview: 'background:rgba(80, 7, 36, 1); border:2px solid #ec4899; color:#fbcfe8; border-radius:50%;' }
    };

    const sounds = { click: new Audio('https://cdn.pixabay.com/audio/2022/03/15/audio_2731885542.mp3'), newBall: new Audio('https://cdn.pixabay.com/audio/2022/03/10/audio_c8c8a73467.mp3'), pop: new Audio('https://cdn.freesound.org/previews/536/536108_1415754-lq.mp3'), win: new Audio('https://cdn.freesound.org/previews/270/270404_5123851-lq.mp3'), lose: new Audio('https://cdn.freesound.org/previews/76/76376_877451-lq.mp3'), spin: new Audio('https://cdn.freesound.org/previews/413/413203_5121236-lq.mp3'), cardFlip: new Audio('https://cdn.freesound.org/previews/240/240776_4107740-lq.mp3'), stop: new Audio('https://cdn.freesound.org/previews/256/256113_3263906-lq.mp3'), tumble: new Audio('https://cdn.freesound.org/previews/256/256113_3263906-lq.mp3'), drop: new Audio('https://cdn.pixabay.com/audio/2022/03/10/audio_c8c8a73467.mp3') };
    function playSound(type) { if(sounds[type]) { sounds[type].currentTime = 0; if(type === 'drop') sounds[type].volume = 0.3; else sounds[type].volume = 1.0; sounds[type].play().catch(e => console.log("Audio play error", e)); } }
    if ('serviceWorker' in navigator) { window.addEventListener('load', () => { navigator.serviceWorker.register('./sw.js').then(reg => { }).catch(err => console.log('SW Failed:', err)); }); }
    function requestNotifyPermission() { if ("Notification" in window) { Notification.requestPermission().then(permission => { if (permission === "granted" && messaging) { messaging.getToken().then((currentToken) => { if (currentToken && auth.currentUser) db.ref('users/' + auth.currentUser.uid).update({ fcmToken: currentToken }); }).catch((err) => console.log('Err token', err)); } }); } }

    function switchTab(tab) {
        document.querySelectorAll('.nav-item').forEach(b => b.classList.remove('active'));
        document.getElementById('view-home').style.display = 'none';
        document.getElementById('view-bingo').style.display = 'none';
        document.getElementById('view-beats').style.display = 'none';
        
        // Pause all beats videos when leaving beats tab
        document.querySelectorAll('.beats-video').forEach(v => v.pause());
        
        if(tab === 'home') {
            document.getElementById('view-home').style.display = 'block';
            document.getElementById('nav-home').classList.add('active');
            loadSocialFeed();
            loadPYMK();
        } else if(tab === 'bingo') {
            document.getElementById('view-bingo').style.display = 'block';
            document.getElementById('nav-bingo').classList.add('active');
        } else if(tab === 'beats') {
            document.getElementById('view-beats').style.display = 'block';
            document.getElementById('nav-beats').classList.add('active');
            initBeats();
        }
        playSound('click');
    }

    function openPostCreator() {
        switchTab('home');
        document.getElementById('postInput').focus();
    }

    // === BEATS FUNCTIONALITY ===
    let beatsLiked = {};
    let currentBeatsVideo = null;
    let beatsVideoPosts = [];

    function initBeats() {
        loadBeatsVideos();
    }

    function loadBeatsVideos() {
        const container = document.getElementById('beatsContainer');
        container.innerHTML = `
            <div class="beats-placeholder">
                <i data-lucide="video" style="width:60px; height:60px; color:rgba(255,255,255,0.3);"></i>
                <h3 style="font-size:18px; margin:10px 0;">Loading Beats...</h3>
                <p style="font-size:13px; opacity:0.6;">Sandali lang...</p>
            </div>
        `;
        setTimeout(() => lucide.createIcons(), 50);
        
        // Fetch ALL posts from Firebase and filter for videos
        db.ref('socialPosts').once('value', snapshot => {
            beatsVideoPosts = [];
            
            if(!snapshot.exists()) {
                console.log('No posts found in database');
                container.innerHTML = `
                    <div class="beats-placeholder">
                        <i data-lucide="video-off" style="width:60px; height:60px; color:rgba(255,255,255,0.3);"></i>
                        <h3 style="font-size:18px; margin:10px 0;">No Beats Yet</h3>
                        <p style="font-size:13px; opacity:0.6;">Wala pang nag-upload ng video. Be the first!</p>
                    </div>
                `;
                setTimeout(() => lucide.createIcons(), 50);
                return;
            }
            
            // Collect ALL posts that have videos
            snapshot.forEach(child => {
                const post = child.val();
                // Check if post has video URL (any field that contains video)
                if(post && (post.videoUrl || post.video)) {
                    beatsVideoPosts.push({
                        key: child.key,
                        ...post
                    });
                }
            });
            
            console.log('Found ' + beatsVideoPosts.length + ' video posts');
            
            if(beatsVideoPosts.length === 0) {
                container.innerHTML = `
                    <div class="beats-placeholder">
                        <i data-lucide="video-off" style="width:60px; height:60px; color:rgba(255,255,255,0.3);"></i>
                        <h3 style="font-size:18px; margin:10px 0;">No Beats Yet</h3>
                        <p style="font-size:13px; opacity:0.6;">Wala pang nag-upload ng video. Be the first!</p>
                    </div>
                `;
                setTimeout(() => lucide.createIcons(), 50);
                return;
            }
            
            // Sort by timestamp (newest first)
            beatsVideoPosts.sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0));
            
            // Render beats videos
            container.innerHTML = '';
            let renderedCount = 0;
            
            beatsVideoPosts.forEach((post, index) => {
                renderBeatVideo(post, index, () => {
                    renderedCount++;
                    if(renderedCount === beatsVideoPosts.length) {
                        // All videos rendered, initialize scrolling
                        setTimeout(() => {
                            initBeatsScrolling();
                            lucide.createIcons();
                        }, 100);
                    }
                });
            });
        });
    }

    function renderBeatVideo(post, index, callback) {
        const container = document.getElementById('beatsContainer');
        const videoDiv = document.createElement('div');
        videoDiv.className = 'beats-video-container';
        videoDiv.setAttribute('data-post-key', post.key);
        
        // Get the video URL (check both videoUrl and video fields)
        const videoUrl = post.videoUrl || post.video;
        
        if(!videoUrl) {
            if(callback) callback();
            return;
        }
        
        // Get user info
        db.ref('users/' + post.uid).once('value', userSnap => {
            const user = userSnap.val();
            if(!user) {
                if(callback) callback();
                return;
            }
            
            const isFollowing = userData?.following && userData.following[post.uid];
            const isOwnPost = auth.currentUser && auth.currentUser.uid === post.uid;
            
            const sanitizedName = escapeHtml(user.name || 'Anonymous');
            const sanitizedPhoto = sanitizeUrl(user.photo || 'https://via.placeholder.com/42');
            const sanitizedContent = escapeHtml(post.content || 'Watch this amazing video! 🎥');
            const sanitizedVideo = sanitizeUrl(videoUrl);
            
            // Check if verified
            const isVerified = user.verified === true;
            const verifiedBadgeHTML = isVerified ? `<span class="verified-badge inline-badge" onmouseenter="showVerificationTooltip(event)" onmouseleave="hideVerificationTooltip()" style="margin-left:4px;"><i data-lucide="check" style="width:10px; height:10px; color:white;"></i></span>` : '';
            
            videoDiv.innerHTML = `
                <video class="beats-video" loop playsinline preload="metadata">
                    <source src="${sanitizedVideo}" type="video/mp4">
                </video>
                
                <div class="beats-overlay">
                    <div class="beats-user-info">
                        <img class="beats-avatar" src="${sanitizedPhoto}" alt="${sanitizedName}" onclick="openUserProfile('${post.uid}')">
                        <div class="beats-username">@${sanitizedName}${verifiedBadgeHTML}</div>
                        ${!isOwnPost ? `<button class="beats-follow-btn ${isFollowing ? 'following' : ''}" onclick="handleBeatsFollow('${post.uid}', this)">
                            ${isFollowing ? 'Following' : 'Follow'}
                        </button>` : ''}
                    </div>
                    <div class="beats-description">${sanitizedContent}</div>
                    <div class="beats-music">
                        <i data-lucide="music" style="width:14px;"></i>
                        <span>Original Audio</span>
                    </div>
                    
                    <div class="beats-comments-preview" id="beats-preview-${index}">
                        <div class="beats-view-comments" onclick="handleBeatsComment('${post.key}')">
                            <span id="beats-comment-preview-text-${index}">Loading comments...</span>
                        </div>
                        <div id="beats-preview-list-${index}"></div>
                    </div>
                </div>

                <div class="beats-actions">
                    <div class="beats-action-btn" onclick="handleBeatsLike('${post.key}', ${index})">
                        <i data-lucide="heart" style="width:24px;" id="beats-like-${index}"></i>
                        <span class="beats-action-count" id="beats-like-count-${index}">${post.likes || 0}</span>
                    </div>
                    <div class="beats-action-btn" onclick="handleBeatsComment('${post.key}')">
                        <i data-lucide="message-circle" style="width:24px;"></i>
                        <span class="beats-action-count" id="beats-comment-count-${index}">0</span>
                    </div>
                    <div class="beats-action-btn" onclick="handleBeatsShare('${post.key}')">
                        <i data-lucide="share-2" style="width:24px;"></i>
                        <span class="beats-action-count">Share</span>
                    </div>
                </div>
            `;
            
            container.appendChild(videoDiv);
            
            // Check if user already liked this post
            if(auth.currentUser) {
                db.ref('postLikes/' + post.key + '/' + auth.currentUser.uid).once('value', likeSnap => {
                    if(likeSnap.exists()) {
                        const likeIcon = document.getElementById('beats-like-' + index);
                        if(likeIcon) {
                            likeIcon.setAttribute('fill', '#ef4444');
                            likeIcon.style.color = '#ef4444';
                            beatsLiked[post.key] = true;
                        }
                    }
                });
            }
            
            // Get comments and display preview
            db.ref('postComments/' + post.key).limitToLast(2).once('value', commSnap => {
                const commentCount = commSnap.numChildren();
                const countEl = document.getElementById('beats-comment-count-' + index);
                const previewTextEl = document.getElementById('beats-comment-preview-text-' + index);
                const previewListEl = document.getElementById('beats-preview-list-' + index);
                
                // Get total comment count
                db.ref('postComments/' + post.key).once('value', totalSnap => {
                    const totalCount = totalSnap.numChildren();
                    
                    if(countEl) countEl.textContent = totalCount;
                    
                    if(totalCount === 0) {
                        if(previewTextEl) previewTextEl.textContent = 'Be the first to comment';
                    } else if(totalCount === 1) {
                        if(previewTextEl) previewTextEl.textContent = 'View 1 comment';
                    } else {
                        if(previewTextEl) previewTextEl.textContent = `View all ${totalCount} comments`;
                    }
                    
                    // Display preview of latest comments
                    if(commSnap.exists() && previewListEl) {
                        const comments = [];
                        commSnap.forEach(child => {
                            comments.push(child.val());
                        });
                        
                        // Show up to 2 latest comments
                        comments.slice(-2).forEach(comment => {
                            db.ref('users/' + comment.uid).once('value', userSnap => {
                                const commentUser = userSnap.val();
                                if(!commentUser) return;
                                
                                const commentDiv = document.createElement('div');
                                commentDiv.className = 'beats-preview-comment';
                                commentDiv.onclick = () => handleBeatsComment(post.key);
                                
                                const sanitizedCommentName = escapeHtml(commentUser.name || 'Anonymous');
                                const sanitizedCommentText = escapeHtml(comment.text || '');
                                
                                commentDiv.innerHTML = `
                                    <span class="beats-preview-comment-author">${sanitizedCommentName}</span>
                                    <span class="beats-preview-comment-text">${sanitizedCommentText}</span>
                                `;
                                
                                previewListEl.appendChild(commentDiv);
                            });
                        });
                    }
                });
            });
            
            setTimeout(() => lucide.createIcons(), 50);
            
            if(callback) callback();
        });
    }

    function initBeatsScrolling() {
        const beatsContainer = document.getElementById('view-beats');
        const videos = beatsContainer.querySelectorAll('.beats-video');
        
        console.log('Initializing beats scrolling with ' + videos.length + ' videos');
        
        if(videos.length === 0) return;
        
        // Play first video
        currentBeatsVideo = videos[0];
        currentBeatsVideo.play().catch(e => {
            console.log('Autoplay prevented:', e);
            // Add play button overlay if autoplay fails
            showPlayButton(currentBeatsVideo);
        });

        // Handle scroll to play/pause videos
        let scrollTimeout;
        beatsContainer.addEventListener('scroll', function() {
            clearTimeout(scrollTimeout);
            
            scrollTimeout = setTimeout(() => {
                let closestVideo = null;
                let minDistance = Infinity;

                videos.forEach(video => {
                    const rect = video.getBoundingClientRect();
                    const distance = Math.abs(rect.top);
                    
                    if(distance < minDistance) {
                        minDistance = distance;
                        closestVideo = video;
                    }
                });

                videos.forEach(video => {
                    if(video === closestVideo) {
                        video.play().catch(e => {
                            showPlayButton(video);
                        });
                        currentBeatsVideo = video;
                    } else {
                        video.pause();
                    }
                });
            }, 100);
        });

        // Tap to play/pause
        videos.forEach(video => {
            video.addEventListener('click', function(e) {
                e.stopPropagation();
                if(this.paused) {
                    this.play();
                } else {
                    this.pause();
                }
            });
        });
    }

    function showPlayButton(video) {
        // Helper function to show play button if autoplay is blocked
        const container = video.parentElement;
        if(container.querySelector('.beats-play-overlay')) return;
        
        const playOverlay = document.createElement('div');
        playOverlay.className = 'beats-play-overlay';
        playOverlay.style.cssText = `
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(255,255,255,0.9);
            width: 70px;
            height: 70px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 100;
        `;
        playOverlay.innerHTML = '<i data-lucide="play" style="width:32px; height:32px; color:#000; margin-left:4px;"></i>';
        playOverlay.onclick = () => {
            video.play();
            playOverlay.remove();
        };
        container.appendChild(playOverlay);
        setTimeout(() => lucide.createIcons(), 10);
    }

    function handleBeatsLike(postKey, index) {
        if(!auth.currentUser) return showToast("Please login first");
        
        const likeIcon = document.getElementById('beats-like-' + index);
        const countEl = document.getElementById('beats-like-count-' + index);
        const isLiked = beatsLiked[postKey];
        
        const myUid = auth.currentUser.uid;
        const likeRef = db.ref('postLikes/' + postKey + '/' + myUid);
        
        if(isLiked) {
            // Unlike
            likeRef.remove();
            db.ref('socialPosts/' + postKey + '/likes').transaction(l => Math.max(0, (l || 1) - 1));
            
            likeIcon.setAttribute('fill', 'none');
            likeIcon.style.color = 'white';
            beatsLiked[postKey] = false;
            
            // Update count
            const currentCount = parseInt(countEl.textContent) || 0;
            countEl.textContent = Math.max(0, currentCount - 1);
        } else {
            // Like with animation
            likeRef.set('❤️');
            db.ref('socialPosts/' + postKey + '/likes').transaction(l => (l || 0) + 1);
            
            likeIcon.setAttribute('fill', '#ef4444');
            likeIcon.style.color = '#ef4444';
            beatsLiked[postKey] = true;
            
            // Animate heart
            likeIcon.style.transform = 'scale(1.3)';
            setTimeout(() => likeIcon.style.transform = 'scale(1)', 200);
            
            // Update count
            const currentCount = parseInt(countEl.textContent) || 0;
            countEl.textContent = currentCount + 1;
            
            playSound('like');
            
            // Send notification to post author
            const post = beatsVideoPosts.find(p => p.key === postKey);
            if(post && post.uid !== myUid && userData && userData.name) {
                db.ref('notifications/' + post.uid).push({
                    msg: `${userData.name} liked your Beat`,
                    time: Date.now(),
                    type: 'like',
                    from: myUid,
                    postId: postKey,
                    image: userData.photo || 'https://via.placeholder.com/40'
                });
            }
        }
    }

    let currentBeatsCommentPostKey = null;

    function handleBeatsComment(postKey) {
        if(!auth.currentUser) return showToast("Please login first");
        
        currentBeatsCommentPostKey = postKey;
        
        // Show modal and backdrop
        const modal = document.getElementById('beatsCommentModal');
        const backdrop = document.getElementById('beatsCommentBackdrop');
        
        backdrop.style.display = 'block';
        modal.classList.add('show');
        
        // Load comments
        loadBeatsComments(postKey);
        
        // Pause current video
        if(currentBeatsVideo) {
            currentBeatsVideo.pause();
        }
        
        setTimeout(() => lucide.createIcons(), 50);
    }

    function closeBeatsComments() {
        const modal = document.getElementById('beatsCommentModal');
        const backdrop = document.getElementById('beatsCommentBackdrop');
        
        modal.classList.remove('show');
        backdrop.style.display = 'none';
        
        // Clear input
        document.getElementById('beatsCommentInput').value = '';
        
        // Resume video
        if(currentBeatsVideo) {
            currentBeatsVideo.play().catch(e => {});
        }
    }

    function loadBeatsComments(postKey) {
        const list = document.getElementById('beatsCommentList');
        list.innerHTML = '<div class="beats-comment-empty"><div style="color:#64748b;">Loading comments...</div></div>';
        
        db.ref('postComments/' + postKey).orderByChild('time').once('value', snapshot => {
            list.innerHTML = '';
            
            if(!snapshot.exists()) {
                list.innerHTML = `
                    <div class="beats-comment-empty">
                        <i data-lucide="message-circle" style="width:40px; height:40px; margin-bottom:10px; color:#64748b;"></i>
                        <p style="color:#64748b;">No comments yet. Be the first!</p>
                    </div>
                `;
                setTimeout(() => lucide.createIcons(), 50);
                return;
            }
            
            const comments = [];
            snapshot.forEach(child => {
                comments.push({
                    key: child.key,
                    ...child.val()
                });
            });
            
            // Show newest first
            comments.reverse();
            
            comments.forEach(comment => {
                renderBeatsComment(comment);
            });
            
            setTimeout(() => lucide.createIcons(), 50);
        });
    }

    function renderBeatsComment(comment) {
        const list = document.getElementById('beatsCommentList');
        
        // Fetch user data
        db.ref('users/' + comment.uid).once('value', userSnap => {
            const user = userSnap.val();
            if(!user) return;
            
            const div = document.createElement('div');
            div.className = 'beats-comment-item';
            
            const sanitizedName = escapeHtml(user.name || 'Anonymous');
            const sanitizedPhoto = sanitizeUrl(user.photo || 'https://via.placeholder.com/36');
            const sanitizedText = escapeHtml(comment.text || '');
            const timeAgo = getTimeAgo(comment.time);
            
            // Check if verified
            const isVerified = user.verified === true;
            const verifiedBadgeHTML = isVerified ? `<span class="verified-badge inline-badge" onmouseenter="showVerificationTooltip(event)" onmouseleave="hideVerificationTooltip()" style="margin-left:4px;"><i data-lucide="check" style="width:8px; height:8px; color:white;"></i></span>` : '';
            
            div.innerHTML = `
                <img class="beats-comment-avatar" src="${sanitizedPhoto}" alt="${sanitizedName}" onclick="closeBeatsComments(); openUserProfile('${comment.uid}')">
                <div class="beats-comment-content">
                    <div class="beats-comment-author">${sanitizedName}${verifiedBadgeHTML}</div>
                    <div class="beats-comment-text">${sanitizedText}</div>
                    <div class="beats-comment-time">${timeAgo}</div>
                </div>
            `;
            
            list.appendChild(div);
            lucide.createIcons();
        });
    }

    function sendBeatsComment() {
        if(!auth.currentUser) return showToast("Please login first");
        if(!currentBeatsCommentPostKey) return;
        
        const input = document.getElementById('beatsCommentInput');
        const text = input.value.trim();
        
        if(!text) return;
        
        const myUid = auth.currentUser.uid;
        const commentData = {
            uid: myUid,
            text: text,
            time: Date.now()
        };
        
        // Save comment
        db.ref('postComments/' + currentBeatsCommentPostKey).push(commentData).then(() => {
            input.value = '';
            
            // Reload comments in modal
            loadBeatsComments(currentBeatsCommentPostKey);
            
            // Find the post and update UI
            const post = beatsVideoPosts.find(p => p.key === currentBeatsCommentPostKey);
            if(post) {
                const index = beatsVideoPosts.indexOf(post);
                
                // Update comment count
                const countEl = document.getElementById('beats-comment-count-' + index);
                if(countEl) {
                    const currentCount = parseInt(countEl.textContent) || 0;
                    countEl.textContent = currentCount + 1;
                }
                
                // Update preview text
                const previewTextEl = document.getElementById('beats-comment-preview-text-' + index);
                if(previewTextEl) {
                    const newCount = (parseInt(countEl?.textContent) || 0);
                    if(newCount === 1) {
                        previewTextEl.textContent = 'View 1 comment';
                    } else {
                        previewTextEl.textContent = `View all ${newCount} comments`;
                    }
                }
                
                // Update preview list - show latest comment
                const previewListEl = document.getElementById('beats-preview-list-' + index);
                if(previewListEl && userData) {
                    // Add new comment to preview
                    const commentDiv = document.createElement('div');
                    commentDiv.className = 'beats-preview-comment';
                    commentDiv.onclick = () => handleBeatsComment(currentBeatsCommentPostKey);
                    
                    const sanitizedName = escapeHtml(userData.name || 'You');
                    const sanitizedText = escapeHtml(text);
                    
                    commentDiv.innerHTML = `
                        <span class="beats-preview-comment-author">${sanitizedName}</span>
                        <span class="beats-preview-comment-text">${sanitizedText}</span>
                    `;
                    
                    // Keep only 2 latest
                    const existingComments = previewListEl.querySelectorAll('.beats-preview-comment');
                    if(existingComments.length >= 2) {
                        existingComments[0].remove();
                    }
                    
                    previewListEl.appendChild(commentDiv);
                }
            }
            
            // Send notification to post author
            if(post && post.uid !== myUid && userData && userData.name) {
                db.ref('notifications/' + post.uid).push({
                    msg: `${userData.name} commented on your Beat`,
                    time: Date.now(),
                    type: 'comment',
                    from: myUid,
                    postId: currentBeatsCommentPostKey,
                    image: userData.photo || 'https://via.placeholder.com/40'
                });
            }
            
            playSound('click');
            showToast('Comment posted!');
        });
    }

    function getTimeAgo(timestamp) {
        const now = Date.now();
        const diff = now - timestamp;
        const seconds = Math.floor(diff / 1000);
        const minutes = Math.floor(seconds / 60);
        const hours = Math.floor(minutes / 60);
        const days = Math.floor(hours / 24);
        
        if(days > 0) return days + 'd ago';
        if(hours > 0) return hours + 'h ago';
        if(minutes > 0) return minutes + 'm ago';
        return 'Just now';
    }

    function handleBeatsShare(postKey) {
        if(!auth.currentUser) return showToast("Please login first");
        
        const post = beatsVideoPosts.find(p => p.key === postKey);
        if(!post) return;
        
        // Copy link or share
        const shareUrl = window.location.origin + window.location.pathname + '?post=' + postKey;
        
        if(navigator.share) {
            navigator.share({
                title: 'Check out this Beat on Radio Bingo Live!',
                text: post.content || 'Amazing video!',
                url: shareUrl
            }).catch(e => console.log('Share canceled'));
        } else {
            // Fallback: copy to clipboard
            navigator.clipboard.writeText(shareUrl).then(() => {
                showToast('Link copied to clipboard!');
            }).catch(() => {
                showToast('Share URL: ' + shareUrl);
            });
        }
    }

    function handleBeatsFollow(targetUid, btn) {
        if(!auth.currentUser) return showToast("Please login first");
        
        const myUid = auth.currentUser.uid;
        if(myUid === targetUid) return;
        
        const isFollowing = btn.classList.contains('following');
        
        if(isFollowing) {
            // Unfollow
            db.ref('users/' + myUid + '/following/' + targetUid).remove();
            db.ref('users/' + targetUid + '/followers/' + myUid).remove();
            btn.classList.remove('following');
            btn.textContent = 'Follow';
            showToast('Unfollowed');
        } else {
            // Follow
            db.ref('users/' + myUid + '/following/' + targetUid).set(true);
            db.ref('users/' + targetUid + '/followers/' + myUid).set(true);
            btn.classList.add('following');
            btn.textContent = 'Following';
            showToast('Following!');
            
            // Send notification
            if(userData && userData.name) {
                db.ref('notifications/' + targetUid).push({
                    msg: `${userData.name} started following you`,
                    time: Date.now(),
                    type: 'follow',
                    from: myUid,
                    image: userData.photo || 'https://via.placeholder.com/40'
                });
            }
        }
    }
    
    // Toggle follow function for inline buttons (used in Beats marketplace)
    function toggleFollow(targetUid, btnId) {
        if(!auth.currentUser) return showToast("Please login first");
        
        const myUid = auth.currentUser.uid;
        if(myUid === targetUid) return;
        
        const btn = document.getElementById(btnId);
        if(!btn) return;
        
        const isFollowing = btn.classList.contains('following');
        
        if(isFollowing) {
            // Unfollow
            db.ref('users/' + myUid + '/following/' + targetUid).remove();
            db.ref('users/' + targetUid + '/followers/' + myUid).remove();
            btn.classList.remove('following');
            btn.textContent = 'Follow';
            showToast('Unfollowed');
        } else {
            // Follow
            db.ref('users/' + myUid + '/following/' + targetUid).set(true);
            db.ref('users/' + targetUid + '/followers/' + myUid).set(true);
            btn.classList.add('following');
            btn.textContent = 'Following';
            showToast('Following!');
            
            // Send notification
            if(userData && userData.name) {
                db.ref('notifications/' + targetUid).push({
                    msg: `${userData.name} started following you`,
                    time: Date.now(),
                    type: 'follow',
                    from: myUid,
                    image: userData.photo || 'https://via.placeholder.com/40'
                });
            }
        }
    }
            
    
    function switchStoreTab(tab) {
        document.querySelectorAll('.store-tab-btn').forEach(b => b.classList.remove('active'));
        document.getElementById('storeSection-cashout').style.display = 'none';
        document.getElementById('storeSection-skins').style.display = 'none';
        document.getElementById('storeSection-earn').style.display = 'none';
        if(tab === 'cashout') { document.getElementById('tabBtnCash').classList.add('active'); document.getElementById('storeSection-cashout').style.display = 'block'; } 
        else if(tab === 'skins') { document.getElementById('tabBtnSkins').classList.add('active'); document.getElementById('storeSection-skins').style.display = 'block'; updateSkinButtons(); } 
        else if(tab === 'earn') { document.getElementById('tabBtnEarn').classList.add('active'); document.getElementById('storeSection-earn').style.display = 'block'; }
        playSound('click');
    }

    function fixDate(timestamp) { if(!timestamp) return "Just now"; const d = new Date(parseInt(timestamp)); return d.toLocaleDateString('en-PH', { month: 'short', day: 'numeric' }) + " " + d.toLocaleTimeString('en-PH', { hour: '2-digit', minute: '2-digit' }); }
    function login() { playSound('click'); auth.signInWithPopup(new firebase.auth.GoogleAuthProvider()).then(() => { requestNotifyPermission(); checkNotifGate(); }); }

    auth.onAuthStateChanged(u => {
        if(u) {
            if(messaging) { messaging.getToken().then((token) => { if(token) db.ref('users/' + u.uid).update({ fcmToken: token }); }).catch((err)=>console.log(err)); messaging.onMessage((payload) => { const title = payload.notification ? payload.notification.title : "Notification"; const body = payload.notification ? payload.notification.body : "New message"; showToast(title + ": " + body); playSound('pop'); }); }
            document.getElementById('loginOverlay').style.display = 'none'; document.getElementById('userPanel').style.display = 'flex';
            
            document.getElementById('userImgContainer').innerHTML = renderAvatarWithBadge(sanitizeUrl(u.photoURL), 0, 45, u.uid);

            document.getElementById('profileUidDisplay').innerText = "ID: " + u.uid.substring(0,8);
            
            const userRef = db.ref('users/'+u.uid);
            userRef.once('value', snapshot => { 
                if (!snapshot.exists()) { 
                    // New User
                    const newRefCode = Math.random().toString(36).substring(2, 8).toUpperCase(); 
                    const urlParams = new URLSearchParams(window.location.search); 
                    const referredBy = urlParams.get('ref'); 
                    userRef.set({ name: u.displayName, photo: u.photoURL, points: 500, refCode: newRefCode, referredBy: referredBy || null, last_seen: Date.now(), cardTimestamp: Date.now(), lastLoginDate: new Date().toDateString(), hasWonBringMeThisRound: false, ownedSkins: ['default'], equippedSkin: 'default' }); 
                    if (referredBy) { db.ref('users').orderByChild('refCode').equalTo(referredBy).once('value', refSnap => { if (refSnap.exists()) { const referrerUid = Object.keys(refSnap.val())[0]; db.ref('users/' + referrerUid + '/points').transaction(p => (p || 0) + 1000); } }); } 
                } else { 
                    // Existing User
                    const data = snapshot.val(); 
                    const updates = { last_seen: Date.now() }; 
                    if (!data.name) updates.name = u.displayName;
                    if (!data.photo) updates.photo = u.photoURL;
                    
                    const today = new Date().toDateString(); 
                    if (data.lastLoginDate !== today) { updates.points = (data.points || 0) + 200; updates.lastLoginDate = today; showToast("🎁 Daily Bonus! +200 RB Coins."); playSound('win'); } 
                    if (!data.refCode) updates.refCode = Math.random().toString(36).substring(2, 8).toUpperCase(); 
                    if(!data.ownedSkins) updates.ownedSkins = ['default']; 
                    if(!data.equippedSkin) updates.equippedSkin = 'default'; 
                    userRef.update(updates); 
                } 
            });
            userRef.on('value', s => { 
                if(s.exists()){ 
                    userData = s.val(); userData.uid = u.uid; 
                    document.getElementById('storePoints').innerText = (userData.points || 0).toLocaleString(); 
                    document.getElementById('refLink').value = window.location.origin + window.location.pathname + "?ref=" + (userData.refCode || ""); 
                    if(userData.referredBy) document.getElementById('referralInputSection').style.display = 'none'; 
                    if(userData.gcash) document.getElementById('gcashInput').value = userData.gcash; 
                    if (userData.currentCard) { cardNumbers = userData.currentCard; renderCard(); } else { generateNewCard(); } 
                    
                    const displayName = userData.name || u.displayName;
                    const displayPhoto = userData.photo || u.photoURL;
                    
                    updatePresenceData(u.uid, displayName, userData.points, displayPhoto); checkLateJoiner();
                    applySkin(userData.equippedSkin || 'default'); updateSkinButtons();
                    
                    document.getElementById('profileNameDisplay').innerText = displayName;
                    
                    // Update Avatars with badges
                    document.getElementById('userImgContainer').innerHTML = renderAvatarWithBadge(sanitizeUrl(displayPhoto), userData.bingoWins || 0, 45, u.uid);
                    document.getElementById('menuAvatarContainer').innerHTML = renderAvatarWithBadge(sanitizeUrl(displayPhoto), userData.bingoWins || 0, 70, u.uid);
                    
                    // Update post creator avatar
                    const postCreatorAvatar = document.getElementById('postCreatorAvatar');
                    if(postCreatorAvatar) {
                        postCreatorAvatar.src = sanitizeUrl(displayPhoto);
                    }
                } 
            });
            initBingo(); setupChat(); listenForNextDraw(); setupPresence(u.uid); listenJackpot(); listenNotifications(u.uid); listenPrivateMessages(u.uid); listenVideoUpdate();
            initSocialSystem(u.uid);
            loadPYMK();
        } else { document.getElementById('loginOverlay').style.display = 'flex'; }
    });
    // === BADGE & AVATAR SYSTEM ===
    function renderAvatarWithBadge(photoUrl, wins, size, uid = null) {
        // Data attribute for online status updates - only if uid is provided
        const uidAttr = uid ? `data-uid="${uid}"` : '';
        
        // Check if user is online - only show indicator if they are active
        const isOnline = uid && onlineUsers[uid];
        const onlineClass = isOnline ? 'is-online' : '';

        setTimeout(() => lucide.createIcons(), 50);

        return `
            <div class="avatar-frame" style="width:${size}px; height:${size}px;" ${uidAttr}>
                <img src="${photoUrl}" style="width:100%; height:100%; border-radius:50%; border:2px solid var(--glass-border); object-fit:cover;">
                <div class="online-indicator ${onlineClass}"></div>
            </div>
        `;
    }
    
    function updateAllOnlineIndicators() {
        document.querySelectorAll('.avatar-frame').forEach(el => {
            const uid = el.dataset.uid;
            if(uid) {
                const dot = el.querySelector('.online-indicator');
                // Only show online indicator if user is truly online
                if(onlineUsers[uid] && onlineUsers[uid].state === 'online' && dot) {
                    dot.classList.add('is-online');
                } else if(dot) {
                    dot.classList.remove('is-online');
                }
            }
        });
    }
    
    // Helper function to format "last seen" time
    function formatLastSeen(timestamp) {
        if(!timestamp) return 'recently';
        
        const now = Date.now();
        const diffMs = now - timestamp;
        const diffMins = Math.floor(diffMs / 60000);
        const diffHours = Math.floor(diffMs / 3600000);
        const diffDays = Math.floor(diffMs / 86400000);
        
        if(diffMins < 1) return 'just now';
        if(diffMins < 60) return `${diffMins} min${diffMins > 1 ? 's' : ''}. ago`;
        if(diffHours < 24) return `${diffHours} hour${diffHours > 1 ? 's' : ''} ago`;
        if(diffDays === 1) return 'yesterday';
        if(diffDays < 7) return `${diffDays} days ago`;
        
        // Format as date for older
        const date = new Date(timestamp);
        return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
    }

    // Helper to get verification badge HTML for text
    function getBadgeHtml(wins, userData = null) {
        // Check if user is verified - this will be populated from Firebase
        if (userData && userData.verified) {
            return `<span class="verified-badge" onclick="showVerificationInfo(event)"><i data-lucide="check" style="width:10px; height:10px; color:white;"></i></span>`;
        }
        return ""; 
    }
    
    // Async version that fetches user data to check verification
    async function getVerificationBadge(uid) {
        if (!uid) return '';
        try {
            const snapshot = await firebase.database().ref(`users/${uid}`).once('value');
            const userData = snapshot.val();
            if (userData && userData.verified) {
                return `<span class="verified-badge"><i data-lucide="check" style="width:10px; height:10px; color:white;"></i></span>`;
            }
        } catch(err) {
            console.error('Error fetching verification status:', err);
        }
        return '';
    }

    // === UTILITY: TEXT SANITIZATION ===
    function escapeHtml(text) {
        if (!text) return '';
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    // === UTILITY: URL VALIDATION ===
    function sanitizeUrl(url) {
        if (!url) return 'https://via.placeholder.com/40';
        // Allow only http/https/data URLs, and Firebase storage URLs
        try {
            const urlObj = new URL(url);
            if (['http:', 'https:', 'data:'].includes(urlObj.protocol)) {
                return url;
            }
        } catch (e) {
            // Invalid URL
        }
        return 'https://via.placeholder.com/40';
    }

    // === UTILITY: IMAGE COMPRESSION ===
    function compressImage(file, maxWidth, quality) {
        return new Promise((resolve) => {
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = (event) => {
                const img = new Image();
                img.src = event.target.result;
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    let width = img.width;
                    let height = img.height;
                    if (width > maxWidth) {
                        height *= maxWidth / width;
                        width = maxWidth;
                    }
                    canvas.width = width;
                    canvas.height = height;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, width, height);
                    resolve(canvas.toDataURL('image/jpeg', quality));
                };
            };
        });
    }

    // === PYMK LOGIC ===
    function loadPYMK() {
        if(!auth.currentUser) return;
        const list = document.getElementById('pymkList');
        const container = document.getElementById('pymkSection');
        
        db.ref('users').limitToLast(20).once('value', s => {
            db.ref('friends/' + auth.currentUser.uid).once('value', fSnap => {
                const friends = fSnap.exists() ? Object.keys(fSnap.val()) : [];
                friends.push(auth.currentUser.uid); // Exclude self
                
                const candidates = [];
                s.forEach(uSnap => {
                    if(!friends.includes(uSnap.key)) {
                        candidates.push({ uid: uSnap.key, ...uSnap.val() });
                    }
                });
                
                // Shuffle and pick 5
                const shuffled = candidates.sort(() => 0.5 - Math.random()).slice(0, 5);
                
                if(shuffled.length > 0) {
                    list.innerHTML = "";
                    shuffled.forEach(u => {
                        const div = document.createElement('div');
                        div.className = 'pymk-card';
                        div.style.cursor = 'pointer';
                        
                        // Check if request already sent
                        db.ref('friendRequests/' + u.uid + '/' + auth.currentUser.uid).once('value', reqSnap => {
                            const btnHtml = reqSnap.exists() 
                                ? `<button class="btn-add-friend-sm" style="opacity:0.6;" onclick="event.stopPropagation(); cancelFriendReqPYMK('${u.uid}')">CANCEL</button>`
                                : `<button class="btn-add-friend-sm" onclick="event.stopPropagation(); sendFriendReqPYMK('${u.uid}')">ADD</button>`;
                            
                            div.innerHTML = `
                                ${renderAvatarWithBadge(u.photo || 'https://via.placeholder.com/60', u.points || 0, 50, u.uid)}
                                <div class="pymk-name" style="margin-top:5px;">${u.name}</div>
                                ${btnHtml}
                            `;
                            
                            // Add click handler for profile preview
                            div.onclick = (e) => {
                                if(!e.target.closest('button')) {
                                    showPYMKPreview(u);
                                }
                            };
                        });
                        
                        list.appendChild(div);
                    });
                    container.style.display = 'block';
                } else {
                    container.style.display = 'none';
                }
            });
        });
    }

    function sendFriendReqPYMK(uid) {
        db.ref('friendRequests/' + uid + '/' + auth.currentUser.uid).set(true);
        showToast("Request Sent!");
        loadPYMK(); 
    }
    
    function cancelFriendReqPYMK(uid) {
        db.ref('friendRequests/' + uid + '/' + auth.currentUser.uid).remove();
        showToast("Request Cancelled");
        loadPYMK();
    }
    
    // PYMK Profile Preview Functions
    function showPYMKPreview(user) {
        const modal = document.getElementById('pymkPreviewModal');
        const backdrop = document.getElementById('pymkPreviewBackdrop');
        const content = document.getElementById('pymkPreviewContent');
        
        // Check friend status
        db.ref('friends/' + auth.currentUser.uid + '/' + user.uid).once('value', fSnap => {
            db.ref('friendRequests/' + user.uid + '/' + auth.currentUser.uid).once('value', reqSnap => {
                const isFriend = fSnap.exists();
                const requestSent = reqSnap.exists();
                
                let actionBtn = '';
                if(isFriend) {
                    actionBtn = `<button onclick="openUserProfile('${user.uid}')" style="background:var(--accent); color:white; border:none; padding:12px 24px; border-radius:12px; font-weight:700; cursor:pointer; width:100%; font-size:14px; margin-top:16px;">View Profile</button>`;
                } else if(requestSent) {
                    actionBtn = `<button onclick="cancelFriendReqPYMK('${user.uid}'); closePYMKPreview();" style="background:rgba(255,255,255,0.1); color:white; border:none; padding:12px 24px; border-radius:12px; font-weight:700; cursor:pointer; width:100%; font-size:14px; margin-top:16px;">Cancel Request</button>`;
                } else {
                    actionBtn = `<button onclick="sendFriendReqPYMK('${user.uid}'); closePYMKPreview();" style="background:var(--accent); color:white; border:none; padding:12px 24px; border-radius:12px; font-weight:700; cursor:pointer; width:100%; font-size:14px; margin-top:16px;">Add Friend</button>`;
                }
                
                content.innerHTML = `
                    ${renderAvatarWithBadge(user.photo || 'https://via.placeholder.com/100', user.points || 0, 100, user.uid)}
                    <h3 style="margin:12px 0 4px; font-size:18px;">${escapeHtml(user.name)}</h3>
                    <div style="display:flex; gap:20px; justify-content:center; margin:16px 0; padding:16px; background:rgba(255,255,255,0.05); border-radius:12px;">
                        <div style="text-align:center;">
                            <div style="font-size:20px; font-weight:900; color:var(--gold);">${user.points || 0}</div>
                            <div style="font-size:10px; color:#94a3b8; text-transform:uppercase;">Points</div>
                        </div>
                        <div style="text-align:center;">
                            <div style="font-size:20px; font-weight:900; color:var(--accent);">${user.bingoWins || 0}</div>
                            <div style="font-size:10px; color:#94a3b8; text-transform:uppercase;">Wins</div>
                        </div>
                    </div>
                    ${actionBtn}
                `;
                
                modal.style.display = 'block';
                backdrop.style.display = 'block';
                setTimeout(() => lucide.createIcons(), 50);
            });
        });
    }
    
    function closePYMKPreview() {
        document.getElementById('pymkPreviewModal').style.display = 'none';
        document.getElementById('pymkPreviewBackdrop').style.display = 'none';
    }
    
    let bannerTargetUrl = "";
    function initBannerListener() { if(sessionStorage.getItem('bannerSeen')) return; db.ref('gameState/bannerSettings').once('value', s => { const d = s.val(); if(d && d.active && d.imageUrl) { document.getElementById('customBannerImg').src = d.imageUrl; bannerTargetUrl = d.targetUrl; document.getElementById('customPopupBanner').style.display = 'flex'; sessionStorage.setItem('bannerSeen', 'true'); playSound('pop'); } }); }
    function closeCustomBanner() { document.getElementById('customPopupBanner').style.display = 'none'; }
    function clickCustomBanner() { if(bannerTargetUrl) window.open(bannerTargetUrl, '_blank'); }

    // === SKIN LOGIC (UPDATED WITH CUSTOM & NEW THEMES) ===
    function applySkin(skinId) { 
        const card = document.getElementById('bingoCardContainer'); 
        card.classList.remove('card-skin-neon', 'card-skin-gold', 'card-skin-pink', 'card-skin-matrix', 'card-skin-kitty', 'card-skin-doraemon', 'card-skin-spongebob', 'card-skin-kuromi', 'card-skin-custom'); 
        card.style.backgroundImage = 'none'; // Reset Custom

        if(skinId === 'neon') card.classList.add('card-skin-neon'); 
        if(skinId === 'gold') card.classList.add('card-skin-gold'); 
        if(skinId === 'pink') card.classList.add('card-skin-pink'); 
        if(skinId === 'matrix') card.classList.add('card-skin-matrix'); 
        if(skinId === 'kitty') card.classList.add('card-skin-kitty');
        if(skinId === 'doraemon') card.classList.add('card-skin-doraemon');
        if(skinId === 'spongebob') card.classList.add('card-skin-spongebob');
        if(skinId === 'kuromi') card.classList.add('card-skin-kuromi');
        
        if(skinId === 'custom') {
            card.classList.add('card-skin-custom');
            const storedBG = localStorage.getItem('customSkinBG');
            if(storedBG) {
                card.style.backgroundImage = `url('${storedBG}')`;
            }
        }
    }

    function updateSkinButtons() { 
        if(!userData.ownedSkins) return; 
        ['default', 'neon', 'gold', 'pink', 'kitty', 'doraemon', 'spongebob', 'kuromi', 'custom'].forEach(skin => { 
            const btn = document.getElementById('btn-skin-' + skin); 
            if(!btn) return; 
            if(userData.equippedSkin === skin) { 
                btn.innerText = "EQUIPPED"; 
                btn.className = "btn-buy-skin owned"; 
                btn.onclick = null; 
            } else if(userData.ownedSkins.includes(skin)) { 
                btn.innerText = "EQUIP"; 
                btn.className = "btn-buy-skin equip"; 
                btn.onclick = () => equipSkin(skin); 
            } 
        }); 
        
        // Show custom slot if uploaded
        if(localStorage.getItem('customSkinBG')) {
            document.getElementById('customSkinSlot').style.display = 'block';
            document.getElementById('customSkinPreview').style.backgroundImage = `url('${localStorage.getItem('customSkinBG')}')`;
        }
    }

    function buyOrEquipSkin(skinId, cost) { 
        if(!userData.ownedSkins) userData.ownedSkins = ['default']; 
        if(userData.ownedSkins.includes(skinId)) { 
            equipSkin(skinId); 
        } else { 
            if(userData.points >= cost) { 
                showCustomConfirm("BUY SKIN?", "Purchase for " + cost + " Coins?", () => { 
                    deductPoints(cost); 
                    let newOwned = [...userData.ownedSkins, skinId]; 
                    db.ref('users/' + userData.uid).update({ ownedSkins: newOwned, equippedSkin: skinId }); 
                    showToast("Skin Purchased!"); 
                    playSound('win'); 
                    spawnFlyingCoins(10); 
                }); 
            } else { 
                showToast("Insufficient Coins"); 
            } 
        } 
    }

    function equipSkin(skinId) { db.ref('users/' + userData.uid).update({ equippedSkin: skinId }); showToast("Skin Equipped"); playSound('click'); }
    
    // Custom Skin Upload Logic
    function handleCustomSkinUpload(input) {
        if(input.files && input.files[0]) {
            compressImage(input.files[0], 800, 0.7).then(base64 => {
                localStorage.setItem('customSkinBG', base64);
                // Auto equip custom
                if(!userData.ownedSkins.includes('custom')) {
                     let newOwned = [...userData.ownedSkins, 'custom'];
                     db.ref('users/' + userData.uid).update({ ownedSkins: newOwned });
                }
                db.ref('users/' + userData.uid).update({ equippedSkin: 'custom' });
                showToast("Custom Background Set!");
                updateSkinButtons();
            });
        }
    }

    function loadCustomSkin() {
        // Just ensures logic is ready, actually handled in updateSkinButtons/applySkin
    }
    
    // === ANTI-CHEAT TASK LOGIC ===
    let strictTimer = null;
    let strictSeconds = 30;
    
    function startStrictWatch() {
        const adsterraLink = "https://directoryeditorweep.com/9b/f5/85/9bf585b6ee39cb9b515e2fae1fa958c2.js"; 
        window.open(adsterraLink, "_blank"); 
        
        const overlay = document.getElementById('adTimerOverlay'); 
        overlay.style.display = 'flex'; 
        
        strictSeconds = 30; // Reset time
        const cd = document.getElementById('adCountdown'); 
        const status = document.getElementById('adStatusText'); 
        const cap = document.getElementById('adCaptchaOverlay'); 
        
        cd.innerText = strictSeconds + "s";
        status.innerText = "Do not close app or switch tabs!";
        
        clearInterval(strictTimer);
        strictTimer = setInterval(() => { 
            // Anti-Cheat Check
            if(document.hidden) { 
                status.innerText = "⚠️ PAUSED! Please return to app."; 
                return; // Stop counting down
            } 
            
            strictSeconds--; 
            cd.innerText = strictSeconds + "s"; 
            status.innerText = "Watching Ad..."; 
            
            if(strictSeconds <= 0) { 
                clearInterval(strictTimer); 
                overlay.style.display = 'none'; 
                cap.style.display = 'flex'; 
                const n1 = Math.floor(Math.random()*10); 
                const n2 = Math.floor(Math.random()*10); 
                document.getElementById('mathQ').innerText = `${n1} + ${n2} = ?`; 
                document.getElementById('mathQ').dataset.ans = n1+n2; 
            } 
        }, 1000); 
    }
    
    function startTaskSafe(url, reward, taskKey) { const lastRun = localStorage.getItem('task_cooldown_' + taskKey); const cooldownTime = 12 * 60 * 60 * 1000; if(lastRun && (Date.now() - parseInt(lastRun)) < cooldownTime) { showToast("⏳ Task in cooldown. Try again later."); return; } showCustomConfirm("START TASK", "Complete offer to earn coins.", () => { window.open(url, '_blank'); const btn = document.getElementById('btn-task-' + taskKey); if(btn) { btn.disabled = true; btn.innerHTML = `<i data-lucide="loader" class="icon-spin"></i> 60s`; let timeLeft = 60; const timer = setInterval(() => { timeLeft--; btn.innerHTML = `<i data-lucide="loader" class="icon-spin"></i> ${timeLeft}s`; if(timeLeft <= 0) { clearInterval(timer); btn.innerHTML = "CLAIM REWARD"; btn.disabled = false; btn.style.background = "#22c55e"; btn.onclick = () => claimTaskReward(reward, taskKey); } }, 1000); } }); }
    function claimTaskReward(reward, taskKey) { addPoints(reward); showToast(`🎉 +${reward} Coins Received!`); playSound('win'); spawnFlyingCoins(20); const btn = document.getElementById('btn-task-' + taskKey); if(btn) { btn.innerHTML = "COMPLETED"; btn.disabled = true; btn.style.background = "#334155"; } localStorage.setItem('task_cooldown_' + taskKey, Date.now()); }
    function openVideoLocker(taskKey) { const lastRun = localStorage.getItem('task_cooldown_video'); if(lastRun && (Date.now() - parseInt(lastRun)) < 300000) { showToast("⏳ Wait before watching again."); return; } showCustomConfirm("WATCH VIDEO", "You will be redirected to the video task. Complete it to earn.", () => { localStorage.setItem('task_cooldown_video', Date.now()); const win = window.open("", "_blank"); if(win) { win.document.write(`<html><head><title>Video Task Verification</title><meta name="viewport" content="width=device-width, initial-scale=1.0"><style>body{background:#000; color:white; font-family:sans-serif; text-align:center; padding:20px; display:flex; flex-direction:column; justify-content:center; height:100vh;}</style></head><body><h2>Loading Video Task...</h2><p>Please wait while we load the verification.</p><script type="text/javascript">var lck = false;</scr`+`ipt><script type="text/javascript" src="https://doctoredits.com/script_include.php?id=1874676"></scr`+`ipt><script type="text/javascript">if(!lck){top.location = 'https://doctoredits.com/help/ablk.php?lkt=2'; }</scr`+`ipt><noscript>Please enable JavaScript to access this page.<meta http-equiv="refresh" content="0;url=https://doctoredits.com/help/enable_javascript.php?lkt=2" ></meta></noscript><button onclick="window.close()" style="margin-top:20px; padding:12px 20px; background:red; color:white; border:none; border-radius:5px;">Close & Return to Game</button></body></html>`); win.document.close(); } else { showToast("Pop-up blocked! Please allow pop-ups."); } }); }

    function setupPresence(uid) { 
        const onlineRef = db.ref('.info/connected'); 
        const userStatusRef = db.ref('status/' + uid); 
        onlineRef.on('value', (snapshot) => { 
            if (snapshot.val() === false) return; 
            // When user disconnects, update status to offline with timestamp
            userStatusRef.onDisconnect().set({ 
                state: 'offline', 
                last_seen: firebase.database.ServerValue.TIMESTAMP 
            }).then(() => { 
                // While online, set status to online
                userStatusRef.set({ 
                    state: 'online', 
                    last_seen: firebase.database.ServerValue.TIMESTAMP 
                }); 
            }); 
        }); 
        // Global Presence Listener
        db.ref('status').on('value', (s) => { 
            onlineUsers = s.val() || {};
            // Count only truly online users
            const onlineCount = Object.values(onlineUsers).filter(status => status.state === 'online').length;
            document.getElementById('onlineCount').innerText = onlineCount || 0; 
            updateAllOnlineIndicators();
        }); 
    }
    
    function updatePresenceData(uid, name, points, photo) { db.ref('status/' + uid).update({ name: name, points: points, photo: photo }); }
    
    // === UPDATED NOTIFICATION LOGIC (With Delete & Nav) ===
    function listenNotifications(uid) { 
        db.ref('notifications/' + uid).on('value', s => { 
            let unreadPMs = 0;
            let count = 0;
            s.forEach(child => {
                const val = child.val();
                if(val.type === 'pm') unreadPMs++;
                else count++;
            });
            const dot = document.getElementById('notifDot'); 
            const pmBadge = document.getElementById('pmBadge');
            if(count > 0) { dot.style.display = 'block'; } else { dot.style.display = 'none'; }
            if(unreadPMs > 0) { pmBadge.style.display = 'flex'; pmBadge.innerText = unreadPMs > 9 ? '9+' : unreadPMs; } else { pmBadge.style.display = 'none'; }
        }); 
    }
    
    function openNotifs() { document.getElementById('notifModal').style.display='flex'; playSound('click'); renderNotifs(); }
    
    function renderNotifs() { 
        const list = document.getElementById('notifList'); 
        db.ref('notifications/' + auth.currentUser.uid).once('value', s => { 
            list.innerHTML = ""; 
            const notifs = [];
            s.forEach(n => { if(n.val().type !== 'pm') notifs.push({ key: n.key, ...n.val() }); });
            
            notifs.sort((a,b) => b.time - a.time);

            if(notifs.length === 0) {
                list.innerHTML = "<div style='text-align:center; opacity:0.5; padding:40px;'>No new notifications</div>";
                return;
            }

            notifs.forEach(val => {
                const div = document.createElement('div');
                div.className = 'notif-card-grouped';
                
                let iconOrImg = `<i data-lucide="info" style="color:#64748b;"></i>`;
                if(val.image) {
                    iconOrImg = `<img src="${val.image}" class="notif-img">`;
                }
                
                div.innerHTML = `
                    ${iconOrImg}
                    <div class="notif-content-wrap">
                        <div style="font-size:13px; color:white;">${val.msg}</div>
                        <div style="font-size:10px; opacity:0.5; margin-top:5px;">${fixDate(val.time)}</div>
                    </div>
                    <button class="btn-delete-notif" onclick="deleteNotif('${val.key}', event)"><i data-lucide="x" style="width:14px;"></i></button>
                `;
                
                // Click Nav Logic
                div.onclick = (e) => {
                    if(e.target.closest('.btn-delete-notif')) return; 
                    if(val.postId) {
                        document.getElementById('notifModal').style.display='none';
                        // Switch to home and find post or open comments
                        switchTab('home');
                        const postEl = document.getElementById('post-' + val.postId);
                        if(postEl) postEl.scrollIntoView({behavior: "smooth"});
                        else openComments(val.postId);
                    }
                };
                
                list.appendChild(div);
            });
            lucide.createIcons();
        }); 
    }

    function deleteNotif(key, event) { 
        event.stopPropagation();
        db.ref('notifications/' + auth.currentUser.uid + '/' + key).remove(); 
        renderNotifs(); 
        showToast("Notification Deleted"); 
    }
    
    function listenJackpot() { db.ref('gameState/jackpot').on('value', s => { const data = s.val(); const banner = document.getElementById('jackpotBanner'); if(data && data.active) { banner.style.display = 'block'; document.getElementById('jackpotDisplayVal').innerText = data.amount + " RB COINS"; isJackpotActive = true; const rawAmount = parseInt(data.amount.replace(/[^0-9]/g, '')); currentJackpotAmount = isNaN(rawAmount) ? 500 : rawAmount; } else { banner.style.display = 'none'; isJackpotActive = false; currentJackpotAmount = 500; } }); }

    function listenVideoUpdate() { db.ref('gameState/videoSettings').on('value', s => { const v = s.val(); const iframe = document.getElementById('liveVideoFrame'); const offline = document.getElementById('videoOfflineState'); if (v && v.type === 'offline') { iframe.style.display = 'none'; iframe.src = ""; offline.style.display = 'flex'; } else if(v && v.url) { offline.style.display = 'none'; iframe.style.display = 'block'; const regExp = /^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|&v=)([^#&?]*).*/; const match = v.url.match(regExp); let videoId = (match && match[2].length === 11) ? match[2] : null; if(!videoId && v.url.length === 11) videoId = v.url; if (videoId) { const embedUrl = `https://www.youtube.com/embed/${videoId}?autoplay=1&mute=1&loop=1&playlist=${videoId}&controls=1`; if(iframe.src !== embedUrl) { iframe.src = embedUrl; } } } }); }

    function listenForForNextDraw() { db.ref('gameState/schedules').on('value', s => { updateNextDrawDisplay(); }); db.ref('gameState/nextDraw').on('value', s => { updateNextDrawDisplay(); }); }
    function listenForNextDraw() { db.ref('gameState').on('value', s => { updateNextDrawDisplay(); }); }

    function updateNextDrawDisplay() { db.ref('gameState').on('value', s => { const gameData = s.val() || {}; const now = Date.now(); if(gameData.drawnNumbers && Object.keys(gameData.drawnNumbers).length > 0) { const banner = document.getElementById('nextDrawBanner'); const timeEl = document.getElementById('nextDrawTime'); const labelEl = document.querySelector('.next-draw-label'); const ndIcon = document.querySelector('.nd-icon'); banner.style.display = 'flex'; banner.style.background = 'rgba(71, 85, 105, 0.9)'; banner.style.borderColor = '#94a3b8'; banner.style.boxShadow = '0 10px 30px rgba(0,0,0,0.5)'; labelEl.innerText = "GAME STATUS"; labelEl.style.color = "#e2e8f0"; timeEl.innerText = "GAME ONGOING"; timeEl.style.fontSize = "20px"; timeEl.style.color = "#ffffff"; timeEl.style.fontWeight = "900"; if(ndIcon) { ndIcon.style.background = 'rgba(255,255,255,0.1)'; ndIcon.style.color = 'white'; ndIcon.style.borderColor = 'rgba(255,255,255,0.2)'; } return; } let displayTime = null; if(gameData.schedules) { const rawScheds = Object.values(gameData.schedules); const times = rawScheds.map(val => (typeof val === 'object' && val.time) ? val.time : val); const futureTimes = times.filter(t => t > now); const sorted = futureTimes.sort((a,b) => a - b); if(sorted.length > 0) { displayTime = sorted[0]; } } if(!displayTime && gameData.nextDraw) { if(gameData.nextDraw > now) { displayTime = gameData.nextDraw; } } const banner = document.getElementById('nextDrawBanner'); const timeEl = document.getElementById('nextDrawTime'); const labelEl = document.querySelector('.next-draw-label'); const lateSched = document.getElementById('lateNextSched'); const ndIcon = document.querySelector('.nd-icon'); if(ndIcon) { ndIcon.style.background = ''; ndIcon.style.color = ''; ndIcon.style.borderColor = ''; } if(displayTime && displayTime > now) { banner.style.display = 'flex'; banner.style.background = 'rgba(15, 23, 42, 0.8)'; banner.style.borderColor = 'rgba(251, 191, 36, 0.4)'; banner.style.boxShadow = '0 10px 30px rgba(0,0,0,0.5)'; const formatted = fixDate(displayTime); timeEl.innerText = formatted; timeEl.style.fontSize = "18px"; timeEl.style.color = "white"; labelEl.innerText = "SUSUNOD NA BOLA"; labelEl.style.color = "var(--gold)"; lateSched.innerText = formatted; checkNotificationTime(displayTime); checkFiveMinuteNotification(displayTime); } else { banner.style.display = 'flex'; banner.style.background = 'linear-gradient(135deg, rgba(15, 23, 42, 0.9), rgba(30, 41, 59, 0.9))'; banner.style.borderColor = '#3b82f6'; banner.style.boxShadow = '0 10px 30px rgba(59, 130, 246, 0.2)'; labelEl.innerText = "WAITING FOR DRAW"; labelEl.style.color = "#93c5fd"; timeEl.innerText = "MAGHINTAY SA SUSUNOD NA DRAW."; timeEl.style.fontSize = "11px"; timeEl.style.fontWeight = "700"; timeEl.style.lineHeight = "1.4"; lateSched.innerText = "--:--"; } }); }
    function checkNotificationTime(timeInput) { if(lastNotifiedDraw == timeInput) return; let drawTime = isNaN(timeInput) ? 0 : parseInt(timeInput); if(drawTime > 0) { const diff = drawTime - Date.now(); const mins = Math.floor(diff / 60000); if(mins === 10) { if(Notification.permission === "granted") new Notification("Radio Bingo", { body: "10 mins na lang, bola na!" }); lastNotifiedDraw = timeInput; } } }

    function initBingo() {
        db.ref('gameState/latestWinner').on('value', s => { const win = s.val(); const banner = document.getElementById('winnerBanner'); const cardCont = document.getElementById('bingoCardContainer'); const gameOverlay = document.getElementById('gameOverOverlay'); cardCont.classList.remove('card-puro'); document.querySelectorAll('.cell').forEach(c => c.classList.remove('cell-waiting')); if(win && win.name) { banner.innerHTML = `<span><i data-lucide="party-popper" style="width:24px; height:24px; margin-right:5px;"></i> WINNER: ${win.name.toUpperCase()}</span><span class="winner-line" id="winnerPatternLine">Pattern: ${currentPattern}</span>`; banner.style.display = 'block'; playSound('win'); lucide.createIcons(); if(win.uid === auth.currentUser.uid) { confetti({ particleCount: 150, spread: 70, origin: { y: 0.6 } }); cardCont.classList.add('card-win'); cardCont.classList.remove('card-lost'); gameOverlay.style.display = 'none'; spawnFlyingCoins(20); triggerScreenShake(); } else { cardCont.classList.add('card-lost'); cardCont.classList.remove('card-win'); gameOverlay.style.display = 'flex'; const nextTime = document.getElementById('nextDrawTime').innerText; document.getElementById('gameOverMsg').innerHTML = `Sayang! Si <b>${win.name.toUpperCase()}</b> ang nanalo.<br><br>Bawi tayo sa next draw!<br><span style="color:var(--gold); font-weight:800; font-size:14px; margin-top:5px; display:block;">SCHEDULE: ${nextTime}</span>`; } } else { banner.style.display = 'none'; cardCont.classList.remove('card-win', 'card-lost'); gameOverlay.style.display = 'none'; document.querySelectorAll('.cell').forEach(c => { c.classList.remove('win-glow', 'win-line-h', 'win-line-v', 'win-line-d1', 'win-line-d2'); }); } });
        db.ref('gameState/currentPattern').on('value', s => { currentPattern = s.val() || "Normal Bingo"; document.getElementById('patternName').innerText = currentPattern; checkWin(); });
        db.ref('drawnNumbers').on('value', s => { const val = s.val(); const newGameDrawn = val ? Object.values(val).map(n => n.toString()) : []; if(newGameDrawn.length > 0 && gameDrawn.length > 0) { const newBalls = newGameDrawn.filter(x => !gameDrawn.includes(x)); if(newBalls.length > 0) { const latestBall = newBalls[newBalls.length - 1]; playSound('newBall'); showToast("BOLA: " + latestBall); } } gameDrawn = newGameDrawn; const btn = document.getElementById('newCardBtn'); if(gameDrawn.length > 0) { btn.disabled = true; btn.innerHTML = `<i data-lucide="lock" style="width:14px"></i> IN GAME`; } else { btn.disabled = false; btn.innerHTML = `<i data-lucide="refresh-cw" style="width:14px"></i> NEW CARD`; } lucide.createIcons(); checkLateJoiner(); updateGridHits(); renderPrevBalls(); checkWin(); checkPuroStatus(); });
        db.ref('gameState/lastCalled').on('value', s => { if(s.exists()) { const num = s.val(); document.getElementById('currentBall').innerText = num; if (num !== lastSpokenNumber) { speakNumber(num); lastSpokenNumber = num; } } else { document.getElementById('currentBall').innerText = "--"; lastSpokenNumber = null; } });
    }
    let lastSpokenNumber = null;
    function speakNumber(num) { if ('speechSynthesis' in window) { let letter = "B"; if (num > 15) letter = "I"; if (num > 30) letter = "N"; if (num > 45) letter = "G"; if (num > 60) letter = "O"; const msg = new SpeechSynthesisUtterance(`${letter} ${num}`); msg.rate = 0.9; window.speechSynthesis.speak(msg); } }

    function checkWin() { if(userData.hasWonCurrent || gameDrawn.length === 0) return; db.ref('gameState/latestWinner').once('value', snap => { if(snap.exists()) return; let winningWays = []; if (currentPattern === "Blackout") { winningWays = [Array.from({length: 25}, (_, i) => i)]; } else if (currentPattern === "Letter X") { winningWays = [[0,4,6,8,12,16,18,20,24]]; } else if (currentPattern === "Four Corners") { winningWays = [[0,4,20,24]]; } else { winningWays = [ [0,1,2,3,4],[5,6,7,8,9],[10,11,12,13,14],[15,16,17,18,19],[20,21,22,23,24], [0,5,10,15,20],[1,6,11,16,21],[2,7,12,17,22],[3,8,13,18,23],[4,9,14,19,24], [0,6,12,18,24], [4,8,12,16,20] ]; } for(let i = 0; i < winningWays.length; i++) { let w = winningWays[i]; if(w.every(idx => marks.includes(idx))) { highlightWinningPattern(w, i); triggerWin(); break; } } }); }
    function checkPuroStatus() { if(userData.hasWonCurrent || gameDrawn.length === 0) return; document.getElementById('bingoCardContainer').classList.remove('card-puro'); document.querySelectorAll('.cell').forEach(c => c.classList.remove('cell-waiting')); let winningWays = []; if (currentPattern === "Blackout") winningWays = [Array.from({length: 25}, (_, i) => i)]; else if (currentPattern === "Letter X") winningWays = [[0,4,6,8,12,16,18,20,24]]; else if (currentPattern === "Four Corners") winningWays = [[0,4,20,24]]; else winningWays = [[0,1,2,3,4],[5,6,7,8,9],[10,11,12,13,14],[15,16,17,18,19],[20,21,22,23,24],[0,5,10,15,20],[1,6,11,16,21],[2,7,12,17,22],[3,8,13,18,23],[4,9,14,19,24],[0,6,12,18,24],[4,8,12,16,20]]; for (let i = 0; i < winningWays.length; i++) { let w = winningWays[i]; let missing = w.filter(idx => !marks.includes(idx)); if (missing.length === 1) { document.getElementById('bingoCardContainer').classList.add('card-puro'); const missingIdx = missing[0]; const cells = document.querySelectorAll('.cell'); if(cells[missingIdx]) cells[missingIdx].classList.add('cell-waiting'); break; } } }
    function highlightWinningPattern(indices, patternType) { const cells = document.querySelectorAll('.cell'); indices.forEach(idx => { const cell = cells[idx]; cell.classList.add('win-glow'); if (currentPattern === 'Normal Bingo') { if (patternType < 5) cell.classList.add('win-line-h'); else if (patternType < 10) cell.classList.add('win-line-v'); else if (patternType === 10) cell.classList.add('win-line-d1'); else cell.classList.add('win-line-d2'); } }); }

    function triggerWin() { const uid = auth.currentUser.uid; let winPrize = 500; if (isJackpotActive) winPrize = currentJackpotAmount; db.ref('gameState/latestWinner').set({ name: userData.name, uid: uid, prize: winPrize }); db.ref('users/' + uid + '/points').transaction(p => (p || 0) + winPrize); db.ref('users/' + uid + '/bingoWins').transaction(w => (w || 0) + 1); db.ref('users/' + uid).update({ hasWonCurrent: true }); userData.hasWonCurrent = true; if (isJackpotActive) { const jpModal = document.getElementById('grandJackpotModal'); document.getElementById('grandPrizeAmount').innerText = winPrize.toLocaleString() + " RB COINS"; document.getElementById('jpWinnerName').innerText = userData.name; jpModal.style.display = 'flex'; confetti({ particleCount: 500, spread: 120, startVelocity: 60 }); } }
    function generateNewCard() { if(gameDrawn.length > 0) return showToast("Bawal magpalit habang may laro!"); let card = []; let cols = [[1,15],[16,30],[31,45],[46,60],[61,75]]; cols.forEach(r => { let nums = []; while(nums.length < 5) { let n = Math.floor(Math.random() * (r[1] - r[0] + 1)) + r[0]; if(!nums.includes(n)) nums.push(n); } card.push(...nums); }); let finalCard = []; for(let r=0; r<5; r++) { for(let c=0; c<5; c++) { finalCard.push(card[c*5 + r]); } } finalCard[12] = "FREE"; db.ref('users/' + auth.currentUser.uid).update({ currentCard: finalCard, cardTimestamp: Date.now(), hasWonCurrent: false }); cardNumbers = finalCard; renderCard(); playSound('cardFlip'); }
    function renderCard() { const grid = document.getElementById('bingoGrid'); grid.innerHTML = ""; cardNumbers.forEach((n, i) => { const div = document.createElement('div'); div.className = 'cell'; div.innerText = n === "FREE" ? "★" : n; if(n === "FREE") { div.classList.add('hit'); if(!marks.includes(12)) marks.push(12); } grid.appendChild(div); }); updateGridHits(); applySkin(userData.equippedSkin || 'default'); }
    function updateGridHits() { marks = [12]; const cells = document.querySelectorAll('.cell'); cells.forEach((c, i) => { const val = c.innerText; if(gameDrawn.includes(val) || val === "★") { c.classList.add('hit'); if(!marks.includes(i)) marks.push(i); } }); }
    function renderPrevBalls() { const row = document.getElementById('ballRow'); row.innerHTML = ""; const last5 = gameDrawn.slice(-5).reverse(); last5.forEach(n => { let d = document.createElement('div'); d.className = 'ball-small'; d.innerText = n; row.appendChild(d); }); }
    function checkLateJoiner() { const overlay = document.getElementById('lateOverlay'); if(gameDrawn.length > 0 && !userData.currentCard) { overlay.style.display = 'flex'; } else if (gameDrawn.length > 0 && userData.cardTimestamp > db.ref('gameState/gameStartTime')) { overlay.style.display = 'none'; } else { overlay.style.display = 'none'; } }

    function setupChat() { 
        const list = document.getElementById('chatList'); 
        db.ref('chats').limitToLast(50).on('child_added', s => { 
            const d = s.val(); const key = s.key; if(isUserMuted(d.uid)) return; 
            const isMe = d.uid === auth.currentUser.uid; 
            const div = document.createElement('div'); div.className = 'chat-row'; div.style.flexDirection = isMe ? 'row-reverse' : 'row'; 
            let replyHtml = ''; if(d.replyTo && d.replyMsg) { replyHtml = `<div style="font-size:10px; opacity:0.7; border-left:2px solid var(--accent); padding-left:5px; margin-bottom:5px; background:rgba(0,0,0,0.2); padding:4px; border-radius:4px;">Replying to: ${d.replyMsg.substring(0, 30)}...</div>`; } 
            
            div.innerHTML = `<img class="chat-pfp" src="${d.pfp}" onclick="showUserOptions('${d.uid}', '${d.name.replace(/'/g, "\\'")}', '${d.pfp}')"><div class="chat-content"><div class="bubble">${!isMe ? `<div class="chat-name" onclick="replyTo('${key}', '${d.msg.replace(/'/g, "\\'")}')">${d.name}</div>` : ''}${replyHtml}<div class="chat-text">${d.msg}</div></div></div>`; 
            list.appendChild(div); list.scrollTop = list.scrollHeight; lucide.createIcons(); 
        }); 
    }
    
    function isUserMuted(uid) { const muted = localStorage.getItem('muted_users'); if(!muted) return false; return JSON.parse(muted).includes(uid); }
    function muteUser(uid) { let muted = JSON.parse(localStorage.getItem('muted_users') || "[]"); if(!muted.includes(uid)) { muted.push(uid); localStorage.setItem('muted_users', JSON.stringify(muted)); showToast("User muted locally."); } }
    function sendChat() { const inp = document.getElementById('chatIn'); const msg = inp.value.trim(); if(!msg) return; const payload = { name: userData.name, msg: msg, pfp: userData.photo, uid: userData.uid, time: Date.now() }; if(selectedReplyId) { payload.replyTo = selectedReplyId; payload.replyMsg = document.getElementById('replyText').innerText.replace("Replying to: ", ""); cancelReply(); } db.ref('chats').push(payload); inp.value = ""; }
    function replyTo(key, msg) { selectedReplyId = key; document.getElementById('replyText').innerText = "Replying to: " + msg.substring(0, 20) + "..."; document.getElementById('replyIndicator').style.display = 'flex'; document.getElementById('chatIn').focus(); }
    function cancelReply() { selectedReplyId = null; document.getElementById('replyIndicator').style.display = 'none'; }

    let currentChatPartner = null;
    let isGroupChat = false;

    function openMessenger() { document.getElementById('pmModal').style.display = 'flex'; document.getElementById('pmInboxView').style.display = 'flex'; document.getElementById('pmChatView').style.display = 'none'; loadInbox(); }
    function loadInbox() { 
        const uid = auth.currentUser.uid; 
        const list = document.getElementById('pmList'); 
        list.innerHTML = "<div style='text-align:center; padding: var(--spacing-lg); opacity:0.5;'>Loading...</div>"; 
        
        renderActiveFriends();

        // Load Groups
        db.ref('groupMembers/' + uid).once('value', gSnap => {
            const myGroups = gSnap.exists() ? Object.keys(gSnap.val()) : [];
            
            // Load PMs
            db.ref('messages').once('value', s => { 
                const conversations = {}; 
                s.forEach(msgSnap => { const m = msgSnap.val(); if(m.from === uid || m.to === uid) { const partner = m.from === uid ? m.to : m.from; conversations[partner] = m; } }); 
                
                list.innerHTML = ""; 
                
                // Render Groups First
                myGroups.forEach(groupId => {
                    db.ref('groups/' + groupId).once('value', groupSnap => {
                        const grp = groupSnap.val();
                        if(!grp) return;
                        const div = document.createElement('div');
                        div.className = 'pm-item';
                        div.onclick = () => openGroupChat(groupId, grp.name);
                        div.innerHTML = `
                            <div style="width:55px; height:55px; border-radius:50%; background:#1e293b; display:flex; align-items:center; justify-content:center; color:white; border:1px solid rgba(255,255,255,0.1);"><i data-lucide="users"></i></div>
                            <div class="pm-info"><span class="pm-name">${grp.name}</span><span class="pm-preview">Group Chat</span></div>
                        `;
                        list.appendChild(div);
                        lucide.createIcons();
                    });
                });

                if(Object.keys(conversations).length === 0 && myGroups.length === 0) { list.innerHTML = "<div style='text-align:center; padding: var(--spacing-lg);'>No messages yet.</div>"; return; } 
                
                // Collect all conversation data with status
                const conversationDataList = [];
                const partnerIds = Object.keys(conversations);
                let processed = 0;
                
                partnerIds.forEach(partnerId => { 
                    db.ref('users/' + partnerId).once('value', uSnap => { 
                        const u = uSnap.val(); 
                        const lastMsg = conversations[partnerId]; 
                        
                        // Check online status
                        db.ref('status/' + partnerId).once('value', statusSnap => {
                            const status = statusSnap.val();
                            const isOnline = status && status.state === 'online';
                            const lastSeenText = !isOnline && status && status.last_seen 
                                ? formatLastSeen(status.last_seen) 
                                : '';
                            
                            conversationDataList.push({
                                partnerId,
                                userData: u,
                                lastMsg,
                                isOnline,
                                lastSeenText,
                                timestamp: status?.last_seen || 0
                            });
                            
                            processed++;
                            
                            // When all conversations are loaded, sort and render
                            if(processed === partnerIds.length) {
                                // Sort: Active users first, then by last seen
                                conversationDataList.sort((a, b) => {
                                    if(a.isOnline && !b.isOnline) return -1;
                                    if(!a.isOnline && b.isOnline) return 1;
                                    return b.timestamp - a.timestamp;
                                });
                                
                                // Render sorted conversations
                                conversationDataList.forEach(data => {
                                    const div = document.createElement('div'); 
                                    div.className = 'pm-item'; 
                                    div.onclick = () => openPrivateChat(data.partnerId, data.userData.name, data.userData.photo); 
                                    const previewText = data.lastMsg.image ? 'Sent a photo' : data.lastMsg.text;
                                    
                                    // Check if user is verified
                                    const isVerified = data.userData.verified === true;
                                    const verifiedBadgeHTML = isVerified ? `<span class="verified-badge inline-badge" onmouseenter="showVerificationTooltip(event)" onmouseleave="hideVerificationTooltip()"><i data-lucide="check" style="width:10px; height:10px; color:white;"></i></span>` : '';
                                    
                                    // Add online indicator wrapper to avatar
                                    const onlineDot = data.isOnline ? '<div class="online-indicator is-online"></div>' : '';
                                    const statusInfo = data.isOnline ? '<span style="color: #22c55e; font-size: 12px; font-weight: 500;">Active now</span>' : 
                                                       (data.lastSeenText ? `<span style="color: rgba(255,255,255,0.4); font-size: 11px;">Active ${data.lastSeenText}</span>` : '');
                                    
                                    div.innerHTML = `
                                        <div class="avatar-frame" data-uid="${data.partnerId}" style="position: relative; flex-shrink: 0;">
                                            <img class="pm-avatar" src="${data.userData.photo || 'https://via.placeholder.com/40'}">
                                            ${onlineDot}
                                        </div>
                                        <div class="pm-info">
                                            <div style="display: flex; align-items: center; gap: 6px;">
                                                <span class="pm-name">${data.userData.name}${verifiedBadgeHTML}</span>
                                            </div>
                                            <span class="pm-preview">${data.lastMsg.from === uid ? 'You: ' : ''}${previewText}</span>
                                            ${statusInfo}
                                        </div>
                                    `; 
                                    list.appendChild(div); 
                                    lucide.createIcons();
                                });
                            }
                        });
                    }); 
                }); 
            });
        });
    }
    
    function deleteConversation() {
        if(!currentChatPartner) return;
        
        const confirmMsg = isGroupChat ? "Delete this group chat? This will remove you from the group." : "Delete this conversation? All messages will be removed.";
        
        if(!confirm(confirmMsg)) return;
        
        const myUid = auth.currentUser.uid;
        
        if(isGroupChat) {
            // Remove user from group
            db.ref('groups/' + currentChatPartner + '/members/' + myUid).remove();
            db.ref('groupMembers/' + myUid + '/' + currentChatPartner).remove();
            showToast("Left group chat");
        } else {
            // Delete all messages between users
            db.ref('messages').once('value', s => {
                const updates = {};
                s.forEach(msgSnap => {
                    const m = msgSnap.val();
                    if((m.from === myUid && m.to === currentChatPartner) || (m.from === currentChatPartner && m.to === myUid)) {
                        updates['messages/' + msgSnap.key] = null;
                    }
                });
                db.ref().update(updates);
                showToast("Conversation deleted");
            });
        }
        
        backToInbox();
    }
    
    function renderActiveFriends() {
        const bar = document.getElementById('activeFriendsBar');
        bar.innerHTML = '';
        
        if(!auth.currentUser) return;
        
        db.ref('friends/' + auth.currentUser.uid).once('value', s => {
            if(!s.exists()) return;
            
            const friendsList = [];
            s.forEach(f => friendsList.push(f.key));
            
            // Check each friend's online status
            friendsList.forEach(friendId => {
                db.ref('status/' + friendId).on('value', statusSnap => {
                    const status = statusSnap.val();
                    
                    // Only show if truly online
                    if(status && status.state === 'online') {
                        db.ref('users/' + friendId).once('value', uSnap => {
                            const u = uSnap.val();
                            if(!u) return;
                            
                            // Remove existing item if present
                            const existingItem = bar.querySelector(`[data-friend-id="${friendId}"]`);
                            if(existingItem) existingItem.remove();
                            
                            const item = document.createElement('div');
                            item.className = 'active-friend-item';
                            item.dataset.friendId = friendId;
                            item.onclick = () => openPrivateChat(friendId, u.name, u.photo); 
                            item.innerHTML = `
                                <div class="active-img-wrap">
                                    <img src="${u.photo}" class="active-img">
                                    <div class="online-dot-large"></div>
                                </div>
                                <div class="active-name">${u.name.split(' ')[0]}</div>
                            `;
                            bar.appendChild(item);
                        });
                    } else {
                        // Remove from active bar if user went offline
                        const existingItem = bar.querySelector(`[data-friend-id="${friendId}"]`);
                        if(existingItem) existingItem.remove();
                    }
                });
            });
        });
    }

    // === GROUP CHAT LOGIC ===
    function startCreateGroup() {
        document.getElementById('pmInboxView').style.display = 'none';
        document.getElementById('pmCreateGroupView').style.display = 'flex';
        const container = document.getElementById('friendSelectContainer');
        container.innerHTML = "Loading friends...";
        
        db.ref('friends/' + auth.currentUser.uid).once('value', s => {
            container.innerHTML = "";
            if(!s.exists()) { container.innerHTML = "No friends found."; return; }
            s.forEach(f => {
                 db.ref('users/' + f.key).once('value', uSnap => {
                     const u = uSnap.val();
                     const div = document.createElement('div');
                     div.className = 'friend-select-item';
                     div.onclick = () => { div.classList.toggle('selected'); };
                     div.dataset.uid = f.key;
                     div.innerHTML = `
                        <div style="display:flex; align-items:center; gap: var(--spacing-sm);">
                            <img src="${u.photo}" style="width:40px; height:40px; border-radius:50%;">
                            <span>${u.name}</span>
                        </div>
                        <div class="checkbox-circle"><i data-lucide="check" style="width:12px;"></i></div>
                     `;
                     container.appendChild(div);
                     lucide.createIcons();
                 });
            });
        });
    }

    function cancelCreateGroup() {
        document.getElementById('pmCreateGroupView').style.display = 'none';
        document.getElementById('pmInboxView').style.display = 'flex';
    }

    function finalizeCreateGroup() {
        const name = document.getElementById('newGroupName').value.trim();
        if(!name) return showToast("Enter Group Name");
        
        const selected = document.querySelectorAll('.friend-select-item.selected');
        if(selected.length === 0) return showToast("Select at least 1 friend");
        
        const members = { [auth.currentUser.uid]: true };
        selected.forEach(el => members[el.dataset.uid] = true);
        
        const groupRef = db.ref('groups').push();
        groupRef.set({
            name: name,
            createdBy: auth.currentUser.uid,
            members: members
        }).then(() => {
            // Index for each member
            Object.keys(members).forEach(uid => {
                db.ref('groupMembers/' + uid + '/' + groupRef.key).set(true);
            });
            showToast("Group Created!");
            cancelCreateGroup();
            loadInbox();
        });
    }

    function openGroupChat(groupId, groupName) {
        currentChatPartner = groupId;
        isGroupChat = true;
        document.getElementById('pmInboxView').style.display = 'none'; 
        document.getElementById('pmChatView').style.display = 'flex'; 
        document.getElementById('chatTargetName').innerText = groupName; 
        document.getElementById('chatTargetStatus').innerText = "Group Chat";
        document.getElementById('chatTargetAvatarCont').innerHTML = `<div style="width:100%; height:100%; border-radius:50%; background:#334155; display:flex; align-items:center; justify-content:center;"><i data-lucide="users"></i></div>`;
        lucide.createIcons();
        
        listenGroupMessages(groupId);
    }
    
    function listenGroupMessages(groupId) {
        const chatDiv = document.getElementById('pmMessages'); 
        chatDiv.innerHTML = "";
        if(pmListenerRef) db.ref('groupMessages').off(); // Clear old listener location logic if slightly diff

        const gRef = db.ref('groupMessages/' + groupId).limitToLast(100);
        gRef.on('child_added', s => {
             const m = s.val();
             const div = document.createElement('div'); 
             div.className = `msg-bubble ${m.from === auth.currentUser.uid ? 'msg-me' : 'msg-them'}`;
             let contentHtml = m.text;
             if(m.image) contentHtml += `<br><img src="${m.image}" class="msg-image-preview">`;
             
             // Show name in group
             if(m.from !== auth.currentUser.uid) {
                 contentHtml = `<span style="font-size:9px; color:#94a3b8; display:block; margin-bottom:2px;">${m.senderName}</span>` + contentHtml;
             }

             div.innerHTML = contentHtml;
             chatDiv.appendChild(div); 
             chatDiv.scrollTop = chatDiv.scrollHeight; 
        });
        pmListenerRef = gRef; // Hacky reference store
    }

    function openPrivateChat(uid, name, photo) { 
        if(uid === auth.currentUser.uid) return showToast("Cant msg self"); 
        currentChatPartner = uid; 
        isGroupChat = false;
        document.getElementById('pmModal').style.display = 'flex'; 
        document.getElementById('pmInboxView').style.display = 'none'; 
        document.getElementById('pmChatView').style.display = 'flex'; 
        document.getElementById('chatTargetName').innerText = name; 
        
        // Real-time status monitoring
        const statusRef = db.ref('status/' + uid);
        statusRef.on('value', statusSnap => {
            const status = statusSnap.val();
            const statusElement = document.getElementById('chatTargetStatus');
            
            if(status && status.state === 'online') {
                statusElement.innerText = "Active now";
                statusElement.style.color = "#22c55e";
            } else if(status && status.last_seen) {
                const lastSeenText = formatLastSeen(status.last_seen);
                statusElement.innerText = `Active ${lastSeenText}`;
                statusElement.style.color = "rgba(255,255,255,0.5)";
            } else {
                statusElement.innerText = "Offline";
                statusElement.style.color = "rgba(255,255,255,0.4)";
            }
        });
        
        document.getElementById('chatTargetAvatarCont').innerHTML = `<img src="${photo}" style="width:100%; height:100%; border-radius:50%; object-fit:cover;">`;
        
        db.ref('notifications/' + auth.currentUser.uid).once('value', s => {
            s.forEach(n => {
                if(n.val().type === 'pm' && n.val().from === uid) {
                    db.ref('notifications/' + auth.currentUser.uid + '/' + n.key).remove();
                }
            });
        });

        listenPrivateMessages(auth.currentUser.uid); 
    }
    
    function backToInbox() { 
        // Clean up status listener
        if(currentChatPartner) {
            db.ref('status/' + currentChatPartner).off();
        }
        
        currentChatPartner = null; 
        isGroupChat = false;
        document.getElementById('pmChatView').style.display = 'none'; 
        document.getElementById('pmInboxView').style.display = 'flex'; 
        if(pmListenerRef) pmListenerRef.off();
        loadInbox(); 
    }
    
    let pmImageBase64 = null;
    function handlePmImage(input) {
        if(input.files && input.files[0]) {
            compressImage(input.files[0], 500, 0.7).then(base64 => {
                pmImageBase64 = base64;
                document.getElementById('pmImgPreviewCont').style.display = 'block';
            });
        }
    }

    function sendPrivateMessage() { 
        const inp = document.getElementById('pmInput'); 
        const text = inp.value.trim(); 
        if((!text && !pmImageBase64) || !currentChatPartner) return; 
        const myUid = auth.currentUser.uid; 
        
        if(isGroupChat) {
            const msgData = { from: myUid, senderName: userData.name, text: text, image: pmImageBase64, timestamp: Date.now() };
            db.ref('groupMessages/' + currentChatPartner).push(msgData);
        } else {
            const msgData = { from: myUid, to: currentChatPartner, text: text, image: pmImageBase64, timestamp: Date.now() }; 
            db.ref('messages').push(msgData); 
            const notifMsg = pmImageBase64 ? 'Sent a photo' : `New PM from ${userData.name}`;
            db.ref('notifications/' + currentChatPartner).push({ msg: notifMsg, time: Date.now(), type: 'pm', from: myUid }); 
        }

        inp.value = ""; 
        pmImageBase64 = null;
        document.getElementById('pmImgInput').value = "";
        document.getElementById('pmImgPreviewCont').style.display = 'none';
    }
    
    let pmListenerRef = null;
    let isInitialLoad = true;
    function listenPrivateMessages(myUid) { 
        const chatDiv = document.getElementById('pmMessages'); 
        chatDiv.innerHTML = "";
        if(pmListenerRef) db.ref('messages').off();
        isInitialLoad = true;

        pmListenerRef = db.ref('messages').limitToLast(100);
        pmListenerRef.on('child_added', s => { 
            const m = s.val(); 
            const key = s.key;
            
            // Play sound for new incoming messages when not in initial load
            if(!isInitialLoad && m.to === myUid && (m.timestamp > (Date.now() - 2000))) {
                playSound('pop');
                
                // Show toast notification if PM modal is closed or chat is with different user
                const pmModal = document.getElementById('pmModal');
                const isPMModalClosed = pmModal.style.display === 'none' || !pmModal.style.display;
                const isDifferentChat = currentChatPartner !== m.from;
                
                if(isPMModalClosed || isDifferentChat) {
                    // Get sender name
                    db.ref('users/' + m.from).once('value', uSnap => {
                        const sender = uSnap.val();
                        if(sender) {
                            const messagePreview = m.image ? '📷 Photo' : (m.text.length > 30 ? m.text.substring(0, 30) + '...' : m.text);
                            const sanitizedName = escapeHtml(sender.name);
                            const sanitizedPreview = escapeHtml(messagePreview);
                            showToast(`💬 ${sanitizedName}: ${sanitizedPreview}`);
                        }
                    });
                }
            }

            if(!currentChatPartner) return; 
            if( (m.from === myUid && m.to === currentChatPartner) || (m.from === currentChatPartner && m.to === myUid) ) { 
                const div = document.createElement('div'); 
                div.className = `msg-bubble ${m.from === myUid ? 'msg-me' : 'msg-them'}`; 
                
                let contentHtml = m.text;
                if(m.image) {
                    contentHtml += `<br><img src="${m.image}" class="msg-image-preview">`;
                }
                
                // Heart logic
                let heartHtml = '';
                if(m.hearted) {
                    heartHtml = `<div class="msg-heart-reaction">❤️</div>`;
                }

                div.innerHTML = `${contentHtml}${heartHtml}`; 
                
                // Double click to heart
                div.ondblclick = () => {
                    if(!m.hearted) {
                        db.ref('messages/' + key).update({ hearted: true });
                        showToast("Message hearted");
                    }
                };

                chatDiv.appendChild(div); 
                chatDiv.scrollTop = chatDiv.scrollHeight; 
            } 
        }); 
        
        // Listen for changes (hearts)
        pmListenerRef.on('child_changed', s => {
             // In real app, find specific bubble and update. Here we just re-render or let it slide for simplicity in one-file
        });

        setTimeout(() => { isInitialLoad = false; }, 1500);
    }

    function deductPoints(amt) { db.ref('users/' + userData.uid + '/points').transaction(p => (p || 0) - amt); spawnLossAnimation(amt); }
    function addPoints(amt) { db.ref('users/' + userData.uid + '/points').transaction(p => (p || 0) + amt); }

    function verifyAdMath() { const ans = document.getElementById('mathAns').value; const corr = document.getElementById('mathQ').dataset.ans; if(ans === corr) { document.getElementById('adCaptchaOverlay').style.display = 'none'; addPoints(50); showToast("Reward: +50 Coins Added!"); } else { showToast("Wrong Answer!"); } }
    
    function spawnFlyingCoins(amount) { const count = Math.min(amount, 15); const targetEl = document.querySelector('.points-badge') || document.querySelector('.game-balance-pill'); if(!targetEl) return; const rect = targetEl.getBoundingClientRect(); const targetX = rect.left + (rect.width / 2); const targetY = rect.top + (rect.height / 2); const startX = window.innerWidth / 2; const startY = window.innerHeight / 2; for(let i=0; i<count; i++) { setTimeout(() => { const coin = document.createElement('div'); coin.className = 'flying-coin'; coin.style.left = startX + 'px'; coin.style.top = startY + 'px'; document.body.appendChild(coin); const spread = 80; const randX = (Math.random() - 0.5) * spread; const randY = (Math.random() - 0.5) * spread; requestAnimationFrame(() => { coin.style.transition = 'transform 0.3s ease-out'; coin.style.transform = `translate(${randX}px, ${randY}px) scale(1.2)`; setTimeout(() => { coin.style.transition = 'transform 0.6s cubic-bezier(0.2, 0.8, 0.2, 1), opacity 0.6s'; const moveX = targetX - startX; const moveY = targetY - startY; coin.style.transform = `translate(${moveX}px, ${moveY}px) scale(0.5)`; coin.style.opacity = '0'; }, 300); setTimeout(() => coin.remove(), 900); }); }, i * 30); } }
    function triggerScreenShake() { const activeGame = document.querySelector('.game-overlay-fs[style*="flex"]'); const target = activeGame ? activeGame.querySelector('.roulette-table, .slot-machine-frame, .hl-table, .color-table, .l9-table, .dice-table') : document.getElementById('bingoCardContainer'); if (target) { target.classList.add('shake-effect'); setTimeout(() => target.classList.remove('shake-effect'), 300); } if (navigator.vibrate) navigator.vibrate([30, 30, 30]); }
    function spawnLossAnimation(amount) { const activeGame = document.querySelector('.game-overlay-fs[style*="flex"]'); let startX, startY; if(activeGame) { startX = window.innerWidth / 2; startY = window.innerHeight / 2; } else { const badge = document.querySelector('.points-badge'); if(badge) { const rect = badge.getBoundingClientRect(); startX = rect.left + 20; startY = rect.top + 40; } else { startX = window.innerWidth / 2; startY = window.innerHeight / 2; } } const el = document.createElement('div'); el.className = 'float-loss'; el.innerText = "-" + amount; el.style.left = startX + 'px'; el.style.top = startY + 'px'; document.body.appendChild(el); setTimeout(() => el.remove(), 1000); }

    function openMenuModal() { document.getElementById('menuModal').style.display='flex'; }
    function saveGcash() { const num = document.getElementById('gcashInput').value; if(num.length > 3) { db.ref('users/'+auth.currentUser.uid).update({ gcash: num }); showToast("Info Saved!"); } else showToast("Invalid Details"); }
    function redeemItem(name, cost) { if(userData.points >= cost) { if(!userData.gcash) return showToast("Save redemption info first!"); showCustomConfirm("REDEEM REWARD?", "Exchange " + cost + " pts for " + name + "?", () => { deductPoints(cost); db.ref('redemptions').push({ uid: userData.uid, name: userData.name, gcash: userData.gcash, item: name, cost: cost, status: 'pending', timestamp: Date.now() }); showToast("Request Sent!"); loadHistory(); }); } else { showToast("Insufficient RB Coins"); } }
    function loadHistory() { const list = document.getElementById('historyList'); db.ref('redemptions').orderByChild('uid').equalTo(auth.currentUser.uid).once('value', s => { list.innerHTML = ""; s.forEach(r => { const d = r.val(); let color = '#fbbf24'; if(d.status === 'sent') color = '#10b981'; if(d.status === 'denied') color = '#ef4444'; list.innerHTML += `<div class="history-item"><div><div style="font-weight:700; font-size:12px;">${d.item}</div><div style="font-size:10px; opacity:0.6;">${fixDate(d.timestamp)}</div></div><div style="font-size:10px; font-weight:800; color:${color}; text-transform:uppercase; border:1px solid ${color}; padding:2px 6px; border-radius:4px;">${d.status}</div></div>`; }); }); }

    // === SUPPORT CONTACT FUNCTIONS ===
    function openSupportModal() {
        document.getElementById('menuModal').style.display = 'none';
        document.getElementById('supportModal').style.display = 'flex';
        loadMyTickets(); // Load user's tickets when opening modal
        setTimeout(() => lucide.createIcons(), 50);
    }

    function submitSupportRequest() {
        const subject = document.getElementById('supportSubject').value.trim();
        const message = document.getElementById('supportMessage').value.trim();
        
        if(!subject || !message) {
            showToast("Please fill in all fields");
            return;
        }
        
        if(message.length < 10) {
            showToast("Message too short. Please provide more details.");
            return;
        }
        
        // Save to Firebase
        db.ref('supportMessages').push({
            uid: auth.currentUser.uid,
            userName: userData.name,
            userEmail: userData.gcash || 'Not provided',
            userPhoto: userData.photo,
            subject: subject,
            message: message,
            timestamp: Date.now(),
            status: 'open'
        });
        
        showToast("Message sent! We'll respond soon.");
        playSound('pop');
        
        // Clear form and refresh ticket list
        document.getElementById('supportSubject').value = '';
        document.getElementById('supportMessage').value = '';
        loadMyTickets();
    }
    
    function loadMyTickets() {
        const ticketsList = document.getElementById('ticketsList');
        ticketsList.innerHTML = '<div style="text-align:center; padding: var(--spacing-md); opacity:0.5; font-size:11px;">Loading tickets...</div>';
        
        db.ref('supportMessages').orderByChild('uid').equalTo(auth.currentUser.uid).once('value', s => {
            ticketsList.innerHTML = '';
            
            if(!s.exists()) {
                ticketsList.innerHTML = '<div style="text-align:center; padding: var(--spacing-md); opacity:0.5; font-size:11px;">No tickets yet</div>';
                return;
            }
            
            const tickets = [];
            s.forEach(child => {
                tickets.push({ key: child.key, ...child.val() });
            });
            
            // Sort by timestamp descending
            tickets.sort((a, b) => b.timestamp - a.timestamp);
            
            tickets.forEach(ticket => {
                // Count replies
                db.ref('supportTicketReplies/' + ticket.key).once('value', rSnap => {
                    const replyCount = rSnap.numChildren();
                    
                    const ticketDiv = document.createElement('div');
                    ticketDiv.className = 'ticket-item';
                    ticketDiv.onclick = () => openTicketDetail(ticket.key);
                    
                    ticketDiv.innerHTML = `
                        <div class="ticket-item-header">
                            <div class="ticket-subject">${escapeHtml(ticket.subject)}</div>
                            <div class="ticket-status ${ticket.status}">${ticket.status}</div>
                        </div>
                        <div style="display:flex; justify-content:space-between; align-items:center;">
                            <div class="ticket-time">${fixDate(ticket.timestamp)}</div>
                            ${replyCount > 0 ? `<div class="ticket-reply-count"><i data-lucide="message-circle" style="width:12px;"></i> ${replyCount}</div>` : ''}
                        </div>
                    `;
                    
                    ticketsList.appendChild(ticketDiv);
                    lucide.createIcons();
                });
            });
        });
    }
    
    let currentTicketKey = null;
    
    function openTicketDetail(ticketKey) {
        currentTicketKey = ticketKey;
        
        db.ref('supportMessages/' + ticketKey).once('value', s => {
            const ticket = s.val();
            if(!ticket) return;
            
            document.getElementById('ticketDetailSubject').innerText = ticket.subject;
            document.getElementById('ticketDetailStatus').innerText = ticket.status.toUpperCase();
            document.getElementById('ticketDetailStatus').style.color = ticket.status === 'open' ? 'var(--gold)' : '#94a3b8';
            
            const repliesContainer = document.getElementById('ticketRepliesContainer');
            repliesContainer.innerHTML = `
                <div class="ticket-original-message">
                    <div class="ticket-original-label">Original Message</div>
                    <div class="ticket-reply-content">${escapeHtml(ticket.message)}</div>
                    <div class="ticket-reply-time" style="margin-top:8px;">${fixDate(ticket.timestamp)}</div>
                </div>
            `;
            
            // Load replies
            db.ref('supportTicketReplies/' + ticketKey).orderByChild('timestamp').once('value', rSnap => {
                // Clear only replies, keep original message
                const existingOriginal = repliesContainer.querySelector('.ticket-original-message');
                repliesContainer.innerHTML = '';
                if(existingOriginal) {
                    repliesContainer.appendChild(existingOriginal);
                }
                
                if(!rSnap.exists()) {
                    repliesContainer.innerHTML += '<div style="text-align:center; padding: var(--spacing-lg); opacity:0.5; font-size:11px;">No replies yet</div>';
                } else {
                    // NORMALIZED: Fetch user data for each reply
                    rSnap.forEach(child => {
                        const reply = child.val();
                        const isAdmin = reply.isAdmin || false;
                        const adminBadge = isAdmin ? '<span class="ticket-reply-admin-badge">Support Team</span>' : '';
                        
                        // Fetch user data from users table
                        db.ref('users/' + reply.uid).once('value', userSnap => {
                            const user = userSnap.val();
                            if(!user) return;
                            
                            const replyDiv = document.createElement('div');
                            replyDiv.className = 'ticket-reply-item';
                            replyDiv.innerHTML = `
                                <div class="ticket-reply-header">
                                    <img src="${user.photo || 'https://via.placeholder.com/40'}" class="ticket-reply-avatar">
                                    <div>
                                        <div class="ticket-reply-author">${escapeHtml(user.name)} ${adminBadge}</div>
                                    </div>
                                    <div class="ticket-reply-time">${fixDate(reply.timestamp)}</div>
                                </div>
                                <div class="ticket-reply-content">${escapeHtml(reply.message)}</div>
                            `;
                            repliesContainer.appendChild(replyDiv);
                            lucide.createIcons();
                        });
                    });
                }
            });
            
            document.getElementById('ticketDetailModal').style.display = 'flex';
            setTimeout(() => lucide.createIcons(), 50);
        });
    }
    
    function closeTicketDetail() {
        document.getElementById('ticketDetailModal').style.display = 'none';
        currentTicketKey = null;
    }
    
    function submitTicketReply() {
        if(!currentTicketKey) return;
        
        const replyText = document.getElementById('ticketReplyInput').value.trim();
        
        if(!replyText) {
            showToast("Please enter a reply");
            return;
        }
        
        if(replyText.length < 5) {
            showToast("Reply too short");
            return;
        }
        
        // NORMALIZED: Add reply to Firebase with only UID
        db.ref('supportTicketReplies/' + currentTicketKey).push({
            uid: auth.currentUser.uid, // ONLY user reference
            message: replyText,
            timestamp: Date.now(),
            isAdmin: false
        }).then(() => {
            // Reload ticket detail to show new reply
            openTicketDetail(currentTicketKey);
            
            // Clear input
            document.getElementById('ticketReplyInput').value = '';
            showToast("Reply sent!");
            playSound('pop');
        });
        
        // Get ticket owner to send notification
        // Note: In a production environment, verify isAdmin flag before sending admin notifications
        db.ref('supportMessages/' + currentTicketKey).once('value', ticketSnap => {
            const ticket = ticketSnap.val();
            if(ticket && ticket.uid !== auth.currentUser.uid) {
                // Another user (likely admin/support) is replying, notify the ticket owner
                db.ref('notifications/' + ticket.uid).push({
                    msg: `Support replied to your ticket: ${ticket.subject}`,
                    time: Date.now(),
                    type: 'support_reply',
                    from: auth.currentUser.uid,
                    ticketId: currentTicketKey,
                    image: userData.photo
                });
            }
        });
        
        // Update ticket status to open if it was closed
        db.ref('supportMessages/' + currentTicketKey + '/status').set('open');
    }

    let selectedMood = null; // UPDATED DEFAULT
    let targetUserForOpt = null;
    let selectedImageBase64 = null;
    let selectedVideoBase64 = null;

    function initSocialSystem(uid) {
        db.ref('friendRequests/' + uid).on('value', s => {
            const container = document.getElementById('friendRequestsSection');
            container.innerHTML = "";
            s.forEach(req => {
                const requesterId = req.key;
                db.ref('users/' + requesterId).once('value', u => {
                    const uData = u.val();
                    const div = document.createElement('div');
                    div.className = 'friend-req-card';
                    div.innerHTML = `<div class="req-info"><img src="${uData.photo}" style="width:30px;height:30px;border-radius:50%;"><span style="font-weight:700; font-size:12px; color:white;">${uData.name} wants to be friends</span></div><div class="req-actions"><button class="btn-accept" onclick="acceptFriend('${requesterId}')">Accept</button><button class="btn-decline" onclick="declineFriend('${requesterId}')">X</button></div>`;
                    container.appendChild(div);
                });
            });
        });
    }

    function showUserOptions(uid, name, photo) {
        targetUserForOpt = { uid, name, photo };
        document.getElementById('optUserAvatarCont').innerHTML = `<img src="${photo}" style="width:60px; height:60px; border-radius:50%; border:2px solid var(--accent); object-fit:cover;">`;
        document.getElementById('optUserName').innerText = name;
        document.getElementById('userOptionsModal').style.display = 'flex';
    }

    function optSendMessage() {
        document.getElementById('userOptionsModal').style.display = 'none';
        openPrivateChat(targetUserForOpt.uid, targetUserForOpt.name, targetUserForOpt.photo);
    }

    function optAddFriend() {
        if(!targetUserForOpt) return;
        const targetUid = targetUserForOpt.uid;
        if(targetUid === auth.currentUser.uid) { showToast("That's you!"); return; }
        
        db.ref('friends/' + auth.currentUser.uid + '/' + targetUid).once('value', s => {
            if(s.exists()) {
                showToast("Already friends!");
            } else {
                db.ref('friendRequests/' + targetUid + '/' + auth.currentUser.uid).set(true);
                showToast("Friend Request Sent!");
            }
            document.getElementById('userOptionsModal').style.display = 'none';
        });
    }

    function acceptFriend(requesterUid) {
        const myUid = auth.currentUser.uid;
        db.ref('friends/' + myUid + '/' + requesterUid).set(true);
        db.ref('friends/' + requesterUid + '/' + myUid).set(true);
        db.ref('friendRequests/' + myUid + '/' + requesterUid).remove();
        showToast("You are now friends!");
        playSound('win');
    }
    
    function sendFriendRequest(targetUid) {
        if(targetUid === auth.currentUser.uid) { 
            showToast("That's you!"); 
            return; 
        }
        
        db.ref('friends/' + auth.currentUser.uid + '/' + targetUid).once('value', s => {
            if(s.exists()) {
                showToast("Already friends!");
            } else {
                db.ref('friendRequests/' + targetUid + '/' + auth.currentUser.uid).set(true);
                showToast("Friend Request Sent!");
                
                // Optionally hide the add friend button after sending request
                const addBtns = document.querySelectorAll(`.add-friend-icon-btn[onclick*="${targetUid}"]`);
                addBtns.forEach(btn => {
                    btn.style.display = 'none';
                });
            }
        });
    }

    function declineFriend(requesterUid) {
        db.ref('friendRequests/' + auth.currentUser.uid + '/' + requesterUid).remove();
    }
    
    // UNFRIEND LOGIC (Modern)
    function unfriendUser() {
        if(!currentProfileUid) return;
        showCustomConfirm("Unfriend?", "Are you sure you want to remove this friend?", () => {
             const myUid = auth.currentUser.uid;
             db.ref('friends/' + myUid + '/' + currentProfileUid).remove();
             db.ref('friends/' + currentProfileUid + '/' + myUid).remove();
             showToast("Unfriended successfully.");
             updateProfileButtonState(currentProfileUid);
        });
    }

    function selectMood(el, mood) {
        const isSelected = el.classList.contains('selected');
        document.querySelectorAll('.mood-chip').forEach(c => c.classList.remove('selected'));
        if(!isSelected) { el.classList.add('selected'); selectedMood = mood; } else { selectedMood = null; }
    }
    
    // === CLOUDINARY MEDIA UPLOAD ===
    // ═══════════════════════════════════════════════════════════
    // ✅ CLOUDINARY CONFIGURED FOR: dzifutb8l
    // ═══════════════════════════════════════════════════════════
    
    const CLOUDINARY_CLOUD_NAME = 'dzifutb8l'; // ✅ YOUR CLOUD NAME - READY!
    const CLOUDINARY_UPLOAD_PRESET = 'radiobingo_uploads'; // Using default preset
    
    /* 
    ✅ CLOUD NAME: SET UP ✅
    
    ⚠️ NEXT STEP: Create Upload Preset (OPTIONAL but RECOMMENDED)
    
    Your code will work with 'ml_default' preset, but for better control:
    
    1. Go to: https://console.cloudinary.com/console/dzifutb8l/settings/upload
    2. Scroll to "Upload presets"
    3. Click "Add upload preset"
    4. Settings:
       • Preset name: radiobingo_uploads
       • Signing mode: Unsigned ⚠️ MUST BE UNSIGNED!
       • Folder: (optional) radiobingo
    5. Click "Save"
    6. Update line 4948 to:
       const CLOUDINARY_UPLOAD_PRESET = 'radiobingo_uploads';
    
    🎯 FOR NOW: It will use 'ml_default' - TEST FIRST before creating custom preset!
    */
    
    async function uploadToCloudinary(file, resourceType = 'image') {
        const formData = new FormData();
        formData.append('file', file);
        formData.append('upload_preset', CLOUDINARY_UPLOAD_PRESET);
        
        const uploadUrl = `https://api.cloudinary.com/v1_1/${CLOUDINARY_CLOUD_NAME}/${resourceType}/upload`;
        
        try {
            showToast('Uploading...');
            const response = await fetch(uploadUrl, {
                method: 'POST',
                body: formData
            });
            
            const data = await response.json();
            if(data.secure_url) {
                return data.secure_url; // Return the Cloudinary URL
            } else {
                throw new Error('Upload failed');
            }
        } catch(error) {
            console.error('Cloudinary upload error:', error);
            showToast('Upload failed. Try again.');
            return null;
        }
    }
    
    function handlePostImage(input) {
        if(input.files && input.files[0]) {
            removePostVideo(); // Clear video if image is selected
            
            // Upload to Cloudinary instead of base64
            uploadToCloudinary(input.files[0], 'image').then(url => {
                if(url) {
                    selectedImageBase64 = url; // Store URL instead of base64
                    document.getElementById('postImgPreview').src = url;
                    document.getElementById('imgPreviewCont').style.display = 'block';
                    showToast('Image uploaded!');
                }
            });
        }
    }
    
    function handlePostVideo(input) {
        if(input.files && input.files[0]) {
            const videoFile = input.files[0];
            
            // Check file size (50MB max for Cloudinary free)
            if(videoFile.size > 50 * 1024 * 1024) {
                showToast("Video too large! Max 50MB");
                input.value = "";
                return;
            }
            
            // Create video element to check duration
            const video = document.createElement('video');
            video.preload = 'metadata';
            
            video.onloadedmetadata = function() {
                window.URL.revokeObjectURL(video.src);
                
                // Check duration (60 seconds max)
                if(video.duration > 60) {
                    showToast("Video too long! Max 1 minute");
                    input.value = "";
                    return;
                }
                
                removePostImage(); // Clear image if video is selected
                
                // Upload to Cloudinary
                uploadToCloudinary(videoFile, 'video').then(url => {
                    if(url) {
                        selectedVideoBase64 = url; // Store URL instead of base64
                        document.getElementById('postVideoPreview').src = url;
                        document.getElementById('videoPreviewCont').style.display = 'block';
                        showToast('Video uploaded!');
                    }
                });
            };
            
            video.src = URL.createObjectURL(videoFile);
        }
    }
    
    function removePostImage() {
        selectedImageBase64 = null;
        document.getElementById('postImgInput').value = "";
        document.getElementById('imgPreviewCont').style.display = 'none';
    }
    
    function removePostVideo() {
        selectedVideoBase64 = null;
        document.getElementById('postVideoInput').value = "";
        document.getElementById('videoPreviewCont').style.display = 'none';
    }

    function toggleVisibility() {
        const visibilityInput = document.getElementById('postVisibility');
        const visibilityIcon = document.getElementById('visibilityIcon');
        const currentValue = visibilityInput.value;
        
        // Cycle through: public -> friends -> private -> public
        if (currentValue === 'public') {
            visibilityInput.value = 'friends';
            visibilityIcon.setAttribute('data-lucide', 'users');
        } else if (currentValue === 'friends') {
            visibilityInput.value = 'private';
            visibilityIcon.setAttribute('data-lucide', 'lock');
        } else {
            visibilityInput.value = 'public';
            visibilityIcon.setAttribute('data-lucide', 'globe');
        }
        
        // Re-render the icon
        lucide.createIcons();
    }

    function createPost() {
        const txt = document.getElementById('postInput').value.trim();
        if(!txt && !selectedImageBase64 && !selectedVideoBase64) return showToast("Type something or add media!");
        
        const visibility = document.getElementById('postVisibility').value || 'public';
        
        // NORMALIZED: Only store UID, fetch user data when displaying
        const postData = {
            uid: auth.currentUser.uid, // ONLY user reference
            content: txt,
            mood: selectedMood,
            image: selectedImageBase64,
            video: selectedVideoBase64,
            timestamp: Date.now(),
            likes: 0,
            visibility: visibility
        };
        
        db.ref('socialPosts').push(postData);
        document.getElementById('postInput').value = "";
        document.getElementById('postVisibility').value = 'public'; // Reset to default
        removePostImage();
        removePostVideo();
        document.querySelectorAll('.mood-chip').forEach(c => c.classList.remove('active'));
        selectedMood = null;
        showToast("Posted!");
        playSound('pop');
    }

    function togglePostMenu(postKey) {
        const menu = document.getElementById('post-menu-' + postKey);
        if (!menu) return;
        
        // Close all other menus
        document.querySelectorAll('.post-overflow-menu').forEach(m => {
            if (m.id !== 'post-menu-' + postKey) {
                m.classList.remove('show');
            }
        });
        
        // Toggle current menu
        menu.classList.toggle('show');
    }

    // Close menu when clicking outside
    document.addEventListener('click', (e) => {
        if (!e.target.closest('.post-overflow-btn') && !e.target.closest('.post-overflow-menu')) {
            document.querySelectorAll('.post-overflow-menu').forEach(m => {
                m.classList.remove('show');
            });
        }
    });

    function deletePost(postKey) {
        // Close the overflow menu
        const menu = document.getElementById('post-menu-' + postKey);
        if (menu) menu.classList.remove('show');
        
        if(!confirm("Are you sure you want to delete this post?")) {
            return;
        }
        
        const ANIMATION_DURATION = 300;
        
        // Soft delete: mark as deleted instead of removing
        // Note: Firebase security rules should verify that auth.uid matches the post author's uid
        db.ref('socialPosts/' + postKey).update({
            deleted: true,
            deletedAt: Date.now()
        }).then(() => {
            // Remove from DOM immediately
            const postElement = document.getElementById('post-' + postKey);
            if(postElement) {
                postElement.style.transition = `opacity ${ANIMATION_DURATION}ms ease`;
                postElement.style.opacity = '0';
                setTimeout(() => postElement.remove(), ANIMATION_DURATION);
            }
            showToast("Post deleted");
            playSound('pop');
        }).catch(err => {
            console.error("Error deleting post:", err);
            showToast("Failed to delete post");
        });
    }

    let currentProfileUid = null;

    function openMyProfile() {
        openUserProfile(auth.currentUser.uid);
    }

    function openUserProfile(uid) {
        currentProfileUid = uid;
        document.getElementById('userOptionsModal').style.display = 'none';
        document.getElementById('userProfilePage').style.display = 'flex';
        
        document.getElementById('pageProfileFeed').innerHTML = "<div style='color:white; opacity:0.5; text-align:center; padding: var(--spacing-lg);'>Loading...</div>";
        document.getElementById('profileMainActionBtn').style.display = 'none';
        document.getElementById('unfriendBtn').style.display = 'none';

        db.ref('users/' + uid).once('value', s => {
            const u = s.val();
            // Inject avatar (without ranking badge)
            document.getElementById('pageProfileAvatarContainer').innerHTML = renderAvatarWithBadge(sanitizeUrl(u.photo || 'https://via.placeholder.com/100'), u.bingoWins || 0, 140, uid);
            
            // Set name with verification badge if verified
            const verificationBadge = u.verified ? `<span class="verified-badge" onclick="showVerificationInfo(event)"><i data-lucide="check" style="width:10px; height:10px; color:white;"></i></span>` : '';
            document.getElementById('pageProfileName').innerHTML = `${escapeHtml(u.name)}${verificationBadge}`;
            document.getElementById('pageProfileBio').innerText = u.bio || "Radio Bingo Player";
            
            if(u.cover) {
                document.getElementById('pageProfileCover').style.backgroundImage = `url('${u.cover}')`;
            } else {
                document.getElementById('pageProfileCover').style.background = '#334155';
                document.getElementById('pageProfileCover').style.backgroundImage = 'none';
            }
            
            updateProfileButtonState(uid);
            
            db.ref('friends/' + uid).once('value', fSnap => {
                document.getElementById('statFriends').innerText = fSnap.numChildren() || 0;
            });
            
            loadProfilePosts(uid);
            lucide.createIcons();
        });
    }

    function closeProfilePage() {
        document.getElementById('userProfilePage').style.display = 'none';
        currentProfileUid = null;
    }
    
    // Show verification badge info tooltip
    function showVerificationInfo(event) {
        event.stopPropagation();
        const tooltip = document.getElementById('verificationTooltip');
        const rect = event.target.getBoundingClientRect();
        
        // Position tooltip near the badge
        tooltip.style.left = rect.left + 'px';
        tooltip.style.top = (rect.bottom + 10) + 'px';
        tooltip.style.display = 'block';
        
        // Re-initialize lucide icons in tooltip
        setTimeout(() => lucide.createIcons(), 10);
        
        // Hide tooltip when clicking anywhere else
        setTimeout(() => {
            document.addEventListener('click', hideVerificationTooltip);
        }, 10);
    }
    
    function hideVerificationTooltip(event) {
        const tooltip = document.getElementById('verificationTooltip');
        if (!tooltip.contains(event.target)) {
            tooltip.style.display = 'none';
            document.removeEventListener('click', hideVerificationTooltip);
        }
    }
    
    // Toggle profile dropdown menu
    function toggleProfileMenu(event) {
        event.stopPropagation();
        const dropdown = document.getElementById('profileDropdown');
        dropdown.classList.toggle('show');
        
        // Close menu when clicking outside
        setTimeout(() => {
            document.addEventListener('click', closeProfileMenuOnClickOutside);
        }, 10);
    }
    
    function closeProfileMenuOnClickOutside(event) {
        const dropdown = document.getElementById('profileDropdown');
        const menuBtn = document.getElementById('profileMenuBtn');
        
        if (!dropdown.contains(event.target) && event.target !== menuBtn) {
            dropdown.classList.remove('show');
            document.removeEventListener('click', closeProfileMenuOnClickOutside);
        }
    }
    
    // Request verification badge with requirements
    async function requestVerificationBadge() {
        const dropdown = document.getElementById('profileDropdown');
        dropdown.classList.remove('show');
        
        const user = auth.currentUser;
        if (!user) return;
        
        try {
            // Fetch user data to check requirements
            const userSnapshot = await db.ref(`users/${user.uid}`).once('value');
            const userData = userSnapshot.val();
            
            if (userData.verified) {
                showToast('✓ You already have a verification badge!');
                return;
            }
            
            if (userData.verificationStatus === 'pending') {
                showToast('⏳ Your verification request is pending review');
                return;
            }
            
            // Check verification requirements
            const accountAge = Date.now() - (userData.createdAt || 0);
            const daysSinceCreation = Math.floor(accountAge / (1000 * 60 * 60 * 24));
            
            // Fetch friend count
            const friendsSnapshot = await db.ref(`friends/${user.uid}`).once('value');
            const friendCount = friendsSnapshot.numChildren();
            
            // Fetch post count
            const postsSnapshot = await db.ref('posts').orderByChild('uid').equalTo(user.uid).once('value');
            const postCount = postsSnapshot.numChildren();
            
            // Define requirements
            const REQUIREMENTS = {
                minFriends: 10,
                minPosts: 5,
                minAccountAgeDays: 7,
                minBingoWins: 3
            };
            
            // Check each requirement
            const failedRequirements = [];
            
            if (friendCount < REQUIREMENTS.minFriends) {
                failedRequirements.push(`✗ At least ${REQUIREMENTS.minFriends} friends (You have: ${friendCount})`);
            }
            
            if (postCount < REQUIREMENTS.minPosts) {
                failedRequirements.push(`✗ At least ${REQUIREMENTS.minPosts} posts (You have: ${postCount})`);
            }
            
            if (daysSinceCreation < REQUIREMENTS.minAccountAgeDays) {
                failedRequirements.push(`✗ Account at least ${REQUIREMENTS.minAccountAgeDays} days old (Yours: ${daysSinceCreation} days)`);
            }
            
            if ((userData.bingoWins || 0) < REQUIREMENTS.minBingoWins) {
                failedRequirements.push(`✗ At least ${REQUIREMENTS.minBingoWins} bingo wins (You have: ${userData.bingoWins || 0})`);
            }
            
            // If requirements not met, show detailed message
            if (failedRequirements.length > 0) {
                const requirementsList = failedRequirements.join('\n');
                showCustomConfirm(
                    'VERIFICATION REQUIREMENTS NOT MET',
                    `You need to meet these requirements to request verification:\n\n${requirementsList}\n\nKeep playing and growing your profile!`,
                    null,
                    'OK',
                    null,
                    true // Single button mode
                );
                return;
            }
            
            // All requirements met - show confirmation with textarea for reason
            const meetsRequirements = `You meet all requirements for verification:

✓ ${friendCount} friends (Required: ${REQUIREMENTS.minFriends})
✓ ${postCount} posts (Required: ${REQUIREMENTS.minPosts})
✓ ${daysSinceCreation} days old (Required: ${REQUIREMENTS.minAccountAgeDays})
✓ ${userData.bingoWins || 0} wins (Required: ${REQUIREMENTS.minBingoWins})

Please explain why you want a verification badge:`;
            
            showCustomConfirm(
                'REQUEST VERIFICATION BADGE',
                meetsRequirements,
                async (reason) => {
                    try {
                        await db.ref(`users/${user.uid}`).update({
                            verificationStatus: 'pending',
                            verificationReason: reason,
                            verificationRequestedAt: Date.now(),
                            verificationMetrics: {
                                friendsAtRequest: friendCount,
                                postsAtRequest: postCount,
                                accountAgeDaysAtRequest: daysSinceCreation,
                                winsAtRequest: userData.bingoWins || 0
                            }
                        });
                        
                        showToast('✓ Verification request submitted! Please wait for admin approval.');
                    } catch (err) {
                        console.error('Error submitting verification request:', err);
                        showToast('✗ Failed to submit request. Please try again.');
                    }
                },
                'SUBMIT REQUEST',
                'CANCEL',
                false,
                true // Show textarea
            );
        } catch (err) {
            console.error('Error requesting verification:', err);
            showToast('✗ Error processing request');
        }
    }
    
    // Open settings (placeholder - you can implement later)
    function openSettings() {
        const dropdown = document.getElementById('profileDropdown');
        dropdown.classList.remove('show');
        
        // For now, just open edit profile
        openEditProfile();
    }

    function updateProfileButtonState(uid) {
        const btn = document.getElementById('profileMainActionBtn');
        const unfriendBtn = document.getElementById('unfriendBtn');
        const giftSkinBtn = document.getElementById('giftSkinBtn');
        const menuBtn = document.getElementById('profileMenuBtn');
        const myUid = auth.currentUser.uid;
        
        unfriendBtn.style.display = 'none';
        giftSkinBtn.style.display = 'none';
        menuBtn.style.display = 'none';
        
        if(uid === myUid) {
            btn.innerText = "Edit Profile";
            btn.className = "profile-action-btn secondary";
            btn.onclick = openEditProfile;
            btn.style.display = 'block';
            
            // Show 3-dot menu button for own profile
            menuBtn.style.display = 'flex';
        } else {
            // Show Gift Skin button for other users
            giftSkinBtn.style.display = 'block';
            giftSkinBtn.onclick = () => openGiftModal(uid);
            
            db.ref('friends/' + myUid + '/' + uid).once('value', s => {
                if(s.exists()) {
                    btn.innerText = "Message";
                    btn.className = "profile-action-btn";
                    btn.onclick = () => openPrivateChat(uid, document.getElementById('pageProfileName').innerText, document.getElementById('pageProfileImg').src); 
                    unfriendBtn.style.display = 'flex'; // Show modern unfriend
                } else {
                     db.ref('friendRequests/' + uid + '/' + myUid).once('value', reqSnap => {
                         if(reqSnap.exists()) {
                             btn.innerText = "Cancel Request";
                             btn.className = "profile-action-btn secondary";
                             btn.onclick = () => {
                                 db.ref('friendRequests/' + uid + '/' + myUid).remove();
                                 updateProfileButtonState(uid);
                                 showToast("Request Cancelled");
                             };
                         } else {
                             btn.innerText = "Add Friend";
                             btn.className = "profile-action-btn";
                             btn.onclick = () => {
                                 db.ref('friendRequests/' + uid + '/' + myUid).set(true);
                                 updateProfileButtonState(uid);
                                 showToast("Request Sent!");
                             };
                         }
                     });
                }
                btn.style.display = 'block';
            });
        }
    }
    
    function loadProfilePosts(uid) {
        const container = document.getElementById('pageProfileFeed');
        
        // Check if this profile user is a friend
        db.ref('friends/' + auth.currentUser.uid + '/' + uid).once('value', friendSnap => {
            const isFriend = friendSnap.exists();
            const isMe = uid === auth.currentUser.uid;
            
            db.ref('socialPosts').orderByChild('uid').equalTo(uid).limitToLast(20).once('value', pSnap => {
                container.innerHTML = "";
                let count = 0;
                let likes = 0;
                const posts = [];
                pSnap.forEach(c => {
                    const p = c.val();
                    if(!p.deleted) {
                        posts.push({ key: c.key, ...p });
                        count++;
                        likes += (p.likes || 0);
                    }
                });
                
                document.getElementById('statPosts').innerText = count;
                document.getElementById('statLikes').innerText = likes;
                
                posts.reverse().forEach(post => {
                    const div = createPostElement(post, isFriend || isMe);
                    container.appendChild(div);
                    loadCommentPreview(post.key);
                    loadReactionSummary(post.key);
                });
                
                if(count === 0) container.innerHTML = "<div style='color:white; opacity:0.5; font-size:12px; text-align:center; padding: var(--spacing-lg);'>No posts yet</div>";
                lucide.createIcons();
            });
        });
    }

    function openEditProfile() {
        document.getElementById('editNameIn').value = userData.name;
        document.getElementById('editBioIn').value = userData.bio || "";
        document.getElementById('editProfileModal').style.display = 'flex';
    }

    function handleProfileUpload(input, type) {
        if(input.files && input.files[0]) {
            // Upload to Cloudinary
            uploadToCloudinary(input.files[0], 'image').then(url => {
                if(url) {
                    input.dataset.cloudinaryUrl = url;
                    showToast("Image uploaded! Click Save.");
                }
            });
        }
    }

    function saveProfileChanges() {
        const newName = document.getElementById('editNameIn').value.trim();
        const newBio = document.getElementById('editBioIn').value.trim();
        
        const pfpInput = document.getElementById('editProfilePicInput');
        const coverInput = document.getElementById('editCoverPicInput');
        
        if(newName.length < 2) return showToast("Name too short");
        
        const updates = {
            name: newName,
            bio: newBio
        };
        
        if(pfpInput.dataset.cloudinaryUrl) updates.photo = pfpInput.dataset.cloudinaryUrl;
        if(coverInput.dataset.cloudinaryUrl) updates.cover = coverInput.dataset.cloudinaryUrl;
        
        // Update user profile
        db.ref('users/' + auth.currentUser.uid).update(updates).then(() => {
            // Update userData object
            userData.name = newName;
            userData.bio = newBio;
            if(updates.photo) userData.photo = updates.photo;
            if(updates.cover) userData.cover = updates.cover;
            
            // NORMALIZED: No need to update posts! User data is fetched from users table.
            // When posts are displayed, they will automatically show the updated name/photo.
            showToast("Profile Updated!");
            document.getElementById('editProfileModal').style.display = 'none';
            // Clear inputs
            pfpInput.value = ""; delete pfpInput.dataset.cloudinaryUrl;
            coverInput.value = ""; delete coverInput.dataset.cloudinaryUrl;
            openMyProfile(); // Refresh
        });
    }

    // === GIFT SKIN FUNCTIONS ===
    function openGiftModal(recipientId) {
        // Fetch recipient data first
        db.ref('users/' + recipientId).once('value', recipientSnap => {
            const recipient = recipientSnap.val();
            if(!recipient) {
                showToast("User not found");
                return;
            }
            
            const recipientOwnedSkins = recipient.ownedSkins || ['default'];
            const recipientName = recipient.name;
            
            // Update modal title
            document.getElementById('giftModalTitle').innerText = `Gift a Skin to ${recipientName}`;
            
            // Populate skins list
            const skinsList = document.getElementById('giftableSkinsList');
            skinsList.innerHTML = '';
            
            Object.entries(skinShop).forEach(([skinId, skin]) => {
                const div = document.createElement('div');
                div.className = 'skin-item';
                
                const isOwned = recipientOwnedSkins.includes(skinId);
                
                div.innerHTML = `
                    <div class="skin-preview" style="${skin.preview}">B</div>
                    <div class="skin-name">${skin.name}</div>
                    <div class="skin-cost">${skin.cost.toLocaleString()} Coins</div>
                    <button class="btn-buy-skin ${isOwned ? 'owned' : 'buy'}" ${isOwned ? 'disabled' : ''}>
                        ${isOwned ? 'Already Owned' : 'GIFT'}
                    </button>
                `;
                
                if(!isOwned) {
                    const btn = div.querySelector('button');
                    btn.onclick = () => confirmSkinGift(recipientId, skinId, recipientName);
                }
                
                skinsList.appendChild(div);
            });
            
            // Show modal
            document.getElementById('giftSkinModal').style.display = 'flex';
            lucide.createIcons();
        });
    }
    
    function confirmSkinGift(recipientId, skinId, recipientName) {
        const skin = skinShop[skinId];
        if(!skin) {
            showToast("Skin not found");
            return;
        }
        
        // Check if sender has enough points
        if(userData.points < skin.cost) {
            showToast("Insufficient Coins");
            return;
        }
        
        // Show confirmation dialog
        showCustomConfirm(
            "GIFT SKIN?",
            `Gift the ${skin.name} skin to ${recipientName} for ${skin.cost.toLocaleString()} Coins?`,
            () => executeSkinGift(recipientId, skinId)
        );
    }
    
    function executeSkinGift(recipientId, skinId) {
        const skin = skinShop[skinId];
        if(!skin) {
            showToast("Skin not found");
            return;
        }
        
        const senderId = auth.currentUser.uid;
        const senderName = userData.name;
        
        // 1. Deduct points from sender using transaction
        db.ref('users/' + senderId + '/points').transaction(currentPoints => {
            const points = currentPoints || 0;
            if(points >= skin.cost) {
                return points - skin.cost;
            } else {
                return undefined; // Abort transaction explicitly
            }
        }, (error, committed, snapshot) => {
            if(error) {
                showToast("Transaction failed");
                console.error(error);
                return;
            }
            
            if(!committed) {
                showToast("Insufficient Coins");
                return;
            }
            
            // 2. Add skin to recipient's ownedSkins array
            db.ref('users/' + recipientId + '/ownedSkins').transaction(currentSkins => {
                const skins = currentSkins || ['default'];
                if(!skins.includes(skinId)) {
                    skins.push(skinId);
                }
                return skins;
            }, (error2, committed2) => {
                if(error2 || !committed2) {
                    console.error("Failed to add skin to recipient:", error2);
                    showToast("Gift failed! Contact support.");
                    // Note: In production, implement compensating transaction to refund sender
                    return;
                }
                
                // 3. Create notification for recipient (only after successful skin transfer)
                db.ref('notifications/' + recipientId).push({
                    msg: `${senderName} gifted you the ${skin.name} skin!`,
                    type: 'gift',
                    from: senderId,
                    time: Date.now()
                });
                
                // 4. Log the transaction (only after successful completion)
                db.ref('giftLogs').push({
                    from: senderId,
                    to: recipientId,
                    skinId: skinId,
                    cost: skin.cost,
                    timestamp: firebase.database.ServerValue.TIMESTAMP
                });
                
                // 5. UI Feedback
                document.getElementById('giftSkinModal').style.display = 'none';
                showToast("Gift sent successfully!");
                spawnFlyingCoins(10);
                playSound('win');
            });
        });
    }

    function openSearch() {
        document.getElementById('searchModal').style.display = 'flex';
        document.getElementById('searchInput').focus();
    }
    
    let searchTimeout = null;
    function handleSearch() {
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(() => {
            const q = document.getElementById('searchInput').value.toLowerCase().trim();
            const resDiv = document.getElementById('searchResults');
            if(q.length < 2) {
                resDiv.innerHTML = "<div style='text-align:center; opacity:0.5; padding: var(--spacing-lg);'>Type more to search...</div>";
                return;
            }
            resDiv.innerHTML = "<div style='text-align:center; opacity:0.5; padding: var(--spacing-lg);'>Searching...</div>";
            db.ref('users').once('value', s => {
                resDiv.innerHTML = "";
                let found = false;
                s.forEach(uSnap => {
                    const u = uSnap.val();
                    const uid = uSnap.key;
                    if(u.name.toLowerCase().includes(q)) {
                        found = true;
                        const div = document.createElement('div');
                        div.className = 'search-res-item';
                        div.onclick = () => {
                            document.getElementById('searchModal').style.display = 'none';
                            openUserProfile(uid);
                        };
                        div.innerHTML = `
                            <img src="${u.photo || 'https://via.placeholder.com/40'}" class="search-res-img">
                            <div style="font-size:14px; font-weight:700; color:white;">${u.name} ${getBadgeHtml(u.bingoWins || 0)}</div>
                        `;
                        resDiv.appendChild(div);
                    }
                });
                if(!found) resDiv.innerHTML = "<div style='text-align:center; opacity:0.5; padding: var(--spacing-lg);'>No users found.</div>";
                lucide.createIcons();
            });
        }, 500);
    }

    let currentOpenPostKey = null;

    function openComments(postKey) {
        currentOpenPostKey = postKey;
        const list = document.getElementById('commentList');
        list.innerHTML = "<div style='text-align:center; color:white; opacity:0.5; padding: var(--spacing-lg);'>Loading...</div>";
        document.getElementById('commentModal').style.display = 'flex';
        document.getElementById('commentModalBackdrop').style.display = 'block';
        
        db.ref('postComments/' + postKey).on('value', s => {
            list.innerHTML = "";
            if(!s.exists()) {
                list.innerHTML = "<div style='text-align:center; color:white; opacity:0.5; padding: var(--spacing-lg);'>No comments yet.</div>";
                return;
            }
            
            // NORMALIZED: Fetch user data for each comment
            s.forEach(c => {
                const com = c.val();
                
                db.ref('users/' + com.uid).once('value', userSnap => {
                    const user = userSnap.val();
                    if(!user) return;
                    
                    const div = document.createElement('div');
                    div.className = 'comment-item';
                    div.innerHTML = `
                        <img class="comment-avatar" src="${user.photo || 'https://via.placeholder.com/40'}">
                        <div class="comment-content-block">
                            <div class="comment-bubble">
                                <div class="comment-author">${escapeHtml(user.name)} ${getBadgeHtml(user.bingoWins || 0)}</div>
                                <div class="comment-text">${escapeHtml(com.text)}</div>
                            </div>
                            <div class="comment-actions">
                                <button class="cmt-action-btn" onclick="likeComment('${postKey}', '${c.key}')">Like</button>
                                <button class="cmt-action-btn" onclick="replyComment('${escapeHtml(user.name)}')">Reply</button>
                                <span>${fixDate(com.time)}</span>
                            </div>
                        </div>
                    `;
                    list.appendChild(div);
                    list.scrollTop = list.scrollHeight;
                    lucide.createIcons();
                });
            });
        });
    }
    
    function closeComments() {
        document.getElementById('commentModal').style.display = 'none';
        document.getElementById('commentModalBackdrop').style.display = 'none';
        db.ref('postComments/' + currentOpenPostKey).off(); 
        currentOpenPostKey = null;
        document.getElementById('commentInput').value = '';
        updateCommentPreview(); // Clear preview
    }

    function sendComment() {
        const txt = document.getElementById('commentInput').value.trim();
        if(!txt || !currentOpenPostKey) return;
        
        // NORMALIZED: Only store UID, fetch user data when displaying
        db.ref('postComments/' + currentOpenPostKey).push({
            uid: auth.currentUser.uid, // ONLY user reference
            text: txt,
            time: Date.now()
        });
        
        // Notify Author (Grouped logic handled in render but we push individual here)
        db.ref('socialPosts/' + currentOpenPostKey).once('value', s => {
             const p = s.val();
             if(p.uid !== auth.currentUser.uid) {
                 db.ref('notifications/' + p.uid).push({
                     msg: `${userData.name} commented on your post`,
                     time: Date.now(),
                     type: 'comment',
                     from: auth.currentUser.uid,
                     postId: currentOpenPostKey, // Link to post
                     image: userData.photo
                 });
             }
        });

        document.getElementById('commentInput').value = "";
        updateCommentPreview(); // Clear preview
    }
    
    function updateCommentPreview() {
        const input = document.getElementById('commentInput');
        const previewBox = document.getElementById('commentPreviewBox');
        const previewText = document.getElementById('commentPreviewText');
        const previewAvatar = document.getElementById('commentPreviewAvatar');
        
        const txt = input.value.trim();
        
        if(txt && userData) {
            previewBox.style.display = 'block';
            previewText.textContent = txt;
            previewAvatar.src = userData.photo || 'https://via.placeholder.com/40';
        } else {
            previewBox.style.display = 'none';
            previewText.textContent = '';
        }
    }
    
    function likeComment(postKey, commentKey) {
        showToast("Liked comment!");
    }
    
    function replyComment(name) {
        document.getElementById('commentInput').value = `@${name} `;
        document.getElementById('commentInput').focus();
        updateCommentPreview(); // Show preview for reply
    }

    function loadCommentPreview(postKey) {
        const previewContainer = document.getElementById('comment-preview-' + postKey);
        const previewList = document.getElementById('preview-list-' + postKey);
        
        if(!previewContainer || !previewList) return;
        
        db.ref('postComments/' + postKey).limitToLast(2).once('value', s => {
            if(!s.exists()) {
                previewContainer.style.display = 'none';
                return;
            }
            
            previewContainer.style.display = 'block';
            previewList.innerHTML = '';
            
            const comments = [];
            s.forEach(c => {
                comments.push({ key: c.key, ...c.val() });
            });
            
            // NORMALIZED: Fetch user data for each comment
            comments.forEach(com => {
                db.ref('users/' + com.uid).once('value', userSnap => {
                    const user = userSnap.val();
                    if(!user) return;
                    
                    const div = document.createElement('div');
                    div.className = 'preview-item';
                    div.style.marginBottom = '5px';
                    
                    const truncatedText = com.text.length > 50 ? com.text.substring(0, 50) + '...' : com.text;
                    const sanitizedText = escapeHtml(truncatedText);
                    const sanitizedName = escapeHtml(user.name);
                    
                    div.innerHTML = `
                        <button class="preview-user" onclick="openUserProfile('${com.uid}')" style="background:none; border:none; padding:0; font:inherit; cursor:pointer;" aria-label="View ${sanitizedName}'s profile">${sanitizedName}</button>
                        <span class="preview-text">${sanitizedText}</span>
                    `;
                    
                    previewList.appendChild(div);
                });
            });
        });
    }


    // === SHARE POST FUNCTIONS ===
    let currentSharePostKey = null;

    function openShareModal(postKey) {
        currentSharePostKey = postKey;
        
        // Check if Web Share API is available
        const nativeShareBtn = document.getElementById('nativeShareBtn');
        const copyLinkBtn = document.getElementById('copyLinkBtn');
        
        if (navigator.share) {
            nativeShareBtn.style.display = 'flex';
            copyLinkBtn.style.display = 'none';
        } else {
            nativeShareBtn.style.display = 'none';
            copyLinkBtn.style.display = 'flex';
        }
        
        // Get post data to show preview
        db.ref('socialPosts/' + postKey).once('value', s => {
            const post = s.val();
            if(!post) return;
            
            const sanitizedAuthor = escapeHtml(post.authorName);
            const sanitizedContent = escapeHtml(post.content || '');
            const truncatedContent = sanitizedContent.length > 100 ? sanitizedContent.substring(0, 100) + '...' : sanitizedContent;
            
            document.getElementById('sharePreview').innerHTML = `
                <div class="share-post-preview-author">${sanitizedAuthor}</div>
                <div class="share-post-preview-content">${truncatedContent}</div>
            `;
            
            document.getElementById('shareModal').style.display = 'flex';
            document.getElementById('shareModalBackdrop').style.display = 'block';
            setTimeout(() => lucide.createIcons(), 50);
        });
    }

    function closeShareModal() {
        document.getElementById('shareModal').style.display = 'none';
        document.getElementById('shareModalBackdrop').style.display = 'none';
        currentSharePostKey = null;
    }

    function shareToOwnProfile() {
        if(!currentSharePostKey) return;
        if(!auth.currentUser) return showToast("Please login first");
        if(!userData || !userData.name) {
            showToast("Loading profile...");
            return;
        }
        
        const caption = document.getElementById('shareCaption').value.trim();
        
        db.ref('socialPosts/' + currentSharePostKey).once('value', s => {
            const originalPost = s.val();
            if(!originalPost) {
                showToast("Post not found");
                return;
            }
            
            // NORMALIZED: Create a new post that references the original
            const shareData = {
                uid: auth.currentUser.uid, // ONLY sharer's UID
                content: caption, // User's caption
                timestamp: Date.now(),
                likes: 0,
                visibility: 'public', // Shared posts default to public
                isShared: true,
                sharedPostKey: currentSharePostKey,
                sharedFrom: originalPost.uid, // ONLY original author's UID
                sharedContent: originalPost.content,
                sharedImage: originalPost.image,
                sharedVideo: originalPost.video,
                sharedMood: originalPost.mood
            };
            
            db.ref('socialPosts').push(shareData).then(() => {
                // Notify original author
                if(originalPost.uid !== auth.currentUser.uid) {
                    db.ref('notifications/' + originalPost.uid).push({
                        msg: `${userData.name} shared your post`,
                        time: Date.now(),
                        type: 'share',
                        from: auth.currentUser.uid,
                        postId: currentSharePostKey,
                        image: userData.photo
                    });
                }
                
                document.getElementById('shareCaption').value = ''; // Clear caption
                showToast("Post shared successfully!");
                playSound('pop');
                closeShareModal();
            }).catch(err => {
                console.error("Share error:", err);
                showToast("Failed to share. Try again.");
            });
        });
    }

    function shareViaWebShare() {
        if(!currentSharePostKey) return;
        
        db.ref('socialPosts/' + currentSharePostKey).once('value', s => {
            const post = s.val();
            if(!post) return;
            
            const shareData = {
                title: 'Check out this post!',
                text: `${post.authorName}: ${post.content || 'Shared a post'}`,
                url: window.location.origin + '/?post=' + currentSharePostKey
            };
            
            if (navigator.share) {
                navigator.share(shareData)
                    .then(() => {
                        showToast("Shared successfully!");
                        playSound('pop');
                        closeShareModal();
                    })
                    .catch((error) => {
                        // Ignore user cancellations (AbortError, NotAllowedError)
                        if (error.name !== 'AbortError' && error.name !== 'NotAllowedError') {
                            console.error('Error sharing:', error);
                            showToast("Failed to share");
                        }
                    });
            } else {
                showToast("Sharing not supported");
            }
        });
    }

    function copyPostLink() {
        if(!currentSharePostKey) return;
        
        const postUrl = window.location.origin + '/?post=' + currentSharePostKey;
        
        if (navigator.clipboard && navigator.clipboard.writeText) {
            navigator.clipboard.writeText(postUrl)
                .then(() => {
                    showToast("Link copied to clipboard!");
                    playSound('pop');
                    closeShareModal();
                })
                .catch((error) => {
                    console.error('Error copying to clipboard:', error);
                    fallbackCopyToClipboard(postUrl);
                });
        } else {
            fallbackCopyToClipboard(postUrl);
        }
    }

    function fallbackCopyToClipboard(text) {
        const textArea = document.createElement('textarea');
        textArea.value = text;
        textArea.style.position = 'fixed';
        textArea.style.left = '-9999px';
        document.body.appendChild(textArea);
        textArea.select();
        
        try {
            // Last-resort fallback using deprecated document.execCommand
            // Required for Internet Explorer and Safari versions prior to 13.1
            // This is only called after modern Clipboard API fails or is unavailable
            document.execCommand('copy');
            showToast("Link copied to clipboard!");
            playSound('pop');
            closeShareModal();
        } catch (error) {
            console.error('Fallback copy failed:', error);
            showToast("Failed to copy link");
        }
        
        document.body.removeChild(textArea);
    }


    let postListener = null;
    let feedSortMethod = 'hype';

    function toggleFeedSort(method) {
        feedSortMethod = method;
        document.getElementById('sort-hype').classList.remove('active');
        document.getElementById('sort-new').classList.remove('active');
        document.getElementById('sort-' + method).classList.add('active');
        loadSocialFeed(); // Reload with new sort
    }

    function loadSocialFeed() {
        const feedContainer = document.getElementById('socialFeed');
        if(postListener) db.ref('socialPosts').off(); // Clear old listener

        feedContainer.innerHTML = "<div style='text-align:center; padding: var(--spacing-lg); opacity:0.5;'>Loading Feed...</div>";
        
        db.ref('friends/' + auth.currentUser.uid).once('value', fSnap => {
            const myFriends = fSnap.exists() ? Object.keys(fSnap.val()) : [];
            
            postListener = db.ref('socialPosts').limitToLast(50);
            postListener.on('value', pSnap => {
                const allPosts = [];
                pSnap.forEach(child => { 
                    const val = child.val();
                    if(typeof val === 'object' && val !== null && !val.deleted) {
                        // === RANKING ALGORITHM ===
                        // Hype Score = (Time Recency) + (Likes * Weight)
                        // Time is normalized to hours since epoch to keep numbers manageable, then small weight
                        // Actually easier: Score = Time + (Likes * 1000 * 60 * 60) -> 1 Like = 1 Hour of freshness
                        const likeCount = val.likes || 0;
                        const score = val.timestamp + (likeCount * 3600000); // Each like pushes it '1 hour' forward in timeline logic
                        
                        allPosts.push({ key: child.key, hypeScore: score, ...val }); 
                    }
                });
                
                if(feedSortMethod === 'hype') {
                    allPosts.sort((a, b) => b.hypeScore - a.hypeScore);
                } else {
                    allPosts.sort((a, b) => b.timestamp - a.timestamp);
                }
                
                const scrollPos = window.scrollY; 
                
                feedContainer.innerHTML = "";
                if(allPosts.length === 0) {
                    feedContainer.innerHTML = "<div style='text-align:center; padding: var(--spacing-lg); opacity:0.5;'>No posts yet. Be the first!</div>";
                    return;
                }
                
                let adCounter = 0;
                
                allPosts.forEach(post => {
                    const isFriend = myFriends.includes(post.uid);
                    const isMe = post.uid === auth.currentUser.uid;
                    
                    // === VISIBILITY FILTERING ===
                    const visibility = post.visibility || 'public'; // Default to public for old posts
                    
                    // Only Me: only author can see
                    if(visibility === 'private' && !isMe) return;
                    
                    // Friends Only: only friends and author can see
                    if(visibility === 'friends' && !isMe && !isFriend) return;
                    
                    // Public: everyone can see (no filtering needed)
                    
                    const div = createPostElement(post, isFriend || isMe);
                    feedContainer.appendChild(div);
                    loadCommentPreview(post.key);
                    loadReactionSummary(post.key);
                    
                    // === IN-FEED ADS INJECTION ===
                    adCounter++;
                    if(adCounter % 5 === 0) {
                         const adDiv = document.createElement('div');
                         adDiv.className = 'ad-container-global';
                         adDiv.style.margin = '15px auto';
                         adDiv.innerHTML = `
                            <script type="text/javascript">
                                atOptions = { 'key' : '59f94c5cb7bcd84edb277947774c3b9d', 'format' : 'iframe', 'height' : 50, 'width' : 320, 'params' : {} };
                            <\/script>
                            <script type="text/javascript" src="https://directoryeditorweep.com/59f94c5cb7bcd84edb277947774c3b9d/invoke.js"><\/script>
                         `;
                         feedContainer.appendChild(adDiv);
                    }
                });
                lucide.createIcons();
                
                if(document.getElementById('view-home').style.display !== 'none' && window.scrollY > 200) {
                     // Only restore scroll if we are down the page
                     setTimeout(() => window.scrollTo(0, scrollPos), 10);
                }
            });
        });
    }

    // === UNIVERSAL POST RENDERER ===
    // This function is used by BOTH main feed and profile pages
    // All post styling updates should be made here for consistency
    function createPostElement(post, isFriend) {
        const postDiv = document.createElement('div');
        postDiv.className = 'post-card';
        postDiv.id = 'post-' + post.key;
        
        // NORMALIZED: Fetch user data from users/{uid} instead of from post
        db.ref('users/' + post.uid).once('value', authorSnap => {
            const author = authorSnap.val();
            if (!author) {
                console.error('Author not found:', post.uid);
                return;
            }
            
            // Add Friend Icon Button (only show if not friend and not own post)
            const isOwnPost = post.uid === auth.currentUser.uid;
            const addFriendBtn = (!isFriend && !isOwnPost) ? `<button class="add-friend-icon-btn" onclick="event.stopPropagation(); sendFriendRequest('${post.uid}')" title="Add Friend"><i data-lucide="user-plus"></i></button>` : '';
            
            const moodHtml = post.mood ? `<div class="mood-display">Feeling ${post.mood}</div>` : '';
            const imgHtml = post.image ? `<div class="post-image-container"><img src="${post.image}" class="post-image"></div>` : '';
            const videoHtml = post.video ? `<div class="post-image-container"><video src="${post.video}" class="post-image" controls style="width:100%; max-height:400px;"></video></div>` : '';
            
            // Visibility indicator
            const visibility = post.visibility || 'public';
            let visibilityIconName = 'globe'; // public
            let visibilityText = 'Public';
            if(visibility === 'friends') {
                visibilityIconName = 'users';
                visibilityText = 'Friends';
            } else if(visibility === 'private') {
                visibilityIconName = 'lock';
                visibilityText = 'Only Me';
            }
            const visibilityBadge = `<span class="visibility-badge" title="${visibilityText}" style="margin-left:4px;"><i data-lucide="${visibilityIconName}" style="width:11px; height:11px;"></i></span>`;
            
            // NORMALIZED: Check if this is a shared post - fetch shared author data
            let sharedPostHtml = '';
            if(post.isShared && post.sharedContent !== undefined && post.sharedFrom) {
                // Fetch shared author data
                db.ref('users/' + post.sharedFrom).once('value', sharedAuthorSnap => {
                    const sharedAuthor = sharedAuthorSnap.val();
                    if(sharedAuthor) {
                        const sharedImgHtml = post.sharedImage ? `<div class="post-image-container"><img src="${post.sharedImage}" class="post-image"></div>` : '';
                        const sharedVideoHtml = post.sharedVideo ? `<div class="post-image-container"><video src="${post.sharedVideo}" class="post-image" controls style="width:100%; max-height:300px;"></video></div>` : '';
                        const sharedMoodHtml = post.sharedMood ? `<div class="mood-display">Feeling ${post.sharedMood}</div>` : '';
                        
                        const sharedPostContainer = postDiv.querySelector('.shared-post-placeholder');
                        if(sharedPostContainer) {
                            sharedPostContainer.innerHTML = `
                                <div class="shared-post-container">
                                    <div style="font-size:10px; color:#94a3b8; margin-bottom: var(--spacing-xs); display:flex; align-items:center; gap:5px;">
                                        <i data-lucide="share-2" style="width:12px;"></i>
                                        <span>Shared from ${escapeHtml(sharedAuthor.name)}</span>
                                    </div>
                                    <div style="display:flex; gap: var(--spacing-sm); align-items:flex-start;">
                                        <img src="${sharedAuthor.photo || 'https://via.placeholder.com/30'}" style="width:30px; height:30px; border-radius:50%; object-fit:cover;" onclick="openUserProfile('${post.sharedFrom}')">
                                        <div style="flex:1;">
                                            <div style="font-weight:700; font-size:11px; color:white; margin-bottom:3px;">${escapeHtml(sharedAuthor.name)}</div>
                                            ${sharedMoodHtml}
                                            <div style="font-size:12px; color:#cbd5e1; margin-top:5px;">${escapeHtml(post.sharedContent || '')}</div>
                                            ${sharedImgHtml}
                                            ${sharedVideoHtml}
                                        </div>
                                    </div>
                                </div>
                            `;
                            lucide.createIcons();
                        }
                    }
                });
            }
            
            postDiv.innerHTML = `
                <div class="post-header">
                    <img class="post-avatar" src="${author.photo || 'https://via.placeholder.com/40'}" onclick="openUserProfile('${post.uid}')">
                    <div class="post-meta">
                        <div class="post-author">
                            ${escapeHtml(author.name)} 
                            ${author.verified ? '<span class="verified-badge" onclick="showVerificationInfo(event)"><i data-lucide="check" style="width:10px; height:10px; color:white;"></i></span>' : ''} 
                            ${addFriendBtn}
                        </div>
                        <div class="post-time" style="display:flex; align-items:center;">${fixDate(post.timestamp)}${visibilityBadge}</div>
                        ${moodHtml}
                    </div>
                    ${isOwnPost ? `
                    <div style="position: relative;">
                        <button class="post-overflow-btn" onclick="togglePostMenu('${post.key}')" aria-label="Post options">
                            <i data-lucide="more-vertical" style="width:18px; height:18px;"></i>
                        </button>
                        <div class="post-overflow-menu" id="post-menu-${post.key}">
                            <button class="overflow-menu-item delete-item" onclick="deletePost('${post.key}')">
                                <i data-lucide="trash-2" style="width:14px;"></i>
                                Delete Post
                            </button>
                        </div>
                    </div>
                    ` : ''}
                </div>
                <div class="post-content">${escapeHtml(post.content || '')}</div>
                ${imgHtml}
                ${videoHtml}
                <div class="shared-post-placeholder"></div>
                <div class="reaction-summary-bar" id="reaction-summary-${post.key}" onclick="openReactionViewer('${post.key}')"></div>
                <div class="post-actions" style="position:relative;">
                    <button class="action-btn" id="like-btn-${post.key}" onclick="showReactionPopup('${post.key}')">
                        <i data-lucide="heart" id="like-icon-${post.key}" style="width:14px;"></i> 
                        <span id="like-count-wrapper-${post.key}" onclick="event.stopPropagation(); openReactionViewer('${post.key}')" onkeypress="if(event.key==='Enter'||event.key===' '){event.preventDefault();event.stopPropagation();openReactionViewer('${post.key}')}" role="button" tabindex="0" style="cursor:pointer; margin-left:4px;" aria-label="View who reacted to this post">
                            <span id="like-count-${post.key}">${post.likes || 0}</span>
                        </span>
                    </button>
                    <div id="react-pop-${post.key}" class="reaction-popup" onmouseleave="this.style.display='none'">
                        <span class="reaction-emoji" onclick="submitReaction('${post.key}', '${post.uid}', '❤️')">❤️</span>
                        <span class="reaction-emoji" onclick="submitReaction('${post.key}', '${post.uid}', '😂')">😂</span>
                        <span class="reaction-emoji" onclick="submitReaction('${post.key}', '${post.uid}', '😮')">😮</span>
                        <span class="reaction-emoji" onclick="submitReaction('${post.key}', '${post.uid}', '😢')">😢</span>
                    </div>
                    <button class="action-btn" onclick="openComments('${post.key}')">
                        <i data-lucide="message-circle" style="width:14px"></i> <span id="comment-btn-text-${post.key}">Comment</span>
                    </button>
                    <button class="action-btn" onclick="openShareModal('${post.key}')">
                        <i data-lucide="share-2" style="width:14px"></i> Share
                    </button>
                </div>
                <div id="comment-preview-${post.key}" class="comment-preview-area" style="display:none;">
                    <div id="preview-list-${post.key}" style="margin-bottom: var(--spacing-xs);"></div>
                    <button onclick="openComments('${post.key}')" style="background:none; border:none; color:var(--accent); font-size:11px; font-weight:700; cursor:pointer; padding:0;" aria-label="View all comments for this post">View all comments</button>
                </div>
            `;
            
            lucide.createIcons();
            
            // Load initial state (simple check if liked)
            db.ref('postLikes/' + post.key + '/' + auth.currentUser.uid).once('value', lSnap => {
                if(lSnap.exists()) {
                    const btn = postDiv.querySelector('#like-btn-' + post.key);
                    const reaction = lSnap.val(); // Get stored emoji
                    const sanitizedReaction = reaction === true ? '❤️' : escapeHtml(reaction);
                    if(btn) {
                        btn.classList.add('liked');
                        btn.innerHTML = `<span style="font-size:16px;">${sanitizedReaction}</span> <span id="like-count-wrapper-${post.key}" onclick="event.stopPropagation(); openReactionViewer('${post.key}')" onkeypress="if(event.key==='Enter'||event.key===' '){event.preventDefault();event.stopPropagation();openReactionViewer('${post.key}')}" role="button" tabindex="0" style="cursor:pointer; margin-left:4px;" aria-label="View who reacted to this post"><span id="like-count-${post.key}">${post.likes || 0}</span></span>`;
                    }
                }
            });
            
            // Load comment count
            db.ref('postComments/' + post.key).on('value', snapshot => {
                const count = snapshot.numChildren();
                const btnText = postDiv.querySelector('#comment-btn-text-' + post.key);
                if (btnText && count > 0) {
                    btnText.textContent = `${count}`;
                }
            });
        });
        
        return postDiv;
    }

    function loadReactionSummary(postKey) {
        db.ref('postLikes/' + postKey).on('value', s => {
            const bar = document.getElementById('reaction-summary-' + postKey);
            if (!bar) return;
            
            if (!s.exists()) {
                bar.innerHTML = '';
                return;
            }

            const counts = {};
            let totalReactions = 0;
            s.forEach(child => {
                let emoji = child.val();
                // Legacy compatibility: old reactions stored as boolean true, convert to heart emoji
                if (emoji === true) emoji = '❤️';
                counts[emoji] = (counts[emoji] || 0) + 1;
                totalReactions++;
            });

            // Sort by count descending and get top 3
            const sorted = Object.entries(counts).sort((a, b) => b[1] - a[1]);
            const topEmojis = sorted.slice(0, 3).map(([emoji]) => emoji);
            
            // Get comment count
            db.ref('postComments/' + postKey).once('value', commentSnapshot => {
                const commentCount = commentSnapshot.numChildren();
                
                // Build the reaction summary HTML
                const emojisHtml = topEmojis.map(emoji => `<span>${emoji}</span>`).join('');
                const reactionText = totalReactions === 1 ? '1 reaction' : `${totalReactions} reactions`;
                const commentText = commentCount > 0 ? (commentCount === 1 ? '1 comment' : `${commentCount} comments`) : '';
                
                bar.innerHTML = `
                    <div style="display: flex; align-items: center;">
                        <div class="reaction-emojis-group">${emojisHtml}</div>
                        <span class="reaction-count-text">${reactionText}</span>
                    </div>
                    ${commentText ? `<span class="comment-count-text">${commentText}</span>` : ''}
                `;
            });
        });
    }

    function showReactionPopup(postKey) {
        const pop = document.getElementById('react-pop-' + postKey);
        if(!pop) {
            console.error('Reaction popup not found for post:', postKey);
            return;
        }
        // Toggle
        if(pop.style.display === 'flex') pop.style.display = 'none';
        else {
            pop.style.display = 'flex';
            setTimeout(() => { 
                document.addEventListener('click', function close(e) {
                    if(!e.target.closest('#like-btn-'+postKey) && !e.target.closest('#react-pop-'+postKey)) {
                        pop.style.display = 'none';
                        document.removeEventListener('click', close);
                    }
                });
            }, 100);
        }
    }

    function submitReaction(postKey, authorUid, emoji) {
        if(!auth.currentUser) return showToast("Please login first");
        
        const myUid = auth.currentUser.uid;
        const likeRef = db.ref('postLikes/' + postKey + '/' + myUid);
        const pop = document.getElementById('react-pop-' + postKey);
        
        if(pop) pop.style.display = 'none'; // Hide popup

        likeRef.once('value', s => {
            if(s.exists() && s.val() === emoji) {
                // Remove reaction if same clicked
                likeRef.remove();
                db.ref('socialPosts/' + postKey + '/likes').transaction(l => (l || 1) - 1);
            } else {
                // New or Change reaction
                if(!s.exists()) {
                    db.ref('socialPosts/' + postKey + '/likes').transaction(l => (l || 0) + 1);
                     // Reward only on first interaction
                    const rewardHistoryRef = db.ref('rewardHistory/' + postKey + '/' + myUid);
                    rewardHistoryRef.once('value', histSnap => {
                        if(!histSnap.exists()) {
                            if(authorUid !== myUid && userData && userData.name) {
                                db.ref('users/' + authorUid + '/points').transaction(p => (p || 0) + 10);
                                db.ref('notifications/' + authorUid).push({
                                    msg: `${userData.name} reacted ${emoji} to your post`,
                                    time: Date.now(),
                                    type: 'like',
                                    from: myUid,
                                    postId: postKey,
                                    image: userData.photo || 'https://via.placeholder.com/40'
                                });
                            }
                            rewardHistoryRef.set(true); 
                        }
                    });
                }
                likeRef.set(emoji);
            }
        });
    }

    let currentReactionPostKey = null;

    function openReactionViewer(postKey) {
        currentReactionPostKey = postKey;
        const modal = document.getElementById('reactionViewerModal');
        const backdrop = document.getElementById('reactionViewerBackdrop');
        const list = document.getElementById('reactionViewerList');
        
        modal.style.display = 'flex';
        backdrop.style.display = 'block';
        list.innerHTML = "<div style='text-align:center; color:white; opacity:0.5; padding: var(--spacing-lg);'>Loading...</div>";
        
        // Fetch all reactions for this post
        db.ref('postLikes/' + postKey).once('value', s => {
            list.innerHTML = "";
            
            if(!s.exists()) {
                list.innerHTML = "<div style='text-align:center; color:white; opacity:0.5; padding: var(--spacing-lg);'>No reactions yet</div>";
                return;
            }
            
            const reactions = [];
            s.forEach(child => {
                reactions.push({
                    uid: child.key,
                    emoji: child.val()
                });
            });
            
            // Fetch user details for each reactor
            let processed = 0;
            reactions.forEach(reaction => {
                db.ref('users/' + reaction.uid).once('value', uSnap => {
                    const user = uSnap.val();
                    if(user) {
                        const div = document.createElement('div');
                        div.className = 'reaction-viewer-item';
                        div.onclick = () => {
                            closeReactionViewer();
                            openUserProfile(reaction.uid);
                        };
                        div.setAttribute('role', 'button');
                        div.setAttribute('tabindex', '0');
                        div.onkeypress = (e) => {
                            if (e.key === 'Enter' || e.key === ' ') {
                                e.preventDefault();
                                closeReactionViewer();
                                openUserProfile(reaction.uid);
                            }
                        };
                        
                        const sanitizedName = escapeHtml(user.name);
                        const sanitizedPhoto = sanitizeUrl(user.photo || 'https://via.placeholder.com/40');
                        
                        div.innerHTML = `
                            <img class="reaction-viewer-avatar" src="${sanitizedPhoto}" alt="${sanitizedName}'s profile picture">
                            <div class="reaction-viewer-info">
                                <div class="reaction-viewer-name">${sanitizedName}</div>
                            </div>
                            <div class="reaction-viewer-emoji">${reaction.emoji === true ? '❤️' : escapeHtml(reaction.emoji)}</div>
                        `;
                        
                        list.appendChild(div);
                    }
                    
                    processed++;
                    if(processed === reactions.length) {
                        lucide.createIcons();
                    }
                });
            });
        });
    }

    function closeReactionViewer() {
        document.getElementById('reactionViewerModal').style.display = 'none';
        document.getElementById('reactionViewerBackdrop').style.display = 'none';
        currentReactionPostKey = null;
    }

    // Remove splash screen immediately
    setTimeout(() => {
        const ss = document.getElementById('splash-screen');
        if (ss) {
            ss.style.opacity = '0';
            setTimeout(() => ss.style.display = 'none', 500);
        }
    }, 1500); // Remove after 1.5 seconds
    
</script>

<!-- Fullscreen Photo Viewer -->
<div class="fullscreen-photo-viewer" id="fullscreenPhotoViewer">
    <div class="fullscreen-header">
        <button class="fullscreen-close-btn" onclick="closeFullscreenPhoto()">
            <i data-lucide="x"></i>
        </button>
        <div style="flex: 1;"></div>
        <button class="fullscreen-menu-btn" onclick="togglePhotoMenu(event)">
            <i data-lucide="more-vertical"></i>
            <div class="photo-menu-dropdown" id="photoMenuDropdown">
                <div class="photo-menu-item" onclick="downloadCurrentMedia()">
                    <i data-lucide="download"></i>
                    <span id="downloadMenuText">Download</span>
                </div>
            </div>
        </button>
    </div>
    
    <div class="fullscreen-photo-container" id="fullscreenMediaContainer">
        <img id="fullscreenPhotoImg" src="" alt="Fullscreen Photo" style="display:none;">
        <video id="fullscreenVideoPlayer" controls style="display:none;"></video>
    </div>
    
    <div class="fullscreen-footer">
        <button class="fullscreen-action-btn" id="fullscreenLikeBtn" onclick="handleFullscreenLike()">
            <i data-lucide="heart"></i>
            <span id="fullscreenLikeCount">Like</span>
        </button>
        <button class="fullscreen-action-btn" onclick="handleFullscreenComment()">
            <i data-lucide="message-circle"></i>
            <span id="fullscreenCommentCount">Comment</span>
        </button>
        <button class="fullscreen-action-btn" onclick="handleFullscreenShare()">
            <i data-lucide="share-2"></i>
            <span>Share</span>
        </button>
    </div>
</div>

<!-- Verification Badge Tooltip -->
<div id="verificationTooltip" class="verification-tooltip">
    <h4>
        <span class="verified-badge" style="cursor: default;">
            <i data-lucide="check" style="width:10px; height:10px; color:white;"></i>
        </span>
        Verified Account
    </h4>
    <p>This account has been verified by administrators. Verified accounts have met community standards and are confirmed to be authentic active members of the Radio Bingo Live community.</p>
</div>

<script>
    // === FULLSCREEN PHOTO/VIDEO VIEWER FUNCTIONS ===
    let currentPhotoPostKey = null;
    let currentPhotoData = null;
    let currentMediaType = 'image'; // 'image' or 'video'
    let currentMediaUrl = '';
    
    function openFullscreenPhoto(mediaUrl, postKey, mediaType = 'image') {
        currentPhotoPostKey = postKey;
        currentMediaType = mediaType;
        currentMediaUrl = mediaUrl;
        
        const viewer = document.getElementById('fullscreenPhotoViewer');
        const img = document.getElementById('fullscreenPhotoImg');
        const video = document.getElementById('fullscreenVideoPlayer');
        const downloadText = document.getElementById('downloadMenuText');
        
        // Show appropriate media element
        if (mediaType === 'video') {
            img.style.display = 'none';
            video.style.display = 'block';
            video.src = mediaUrl;
            video.load();
            downloadText.textContent = 'Download Video';
        } else {
            video.style.display = 'none';
            img.style.display = 'block';
            img.src = mediaUrl;
            downloadText.textContent = 'Download Photo';
        }
        
        viewer.classList.add('active');
        document.body.style.overflow = 'hidden';
        
        // Load post data
        loadFullscreenPostData(postKey);
        
        setTimeout(() => lucide.createIcons(), 100);
    }
    
    function closeFullscreenPhoto() {
        const viewer = document.getElementById('fullscreenPhotoViewer');
        const video = document.getElementById('fullscreenVideoPlayer');
        
        viewer.classList.remove('active');
        document.body.style.overflow = '';
        
        // Stop video if playing
        if (video) {
            video.pause();
            video.src = '';
        }
        
        currentPhotoPostKey = null;
        currentPhotoData = null;
        currentMediaType = 'image';
        currentMediaUrl = '';
        
        // Close dropdown if open
        document.getElementById('photoMenuDropdown').classList.remove('show');
    }
    
    function togglePhotoMenu(event) {
        event.stopPropagation();
        const dropdown = document.getElementById('photoMenuDropdown');
        dropdown.classList.toggle('show');
        
        if (dropdown.classList.contains('show')) {
            setTimeout(() => {
                document.addEventListener('click', function closeMenu(e) {
                    if (!e.target.closest('.photo-menu-dropdown') && !e.target.closest('.fullscreen-menu-btn')) {
                        dropdown.classList.remove('show');
                        document.removeEventListener('click', closeMenu);
                    }
                });
            }, 100);
        }
    }
    
    function downloadCurrentMedia() {
        const link = document.createElement('a');
        link.href = currentMediaUrl;
        
        if (currentMediaType === 'video') {
            link.download = `radio-bingo-video-${Date.now()}.mp4`;
            showToast('📥 Downloading video...');
        } else {
            link.download = `radio-bingo-photo-${Date.now()}.jpg`;
            showToast('📥 Downloading photo...');
        }
        
        link.target = '_blank';
        link.rel = 'noopener noreferrer';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        
        document.getElementById('photoMenuDropdown').classList.remove('show');
    }
    
    // Legacy function name support
    function downloadCurrentPhoto() {
        downloadCurrentMedia();
    }
    
    function loadFullscreenPostData(postKey) {
        if (!postKey) return;
        
        // Fetch post data from Firebase
        db.ref('socialPosts/' + postKey).once('value', snap => {
            if (!snap.exists()) return;
            
            currentPhotoData = snap.val();
            const likeCount = currentPhotoData.likes || 0;
            
            // Update like count display
            document.getElementById('fullscreenLikeCount').textContent = likeCount > 0 ? likeCount : 'Like';
            
            // Check if current user liked this
            if (auth.currentUser) {
                db.ref('postLikes/' + postKey + '/' + auth.currentUser.uid).once('value', likeSnap => {
                    const likeBtn = document.getElementById('fullscreenLikeBtn');
                    if (likeSnap.exists()) {
                        likeBtn.classList.add('liked');
                    } else {
                        likeBtn.classList.remove('liked');
                    }
                    lucide.createIcons();
                });
            }
            
            // Load comment count
            db.ref('postComments/' + postKey).once('value', commentSnap => {
                const commentCount = commentSnap.numChildren();
                document.getElementById('fullscreenCommentCount').textContent = commentCount > 0 ? commentCount : 'Comment';
            });
        });
    }
    
    function handleFullscreenLike() {
        if (!auth.currentUser) {
            closeFullscreenPhoto();
            return showToast("Please login first");
        }
        
        if (!currentPhotoPostKey) return;
        
        const myUid = auth.currentUser.uid;
        const likeRef = db.ref('postLikes/' + currentPhotoPostKey + '/' + myUid);
        const likeBtn = document.getElementById('fullscreenLikeBtn');
        const countSpan = document.getElementById('fullscreenLikeCount');
        
        likeRef.once('value', s => {
            if (s.exists()) {
                // Unlike
                likeRef.remove();
                db.ref('socialPosts/' + currentPhotoPostKey + '/likes').transaction(l => Math.max(0, (l || 1) - 1));
                likeBtn.classList.remove('liked');
                showToast('Like removed');
            } else {
                // Like
                likeRef.set('❤️');
                db.ref('socialPosts/' + currentPhotoPostKey + '/likes').transaction(l => (l || 0) + 1);
                likeBtn.classList.add('liked');
                showToast('❤️ Liked!');
                
                // Reward post author
                if (currentPhotoData && currentPhotoData.uid !== myUid) {
                    const rewardHistoryRef = db.ref('rewardHistory/' + currentPhotoPostKey + '/' + myUid);
                    rewardHistoryRef.once('value', histSnap => {
                        if (!histSnap.exists() && userData && userData.name) {
                            db.ref('users/' + currentPhotoData.uid + '/points').transaction(p => (p || 0) + 10);
                            db.ref('notifications/' + currentPhotoData.uid).push({
                                msg: `${userData.name} liked your ${currentMediaType === 'video' ? 'video' : 'photo'}`,
                                time: Date.now(),
                                type: 'like',
                                from: myUid,
                                postId: currentPhotoPostKey,
                                image: userData.photo || 'https://via.placeholder.com/40'
                            });
                            rewardHistoryRef.set(true);
                        }
                    });
                }
            }
            
            // Reload data
            loadFullscreenPostData(currentPhotoPostKey);
            lucide.createIcons();
        });
    }
    
    function handleFullscreenComment() {
        if (!currentPhotoPostKey) return;
        closeFullscreenPhoto();
        
        // Open comment modal for this post
        setTimeout(() => {
            openComments(currentPhotoPostKey);
        }, 300);
    }
    
    function handleFullscreenShare() {
        if (!currentPhotoPostKey) return;
        
        const shareData = {
            title: 'Radio Bingo Live',
            text: `Check out this ${currentMediaType === 'video' ? 'video' : 'photo'} on Radio Bingo Live!`,
            url: window.location.href
        };
        
        if (navigator.share) {
            navigator.share(shareData)
                .then(() => showToast('📤 Shared successfully!'))
                .catch(() => {});
        } else {
            // Fallback: copy link
            navigator.clipboard.writeText(window.location.href)
                .then(() => showToast('🔗 Link copied to clipboard!'))
                .catch(() => showToast('❌ Unable to share'));
        }
    }
    
    // Add click handler to post images - wrap existing renderPosts function
    const originalRenderPosts = window.renderPosts;
    if (originalRenderPosts) {
        window.renderPosts = function(...args) {
            originalRenderPosts.apply(this, args);
            
            // Add click handlers after posts render
            setTimeout(() => {
                // Handle images
                document.querySelectorAll('.post-card img[src*="http"]').forEach(img => {
                    if (!img.dataset.fullscreenEnabled && img.closest('.post-content, .post-media')) {
                        img.dataset.fullscreenEnabled = 'true';
                        img.style.cursor = 'pointer';
                        
                        const postCard = img.closest('.post-card');
                        const postKey = postCard ? postCard.dataset.postKey : null;
                        
                        img.addEventListener('click', function(e) {
                            e.preventDefault();
                            e.stopPropagation();
                            openFullscreenPhoto(img.src, postKey, 'image');
                        });
                    }
                });
                
                // Handle videos
                document.querySelectorAll('.post-card video').forEach(video => {
                    if (!video.dataset.fullscreenEnabled) {
                        video.dataset.fullscreenEnabled = 'true';
                        
                        const postCard = video.closest('.post-card');
                        const postKey = postCard ? postCard.dataset.postKey : null;
                        
                        // Add double-click handler for fullscreen
                        video.addEventListener('dblclick', function(e) {
                            e.preventDefault();
                            e.stopPropagation();
                            openFullscreenPhoto(video.src || video.currentSrc, postKey, 'video');
                        });
                        
                        // Add fullscreen button overlay
                        const wrapper = video.parentElement;
                        if (wrapper && !wrapper.querySelector('.video-fullscreen-overlay')) {
                            const overlay = document.createElement('div');
                            overlay.className = 'video-fullscreen-overlay';
                            overlay.style.cssText = 'position:absolute; top:8px; right:8px; background:rgba(0,0,0,0.7); padding:8px; border-radius:8px; cursor:pointer; z-index:10; backdrop-filter:blur(10px);';
                            overlay.innerHTML = '<i data-lucide="maximize-2" style="width:20px; height:20px; color:white;"></i>';
                            overlay.onclick = function(e) {
                                e.preventDefault();
                                e.stopPropagation();
                                openFullscreenPhoto(video.src || video.currentSrc, postKey, 'video');
                            };
                            
                            if (wrapper.style.position !== 'relative' && wrapper.style.position !== 'absolute') {
                                wrapper.style.position = 'relative';
                            }
                            wrapper.appendChild(overlay);
                            
                            setTimeout(() => lucide.createIcons(), 100);
                        }
                    }
                });
            }, 500);
        };
    }
</script>

</body>
</html>
