<!DOCTYPE html>
<html lang="tl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Radio Bingo Live | Official</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <style>
        :root { --bg: #0b1120; --surface: #1e293b; --surface-br: #334155; --accent: #3b82f6; --text: #f8fafc; --gold: #fbbf24; --success: #10b981; --danger: #ef4444; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        body { 
            font-family: 'Inter', sans-serif; 
            background: var(--bg); 
            color: var(--text); 
            margin: 0; 
            padding: 0; 
            display: flex; 
            flex-direction: column; 
            height: 100vh;
            overflow: hidden;
        }

        /* WINNING STYLES - DINAGDAG PARA SA VISUALS */
        .cell.win-pattern {
            background: var(--gold) !important;
            color: #000 !important;
            box-shadow: 0 0 15px var(--gold);
            z-index: 2;
            transform: scale(1.1);
        }

        .card-container.game-over {
            filter: grayscale(1) opacity(0.5);
            pointer-events: none;
            position: relative;
        }

        #loserOverlay {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0,0,0,0.8);
            padding: 20px;
            border-radius: 15px;
            text-align: center;
            z-index: 10;
            width: 80%;
            border: 2px solid var(--surface-br);
            display: none;
        }

        /* --- ORIGINAL STYLES MO (WALANG GALAW) --- */
        .top-nav { background: var(--surface); padding: 15px 20px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--surface-br); }
        .logo { font-weight: 900; font-size: 20px; letter-spacing: -1px; display: flex; align-items: center; gap: 8px; }
        .logo span { color: var(--accent); }
        
        .main-content { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 20px; padding-bottom: 100px; }
        
        .stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .stat-card { background: var(--surface); padding: 15px; border-radius: 20px; border: 1px solid var(--surface-br); position: relative; overflow: hidden; }
        .stat-label { font-size: 11px; font-weight: 700; opacity: 0.6; text-transform: uppercase; margin-bottom: 5px; display: block; }
        .stat-value { font-size: 20px; font-weight: 900; }

        .game-section { background: var(--surface); border-radius: 28px; padding: 20px; border: 1px solid var(--surface-br); position: relative; }
        .ball-display { background: var(--bg); border-radius: 20px; padding: 20px; text-align: center; margin-bottom: 20px; border: 1px solid var(--surface-br); }
        #currentBall { font-size: 48px; font-weight: 900; color: var(--accent); display: block; }
        
        .bingo-card { display: grid; grid-template-columns: repeat(5, 1fr); gap: 8px; margin-top: 15px; position: relative; }
        .cell { aspect-ratio: 1; background: var(--bg); border-radius: 12px; display: flex; align-items: center; justify-content: center; font-weight: 800; font-size: 16px; border: 1px solid var(--surface-br); transition: all 0.3s; }
        .cell.marked { background: var(--accent); border-color: var(--accent); color: white; }
        .cell.free { background: var(--gold); color: #000; font-size: 10px; font-weight: 900; }

        .bottom-nav { position: fixed; bottom: 0; width: 100%; background: var(--surface); display: flex; justify-content: space-around; padding: 15px; border-top: 1px solid var(--surface-br); }
        .nav-item { display: flex; flex-direction: column; align-items: center; gap: 5px; background: none; border: none; color: var(--text); opacity: 0.5; font-size: 10px; font-weight: 700; }
        .nav-item.active { opacity: 1; color: var(--accent); }

        .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.85); display: none; align-items: center; justify-content: center; z-index: 100; padding: 20px; backdrop-filter: blur(5px); }
        .modal-content { background: var(--surface); width: 100%; max-width: 400px; border-radius: 30px; padding: 30px; border: 1px solid var(--surface-br); }
        
        .shop-item { background: var(--bg); padding: 15px; border-radius: 15px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; }
        .history-item { padding: 15px; border-bottom: 1px solid var(--surface-br); display: flex; justify-content: space-between; }
        .status-pending { color: var(--gold); }
        .status-completed { color: var(--success); }
    </style>
</head>
<body>

    <div class="top-nav">
        <div class="logo"><i data-lucide="radio"></i> RADIO<span>BINGO</span></div>
        <div id="userPoints" style="font-weight: 900; color: var(--gold);">₱0.00</div>
    </div>

    <div class="main-content">
        <div class="stats-grid">
            <div class="stat-card">
                <span class="stat-label">Next Draw</span>
                <div class="stat-value" id="nextDrawTime">--:--</div>
            </div>
            <div class="stat-card">
                <span class="stat-label">Pattern</span>
                <div class="stat-value" id="gamePattern" style="font-size: 14px; color: var(--gold);">Normal Bingo</div>
            </div>
        </div>

        <div class="game-section">
            <div class="ball-display">
                <span class="stat-label">Now Drawing</span>
                <span id="currentBall">--</span>
            </div>
            
            <div id="cardContainer" style="position: relative;">
                <div id="loserOverlay">
                    <h2 style="color: var(--danger); margin: 0;">GAME OVER</h2>
                    <p id="winnerName" style="font-size: 14px; margin: 10px 0;"></p>
                    <p style="font-size: 12px; opacity: 0.7;">Bawi nalang next draw!</p>
                </div>
                <div class="bingo-card" id="bingoCard"></div>
            </div>

            <button onclick="checkBingo()" id="bingoBtn" style="width: 100%; margin-top: 20px; padding: 18px; border-radius: 18px; border: none; background: var(--accent); color: white; font-weight: 900; font-size: 16px; display: none;">BINGO!</button>
        </div>
    </div>

    <div id="shopModal" class="modal">
        <div class="modal-content">
            <h2 style="margin-top: 0;">Rewards Shop</h2>
            <div id="shopList"></div>
            <button onclick="closeModals()" style="width:100%; margin-top:20px; padding:15px; border-radius:15px; border:none; background:var(--surface-br); color:white;">Close</button>
        </div>
    </div>

    <div id="menuModal" class="modal">
        <div class="modal-content">
            <h2>Transaction History</h2>
            <div id="historyList" style="max-height: 300px; overflow-y: auto;"></div>
            <button onclick="closeModals()" style="width:100%; margin-top:20px; padding:15px; border-radius:15px; border:none; background:var(--surface-br); color:white;">Close</button>
        </div>
    </div>

    <nav class="bottom-nav">
        <button class="nav-item active"><i data-lucide="layout-grid"></i>Play</button>
        <button class="nav-item" onclick="openShop()"><i data-lucide="shopping-bag"></i>Shop</button>
        <button class="nav-item" onclick="openMenuModal()"><i data-lucide="history"></i>History</button>
    </nav>

<script>
    lucide.createIcons();
    const firebaseConfig = { apiKey: "AIzaSyDIAQXJ15atKJxu7PtcFL1W9JnO1N14pVs", authDomain: "radiobingo-9ac29.firebaseapp.com", databaseURL: "https://radiobingo-9ac29-default-rtdb.asia-southeast1.firebasedatabase.app", projectId: "radiobingo-9ac29", storageBucket: "radiobingo-9ac29.firebasestorage.app", messagingSenderId: "965903993397", appId: "1:965903993397:web:f6646fa05225f147eebf7c" };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const auth = firebase.auth();

    let myCard = [];
    let drawnNumbers = [];
    let currentPattern = "Normal Bingo";
    let hasWon = false;

    // LOGIN & INITIALIZATION
    auth.onAuthStateChanged(user => {
        if(user) {
            setupUser(user);
            initGameSync();
        } else {
            login();
        }
    });

    async function login() {
        const provider = new firebase.auth.GoogleAuthProvider();
        await auth.signInWithRedirect(provider);
    }

    function setupUser(user) {
        db.ref('users/' + user.uid).on('value', s => {
            if(!s.exists()) {
                db.ref('users/' + user.uid).set({
                    name: user.displayName,
                    photo: user.photoURL,
                    points: 0,
                    refCode: Math.floor(100000 + Math.random() * 900000).toString(),
                    joined: Date.now()
                });
            } else {
                document.getElementById('userPoints').innerText = '₱' + s.val().points.toFixed(2);
                if(s.val().hasWonCurrent) hasWon = true;
            }
        });
    }

    function initGameSync() {
        // Pattern & Schedule Sync
        db.ref('gameState').on('value', s => {
            const data = s.val();
            if(data) {
                currentPattern = data.currentPattern || "Normal Bingo";
                document.getElementById('gamePattern').innerText = currentPattern;
                document.getElementById('nextDrawTime').innerText = data.nextDraw || "--:--";
                
                // --- UPDATE: Winner Overlay Check ---
                if(data.latestWinner && data.latestWinner.uid !== auth.currentUser.uid) {
                    showLoserState(data.latestWinner.name);
                } else if(!data.latestWinner) {
                    hideOverlays();
                }
            }
        });

        // Balls Sync
        db.ref('drawnNumbers').on('value', s => {
            drawnNumbers = s.val() ? Object.values(s.val()) : [];
            const lastBall = drawnNumbers[drawnNumbers.length-1];
            document.getElementById('currentBall').innerText = lastBall || "--";
            if(drawnNumbers.length === 0) resetForNewGame();
            renderCard();
        });
    }

    function generateCard() {
        const card = [];
        const ranges = [[1,15],[16,30],[31,45],[46,60],[61,75]];
        for(let i=0; i<5; i++) {
            const col = [];
            while(col.length < 5) {
                const n = Math.floor(Math.random() * (ranges[i][1] - ranges[i][0] + 1)) + ranges[i][0];
                if(!col.includes(n)) col.push(n);
            }
            card.push(col);
        }
        return card;
    }

    function renderCard() {
        const container = document.getElementById('bingoCard');
        if(!myCard.length) {
            const saved = localStorage.getItem('myBingoCard');
            myCard = saved ? JSON.parse(saved) : generateCard();
            localStorage.setItem('myBingoCard', JSON.stringify(myCard));
        }

        container.innerHTML = "";
        let markedCount = 0;
        
        // Winning Indices para sa line display
        const winResult = checkWinningPattern();

        for(let r=0; r<5; r++) {
            for(let c=0; c<5; c++) {
                const val = myCard[c][r];
                const isFree = r === 2 && c === 2;
                const isMarked = isFree || drawnNumbers.includes(val);
                
                const div = document.createElement('div');
                div.className = `cell ${isFree ? 'free' : ''} ${isMarked ? 'marked' : ''}`;
                
                // --- UPDATE: Ipakita ang Winning Line ---
                if(hasWon && winResult && winResult.indices.some(idx => idx.r === r && idx.c === c)) {
                    div.classList.add('win-pattern');
                }

                div.innerText = isFree ? "FREE" : val;
                container.appendChild(div);
                if(isMarked) markedCount++;
            }
        }
        
        document.getElementById('bingoBtn').style.display = (markedCount >= 4 && !hasWon) ? 'block' : 'none';
    }

    // UPDATE: Sinama ang Indices sa checkWinningPattern para malaman kung anong cells ang kukulayan
    function checkWinningPattern() {
        const board = [];
        for(let r=0; r<5; r++) {
            board[r] = [];
            for(let c=0; c<5; c++) {
                board[r][c] = (r === 2 && c === 2) || drawnNumbers.includes(myCard[c][r]);
            }
        }

        let winIndices = [];

        // Rows
        for(let r=0; r<5; r++) {
            if(board[r].every(v => v)) {
                for(let c=0; c<5; c++) winIndices.push({r,c});
                return { win: true, indices: winIndices };
            }
        }
        // Cols
        for(let c=0; c<5; c++) {
            let win = true;
            let temp = [];
            for(let r=0; r<5; r++) { if(!board[r][c]) win = false; temp.push({r,c}); }
            if(win) return { win: true, indices: temp };
        }
        // Diagonals
        let d1 = true, d2 = true, t1 = [], t2 = [];
        for(let i=0; i<5; i++) {
            if(!board[i][i]) d1 = false; t1.push({r:i, c:i});
            if(!board[i][4-i]) d2 = false; t2.push({r:i, c:4-i});
        }
        if(d1) return { win: true, indices: t1 };
        if(d2) return { win: true, indices: t2 };

        return null;
    }

    async function checkBingo() {
        const winResult = checkWinningPattern();
        if(winResult && !hasWon) {
            hasWon = true;
            confetti({ particleCount: 150, spread: 70, origin: { y: 0.6 } });
            
            await db.ref('gameState/latestWinner').set({
                uid: auth.currentUser.uid,
                name: auth.currentUser.displayName,
                time: Date.now()
            });
            
            db.ref('users/' + auth.currentUser.uid).update({
                points: firebase.database.ServerValue.increment(50),
                hasWonCurrent: true
            });
            
            alert("BINGO! Nanalo ka ng ₱50!");
            renderCard(); // I-refresh para lumabas ang gold line
        } else {
            alert("Hindi pa Bingo! Check mo mabuti.");
        }
    }

    // --- NEW UI LOGIC FUNCTIONS ---
    function showLoserState(winnerName) {
        document.getElementById('cardContainer').classList.add('game-over');
        const overlay = document.getElementById('loserOverlay');
        overlay.style.display = 'block';
        document.getElementById('winnerName').innerText = "Winner: " + winnerName;
        document.getElementById('bingoBtn').style.display = 'none';
    }

    function hideOverlays() {
        document.getElementById('cardContainer').classList.remove('game-over');
        document.getElementById('loserOverlay').style.display = 'none';
    }

    function resetForNewGame() {
        hasWon = false;
        myCard = generateCard();
        localStorage.setItem('myBingoCard', JSON.stringify(myCard));
        hideOverlays();
        db.ref('users/' + auth.currentUser.uid + '/hasWonCurrent').set(false);
    }

    // ORIGINAL SHOP & MODAL LOGIC (WALANG GALAW)
    function openShop() {
        document.getElementById('shopModal').style.display = 'flex';
        const items = [
            { name: "₱50 GCash", cost: 50 },
            { name: "₱100 GCash", cost: 100 },
            { name: "₱500 GCash", cost: 500 }
        ];
        const list = document.getElementById('shopList');
        list.innerHTML = "";
        items.forEach(item => {
            const div = document.createElement('div');
            div.className = 'shop-item';
            div.innerHTML = `
                <div>
                    <div style="font-weight:800;">${item.name}</div>
                    <div style="font-size:12px; color:var(--gold);">₱${item.cost} Points</div>
                </div>
                <button onclick="redeem('${item.name}', ${item.cost})" style="padding:10px 20px; border-radius:10px; border:none; background:var(--accent); color:white; font-weight:800;">REDEEM</button>
            `;
            list.appendChild(div);
        });
    }

    async function redeem(item, cost) {
        const s = await db.ref('users/' + auth.currentUser.uid).once('value');
        const points = s.val().points || 0;
        if(points < cost) return alert("Kulang ang iyong points!");
        
        const gcash = prompt("Ilagay ang iyong GCash Number:");
        if(!gcash) return;

        await db.ref('redemptions').push({
            uid: auth.currentUser.uid,
            name: auth.currentUser.displayName,
            item: item,
            cost: cost,
            gcash: gcash,
            status: 'pending',
            time: Date.now()
        });

        db.ref('users/' + auth.currentUser.uid + '/points').transaction(p => p - cost);
        alert("Redemption Request Sent!");
        closeModals();
    }

    function closeModals() { document.querySelectorAll('.modal').forEach(m => m.style.display = 'none'); }

    function openMenuModal() {
        document.getElementById('menuModal').style.display = 'flex';
        const hist = document.getElementById('historyList');
        hist.innerHTML = "<div style='font-size:12px; opacity:0.5; padding:10px;'>Loading transactions...</div>";
        
        db.ref('redemptions').orderByChild('uid').equalTo(auth.currentUser.uid).once('value', s => {
            hist.innerHTML = "";
            if(!s.exists()) { hist.innerHTML = "<div style='font-size:11px; opacity:0.5; text-align:center; padding:20px;'>No history yet</div>"; return; }
            
            let redemptions = [];
            s.forEach(child => { redemptions.push(child.val()); });
            redemptions.sort((a,b) => b.time - a.time);

            redemptions.forEach(v => {
                const item = document.createElement('div');
                item.className = 'history-item';
                item.innerHTML = `
                    <div>
                        <div style="font-weight:700; font-size:13px;">${v.item}</div>
                        <div style="font-size:10px; opacity:0.5;">${new Date(v.time).toLocaleDateString()}</div>
                    </div>
                    <span style="font-size:11px; font-weight:800;" class="${v.status === 'pending' ? 'status-pending' : 'status-completed'}">${v.status.toUpperCase()}</span>
                `;
                hist.appendChild(item);
            });
        });
    }
</script>
</body>
</html>
