<!DOCTYPE html>
<html lang="tl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#0f172a">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Radio Bingo Live | Social Ecosystem</title>
    
    <script>
        if (window.location.pathname.endsWith("index.html")) {
            var newPath = window.location.pathname.replace(/index\.html$/, "");
            window.history.replaceState({}, document.title, newPath);
        }
    </script>

    <link rel="icon" type="image/png" href="https://i.imgur.com/7D8u8h6.png">
    <link rel="apple-touch-icon" href="https://i.imgur.com/7D8u8h6.png">
    <link rel="manifest" href="manifest.json">
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;900&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-messaging.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

    <script src="https://pl28660488.effectivegatecpm.com/9b/f5/85/9bf585b6ee39cb9b515e2fae1fa958c2.js"></script>
    <script src="https://pl28660496.effectivegatecpm.com/a6/64/bf/a664bf7e7084386b4f4b428590030df3.js"></script>

    <style>
        /* === ORIGINAL VARIABLES === */
        :root { 
            --bg-overlay: rgba(15, 23, 42, 0.95); 
            --glass-surface: rgba(30, 41, 59, 0.75);
            --glass-border: rgba(255, 255, 255, 0.1);
            
            --accent: #0ea5e9; 
            --accent-glow: #38bdf8;
            --text: #ffffff; 
            --gold: #fbbf24; 
            --gold-shine: #fcd34d;
            --success: #10b981; 
            --danger: #ef4444; 
            --minigame: #f472b6;
            
            --messenger-blue: #0084ff;
            --messenger-grey: #3e4042;
            --messenger-bg: #000000;
        }
        
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; user-select: none; }
        
        body { 
            font-family: 'Inter', sans-serif; 
            background: radial-gradient(circle at top center, #1e293b 0%, #0f172a 60%, #020617 100%);
            background-attachment: fixed;
            color: var(--text); 
            margin: 0; 
            padding-bottom: 90px; /* Added padding for Bottom Nav */
            overflow-x: hidden; 
            min-height: 100vh;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.8);
        }

        /* === NEW BOTTOM NAV === */
        .bottom-nav {
            position: fixed; bottom: 0; left: 0; right: 0;
            background: rgba(15, 23, 42, 0.98);
            backdrop-filter: blur(10px);
            border-top: 1px solid rgba(255,255,255,0.1);
            display: flex; justify-content: space-around;
            padding: 12px 5px 25px 5px; /* Extra padding for iOS bar */
            z-index: 5000;
            box-shadow: 0 -5px 20px rgba(0,0,0,0.5);
        }
        .nav-item {
            flex: 1; display: flex; flex-direction: column; align-items: center;
            color: #64748b; font-size: 10px; font-weight: 700; background: none; border: none; cursor: pointer; transition: 0.2s;
        }
        .nav-item.active { color: var(--accent); transform: translateY(-3px); }
        .nav-item.active i { filter: drop-shadow(0 0 8px var(--accent)); }
        
        /* === ORIGINAL STYLES PRESERVED === */
        #customPopupBanner { display: none; position: fixed; inset: 0; z-index: 9999999; background: rgba(0,0,0,0.85); align-items: center; justify-content: center; flex-direction: column; padding: 20px; backdrop-filter: blur(5px); }
        .card-skin-neon { border: 2px solid #06b6d4 !important; box-shadow: 0 0 20px #06b6d4, inset 0 0 20px rgba(6, 182, 212, 0.2) !important; background: rgba(8, 51, 68, 0.9) !important; }
        .card-skin-neon .cell { border-color: #06b6d4 !important; color: #67e8f9 !important; text-shadow: 0 0 5px #06b6d4 !important; }
        .card-skin-gold { border: 2px solid #f59e0b !important; box-shadow: 0 0 25px #f59e0b, inset 0 0 10px #f59e0b !important; background: linear-gradient(135deg, #451a03, #000) !important; }
        .card-skin-gold .cell { border-color: #fbbf24 !important; color: #fcd34d !important; font-family: 'Times New Roman', serif; }
        .card-skin-pink { border: 2px solid #ec4899 !important; box-shadow: 0 0 20px #ec4899 !important; background: rgba(80, 7, 36, 0.9) !important; }
        .card-skin-pink .cell { border-color: #f472b6 !important; color: #fbcfe8 !important; border-radius: 50% !important; }
        .card-skin-matrix { border: 2px solid #22c55e !important; box-shadow: 0 0 15px #22c55e !important; background: black !important; font-family: 'Courier New', monospace; }
        .card-skin-matrix .cell { border-color: #22c55e !important; color: #4ade80 !important; border-radius: 0 !important; }
        
        /* Store & Skins Grid (Recycled for Store Tab) */
        .skins-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
        .skin-item { background: rgba(255,255,255,0.05); padding: 10px; border-radius: 16px; border: 1px solid rgba(255,255,255,0.1); text-align: center; position: relative; overflow: hidden; }
        .skin-preview { height: 60px; border-radius: 8px; margin-bottom: 8px; display: flex; align-items: center; justify-content: center; font-size: 20px; font-weight: 900; }
        .skin-name { font-size: 12px; font-weight: 800; color: white; margin-bottom: 4px; }
        .btn-buy-skin { width: 100%; padding: 8px; border: none; border-radius: 8px; font-weight: 800; font-size: 10px; cursor: pointer; }
        .btn-buy-skin.buy { background: var(--gold); color: black; }
        .btn-buy-skin.equip { background: var(--success); color: white; }
        .btn-buy-skin.owned { background: rgba(255,255,255,0.1); color: #cbd5e1; cursor: default; }

        /* Install Gate & Notif Blocker (KEPT) */
        #installGate { position: fixed; inset: 0; z-index: 2147483647; background: #0f172a; display: none; flex-direction: column; align-items: center; justify-content: center; padding: 30px; text-align: center; }
        .gate-logo { font-size: 64px; font-weight: 900; letter-spacing: -3px; color: white; margin-bottom: 10px; text-shadow: 0 0 40px rgba(14, 165, 233, 0.6); }
        .gate-logo span { color: var(--accent-glow); }
        .gate-btn-install { background: linear-gradient(135deg, var(--accent), #2563eb); color: white; border: none; padding: 18px 40px; border-radius: 50px; font-weight: 900; font-size: 16px; cursor: pointer; display: flex; align-items: center; gap: 10px; }
        #notifBlocker { position: fixed; inset: 0; z-index: 9999999; background: rgba(15, 23, 42, 0.98); display: none; flex-direction: column; align-items: center; justify-content: center; padding: 30px; text-align: center; }
        
        /* General UI Elements */
        #customToast { position: fixed; top: 20px; left: 50%; transform: translateX(-50%) translateY(-150%); background: rgba(15, 23, 42, 0.95); border: 1px solid var(--accent); padding: 16px 24px; border-radius: 16px; z-index: 100000; display: flex; align-items: center; justify-content: center; text-align: center; gap: 12px; box-shadow: 0 10px 40px rgba(0,0,0,0.8); backdrop-filter: blur(12px); transition: transform 0.4s; min-width: 280px; }
        #customToast.show { transform: translateX(-50%) translateY(0); }
        
        /* Login Overlay */
        #loginOverlay { position: fixed; inset: 0; background: radial-gradient(circle at top right, #1e293b, #0f172a 70%); z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 20px; }
        .app-logo-lg { font-size: 56px; font-weight: 900; letter-spacing: -3px; color: white; margin-bottom: 10px; text-shadow: 0 10px 30px rgba(14, 165, 233, 0.3); }
        .btn-main-auth { background: white; color: black; border: none; width: 100%; padding: 18px; border-radius: 16px; font-weight: 800; font-size: 16px; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 12px; box-shadow: 0 10px 25px rgba(0,0,0,0.3); }

        /* Header & Nav */
        .nav { background: rgba(15, 23, 42, 0.95); backdrop-filter: blur(15px); padding: 10px 15px; display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 100; border-bottom: 1px solid rgba(255,255,255,0.1); height: 60px; }
        .icon-btn { background: rgba(255,255,255,0.1); color: white; border: 1px solid rgba(255,255,255,0.15); width: 38px; height: 38px; border-radius: 12px; cursor: pointer; position: relative; display: flex; align-items: center; justify-content: center; }
        .points-badge { background: linear-gradient(135deg, rgba(251, 191, 36, 0.2), rgba(245, 158, 11, 0.4)); color: #fff; padding: 0 12px; height: 38px; border-radius: 12px; font-weight: 800; border: 1px solid rgba(251, 191, 36, 0.6); font-size: 13px; display: flex; align-items: center; gap: 6px; }
        .notif-badge { position: absolute; top: 8px; right: 8px; background: var(--danger); width: 8px; height: 8px; border-radius: 50%; display: none; z-index: 10; }

        /* Container */
        .container { width: 100%; max-width: 500px; margin: 0 auto; padding: 10px; }
        
        /* Video Feed */
        .video-feed-wrapper { margin-bottom: 15px; border-radius: 24px; overflow: hidden; background: #000; border: 2px solid rgba(255,255,255,0.2); box-shadow: 0 10px 40px rgba(0,0,0,0.6); }
        .video-container { position: relative; width: 100%; aspect-ratio: 16 / 9; }
        .video-overlay-bl { position: absolute; bottom: 12px; left: 12px; z-index: 10; background: rgba(0,0,0,0.9); padding: 6px 12px; border-radius: 8px; border: 1px solid var(--success); display: flex; align-items: center; gap: 5px; color: var(--success); font-size: 11px; font-weight: 800; }
        
        /* Bingo Elements (KEPT EXACTLY AS IS) */
        .card { background: var(--glass-surface); backdrop-filter: blur(20px); border-radius: 24px; padding: 20px; margin-bottom: 20px; border: 1px solid var(--glass-border); position: relative; box-shadow: 0 15px 35px rgba(0,0,0,0.4); }
        .draw-panel { display: grid; grid-template-columns: 1fr 90px; gap: 12px; margin-bottom: 20px; }
        .prev-balls { background: rgba(0,0,0,0.4); border-radius: 16px; padding: 10px; display: flex; align-items: center; gap: 8px; overflow-x: auto; scrollbar-width: none; border: 1px solid rgba(255,255,255,0.1); }
        .ball-small { min-width: 40px; height: 40px; background: linear-gradient(135deg, #334155, #1e293b); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 14px; font-weight: 900; border: 1px solid rgba(255,255,255,0.3); color: white; box-shadow: 0 4px 10px rgba(0,0,0,0.3); }
        .current-ball-box { background: linear-gradient(135deg, var(--accent), #2563eb); border-radius: 18px; height: 90px; display: flex; flex-direction: column; align-items: center; justify-content: center; box-shadow: 0 8px 25px rgba(59, 130, 246, 0.5); border: 2px solid rgba(255,255,255,0.4); }
        .bingo-header { display: grid; grid-template-columns: repeat(5, 1fr); gap: 8px; margin-bottom: 10px; }
        .letter { text-align: center; font-size: 26px; font-weight: 900; color: var(--gold); text-shadow: 0 2px 10px rgba(251, 191, 36, 0.8); -webkit-text-stroke: 1px rgba(0,0,0,0.5); }
        .grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 8px; position: relative; }
        .cell { aspect-ratio: 1; background: rgba(255,255,255,0.1); border-radius: 12px; display: flex; align-items: center; justify-content: center; font-weight: 800; font-size: 18px; border: 1px solid rgba(255,255,255,0.15); transition: all 0.3s; z-index: 2; position: relative; overflow: hidden; color: white; text-shadow: 0 2px 3px black; }
        .cell.hit { background: linear-gradient(135deg, var(--accent), #2563eb); color: white; transform: scale(1.05); border-color: rgba(255,255,255,0.6); box-shadow: 0 5px 15px rgba(59, 130, 246, 0.6); }
        .card.card-win { border: 3px solid var(--success) !important; box-shadow: 0 0 50px rgba(16, 185, 129, 0.5); animation: pulse-win 2s infinite; background: rgba(16, 185, 129, 0.2); }
        .cell.cell-waiting { background: #fffbeb !important; color: #b45309 !important; border: 2px dashed #f59e0b; animation: flash-waiting 1s infinite; z-index: 5; font-weight: 900; transform: scale(1.1); }
        .cell.win-glow { background: #10b981 !important; color: white; z-index: 3; border: 2px solid #fff; box-shadow: 0 0 25px var(--success); }
        
        /* Chat Box */
        .chat-box { height: 480px; display: flex; flex-direction: column; background: #111827; border-radius: 20px; border: 1px solid rgba(255,255,255,0.1); overflow: hidden; box-shadow: 0 20px 50px rgba(0,0,0,0.5); position: relative; margin-top: 20px; }
        .chat-header { padding: 15px 20px; background: rgba(31, 41, 55, 0.95); border-bottom: 1px solid rgba(255,255,255,0.08); display: flex; align-items: center; gap: 10px; z-index: 10; }
        #chatList { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 12px; background: #0f172a; }
        .chat-row { display: flex; gap: 10px; max-width: 100%; align-items: flex-end; }
        .chat-pfp { width: 32px; height: 32px; border-radius: 50%; border: 1px solid rgba(255,255,255,0.2); object-fit: cover; }
        .bubble { padding: 10px 14px; font-size: 13px; line-height: 1.4; color: #e2e8f0; word-break: break-word; font-weight: 500; position: relative; }
        .chat-row[style*="row-reverse"] .bubble { background: linear-gradient(135deg, var(--accent), #2563eb); color: white; border-radius: 18px 18px 4px 18px; }
        .chat-row:not([style*="row-reverse"]) .bubble { background: #374151; color: #f3f4f6; border-radius: 18px 18px 18px 4px; }
        .chat-input-area { background: #1f2937; padding: 12px; border-top: 1px solid rgba(255,255,255,0.08); display: flex; gap: 10px; align-items: center; }
        .input-wrapper { flex: 1; display: flex; gap: 10px; background: #374151; padding: 0 15px; border-radius: 24px; align-items: center; height: 42px; border: 1px solid rgba(255,255,255,0.1); }
        .input-wrapper input { flex: 1; background: none; border: none; color: white; outline: none; font-size: 13px; height: 100%; }

        /* Jackpot Banner */
        #jackpotBanner { background: linear-gradient(135deg, #271a00 0%, #451a03 50%, #000000 100%); border: 2px solid #fbbf24; color: #fbbf24; padding: 15px; text-align: center; border-radius: 18px; box-shadow: 0 0 25px rgba(251, 191, 36, 0.3), inset 0 0 20px rgba(251, 191, 36, 0.1); display: none; margin-bottom: 15px; position: relative; overflow: hidden; animation: pulse-border 2s infinite; }
        .jackpot-amount { font-size: 32px; color: #ffffff; display: block; font-weight: 900; text-shadow: 0 2px 15px rgba(251, 191, 36, 0.8); background: linear-gradient(to bottom, #ffffff, #fcd34d); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        @keyframes pulse-border { 0% { box-shadow: 0 0 15px rgba(251, 191, 36, 0.2); border-color: #b45309; } 50% { box-shadow: 0 0 35px rgba(251, 191, 36, 0.6); border-color: #fbbf24; } 100% { box-shadow: 0 0 15px rgba(251, 191, 36, 0.2); border-color: #b45309; } }

        /* === NEW SOCIAL & FEED STYLES === */
        #socialTab { display: block; animation: fadeIn 0.3s ease; }
        #bingoTab, #storeTab, #profileTab { display: none; animation: fadeIn 0.3s ease; }

        .post-creator-modern { background: var(--glass-surface); padding: 15px; border-radius: 18px; border: 1px solid var(--glass-border); display: flex; flex-direction: column; gap: 10px; margin-bottom: 15px; }
        .pc-top { display: flex; gap: 10px; align-items: flex-start; }
        .pc-avatar { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; border: 2px solid var(--accent); }
        .pc-input { background: rgba(0,0,0,0.4); border: 1px solid rgba(255,255,255,0.1); border-radius: 20px; padding: 12px 15px; color: white; resize: none; min-height: 60px; font-family: 'Inter', sans-serif; flex: 1; outline: none; font-size: 14px; }
        .pc-actions { display: flex; justify-content: space-between; align-items: center; padding-top: 5px; border-top: 1px solid rgba(255,255,255,0.05); margin-top: 5px; }
        .pc-btn-icon { background: none; border: none; color: var(--accent-glow); display: flex; align-items: center; gap: 5px; font-size: 12px; font-weight: 700; cursor: pointer; padding: 5px 10px; border-radius: 10px; }
        .btn-post-modern { background: var(--accent); color: white; border: none; padding: 8px 20px; border-radius: 20px; font-weight: 800; font-size: 12px; cursor: pointer; box-shadow: 0 4px 12px rgba(14, 165, 233, 0.3); }

        .post-card { background: #1e293b; border-radius: 16px; border: 1px solid rgba(255,255,255,0.05); overflow: hidden; margin-bottom: 10px; position: relative; }
        .post-header { padding: 12px; display: flex; align-items: center; gap: 10px; border-bottom: 1px solid rgba(255,255,255,0.05); }
        .post-avatar { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; border: 1px solid rgba(255,255,255,0.2); }
        .post-meta { flex: 1; }
        .post-author { font-size: 14px; font-weight: 800; color: white; display: flex; align-items: center; gap: 5px; }
        .post-time { font-size: 11px; color: #94a3b8; }
        .post-content { padding: 15px; font-size: 14px; line-height: 1.5; color: #e2e8f0; word-break: break-word; }
        .post-image-container { width: 100%; max-height: 350px; overflow: hidden; display: flex; justify-content: center; background: #000; margin-bottom: 5px; }
        .post-image { max-width: 100%; max-height: 350px; object-fit: contain; }
        .post-stats { padding: 8px 15px; font-size: 11px; color: #94a3b8; display: flex; justify-content: space-between; border-bottom: 1px solid rgba(255,255,255,0.05); }
        .post-actions { display: flex; position: relative; }
        .action-btn { flex: 1; background: transparent; border: none; color: #94a3b8; padding: 12px; font-size: 13px; font-weight: 600; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 6px; transition: 0.2s; position: relative; }
        .action-btn:hover { background: rgba(255,255,255,0.05); color: white; }

        /* Reactions */
        .reaction-dock { position: absolute; bottom: 50px; left: 10px; background: rgba(255,255,255,0.9); border-radius: 30px; padding: 5px 10px; display: none; gap: 5px; box-shadow: 0 5px 15px rgba(0,0,0,0.5); z-index: 20; animation: popUp 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        .action-btn:hover .reaction-dock { display: flex; } 
        .reaction-btn { width: 32px; height: 32px; font-size: 20px; transition: 0.2s; cursor: pointer; display: flex; align-items: center; justify-content: center; }
        .reaction-btn:hover { transform: scale(1.4) translateY(-5px); }
        @keyframes popUp { from { transform: scale(0); opacity: 0; } to { transform: scale(1); opacity: 1; } }

        /* Comments Preview */
        .comments-preview-area { background: rgba(0,0,0,0.2); padding: 10px 15px; }
        .comment-prev { font-size: 12px; margin-bottom: 4px; color: #cbd5e1; }
        .comment-prev b { color: white; margin-right: 5px; }

        /* Algorithm (PYMK) */
        .pymk-container { background: #1e293b; border-radius: 16px; padding: 15px; margin-bottom: 15px; border: 1px solid rgba(255,255,255,0.05); }
        .pymk-header { font-size: 13px; font-weight: 800; color: #cbd5e1; margin-bottom: 10px; text-transform: uppercase; }
        .pymk-scroll { display: flex; gap: 10px; overflow-x: auto; padding-bottom: 10px; scrollbar-width: none; }
        .pymk-card { background: rgba(255,255,255,0.05); border-radius: 12px; padding: 10px; min-width: 110px; display: flex; flex-direction: column; align-items: center; text-align: center; border: 1px solid rgba(255,255,255,0.05); }
        .pymk-img { width: 50px; height: 50px; border-radius: 50%; margin-bottom: 8px; border: 2px solid var(--accent); object-fit: cover; }
        .pymk-name { font-size: 12px; font-weight: 700; color: white; margin-bottom: 8px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; width: 100%; }
        .btn-add-sm { background: var(--accent); color: white; border: none; padding: 5px 15px; border-radius: 20px; font-size: 10px; font-weight: 800; cursor: pointer; width: 100%; }

        /* Modern Profile */
        .profile-modern-header { position: relative; margin-bottom: 60px; border-radius: 20px; overflow: visible; }
        .cover-photo { height: 150px; background: linear-gradient(135deg, var(--accent), #1e293b); border-radius: 20px 20px 0 0; }
        .pm-avatar-lg { position: absolute; bottom: -40px; left: 20px; width: 90px; height: 90px; border-radius: 50%; border: 4px solid #0f172a; background: #000; object-fit: cover; }
        .pm-info-sec { padding: 0 10px; }
        .pm-name-lg { font-size: 24px; font-weight: 900; color: white; margin: 0; }
        .pm-bio { font-size: 13px; color: #cbd5e1; margin-top: 5px; max-width: 300px; }
        .pm-stats-row { display: flex; gap: 20px; margin: 15px 0; border-top: 1px solid rgba(255,255,255,0.1); border-bottom: 1px solid rgba(255,255,255,0.1); padding: 15px 0; }
        .pm-stat { text-align: center; }
        .pm-stat b { display: block; font-size: 18px; color: white; }
        .pm-stat span { font-size: 11px; color: #94a3b8; }
        .pm-actions-row { display: flex; gap: 10px; margin-bottom: 20px; }
        .btn-pm-primary { flex: 1; background: var(--accent); color: white; border: none; padding: 10px; border-radius: 8px; font-weight: 700; cursor: pointer; }
        .btn-pm-sec { flex: 1; background: rgba(255,255,255,0.1); color: white; border: none; padding: 10px; border-radius: 8px; font-weight: 700; cursor: pointer; }

        /* Task List (Store) */
        .task-list { display: flex; flex-direction: column; gap: 10px; margin-top: 15px; }
        .task-item { background: linear-gradient(135deg, rgba(30,41,59,0.9), rgba(15,23,42,0.95)); padding: 15px; border-radius: 16px; border: 1px solid rgba(255,255,255,0.1); display: flex; justify-content: space-between; align-items: center; }
        .btn-do-task { background: var(--accent); color: white; border: none; padding: 8px 15px; border-radius: 10px; font-weight: 800; font-size: 11px; cursor: pointer; }
        
        /* Modals */
        .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.95); z-index: 6000; display: none; align-items: center; justify-content: center; padding: 15px; }
        .modal-content { background: #1e293b; border-radius: 20px; width: 100%; max-width: 450px; padding: 20px; border: 1px solid rgba(255,255,255,0.1); max-height: 90vh; overflow-y: auto; }
        
        /* Store Nav */
        .store-nav { display: flex; gap: 8px; margin-bottom: 15px; background: rgba(0,0,0,0.3); padding: 5px; border-radius: 12px; }
        .store-tab-btn { flex: 1; padding: 10px; border: none; background: transparent; color: #94a3b8; font-weight: 800; border-radius: 8px; cursor: pointer; font-size: 11px; text-transform: uppercase; }
        .store-tab-btn.active { background: var(--accent); color: white; }

        .flying-coin { position: fixed; width: 24px; height: 24px; background-image: url('https://cdn-icons-png.flaticon.com/512/217/217853.png'); background-size: contain; background-repeat: no-repeat; z-index: 99999; pointer-events: none; }
        
        /* Ad Containers */
        .ad-container-global { position: relative; z-index: 10 !important; width: 320px; height: 50px; display: flex; justify-content: center; align-items: center; margin: 15px auto; background: rgba(0,0,0,0.4); border-radius: 4px; border: 1px dashed rgba(255,255,255,0.3); text-align: center; overflow: hidden; }
        #grandJackpotModal { position: fixed; inset: 0; z-index: 99999; background: rgba(0,0,0,0.95); display: none; align-items: center; justify-content: center; flex-direction: column; overflow: hidden; }
    </style>
</head>
<body>

<div id="customPopupBanner">
    <div style="position:relative; max-width:400px; width:100%; animation: popScale 0.4s;">
        <button onclick="closeCustomBanner()" style="position:absolute; top:-15px; right:-10px; background:var(--danger); color:white; border:2px solid white; border-radius:50%; width:36px; height:36px; z-index:10; cursor:pointer;"><i data-lucide="x"></i></button>
        <img id="customBannerImg" src="" style="width:100%; border-radius:20px; cursor:pointer;" onclick="clickCustomBanner()">
    </div>
</div>

<div id="notifBlocker">
    <div class="notif-gate-icon"><i data-lucide="bell-ring" style="width: 40px; color: #3b82f6;"></i></div>
    <div class="gate-title">ENABLE NOTIFICATIONS</div>
    <p class="gate-desc">To ensure fairness and real-time updates for Bingo Calls, this app requires push notifications.</p>
    <button onclick="requestGatePermission()" class="btn-allow-notif">ALLOW NOTIFICATIONS</button>
    <div id="blockedHelp" class="blocked-help">Check site settings to unblock.</div>
</div>

<div id="installGate">
    <div class="gate-logo">RB<span>LIVE</span></div>
    <div class="gate-title">Install to Play</div>
    <button class="gate-btn-install" onclick="triggerInstall()">INSTALL APP</button>
</div>

<div id="customToast"><i data-lucide="info" class="toast-icon"></i><span class="toast-msg" id="toastMsg">Notification!</span></div>

<div id="loginOverlay">
    <div class="login-bg-blob blob-1"></div>
    <div class="login-bg-blob blob-2"></div>
    <div class="login-app-container">
        <div class="app-logo-lg">RB<span>LIVE</span></div>
        <p style="color:#cbd5e1; margin-bottom:40px;">Live Bingo & Social Network</p>
        <button class="btn-main-auth" onclick="login()">
            <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/action/google.svg" width="20"> Sign in with Google
        </button>
    </div>
</div>

<div class="nav">
    <div style="display:flex; align-items:center;"><span style="font-weight: 900; font-size: 20px;">RB <span style="color:var(--accent-glow)">LIVE</span></span></div>
    <div id="userPanel" style="display:none; align-items: center; gap: 10px;">
        <div class="user-stats">
            <div class="icon-btn" onclick="document.getElementById('notesModal').style.display='flex'">
                <i data-lucide="clipboard-list" style="width:20px"></i>
            </div>
            <div class="icon-btn" onclick="openMessenger()">
                <i data-lucide="message-circle" style="width:20px"></i>
                <span id="pmBadge" class="notif-badge"></span>
            </div>
            <div class="points-badge"><i data-lucide="coins" style="width:14px"></i> <span id="userPoints">0</span></div>
        </div>
        <img id="userImg" src="" style="width:40px; height:40px; border-radius:50%; border:2px solid var(--accent);" onclick="switchTab('profile')">
    </div>
</div>

<div class="container">
    <div class="ad-container-global">
         <script type="text/javascript">
            atOptions = { 'key' : '59f94c5cb7bcd84edb277947774c3b9d', 'format' : 'iframe', 'height' : 50, 'width' : 320, 'params' : {} };
        </script>
        <script type="text/javascript" src="https://directoryeditorweep.com/59f94c5cb7bcd84edb277947774c3b9d/invoke.js"></script>
    </div>

    <div class="video-feed-wrapper">
        <div class="video-container">
            <div class="video-overlay-bl"><i data-lucide="users" style="width:14px"></i><span id="onlineCount">0</span> ONLINE</div>
            <iframe id="liveVideoFrame" width="100%" height="100%" src="https://www.youtube.com/embed/4I_NSJTbdXo?autoplay=1&mute=1" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen></iframe>
        </div>
    </div>
    
    <div id="jackpotBanner">
        <div style="font-size:11px; font-weight:900; color:#fcd34d;">JACKPOT ROUND</div>
        <span class="jackpot-amount" id="jackpotDisplayVal">5,000</span>
        <div style="font-size: 10px; opacity: 0.7; margin-top: 5px; color: #fbbf24;">RB COINS GRAND PRIZE</div>
    </div>

    <div id="socialTab">
        <div class="post-creator-modern">
            <div class="pc-top">
                <img id="myPcAvatar" class="pc-avatar" src="">
                <textarea id="postInput" class="pc-input" placeholder="What's on your mind?"></textarea>
            </div>
            <div id="imgPreviewCont" style="display:none; margin-top:10px; position:relative;">
                <img id="postImgPreview" style="max-height:100px; border-radius:10px;">
                <button onclick="removePostImage()" style="position:absolute; top:-5px; right:-5px; background:red; color:white; border:none; border-radius:50%; width:20px; height:20px;">x</button>
            </div>
            <div class="pc-actions">
                <div style="display:flex; gap:5px;">
                    <label for="postImgInput" class="pc-btn-icon"><i data-lucide="image" style="width:16px;"></i> Photo</label>
                    <input type="file" id="postImgInput" accept="image/*" style="display:none" onchange="handlePostImage(this)">
                    <button class="pc-btn-icon" onclick="toggleMoodSelector()"><i data-lucide="smile" style="width:16px;"></i> Mood</button>
                </div>
                <button class="btn-post-modern" onclick="createPost()">POST</button>
            </div>
            <div id="moodSelector" style="display:none; gap:5px; padding-top:10px; overflow-x:auto;">
                <button onclick="selectMood('Happy')" style="padding:5px 10px; border-radius:15px; border:1px solid #ffffff33; background:none; color:white;">üòä Happy</button>
                <button onclick="selectMood('Sad')" style="padding:5px 10px; border-radius:15px; border:1px solid #ffffff33; background:none; color:white;">üòî Sad</button>
                <button onclick="selectMood('Excited')" style="padding:5px 10px; border-radius:15px; border:1px solid #ffffff33; background:none; color:white;">ü§© Excited</button>
            </div>
        </div>

        <div id="socialFeed" class="social-feed-container"></div>
    </div>

    <div id="bingoTab">
        <div class="draw-panel">
            <div class="prev-balls" id="ballRow"></div>
            <div class="current-ball-box"><span id="currentBall" style="font-size:36px; font-weight:900; color:white;">--</span></div>
        </div>
        
        <div class="card" id="bingoCardContainer">
            <div style="display:flex; justify-content:space-between; margin-bottom:10px; align-items:center;">
                <span id="patternName" style="color:var(--gold); font-weight:800; text-transform:uppercase;">Normal Bingo</span>
                <button onclick="generateNewCard()" id="newCardBtn" style="background:var(--accent); border:none; padding:5px 10px; border-radius:8px; color:white; font-size:10px; font-weight:bold;">NEW CARD</button>
            </div>
            <div class="bingo-header"><div class="letter">B</div><div class="letter">I</div><div class="letter">N</div><div class="letter">G</div><div class="letter">O</div></div>
            <div class="grid" id="bingoGrid"></div>
        </div>
        
        <div class="chat-box">
             <div class="chat-header">
                <i data-lucide="message-square" style="width:18px; color:var(--accent-glow)"></i>
                <h3>LIVE STREAM CHAT</h3>
            </div>
            <div id="chatList"></div>
             <div class="chat-input-area">
                <form class="input-wrapper" onsubmit="event.preventDefault(); sendChat();">
                    <input type="text" id="chatIn" placeholder="Say something..." autocomplete="off">
                    <button type="submit" style="background:none; border:none; color:white;"><i data-lucide="send" style="width:16px"></i></button>
                </form>
            </div>
        </div>
    </div>

    <div id="storeTab">
        <div class="store-nav">
            <button class="store-tab-btn active" onclick="switchStoreSection('cashout')" id="stCash">Redeem</button>
            <button class="store-tab-btn" onclick="switchStoreSection('skins')" id="stSkins">Skins</button>
            <button class="store-tab-btn" onclick="switchStoreSection('earn')" id="stEarn">Earn</button>
        </div>
        
        <div id="store-cashout">
            <div class="task-list">
                <div class="task-item">
                    <div class="task-info"><h4>‚Ç±20 Gift Card</h4><p>Cost: 50,000 Coins</p></div>
                    <button class="btn-do-task" onclick="redeemItem('‚Ç±20 GC', 50000)">REDEEM</button>
                </div>
                 <div class="task-item">
                    <div class="task-info"><h4>‚Ç±50 Gift Card</h4><p>Cost: 125,000 Coins</p></div>
                    <button class="btn-do-task" onclick="redeemItem('‚Ç±50 GC', 125000)">REDEEM</button>
                </div>
            </div>
             <p style="text-align: center; font-size: 10px; opacity: 0.6; margin-top: 25px;">*Processing takes 24-48 hours.</p>
        </div>

        <div id="store-skins" style="display:none;" class="skins-grid">
            <div class="skin-item">
                <div class="skin-preview" style="background:rgba(8,51,68,1); border:2px solid #06b6d4; color:#67e8f9;">B</div>
                <div class="skin-name">Neon City</div>
                <button class="btn-buy-skin buy" onclick="buyOrEquipSkin('neon', 50000)">50k Coins</button>
            </div>
             <div class="skin-item">
                <div class="skin-preview" style="background:#451a03; border:2px solid #f59e0b; color:#fcd34d;">B</div>
                <div class="skin-name">Luxury</div>
                <button class="btn-buy-skin buy" onclick="buyOrEquipSkin('gold', 100000)">100k Coins</button>
            </div>
        </div>
        
        <div id="store-earn" style="display:none;">
             <div class="task-item" style="border-color: #ef4444; background: linear-gradient(90deg, rgba(69,10,10,0.8), rgba(15,23,42,0.8));">
                <div class="task-info"><h4 style="color:#fca5a5;">Watch Video Task</h4><p>Watch full video to unlock reward</p><span class="task-reward" style="background: rgba(239,68,68,0.2); border-color:#ef4444; color:#fca5a5;">+2,000 Coins</span></div>
                <button class="btn-do-task" style="background:#ef4444;" id="btn-task-video" onclick="openVideoLocker('video')">WATCH</button>
            </div>
            <button id="btnWatchAd" onclick="startStrictWatch()" style="background: linear-gradient(135deg, #f59e0b, #b45309); width: 100%; border: none; padding: 15px; border-radius: 12px; font-weight: 900; color: white; margin-top:15px; cursor: pointer;">
                WATCH AD (+50 Coins)
            </button>
        </div>
    </div>

    <div id="profileTab">
        <div class="profile-modern-header">
            <div class="cover-photo"></div>
            <img id="pfAvatar" class="pm-avatar-lg" src="">
        </div>
        <div class="pm-info-sec">
            <h2 id="pfName" class="pm-name-lg">User Name</h2>
            <div style="display:flex; align-items:center; gap:5px;">
                <p id="pfBio" class="pm-bio">No bio yet.</p>
                <i data-lucide="edit-2" style="width:12px; color:#64748b; cursor:pointer;" onclick="editBio()"></i>
            </div>
            
            <div class="pm-stats-row">
                <div class="pm-stat"><b id="pfFriendCount">0</b><span>Friends</span></div>
                <div class="pm-stat"><b id="pfPostCount">0</b><span>Posts</span></div>
                <div class="pm-stat"><b id="pfPoints">0</b><span>Coins</span></div>
            </div>
            
            <div class="pm-actions-row">
                <button class="btn-pm-primary" onclick="copyInvite()">INVITE FRIENDS</button>
                <button class="btn-pm-sec" onclick="auth.signOut().then(()=>location.reload())">LOGOUT</button>
            </div>
            
            <h4 style="color:white; margin-bottom:10px; border-bottom:1px solid rgba(255,255,255,0.1); padding-bottom:5px;">My Posts</h4>
            <div id="myPostsFeed"></div>
        </div>
    </div>
</div>

<div class="bottom-nav">
    <button class="nav-item active" onclick="switchTab('social')" id="nav-social">
        <i data-lucide="home" style="width:24px"></i> Home
    </button>
    <button class="nav-item" onclick="switchTab('bingo')" id="nav-bingo">
        <i data-lucide="grid-3x3" style="width:24px"></i> Bingo
    </button>
    <button class="nav-item" onclick="switchTab('store')" id="nav-store">
        <i data-lucide="shopping-bag" style="width:24px"></i> Store
    </button>
    <button class="nav-item" onclick="switchTab('profile')" id="nav-profile">
        <i data-lucide="user" style="width:24px"></i> Me
    </button>
</div>

<div id="notesModal" class="modal" onclick="this.style.display='none'">
    <div class="modal-content" onclick="event.stopPropagation()">
        <h3>üì¢ BULLETIN / NOTES</h3>
        <ul style="padding-left:20px; color:#cbd5e1; font-size:14px; line-height:1.6;">
            <li><b>Fair Play:</b> Multiple accounts will be banned.</li>
            <li><b>Jackpot:</b> Starts when pattern is "Blackout".</li>
            <li><b>Redemption:</b> Valid ID is required for big claims.</li>
            <li><b>Disclaimer:</b> This is for entertainment only. No real money betting involved.</li>
        </ul>
        <button onclick="document.getElementById('notesModal').style.display='none'" style="width:100%; padding:10px; background:var(--accent); border:none; color:white; border-radius:10px; margin-top:20px;">CLOSE</button>
    </div>
</div>

<div id="commentModal" class="modal" style="display:none; align-items:flex-end;" onclick="this.style.display='none'">
    <div class="modal-content" style="border-radius:20px 20px 0 0; max-height:80vh; margin:0; width:100%; max-width:100%;" onclick="event.stopPropagation()">
        <div style="display:flex; justify-content:space-between; margin-bottom:15px;">
            <h3 style="margin:0;">Comments</h3>
            <button onclick="document.getElementById('commentModal').style.display='none'" style="background:none; border:none; color:white;">‚úï</button>
        </div>
        <div id="commentList" style="height:300px; overflow-y:auto; display:flex; flex-direction:column; gap:10px;"></div>
        <form onsubmit="event.preventDefault(); sendComment();" style="display:flex; gap:10px; margin-top:15px;">
            <input id="commentInput" style="flex:1; padding:10px; border-radius:20px; border:none; background:#334155; color:white;" placeholder="Write a comment...">
            <button type="submit" style="background:var(--accent); border:none; color:white; width:40px; height:40px; border-radius:50%;"><i data-lucide="send" style="width:16px"></i></button>
        </form>
    </div>
</div>

<div id="grandJackpotModal" onclick="this.style.display='none'">
    <div style="text-align:center;">
        <i data-lucide="crown" style="width:80px; height:80px; color:var(--gold);"></i>
        <h1 class="jackpot-amount">JACKPOT!</h1>
        <p id="jpWinnerName" style="color:white;"></p>
    </div>
</div>

<div id="pmModal" class="modal" style="z-index:7000;">
    <div class="modal-content" style="height:80vh; display:flex; flex-direction:column; padding:0;">
        <div style="padding:15px; border-bottom:1px solid rgba(255,255,255,0.1); display:flex; justify-content:space-between;">
            <h3 style="margin:0;">Messages</h3>
            <button onclick="document.getElementById('pmModal').style.display='none'" style="background:none; border:none; color:white;">X</button>
        </div>
        <div id="pmList" style="flex:1; overflow-y:auto; padding:15px;"></div>
    </div>
</div>

<div id="adTimerOverlay" style="display: none; position: fixed; inset: 0; background: rgba(15, 23, 42, 0.98); z-index: 50; align-items: center; justify-content: center; flex-direction: column;">
    <div style="font-size: 18px; font-weight: 900; color: white;" id="adCountdown">15s</div>
</div>
<div id="adCaptchaOverlay" style="display: none; position: fixed; inset: 0; background: rgba(15, 23, 42, 0.98); z-index: 51; align-items: center; justify-content: center; flex-direction: column;">
    <div style="font-size: 14px; font-weight: 700; color: var(--accent-glow); margin-bottom: 10px;">HUMAN VERIFICATION</div>
    <div style="background: rgba(255,255,255,0.1); padding: 10px; border-radius: 12px; margin-bottom: 10px;">
        <span id="mathQ" style="font-size: 20px; font-weight: 900; color: white;">5 + 3 = ?</span>
    </div>
    <div style="display: flex; gap: 5px;">
        <input type="number" id="mathAns" style="width: 60px; padding: 8px; border-radius: 8px; border: 1px solid var(--accent); background: #0f172a; color: white; text-align: center; font-weight: 800;">
        <button onclick="verifyAdMath()" style="background: var(--success); border: none; padding: 8px 12px; border-radius: 8px; color: white; font-weight: 900;">OK</button>
    </div>
</div>

<script>
    // === CONFIG & INIT ===
    const firebaseConfig = { apiKey: "AIzaSyDIAQXJ15atKJxu7PtcFL1W9JnO1N14pVs", authDomain: "radiobingo-9ac29.firebaseapp.com", databaseURL: "https://radiobingo-9ac29-default-rtdb.asia-southeast1.firebasedatabase.app", projectId: "radiobingo-9ac29", storageBucket: "radiobingo-9ac29.firebasestorage.app", messagingSenderId: "965903993397", appId: "1:965903993397:web:f6646fa05225f147eebf7c" };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database(); const auth = firebase.auth();
    let userData = {}; let selectedMood = null; let selectedImage = null; let currentPostId = null;
    let gameDrawn = []; let cardNumbers = []; let marks = [12]; let currentPattern = "Normal Bingo"; let isJackpotActive = false; let currentJackpotAmount = 500;
    
    // Sounds (Preserved)
    const sounds = { click: new Audio('https://cdn.pixabay.com/audio/2022/03/15/audio_2731885542.mp3'), newBall: new Audio('https://cdn.pixabay.com/audio/2022/03/10/audio_c8c8a73467.mp3'), pop: new Audio('https://cdn.freesound.org/previews/536/536108_1415754-lq.mp3'), win: new Audio('https://cdn.freesound.org/previews/270/270404_5123851-lq.mp3') };
    function playSound(type) { if(sounds[type]) { sounds[type].currentTime = 0; sounds[type].play().catch(e => console.log(e)); } }

    // === STARTUP ===
    window.onload = () => {
        lucide.createIcons();
        setTimeout(() => document.getElementById('loginOverlay').style.display = auth.currentUser ? 'none' : 'flex', 1000);
        checkNotifGate();
    };

    function login() { auth.signInWithPopup(new firebase.auth.GoogleAuthProvider()); }

    auth.onAuthStateChanged(u => {
        if(u) {
            document.getElementById('loginOverlay').style.display = 'none';
            document.getElementById('userPanel').style.display = 'flex';
            document.getElementById('myPcAvatar').src = u.photoURL;
            document.getElementById('userImg').src = u.photoURL;
            document.getElementById('pfAvatar').src = u.photoURL;
            
            // Fetch/Create User
            db.ref('users/' + u.uid).on('value', s => {
                if(!s.exists()) {
                    const newRefCode = Math.random().toString(36).substring(2, 8).toUpperCase();
                    db.ref('users/' + u.uid).set({ name: u.displayName, photo: u.photoURL, points: 500, bio: "Hello World!", refCode: newRefCode });
                }
                userData = s.val();
                userData.uid = u.uid;
                document.getElementById('userPoints').innerText = (userData.points || 0).toLocaleString();
                document.getElementById('pfName').innerText = userData.name;
                document.getElementById('pfBio').innerText = userData.bio || "No bio yet.";
                document.getElementById('pfPoints').innerText = (userData.points || 0).toLocaleString();
                
                // Initialize Tabs
                loadSocialFeed();
                initBingo(u.uid);
                setupPresence(u.uid);
                
                // Count Friends
                db.ref('friends/'+u.uid).on('value', f => {
                    document.getElementById('pfFriendCount').innerText = f.numChildren();
                });
            });
            requestNotifyPermission();
        }
    });

    // === NAVIGATION ===
    function switchTab(tab) {
        ['social', 'bingo', 'store', 'profile'].forEach(t => {
            document.getElementById(t+'Tab').style.display = 'none';
            document.getElementById('nav-'+t).classList.remove('active');
        });
        document.getElementById(tab+'Tab').style.display = 'block';
        document.getElementById('nav-'+tab).classList.add('active');
        
        if(tab === 'social') loadSocialFeed();
        if(tab === 'profile') loadMyPosts();
    }

    function switchStoreSection(sec) {
        document.getElementById('store-cashout').style.display = sec === 'cashout' ? 'block' : 'none';
        document.getElementById('store-skins').style.display = sec === 'skins' ? 'grid' : 'none';
        document.getElementById('store-earn').style.display = sec === 'earn' ? 'block' : 'none';
        document.getElementById('stCash').classList.toggle('active', sec === 'cashout');
        document.getElementById('stSkins').classList.toggle('active', sec === 'skins');
        document.getElementById('stEarn').classList.toggle('active', sec === 'earn');
    }

    // === SOCIAL FEED ALGORITHM (NEW) ===
    function loadSocialFeed() {
        const feed = document.getElementById('socialFeed');
        if(document.getElementById('socialTab').style.display === 'none') return;
        
        db.ref('socialPosts').limitToLast(30).once('value', s => {
            const posts = [];
            s.forEach(c => posts.push({ key: c.key, ...c.val() }));
            posts.reverse(); 

            feed.innerHTML = "";
            const pymkHTML = `<div class="pymk-container"><div class="pymk-header">People You May Know</div><div class="pymk-scroll" id="pymkList">Loading...</div></div>`;

            if(posts.length === 0) feed.innerHTML = "<div style='text-align:center; padding:40px;'>No posts yet. Be the first!</div>";

            posts.forEach((p, index) => {
                if(index === 2) feed.innerHTML += pymkHTML; // Insert Algorithm Block
                feed.appendChild(createPostCard(p));
            });

            if(posts.length >= 2) loadPYMK(); 
            lucide.createIcons();
        });
    }

    function createPostCard(p) {
        const div = document.createElement('div');
        div.className = 'post-card';
        const mood = p.mood ? `<span class="mood-display">Feeling ${p.mood}</span>` : '';
        const img = p.image ? `<div class="post-image-container"><img src="${p.image}" class="post-image"></div>` : '';
        
        div.innerHTML = `
            <div class="post-header">
                <img class="post-avatar" src="${p.authorPhoto}">
                <div class="post-meta">
                    <div class="post-author">${p.authorName}</div>
                    <div class="post-time">${new Date(p.timestamp).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}</div>
                    ${mood}
                </div>
            </div>
            <div class="post-content">${p.content}</div>
            ${img}
            <div class="post-stats">
                <span id="react-count-${p.key}">${p.likes || 0} Reactions</span>
                <span id="comm-count-${p.key}">Comments</span>
            </div>
            <div class="post-actions">
                <div class="reaction-dock">
                    <div class="reaction-btn" onclick="react('${p.key}', 'like')">üëç</div>
                    <div class="reaction-btn" onclick="react('${p.key}', 'love')">‚ù§Ô∏è</div>
                    <div class="reaction-btn" onclick="react('${p.key}', 'haha')">üòÇ</div>
                    <div class="reaction-btn" onclick="react('${p.key}', 'sad')">üò¢</div>
                    <div class="reaction-btn" onclick="react('${p.key}', 'angry')">üò°</div>
                </div>
                <button class="action-btn"><i data-lucide="thumbs-up" style="width:16px;"></i> React</button>
                <button class="action-btn" onclick="openComments('${p.key}')"><i data-lucide="message-circle" style="width:16px;"></i> Comment</button>
            </div>
            <div class="comments-preview-area" id="preview-${p.key}"></div>
        `;

        // Fetch Comment Preview
        db.ref('postComments/'+p.key).limitToLast(2).on('value', s => {
            const area = div.querySelector(`#preview-${p.key}`);
            if(s.exists()) {
                let html = "";
                s.forEach(c => { const com = c.val(); html += `<div class="comment-prev"><b>${com.uName}</b> ${com.text}</div>`; });
                area.innerHTML = html;
            } else { area.style.display = 'none'; }
        });
        return div;
    }

    function react(key, type) {
        db.ref('postReactions/'+key+'/'+auth.currentUser.uid).set(type);
        db.ref('socialPosts/'+key+'/likes').transaction(l => (l||0)+1);
        showToast(`Reacted with ${type}`);
    }

    function loadPYMK() {
        const list = document.getElementById('pymkList');
        if(!list) return;
        db.ref('users').limitToLast(10).once('value', s => {
            list.innerHTML = "";
            s.forEach(u => {
                const user = u.val();
                if(u.key !== auth.currentUser.uid) { 
                    const div = document.createElement('div');
                    div.className = 'pymk-card';
                    div.innerHTML = `<img class="pymk-img" src="${user.photo}"><div class="pymk-name">${user.name}</div><button class="btn-add-sm" onclick="addFriend('${u.key}')">Add</button>`;
                    list.appendChild(div);
                }
            });
        });
    }

    function loadMyPosts() {
        const div = document.getElementById('myPostsFeed');
        div.innerHTML = "Loading...";
        db.ref('socialPosts').orderByChild('uid').equalTo(auth.currentUser.uid).limitToLast(10).once('value', s => {
            div.innerHTML = "";
            s.forEach(p => div.prepend(createPostCard({key: p.key, ...p.val()})));
            if(!div.innerHTML) div.innerHTML = "<p style='text-align:center; opacity:0.5'>No posts yet.</p>";
            lucide.createIcons();
        });
    }

    // === POST CREATION ===
    function toggleMoodSelector() { document.getElementById('moodSelector').style.display = document.getElementById('moodSelector').style.display === 'none' ? 'flex' : 'none'; }
    function selectMood(m) { selectedMood = m; toggleMoodSelector(); showToast("Mood set: " + m); }
    function handlePostImage(input) { if (input.files && input.files[0]) { var reader = new FileReader(); reader.onload = function(e) { selectedImage = e.target.result; document.getElementById('postImgPreview').src = selectedImage; document.getElementById('imgPreviewCont').style.display = 'block'; }; reader.readAsDataURL(input.files[0]); } }
    function removePostImage() { selectedImage = null; document.getElementById('imgPreviewCont').style.display = 'none'; document.getElementById('postImgInput').value = ""; }
    
    function createPost() {
        const txt = document.getElementById('postInput').value;
        if(!txt && !selectedImage) return showToast("Write something!");
        db.ref('socialPosts').push({ uid: auth.currentUser.uid, authorName: userData.name, authorPhoto: userData.photo, content: txt, image: selectedImage, mood: selectedMood, timestamp: Date.now(), likes: 0 });
        document.getElementById('postInput').value = ""; removePostImage(); showToast("Posted!"); loadSocialFeed();
    }

    // === COMMENTS ===
    function openComments(pid) {
        currentPostId = pid;
        document.getElementById('commentModal').style.display = 'flex';
        const list = document.getElementById('commentList');
        db.ref('postComments/'+pid).on('child_added', s => {
            const c = s.val();
            const d = document.createElement('div');
            d.innerHTML = `<div style="background:#334155; padding:8px 12px; border-radius:12px; margin-bottom:5px; font-size:13px;"><b style="color:var(--accent-glow);">${c.uName}</b>: ${c.text}</div>`;
            list.appendChild(d);
            list.scrollTop = list.scrollHeight;
        });
    }

    function sendComment() {
        const txt = document.getElementById('commentInput').value;
        if(!txt) return;
        db.ref('postComments/'+currentPostId).push({ uid: auth.currentUser.uid, uName: userData.name, text: txt, timestamp: Date.now() });
        document.getElementById('commentInput').value = "";
    }

    // === BINGO GAME LOGIC (PRESERVED) ===
    function initBingo(uid) {
        db.ref('drawnNumbers').on('value', s => {
            const nums = s.val() ? Object.values(s.val()) : [];
            if(nums.length > 0) {
                const latest = nums[nums.length-1];
                document.getElementById('currentBall').innerText = latest;
                speakNumber(latest);
                gameDrawn = nums;
                renderPrevBalls(nums);
                updateGridHits();
                checkWin();
            }
        });
        db.ref('users/'+uid+'/currentCard').on('value', s => {
            if(s.exists()) { cardNumbers = s.val(); renderCard(s.val()); } else generateNewCard();
        });
        db.ref('gameState/currentPattern').on('value', s => { currentPattern = s.val() || "Normal Bingo"; document.getElementById('patternName').innerText = currentPattern; });
    }

    function generateNewCard() {
        let card = []; let cols = [[1,15],[16,30],[31,45],[46,60],[61,75]];
        cols.forEach(r => { let nums = []; while(nums.length < 5) { let n = Math.floor(Math.random() * (r[1] - r[0] + 1)) + r[0]; if(!nums.includes(n)) nums.push(n); } card.push(...nums); });
        let finalCard = []; for(let r=0; r<5; r++) { for(let c=0; c<5; c++) { finalCard.push(card[c*5 + r]); } }
        finalCard[12] = "FREE";
        db.ref('users/'+auth.currentUser.uid).update({ currentCard: finalCard });
    }

    function renderCard(nums) {
        const grid = document.getElementById('bingoGrid');
        grid.innerHTML = "";
        nums.forEach((n, i) => {
            const d = document.createElement('div');
            d.className = 'cell';
            d.innerText = n === "FREE" ? "‚òÖ" : n;
            if(n === "FREE") d.classList.add('hit');
            grid.appendChild(d);
        });
        updateGridHits();
    }
    
    function updateGridHits() {
        marks = [12];
        const cells = document.querySelectorAll('.cell');
        cells.forEach((c, i) => {
            const val = c.innerText;
            if(gameDrawn.includes(val.toString()) || val === "‚òÖ") { c.classList.add('hit'); if(!marks.includes(i)) marks.push(i); }
        });
    }

    function renderPrevBalls(nums) {
        const r = document.getElementById('ballRow');
        r.innerHTML = "";
        nums.slice(-5).reverse().forEach(n => { r.innerHTML += `<div class="ball-small">${n}</div>`; });
    }

    function checkWin() {
        if(userData.hasWonCurrent || gameDrawn.length === 0) return;
        let winningWays = [];
        if (currentPattern === "Blackout") { winningWays = [Array.from({length: 25}, (_, i) => i)]; } 
        else { winningWays = [[0,1,2,3,4],[5,6,7,8,9],[10,11,12,13,14],[15,16,17,18,19],[20,21,22,23,24],[0,5,10,15,20],[1,6,11,16,21],[2,7,12,17,22],[3,8,13,18,23],[4,9,14,19,24],[0,6,12,18,24],[4,8,12,16,20]]; }
        
        for(let i = 0; i < winningWays.length; i++) {
            let w = winningWays[i];
            if(w.every(idx => marks.includes(idx))) {
                triggerWin();
                break;
            }
        }
    }

    function triggerWin() {
        const uid = auth.currentUser.uid;
        let winPrize = 500;
        db.ref('gameState/latestWinner').set({ name: userData.name, uid: uid, prize: winPrize });
        db.ref('users/' + uid + '/points').transaction(p => (p || 0) + winPrize);
        db.ref('users/' + uid).update({ hasWonCurrent: true });
        userData.hasWonCurrent = true;
        showToast("BINGO!!! +500 Coins");
        playSound('win');
        confetti({ particleCount: 200, spread: 100 });
    }

    function speakNumber(num) { 
        if ('speechSynthesis' in window) { 
            let letter = "B"; if (num > 15) letter = "I"; if (num > 30) letter = "N"; if (num > 45) letter = "G"; if (num > 60) letter = "O"; 
            const msg = new SpeechSynthesisUtterance(`${letter} ${num}`); msg.rate = 0.9; window.speechSynthesis.speak(msg); 
        } 
    }

    // === STORE & ADS UTILS (Preserved) ===
    function startStrictWatch() { 
        const adsterraLink = "https://directoryeditorweep.com/9b/f5/85/9bf585b6ee39cb9b515e2fae1fa958c2.js"; 
        window.open(adsterraLink, "_blank"); 
        document.getElementById('adTimerOverlay').style.display = 'flex'; 
        let timeLeft = 15; 
        let timer = setInterval(() => { timeLeft--; document.getElementById('adCountdown').innerText = timeLeft + "s"; if(timeLeft <= 0) { clearInterval(timer); document.getElementById('adTimerOverlay').style.display = 'none'; document.getElementById('adCaptchaOverlay').style.display = 'flex'; } }, 1000); 
    }
    function verifyAdMath() { 
        if(document.getElementById('mathAns').value === "8") { document.getElementById('adCaptchaOverlay').style.display = 'none'; db.ref('users/'+auth.currentUser.uid+'/points').transaction(p=>(p||0)+50); showToast("+50 Coins Added!"); } 
        else showToast("Wrong Answer!"); 
    }
    function openVideoLocker(type) { 
        if(localStorage.getItem('task_cooldown_video') && (Date.now() - localStorage.getItem('task_cooldown_video') < 300000)) return showToast("Cooldown active.");
        localStorage.setItem('task_cooldown_video', Date.now());
        window.open("https://doctoredits.com/script_include.php?id=1874676", "_blank");
    }
    
    function buyOrEquipSkin(skinId, cost) {
        if(!userData.ownedSkins) userData.ownedSkins = ['default'];
        if(userData.ownedSkins.includes(skinId)) {
             db.ref('users/' + userData.uid).update({ equippedSkin: skinId }); showToast("Equipped!");
        } else {
            if(userData.points >= cost) {
                db.ref('users/' + userData.uid + '/points').transaction(p => p - cost);
                let newSkins = userData.ownedSkins; newSkins.push(skinId);
                db.ref('users/' + userData.uid).update({ ownedSkins: newSkins, equippedSkin: skinId });
                showToast("Purchased!");
            } else showToast("Insufficient Coins");
        }
    }
    
    // === CHAT & UTILS ===
    function sendChat() {
        const inp = document.getElementById('chatIn');
        if(!inp.value) return;
        db.ref('chats').push({ name: userData.name, msg: inp.value, pfp: userData.photo, uid: userData.uid });
        inp.value = "";
    }
    function setupPresence(uid) {
        db.ref('.info/connected').on('value', s => { if(s.val()) db.ref('status/'+uid).onDisconnect().remove(); db.ref('status/'+uid).set('online'); });
        db.ref('status').on('value', s => document.getElementById('onlineCount').innerText = s.numChildren());
    }
    function requestGatePermission() { Notification.requestPermission().then(p => { if(p === "granted") document.getElementById('notifBlocker').style.display = 'none'; }); }
    function checkNotifGate() { if(Notification.permission !== "granted") document.getElementById('notifBlocker').style.display = 'flex'; }
    function showToast(msg) { const t = document.getElementById('customToast'); document.getElementById('toastMsg').innerText = msg; t.classList.add('show'); setTimeout(() => t.classList.remove('show'), 3000); }
    function addFriend(targetUid) { db.ref('friends/'+auth.currentUser.uid+'/'+targetUid).set(true); showToast("Friend Added!"); }
    function editBio() { const n = prompt("New Bio:"); if(n) db.ref('users/'+auth.currentUser.uid).update({ bio: n }); }
    function copyInvite() { navigator.clipboard.writeText(window.location.origin + "?ref=" + userData.refCode); showToast("Link Copied!"); }
</script>
</body>
</html>
