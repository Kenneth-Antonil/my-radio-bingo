<!DOCTYPE html>
<html lang="tl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#0f172a">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Radio Bingo Live | Social Ecosystem</title>
    
    <script>
        if (window.location.pathname.endsWith("index.html")) {
            var newPath = window.location.pathname.replace(/index\.html$/, "");
            window.history.replaceState({}, document.title, newPath);
        }
    </script>

    <link rel="icon" type="image/png" href="https://i.imgur.com/7D8u8h6.png">
    <link rel="apple-touch-icon" href="https://i.imgur.com/7D8u8h6.png">
    <link rel="manifest" href="manifest.json">
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;900&family=Comic+Neue:wght@700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-messaging.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

    <script src="https://pl28660488.effectivegatecpm.com/9b/f5/85/9bf585b6ee39cb9b515e2fae1fa958c2.js"></script>
    <script src="https://pl28660496.effectivegatecpm.com/a6/64/bf/a664bf7e7084386b4f4b428590030df3.js"></script>

    <style>
        /* === CORE VARIABLES === */
        :root { 
            --bg-overlay: rgba(15, 23, 42, 0.95); 
            --glass-surface: rgba(30, 41, 59, 0.75);
            --glass-border: rgba(255, 255, 255, 0.08);
            
            --accent: #0ea5e9; /* Ocean Blue */
            --accent-glow: #38bdf8;
            --text: #ffffff; 
            --gold: #fbbf24; 
            --gold-shine: #fcd34d;
            --success: #10b981; 
            --danger: #ef4444; 
            --minigame: #f472b6;
            
            /* Messenger Colors */
            --messenger-blue: #3b82f6;
            --messenger-grey: #334155;
            --messenger-bg: #020617;
        }
        
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; user-select: none; }
        
        body { 
            font-family: 'Inter', sans-serif; 
            background: #0f172a;
            color: var(--text); 
            margin: 0; 
            padding-bottom: calc(90px + env(safe-area-inset-bottom)); 
            overflow-x: hidden; 
            min-height: 100vh;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.5);
        }

        /* === BADGE & ACTIVE INDICATOR SYSTEM === */
        .avatar-frame {
            position: relative;
            display: inline-block;
            flex-shrink: 0;
            cursor: pointer;
        }
        .avatar-frame img {
            display: block;
            border-radius: 50%;
            border: 2px solid rgba(255,255,255,0.1);
            object-fit: cover;
            width: 100%;
            height: 100%;
            transition: transform 0.2s;
        }
        .avatar-frame:active img { transform: scale(0.95); }

        .avatar-badge-icon {
            position: absolute;
            bottom: -2px;
            right: -2px;
            width: 35%; 
            height: 35%;
            border-radius: 50%;
            background: #0f172a; 
            border: 2px solid #0f172a;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            z-index: 10;
            box-shadow: 0 2px 5px rgba(0,0,0,0.5);
        }
        
        /* ACTIVE GREEN DOT INDICATOR */
        .online-status-dot {
            position: absolute;
            bottom: 2px;
            right: 2px;
            width: 12px;
            height: 12px;
            background-color: #22c55e;
            border: 2px solid #0f172a;
            border-radius: 50%;
            z-index: 11;
            box-shadow: 0 0 0 1px rgba(0,0,0,0.2);
            display: none;
        }
        .online-status-dot.active { display: block; }

        .tier-bronze-bg { background: linear-gradient(135deg, #cd7f32, #a0522d); }
        .tier-silver-bg { background: linear-gradient(135deg, #e0e0e0, #9ca3af); }
        .tier-gold-bg { background: linear-gradient(135deg, #fcd34d, #b45309); border: 1px solid #fcd34d; }
        .tier-platinum-bg { background: linear-gradient(135deg, #e5e4e2, #64748b); border: 1px solid white; }
        .tier-diamond-bg { background: linear-gradient(135deg, #b9f2ff, #06b6d4); box-shadow: 0 0 5px #06b6d4; border: 1px solid #06b6d4; }

        /* === MODERN DISCLAIMER === */
        .disclaimer-modern {
            background: rgba(15, 23, 42, 0.8);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(255,255,255,0.05);
            padding: 8px 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        .disclaimer-badge {
            background: rgba(239, 68, 68, 0.2);
            color: #f87171;
            border: 1px solid rgba(239, 68, 68, 0.3);
            font-size: 9px;
            font-weight: 900;
            padding: 3px 6px;
            border-radius: 6px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .disclaimer-text {
            font-size: 10px;
            color: #cbd5e1;
            font-weight: 500;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        /* === MODERN POST CREATOR === */
        .post-creator-modern {
            background: #1e293b; 
            backdrop-filter: blur(20px);
            padding: 15px;
            border-radius: 20px;
            border: 1px solid rgba(255, 255, 255, 0.05);
            margin-bottom: 20px;
            box-shadow: 0 10px 30px -10px rgba(0,0,0,0.3);
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        .post-input-modern {
            background: rgba(0,0,0,0.2);
            border: 1px solid rgba(255,255,255,0.05);
            border-radius: 12px;
            padding: 15px;
            color: white;
            font-family: 'Inter', sans-serif;
            font-size: 14px;
            resize: none;
            min-height: 80px;
            outline: none;
            transition: 0.3s;
        }
        .post-input-modern:focus { background: rgba(0,0,0,0.4); border-color: rgba(255,255,255,0.1); }
        
        .mood-selector {
            display: flex; gap: 8px; overflow-x: auto; padding: 5px 2px 10px 2px; scrollbar-width: none;
        }
        .mood-selector::-webkit-scrollbar { display: none; }
        .mood-chip {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            padding: 8px 16px; border-radius: 20px;
            font-size: 12px; font-weight: 700; color: #94a3b8;
            white-space: nowrap; cursor: pointer;
            transition: all 0.2s; flex-shrink: 0;
        }
        .mood-chip.active {
            background: var(--accent); color: white; border-color: var(--accent-glow); transform: scale(1.05);
        }

        .post-tools {
            display: flex; justify-content: space-between; align-items: center; border-top: 1px solid rgba(255,255,255,0.05); padding-top: 15px;
        }
        .tool-btn {
            display: flex; align-items: center; gap: 6px;
            background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.05);
            padding: 8px 14px; border-radius: 30px; color: #94a3b8;
            font-size: 11px; font-weight: 700; cursor: pointer; transition: 0.2s;
        }
        .btn-post-modern {
            background: var(--accent); color: white; border: none;
            padding: 8px 20px; border-radius: 30px; font-weight: 800; font-size: 12px;
            cursor: pointer; box-shadow: 0 4px 15px rgba(14, 165, 233, 0.3);
        }

        /* === MESSENGER & NOTIFS === */
        .msg-image-preview { max-width: 200px; border-radius: 12px; border: 1px solid rgba(255,255,255,0.1); margin-top: 5px; }
        .msg-heart-reaction { position: absolute; bottom: -8px; right: -5px; background: #1e293b; border: 1px solid #334155; border-radius: 10px; padding: 2px 4px; font-size: 10px; }
        
        .notif-card-grouped {
            background: rgba(30, 41, 59, 0.4);
            border-left: 3px solid var(--accent);
            margin-bottom: 8px; padding: 12px;
            border-radius: 0 12px 12px 0;
            display: flex; align-items: center; gap: 12px;
            cursor: pointer; transition: 0.2s;
        }
        .notif-img { width: 36px; height: 36px; border-radius: 50%; object-fit: cover; border: 1px solid rgba(255,255,255,0.1); }
        .notif-content-wrap { flex: 1; }
        .notif-delete-btn {
            background: rgba(239, 68, 68, 0.1); color: #ef4444; border: none;
            width: 24px; height: 24px; border-radius: 6px;
            display: flex; align-items: center; justify-content: center; cursor: pointer;
        }

        /* === BINGO CARD SKINS FIX === */
        .card-skin-neon { border: 2px solid #06b6d4 !important; background: rgba(8, 51, 68, 0.95) !important; box-shadow: 0 0 20px #06b6d4 !important; }
        .card-skin-neon .cell { border-color: #06b6d4 !important; color: #67e8f9 !important; text-shadow: 0 0 5px #06b6d4 !important; }
        
        .card-skin-gold { border: 2px solid #f59e0b !important; background: linear-gradient(135deg, #451a03, #000) !important; box-shadow: 0 0 25px #f59e0b !important; }
        .card-skin-gold .cell { border-color: #fbbf24 !important; color: #fcd34d !important; font-family: serif; }
        
        .card-skin-kitty { border: 4px solid #ffc0cb !important; background: radial-gradient(circle, #fff0f5, #ff69b4) !important; font-family: 'Comic Neue', cursive; }
        .card-skin-kitty .cell { background: white !important; color: #ff1493 !important; border: 2px solid #ffc0cb !important; border-radius: 15px !important; }

        .card-skin-doraemon { border: 4px solid #0096df !important; background: linear-gradient(180deg, #0096df 0%, #ffffff 100%) !important; }
        .card-skin-doraemon .cell { background: rgba(255,255,255,0.9) !important; color: #0096df !important; border: 2px solid #dd1616 !important; border-radius: 50% !important; }

        .card-skin-spongebob { border: 4px solid #f7f44d !important; background: #f7f44d !important; }
        .card-skin-spongebob .cell { background: rgba(255,255,255,0.8) !important; color: #7d5837 !important; border: 2px dashed #7d5837 !important; }
        
        .card-skin-kuromi { border: 4px solid #000000 !important; background: linear-gradient(135deg, #000000, #4b0082) !important; }
        .card-skin-kuromi .cell { background: rgba(234, 101, 162, 0.2) !important; color: #ea65a2 !important; border: 1px solid #ea65a2 !important; }

        .card-skin-custom { background-size: cover !important; background-position: center !important; border: 2px solid rgba(255,255,255,0.5) !important; }
        .card-skin-custom .cell { background: rgba(0,0,0,0.6) !important; backdrop-filter: blur(4px); color: white !important; border: 1px solid rgba(255,255,255,0.3) !important; }

        /* CRITICAL FIX FOR TANTOS (MARKERS) VISIBILITY */
        .cell.hit {
            background: linear-gradient(135deg, var(--accent), #2563eb) !important;
            color: white !important;
            opacity: 1 !important;
            z-index: 5 !important;
            border-color: rgba(255,255,255,0.5) !important;
            box-shadow: 0 5px 15px rgba(59, 130, 246, 0.6) !important;
            transform: scale(0.95);
        }

        /* === SOCIAL FEED UPDATED === */
        .feed-filter-bar { display: flex; gap: 10px; margin: 15px 0; align-items: center; }
        .feed-sort-btn {
            background: transparent; border: 1px solid rgba(255,255,255,0.1);
            color: #94a3b8; font-weight: 700; font-size: 12px;
            display: flex; align-items: center; gap: 6px;
            padding: 8px 15px; border-radius: 20px; cursor: pointer;
        }
        .feed-sort-btn.active { background: rgba(14, 165, 233, 0.15); color: var(--accent-glow); border-color: var(--accent); }

        .post-card { background: #1e293b; border-radius: 16px; border: 1px solid rgba(255,255,255,0.05); margin-bottom: 15px; overflow: hidden; }
        .post-header { padding: 12px; display: flex; align-items: center; gap: 10px; }
        .post-meta { flex: 1; }
        .post-author { font-size: 14px; font-weight: 800; color: white; display: flex; align-items: center; gap: 5px; cursor: pointer;}
        .post-time { font-size: 11px; color: #94a3b8; }
        .mood-display { font-size: 10px; background: rgba(255,255,255,0.1); padding: 2px 8px; border-radius: 8px; margin-top: 2px; display: inline-block; color: var(--accent-glow); }
        .post-content { padding: 0 15px 15px 15px; font-size: 14px; line-height: 1.5; color: #e2e8f0; }
        .post-image-container { width: 100%; display: flex; justify-content: center; background: #000; }
        .post-image { max-width: 100%; max-height: 400px; object-fit: contain; }
        
        .shared-post-wrapper { margin: 0 15px 15px 15px; border: 1px solid rgba(255,255,255,0.1); border-radius: 12px; background: rgba(15, 23, 42, 0.5); overflow: hidden; }
        .shared-header { padding: 10px; border-bottom: 1px solid rgba(255,255,255,0.05); font-size: 11px; color: #94a3b8; display:flex; align-items:center; gap:5px; }

        .post-stats-bar { padding: 8px 15px; border-top: 1px solid rgba(255,255,255,0.05); display: flex; justify-content: space-between; font-size: 11px; color: #94a3b8; }
        .post-actions { display: flex; border-top: 1px solid rgba(255,255,255,0.05); }
        .action-btn { flex: 1; background: transparent; border: none; color: #94a3b8; padding: 12px; font-size: 12px; font-weight: 600; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 6px; }
        .action-btn.liked { color: var(--minigame); }

        .comment-preview-area { background: rgba(0,0,0,0.2); padding: 10px 15px; font-size: 12px; display: flex; gap: 8px; align-items: flex-start; cursor: pointer; }
        .cmt-prev-user { font-weight: 800; color: white; }
        .cmt-prev-text { color: #cbd5e1; opacity: 0.9; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 80%; }

        /* === PROFILE PAGE === */
        .profile-page-container { position: fixed; inset: 0; background: #020617; z-index: 6000; display: none; flex-direction: column; overflow-y: auto; padding-bottom: 100px; }
        .profile-cover { width: 100%; height: 280px; background-size: cover !important; background-position: center !important; position: relative; }
        .profile-info-section { padding: 0 20px; margin-top: -60px; position: relative; z-index: 10; display: flex; flex-direction: column; align-items: center; }
        .profile-name-large { font-size: 24px; font-weight: 900; color: white; margin: 10px 0 5px 0; text-shadow: 0 2px 10px rgba(0,0,0,0.8); }
        .profile-action-btn { width: 100%; max-width: 250px; padding: 12px; border-radius: 30px; font-weight: 800; margin-bottom: 15px; border: none; cursor: pointer; background: white; color: black; }
        .profile-action-btn.secondary { background: rgba(255,255,255,0.1); color: white; border: 1px solid rgba(255,255,255,0.2); }
        .btn-unfriend-modern { background: rgba(239, 68, 68, 0.1); color: #ef4444; border: 1px solid rgba(239, 68, 68, 0.3); padding: 10px; width: 100%; max-width: 250px; border-radius: 12px; font-weight: 700; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; margin-bottom: 20px; }

        /* Other Preserved Styles */
        .bottom-nav { position: fixed; bottom: 0; left: 0; right: 0; background: rgba(15, 23, 42, 0.98); backdrop-filter: blur(20px); border-top: 1px solid rgba(255,255,255,0.05); height: calc(65px + env(safe-area-inset-bottom)); display: flex; justify-content: space-around; align-items: flex-start; z-index: 5000; padding-top: 10px; padding-bottom: env(safe-area-inset-bottom); }
        .nav-item { display: flex; flex-direction: column; align-items: center; gap: 4px; color: #94a3b8; width: 20%; background: none; border: none; cursor: pointer; }
        .nav-item.active { color: var(--accent-glow); }
        .nav-icon-bg { background: linear-gradient(135deg, var(--accent), #2563eb); width: 50px; height: 50px; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; border: 4px solid #0f172a; margin-top: -25px; box-shadow: 0 5px 15px rgba(14, 165, 233, 0.4); }

        .nav { background: rgba(15, 23, 42, 0.95); backdrop-filter: blur(15px); padding: 10px 15px; display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 100; border-bottom: 1px solid rgba(255,255,255,0.1); height: 60px; }
        .user-stats { display: flex; align-items: center; gap: 8px; }
        .icon-btn { background: rgba(255,255,255,0.1); color: white; width: 38px; height: 38px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; position: relative; border: none; }
        .notif-badge { position: absolute; top: 0; right: 0; background: var(--danger); font-size: 10px; width: 16px; height: 16px; border-radius: 50%; display: none; align-items: center; justify-content: center; border: 2px solid #0f172a; }
        
        .card { background: var(--glass-surface); backdrop-filter: blur(20px); border-radius: 24px; padding: 15px; margin-bottom: 20px; border: 1px solid var(--glass-border); position: relative; box-shadow: 0 15px 35px rgba(0,0,0,0.4); }
        .grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 4px; position: relative; }
        .cell { aspect-ratio: 1; background: rgba(255,255,255,0.1); border-radius: 12px; display: flex; align-items: center; justify-content: center; font-weight: 800; font-size: 16px; border: 1px solid rgba(255,255,255,0.15); color: white; text-shadow: 0 2px 3px black; position: relative; z-index: 2; }
        
        /* Modals & Utils */
        .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 6000; display: none; align-items: center; justify-content: center; padding: 15px; backdrop-filter: blur(15px); }
        .modal-content { background: #1e293b; border-radius: 24px; width: 100%; max-width: 450px; padding: 25px; border: 1px solid rgba(255,255,255,0.1); max-height: 90vh; overflow-y: auto; }
        .container { width: 100%; max-width: 500px; margin: 0 auto; padding: 10px; padding-bottom: 120px; }
        .reaction-popup { position: absolute; bottom: 100%; left: 10px; background: #1e293b; border-radius: 50px; padding: 5px 10px; display: none; gap: 5px; box-shadow: 0 5px 15px rgba(0,0,0,0.5); border: 1px solid rgba(255,255,255,0.1); z-index: 10; }
        .reaction-emoji { font-size: 20px; cursor: pointer; transition: transform 0.2s; }
        .reaction-emoji:hover { transform: scale(1.3); }

        /* Ensure PyMK works */
        .pymk-section { margin-bottom: 20px; }
        .pymk-scroll { display: flex; gap: 12px; overflow-x: auto; padding-bottom: 10px; scrollbar-width: none; }
        .pymk-card { background: #1e293b; border: 1px solid rgba(255,255,255,0.05); min-width: 140px; padding: 15px; border-radius: 16px; display: flex; flex-direction: column; align-items: center; }
        .btn-add-friend-sm { background: rgba(14, 165, 233, 0.2); color: var(--accent-glow); border: 1px solid var(--accent); padding: 6px 12px; border-radius: 20px; font-size: 11px; font-weight: 800; cursor: pointer; width: 100%; margin-top: 10px; }
        
        /* Store & Tasks */
        .store-nav { display: flex; gap: 8px; margin-bottom: 15px; background: rgba(0,0,0,0.3); padding: 5px; border-radius: 12px; }
        .store-tab-btn { flex: 1; padding: 10px; border: none; background: transparent; color: #94a3b8; font-weight: 800; border-radius: 8px; cursor: pointer; font-size: 11px; text-transform: uppercase; }
        .store-tab-btn.active { background: var(--accent); color: white; }
        .task-list { display: flex; flex-direction: column; gap: 10px; }
        .task-item { background: linear-gradient(135deg, rgba(30,41,59,0.9), rgba(15,23,42,0.95)); padding: 15px; border-radius: 16px; border: 1px solid rgba(255,255,255,0.1); display: flex; justify-content: space-between; align-items: center; }
        .btn-do-task { background: var(--accent); color: white; border: none; padding: 10px 18px; border-radius: 10px; font-weight: 800; cursor: pointer; }
    </style>
</head>
    <body>

<div class="bottom-nav">
    <button class="nav-item active" onclick="switchTab('home')" id="nav-home">
        <i data-lucide="home" class="nav-icon"></i>
        <span class="nav-label">Home</span>
    </button>
    <button class="nav-item" onclick="switchTab('bingo')" id="nav-bingo">
        <i data-lucide="play-circle" class="nav-icon"></i>
        <span class="nav-label">Bingo</span>
    </button>
    <div class="nav-center" onclick="openPostCreator()">
        <div class="nav-icon-bg"><i data-lucide="plus" style="width:28px; height:28px;"></i></div>
    </div>
    <button class="nav-item" onclick="document.getElementById('storeModal').style.display='flex'" id="nav-store">
        <i data-lucide="shopping-bag" class="nav-icon"></i>
        <span class="nav-label">Store</span>
    </button>
    <button class="nav-item" onclick="openMyProfile()" id="nav-profile">
        <i data-lucide="user" class="nav-icon"></i>
        <span class="nav-label">Me</span>
    </button>
</div>
    <div class="sticky-ad-footer">
    <script type="text/javascript">
        atOptions = { 'key' : 'a664bf7e7084386b4f4b428590030df3', 'format' : 'iframe', 'height' : 50, 'width' : 320, 'params' : {} };
    </script>
    <script type="text/javascript" src="https://pl28660496.effectivegatecpm.com/a6/64/bf/a664bf7e7084386b4f4b428590030df3.js"></script>
</div>
<div id="customPopupBanner">
    <div style="position:relative; max-width:400px; width:100%; animation: popScale 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);">
        <button onclick="closeCustomBanner()" style="position:absolute; top:-15px; right:-10px; background:linear-gradient(135deg, #ef4444, #b91c1c); color:white; border:2px solid white; border-radius:50%; width:36px; height:36px; font-weight:bold; cursor:pointer; z-index:10; display:flex; align-items:center; justify-content:center; box-shadow:0 4px 10px rgba(0,0,0,0.3);"><i data-lucide="x" style="width:20px"></i></button>
        <img id="customBannerImg" src="" style="width:100%; border-radius:20px; border:2px solid rgba(255,255,255,0.2); box-shadow:0 20px 50px rgba(0,0,0,0.8); cursor:pointer; object-fit:cover;" onclick="clickCustomBanner()">
    </div>
</div>

<div id="installGate">
    <div class="gate-logo">RB<span>LIVE</span></div>
    <div class="gate-title">Install to Play</div>
    <p class="gate-desc">To access the full Radio Bingo experience, you must install the official App.</p>
    <button id="gateInstallBtn" class="gate-btn-install" onclick="triggerInstall()">
        <i data-lucide="download-cloud" style="width:20px; height:20px;"></i> INSTALL APP
    </button>
    <div id="gateIosNote" class="gate-ios-note">
        <div style="font-weight:800; color:white; margin-bottom:10px; text-transform:uppercase;">iOS Instructions:</div>
        <div class="ios-step"><i data-lucide="share" class="ios-icon" style="width:16px;"></i> 1. Tap the Share button below.</div>
        <div class="ios-step"><i data-lucide="plus-square" class="ios-icon" style="width:16px;"></i> 2. Scroll down & tap 'Add to Home Screen'.</div>
        <div class="ios-step"><i data-lucide="check" class="ios-icon" style="width:16px;"></i> 3. Launch App from Home Screen.</div>
    </div>
</div>

<div id="notifBlocker">
    <div class="notif-gate-icon">
        <i data-lucide="bell-ring" style="width: 40px; height: 40px; color: #3b82f6;"></i>
    </div>
    <div class="notif-gate-title">ENABLE NOTIFICATIONS</div>
    <p class="notif-gate-desc">To ensure fairness and real-time updates for Bingo Calls, this app requires push notifications to be enabled.</p>
    <button onclick="requestGatePermission()" class="btn-allow-notif">
        <i data-lucide="check-circle" style="width:20px"></i> ALLOW NOTIFICATIONS
    </button>
    <div id="blockedHelp" class="blocked-help">
        <strong style="color:var(--danger); display:block; margin-bottom:5px;">‚ö†Ô∏è NOTIFICATIONS ARE BLOCKED!</strong>
        1. Click the <b>Lock Icon üîí</b> or <b>Settings Icon</b> beside the URL bar.<br>
        2. Click <b>Permissions</b> or <b>Site Settings</b>.<br>
        3. Find <b>Notifications</b> and set to <b>Allow</b>.<br>
        4. Reload this page.
    </div>
</div>

<div id="splash-screen">
    <div class="splash-logo">RB<span>LIVE</span></div>
    <div class="splash-loader"></div>
</div>

<div id="customToast">
    <i data-lucide="info" class="toast-icon"></i>
    <span class="toast-msg" id="toastMsg">Notification!</span>
</div>

<div id="customConfirmModal">
    <div class="conf-content">
        <i data-lucide="alert-circle" style="width: 40px; height: 40px; color: var(--gold); margin-bottom: 15px;"></i>
        <h3 class="conf-title" id="confTitle">Confirm Action</h3>
        <p class="conf-msg" id="confMsg">Are you sure you want to proceed?</p>
        <div class="conf-actions">
            <button class="btn-conf-no" onclick="closeCustomConfirm()">CANCEL</button>
            <button class="btn-conf-yes" id="confYesBtn">CONFIRM</button>
        </div>
    </div>
</div>

<div id="loginOverlay">
    <div class="login-bg-blob blob-1"></div>
    <div class="login-bg-blob blob-2"></div>
    <div class="login-app-container">
        <div class="app-logo-lg">RB<span>LIVE</span></div>
        <p class="app-tagline">The ultimate live bingo experience.<br>Play, Win, and Redeem Rewards.</p>
        <div class="promo-badge">
            <i data-lucide="gift" style="width:16px"></i> 
            <span>Register now & Get 500 Free RB Coins</span>
        </div>
        <div class="auth-btn-group">
            <button class="btn-main-auth" onclick="login()">
                <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/action/google.svg" alt="Google" style="width:20px">
                Sign in with Google
            </button>
        </div>
    </div>
    <div class="login-footer-legal">
        <div class="legal-text">
            <span>‚ö†Ô∏è DISCLAIMER: NOT A GAMBLING SITE</span>
            <span style="opacity: 0.6; font-size: 9px;">For entertainment purposes only. No real money betting.</span>
            <div style="margin-top: 5px; opacity: 0.8; font-size: 10px;">
                <a href="terms.html" style="color:#cbd5e1; text-decoration:none; margin:0 5px;">Terms</a> |
                <a href="privacy.html" style="color:#cbd5e1; text-decoration:none; margin:0 5px;">Privacy</a>
            </div>
        </div>
    </div>
</div>

<div class="nav">
    <div style="display:flex; align-items:center; gap:10px;">
        <span style="font-weight: 900; font-size: 20px; text-shadow: 0 2px 5px rgba(0,0,0,0.8);">RB <span style="color:var(--accent-glow)">LIVE</span></span>
    </div>
    <div id="userPanel" style="display:none; align-items: center; gap: 10px;">
        <div class="user-stats">
            <div class="icon-btn" onclick="openSearch()">
                <i data-lucide="search" style="width:20px"></i>
            </div>
            <div class="icon-btn" onclick="openMessenger()">
                <i data-lucide="message-circle" style="width:20px"></i>
                <span id="pmBadge" class="notif-badge"></span>
            </div>
            <div class="icon-btn" onclick="openNotifs()">
                <i data-lucide="bell" style="width:20px"></i>
                <span id="notifDot" class="notif-badge"></span>
            </div>
        </div>
        <div id="userImgContainer" onclick="openMenuModal()"></div>
    </div>
</div>

<div class="disclaimer-modern">
    <div class="disclaimer-badge">NOTICE</div>
    <div class="disclaimer-text">Hindi ito gambling site. For entertainment purposes lamang.</div>
</div>

<div class="container">
    <div class="ad-container-global">
        <script type="text/javascript">
            atOptions = { 'key' : '9bf585b6ee39cb9b515e2fae1fa958c2', 'format' : 'iframe', 'height' : 50, 'width' : 320, 'params' : {} };
        </script>
        <script type="text/javascript" src="https://pl28660488.effectivegatecpm.com/9b/f5/85/9bf585b6ee39cb9b515e2fae1fa958c2.js"></script>
    </div>

    <div id="view-home" style="display:block;">
        <div id="friendRequestsSection"></div>
        
        <div class="post-creator-modern" id="mainPostCreator">
            <h4 style="margin:0; color:white; font-size:16px; font-weight:800; display:flex; align-items:center; gap:8px;">
                <i data-lucide="edit-3" style="width:16px; color:var(--accent-glow);"></i> Create Post
            </h4>
            
            <textarea id="postInput" class="post-input-modern" placeholder="What's on your mind?"></textarea>
            
            <div class="image-preview-container" id="imgPreviewCont">
                <img id="postImgPreview" class="image-preview-img">
                <div class="btn-remove-img" onclick="removePostImage()"><i data-lucide="x" style="width:12px;"></i></div>
            </div>

            <div class="mood-selector">
                <div class="mood-chip" onclick="selectMood(this, 'Happy')">üòä Happy</div>
                <div class="mood-chip" onclick="selectMood(this, 'Sad')">üòî Sad</div>
                <div class="mood-chip" onclick="selectMood(this, 'Excited')">ü§© Excited</div>
                <div class="mood-chip" onclick="selectMood(this, 'Cool')">üòé Cool</div>
                <div class="mood-chip" onclick="selectMood(this, 'Angry')">üò° Angry</div>
                <div class="mood-chip" onclick="selectMood(this, 'Lucky')">üçÄ Lucky</div>
            </div>

            <div class="post-tools">
                <label for="postImgInput" class="tool-btn photo-tool">
                    <i data-lucide="image" style="width:16px;"></i> Photo
                </label>
                <input type="file" id="postImgInput" accept="image/*" style="display:none" onchange="handlePostImage(this)">
                
                <button class="btn-post-modern" onclick="createPost()">POST</button>
            </div>
        </div>

        <div id="pymkSection" class="pymk-section" style="display:none;">
            <div class="pymk-title">People You May Know</div>
            <div class="pymk-scroll" id="pymkList"></div>
        </div>

        <div class="feed-filter-bar">
            <button class="feed-sort-btn active" id="sort-hype" onclick="toggleFeedSort('hype')">
                <i data-lucide="flame" style="width:14px"></i> HYPE
            </button>
            <button class="feed-sort-btn" id="sort-new" onclick="toggleFeedSort('new')">
                <i data-lucide="clock" style="width:14px"></i> NEWEST
            </button>
        </div>

        <div id="socialFeed" class="social-feed-container">
            <div style="text-align:center; padding:20px; opacity:0.5;">Loading Feed...</div>
        </div>
    </div>

    <div id="view-bingo" style="display:none;">
        <div class="video-feed-wrapper">
            <div class="video-container">
                <div class="video-overlay-bl"><i data-lucide="users" style="width:14px"></i><span id="onlineCount">0</span> ONLINE</div>
                <div id="videoOfflineState" style="display:none; position:absolute; inset:0; background:#0f172a; flex-direction:column; align-items:center; justify-content:center; z-index:20;">
                    <div style="width:60px; height:60px; background:rgba(255,255,255,0.05); border-radius:50%; display:flex; align-items:center; justify-content:center; margin-bottom:15px; animation:pulse-ring 2s infinite;">
                        <i data-lucide="radio" style="width:30px; height:30px; color:#94a3b8;"></i>
                    </div>
                    <h3 style="margin:0; font-size:16px; font-weight:900; color:white; letter-spacing:1px;">WAITING FOR LIVE</h3>
                    <p style="margin:5px 0 0; font-size:12px; color:#64748b;">Stand by for the next draw.</p>
                </div>
                <iframe id="liveVideoFrame" width="100%" height="100%" src="https://www.youtube.com/embed/4I_NSJTbdXo?autoplay=1&mute=1" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" referrerpolicy="strict-origin-when-cross-origin" allowfullscreen style="border:none; position:absolute; top:0; left:0; width:100%; height:100%;"></iframe>
            </div>
        </div>

        <div id="jackpotBanner">
            <div class="jp-label-new">
                <i data-lucide="crown" style="width: 16px;"></i> JACKPOT ROUND <i data-lucide="crown" style="width: 16px;"></i>
            </div>
            <span class="jackpot-amount" id="jackpotDisplayVal">5,000</span>
            <div style="font-size: 10px; opacity: 0.7; margin-top: 5px; color: #fbbf24;">RB COINS GRAND PRIZE</div>
        </div>

        <div id="nextDrawBanner" class="next-draw-container">
            <div class="nd-icon"><i data-lucide="calendar-days"></i></div>
            <div class="nd-info">
                <div class="next-draw-label">Susunod na Bola</div>
                <div id="nextDrawTime" class="next-draw-time">--:-- --</div>
            </div>
        </div>
        
        <div id="winnerBanner">
            <span><i data-lucide="party-popper" style="width:24px; height:24px;"></i> BINGO WINNER!</span>
            <span class="winner-line" id="winnerPatternLine">Pattern: Normal Bingo</span>
        </div>

        <div class="draw-panel">
            <div class="prev-balls" id="ballRow"></div>
            <div class="current-ball-box"><span style="font-size:9px; font-weight:800; opacity:0.8; color:white;">NOW DRAWN</span><span id="currentBall" style="font-size:36px; font-weight:900; color:white; text-shadow:0 2px 10px rgba(0,0,0,0.5);">--</span></div>
        </div>
        
        <div class="card" id="bingoCardContainer">
            <div id="lateOverlay" class="late-overlay">
                <i data-lucide="lock" style="color:var(--danger); width:48px; height:48px; margin-bottom:15px; filter: drop-shadow(0 0 10px var(--danger));"></i>
                <div class="late-text">GAME ONGOING</div>
                <div class="late-subtext">Sorry, ongoing na ang bola. Bawal na sumali ang late.</div>
                <div style="margin-top:20px; background:rgba(255,255,255,0.1); padding:10px 20px; border-radius:12px; border:1px solid rgba(255,255,255,0.1);">
                    <span style="font-size:10px; display:block; opacity:0.7;">NEXT GAME:</span>
                    <strong id="lateNextSched" style="font-size:16px; color:var(--gold);">--:--</strong>
                </div>
            </div>
            <div id="gameOverOverlay" class="game-over-overlay">
                <i data-lucide="trophy" style="color:var(--gold); width:50px; height:50px; margin-bottom:15px; filter: drop-shadow(0 0 15px var(--gold));"></i>
                <div class="late-text">Game Finished</div>
                <div class="late-subtext" id="gameOverMsg">Better luck next time!</div>
            </div>
            <div class="change-card-wrapper" style="display:flex; justify-content:space-between; align-items:center; padding-bottom:15px;">
                <div class="pattern-box">
                    <div class="pattern-dot"></div>
                    <span class="pattern-text" id="patternName">Normal Bingo</span>
                </div>
                <button class="btn-change" id="newCardBtn" onclick="generateNewCard()"><i data-lucide="refresh-cw" style="width:14px"></i> NEW CARD</button>
            </div>
            <div class="bingo-header"><div class="letter">B</div><div class="letter">I</div><div class="letter">N</div><div class="letter">G</div><div class="letter">O</div></div>
            <div class="grid" id="bingoGrid"></div>
        </div>
        
        <div class="chat-box" style="margin-top:15px;">
            <div class="chat-header">
                <i data-lucide="message-square" style="width:18px; color:var(--accent-glow)"></i>
                <h3>LIVE STREAM CHAT</h3>
            </div>
            <div id="chatList"></div>
            <div id="replyIndicator" class="reply-indicator" style="display:none; padding: 5px 15px; background: #374151; color: #d1d5db; font-size: 11px;">
                <span id="replyText">Replying to...</span>
                <button onclick="cancelReply()" style="background:none; border:none; color:white; cursor:pointer;"><i data-lucide="x" style="width:14px"></i></button>
            </div>
            <div class="chat-input-area">
                <form class="input-wrapper" onsubmit="event.preventDefault(); sendChat();">
                    <input type="text" id="chatIn" placeholder="Say something..." autocomplete="off">
                    <button type="submit" class="send-btn">
                        <i data-lucide="send" style="width:16px"></i>
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>
        <div id="grandJackpotModal" onclick="this.style.display='none'">
    <div class="jackpot-rays"></div>
    <div class="jackpot-content">
        <div class="icon-glow"><i data-lucide="crown" style="width: 80px; height: 80px;"></i></div>
        <h1 class="jp-title">JACKPOT WIN!</h1>
        <h2 class="jp-amount" id="grandPrizeAmount">10,000 RB COINS</h2>
        <div class="jp-name" id="jpWinnerName">WINNER NAME</div>
        <p style="font-size: 11px; color: white; opacity: 0.7; margin-top: 20px;">Tap anywhere to close</p>
    </div>
</div>

<div id="pmModal" class="pm-modal">
    <div class="pm-container">
        <div id="pmInboxView" style="display:flex; flex-direction:column; height:100%;">
            <div class="pm-header">
                <div style="display:flex; align-items:center; gap:10px;">
                    <h3>Chats</h3>
                </div>
                <div style="display:flex; gap:10px;">
                    <button class="group-create-btn" onclick="startCreateGroup()"><i data-lucide="users" style="width:14px"></i> + Group</button>
                    <button onclick="document.getElementById('pmModal').style.display='none'" style="background:rgba(255,255,255,0.1); border:none; width:30px; height:30px; border-radius:50%; color:white; display:flex; align-items:center; justify-content:center;"><i data-lucide="x" style="width:16px;"></i></button>
                </div>
            </div>
            <div class="active-friends-bar" id="activeFriendsBar"></div>
            <div id="pmList" class="pm-inbox-list"></div>
        </div>
        
        <div id="pmChatView" class="pm-chat-view">
            <div class="pm-chat-header">
                <button onclick="backToInbox()" style="background:none; border:none; color:var(--messenger-blue);"><i data-lucide="arrow-left"></i></button>
                <div style="display:flex; align-items:center;">
                     <div id="chatTargetAvatarCont" style="width:36px; height:36px; margin-left:5px;"></div>
                     <div style="display:flex; flex-direction:column; margin-left:10px;">
                        <span id="chatTargetName" style="font-weight:700; font-size:15px; color:white;">User</span>
                        <span id="chatTargetStatus" style="font-size:11px; color:#b0b3b8;">Active now</span>
                     </div>
                </div>
            </div>
            <div id="pmMessages" class="pm-messages"></div>
            
            <div class="pm-footer-modern">
                <label for="pmImgInput" class="pm-attach-btn">
                    <i data-lucide="image" style="width:24px;"></i>
                </label>
                <input type="file" id="pmImgInput" accept="image/*" style="display:none" onchange="handlePmImage(this)">
                
                <form onsubmit="event.preventDefault(); sendPrivateMessage();" style="flex:1; display:flex; gap:10px;">
                    <input type="text" id="pmInput" class="pm-styled-input" placeholder="Type a message..." autocomplete="off">
                    <button type="submit" style="background:none; border:none; color:var(--messenger-blue); cursor:pointer;"><i data-lucide="send" style="width:24px"></i></button>
                </form>
            </div>
            <div id="pmImgPreviewCont" style="padding:10px; background:#0f172a; display:none;">
                <span style="font-size:10px; color:var(--accent-glow);">Image attached</span>
            </div>
        </div>

        <div id="pmCreateGroupView" style="display:none; flex-direction:column; height:100%; background:#000;">
            <div class="pm-header">
                <button onclick="cancelCreateGroup()" style="background:none; border:none; color:white;"><i data-lucide="arrow-left"></i></button>
                <h3>New Group</h3>
                <button onclick="finalizeCreateGroup()" style="color:var(--accent); background:none; border:none; font-weight:800;">CREATE</button>
            </div>
            <div style="padding:20px;">
                <input type="text" id="newGroupName" class="styled-input" placeholder="Group Name">
                <h4 style="color:#94a3b8; margin-top:20px; font-size:12px; text-transform:uppercase;">Select Friends</h4>
                <div id="friendSelectContainer" style="margin-top:10px;"></div>
            </div>
        </div>
    </div>
</div>

<div id="notifModal" class="modal" onclick="this.style.display='none'">
    <div class="modal-content" onclick="event.stopPropagation()">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px; border-bottom:1px solid rgba(255,255,255,0.1); padding-bottom:15px;">
            <div style="display:flex; align-items:center; gap:10px;">
                <h3 style="margin:0; font-size:18px;">Notifications</h3>
            </div>
            <button onclick="document.getElementById('notifModal').style.display='none'" style="background:none; border:none; color:white;"><i data-lucide="x"></i></button>
        </div>
        <div id="notifList"></div>
    </div>
</div>

<div id="userOptionsModal" class="modal" onclick="this.style.display='none'">
    <div class="modal-content" onclick="event.stopPropagation()" style="text-align:center;">
        <div id="optUserAvatarCont" style="display:flex; justify-content:center; margin-bottom:10px;"></div>
        <h3 id="optUserName" style="margin:0 0 20px 0; color:white;">User</h3>
        
        <button class="user-opt-btn" onclick="openUserProfile(targetUserForOpt.uid)"><i data-lucide="user"></i> View Profile</button>
        <button class="user-opt-btn" onclick="optAddFriend()"><i data-lucide="user-plus"></i> Add Friend</button>
        <button class="user-opt-btn" onclick="optSendMessage()"><i data-lucide="message-circle"></i> Send Message</button>
        <button class="user-opt-btn" onclick="document.getElementById('userOptionsModal').style.display='none'"><i data-lucide="x"></i> Close</button>
    </div>
</div>

<div id="commentModalBackdrop" class="comment-modal-backdrop" onclick="closeComments()"></div>
<div id="commentModal" class="comment-modal">
    <div class="comment-header">
        <h3 style="margin:0; font-size:16px;">Comments</h3>
        <button onclick="closeComments()" style="background:none; border:none; color:white;"><i data-lucide="x"></i></button>
    </div>
    <div id="commentList" class="comment-list"></div>
    <form class="comment-input-area" onsubmit="event.preventDefault(); sendComment();">
        <input type="text" id="commentInput" class="comment-input" placeholder="Write a comment..." autocomplete="off">
        <button type="submit" style="background:none; border:none; color:var(--accent);"><i data-lucide="send"></i></button>
    </form>
</div>

<div id="searchModal" class="search-modal-container">
    <div class="search-header">
        <button onclick="document.getElementById('searchModal').style.display='none'" style="background:none; border:none; color:white;"><i data-lucide="arrow-left"></i></button>
        <div class="search-bar-wrap">
            <i data-lucide="search" style="width:16px; opacity:0.5;"></i>
            <input type="text" id="searchInput" class="search-input" placeholder="Search users or posts..." onkeyup="handleSearch()">
        </div>
    </div>
    <div id="searchResults" class="search-results">
        <div style="text-align:center; opacity:0.5; padding:20px;">Type to search...</div>
    </div>
</div>

<div id="userProfilePage" class="profile-page-container">
    <button class="profile-nav-back" onclick="closeProfilePage()">
        <i data-lucide="arrow-left"></i>
    </button>
    
    <div class="profile-cover" id="pageProfileCover"></div>
    
    <div class="profile-info-section">
        <div class="profile-avatar-container" id="pageProfileAvatarContainer"></div>
        
        <h2 id="pageProfileName" class="profile-page-name">User Name</h2>
        <p id="pageProfileBio" class="profile-page-bio">Radio Bingo Player</p>
        
        <button id="profileMainActionBtn" class="profile-action-btn" onclick="handleProfileMainAction()">Add Friend</button>
        
        <button id="unfriendBtn" class="btn-unfriend-modern" style="display:none;" onclick="unfriendUser()">
            <i data-lucide="user-x" style="width:16px"></i> Unfriend
        </button>
        
        <div class="profile-stats-card">
            <div class="stat-item">
                <span class="stat-val" id="statFriends">0</span>
                <span class="stat-lbl"><i data-lucide="users" style="width:12px; vertical-align:middle;"></i> Friends</span>
            </div>
            <div class="stat-item">
                <span class="stat-val" id="statLikes">0</span>
                <span class="stat-lbl"><i data-lucide="heart" style="width:12px; vertical-align:middle;"></i> Likes</span>
            </div>
             <div class="stat-item">
                <span class="stat-val" id="statPosts">0</span>
                <span class="stat-lbl"><i data-lucide="image" style="width:12px; vertical-align:middle;"></i> Posts</span>
            </div>
        </div>
        
        <div id="pageProfileFeed" class="profile-feed-section"></div>
    </div>
</div>

<div id="editProfileModal" class="modal" onclick="this.style.display='none'">
    <div class="modal-content" onclick="event.stopPropagation()">
        <h3 style="margin-top:0; color:white;">Edit Profile</h3>
        <label class="edit-label">Display Name</label>
        <input type="text" id="editNameIn" class="edit-input" placeholder="Your Name">
        <label class="edit-label">Bio</label>
        <input type="text" id="editBioIn" class="edit-input" placeholder="Short bio...">
        <label class="edit-label">Change Profile Picture</label>
        <input type="file" id="editProfilePicInput" class="edit-input" accept="image/*" onchange="handleProfileUpload(this, 'pfp')">
        <label class="edit-label">Change Cover Photo</label>
        <input type="file" id="editCoverPicInput" class="edit-input" accept="image/*" onchange="handleProfileUpload(this, 'cover')">
        <button onclick="saveProfileChanges()" style="width:100%; padding:15px; background:var(--accent); border:none; border-radius:12px; font-weight:900; color:white; cursor:pointer;">SAVE CHANGES</button>
    </div>
</div>

<div id="installGuideModal" class="modal" onclick="this.style.display='none'">
    <div class="modal-content" onclick="event.stopPropagation()">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
            <h3 style="margin:0; font-size:18px; font-weight:900;">INSTALL GUIDE</h3>
            <button onclick="document.getElementById('installGuideModal').style.display='none'" style="background:none; border:none; color:white;"><i data-lucide="x"></i></button>
        </div>
        <div class="install-tabs">
            <button class="install-tab-btn active" id="tabAndroid" onclick="showGuide('android')">ANDROID</button>
            <button class="install-tab-btn" id="tabIOS" onclick="showGuide('ios')">iOS</button>
        </div>
        <div id="guideAndroidContent">
            <div class="guide-step"><div class="step-num">1</div><div class="step-text">Pindutin ang <b>Three Dots (‚ãÆ)</b> sa upper right corner ng Google Chrome browser.</div></div>
            <div class="guide-step"><div class="step-num">2</div><div class="step-text">Hanapin at pindutin ang <b>"Install App"</b> o <b>"Add to Home Screen"</b>.</div></div>
            <div class="guide-step"><div class="step-num">3</div><div class="step-text">Click <b>Install</b> para mapunta ito sa iyong home screen.</div></div>
        </div>
        <div id="guideIOSContent" style="display:none;">
            <div class="guide-step"><div class="step-num">1</div><div class="step-text">Gamitin ang <b>Safari Browser</b> at pindutin ang <b>Share Icon</b> <i data-lucide="share" style="width:12px"></i> sa ibaba.</div></div>
            <div class="guide-step"><div class="step-num">2</div><div class="step-text">Mag-scroll pababa at hanapin ang <b>"Add to Home Screen"</b> <i data-lucide="plus-square" style="width:12px"></i>.</div></div>
            <div class="guide-step"><div class="step-num">3</div><div class="step-text">Click <b>Add</b> sa upper right corner.</div></div>
        </div>
    </div>
</div>

<div id="menuModal" class="modal" onclick="this.style.display='none'">
    <div class="modal-content" onclick="event.stopPropagation()">
        <div class="profile-header">
            <div id="menuAvatarContainer"></div>
            <div class="profile-name-info">
                <h2 class="profile-name" id="profileNameDisplay">User Name</h2>
                <span class="profile-uid" id="profileUidDisplay">UID: ---</span>
            </div>
            <button onclick="document.getElementById('menuModal').style.display='none'" style="background:none; border:none; color:white; opacity:0.5;"><i data-lucide="x"></i></button>
        </div>
        <div class="gcash-section">
            <span style="font-size:10px; font-weight:800; color:var(--accent-glow); text-transform:uppercase; margin-bottom:10px; display:flex; align-items:center; gap:5px;"><i data-lucide="credit-card" style="width:12px"></i> Email / Redemption Info</span>
            <div style="display:flex; gap:10px;">
                <input type="text" id="gcashInput" class="styled-input" placeholder="Enter email or details">
                <button onclick="saveGcash(); playSound('click');" style="background:var(--accent); border:none; color:white; padding:0 20px; border-radius:12px; font-weight:800; font-size:12px; cursor:pointer; box-shadow:0 4px 10px rgba(59, 130, 246, 0.3);">SAVE</button>
            </div>
        </div>
        <div class="ref-container">
            <span style="font-size:10px; font-weight:800; color:var(--success); text-transform:uppercase; margin-bottom:10px; display:flex; align-items:center; gap:5px;"><i data-lucide="share-2" style="width:12px"></i> Invite & Earn</span>
            <input type="text" id="refLink" readonly class="styled-input" style="background:rgba(0,0,0,0.2); text-align:center; cursor:pointer; margin-bottom:10px;" onclick="this.select(); document.execCommand('copy'); showToast('Copied Link!'); playSound('click');">
            <div id="referralInputSection">
                <span style="font-size:10px; font-weight:800; color:var(--gold); text-transform:uppercase; margin-bottom:10px; display:flex; align-items:center; gap:5px; margin-top:15px;"><i data-lucide="ticket" style="width:12px"></i> Claim Referral Code</span>
                <div style="display:flex; gap:10px;">
                    <input type="text" id="referralInput" class="styled-input" placeholder="ENTER CODE">
                    <button onclick="claimReferral(); playSound('click');" style="background:var(--gold); border:none; color:black; padding:0 20px; border-radius:12px; font-weight:800; font-size:12px; cursor:pointer; box-shadow:0 4px 10px rgba(251, 191, 36, 0.3);">CLAIM</button>
                </div>
            </div>
        </div>
        <div class="history-box">
            <span style="font-size:10px; font-weight:800; color:white; text-transform:uppercase; margin-bottom:10px; display:flex; align-items:center; gap:5px;"><i data-lucide="history" style="width:12px"></i> Transaction History</span>
            <div id="historyList" class="history-list"></div>
        </div>
        
        <div style="margin-top:15px; border-top:1px solid rgba(255,255,255,0.1); padding-top:10px;">
            <a href="about.html" style="display:block; color:#94a3b8; font-size:12px; padding:8px 0; text-decoration:none;">About Us</a>
            <a href="privacy.html" style="display:block; color:#94a3b8; font-size:12px; padding:8px 0; text-decoration:none;">Privacy Policy</a>
            <a href="terms.html" style="display:block; color:#94a3b8; font-size:12px; padding:8px 0; text-decoration:none;">Terms of Service</a>
        </div>

        <button onclick="auth.signOut().then(()=>location.reload())" style="width:100%; padding:14px; background:rgba(239, 68, 68, 0.1); color:var(--danger); border:1px solid rgba(239, 68, 68, 0.2); border-radius:14px; font-weight:800; margin-top:20px; cursor:pointer; display:flex; align-items:center; justify-content:center; gap:8px;">
            <i data-lucide="log-out" style="width:18px"></i> Sign Out
        </button>
    </div>
</div>

<div id="storeModal" class="modal" onclick="this.style.display='none'">
    <div class="modal-content" onclick="event.stopPropagation()">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px; border-bottom: 1px solid rgba(255,255,255,0.05); padding-bottom: 15px;">
            <div>
                <h3 style="margin:0; font-size: 20px; font-weight: 900;">MARKETPLACE</h3>
                <p style="margin: 5px 0 0 0; font-size: 11px; opacity: 0.8; font-weight: 600;">Redeem, Shop Skins, or Earn</p>
            </div>
            <div class="points-badge" style="height:35px; border-radius: 10px;"><i data-lucide="coins" style="width:14px"></i> <span id="storePoints">0</span></div>
        </div>
        <div class="store-nav">
            <button class="store-tab-btn active" onclick="switchStoreTab('cashout')" id="tabBtnCash">Cash Out</button>
            <button class="store-tab-btn" onclick="switchStoreTab('skins')" id="tabBtnSkins">Skins</button>
            <button class="store-tab-btn" onclick="switchStoreTab('earn')" id="tabBtnEarn" style="color:var(--gold);">Tasks</button>
        </div>
        
        <div class="glass-panel" style="padding: 15px; border-radius: 18px; margin-bottom: 20px; border: 1px dashed var(--gold); text-align: center; position: relative; overflow: hidden;">
            <h4 style="margin: 0 0 10px 0; color: var(--gold); font-size: 14px; text-transform: uppercase;">‚ö° FREE RB COINS ‚ö°</h4>
            <div id="adTimerOverlay" style="display: none; position: absolute; inset: 0; background: rgba(15, 23, 42, 0.98); z-index: 50; align-items: center; justify-content: center; flex-direction: column;">
                <div id="adStatusIcon" style="font-size: 30px; margin-bottom: 10px;">üì∫</div>
                <div style="font-size: 18px; font-weight: 900; color: white;" id="adCountdown">30s</div>
                <div style="font-size: 12px; color: #ef4444; padding: 0 20px; margin-top: 5px; font-weight:800;" id="adStatusText">Do not close app or switch tabs!</div>
            </div>
            <div id="adCaptchaOverlay" style="display: none; position: absolute; inset: 0; background: rgba(15, 23, 42, 0.98); z-index: 51; align-items: center; justify-content: center; flex-direction: column;">
                <div style="font-size: 14px; font-weight: 700; color: var(--accent-glow); margin-bottom: 10px;">HUMAN VERIFICATION</div>
                <div style="background: rgba(255,255,255,0.1); padding: 10px; border-radius: 12px; margin-bottom: 10px;">
                    <span id="mathQ" style="font-size: 20px; font-weight: 900; color: white;">5 + 3 = ?</span>
                </div>
                <div style="display: flex; gap: 5px;">
                    <input type="number" id="mathAns" style="width: 60px; padding: 8px; border-radius: 8px; border: 1px solid var(--accent); background: #0f172a; color: white; text-align: center; font-weight: 800;">
                    <button onclick="verifyAdMath()" style="background: var(--success); border: none; padding: 8px 12px; border-radius: 8px; color: white; font-weight: 900;">OK</button>
                </div>
            </div>
            <button id="btnWatchAd" onclick="startStrictWatch()" style="background: linear-gradient(135deg, #f59e0b, #b45309); width: 100%; border: none; padding: 15px; border-radius: 12px; font-weight: 900; color: white; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 10px; font-size: 14px; box-shadow: 0 5px 15px rgba(245, 158, 11, 0.4); text-shadow: 0 1px 2px black;">
                <i data-lucide="play-circle" style="width: 20px;"></i> WATCH AD (+50 Coins)
            </button>
            <p style="font-size: 10px; opacity: 0.6; margin-top: 8px; color:var(--danger);">*Timer pauses if you leave the app!</p>
        </div>

        <div id="storeSection-cashout" style="display:block;">
            <div class="reward-grid">
                <div class="reward-item">
                    <div class="reward-main"><div class="reward-icon-box"><i data-lucide="gift" style="width:22px"></i></div><div class="reward-info"><b>‚Ç±20 Gift Card</b><small><i data-lucide="database" style="width:10px"></i> 50,000 Coins</small></div></div>
                    <button class="btn-redeem" onclick="redeemItem('‚Ç±20 Gift Card', 50000)">Redeem</button>
                </div>
                <div class="reward-item">
                    <div class="reward-main"><div class="reward-icon-box" style="color:var(--gold); background:rgba(251, 191, 36, 0.1); border-color:rgba(251, 191, 36, 0.3);"><i data-lucide="gift" style="width:22px"></i></div><div class="reward-info"><b>‚Ç±50 Gift Card</b><small><i data-lucide="database" style="width:10px"></i> 125,000 Coins</small></div></div>
                    <button class="btn-redeem" onclick="redeemItem('‚Ç±50 Gift Card', 125000)">Redeem</button>
                </div>
                <div class="reward-item">
                    <div class="reward-main"><div class="reward-icon-box" style="color:var(--success); background:rgba(16, 185, 129, 0.1); border-color:rgba(16, 185, 129, 0.3);"><i data-lucide="gift" style="width:22px"></i></div><div class="reward-info"><b>‚Ç±100 Gift Card</b><small><i data-lucide="database" style="width:10px"></i> 250,000 Coins</small></div></div>
                    <button class="btn-redeem" onclick="redeemItem('‚Ç±100 Gift Card', 250000)">Redeem</button>
                </div>
            </div>
            <p style="text-align: center; font-size: 10px; opacity: 0.6; margin-top: 25px; line-height: 1.5; text-shadow:0 1px 2px black;">*Processing may take 24-48 hours.<br>Make sure your redemption details are correct.</p>
        </div>

        <div id="storeSection-skins" style="display:none;">
            <p style="font-size:11px; opacity:0.7; margin-bottom:15px; text-align:center;">Customize your Bingo Card. Look rich, play rich.</p>
            
            <div style="margin-bottom:20px; padding:15px; background:rgba(255,255,255,0.05); border-radius:12px; text-align:center;">
                <label style="font-size:12px; font-weight:700; display:block; margin-bottom:10px; color:var(--accent-glow);">UPLOAD CUSTOM BACKGROUND</label>
                <input type="file" accept="image/*" id="customSkinInput" style="display:none" onchange="handleCustomSkinUpload(this)">
                <button onclick="document.getElementById('customSkinInput').click()" style="background:var(--accent); color:white; border:none; padding:8px 15px; border-radius:8px; font-weight:800; font-size:11px; cursor:pointer;">CHOOSE IMAGE</button>
            </div>

            <div class="skins-grid">
                <div class="skin-item"><div class="skin-preview" style="background:rgba(30,41,59,0.8); border:1px solid rgba(255,255,255,0.1);">B</div><div class="skin-name">Classic</div><div class="skin-cost">Free</div><button class="btn-buy-skin equip" id="btn-skin-default" onclick="equipSkin('default')">EQUIP</button></div>
                
                <div class="skin-item"><div class="skin-preview" style="background:pink; border:2px solid hotpink; color:deeppink; font-family:'Comic Neue',cursive;">B</div><div class="skin-name">Hello Kitty</div><div class="skin-cost">75,000 Coins</div><button class="btn-buy-skin buy" id="btn-skin-kitty" onclick="buyOrEquipSkin('kitty', 75000)">BUY</button></div>
                
                <div class="skin-item"><div class="skin-preview" style="background:#0096df; border:2px solid white; color:white; border-radius:50%;">B</div><div class="skin-name">Doraemon</div><div class="skin-cost">75,000 Coins</div><button class="btn-buy-skin buy" id="btn-skin-doraemon" onclick="buyOrEquipSkin('doraemon', 75000)">BUY</button></div>
                
                <div class="skin-item"><div class="skin-preview" style="background:#f7f44d; border:2px dashed brown; color:brown;">B</div><div class="skin-name">SpongeBob</div><div class="skin-cost">75,000 Coins</div><button class="btn-buy-skin buy" id="btn-skin-spongebob" onclick="buyOrEquipSkin('spongebob', 75000)">BUY</button></div>
                
                <div class="skin-item"><div class="skin-preview" style="background:black; border:2px solid purple; color:pink;">B</div><div class="skin-name">Kuromi</div><div class="skin-cost">75,000 Coins</div><button class="btn-buy-skin buy" id="btn-skin-kuromi" onclick="buyOrEquipSkin('kuromi', 75000)">BUY</button></div>

                <div class="skin-item"><div class="skin-preview" style="background:rgba(8,51,68,1); border:2px solid #06b6d4; color:#67e8f9; text-shadow:0 0 5px #06b6d4;">B</div><div class="skin-name">Neon City</div><div class="skin-cost">50,000 Coins</div><button class="btn-buy-skin buy" id="btn-skin-neon" onclick="buyOrEquipSkin('neon', 50000)">BUY</button></div>
                <div class="skin-item"><div class="skin-preview" style="background:linear-gradient(135deg, #451a03, #000); border:2px solid #f59e0b; color:#fcd34d; font-family:'Times New Roman',serif;">B</div><div class="skin-name">Luxury Gold</div><div class="skin-cost">100,000 Coins</div><button class="btn-buy-skin buy" id="btn-skin-gold" onclick="buyOrEquipSkin('gold', 100000)">BUY</button></div>
                <div class="skin-item"><div class="skin-preview" style="background:rgba(80, 7, 36, 1); border:2px solid #ec4899; color:#fbcfe8; border-radius:50%;">B</div><div class="skin-name">Kawaii Pink</div><div class="skin-cost">25,000 Coins</div><button class="btn-buy-skin buy" id="btn-skin-pink" onclick="buyOrEquipSkin('pink', 25000)">BUY</button></div>
                
                <div class="skin-item" id="customSkinSlot" style="display:none;"><div class="skin-preview" id="customSkinPreview" style="background-size:cover;">B</div><div class="skin-name">My Custom</div><div class="skin-cost">Owned</div><button class="btn-buy-skin equip" id="btn-skin-custom" onclick="equipSkin('custom')">EQUIP</button></div>
            </div>
        </div>
        <div id="storeSection-earn" style="display:none;">
            <p style="font-size:11px; opacity:0.7; margin-bottom:15px; text-align:center;">Complete tasks to earn huge coins instantly.</p>
            <div class="task-list">
                <div class="task-item" style="border-color: #ef4444; background: linear-gradient(90deg, rgba(69,10,10,0.8), rgba(15,23,42,0.8));">
                    <div class="task-info"><h4 style="color:#fca5a5;">Watch Video Task</h4><p>Watch full video to unlock reward</p><span class="task-reward" style="background: rgba(239,68,68,0.2); border-color:#ef4444; color:#fca5a5;">+2,000 Coins</span></div>
                    <button class="btn-do-task" style="background:#ef4444;" id="btn-task-video" onclick="openVideoLocker('video')">WATCH</button>
                </div>
                <div class="task-item">
                    <div class="task-info"><h4>Premium Offer</h4><p>Complete simple offer to verify</p><span class="task-reward">+5,000 Coins</span></div>
                    <button class="btn-do-task" id="btn-task-premium" onclick="startTaskSafe('https://doctoredits.com/1874673', 5000, 'premium')">GO</button>
                </div>
            </div>
        </div>
    </div>
</div>

<div id="pwaInstallBanner">
    <div><span class="pwa-text">INSTALL APP</span><span class="pwa-sub">Download for better experience!</span></div>
    <button id="pwaBottomBtn" class="pwa-btn">INSTALL</button>
</div>
        <script>
    // === NOTIFICATION & INSTALL BLOCKER LOGIC ===
    window.addEventListener('load', () => { setTimeout(hideSplash, 2000); checkNotifGate(); checkInstallGate(); initBannerListener(); loadSocialFeed(); loadPYMK(); loadCustomSkin(); });
    setTimeout(hideSplash, 5000);
    function hideSplash() { const ss = document.getElementById('splash-screen'); if(ss && ss.style.display !== 'none') { ss.style.opacity = '0'; setTimeout(() => ss.style.display = 'none', 800); } }
    
    function checkNotifGate() {
        const blocker = document.getElementById('notifBlocker');
        const help = document.getElementById('blockedHelp');
        if (!("Notification" in window)) { showToast("Notifications not supported on this device."); blocker.style.display = 'none'; return; }
        if (Notification.permission === "granted") { blocker.style.display = 'none'; } else if (Notification.permission === "denied") { blocker.style.display = 'flex'; help.style.display = 'block'; } else { blocker.style.display = 'flex'; help.style.display = 'none'; }
    }
    function requestGatePermission() { Notification.requestPermission().then(permission => { if (permission === "granted") { checkNotifGate(); requestNotifyPermission(); } else { checkNotifGate(); } }); }
    function showToast(msg) { const toast = document.getElementById('customToast'); document.getElementById('toastMsg').innerText = msg; toast.classList.add('show'); playSound('click'); setTimeout(() => { toast.classList.remove('show'); }, 3000); }

    let confirmCallback = null;
    function showCustomConfirm(title, msg, onYes) { document.getElementById('confTitle').innerText = title; document.getElementById('confMsg').innerText = msg; document.getElementById('customConfirmModal').style.display = 'flex'; confirmCallback = onYes; playSound('click'); }
    function closeCustomConfirm() { document.getElementById('customConfirmModal').style.display = 'none'; confirmCallback = null; }
    document.getElementById('confYesBtn').addEventListener('click', () => { if(confirmCallback) confirmCallback(); closeCustomConfirm(); });

    let deferredPrompt;
    const bottomBanner = document.getElementById('pwaInstallBanner');
    const bottomBtn = document.getElementById('pwaBottomBtn');
    
    function checkInstallGate() {
        const gate = document.getElementById('installGate');
        const isStandalone = window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone === true;
        if (isStandalone) { gate.style.display = 'none'; } else { gate.style.display = 'flex'; const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream; if(isIOS) { document.getElementById('gateInstallBtn').style.display = 'none'; document.getElementById('gateIosNote').style.display = 'block'; } }
        checkInstallState();
    }
    function checkInstallState() { if (window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone === true) { if(bottomBanner) bottomBanner.style.display = 'none'; } }
    window.addEventListener('beforeinstallprompt', (e) => { e.preventDefault(); deferredPrompt = e; if(bottomBanner && document.getElementById('installGate').style.display === 'none') { bottomBanner.style.display = 'flex'; } });
    function triggerInstall() { if (deferredPrompt) { deferredPrompt.prompt(); deferredPrompt.userChoice.then((choiceResult) => { if (choiceResult.outcome === 'accepted') { if(bottomBanner) bottomBanner.style.display = 'none'; } deferredPrompt = null; }); } else { document.getElementById('installGuideModal').style.display = 'flex'; const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream; if (isIOS) { showGuide('ios'); } else { showGuide('android'); } } if(bottomBanner) bottomBanner.style.display = 'none'; }
    function showGuide(os) { document.querySelectorAll('.install-tab-btn').forEach(b => b.classList.remove('active')); if(os === 'android') { document.getElementById('tabAndroid').classList.add('active'); document.getElementById('guideAndroidContent').style.display = 'block'; document.getElementById('guideIOSContent').style.display = 'none'; } else { document.getElementById('tabIOS').classList.add('active'); document.getElementById('guideAndroidContent').style.display = 'none'; document.getElementById('guideIOSContent').style.display = 'block'; } }
    if(bottomBtn) bottomBtn.addEventListener('click', triggerInstall);

    lucide.createIcons();
    const firebaseConfig = { apiKey: "AIzaSyDIAQXJ15atKJxu7PtcFL1W9JnO1N14pVs", authDomain: "radiobingo-9ac29.firebaseapp.com", databaseURL: "https://radiobingo-9ac29-default-rtdb.asia-southeast1.firebasedatabase.app", projectId: "radiobingo-9ac29", storageBucket: "radiobingo-9ac29.firebasestorage.app", messagingSenderId: "965903993397", appId: "1:965903993397:web:f6646fa05225f147eebf7c" };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database(); const auth = firebase.auth();
    let messaging; try { messaging = firebase.messaging(); } catch(e) { console.log("Messaging failed to init", e); }
    
    // GLOBAL VARIABLES
    let userData = {}; let cardNumbers = []; let marks = [12]; let gameDrawn = []; let currentPattern = "Normal Bingo"; let lastNotifiedDraw = ""; let selectedReplyId = null;
    let currentJackpotAmount = 500; let isJackpotActive = false;
    let onlineUsersCache = {}; // Cache for Active Status

    const sounds = { click: new Audio('https://cdn.pixabay.com/audio/2022/03/15/audio_2731885542.mp3'), newBall: new Audio('https://cdn.pixabay.com/audio/2022/03/10/audio_c8c8a73467.mp3'), pop: new Audio('https://cdn.freesound.org/previews/536/536108_1415754-lq.mp3'), win: new Audio('https://cdn.freesound.org/previews/270/270404_5123851-lq.mp3'), lose: new Audio('https://cdn.freesound.org/previews/76/76376_877451-lq.mp3'), spin: new Audio('https://cdn.freesound.org/previews/413/413203_5121236-lq.mp3'), cardFlip: new Audio('https://cdn.freesound.org/previews/240/240776_4107740-lq.mp3'), stop: new Audio('https://cdn.freesound.org/previews/256/256113_3263906-lq.mp3'), tumble: new Audio('https://cdn.freesound.org/previews/256/256113_3263906-lq.mp3'), drop: new Audio('https://cdn.pixabay.com/audio/2022/03/10/audio_c8c8a73467.mp3') };
    function playSound(type) { if(sounds[type]) { sounds[type].currentTime = 0; if(type === 'drop') sounds[type].volume = 0.3; else sounds[type].volume = 1.0; sounds[type].play().catch(e => console.log("Audio play error", e)); } }
    if ('serviceWorker' in navigator) { window.addEventListener('load', () => { navigator.serviceWorker.register('./sw.js').then(reg => { }).catch(err => console.log('SW Failed:', err)); }); }
    function requestNotifyPermission() { if ("Notification" in window) { Notification.requestPermission().then(permission => { if (permission === "granted" && messaging) { messaging.getToken().then((currentToken) => { if (currentToken && auth.currentUser) db.ref('users/' + auth.currentUser.uid).update({ fcmToken: currentToken }); }).catch((err) => console.log('Err token', err)); } }); } }

    function switchTab(tab) {
        document.querySelectorAll('.nav-item').forEach(b => b.classList.remove('active'));
        document.getElementById('view-home').style.display = 'none';
        document.getElementById('view-bingo').style.display = 'none';
        
        if(tab === 'home') {
            document.getElementById('view-home').style.display = 'block';
            document.getElementById('nav-home').classList.add('active');
            loadSocialFeed();
            loadPYMK();
        } else if(tab === 'bingo') {
            document.getElementById('view-bingo').style.display = 'block';
            document.getElementById('nav-bingo').classList.add('active');
        }
        playSound('click');
    }

    function openPostCreator() {
        switchTab('home');
        document.getElementById('postInput').focus();
    }
    
    function switchStoreTab(tab) {
        document.querySelectorAll('.store-tab-btn').forEach(b => b.classList.remove('active'));
        document.getElementById('storeSection-cashout').style.display = 'none';
        document.getElementById('storeSection-skins').style.display = 'none';
        document.getElementById('storeSection-earn').style.display = 'none';
        if(tab === 'cashout') { document.getElementById('tabBtnCash').classList.add('active'); document.getElementById('storeSection-cashout').style.display = 'block'; } 
        else if(tab === 'skins') { document.getElementById('tabBtnSkins').classList.add('active'); document.getElementById('storeSection-skins').style.display = 'block'; updateSkinButtons(); } 
        else if(tab === 'earn') { document.getElementById('tabBtnEarn').classList.add('active'); document.getElementById('storeSection-earn').style.display = 'block'; }
        playSound('click');
    }

    function fixDate(timestamp) { if(!timestamp) return "Just now"; const d = new Date(parseInt(timestamp)); return d.toLocaleDateString('en-PH', { month: 'short', day: 'numeric' }) + " " + d.toLocaleTimeString('en-PH', { hour: '2-digit', minute: '2-digit' }); }
    function login() { playSound('click'); auth.signInWithPopup(new firebase.auth.GoogleAuthProvider()).then(() => { requestNotifyPermission(); checkNotifGate(); }); }

    // === AUTH OBSERVER ===
    auth.onAuthStateChanged(u => {
        if(u) {
            if(messaging) { messaging.getToken().then((token) => { if(token) db.ref('users/' + u.uid).update({ fcmToken: token }); }).catch((err)=>console.log(err)); messaging.onMessage((payload) => { const title = payload.notification ? payload.notification.title : "Notification"; const body = payload.notification ? payload.notification.body : "New message"; showToast(title + ": " + body); playSound('pop'); }); }
            document.getElementById('loginOverlay').style.display = 'none'; document.getElementById('userPanel').style.display = 'flex';
            
            // Set initial avatar with UID for status tracking
            document.getElementById('userImgContainer').innerHTML = renderAvatarWithBadge(u.photoURL, 0, 40, u.uid);

            document.getElementById('profileUidDisplay').innerText = "ID: " + u.uid.substring(0,8);
            
            const userRef = db.ref('users/'+u.uid);
            userRef.once('value', snapshot => { 
                if (!snapshot.exists()) { 
                    // New User
                    const newRefCode = Math.random().toString(36).substring(2, 8).toUpperCase(); 
                    const urlParams = new URLSearchParams(window.location.search); 
                    const referredBy = urlParams.get('ref'); 
                    userRef.set({ name: u.displayName, photo: u.photoURL, points: 500, refCode: newRefCode, referredBy: referredBy || null, last_seen: Date.now(), cardTimestamp: Date.now(), lastLoginDate: new Date().toDateString(), hasWonBringMeThisRound: false, ownedSkins: ['default'], equippedSkin: 'default' }); 
                    if (referredBy) { db.ref('users').orderByChild('refCode').equalTo(referredBy).once('value', refSnap => { if (refSnap.exists()) { const referrerUid = Object.keys(refSnap.val())[0]; db.ref('users/' + referrerUid + '/points').transaction(p => (p || 0) + 1000); } }); } 
                } else { 
                    // Existing User Updates
                    const data = snapshot.val(); 
                    const updates = { last_seen: Date.now() }; 
                    if (!data.name) updates.name = u.displayName;
                    if (!data.photo) updates.photo = u.photoURL;
                    
                    const today = new Date().toDateString(); 
                    if (data.lastLoginDate !== today) { updates.points = (data.points || 0) + 200; updates.lastLoginDate = today; showToast("üéÅ Daily Bonus! +200 RB Coins."); playSound('win'); } 
                    if (!data.refCode) updates.refCode = Math.random().toString(36).substring(2, 8).toUpperCase(); 
                    if(!data.ownedSkins) updates.ownedSkins = ['default']; 
                    if(!data.equippedSkin) updates.equippedSkin = 'default'; 
                    userRef.update(updates); 
                } 
            });
            
            userRef.on('value', s => { 
                if(s.exists()){ 
                    userData = s.val(); userData.uid = u.uid; 
                    
                    document.getElementById('storePoints').innerText = (userData.points || 0).toLocaleString(); 
                    document.getElementById('refLink').value = window.location.origin + window.location.pathname + "?ref=" + (userData.refCode || ""); 
                    if(userData.referredBy) document.getElementById('referralInputSection').style.display = 'none'; 
                    if(userData.gcash) document.getElementById('gcashInput').value = userData.gcash; 
                    if (userData.currentCard) { cardNumbers = userData.currentCard; renderCard(); } else { generateNewCard(); } 
                    
                    const displayName = userData.name || u.displayName;
                    const displayPhoto = userData.photo || u.photoURL;
                    
                    updatePresenceData(u.uid, displayName, userData.points, displayPhoto); checkLateJoiner();
                    applySkin(userData.equippedSkin || 'default'); updateSkinButtons();
                    
                    document.getElementById('profileNameDisplay').innerText = displayName;
                    
                    // Update Avatars with badges & UID
                    document.getElementById('userImgContainer').innerHTML = renderAvatarWithBadge(displayPhoto, userData.points, 40, u.uid);
                    document.getElementById('menuAvatarContainer').innerHTML = renderAvatarWithBadge(displayPhoto, userData.points, 70, u.uid);
                } 
            });
            initBingo(); setupChat(); listenForNextDraw(); setupPresence(u.uid); listenJackpot(); listenNotifications(u.uid); listenPrivateMessages(u.uid); listenVideoUpdate();
            initSocialSystem(u.uid);
            loadPYMK();
        } else { document.getElementById('loginOverlay').style.display = 'flex'; }
    });

    // === AVATAR & ACTIVE STATUS SYSTEM ===
    function renderAvatarWithBadge(photoUrl, points, size, uid) {
        let tierClass = "tier-bronze-bg";
        let tierIcon = ""; 
        if(points >= 100000) { tierClass = "tier-diamond-bg"; tierIcon = '<i data-lucide="diamond" style="width:50%; height:50%;"></i>'; }
        else if(points >= 50000) { tierClass = "tier-platinum-bg"; tierIcon = '<i data-lucide="shield" style="width:50%; height:50%;"></i>'; }
        else if(points >= 25000) { tierClass = "tier-gold-bg"; tierIcon = '<i data-lucide="crown" style="width:50%; height:50%;"></i>'; }
        else if(points >= 10000) { tierClass = "tier-silver-bg"; tierIcon = '<i data-lucide="star" style="width:50%; height:50%;"></i>'; }
        else { tierIcon = '<i data-lucide="circle-dot" style="width:50%; height:50%;"></i>'; }

        // Logic for Green Dot
        const uidAttr = uid ? `data-uid="${uid}"` : '';
        const activeClass = (uid && onlineUsersCache[uid]) ? 'active' : '';

        setTimeout(() => lucide.createIcons(), 50);

        return `
            <div class="avatar-frame" style="width:${size}px; height:${size}px;" ${uidAttr} onclick="openUserProfile('${uid}')">
                <img src="${photoUrl}">
                <div class="online-status-dot ${activeClass}"></div>
                <div class="avatar-badge-icon ${tierClass}">
                    ${tierIcon}
                </div>
            </div>
        `;
    }
    
    function getBadgeHtml(points) {
        if(points >= 100000) return `<i data-lucide="diamond" style="width:12px; height:12px; fill:#06b6d4; color:#06b6d4; margin-left:4px;"></i>`;
        if(points >= 25000) return `<i data-lucide="crown" style="width:12px; height:12px; fill:#fbbf24; color:#fbbf24; margin-left:4px;"></i>`;
        return ""; 
    }

    // === UTILITY ===
    function compressImage(file, maxWidth, quality) {
        return new Promise((resolve) => {
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = (event) => {
                const img = new Image();
                img.src = event.target.result;
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    let width = img.width;
                    let height = img.height;
                    if (width > maxWidth) {
                        height *= maxWidth / width;
                        width = maxWidth;
                    }
                    canvas.width = width;
                    canvas.height = height;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, width, height);
                    resolve(canvas.toDataURL('image/jpeg', quality));
                };
            };
        });
    }

    // === BINGO GAME ENGINE ===
    function initBingo() {
        db.ref('gameState/latestWinner').on('value', s => { const win = s.val(); const banner = document.getElementById('winnerBanner'); const cardCont = document.getElementById('bingoCardContainer'); const gameOverlay = document.getElementById('gameOverOverlay'); cardCont.classList.remove('card-puro'); document.querySelectorAll('.cell').forEach(c => c.classList.remove('cell-waiting')); if(win && win.name) { banner.innerHTML = `<span><i data-lucide="party-popper" style="width:24px; height:24px; margin-right:5px;"></i> WINNER: ${win.name.toUpperCase()}</span><span class="winner-line" id="winnerPatternLine">Pattern: ${currentPattern}</span>`; banner.style.display = 'block'; playSound('win'); lucide.createIcons(); if(win.uid === auth.currentUser.uid) { confetti({ particleCount: 150, spread: 70, origin: { y: 0.6 } }); cardCont.classList.add('card-win'); cardCont.classList.remove('card-lost'); gameOverlay.style.display = 'none'; spawnFlyingCoins(20); triggerScreenShake(); } else { cardCont.classList.add('card-lost'); cardCont.classList.remove('card-win'); gameOverlay.style.display = 'flex'; const nextTime = document.getElementById('nextDrawTime').innerText; document.getElementById('gameOverMsg').innerHTML = `Sayang! Si <b>${win.name.toUpperCase()}</b> ang nanalo.<br><br>Bawi tayo sa next draw!<br><span style="color:var(--gold); font-weight:800; font-size:14px; margin-top:5px; display:block;">SCHEDULE: ${nextTime}</span>`; } } else { banner.style.display = 'none'; cardCont.classList.remove('card-win', 'card-lost'); gameOverlay.style.display = 'none'; document.querySelectorAll('.cell').forEach(c => { c.classList.remove('win-glow', 'win-line-h', 'win-line-v', 'win-line-d1', 'win-line-d2'); }); } });
        db.ref('gameState/currentPattern').on('value', s => { currentPattern = s.val() || "Normal Bingo"; document.getElementById('patternName').innerText = currentPattern; checkWin(); });
        db.ref('drawnNumbers').on('value', s => { const val = s.val(); const newGameDrawn = val ? Object.values(val).map(n => n.toString()) : []; if(newGameDrawn.length > 0 && gameDrawn.length > 0) { const newBalls = newGameDrawn.filter(x => !gameDrawn.includes(x)); if(newBalls.length > 0) { const latestBall = newBalls[newBalls.length - 1]; playSound('newBall'); showToast("BOLA: " + latestBall); } } gameDrawn = newGameDrawn; const btn = document.getElementById('newCardBtn'); if(gameDrawn.length > 0) { btn.disabled = true; btn.innerHTML = `<i data-lucide="lock" style="width:14px"></i> IN GAME`; } else { btn.disabled = false; btn.innerHTML = `<i data-lucide="refresh-cw" style="width:14px"></i> NEW CARD`; } lucide.createIcons(); checkLateJoiner(); updateGridHits(); renderPrevBalls(); checkWin(); checkPuroStatus(); });
        db.ref('gameState/lastCalled').on('value', s => { if(s.exists()) { const num = s.val(); document.getElementById('currentBall').innerText = num; if (num !== lastSpokenNumber) { speakNumber(num); lastSpokenNumber = num; } } else { document.getElementById('currentBall').innerText = "--"; lastSpokenNumber = null; } });
    }
    let lastSpokenNumber = null;
    function speakNumber(num) { if ('speechSynthesis' in window) { let letter = "B"; if (num > 15) letter = "I"; if (num > 30) letter = "N"; if (num > 45) letter = "G"; if (num > 60) letter = "O"; const msg = new SpeechSynthesisUtterance(`${letter} ${num}`); msg.rate = 0.9; window.speechSynthesis.speak(msg); } }

    function checkWin() { if(userData.hasWonCurrent || gameDrawn.length === 0) return; db.ref('gameState/latestWinner').once('value', snap => { if(snap.exists()) return; let winningWays = []; if (currentPattern === "Blackout") { winningWays = [Array.from({length: 25}, (_, i) => i)]; } else if (currentPattern === "Letter X") { winningWays = [[0,4,6,8,12,16,18,20,24]]; } else if (currentPattern === "Four Corners") { winningWays = [[0,4,20,24]]; } else { winningWays = [ [0,1,2,3,4],[5,6,7,8,9],[10,11,12,13,14],[15,16,17,18,19],[20,21,22,23,24], [0,5,10,15,20],[1,6,11,16,21],[2,7,12,17,22],[3,8,13,18,23],[4,9,14,19,24], [0,6,12,18,24], [4,8,12,16,20] ]; } for(let i = 0; i < winningWays.length; i++) { let w = winningWays[i]; if(w.every(idx => marks.includes(idx))) { highlightWinningPattern(w, i); triggerWin(); break; } } }); }
    function checkPuroStatus() { if(userData.hasWonCurrent || gameDrawn.length === 0) return; document.getElementById('bingoCardContainer').classList.remove('card-puro'); document.querySelectorAll('.cell').forEach(c => c.classList.remove('cell-waiting')); let winningWays = []; if (currentPattern === "Blackout") winningWays = [Array.from({length: 25}, (_, i) => i)]; else if (currentPattern === "Letter X") winningWays = [[0,4,6,8,12,16,18,20,24]]; else if (currentPattern === "Four Corners") winningWays = [[0,4,20,24]]; else winningWays = [[0,1,2,3,4],[5,6,7,8,9],[10,11,12,13,14],[15,16,17,18,19],[20,21,22,23,24],[0,5,10,15,20],[1,6,11,16,21],[2,7,12,17,22],[3,8,13,18,23],[4,9,14,19,24],[0,6,12,18,24],[4,8,12,16,20]]; for (let i = 0; i < winningWays.length; i++) { let w = winningWays[i]; let missing = w.filter(idx => !marks.includes(idx)); if (missing.length === 1) { document.getElementById('bingoCardContainer').classList.add('card-puro'); const missingIdx = missing[0]; const cells = document.querySelectorAll('.cell'); if(cells[missingIdx]) cells[missingIdx].classList.add('cell-waiting'); break; } } }
    function highlightWinningPattern(indices, patternType) { const cells = document.querySelectorAll('.cell'); indices.forEach(idx => { const cell = cells[idx]; cell.classList.add('win-glow'); if (currentPattern === 'Normal Bingo') { if (patternType < 5) cell.classList.add('win-line-h'); else if (patternType < 10) cell.classList.add('win-line-v'); else if (patternType === 10) cell.classList.add('win-line-d1'); else cell.classList.add('win-line-d2'); } }); }

    function triggerWin() { const uid = auth.currentUser.uid; let winPrize = 500; if (isJackpotActive) winPrize = currentJackpotAmount; db.ref('gameState/latestWinner').set({ name: userData.name, uid: uid, prize: winPrize }); db.ref('users/' + uid + '/points').transaction(p => (p || 0) + winPrize); db.ref('users/' + uid).update({ hasWonCurrent: true }); userData.hasWonCurrent = true; if (isJackpotActive) { const jpModal = document.getElementById('grandJackpotModal'); document.getElementById('grandPrizeAmount').innerText = winPrize.toLocaleString() + " RB COINS"; document.getElementById('jpWinnerName').innerText = userData.name; jpModal.style.display = 'flex'; confetti({ particleCount: 500, spread: 120, startVelocity: 60 }); } }
    
    function generateNewCard() { if(gameDrawn.length > 0) return showToast("Bawal magpalit habang may laro!"); let card = []; let cols = [[1,15],[16,30],[31,45],[46,60],[61,75]]; cols.forEach(r => { let nums = []; while(nums.length < 5) { let n = Math.floor(Math.random() * (r[1] - r[0] + 1)) + r[0]; if(!nums.includes(n)) nums.push(n); } card.push(...nums); }); let finalCard = []; for(let r=0; r<5; r++) { for(let c=0; c<5; c++) { finalCard.push(card[c*5 + r]); } } finalCard[12] = "FREE"; db.ref('users/' + auth.currentUser.uid).update({ currentCard: finalCard, cardTimestamp: Date.now(), hasWonCurrent: false }); cardNumbers = finalCard; renderCard(); playSound('cardFlip'); }
    
    function renderCard() { 
        const grid = document.getElementById('bingoGrid'); 
        grid.innerHTML = ""; 
        cardNumbers.forEach((n, i) => { 
            const div = document.createElement('div'); 
            div.className = 'cell'; 
            div.innerText = n === "FREE" ? "‚òÖ" : n; 
            grid.appendChild(div); 
        }); 
        updateGridHits(); 
        applySkin(userData.equippedSkin || 'default'); 
    }
    
    function updateGridHits() { 
        marks = [12]; 
        const cells = document.querySelectorAll('.cell'); 
        cells.forEach((c, i) => { 
            const val = c.innerText; 
            const isHit = gameDrawn.includes(val) || val === "‚òÖ";
            if(isHit) { 
                c.classList.add('hit'); 
                if(!marks.includes(i)) marks.push(i); 
            } else {
                c.classList.remove('hit');
            }
        }); 
    }
    
    function renderPrevBalls() { const row = document.getElementById('ballRow'); row.innerHTML = ""; const last5 = gameDrawn.slice(-5).reverse(); last5.forEach(n => { let d = document.createElement('div'); d.className = 'ball-small'; d.innerText = n; row.appendChild(d); }); }
    function checkLateJoiner() { const overlay = document.getElementById('lateOverlay'); if(gameDrawn.length > 0 && !userData.currentCard) { overlay.style.display = 'flex'; } else if (gameDrawn.length > 0 && userData.cardTimestamp > db.ref('gameState/gameStartTime')) { overlay.style.display = 'none'; } else { overlay.style.display = 'none'; } }

    function setupPresence(uid) { 
        const onlineRef = db.ref('.info/connected'); 
        const userStatusRef = db.ref('status/' + uid); 
        
        onlineRef.on('value', (snapshot) => { 
            if (snapshot.val() === false) return; 
            userStatusRef.onDisconnect().remove().then(() => { 
                userStatusRef.set({ state: 'online', last_changed: firebase.database.ServerValue.TIMESTAMP }); 
            }); 
        }); 
        
        // Listen to ALL online status
        db.ref('status').on('value', (s) => { 
            const val = s.val() || {};
            onlineUsersCache = val; 
            document.getElementById('onlineCount').innerText = s.numChildren() || 0;
            updateActiveIndicators();
        }); 
    }

    function updateActiveIndicators() {
        const avatars = document.querySelectorAll('.avatar-frame[data-uid]');
        avatars.forEach(av => {
            const uid = av.dataset.uid;
            const dot = av.querySelector('.online-status-dot');
            if(dot) {
                if(onlineUsersCache[uid]) {
                    dot.classList.add('active');
                } else {
                    dot.classList.remove('active');
                }
            }
        });
    }

    function updatePresenceData(uid, name, points, photo) { db.ref('status/' + uid).update({ name: name, points: points, photo: photo }); }
            // === CHAT & MESSENGER LOGIC ===
    function setupChat() { 
        const list = document.getElementById('chatList'); 
        db.ref('chats').limitToLast(50).on('child_added', s => { 
            const d = s.val(); const key = s.key; if(isUserMuted(d.uid)) return; 
            const isMe = d.uid === auth.currentUser.uid; 
            const div = document.createElement('div'); div.className = 'chat-row'; div.style.flexDirection = isMe ? 'row-reverse' : 'row'; 
            let replyHtml = ''; if(d.replyTo && d.replyMsg) { replyHtml = `<div style="font-size:10px; opacity:0.7; border-left:2px solid var(--accent); padding-left:5px; margin-bottom:5px; background:rgba(0,0,0,0.2); padding:4px; border-radius:4px;">Replying to: ${d.replyMsg.substring(0, 30)}...</div>`; } 
            
            div.innerHTML = `<img class="chat-pfp" src="${d.pfp}" onclick="showUserOptions('${d.uid}', '${d.name.replace(/'/g, "\\'")}', '${d.pfp}')"><div class="chat-content"><div class="bubble">${!isMe ? `<div class="chat-name" onclick="replyTo('${key}', '${d.msg.replace(/'/g, "\\'")}')">${d.name}</div>` : ''}${replyHtml}<div class="chat-text">${d.msg}</div></div></div>`; 
            list.appendChild(div); list.scrollTop = list.scrollHeight; lucide.createIcons(); 
        }); 
    }
    
    function isUserMuted(uid) { const muted = localStorage.getItem('muted_users'); if(!muted) return false; return JSON.parse(muted).includes(uid); }
    function muteUser(uid) { let muted = JSON.parse(localStorage.getItem('muted_users') || "[]"); if(!muted.includes(uid)) { muted.push(uid); localStorage.setItem('muted_users', JSON.stringify(muted)); showToast("User muted locally."); } }
    function sendChat() { const inp = document.getElementById('chatIn'); const msg = inp.value.trim(); if(!msg) return; const payload = { name: userData.name, msg: msg, pfp: userData.photo, uid: userData.uid, time: Date.now() }; if(selectedReplyId) { payload.replyTo = selectedReplyId; payload.replyMsg = document.getElementById('replyText').innerText.replace("Replying to: ", ""); cancelReply(); } db.ref('chats').push(payload); inp.value = ""; }
    function replyTo(key, msg) { selectedReplyId = key; document.getElementById('replyText').innerText = "Replying to: " + msg.substring(0, 20) + "..."; document.getElementById('replyIndicator').style.display = 'flex'; document.getElementById('chatIn').focus(); }
    function cancelReply() { selectedReplyId = null; document.getElementById('replyIndicator').style.display = 'none'; }

    // === MESSENGER FUNCTIONS ===
    let currentChatPartner = null;
    let isGroupChat = false;

    function openMessenger() { document.getElementById('pmModal').style.display = 'flex'; document.getElementById('pmInboxView').style.display = 'flex'; document.getElementById('pmChatView').style.display = 'none'; loadInbox(); }
    
    function loadInbox() { 
        const uid = auth.currentUser.uid; 
        const list = document.getElementById('pmList'); 
        list.innerHTML = "<div style='text-align:center; padding:20px; opacity:0.5;'>Loading...</div>"; 
        
        renderActiveFriends();

        // Load Groups
        db.ref('groupMembers/' + uid).once('value', gSnap => {
            const myGroups = gSnap.exists() ? Object.keys(gSnap.val()) : [];
            db.ref('messages').once('value', s => { 
                const conversations = {}; 
                s.forEach(msgSnap => { const m = msgSnap.val(); if(m.from === uid || m.to === uid) { const partner = m.from === uid ? m.to : m.from; conversations[partner] = m; } }); 
                list.innerHTML = ""; 
                myGroups.forEach(groupId => {
                    db.ref('groups/' + groupId).once('value', groupSnap => {
                        const grp = groupSnap.val();
                        if(!grp) return;
                        const div = document.createElement('div');
                        div.className = 'pm-item';
                        div.onclick = () => openGroupChat(groupId, grp.name);
                        div.innerHTML = `<div style="width:55px; height:55px; border-radius:50%; background:#1e293b; display:flex; align-items:center; justify-content:center; color:white; border:1px solid rgba(255,255,255,0.1);"><i data-lucide="users"></i></div><div class="pm-info"><span class="pm-name">${grp.name}</span><span class="pm-preview">Group Chat</span></div>`;
                        list.appendChild(div);
                        lucide.createIcons();
                    });
                });
                if(Object.keys(conversations).length === 0 && myGroups.length === 0) { list.innerHTML = "<div style='text-align:center; padding:20px;'>No messages yet.</div>"; return; } 
                Object.keys(conversations).forEach(partnerId => { 
                    db.ref('users/' + partnerId).once('value', uSnap => { 
                        const u = uSnap.val(); 
                        const lastMsg = conversations[partnerId]; 
                        const div = document.createElement('div'); 
                        div.className = 'pm-item'; 
                        div.onclick = () => openPrivateChat(partnerId, u.name, u.photo); 
                        const previewText = lastMsg.image ? 'Sent a photo' : lastMsg.text;
                        div.innerHTML = `<img class="pm-avatar" src="${u.photo || 'https://via.placeholder.com/40'}" style="width:55px; height:55px; border-radius:50%; object-fit:cover;"><div class="pm-info"><span class="pm-name">${u.name} ${getBadgeHtml(u.points || 0)}</span><span class="pm-preview">${lastMsg.from === uid ? 'You: ' : ''}${previewText}</span></div>`; 
                        list.appendChild(div); 
                        lucide.createIcons();
                    }); 
                }); 
            });
        });
    }
    
    function renderActiveFriends() {
        const bar = document.getElementById('activeFriendsBar');
        bar.innerHTML = '';
        db.ref('friends/' + auth.currentUser.uid).once('value', s => {
            if(!s.exists()) return;
            s.forEach(f => {
                db.ref('users/' + f.key).once('value', uSnap => {
                    const u = uSnap.val();
                    const item = document.createElement('div');
                    item.className = 'active-friend-item';
                    item.style.display = 'flex'; item.style.flexDirection='column'; item.style.alignItems='center'; item.style.minWidth='60px'; item.style.cursor='pointer';
                    item.onclick = () => openPrivateChat(f.key, u.name, u.photo); 
                    
                    // Logic to show online dot only if online
                    const isOnline = onlineUsersCache[f.key];
                    const dotHtml = isOnline ? `<div style="position:absolute; bottom:2px; right:2px; width:12px; height:12px; background:#22c55e; border:2px solid #000; border-radius:50%;"></div>` : '';

                    item.innerHTML = `
                        <div style="position:relative; width:50px; height:50px;">
                            <img src="${u.photo}" style="width:50px; height:50px; border-radius:50%; border:2px solid var(--messenger-blue); object-fit:cover;">
                            ${dotHtml}
                        </div>
                        <div style="font-size:11px; color:#e4e6eb; margin-top:5px; max-width:60px; overflow:hidden; white-space:nowrap; text-overflow:ellipsis;">${u.name.split(' ')[0]}</div>
                    `;
                    bar.appendChild(item);
                });
            });
        });
    }

    function openPrivateChat(uid, name, photo) { 
        if(uid === auth.currentUser.uid) return showToast("Cant msg self"); 
        currentChatPartner = uid; isGroupChat = false;
        document.getElementById('pmModal').style.display = 'flex'; document.getElementById('pmInboxView').style.display = 'none'; document.getElementById('pmChatView').style.display = 'flex'; 
        document.getElementById('chatTargetName').innerText = name; document.getElementById('chatTargetStatus').innerText = "Active now";
        document.getElementById('chatTargetAvatarCont').innerHTML = `<img src="${photo}" style="width:100%; height:100%; border-radius:50%; object-fit:cover;">`;
        db.ref('notifications/' + auth.currentUser.uid).once('value', s => { s.forEach(n => { if(n.val().type === 'pm' && n.val().from === uid) db.ref('notifications/' + auth.currentUser.uid + '/' + n.key).remove(); }); });
        listenPrivateMessages(auth.currentUser.uid); 
    }
    
    function backToInbox() { currentChatPartner = null; isGroupChat = false; document.getElementById('pmChatView').style.display = 'none'; document.getElementById('pmInboxView').style.display = 'flex'; if(pmListenerRef) pmListenerRef.off(); loadInbox(); }
    
    let pmImageBase64 = null;
    function handlePmImage(input) { if(input.files && input.files[0]) { compressImage(input.files[0], 500, 0.7).then(base64 => { pmImageBase64 = base64; document.getElementById('pmImgPreviewCont').style.display = 'block'; }); } }

    function sendPrivateMessage() { 
        const inp = document.getElementById('pmInput'); const text = inp.value.trim(); if((!text && !pmImageBase64) || !currentChatPartner) return; 
        const myUid = auth.currentUser.uid; 
        if(isGroupChat) {
            const msgData = { from: myUid, senderName: userData.name, text: text, image: pmImageBase64, timestamp: Date.now() };
            db.ref('groupMessages/' + currentChatPartner).push(msgData);
        } else {
            const msgData = { from: myUid, to: currentChatPartner, text: text, image: pmImageBase64, timestamp: Date.now() }; 
            db.ref('messages').push(msgData); 
            const notifMsg = pmImageBase64 ? 'Sent a photo' : `New PM from ${userData.name}`;
            db.ref('notifications/' + currentChatPartner).push({ msg: notifMsg, time: Date.now(), type: 'pm', from: myUid }); 
        }
        inp.value = ""; pmImageBase64 = null; document.getElementById('pmImgInput').value = ""; document.getElementById('pmImgPreviewCont').style.display = 'none';
    }
    
    let pmListenerRef = null;
    function listenPrivateMessages(myUid) { 
        const chatDiv = document.getElementById('pmMessages'); chatDiv.innerHTML = ""; if(pmListenerRef) db.ref('messages').off();
        pmListenerRef = db.ref('messages').limitToLast(100);
        pmListenerRef.on('child_added', s => { 
            const m = s.val(); const key = s.key; if(!currentChatPartner) return; 
            if( (m.from === myUid && m.to === currentChatPartner) || (m.from === currentChatPartner && m.to === myUid) ) { 
                const div = document.createElement('div'); div.className = `msg-bubble ${m.from === myUid ? 'msg-me' : 'msg-them'}`; 
                div.style.alignSelf = m.from === myUid ? 'flex-end' : 'flex-start';
                div.style.background = m.from === myUid ? 'var(--messenger-blue)' : 'var(--messenger-grey)';
                div.style.padding = '10px 15px'; div.style.borderRadius = '18px'; div.style.maxWidth = '75%'; div.style.marginBottom = '2px'; div.style.color='white';
                let contentHtml = m.text; if(m.image) contentHtml += `<br><img src="${m.image}" class="msg-image-preview">`;
                let heartHtml = m.hearted ? `<div class="msg-heart-reaction">‚ù§Ô∏è</div>` : '';
                div.innerHTML = `${contentHtml}${heartHtml}`; 
                div.ondblclick = () => { if(!m.hearted) { db.ref('messages/' + key).update({ hearted: true }); showToast("Message hearted"); } };
                chatDiv.appendChild(div); chatDiv.scrollTop = chatDiv.scrollHeight; 
            } 
        }); 
    }

    // === NOTIFICATIONS (UPDATED: DELETE & REDIRECT) ===
    function listenNotifications(uid) { 
        db.ref('notifications/' + uid).on('value', s => { 
            let unreadPMs = 0; let count = 0;
            s.forEach(child => { const val = child.val(); if(val.type === 'pm') unreadPMs++; else count++; });
            const dot = document.getElementById('notifDot'); const pmBadge = document.getElementById('pmBadge');
            if(count > 0) { dot.style.display = 'flex'; dot.innerText = count > 9 ? '9+' : count; } else { dot.style.display = 'none'; }
            if(unreadPMs > 0) { pmBadge.style.display = 'flex'; pmBadge.innerText = unreadPMs > 9 ? '9+' : unreadPMs; } else { pmBadge.style.display = 'none'; }
        }); 
    }
    
    function openNotifs() { document.getElementById('notifModal').style.display='flex'; playSound('click'); renderNotifs(); }
    
    function renderNotifs() { 
        const list = document.getElementById('notifList'); 
        db.ref('notifications/' + auth.currentUser.uid).once('value', s => { 
            list.innerHTML = ""; 
            const notifs = [];
            s.forEach(n => { if(n.val().type !== 'pm') notifs.push({ key: n.key, ...n.val() }); });
            notifs.sort((a,b) => b.time - a.time);
            if(notifs.length === 0) { list.innerHTML = "<div style='text-align:center; opacity:0.5; padding:40px;'>No new notifications</div>"; return; }
            notifs.forEach(val => {
                const div = document.createElement('div'); div.className = 'notif-card-grouped';
                let iconOrImg = `<i data-lucide="info" style="color:#64748b;"></i>`; if(val.image) iconOrImg = `<img src="${val.image}" class="notif-img">`;
                const contentDiv = document.createElement('div'); contentDiv.className = 'notif-content-wrap';
                contentDiv.innerHTML = `<div style="font-size:13px; color:white;">${val.msg}</div><div style="font-size:10px; opacity:0.5; margin-top:5px;">${fixDate(val.time)}</div>`;
                contentDiv.onclick = () => handleNotificationClick(val);
                const delBtn = document.createElement('button'); delBtn.className = 'notif-delete-btn';
                delBtn.innerHTML = `<i data-lucide="trash-2" style="width:14px;"></i>`;
                delBtn.onclick = (e) => { e.stopPropagation(); deleteNotif(val.key); };
                div.innerHTML = iconOrImg; div.appendChild(contentDiv); div.appendChild(delBtn);
                list.appendChild(div);
            });
            lucide.createIcons();
        }); 
    }

    function handleNotificationClick(notif) {
        document.getElementById('notifModal').style.display='none';
        if(notif.type === 'like' || notif.type === 'comment' || notif.type === 'share') { openComments(notif.postId); } 
        else if (notif.type === 'friendReq') { document.getElementById('friendRequestsSection').scrollIntoView({ behavior: 'smooth' }); }
    }
    function deleteNotif(key) { db.ref('notifications/' + auth.currentUser.uid + '/' + key).remove(); renderNotifs(); }

    // === SOCIAL FEED (SHARE + REACTION PREVIEW) ===
    let postListener = null; let feedSortMethod = 'hype';
    function toggleFeedSort(method) { feedSortMethod = method; document.getElementById('sort-hype').classList.remove('active'); document.getElementById('sort-new').classList.remove('active'); document.getElementById('sort-' + method).classList.add('active'); loadSocialFeed(); }

    function loadSocialFeed() {
        const feedContainer = document.getElementById('socialFeed');
        if(postListener) db.ref('socialPosts').off(); 
        feedContainer.innerHTML = "<div style='text-align:center; padding:20px; opacity:0.5;'>Loading Feed...</div>";
        db.ref('friends/' + auth.currentUser.uid).once('value', fSnap => {
            const myFriends = fSnap.exists() ? Object.keys(fSnap.val()) : [];
            postListener = db.ref('socialPosts').limitToLast(50);
            postListener.on('value', pSnap => {
                const allPosts = [];
                pSnap.forEach(child => { const val = child.val(); if(typeof val === 'object' && val !== null) { const likeCount = val.likes || 0; const score = val.timestamp + (likeCount * 3600000); allPosts.push({ key: child.key, hypeScore: score, ...val }); } });
                if(feedSortMethod === 'hype') allPosts.sort((a, b) => b.hypeScore - a.hypeScore); else allPosts.sort((a, b) => b.timestamp - a.timestamp);
                const scrollPos = window.scrollY; feedContainer.innerHTML = "";
                if(allPosts.length === 0) { feedContainer.innerHTML = "<div style='text-align:center; padding:20px; opacity:0.5;'>No posts yet. Be the first!</div>"; return; }
                allPosts.forEach(post => { const isFriend = myFriends.includes(post.uid); const isMe = post.uid === auth.currentUser.uid; const div = createPostElement(post, isFriend || isMe); feedContainer.appendChild(div); });
                lucide.createIcons(); updateActiveIndicators(); if(window.scrollY > 200) setTimeout(() => window.scrollTo(0, scrollPos), 10);
            });
        });
    }

    function createPostElement(post, isFriend) {
        const postDiv = document.createElement('div'); postDiv.className = 'post-card'; postDiv.id = 'post-' + post.key;
        const moodHtml = post.mood ? `<div class="mood-display">Feeling ${post.mood}</div>` : '';
        const imgHtml = post.image ? `<div class="post-image-container"><img src="${post.image}" class="post-image"></div>` : '';
        let sharedHtml = '';
        if(post.sharedFrom && post.sharedContent) {
            let sharedImg = post.sharedImage ? `<div class="post-image-container" style="max-height:200px;"><img src="${post.sharedImage}" class="post-image"></div>` : '';
            sharedHtml = `<div class="shared-post-wrapper"><div class="shared-header"><i data-lucide="repeat" style="width:12px"></i> Shared from ${post.sharedAuthorName}</div><div class="post-content" style="padding:10px; font-size:13px; opacity:0.9;">${post.sharedContent}</div>${sharedImg}</div>`;
        }
        postDiv.innerHTML = `
            <div class="post-header">${renderAvatarWithBadge(post.authorPhoto, post.authorPoints, 40, post.uid)}<div class="post-meta"><div class="post-author" onclick="openUserProfile('${post.uid}')">${post.authorName} ${getBadgeHtml(post.authorPoints || 0)}</div><div class="post-time">${fixDate(post.timestamp)}</div>${moodHtml}</div></div>
            <div class="post-content">${post.content}</div>${imgHtml}${sharedHtml}
            <div class="post-stats-bar"><div class="reaction-faces" id="react-faces-${post.key}"></div><div id="stats-text-${post.key}">${post.likes || 0} Likes</div></div>
            <div class="post-actions" style="position:relative;"><button class="action-btn" id="like-btn-${post.key}" onclick="showReactionPopup('${post.key}')"><i data-lucide="heart" id="like-icon-${post.key}" style="width:16px;"></i> Like</button><div id="react-pop-${post.key}" class="reaction-popup" onmouseleave="this.style.display='none'" style="display:none;"><span class="reaction-emoji" onclick="submitReaction('${post.key}', '${post.uid}', '‚ù§Ô∏è')">‚ù§Ô∏è</span><span class="reaction-emoji" onclick="submitReaction('${post.key}', '${post.uid}', 'üòÇ')">üòÇ</span><span class="reaction-emoji" onclick="submitReaction('${post.key}', '${post.uid}', 'üòÆ')">üòÆ</span><span class="reaction-emoji" onclick="submitReaction('${post.key}', '${post.uid}', 'üò¢')">üò¢</span></div><button class="action-btn" onclick="openComments('${post.key}')"><i data-lucide="message-circle" style="width:16px"></i> Comment</button><button class="action-btn" onclick="sharePost('${post.key}')"><i data-lucide="share-2" style="width:16px"></i> Share</button></div>
            <div id="cmt-prev-${post.key}" class="comment-preview-area" style="display:none;" onclick="openComments('${post.key}')"></div>
        `;
        db.ref('postLikes/' + post.key + '/' + auth.currentUser.uid).once('value', lSnap => { if(lSnap.exists()) { const btn = postDiv.querySelector('#like-btn-' + post.key); const reaction = lSnap.val(); if(btn) { btn.classList.add('liked'); btn.innerHTML = `<span style="font-size:16px;">${reaction === true ? '‚ù§Ô∏è' : reaction}</span> Like`; } } });
        db.ref('postComments/' + post.key).limitToLast(1).once('value', cSnap => { if(cSnap.exists()) { const cVal = Object.values(cSnap.val())[0]; const prevDiv = postDiv.querySelector('#cmt-prev-' + post.key); prevDiv.style.display = 'flex'; prevDiv.innerHTML = `<span class="cmt-prev-user">${cVal.uName}:</span> <span class="cmt-prev-text">${cVal.text.substring(0, 40)}${cVal.text.length > 40 ? '...' : ''}</span>`; } });
        return postDiv;
    }
    
    function sharePost(postKey) {
        showCustomConfirm("Share Post?", "Share this to your timeline?", () => {
            db.ref('socialPosts/' + postKey).once('value', s => {
                const original = s.val(); if(!original) return;
                const postData = { uid: auth.currentUser.uid, authorName: userData.name, authorPhoto: userData.photo, authorPoints: userData.points, content: `Shared a post`, timestamp: Date.now(), likes: 0, sharedFrom: original.uid, sharedAuthorName: original.authorName, sharedContent: original.content, sharedImage: original.image || null };
                db.ref('socialPosts').push(postData);
                if(original.uid !== auth.currentUser.uid) { db.ref('notifications/' + original.uid).push({ msg: `${userData.name} shared your post`, time: Date.now(), type: 'share', from: auth.currentUser.uid, postId: postKey, image: userData.photo }); }
                showToast("Post Shared!"); playSound('pop');
            });
        });
    }

    function showReactionPopup(postKey) { const pop = document.getElementById('react-pop-' + postKey); if(pop.style.display === 'flex') pop.style.display = 'none'; else { pop.style.display = 'flex'; setTimeout(() => { document.addEventListener('click', function close(e) { if(!e.target.closest('#like-btn-'+postKey) && !e.target.closest('#react-pop-'+postKey)) { pop.style.display = 'none'; document.removeEventListener('click', close); } }); }, 100); } }
    function submitReaction(postKey, authorUid, emoji) {
        const myUid = auth.currentUser.uid; const likeRef = db.ref('postLikes/' + postKey + '/' + myUid); const pop = document.getElementById('react-pop-' + postKey); pop.style.display = 'none'; 
        likeRef.once('value', s => {
            if(s.exists() && s.val() === emoji) { likeRef.remove(); db.ref('socialPosts/' + postKey + '/likes').transaction(l => (l || 1) - 1); } 
            else { 
                if(!s.exists()) { db.ref('socialPosts/' + postKey + '/likes').transaction(l => (l || 0) + 1); 
                const rewardHistoryRef = db.ref('rewardHistory/' + postKey + '/' + myUid);
                rewardHistoryRef.once('value', histSnap => { if(!histSnap.exists()) { if(authorUid !== myUid) { db.ref('users/' + authorUid + '/points').transaction(p => (p || 0) + 10); db.ref('notifications/' + authorUid).push({ msg: `${userData.name} reacted ${emoji} to your post`, time: Date.now(), type: 'like', from: myUid, postId: postKey, image: userData.photo }); } rewardHistoryRef.set(true); } }); } 
                likeRef.set(emoji); 
            }
        });
    }
    
    let selectedMood = null; 
    let selectedImageBase64 = null;
    function selectMood(el, mood) { const isActive = el.classList.contains('active'); document.querySelectorAll('.mood-chip').forEach(c => c.classList.remove('active')); if(!isActive) { el.classList.add('active'); selectedMood = mood; } else { selectedMood = null; } }
    function handlePostImage(input) { if(input.files && input.files[0]) { compressImage(input.files[0], 800, 0.7).then(base64 => { selectedImageBase64 = base64; document.getElementById('postImgPreview').src = selectedImageBase64; document.getElementById('imgPreviewCont').style.display = 'block'; }); } }
    function removePostImage() { selectedImageBase64 = null; document.getElementById('postImgInput').value = ""; document.getElementById('imgPreviewCont').style.display = 'none'; }
    function createPost() {
        const txt = document.getElementById('postInput').value.trim(); if(!txt && !selectedImageBase64) return showToast("Type something or add photo!");
        const postData = { uid: auth.currentUser.uid, authorName: userData.name, authorPhoto: userData.photo, authorPoints: userData.points, content: txt, mood: selectedMood, image: selectedImageBase64, timestamp: Date.now(), likes: 0 };
        db.ref('socialPosts').push(postData); document.getElementById('postInput').value = ""; removePostImage(); document.querySelectorAll('.mood-chip').forEach(c => c.classList.remove('active')); selectedMood = null; showToast("Posted!"); playSound('pop');
    }

    // === PROFILE, SEARCH & SETTINGS ===
    function openUserProfile(uid) {
        currentProfileUid = uid; document.getElementById('userOptionsModal').style.display = 'none'; document.getElementById('searchModal').style.display = 'none'; document.getElementById('userProfilePage').style.display = 'flex';
        document.getElementById('pageProfileFeed').innerHTML = "<div style='color:white; opacity:0.5; text-align:center; padding:20px;'>Loading...</div>"; document.getElementById('profileMainActionBtn').style.display = 'none'; document.getElementById('unfriendBtn').style.display = 'none';
        db.ref('users/' + uid).once('value', s => {
            const u = s.val();
            document.getElementById('pageProfileAvatarContainer').innerHTML = `<div class="avatar-frame" style="width:140px; height:140px; border:4px solid #0f172a; border-radius:50%;"><img src="${u.photo || 'https://via.placeholder.com/140'}" style="width:100%; height:100%; border-radius:50%; object-fit:cover;">${getBadgeHtml(u.points || 0).replace('width:12px', 'width:24px').replace('height:12px', 'height:24px')}</div>`;
            document.getElementById('pageProfileName').innerHTML = `${u.name}`; document.getElementById('pageProfileBio').innerText = u.bio || "Radio Bingo Player";
            if(u.cover) { document.getElementById('pageProfileCover').style.backgroundImage = `url('${u.cover}')`; } else { document.getElementById('pageProfileCover').style.backgroundImage = 'none'; document.getElementById('pageProfileCover').style.backgroundColor = '#334155'; }
            updateProfileButtonState(uid);
            db.ref('friends/' + uid).once('value', fSnap => { document.getElementById('statFriends').innerText = fSnap.numChildren() || 0; });
            loadProfilePosts(uid); lucide.createIcons();
        });
    }
    function closeProfilePage() { document.getElementById('userProfilePage').style.display = 'none'; currentProfileUid = null; }
    function openMyProfile() { openUserProfile(auth.currentUser.uid); }
    function openMenuModal() { document.getElementById('menuModal').style.display='flex'; loadHistory(); }
    
    function updateProfileButtonState(uid) {
        const btn = document.getElementById('profileMainActionBtn'); const unfriendBtn = document.getElementById('unfriendBtn'); const myUid = auth.currentUser.uid; unfriendBtn.style.display = 'none';
        if(uid === myUid) { btn.innerText = "Edit Profile"; btn.className = "profile-action-btn secondary"; btn.onclick = openEditProfile; btn.style.display = 'block'; } else {
            db.ref('friends/' + myUid + '/' + uid).once('value', s => {
                if(s.exists()) { btn.innerText = "Message"; btn.className = "profile-action-btn"; db.ref('users/'+uid).once('value', us => { const u = us.val(); btn.onclick = () => openPrivateChat(uid, u.name, u.photo); }); unfriendBtn.style.display = 'flex'; } else {
                     db.ref('friendRequests/' + uid + '/' + myUid).once('value', reqSnap => {
                         if(reqSnap.exists()) { btn.innerText = "Request Sent"; btn.className = "profile-action-btn secondary"; btn.onclick = null; } else {
                             btn.innerText = "Add Friend"; btn.className = "profile-action-btn";
                             btn.onclick = () => { db.ref('friendRequests/' + uid + '/' + myUid).set(true); updateProfileButtonState(uid); db.ref('notifications/' + uid).push({ msg: `${userData.name} sent a friend request`, time: Date.now(), type: 'friendReq', from: myUid, image: userData.photo }); showToast("Request Sent!"); };
                         }
                     });
                }
                btn.style.display = 'block';
            });
        }
    }
    function loadProfilePosts(uid) {
        const container = document.getElementById('pageProfileFeed'); db.ref('socialPosts').orderByChild('uid').equalTo(uid).limitToLast(20).once('value', pSnap => {
            container.innerHTML = ""; let count = 0; let likes = 0; const posts = [];
            pSnap.forEach(c => { const p = c.val(); posts.push({ key: c.key, ...p }); count++; likes += (p.likes || 0); });
            document.getElementById('statPosts').innerText = count; document.getElementById('statLikes').innerText = likes;
            posts.reverse().forEach(post => { const div = createPostElement(post, false); container.appendChild(div); });
            if(count === 0) container.innerHTML = "<div style='color:white; opacity:0.5; font-size:12px; text-align:center; padding:20px;'>No posts yet</div>"; lucide.createIcons();
        });
    }
    
    function unfriendUser() { if(!currentProfileUid) return; showCustomConfirm("Unfriend User?", "Are you sure you want to remove this friend?", () => { const myUid = auth.currentUser.uid; db.ref('friends/' + myUid + '/' + currentProfileUid).remove(); db.ref('friends/' + currentProfileUid + '/' + myUid).remove(); showToast("Unfriended successfully."); updateProfileButtonState(currentProfileUid); }); }
    function openEditProfile() { document.getElementById('editNameIn').value = userData.name; document.getElementById('editBioIn').value = userData.bio || ""; document.getElementById('editProfileModal').style.display = 'flex'; }
    function handleProfileUpload(input, type) { if(input.files && input.files[0]) { const maxWidth = type === 'cover' ? 1000 : 500; compressImage(input.files[0], maxWidth, 0.7).then(base64 => { input.dataset.b64 = base64; showToast("Image selected! Click Save."); }); } }
    function saveProfileChanges() {
        const newName = document.getElementById('editNameIn').value.trim(); const newBio = document.getElementById('editBioIn').value.trim(); const pfpInput = document.getElementById('editProfilePicInput'); const coverInput = document.getElementById('editCoverPicInput');
        if(newName.length < 2) return showToast("Name too short");
        const updates = { name: newName, bio: newBio }; if(pfpInput.dataset.b64) updates.photo = pfpInput.dataset.b64; if(coverInput.dataset.b64) updates.cover = coverInput.dataset.b64;
        db.ref('users/' + auth.currentUser.uid).update(updates).then(() => { showToast("Profile Updated!"); document.getElementById('editProfileModal').style.display = 'none'; pfpInput.value = ""; delete pfpInput.dataset.b64; coverInput.value = ""; delete coverInput.dataset.b64; openMyProfile(); });
    }

    function initSocialSystem(uid) {
        db.ref('friendRequests/' + uid).on('value', s => { const container = document.getElementById('friendRequestsSection'); container.innerHTML = ""; if(s.exists()) { container.innerHTML="<div style='padding:10px; font-size:12px; color:#94a3b8; font-weight:800;'>FRIEND REQUESTS</div>"; }
            s.forEach(req => { const requesterId = req.key; db.ref('users/' + requesterId).once('value', u => { const uData = u.val(); const div = document.createElement('div'); div.className = 'friend-req-card'; div.innerHTML = `<div class="req-info" onclick="openUserProfile('${requesterId}')"><img src="${uData.photo}" style="width:36px;height:36px;border-radius:50%; object-fit:cover;"><span style="font-weight:700; font-size:13px; color:white;">${uData.name}</span></div><div class="req-actions"><button class="btn-accept" onclick="acceptFriend('${requesterId}')">Confirm</button><button class="btn-decline" onclick="declineFriend('${requesterId}')">Delete</button></div>`; container.appendChild(div); }); });
        });
    }
    function acceptFriend(requesterUid) { const myUid = auth.currentUser.uid; db.ref('friends/' + myUid + '/' + requesterUid).set(true); db.ref('friends/' + requesterUid + '/' + myUid).set(true); db.ref('friendRequests/' + myUid + '/' + requesterUid).remove(); db.ref('notifications/' + requesterUid).push({ msg: `${userData.name} accepted your friend request`, time: Date.now(), type: 'friendReq', from: myUid, image: userData.photo }); showToast("Friend Added!"); playSound('win'); }
    function declineFriend(requesterUid) { db.ref('friendRequests/' + auth.currentUser.uid + '/' + requesterUid).remove(); showToast("Request removed."); }

    function openSearch() { document.getElementById('searchModal').style.display = 'flex'; document.getElementById('searchInput').focus(); }
    let searchTimeout = null;
    function handleSearch() { clearTimeout(searchTimeout); searchTimeout = setTimeout(() => { const q = document.getElementById('searchInput').value.toLowerCase().trim(); const resDiv = document.getElementById('searchResults'); if(q.length < 2) { resDiv.innerHTML = "<div style='text-align:center; opacity:0.5; padding:20px;'>Type more to search...</div>"; return; } resDiv.innerHTML = "<div style='text-align:center; opacity:0.5; padding:20px;'>Searching...</div>";
        db.ref('users').limitToLast(50).once('value', allSnap => { resDiv.innerHTML = ""; let found = false;
             allSnap.forEach(uSnap => { const u = uSnap.val(); const uid = uSnap.key; if(u.name.toLowerCase().includes(q)) { found = true; const div = document.createElement('div'); div.className = 'search-res-item'; div.onclick = () => openUserProfile(uid); div.innerHTML = `${renderAvatarWithBadge(u.photo, u.points, 40, uid)}<div style="font-size:14px; font-weight:700; color:white; margin-left:10px;">${u.name}</div>`; resDiv.appendChild(div); } });
            if(!found) resDiv.innerHTML = "<div style='text-align:center; opacity:0.5; padding:20px;'>No users found.</div>"; lucide.createIcons();
        });
    }, 500); }

    // === COMMENTS ===
    let currentOpenPostKey = null;
    function openComments(postKey) { currentOpenPostKey = postKey; const list = document.getElementById('commentList'); list.innerHTML = "<div style='text-align:center; color:white; opacity:0.5; padding:20px;'>Loading...</div>"; document.getElementById('commentModal').style.display = 'flex'; document.getElementById('commentModalBackdrop').style.display = 'block';
        db.ref('postComments/' + postKey).on('value', s => { list.innerHTML = ""; if(!s.exists()) { list.innerHTML = "<div style='text-align:center; color:white; opacity:0.5; padding:20px;'>No comments yet.</div>"; return; }
            s.forEach(c => { const com = c.val(); const div = document.createElement('div'); div.className = 'comment-item'; div.innerHTML = `<img class="comment-avatar" src="${com.uPhoto}"><div class="comment-content-block"><div class="comment-bubble"><div class="comment-author">${com.uName} ${getBadgeHtml(com.uPoints || 0)}</div><div class="comment-text">${com.text}</div></div><div class="comment-actions"><span>${fixDate(com.time)}</span></div></div>`; list.appendChild(div); }); list.scrollTop = list.scrollHeight; lucide.createIcons();
        });
    }
    function closeComments() { document.getElementById('commentModal').style.display = 'none'; document.getElementById('commentModalBackdrop').style.display = 'none'; if(currentOpenPostKey) db.ref('postComments/' + currentOpenPostKey).off(); currentOpenPostKey = null; }
    function sendComment() { const txt = document.getElementById('commentInput').value.trim(); if(!txt || !currentOpenPostKey) return;
        db.ref('postComments/' + currentOpenPostKey).push({ uid: auth.currentUser.uid, uName: userData.name, uPhoto: userData.photo, uPoints: userData.points, text: txt, time: Date.now() });
        db.ref('socialPosts/' + currentOpenPostKey).once('value', s => { const p = s.val(); if(p.uid !== auth.currentUser.uid) { db.ref('notifications/' + p.uid).push({ msg: `${userData.name} commented on your post`, time: Date.now(), type: 'comment', from: auth.currentUser.uid, postId: currentOpenPostKey, image: userData.photo }); } }); document.getElementById('commentInput').value = "";
    }

    // === STORE ===
    function applySkin(skinId) { const card = document.getElementById('bingoCardContainer'); card.classList.remove('card-skin-neon', 'card-skin-gold', 'card-skin-kitty', 'card-skin-doraemon', 'card-skin-spongebob', 'card-skin-kuromi', 'card-skin-custom'); card.style.backgroundImage = 'none'; if(skinId !== 'default' && skinId !== 'custom') card.classList.add('card-skin-' + skinId);
        if(skinId === 'custom') { card.classList.add('card-skin-custom'); const storedBG = localStorage.getItem('customSkinBG'); if(storedBG) card.style.backgroundImage = `url('${storedBG}')`; }
    }
    function updateSkinButtons() { if(!userData.ownedSkins) return; ['default', 'neon', 'gold', 'kitty', 'doraemon', 'spongebob', 'kuromi', 'custom'].forEach(skin => { const btn = document.getElementById('btn-skin-' + skin); if(!btn) return; if(userData.equippedSkin === skin) { btn.innerText = "EQUIPPED"; btn.className = "btn-buy-skin owned"; btn.onclick = null; } else if(userData.ownedSkins.includes(skin)) { btn.innerText = "EQUIP"; btn.className = "btn-buy-skin equip"; btn.onclick = () => equipSkin(skin); } }); if(localStorage.getItem('customSkinBG')) { document.getElementById('customSkinSlot').style.display = 'block'; document.getElementById('customSkinPreview').style.backgroundImage = `url('${localStorage.getItem('customSkinBG')}')`; } }
    function buyOrEquipSkin(skinId, cost) { if(!userData.ownedSkins) userData.ownedSkins = ['default']; if(userData.ownedSkins.includes(skinId)) { equipSkin(skinId); } else { if(userData.points >= cost) { showCustomConfirm("BUY SKIN?", "Purchase for " + cost + " Coins?", () => { deductPoints(cost); let newOwned = [...userData.ownedSkins, skinId]; db.ref('users/' + userData.uid).update({ ownedSkins: newOwned, equippedSkin: skinId }); showToast("Skin Purchased!"); playSound('win'); spawnFlyingCoins(10); updateSkinButtons(); }); } else { showToast("Insufficient Coins"); } } }
    function equipSkin(skinId) { db.ref('users/' + userData.uid).update({ equippedSkin: skinId }); showToast("Skin Equipped"); playSound('click'); applySkin(skinId); updateSkinButtons(); }
    function handleCustomSkinUpload(input) { if(input.files && input.files[0]) { compressImage(input.files[0], 800, 0.7).then(base64 => { localStorage.setItem('customSkinBG', base64); if(!userData.ownedSkins.includes('custom')) { let newOwned = [...userData.ownedSkins, 'custom']; db.ref('users/' + userData.uid).update({ ownedSkins: newOwned }); } equipSkin('custom'); showToast("Custom Background Set!"); }); } }
    function loadCustomSkin() { /* Handled in updateSkinButtons */ }

    // === MISC HELPERS ===
    function saveGcash() { const num = document.getElementById('gcashInput').value; if(num.length > 3) { db.ref('users/'+auth.currentUser.uid).update({ gcash: num }); showToast("Info Saved!"); } else showToast("Invalid Details"); }
    function redeemItem(name, cost) { if(userData.points >= cost) { if(!userData.gcash) return showToast("Save redemption info first!"); showCustomConfirm("REDEEM REWARD?", "Exchange " + cost + " pts for " + name + "?", () => { deductPoints(cost); db.ref('redemptions').push({ uid: userData.uid, name: userData.name, gcash: userData.gcash, item: name, cost: cost, status: 'pending', timestamp: Date.now() }); showToast("Request Sent!"); loadHistory(); }); } else { showToast("Insufficient RB Coins"); } }
    function loadHistory() { const list = document.getElementById('historyList'); db.ref('redemptions').orderByChild('uid').equalTo(auth.currentUser.uid).limitToLast(10).once('value', s => { list.innerHTML = ""; if(!s.exists()) { list.innerHTML = "<div style='font-size:10px; opacity:0.5;'>No transactions yet</div>"; return; } s.forEach(r => { const d = r.val(); let color = '#fbbf24'; if(d.status === 'sent') color = '#10b981'; if(d.status === 'denied') color = '#ef4444'; list.innerHTML += `<div class="history-item"><div><div style="font-weight:700; font-size:12px;">${d.item}</div><div style="font-size:10px; opacity:0.6;">${fixDate(d.timestamp)}</div></div><div style="font-size:10px; font-weight:800; color:${color}; text-transform:uppercase; border:1px solid ${color}; padding:2px 6px; border-radius:4px;">${d.status}</div></div>`; }); }); }
    function deductPoints(amt) { db.ref('users/' + userData.uid + '/points').transaction(p => (p || 0) - amt); spawnLossAnimation(amt); }
    function addPoints(amt) { db.ref('users/' + userData.uid + '/points').transaction(p => (p || 0) + amt); }
    function spawnFlyingCoins(amount) { const count = Math.min(amount, 15); const targetEl = document.querySelector('.points-badge') || document.getElementById('nav-store'); if(!targetEl) return; const rect = targetEl.getBoundingClientRect(); const targetX = rect.left + (rect.width / 2); const targetY = rect.top + (rect.height / 2); const startX = window.innerWidth / 2; const startY = window.innerHeight / 2; for(let i=0; i<count; i++) { setTimeout(() => { const coin = document.createElement('div'); coin.className = 'flying-coin'; coin.style.left = startX + 'px'; coin.style.top = startY + 'px'; document.body.appendChild(coin); const spread = 80; const randX = (Math.random() - 0.5) * spread; const randY = (Math.random() - 0.5) * spread; requestAnimationFrame(() => { coin.style.transition = 'transform 0.3s ease-out'; coin.style.transform = `translate(${randX}px, ${randY}px) scale(1.2)`; setTimeout(() => { coin.style.transition = 'transform 0.6s cubic-bezier(0.2, 0.8, 0.2, 1), opacity 0.6s'; const moveX = targetX - startX; const moveY = targetY - startY; coin.style.transform = `translate(${moveX}px, ${moveY}px) scale(0.5)`; coin.style.opacity = '0'; }, 300); setTimeout(() => coin.remove(), 900); }); }, i * 30); } }
    function triggerScreenShake() { const target = document.getElementById('bingoCardContainer'); if (target) { target.classList.add('shake-effect'); setTimeout(() => target.classList.remove('shake-effect'), 300); } if (navigator.vibrate) navigator.vibrate([30, 30, 30]); }
    function spawnLossAnimation(amount) { const startX = window.innerWidth / 2; const startY = window.innerHeight / 2; const el = document.createElement('div'); el.className = 'float-loss'; el.innerText = "-" + amount; el.style.left = startX + 'px'; el.style.top = startY + 'px'; document.body.appendChild(el); setTimeout(() => el.remove(), 1000); }

    // === AD & TASK LOGIC ===
    let strictTimer = null; let strictSeconds = 30;
    function startStrictWatch() { const adsterraLink = "https://directoryeditorweep.com/9b/f5/85/9bf585b6ee39cb9b515e2fae1fa958c2.js"; window.open(adsterraLink, "_blank"); const overlay = document.getElementById('adTimerOverlay'); overlay.style.display = 'flex'; strictSeconds = 30; const cd = document.getElementById('adCountdown'); const status = document.getElementById('adStatusText'); const cap = document.getElementById('adCaptchaOverlay'); cd.innerText = strictSeconds + "s"; status.innerText = "Do not close app or switch tabs!"; clearInterval(strictTimer); strictTimer = setInterval(() => { if(document.hidden) { status.innerText = "‚ö†Ô∏è PAUSED! Please return to app."; return; } strictSeconds--; cd.innerText = strictSeconds + "s"; status.innerText = "Watching Ad..."; if(strictSeconds <= 0) { clearInterval(strictTimer); overlay.style.display = 'none'; cap.style.display = 'flex'; const n1 = Math.floor(Math.random()*10); const n2 = Math.floor(Math.random()*10); document.getElementById('mathQ').innerText = `${n1} + ${n2} = ?`; document.getElementById('mathQ').dataset.ans = n1+n2; } }, 1000); }
    function startTaskSafe(url, reward, taskKey) { const lastRun = localStorage.getItem('task_cooldown_' + taskKey); const cooldownTime = 12 * 60 * 60 * 1000; if(lastRun && (Date.now() - parseInt(lastRun)) < cooldownTime) { showToast("‚è≥ Task in cooldown. Try again later."); return; } showCustomConfirm("START TASK", "Complete offer to earn coins.", () => { window.open(url, '_blank'); const btn = document.getElementById('btn-task-' + taskKey); if(btn) { btn.disabled = true; btn.innerHTML = `<i data-lucide="loader" class="icon-spin"></i> 60s`; let timeLeft = 60; const timer = setInterval(() => { timeLeft--; btn.innerHTML = `<i data-lucide="loader" class="icon-spin"></i> ${timeLeft}s`; if(timeLeft <= 0) { clearInterval(timer); btn.innerHTML = "CLAIM REWARD"; btn.disabled = false; btn.style.background = "#22c55e"; btn.onclick = () => claimTaskReward(reward, taskKey); } }, 1000); } }); }
    function claimTaskReward(reward, taskKey) { addPoints(reward); showToast(`üéâ +${reward} Coins Received!`); playSound('win'); spawnFlyingCoins(20); const btn = document.getElementById('btn-task-' + taskKey); if(btn) { btn.innerHTML = "COMPLETED"; btn.disabled = true; btn.style.background = "#334155"; } localStorage.setItem('task_cooldown_' + taskKey, Date.now()); }
    function openVideoLocker(taskKey) { const lastRun = localStorage.getItem('task_cooldown_video'); if(lastRun && (Date.now() - parseInt(lastRun)) < 300000) { showToast("‚è≥ Wait before watching again."); return; } showCustomConfirm("WATCH VIDEO", "You will be redirected to the video task. Complete it to earn.", () => { localStorage.setItem('task_cooldown_video', Date.now()); const win = window.open("", "_blank"); if(win) { win.document.write(`<html><head><title>Video Task Verification</title><meta name="viewport" content="width=device-width, initial-scale=1.0"><style>body{background:#000; color:white; font-family:sans-serif; text-align:center; padding:20px; display:flex; flex-direction:column; justify-content:center; height:100vh;}</style></head><body><h2>Loading Video Task...</h2><p>Please wait while we load the verification.</p><script type="text/javascript">var lck = false;</scr`+`ipt><script type="text/javascript" src="https://doctoredits.com/script_include.php?id=1874676"></scr`+`ipt><script type="text/javascript">if(!lck){top.location = 'https://doctoredits.com/help/ablk.php?lkt=2'; }</scr`+`ipt><noscript>Please enable JavaScript to access this page.<meta http-equiv="refresh" content="0;url=https://doctoredits.com/help/enable_javascript.php?lkt=2" ></meta></noscript><button onclick="window.close()" style="margin-top:20px; padding:10px 20px; background:red; color:white; border:none; border-radius:5px;">Close & Return to Game</button></body></html>`); win.document.close(); } else { showToast("Pop-up blocked! Please allow pop-ups."); } }); }
    function verifyAdMath() { const ans = document.getElementById('mathAns').value; const corr = document.getElementById('mathQ').dataset.ans; if(ans === corr) { document.getElementById('adCaptchaOverlay').style.display = 'none'; addPoints(50); showToast("Reward: +50 Coins Added!"); } else { showToast("Wrong Answer!"); } }
    function claimReferral() { const code = document.getElementById('referralInput').value.toUpperCase().trim(); if(code.length !== 6 || code === userData.refCode) return showToast("Invalid Code"); db.ref('users').orderByChild('refCode').equalTo(code).once('value', s => { if(s.exists()) { db.ref('users/'+auth.currentUser.uid).update({ referredBy: code }); db.ref('users/'+Object.keys(s.val())[0]+'/points').transaction(p => (p||0)+1000); addPoints(500); showToast("Referral Claimed! +500 Coins"); document.getElementById('referralInputSection').style.display='none'; playSound('win'); } else { showToast("Code not found"); } }); }

</script>
</body>
</html>
