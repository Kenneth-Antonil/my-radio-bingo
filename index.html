<!DOCTYPE html>
<html lang="tl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#0f172a">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Radio Bingo Live | Social Ecosystem</title>
    
    <script>
        if (window.location.pathname.endsWith("index.html")) {
            var newPath = window.location.pathname.replace(/index\.html$/, "");
            window.history.replaceState({}, document.title, newPath);
        }
    </script>

    <link rel="icon" type="image/png" href="https://i.imgur.com/7D8u8h6.png">
    <link rel="apple-touch-icon" href="https://i.imgur.com/7D8u8h6.png">
    <link rel="manifest" href="manifest.json">
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;900&family=Comic+Neue:wght@700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-messaging.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

    <script src="https://pl28660488.effectivegatecpm.com/9b/f5/85/9bf585b6ee39cb9b515e2fae1fa958c2.js"></script>
    <script src="https://pl28660496.effectivegatecpm.com/a6/64/bf/a664bf7e7084386b4f4b428590030df3.js"></script>

    <style>
        /* === CORE VARIABLES === */
        :root { 
            --bg-overlay: rgba(15, 23, 42, 0.95); 
            --glass-surface: rgba(30, 41, 59, 0.75);
            --glass-border: rgba(255, 255, 255, 0.08);
            
            --accent: #0ea5e9; /* Ocean Blue */
            --accent-glow: #38bdf8;
            --text: #ffffff; 
            --gold: #fbbf24; 
            --gold-shine: #fcd34d;
            --success: #10b981; 
            --danger: #ef4444; 
            --minigame: #f472b6;
            
            /* Messenger Colors */
            --messenger-blue: #3b82f6;
            --messenger-grey: #334155;
            --messenger-bg: #020617;
        }
        
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; user-select: none; }
        
        body { 
            font-family: 'Inter', sans-serif; 
            background: #0f172a;
            color: var(--text); 
            margin: 0; 
            padding-bottom: calc(90px + env(safe-area-inset-bottom)); 
            overflow-x: hidden; 
            min-height: 100vh;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.5);
        }

        /* === GLOBAL ACTIVE INDICATOR === */
        .avatar-container-global {
            position: relative;
            display: inline-block;
        }
        .online-dot-global {
            position: absolute;
            bottom: 2px;
            right: 2px;
            width: 10px;
            height: 10px;
            background: #22c55e;
            border: 2px solid #0f172a;
            border-radius: 50%;
            z-index: 20;
            display: none; /* Hidden by default, JS toggles it */
            box-shadow: 0 0 5px rgba(34, 197, 94, 0.6);
        }
        .online-dot-global.is-online {
            display: block;
        }

        /* === BADGE ON AVATAR SYSTEM === */
        .avatar-frame {
            position: relative;
            display: inline-block;
            flex-shrink: 0;
            cursor: pointer; /* Global clickable */
        }
        .avatar-frame img {
            display: block;
            border-radius: 50%;
            border: 2px solid rgba(255,255,255,0.1);
            object-fit: cover;
            background: #1e293b;
        }
        .avatar-badge-icon {
            position: absolute;
            bottom: -2px;
            right: -2px;
            width: 40%; 
            height: 40%;
            border-radius: 50%;
            background: #0f172a; 
            border: 2px solid #0f172a;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            z-index: 10;
            box-shadow: 0 2px 5px rgba(0,0,0,0.5);
            font-size: 10px;
        }
        .tier-bronze-bg { background: linear-gradient(135deg, #cd7f32, #a0522d); }
        .tier-silver-bg { background: linear-gradient(135deg, #e0e0e0, #9ca3af); }
        .tier-gold-bg { background: linear-gradient(135deg, #fcd34d, #b45309); border: 1px solid #fcd34d; }
        .tier-platinum-bg { background: linear-gradient(135deg, #e5e4e2, #64748b); border: 1px solid white; }
        .tier-diamond-bg { background: linear-gradient(135deg, #b9f2ff, #06b6d4); box-shadow: 0 0 5px #06b6d4; border: 1px solid #06b6d4; }

        /* === MODERN DISCLAIMER === */
        .disclaimer-modern {
            background: rgba(15, 23, 42, 0.8);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(255,255,255,0.05);
            padding: 8px 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        .disclaimer-badge {
            background: rgba(239, 68, 68, 0.2);
            color: #f87171;
            border: 1px solid rgba(239, 68, 68, 0.3);
            font-size: 9px;
            font-weight: 900;
            padding: 3px 6px;
            border-radius: 6px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .disclaimer-text {
            font-size: 10px;
            color: #cbd5e1;
            font-weight: 500;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        /* === UPDATED FEED SORT TABS === */
        .feed-sort-container {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 15px;
            padding: 0 5px;
        }
        .feed-sort-label {
            font-size: 13px;
            font-weight: 800;
            color: white;
            letter-spacing: 0.5px;
        }
        .feed-tabs-modern {
            display: flex;
            background: rgba(30, 41, 59, 0.5);
            padding: 4px;
            border-radius: 12px;
            border: 1px solid rgba(255,255,255,0.1);
        }
        .feed-tab-btn {
            background: transparent;
            border: none;
            color: #94a3b8;
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 11px;
            font-weight: 700;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: all 0.2s;
        }
        .feed-tab-btn.active {
            background: var(--accent);
            color: white;
            box-shadow: 0 2px 8px rgba(14, 165, 233, 0.3);
        }

        /* === MODERN POST CREATOR === */
        .post-creator-modern {
            background: linear-gradient(145deg, rgba(30, 41, 59, 0.6), rgba(15, 23, 42, 0.8));
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            padding: 18px;
            border-radius: 24px;
            border: 1px solid rgba(255, 255, 255, 0.05);
            margin-bottom: 25px;
            box-shadow: 0 20px 40px -10px rgba(0,0,0,0.3);
            display: flex;
            flex-direction: column;
            gap: 15px;
            transition: transform 0.2s;
        }
        .post-input-modern {
            background: rgba(0,0,0,0.2);
            border: 1px solid rgba(255,255,255,0.05);
            border-radius: 16px;
            padding: 15px;
            color: white;
            font-family: 'Inter', sans-serif;
            font-size: 14px;
            resize: none;
            min-height: 80px;
            outline: none;
            transition: 0.3s;
        }
        .post-input-modern:focus {
            background: rgba(0,0,0,0.4);
            border-color: rgba(255,255,255,0.1);
        }
        
        .mood-selector {
            display: flex;
            gap: 8px;
            overflow-x: auto;
            padding: 5px 2px 10px 2px;
            scrollbar-width: none;
        }
        .mood-selector::-webkit-scrollbar { display: none; }
        
        .mood-chip {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 700;
            color: #94a3b8;
            white-space: nowrap;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }
        .mood-chip.active {
            background: linear-gradient(135deg, var(--accent), #2563eb);
            color: white;
            border-color: rgba(255,255,255,0.2);
            box-shadow: 0 4px 15px rgba(14, 165, 233, 0.4);
            transform: scale(1.05);
        }

        .post-tools {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-top: 1px solid rgba(255,255,255,0.05);
            padding-top: 15px;
        }
        .tool-btn {
            display: flex;
            align-items: center;
            gap: 6px;
            background: rgba(255,255,255,0.03);
            border: 1px solid rgba(255,255,255,0.05);
            padding: 8px 14px;
            border-radius: 30px;
            color: #94a3b8;
            font-size: 11px;
            font-weight: 700;
            cursor: pointer;
            transition: 0.2s;
        }
        .tool-btn:active { transform: scale(0.95); }
        .tool-btn.photo-tool { color: var(--accent-glow); }
        .btn-post-modern {
            background: linear-gradient(135deg, var(--accent), #2563eb);
            color: white;
            border: none;
            padding: 10px 24px;
            border-radius: 30px;
            font-weight: 800;
            font-size: 12px;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(14, 165, 233, 0.3);
            transition: 0.2s;
        }
        
        /* === BINGO CARD SKIN FIX === */
        .card-skin-neon { border: 2px solid #06b6d4 !important; box-shadow: 0 0 20px #06b6d4, inset 0 0 20px rgba(6, 182, 212, 0.2) !important; background: rgba(8, 51, 68, 0.9) !important; }
        .card-skin-neon .cell { border-color: #06b6d4 !important; color: #67e8f9 !important; text-shadow: 0 0 5px #06b6d4 !important; }
        
        .card-skin-gold { border: 2px solid #f59e0b !important; box-shadow: 0 0 25px #f59e0b, inset 0 0 10px #f59e0b !important; background: linear-gradient(135deg, #451a03, #000) !important; }
        .card-skin-gold .cell { border-color: #fbbf24 !important; color: #fcd34d !important; font-family: 'Times New Roman', serif; }
        
        .card-skin-pink { border: 2px solid #ec4899 !important; box-shadow: 0 0 20px #ec4899 !important; background: rgba(80, 7, 36, 0.9) !important; }
        .card-skin-pink .cell { border-color: #f472b6 !important; color: #fbcfe8 !important; border-radius: 50% !important; }
        
        .card-skin-matrix { border: 2px solid #22c55e !important; box-shadow: 0 0 15px #22c55e !important; background: black !important; font-family: 'Courier New', monospace; }
        .card-skin-matrix .cell { border-color: #22c55e !important; color: #4ade80 !important; border-radius: 0 !important; }

        .card-skin-custom { background-size: cover !important; background-position: center !important; border: 2px solid rgba(255,255,255,0.5) !important; box-shadow: 0 0 30px rgba(0,0,0,0.8) !important; }
        /* Ensure cells are readable on custom skins */
        .card-skin-custom .cell { background: rgba(0,0,0,0.6) !important; backdrop-filter: blur(4px); color: white !important; border: 1px solid rgba(255,255,255,0.3) !important; }

        /* CHARACTER THEMES - IMPORTANT: Fix Z-Index */
        .card-skin-kitty { border: 4px solid #ffc0cb !important; background: radial-gradient(circle, #fff0f5, #ff69b4) !important; box-shadow: 0 0 20px #ff69b4 !important; font-family: 'Comic Neue', cursive; }
        .card-skin-kitty .cell { background: white !important; color: #ff1493 !important; border: 2px solid #ffc0cb !important; border-radius: 15px !important; opacity: 1 !important; z-index: 5; }

        .card-skin-doraemon { border: 4px solid #0096df !important; background: linear-gradient(180deg, #0096df 0%, #ffffff 100%) !important; box-shadow: 0 0 20px #dd1616 !important; }
        .card-skin-doraemon .cell { background: rgba(255,255,255,0.9) !important; color: #0096df !important; border: 2px solid #dd1616 !important; border-radius: 50% !important; z-index: 5; }

        .card-skin-spongebob { border: 4px solid #f7f44d !important; background: #f7f44d !important; box-shadow: 0 0 20px #f7f44d !important; }
        .card-skin-spongebob .cell { background: rgba(255,255,255,0.8) !important; color: #7d5837 !important; border: 2px dashed #7d5837 !important; z-index: 5; }
        
        .card-skin-kuromi { border: 4px solid #000000 !important; background: linear-gradient(135deg, #000000, #4b0082) !important; box-shadow: 0 0 20px #ea65a2 !important; }
        .card-skin-kuromi .cell { background: rgba(234, 101, 162, 0.2) !important; color: #ea65a2 !important; border: 1px solid #ea65a2 !important; border-radius: 8px 0 8px 0 !important; z-index: 5; }

        .grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 4px; position: relative; }
        .cell { 
            aspect-ratio: 1; 
            background: rgba(255,255,255,0.1); 
            border-radius: 12px; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            font-weight: 800; 
            font-size: 16px; 
            border: 1px solid rgba(255,255,255,0.15); 
            transition: all 0.3s; 
            z-index: 2; /* Increased Base Z-Index */
            position: relative; 
            overflow: hidden; 
            box-shadow: inset 0 2px 5px rgba(255,255,255,0.05); 
            color: white; 
            text-shadow: 0 2px 3px black; 
        }
        /* HIT STATE - Highest Priority Visibility */
        .cell.hit { 
            background: linear-gradient(135deg, var(--accent), #2563eb) !important; 
            color: white !important; 
            transform: scale(1.05); 
            border-color: rgba(255,255,255,0.6) !important; 
            box-shadow: 0 5px 15px rgba(59, 130, 246, 0.6) !important; 
            text-shadow: 0 2px 2px rgba(0,0,0,0.5) !important; 
            opacity: 1 !important;
            z-index: 10 !important; /* Ensure Hits are always on top of skins */
        }
        
        /* ... (Store Nav, Task List styles maintained) ... */
        .store-nav { display: flex; gap: 8px; margin-bottom: 15px; background: rgba(0,0,0,0.3); padding: 5px; border-radius: 12px; }
        .store-tab-btn { flex: 1; padding: 10px; border: none; background: transparent; color: #94a3b8; font-weight: 800; border-radius: 8px; cursor: pointer; font-size: 11px; text-transform: uppercase; }
        .store-tab-btn.active { background: var(--accent); color: white; box-shadow: 0 4px 10px rgba(14, 165, 233, 0.3); }
        .skins-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
        .skin-item { background: rgba(255,255,255,0.05); padding: 10px; border-radius: 16px; border: 1px solid rgba(255,255,255,0.1); text-align: center; position: relative; overflow: hidden; }
        .skin-preview { height: 60px; border-radius: 8px; margin-bottom: 8px; display: flex; align-items: center; justify-content: center; font-size: 20px; font-weight: 900; background-size: cover; background-position: center; }
        .skin-name { font-size: 12px; font-weight: 800; color: white; margin-bottom: 4px; }
        .skin-cost { font-size: 10px; color: var(--gold); margin-bottom: 8px; font-weight: 700; }
        .btn-buy-skin { width: 100%; padding: 8px; border: none; border-radius: 8px; font-weight: 800; font-size: 10px; cursor: pointer; }
        .btn-buy-skin.owned { background: rgba(255,255,255,0.1); color: #cbd5e1; cursor: default; }
        .btn-buy-skin.buy { background: var(--gold); color: black; }
        .btn-buy-skin.equip { background: var(--success); color: white; }

        /* === PROFILE PAGE REDESIGN === */
        .profile-page-container { position: fixed; inset: 0; background: #020617; z-index: 6000; display: none; flex-direction: column; overflow-y: auto; padding-bottom: calc(80px + env(safe-area-inset-bottom)); }
        
        .profile-cover {
            height: 35vh;
            min-height: 250px;
            max-height: 350px;
            width: 100%;
            position: relative;
            background-color: #334155;
            overflow: hidden;
        }
        /* New cover approach: Blur background + Contain image */
        .profile-cover-bg {
            position: absolute; inset: 0; background-size: cover; background-position: center; filter: blur(20px); opacity: 0.5;
        }
        .profile-cover-img {
            position: absolute; inset: 0; width: 100%; height: 100%; object-fit: contain; z-index: 1;
        }
        .profile-cover-overlay {
            position: absolute; inset: 0; background: linear-gradient(to bottom, transparent 60%, #020617 100%); z-index: 2;
        }

        .profile-nav-back {
            position: absolute; top: 15px; left: 15px; z-index: 20;
            width: 40px; height: 40px; border-radius: 50%; background: rgba(0,0,0,0.4);
            backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.1);
            color: white; display: flex; align-items: center; justify-content: center; cursor: pointer;
            transition: transform 0.2s;
        }
        
        .profile-info-section {
            padding: 0 20px;
            margin-top: -50px; 
            position: relative;
            z-index: 10;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        .profile-page-name { font-size: 28px; font-weight: 900; color: white; margin: 10px 0 5px 0; letter-spacing: -0.5px; display:flex; align-items:center; gap:8px; justify-content: center; text-shadow: 0 5px 15px rgba(0,0,0,0.5); text-align: center; }
        .profile-page-bio { font-size: 14px; color: #94a3b8; margin: 0 0 20px 0; text-align: center; max-width: 90%; line-height: 1.5; }
        
        /* ... (Nav, Footer, etc maintained from previous but cleaner) ... */
        .nav { background: rgba(15, 23, 42, 0.95); backdrop-filter: blur(15px); padding: 10px 15px; display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 100; border-bottom: 1px solid rgba(255,255,255,0.1); height: auto; min-height: 60px; }
        .user-stats { display: flex; align-items: center; gap: 8px; }
        .icon-btn { background: rgba(255,255,255,0.1); color: white; border: 1px solid rgba(255,255,255,0.15); width: 38px; height: 38px; border-radius: 12px; cursor: pointer; position: relative; display: flex; align-items: center; justify-content: center; transition: 0.2s; }
        .notif-badge { position: absolute; top: 6px; right: 6px; background: var(--danger); width: 8px; height: 8px; border-radius: 50%; display: none; z-index: 10; box-shadow: 0 0 10px var(--danger); }
        
        /* Bottom Nav */
        .bottom-nav { position: fixed; bottom: 0; left: 0; right: 0; background: rgba(15, 23, 42, 0.95); backdrop-filter: blur(15px); border-top: 1px solid rgba(255,255,255,0.1); height: calc(65px + env(safe-area-inset-bottom)); display: flex; justify-content: space-around; align-items: flex-start; z-index: 5000; padding-top: 10px; padding-bottom: env(safe-area-inset-bottom); }
        .nav-item { display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 4px; color: #94a3b8; width: 20%; height: 50px; border: none; background: none; cursor: pointer; transition: 0.2s; }
        .nav-item.active { color: var(--accent-glow); }
        .nav-center .nav-icon-bg { background: linear-gradient(135deg, var(--accent), #2563eb); width: 50px; height: 50px; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; box-shadow: 0 8px 20px rgba(14, 165, 233, 0.5); border: 4px solid #0f172a; }

        /* Social Post Updates */
        .post-card { background: #1e293b; border-radius: 16px; border: 1px solid rgba(255,255,255,0.05); overflow: hidden; margin-bottom: 15px; }
        .post-header { padding: 12px; display: flex; align-items: center; gap: 10px; border-bottom: 1px solid rgba(255,255,255,0.05); }
        .post-avatar { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; border: 1px solid rgba(255,255,255,0.2); cursor: pointer; }
        .post-meta { flex: 1; }
        .post-author { font-size: 14px; font-weight: 800; color: white; display: flex; align-items: center; gap: 5px; cursor: pointer; }
        
        /* Comment Preview in Feed */
        .comment-preview-section {
            background: rgba(0,0,0,0.2);
            padding: 10px 15px;
            font-size: 12px;
            color: #cbd5e1;
            border-top: 1px solid rgba(255,255,255,0.05);
            display: flex;
            gap: 8px;
            align-items: center;
        }
        .cmt-prev-user { font-weight: 800; color: white; }
        
        /* Reactions Display */
        .reaction-display-bar {
            padding: 5px 15px;
            font-size: 11px;
            color: #94a3b8;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .react-avatars { display: flex; margin-right: 5px; }
        .react-avatar-sm { width: 16px; height: 16px; border-radius: 50%; border: 1px solid #1e293b; margin-left: -5px; }
        .react-avatar-sm:first-child { margin-left: 0; }

        /* Shared Post Style */
        .shared-post-container {
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 12px;
            margin: 10px 15px;
            background: rgba(255,255,255,0.02);
            overflow: hidden;
        }
        .shared-header {
            padding: 8px 12px;
            background: rgba(255,255,255,0.05);
            font-size: 11px;
            font-weight: 700;
            color: #cbd5e1;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        /* Notif Delete Button */
        .notif-card-grouped { position: relative; }
        .btn-notif-del {
            position: absolute; top: 5px; right: 5px;
            background: transparent; border: none; color: #64748b;
            cursor: pointer; padding: 5px;
        }
        .btn-notif-del:hover { color: var(--danger); }
        
        /* Modal Adjustments */
        .modal-content { max-height: 90vh; overflow-y: auto; }
        
        /* Task & Store */
        .task-item { background: linear-gradient(135deg, rgba(30,41,59,0.9), rgba(15,23,42,0.95)); padding: 15px; border-radius: 16px; border: 1px solid rgba(255,255,255,0.1); display: flex; justify-content: space-between; align-items: center; position: relative; overflow: hidden; margin-bottom: 10px; }
        
        /* ... Other existing styles ... */
        .container { width: 100%; max-width: 500px; margin: 0 auto; padding: 10px; padding-bottom: 120px; }
    </style>
</head>
<body>

<div class="bottom-nav">
    <button class="nav-item active" onclick="switchTab('home')" id="nav-home">
        <i data-lucide="home" class="nav-icon"></i>
        <span class="nav-label">Home</span>
    </button>
    <button class="nav-item" onclick="switchTab('bingo')" id="nav-bingo">
        <i data-lucide="play-circle" class="nav-icon"></i>
        <span class="nav-label">Bingo</span>
    </button>
    <div class="nav-center" onclick="openPostCreator()">
        <div class="nav-icon-bg"><i data-lucide="plus" style="width:28px; height:28px;"></i></div>
    </div>
    <button class="nav-item" onclick="document.getElementById('storeModal').style.display='flex'" id="nav-store">
        <i data-lucide="shopping-bag" class="nav-icon"></i>
        <span class="nav-label">Store</span>
    </button>
    <button class="nav-item" onclick="openMyProfile()" id="nav-profile">
        <div class="avatar-container-global">
            <i data-lucide="user" class="nav-icon"></i>
            <div id="nav-profile-dot" class="online-dot-global"></div>
        </div>
        <span class="nav-label">Me</span>
    </button>
</div>

<div class="sticky-ad-footer">
    <script type="text/javascript">
        atOptions = { 'key' : 'a664bf7e7084386b4f4b428590030df3', 'format' : 'iframe', 'height' : 50, 'width' : 320, 'params' : {} };
    </script>
    <script type="text/javascript" src="https://pl28660496.effectivegatecpm.com/a6/64/bf/a664bf7e7084386b4f4b428590030df3.js"></script>
</div>

<div id="customPopupBanner">
    <div style="position:relative; max-width:400px; width:100%; animation: popScale 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);">
        <button onclick="closeCustomBanner()" style="position:absolute; top:-15px; right:-10px; background:linear-gradient(135deg, #ef4444, #b91c1c); color:white; border:2px solid white; border-radius:50%; width:36px; height:36px; font-weight:bold; cursor:pointer; z-index:10; display:flex; align-items:center; justify-content:center; box-shadow:0 4px 10px rgba(0,0,0,0.3);"><i data-lucide="x" style="width:20px"></i></button>
        <img id="customBannerImg" src="" style="width:100%; border-radius:20px; border:2px solid rgba(255,255,255,0.2); box-shadow:0 20px 50px rgba(0,0,0,0.8); cursor:pointer; object-fit:cover;" onclick="clickCustomBanner()">
    </div>
</div>

<div id="installGate">
    <div class="gate-logo">RB<span>LIVE</span></div>
    <div class="gate-title">Install to Play</div>
    <p class="gate-desc">To access the full Radio Bingo experience, you must install the official App.</p>
    <button id="gateInstallBtn" class="gate-btn-install" onclick="triggerInstall()">
        <i data-lucide="download-cloud" style="width:20px; height:20px;"></i> INSTALL APP
    </button>
    <div id="gateIosNote" class="gate-ios-note">
        <div style="font-weight:800; color:white; margin-bottom:10px; text-transform:uppercase;">iOS Instructions:</div>
        <div class="ios-step"><i data-lucide="share" class="ios-icon" style="width:16px;"></i> 1. Tap the Share button below.</div>
        <div class="ios-step"><i data-lucide="plus-square" class="ios-icon" style="width:16px;"></i> 2. Scroll down & tap 'Add to Home Screen'.</div>
        <div class="ios-step"><i data-lucide="check" class="ios-icon" style="width:16px;"></i> 3. Launch App from Home Screen.</div>
    </div>
</div>

<div id="notifBlocker">
    <div class="notif-gate-icon">
        <i data-lucide="bell-ring" style="width: 40px; height: 40px; color: #3b82f6;"></i>
    </div>
    <div class="notif-gate-title">ENABLE NOTIFICATIONS</div>
    <p class="notif-gate-desc">To ensure fairness and real-time updates for Bingo Calls, this app requires push notifications to be enabled.</p>
    <button onclick="requestGatePermission()" class="btn-allow-notif">
        <i data-lucide="check-circle" style="width:20px"></i> ALLOW NOTIFICATIONS
    </button>
    <div id="blockedHelp" class="blocked-help">
        <strong style="color:var(--danger); display:block; margin-bottom:5px;">‚ö†Ô∏è NOTIFICATIONS ARE BLOCKED!</strong>
        1. Click the <b>Lock Icon üîí</b> or <b>Settings Icon</b> beside the URL bar.<br>
        2. Click <b>Permissions</b> or <b>Site Settings</b>.<br>
        3. Find <b>Notifications</b> and set to <b>Allow</b>.<br>
        4. Reload this page.
    </div>
</div>

<div id="splash-screen">
    <div class="splash-logo">RB<span>LIVE</span></div>
    <div class="splash-loader"></div>
</div>

<div id="customToast">
    <i data-lucide="info" class="toast-icon"></i>
    <span class="toast-msg" id="toastMsg">Notification!</span>
</div>

<div id="customConfirmModal">
    <div class="conf-content">
        <i data-lucide="alert-circle" style="width: 40px; height: 40px; color: var(--gold); margin-bottom: 15px;"></i>
        <h3 class="conf-title" id="confTitle">Confirm Action</h3>
        <p class="conf-msg" id="confMsg">Are you sure you want to proceed?</p>
        <div class="conf-actions">
            <button class="btn-conf-no" onclick="closeCustomConfirm()">CANCEL</button>
            <button class="btn-conf-yes" id="confYesBtn">CONFIRM</button>
        </div>
    </div>
</div>

<div id="loginOverlay">
    <div class="login-bg-blob blob-1"></div>
    <div class="login-bg-blob blob-2"></div>
    <div class="login-app-container">
        <div class="app-logo-lg">RB<span>LIVE</span></div>
        <p class="app-tagline">The ultimate live bingo experience.<br>Play, Win, and Redeem Rewards.</p>
        <div class="promo-badge">
            <i data-lucide="gift" style="width:16px"></i> 
            <span>Register now & Get 500 Free RB Coins</span>
        </div>
        <div class="auth-btn-group">
            <button class="btn-main-auth" onclick="login()">
                <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/action/google.svg" alt="Google" style="width:20px">
                Sign in with Google
            </button>
        </div>
    </div>
    <div class="login-footer-legal">
        <div class="legal-text">
            <span>‚ö†Ô∏è DISCLAIMER: NOT A GAMBLING SITE</span>
            <span style="opacity: 0.6; font-size: 9px;">For entertainment purposes only. No real money betting.</span>
            <div style="margin-top: 5px; opacity: 0.8; font-size: 10px;">
                <a href="terms.html" style="color:#cbd5e1; text-decoration:none; margin:0 5px;">Terms</a> |
                <a href="privacy.html" style="color:#cbd5e1; text-decoration:none; margin:0 5px;">Privacy</a>
            </div>
        </div>
    </div>
</div>

<div class="nav">
    <div style="display:flex; align-items:center; gap:10px;">
        <span style="font-weight: 900; font-size: 20px; text-shadow: 0 2px 5px rgba(0,0,0,0.8);">RB <span style="color:var(--accent-glow)">LIVE</span></span>
    </div>
    <div id="userPanel" style="display:none; align-items: center; gap: 10px;">
        <div class="user-stats">
            <div class="icon-btn" onclick="openSearch()">
                <i data-lucide="search" style="width:20px"></i>
            </div>
            <div class="icon-btn" onclick="openMessenger()">
                <i data-lucide="message-circle" style="width:20px"></i>
                <span id="pmBadge" class="notif-badge"></span>
            </div>
            <div class="icon-btn" onclick="openNotifs()">
                <i data-lucide="bell" style="width:20px"></i>
                <span id="notifDot" class="notif-badge"></span>
            </div>
            </div>
        <div id="userImgContainer" onclick="openMenuModal()"></div>
    </div>
</div>

<div class="disclaimer-modern">
    <div class="disclaimer-badge">NOTICE</div>
    <div class="disclaimer-text">Hindi ito gambling site. For entertainment purposes lamang.</div>
</div>

<div class="container">
    <div class="ad-container-global">
        <script type="text/javascript">
            atOptions = { 'key' : '9bf585b6ee39cb9b515e2fae1fa958c2', 'format' : 'iframe', 'height' : 50, 'width' : 320, 'params' : {} };
        </script>
        <script type="text/javascript" src="https://pl28660488.effectivegatecpm.com/9b/f5/85/9bf585b6ee39cb9b515e2fae1fa958c2.js"></script>
    </div>

    <div id="view-home" style="display:block;">
        <div id="friendRequestsSection"></div>
        
        <div class="post-creator-modern" id="mainPostCreator">
            <h4 style="margin:0; color:white; font-size:16px; font-weight:800; display:flex; align-items:center; gap:8px;">
                <i data-lucide="edit-3" style="width:16px; color:var(--accent-glow);"></i> Create Post
            </h4>
            
            <textarea id="postInput" class="post-input-modern" placeholder="What's on your mind?"></textarea>
            
            <div class="image-preview-container" id="imgPreviewCont">
                <img id="postImgPreview" class="image-preview-img">
                <div class="btn-remove-img" onclick="removePostImage()"><i data-lucide="x" style="width:12px;"></i></div>
            </div>

            <div class="mood-selector">
                <div class="mood-chip" onclick="selectMood(this, 'Happy')">üòä Happy</div>
                <div class="mood-chip" onclick="selectMood(this, 'Sad')">üòî Sad</div>
                <div class="mood-chip" onclick="selectMood(this, 'Excited')">ü§© Excited</div>
                <div class="mood-chip" onclick="selectMood(this, 'Cool')">üòé Cool</div>
                <div class="mood-chip" onclick="selectMood(this, 'Angry')">üò° Angry</div>
                <div class="mood-chip" onclick="selectMood(this, 'Lucky')">üçÄ Lucky</div>
            </div>

            <div class="post-tools">
                <label for="postImgInput" class="tool-btn photo-tool">
                    <i data-lucide="image" style="width:16px;"></i> Photo
                </label>
                <input type="file" id="postImgInput" accept="image/*" style="display:none" onchange="handlePostImage(this)">
                
                <button class="btn-post-modern" onclick="createPost()">POST</button>
            </div>
        </div>

        <div id="pymkSection" class="pymk-section" style="display:none;">
            <div class="pymk-title">People You May Know</div>
            <div class="pymk-scroll" id="pymkList"></div>
        </div>

        <div class="feed-sort-container">
            <div class="feed-sort-label">TIMELINE</div>
            <div class="feed-tabs-modern">
                <button class="feed-tab-btn active" id="sort-hype" onclick="toggleFeedSort('hype')">
                    <i data-lucide="flame" style="width:14px"></i> HOT
                </button>
                <button class="feed-tab-btn" id="sort-new" onclick="toggleFeedSort('new')">
                    <i data-lucide="clock" style="width:14px"></i> NEW
                </button>
            </div>
        </div>

        <div id="socialFeed" class="social-feed-container">
            <div style="text-align:center; padding:20px; opacity:0.5;">Loading Feed...</div>
        </div>
    </div>

    <div id="view-bingo" style="display:none;">
        <div class="video-feed-wrapper">
            <div class="video-container">
                <div class="video-overlay-bl"><i data-lucide="users" style="width:14px"></i><span id="onlineCount">0</span> ONLINE</div>
                <div id="videoOfflineState" style="display:none; position:absolute; inset:0; background:#0f172a; flex-direction:column; align-items:center; justify-content:center; z-index:20;">
                    <div style="width:60px; height:60px; background:rgba(255,255,255,0.05); border-radius:50%; display:flex; align-items:center; justify-content:center; margin-bottom:15px; animation:pulse-ring 2s infinite;">
                        <i data-lucide="radio" style="width:30px; height:30px; color:#94a3b8;"></i>
                    </div>
                    <h3 style="margin:0; font-size:16px; font-weight:900; color:white; letter-spacing:1px;">WAITING FOR LIVE</h3>
                    <p style="margin:5px 0 0; font-size:12px; color:#64748b;">Stand by for the next draw.</p>
                </div>
                <iframe id="liveVideoFrame" width="100%" height="100%" src="https://www.youtube.com/embed/4I_NSJTbdXo?autoplay=1&mute=1" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" referrerpolicy="strict-origin-when-cross-origin" allowfullscreen style="border:none; position:absolute; top:0; left:0; width:100%; height:100%;"></iframe>
            </div>
        </div>

        <div id="jackpotBanner">
            <div class="jp-label-new">
                <i data-lucide="crown" style="width: 16px;"></i> JACKPOT ROUND <i data-lucide="crown" style="width: 16px;"></i>
            </div>
            <span class="jackpot-amount" id="jackpotDisplayVal">5,000</span>
            <div style="font-size: 10px; opacity: 0.7; margin-top: 5px; color: #fbbf24;">RB COINS GRAND PRIZE</div>
        </div>

        <div id="nextDrawBanner" class="next-draw-container">
            <div class="nd-icon"><i data-lucide="calendar-days"></i></div>
            <div class="nd-info">
                <div class="next-draw-label">Susunod na Bola</div>
                <div id="nextDrawTime" class="next-draw-time">--:-- --</div>
            </div>
        </div>
        
        <div id="winnerBanner">
            <span><i data-lucide="party-popper" style="width:24px; height:24px;"></i> BINGO WINNER!</span>
            <span class="winner-line" id="winnerPatternLine">Pattern: Normal Bingo</span>
        </div>

        <div class="draw-panel">
            <div class="prev-balls" id="ballRow"></div>
            <div class="current-ball-box"><span style="font-size:9px; font-weight:800; opacity:0.8; color:white;">NOW DRAWN</span><span id="currentBall" style="font-size:36px; font-weight:900; color:white; text-shadow:0 2px 10px rgba(0,0,0,0.5);">--</span></div>
        </div>
        
        <div class="card" id="bingoCardContainer">
            <div id="lateOverlay" class="late-overlay">
                <i data-lucide="lock" style="color:var(--danger); width:48px; height:48px; margin-bottom:15px; filter: drop-shadow(0 0 10px var(--danger));"></i>
                <div class="late-text">GAME ONGOING</div>
                <div class="late-subtext">Sorry, ongoing na ang bola. Bawal na sumali ang late.</div>
                <div style="margin-top:20px; background:rgba(255,255,255,0.1); padding:10px 20px; border-radius:12px; border:1px solid rgba(255,255,255,0.1);">
                    <span style="font-size:10px; display:block; opacity:0.7;">NEXT GAME:</span>
                    <strong id="lateNextSched" style="font-size:16px; color:var(--gold);">--:--</strong>
                </div>
            </div>
            <div id="gameOverOverlay" class="game-over-overlay">
                <i data-lucide="trophy" style="color:var(--gold); width:50px; height:50px; margin-bottom:15px; filter: drop-shadow(0 0 15px var(--gold));"></i>
                <div class="late-text">Game Finished</div>
                <div class="late-subtext" id="gameOverMsg">Better luck next time!</div>
            </div>
            <div class="change-card-wrapper" style="display:flex; justify-content:space-between; align-items:center; padding-bottom:15px;">
                <div class="pattern-box">
                    <div class="pattern-dot"></div>
                    <span class="pattern-text" id="patternName">Normal Bingo</span>
                </div>
                <button class="btn-change" id="newCardBtn" onclick="generateNewCard()"><i data-lucide="refresh-cw" style="width:14px"></i> NEW CARD</button>
            </div>
            <div class="bingo-header"><div class="letter">B</div><div class="letter">I</div><div class="letter">N</div><div class="letter">G</div><div class="letter">O</div></div>
            <div class="grid" id="bingoGrid"></div>
        </div>
        
        <div class="chat-box" style="margin-top:15px;">
            <div class="chat-header">
                <i data-lucide="message-square" style="width:18px; color:var(--accent-glow)"></i>
                <h3>LIVE STREAM CHAT</h3>
            </div>
            <div id="chatList"></div>
            <div id="replyIndicator" class="reply-indicator" style="display:none; padding: 5px 15px; background: #374151; color: #d1d5db; font-size: 11px;">
                <span id="replyText">Replying to...</span>
                <button onclick="cancelReply()" style="background:none; border:none; color:white; cursor:pointer;"><i data-lucide="x" style="width:14px"></i></button>
            </div>
            <div class="chat-input-area">
                <form class="input-wrapper" onsubmit="event.preventDefault(); sendChat();">
                    <input type="text" id="chatIn" placeholder="Say something..." autocomplete="off">
                    <button type="submit" class="send-btn">
                        <i data-lucide="send" style="width:16px"></i>
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>
<div id="grandJackpotModal" onclick="this.style.display='none'">
    <div class="jackpot-rays"></div>
    <div class="jackpot-content">
        <div class="icon-glow"><i data-lucide="crown" style="width: 80px; height: 80px;"></i></div>
        <h1 class="jp-title">JACKPOT WIN!</h1>
        <h2 class="jp-amount" id="grandPrizeAmount">10,000 RB COINS</h2>
        <div class="jp-name" id="jpWinnerName">WINNER NAME</div>
        <p style="font-size: 11px; color: white; opacity: 0.7; margin-top: 20px;">Tap anywhere to close</p>
    </div>
</div>

<div id="pmModal" class="pm-modal">
    <div class="pm-container">
        <div id="pmInboxView" style="display:flex; flex-direction:column; height:100%;">
            <div class="pm-header">
                <div style="display:flex; align-items:center; gap:10px;">
                    <h3>Chats</h3>
                </div>
                <div style="display:flex; gap:10px;">
                    <button class="group-create-btn" onclick="startCreateGroup()"><i data-lucide="users" style="width:14px"></i> + Group</button>
                    <button onclick="document.getElementById('pmModal').style.display='none'" style="background:rgba(255,255,255,0.1); border:none; width:30px; height:30px; border-radius:50%; color:white; display:flex; align-items:center; justify-content:center;"><i data-lucide="x" style="width:16px;"></i></button>
                </div>
            </div>
            <div class="active-friends-bar" id="activeFriendsBar"></div>
            <div id="pmList" class="pm-inbox-list"></div>
        </div>
        
        <div id="pmChatView" class="pm-chat-view">
            <div class="pm-chat-header">
                <button onclick="backToInbox()" style="background:none; border:none; color:var(--messenger-blue);"><i data-lucide="arrow-left"></i></button>
                <div style="display:flex; align-items:center;">
                     <div id="chatTargetAvatarCont" style="width:36px; height:36px; margin-left:5px;"></div>
                     <div style="display:flex; flex-direction:column; margin-left:10px;">
                        <span id="chatTargetName" style="font-weight:700; font-size:15px; color:white;">User</span>
                        <span id="chatTargetStatus" style="font-size:11px; color:#b0b3b8;">Active now</span>
                     </div>
                </div>
            </div>
            <div id="pmMessages" class="pm-messages"></div>
            
            <div class="pm-footer-modern">
                <label for="pmImgInput" class="pm-attach-btn">
                    <i data-lucide="image" style="width:24px;"></i>
                </label>
                <input type="file" id="pmImgInput" accept="image/*" style="display:none" onchange="handlePmImage(this)">
                
                <form onsubmit="event.preventDefault(); sendPrivateMessage();" style="flex:1; display:flex; gap:10px;">
                    <input type="text" id="pmInput" class="pm-styled-input" placeholder="Type a message..." autocomplete="off">
                    <button type="submit" style="background:none; border:none; color:var(--messenger-blue); cursor:pointer;"><i data-lucide="send" style="width:24px"></i></button>
                </form>
            </div>
            <div id="pmImgPreviewCont" style="padding:10px; background:#0f172a; display:none;">
                <span style="font-size:10px; color:var(--accent-glow);">Image attached</span>
            </div>
        </div>

        <div id="pmCreateGroupView" style="display:none; flex-direction:column; height:100%; background:#000;">
            <div class="pm-header">
                <button onclick="cancelCreateGroup()" style="background:none; border:none; color:white;"><i data-lucide="arrow-left"></i></button>
                <h3>New Group</h3>
                <button onclick="finalizeCreateGroup()" style="color:var(--accent); background:none; border:none; font-weight:800;">CREATE</button>
            </div>
            <div style="padding:20px;">
                <input type="text" id="newGroupName" class="styled-input" placeholder="Group Name">
                <h4 style="color:#94a3b8; margin-top:20px; font-size:12px; text-transform:uppercase;">Select Friends</h4>
                <div id="friendSelectContainer" style="margin-top:10px;"></div>
            </div>
        </div>
    </div>
</div>

<div id="notifModal" class="modal" onclick="this.style.display='none'">
    <div class="modal-content" onclick="event.stopPropagation()">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px; border-bottom:1px solid rgba(255,255,255,0.1); padding-bottom:15px;">
            <div style="display:flex; align-items:center; gap:10px;">
                <div style="background:rgba(255,255,255,0.1); padding:8px; border-radius:10px;"><i data-lucide="bell" style="width:20px;"></i></div>
                <h3 style="margin:0; font-size:18px;">Notifications</h3>
            </div>
            <button onclick="document.getElementById('notifModal').style.display='none'" style="background:none; border:none; color:white;"><i data-lucide="x"></i></button>
        </div>
        <div id="notifList"></div>
    </div>
</div>

<div id="userOptionsModal" class="modal" onclick="this.style.display='none'">
    <div class="modal-content" onclick="event.stopPropagation()" style="text-align:center;">
        <div id="optUserAvatarCont" style="display:flex; justify-content:center; margin-bottom:10px;"></div>
        <h3 id="optUserName" style="margin:0 0 20px 0; color:white;">User</h3>
        
        <button class="user-opt-btn" onclick="openUserProfile(targetUserForOpt.uid)"><i data-lucide="user"></i> View Profile</button>
        <button class="user-opt-btn" onclick="optAddFriend()"><i data-lucide="user-plus"></i> Add Friend</button>
        <button class="user-opt-btn" onclick="optSendMessage()"><i data-lucide="message-circle"></i> Send Message</button>
        <button class="user-opt-btn" onclick="document.getElementById('userOptionsModal').style.display='none'"><i data-lucide="x"></i> Close</button>
    </div>
</div>

<div id="shareOptionsModal" class="modal" onclick="this.style.display='none'">
    <div class="modal-content" onclick="event.stopPropagation()" style="text-align:center;">
        <h3 style="margin:0 0 20px 0; color:white;">Share Post</h3>
        <button class="user-opt-btn" onclick="sharePostInternal()"><i data-lucide="repeat"></i> Repost on Timeline</button>
        <button class="user-opt-btn" onclick="copyPostLink()"><i data-lucide="link"></i> Copy Link</button>
        <button class="user-opt-btn" onclick="document.getElementById('shareOptionsModal').style.display='none'"><i data-lucide="x"></i> Cancel</button>
    </div>
</div>

<div id="commentModalBackdrop" class="comment-modal-backdrop" onclick="closeComments()"></div>
<div id="commentModal" class="comment-modal">
    <div class="comment-header">
        <h3 style="margin:0; font-size:16px;">Comments</h3>
        <button onclick="closeComments()" style="background:none; border:none; color:white;"><i data-lucide="x"></i></button>
    </div>
    <div id="commentList" class="comment-list"></div>
    <form class="comment-input-area" onsubmit="event.preventDefault(); sendComment();">
        <input type="text" id="commentInput" class="comment-input" placeholder="Write a comment..." autocomplete="off">
        <button type="submit" style="background:none; border:none; color:var(--accent);"><i data-lucide="send"></i></button>
    </form>
</div>

<div id="searchModal" class="search-modal-container">
    <div class="search-header">
        <button onclick="document.getElementById('searchModal').style.display='none'" style="background:none; border:none; color:white;"><i data-lucide="arrow-left"></i></button>
        <div class="search-bar-wrap">
            <i data-lucide="search" style="width:16px; opacity:0.5;"></i>
            <input type="text" id="searchInput" class="search-input" placeholder="Search users or posts..." onkeyup="handleSearch()">
        </div>
    </div>
    <div id="searchResults" class="search-results">
        <div style="text-align:center; opacity:0.5; padding:20px;">Type to search...</div>
    </div>
</div>

<div id="userProfilePage" class="profile-page-container">
    <button class="profile-nav-back" onclick="closeProfilePage()">
        <i data-lucide="arrow-left"></i>
    </button>
    
    <div class="profile-cover">
        <div class="profile-cover-bg" id="pageProfileCoverBg"></div>
        <img class="profile-cover-img" id="pageProfileCoverImg">
        <div class="profile-cover-overlay"></div>
    </div>
    
    <div class="profile-info-section">
        <div class="profile-avatar-container" id="pageProfileAvatarContainer">
             </div>
        
        <h2 id="pageProfileName" class="profile-page-name">User Name</h2>
        <p id="pageProfileBio" class="profile-page-bio">Radio Bingo Player</p>
        
        <button id="profileMainActionBtn" class="profile-action-btn" onclick="handleProfileMainAction()">Add Friend</button>
        
        <button id="unfriendBtn" class="btn-unfriend-modern" style="display:none;" onclick="unfriendUser()">
            <i data-lucide="user-x" style="width:16px"></i> Unfriend
        </button>
        
        <div class="profile-stats-card">
            <div class="stat-item">
                <span class="stat-val" id="statFriends">0</span>
                <span class="stat-lbl"><i data-lucide="users" style="width:12px; vertical-align:middle;"></i> Friends</span>
            </div>
            <div class="stat-item">
                <span class="stat-val" id="statLikes">0</span>
                <span class="stat-lbl"><i data-lucide="heart" style="width:12px; vertical-align:middle;"></i> Likes</span>
            </div>
             <div class="stat-item">
                <span class="stat-val" id="statPosts">0</span>
                <span class="stat-lbl"><i data-lucide="image" style="width:12px; vertical-align:middle;"></i> Posts</span>
            </div>
        </div>
        
        <div id="pageProfileFeed" class="profile-feed-section"></div>
    </div>
</div>

<div id="editProfileModal" class="modal" onclick="this.style.display='none'">
    <div class="modal-content" onclick="event.stopPropagation()">
        <h3 style="margin-top:0; color:white;">Edit Profile</h3>
        
        <label class="edit-label">Display Name</label>
        <input type="text" id="editNameIn" class="edit-input" placeholder="Your Name">
        
        <label class="edit-label">Bio</label>
        <input type="text" id="editBioIn" class="edit-input" placeholder="Short bio...">
        
        <label class="edit-label">Change Profile Picture</label>
        <input type="file" id="editProfilePicInput" class="edit-input" accept="image/*" onchange="handleProfileUpload(this, 'pfp')">
        
        <label class="edit-label">Change Cover Photo</label>
        <input type="file" id="editCoverPicInput" class="edit-input" accept="image/*" onchange="handleProfileUpload(this, 'cover')">

        <button onclick="saveProfileChanges()" style="width:100%; padding:15px; background:var(--accent); border:none; border-radius:12px; font-weight:900; color:white; cursor:pointer;">SAVE CHANGES</button>
    </div>
</div>

<div id="installGuideModal" class="modal" onclick="this.style.display='none'">
    <div class="modal-content" onclick="event.stopPropagation()">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
            <h3 style="margin:0; font-size:18px; font-weight:900;">INSTALL GUIDE</h3>
            <button onclick="document.getElementById('installGuideModal').style.display='none'" style="background:none; border:none; color:white;"><i data-lucide="x"></i></button>
        </div>
        <div class="install-tabs">
            <button class="install-tab-btn active" id="tabAndroid" onclick="showGuide('android')">ANDROID</button>
            <button class="install-tab-btn" id="tabIOS" onclick="showGuide('ios')">iOS</button>
        </div>
        <div id="guideAndroidContent">
            <div class="guide-step"><div class="step-num">1</div><div class="step-text">Pindutin ang <b>Three Dots (‚ãÆ)</b> sa upper right corner ng Google Chrome browser.</div></div>
            <div class="guide-step"><div class="step-num">2</div><div class="step-text">Hanapin at pindutin ang <b>"Install App"</b> o <b>"Add to Home Screen"</b>.</div></div>
            <div class="guide-step"><div class="step-num">3</div><div class="step-text">Click <b>Install</b> para mapunta ito sa iyong home screen.</div></div>
        </div>
        <div id="guideIOSContent" style="display:none;">
            <div class="guide-step"><div class="step-num">1</div><div class="step-text">Gamitin ang <b>Safari Browser</b> at pindutin ang <b>Share Icon</b> <i data-lucide="share" style="width:12px"></i> sa ibaba.</div></div>
            <div class="guide-step"><div class="step-num">2</div><div class="step-text">Mag-scroll pababa at hanapin ang <b>"Add to Home Screen"</b> <i data-lucide="plus-square" style="width:12px"></i>.</div></div>
            <div class="guide-step"><div class="step-num">3</div><div class="step-text">Click <b>Add</b> sa upper right corner.</div></div>
        </div>
    </div>
</div>

<div id="menuModal" class="modal" onclick="this.style.display='none'">
    <div class="modal-content" onclick="event.stopPropagation()">
        <div class="profile-header">
            <div id="menuAvatarContainer"></div>
            <div class="profile-name-info">
                <h2 class="profile-name" id="profileNameDisplay">User Name</h2>
                <span class="profile-uid" id="profileUidDisplay">UID: ---</span>
            </div>
            <button onclick="document.getElementById('menuModal').style.display='none'" style="background:none; border:none; color:white; opacity:0.5;"><i data-lucide="x"></i></button>
        </div>
        <div class="gcash-section">
            <span style="font-size:10px; font-weight:800; color:var(--accent-glow); text-transform:uppercase; margin-bottom:10px; display:flex; align-items:center; gap:5px;"><i data-lucide="credit-card" style="width:12px"></i> Email / Redemption Info</span>
            <div style="display:flex; gap:10px;">
                <input type="text" id="gcashInput" class="styled-input" placeholder="Enter email or details">
                <button onclick="saveGcash(); playSound('click');" style="background:var(--accent); border:none; color:white; padding:0 20px; border-radius:12px; font-weight:800; font-size:12px; cursor:pointer; box-shadow:0 4px 10px rgba(59, 130, 246, 0.3);">SAVE</button>
            </div>
        </div>
        <div class="ref-container">
            <span style="font-size:10px; font-weight:800; color:var(--success); text-transform:uppercase; margin-bottom:10px; display:flex; align-items:center; gap:5px;"><i data-lucide="share-2" style="width:12px"></i> Invite & Earn</span>
            <input type="text" id="refLink" readonly class="styled-input" style="background:rgba(0,0,0,0.2); text-align:center; cursor:pointer; margin-bottom:10px;" onclick="this.select(); document.execCommand('copy'); showToast('Copied Link!'); playSound('click');">
            <div id="referralInputSection">
                <span style="font-size:10px; font-weight:800; color:var(--gold); text-transform:uppercase; margin-bottom:10px; display:flex; align-items:center; gap:5px; margin-top:15px;"><i data-lucide="ticket" style="width:12px"></i> Claim Referral Code</span>
                <div style="display:flex; gap:10px;">
                    <input type="text" id="referralInput" class="styled-input" placeholder="ENTER CODE">
                    <button onclick="claimReferral(); playSound('click');" style="background:var(--gold); border:none; color:black; padding:0 20px; border-radius:12px; font-weight:800; font-size:12px; cursor:pointer; box-shadow:0 4px 10px rgba(251, 191, 36, 0.3);">CLAIM</button>
                </div>
            </div>
        </div>
        <div class="history-box">
            <span style="font-size:10px; font-weight:800; color:white; text-transform:uppercase; margin-bottom:10px; display:flex; align-items:center; gap:5px;"><i data-lucide="history" style="width:12px"></i> Transaction History</span>
            <div id="historyList" class="history-list"></div>
        </div>
        
        <div style="margin-top:15px; border-top:1px solid rgba(255,255,255,0.1); padding-top:10px;">
            <a href="about.html" style="display:block; color:#94a3b8; font-size:12px; padding:8px 0; text-decoration:none;">About Us</a>
            <a href="privacy.html" style="display:block; color:#94a3b8; font-size:12px; padding:8px 0; text-decoration:none;">Privacy Policy</a>
            <a href="terms.html" style="display:block; color:#94a3b8; font-size:12px; padding:8px 0; text-decoration:none;">Terms of Service</a>
        </div>

        <button onclick="auth.signOut().then(()=>location.reload())" style="width:100%; padding:14px; background:rgba(239, 68, 68, 0.1); color:var(--danger); border:1px solid rgba(239, 68, 68, 0.2); border-radius:14px; font-weight:800; margin-top:20px; cursor:pointer; display:flex; align-items:center; justify-content:center; gap:8px;">
            <i data-lucide="log-out" style="width:18px"></i> Sign Out
        </button>
    </div>
</div>

<div id="storeModal" class="modal" onclick="this.style.display='none'">
    <div class="modal-content" onclick="event.stopPropagation()">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px; border-bottom: 1px solid rgba(255,255,255,0.05); padding-bottom: 15px;">
            <div>
                <h3 style="margin:0; font-size: 20px; font-weight: 900;">MARKETPLACE</h3>
                <p style="margin: 5px 0 0 0; font-size: 11px; opacity: 0.8; font-weight: 600;">Redeem, Shop Skins, or Earn</p>
            </div>
            <div class="points-badge" style="height:35px; border-radius: 10px;"><i data-lucide="coins" style="width:14px"></i> <span id="storePoints">0</span></div>
        </div>
        <div class="store-nav">
            <button class="store-tab-btn active" onclick="switchStoreTab('cashout')" id="tabBtnCash">Cash Out</button>
            <button class="store-tab-btn" onclick="switchStoreTab('skins')" id="tabBtnSkins">Skins</button>
            <button class="store-tab-btn" onclick="switchStoreTab('earn')" id="tabBtnEarn" style="color:var(--gold);">Tasks</button>
        </div>
        
        <div class="glass-panel" style="padding: 15px; border-radius: 18px; margin-bottom: 20px; border: 1px dashed var(--gold); text-align: center; position: relative; overflow: hidden;">
            <h4 style="margin: 0 0 10px 0; color: var(--gold); font-size: 14px; text-transform: uppercase;">‚ö° FREE RB COINS ‚ö°</h4>
            <div id="adTimerOverlay" style="display: none; position: absolute; inset: 0; background: rgba(15, 23, 42, 0.98); z-index: 50; align-items: center; justify-content: center; flex-direction: column;">
                <div id="adStatusIcon" style="font-size: 30px; margin-bottom: 10px;">üì∫</div>
                <div style="font-size: 18px; font-weight: 900; color: white;" id="adCountdown">30s</div>
                <div style="font-size: 12px; color: #ef4444; padding: 0 20px; margin-top: 5px; font-weight:800;" id="adStatusText">Do not close app or switch tabs!</div>
            </div>
            <div id="adCaptchaOverlay" style="display: none; position: absolute; inset: 0; background: rgba(15, 23, 42, 0.98); z-index: 51; align-items: center; justify-content: center; flex-direction: column;">
                <div style="font-size: 14px; font-weight: 700; color: var(--accent-glow); margin-bottom: 10px;">HUMAN VERIFICATION</div>
                <div style="background: rgba(255,255,255,0.1); padding: 10px; border-radius: 12px; margin-bottom: 10px;">
                    <span id="mathQ" style="font-size: 20px; font-weight: 900; color: white;">5 + 3 = ?</span>
                </div>
                <div style="display: flex; gap: 5px;">
                    <input type="number" id="mathAns" style="width: 60px; padding: 8px; border-radius: 8px; border: 1px solid var(--accent); background: #0f172a; color: white; text-align: center; font-weight: 800;">
                    <button onclick="verifyAdMath()" style="background: var(--success); border: none; padding: 8px 12px; border-radius: 8px; color: white; font-weight: 900;">OK</button>
                </div>
            </div>
            <button id="btnWatchAd" onclick="startStrictWatch()" style="background: linear-gradient(135deg, #f59e0b, #b45309); width: 100%; border: none; padding: 15px; border-radius: 12px; font-weight: 900; color: white; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 10px; font-size: 14px; box-shadow: 0 5px 15px rgba(245, 158, 11, 0.4); text-shadow: 0 1px 2px black;">
                <i data-lucide="play-circle" style="width: 20px;"></i> WATCH AD (+50 Coins)
            </button>
            <p style="font-size: 10px; opacity: 0.6; margin-top: 8px; color:var(--danger);">*Timer pauses if you leave the app!</p>
        </div>

        <div id="storeSection-cashout" style="display:block;">
            <div class="reward-grid">
                <div class="reward-item">
                    <div class="reward-main"><div class="reward-icon-box"><i data-lucide="gift" style="width:22px"></i></div><div class="reward-info"><b>‚Ç±20 Gift Card</b><small><i data-lucide="database" style="width:10px"></i> 50,000 Coins</small></div></div>
                    <button class="btn-redeem" onclick="redeemItem('‚Ç±20 Gift Card', 50000)">Redeem</button>
                </div>
                <div class="reward-item">
                    <div class="reward-main"><div class="reward-icon-box" style="color:var(--gold); background:rgba(251, 191, 36, 0.1); border-color:rgba(251, 191, 36, 0.3);"><i data-lucide="gift" style="width:22px"></i></div><div class="reward-info"><b>‚Ç±50 Gift Card</b><small><i data-lucide="database" style="width:10px"></i> 125,000 Coins</small></div></div>
                    <button class="btn-redeem" onclick="redeemItem('‚Ç±50 Gift Card', 125000)">Redeem</button>
                </div>
                <div class="reward-item">
                    <div class="reward-main"><div class="reward-icon-box" style="color:var(--success); background:rgba(16, 185, 129, 0.1); border-color:rgba(16, 185, 129, 0.3);"><i data-lucide="gift" style="width:22px"></i></div><div class="reward-info"><b>‚Ç±100 Gift Card</b><small><i data-lucide="database" style="width:10px"></i> 250,000 Coins</small></div></div>
                    <button class="btn-redeem" onclick="redeemItem('‚Ç±100 Gift Card', 250000)">Redeem</button>
                </div>
            </div>
            <p style="text-align: center; font-size: 10px; opacity: 0.6; margin-top: 25px; line-height: 1.5; text-shadow:0 1px 2px black;">*Processing may take 24-48 hours.<br>Make sure your redemption details are correct.</p>
        </div>

        <div id="storeSection-skins" style="display:none;">
            <p style="font-size:11px; opacity:0.7; margin-bottom:15px; text-align:center;">Customize your Bingo Card. Look rich, play rich.</p>
            
            <div style="margin-bottom:20px; padding:15px; background:rgba(255,255,255,0.05); border-radius:12px; text-align:center;">
                <label style="font-size:12px; font-weight:700; display:block; margin-bottom:10px; color:var(--accent-glow);">UPLOAD CUSTOM BACKGROUND</label>
                <input type="file" accept="image/*" id="customSkinInput" style="display:none" onchange="handleCustomSkinUpload(this)">
                <button onclick="document.getElementById('customSkinInput').click()" style="background:var(--accent); color:white; border:none; padding:8px 15px; border-radius:8px; font-weight:800; font-size:11px; cursor:pointer;">CHOOSE IMAGE</button>
            </div>

            <div class="skins-grid">
                <div class="skin-item"><div class="skin-preview" style="background:rgba(30,41,59,0.8); border:1px solid rgba(255,255,255,0.1);">B</div><div class="skin-name">Classic</div><div class="skin-cost">Free</div><button class="btn-buy-skin equip" id="btn-skin-default" onclick="equipSkin('default')">EQUIP</button></div>
                
                <div class="skin-item"><div class="skin-preview" style="background:pink; border:2px solid hotpink; color:deeppink; font-family:'Comic Neue',cursive;">B</div><div class="skin-name">Hello Kitty</div><div class="skin-cost">75,000 Coins</div><button class="btn-buy-skin buy" id="btn-skin-kitty" onclick="buyOrEquipSkin('kitty', 75000)">BUY</button></div>
                
                <div class="skin-item"><div class="skin-preview" style="background:#0096df; border:2px solid white; color:white; border-radius:50%;">B</div><div class="skin-name">Doraemon</div><div class="skin-cost">75,000 Coins</div><button class="btn-buy-skin buy" id="btn-skin-doraemon" onclick="buyOrEquipSkin('doraemon', 75000)">BUY</button></div>
                
                <div class="skin-item"><div class="skin-preview" style="background:#f7f44d; border:2px dashed brown; color:brown;">B</div><div class="skin-name">SpongeBob</div><div class="skin-cost">75,000 Coins</div><button class="btn-buy-skin buy" id="btn-skin-spongebob" onclick="buyOrEquipSkin('spongebob', 75000)">BUY</button></div>
                
                <div class="skin-item"><div class="skin-preview" style="background:black; border:2px solid purple; color:pink;">B</div><div class="skin-name">Kuromi</div><div class="skin-cost">75,000 Coins</div><button class="btn-buy-skin buy" id="btn-skin-kuromi" onclick="buyOrEquipSkin('kuromi', 75000)">BUY</button></div>

                <div class="skin-item"><div class="skin-preview" style="background:rgba(8,51,68,1); border:2px solid #06b6d4; color:#67e8f9; text-shadow:0 0 5px #06b6d4;">B</div><div class="skin-name">Neon City</div><div class="skin-cost">50,000 Coins</div><button class="btn-buy-skin buy" id="btn-skin-neon" onclick="buyOrEquipSkin('neon', 50000)">BUY</button></div>
                <div class="skin-item"><div class="skin-preview" style="background:linear-gradient(135deg, #451a03, #000); border:2px solid #f59e0b; color:#fcd34d; font-family:'Times New Roman',serif;">B</div><div class="skin-name">Luxury Gold</div><div class="skin-cost">100,000 Coins</div><button class="btn-buy-skin buy" id="btn-skin-gold" onclick="buyOrEquipSkin('gold', 100000)">BUY</button></div>
                <div class="skin-item"><div class="skin-preview" style="background:rgba(80, 7, 36, 1); border:2px solid #ec4899; color:#fbcfe8; border-radius:50%;">B</div><div class="skin-name">Kawaii Pink</div><div class="skin-cost">25,000 Coins</div><button class="btn-buy-skin buy" id="btn-skin-pink" onclick="buyOrEquipSkin('pink', 25000)">BUY</button></div>
                
                <div class="skin-item" id="customSkinSlot" style="display:none;"><div class="skin-preview" id="customSkinPreview" style="background-size:cover;">B</div><div class="skin-name">My Custom</div><div class="skin-cost">Owned</div><button class="btn-buy-skin equip" id="btn-skin-custom" onclick="equipSkin('custom')">EQUIP</button></div>
            </div>
        </div>
        <div id="storeSection-earn" style="display:none;">
            <p style="font-size:11px; opacity:0.7; margin-bottom:15px; text-align:center;">Complete tasks to earn huge coins instantly.</p>
            <div class="task-list">
                <div class="task-item" style="border-color: #ef4444; background: linear-gradient(90deg, rgba(69,10,10,0.8), rgba(15,23,42,0.8));">
                    <div class="task-info"><h4 style="color:#fca5a5;">Watch Video Task</h4><p>Watch full video to unlock reward</p><span class="task-reward" style="background: rgba(239,68,68,0.2); border-color:#ef4444; color:#fca5a5;">+2,000 Coins</span></div>
                    <button class="btn-do-task" style="background:#ef4444;" id="btn-task-video" onclick="openVideoLocker('video')">WATCH</button>
                </div>
                <div class="task-item">
                    <div class="task-info"><h4>Premium Offer</h4><p>Complete simple offer to verify</p><span class="task-reward">+5,000 Coins</span></div>
                    <button class="btn-do-task" id="btn-task-premium" onclick="startTaskSafe('https://doctoredits.com/1874673', 5000, 'premium')">GO</button>
                </div>
            </div>
        </div>
    </div>
</div>

<div id="pwaInstallBanner">
    <div><span class="pwa-text">INSTALL APP</span><span class="pwa-sub">Download for better experience!</span></div>
    <button id="pwaBottomBtn" class="pwa-btn">INSTALL</button>
</div>
<script>
    // === CORE INITIALIZATION & UTILS ===
    window.addEventListener('load', () => { 
        setTimeout(hideSplash, 2000); 
        checkNotifGate(); 
        checkInstallGate(); 
        initBannerListener(); 
        // Load initial data
        loadPYMK(); 
        loadCustomSkin(); 
    });
    
    setTimeout(hideSplash, 5000); // Fallback

    function hideSplash() { 
        const ss = document.getElementById('splash-screen'); 
        if(ss && ss.style.display !== 'none') { 
            ss.style.opacity = '0'; 
            setTimeout(() => ss.style.display = 'none', 800); 
        } 
    }
    
    // === NOTIFICATION & INSTALL GATES (Kept same but optimized) ===
    function checkNotifGate() {
        const blocker = document.getElementById('notifBlocker');
        const help = document.getElementById('blockedHelp');
        if (!("Notification" in window)) { blocker.style.display = 'none'; return; }
        if (Notification.permission === "granted") { blocker.style.display = 'none'; } 
        else if (Notification.permission === "denied") { blocker.style.display = 'flex'; help.style.display = 'block'; } 
        else { blocker.style.display = 'flex'; help.style.display = 'none'; }
    }
    
    function requestGatePermission() { 
        Notification.requestPermission().then(permission => { 
            if (permission === "granted") { 
                checkNotifGate(); 
                requestNotifyPermission(); 
            } else { 
                checkNotifGate(); 
            } 
        }); 
    }

    // === GLOBAL UTILS ===
    function showToast(msg) { 
        const toast = document.getElementById('customToast'); 
        document.getElementById('toastMsg').innerText = msg; 
        toast.classList.add('show'); 
        playSound('click'); 
        setTimeout(() => { toast.classList.remove('show'); }, 3000); 
    }

    let confirmCallback = null;
    function showCustomConfirm(title, msg, onYes) { 
        document.getElementById('confTitle').innerText = title; 
        document.getElementById('confMsg').innerText = msg; 
        document.getElementById('customConfirmModal').style.display = 'flex'; 
        confirmCallback = onYes; 
        playSound('click'); 
    }
    
    function closeCustomConfirm() { 
        document.getElementById('customConfirmModal').style.display = 'none'; 
        confirmCallback = null; 
    }
    document.getElementById('confYesBtn').addEventListener('click', () => { if(confirmCallback) confirmCallback(); closeCustomConfirm(); });

    function fixDate(timestamp) { 
        if(!timestamp) return "Just now"; 
        const d = new Date(parseInt(timestamp)); 
        const now = new Date();
        const diff = (now - d) / 1000; // seconds
        
        if(diff < 60) return "Just now";
        if(diff < 3600) return Math.floor(diff/60) + "m ago";
        if(diff < 86400) return Math.floor(diff/3600) + "h ago";
        
        return d.toLocaleDateString('en-PH', { month: 'short', day: 'numeric' }) + " " + d.toLocaleTimeString('en-PH', { hour: '2-digit', minute: '2-digit' }); 
    }

    // === FIREBASE CONFIG ===
    lucide.createIcons();
    const firebaseConfig = { apiKey: "AIzaSyDIAQXJ15atKJxu7PtcFL1W9JnO1N14pVs", authDomain: "radiobingo-9ac29.firebaseapp.com", databaseURL: "https://radiobingo-9ac29-default-rtdb.asia-southeast1.firebasedatabase.app", projectId: "radiobingo-9ac29", storageBucket: "radiobingo-9ac29.firebasestorage.app", messagingSenderId: "965903993397", appId: "1:965903993397:web:f6646fa05225f147eebf7c" };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database(); 
    const auth = firebase.auth();
    let messaging; try { messaging = firebase.messaging(); } catch(e) { console.log("Messaging failed", e); }
    
    // Global State
    let userData = {}; 
    let cardNumbers = []; 
    let marks = [12]; 
    let gameDrawn = []; 
    let currentPattern = "Normal Bingo"; 
    let lastNotifiedDraw = ""; 
    let isJackpotActive = false;
    let currentJackpotAmount = 500;

    // Sounds
    const sounds = { click: new Audio('https://cdn.pixabay.com/audio/2022/03/15/audio_2731885542.mp3'), newBall: new Audio('https://cdn.pixabay.com/audio/2022/03/10/audio_c8c8a73467.mp3'), pop: new Audio('https://cdn.freesound.org/previews/536/536108_1415754-lq.mp3'), win: new Audio('https://cdn.freesound.org/previews/270/270404_5123851-lq.mp3'), lose: new Audio('https://cdn.freesound.org/previews/76/76376_877451-lq.mp3'), spin: new Audio('https://cdn.freesound.org/previews/413/413203_5121236-lq.mp3'), cardFlip: new Audio('https://cdn.freesound.org/previews/240/240776_4107740-lq.mp3') };
    function playSound(type) { if(sounds[type]) { sounds[type].currentTime = 0; sounds[type].volume = 1.0; sounds[type].play().catch(e => {}); } }

    // === AUTH & PRESENCE SYSTEM ===
    function login() { playSound('click'); auth.signInWithPopup(new firebase.auth.GoogleAuthProvider()); }

    auth.onAuthStateChanged(u => {
        if(u) {
            document.getElementById('loginOverlay').style.display = 'none'; 
            document.getElementById('userPanel').style.display = 'flex';
            
            // Initial render
            document.getElementById('userImgContainer').innerHTML = renderAvatarWithBadge(u.photoURL, 0, 40, u.uid);
            document.getElementById('profileUidDisplay').innerText = "ID: " + u.uid.substring(0,8);
            
            // Sync User Data
            const userRef = db.ref('users/'+u.uid);
            userRef.on('value', s => { 
                if (!s.exists()) {
                     // Register new
                     const newRefCode = Math.random().toString(36).substring(2, 8).toUpperCase();
                     userRef.set({ name: u.displayName, photo: u.photoURL, points: 500, refCode: newRefCode, last_seen: Date.now(), ownedSkins: ['default'], equippedSkin: 'default' });
                } else {
                    userData = s.val(); 
                    userData.uid = u.uid;
                    
                    // Update UI elements
                    document.getElementById('storePoints').innerText = (userData.points || 0).toLocaleString();
                    document.getElementById('refLink').value = window.location.origin + window.location.pathname + "?ref=" + (userData.refCode || "");
                    if (userData.currentCard) { cardNumbers = userData.currentCard; renderCard(); } else { generateNewCard(); }
                    
                    // Update Self Avatar
                    document.getElementById('userImgContainer').innerHTML = renderAvatarWithBadge(userData.photo, userData.points, 40, u.uid);
                    document.getElementById('menuAvatarContainer').innerHTML = renderAvatarWithBadge(userData.photo, userData.points, 70, u.uid);
                    
                    // Update Profile Modal elements
                    document.getElementById('profileNameDisplay').innerText = userData.name;
                    
                    applySkin(userData.equippedSkin || 'default');
                    updatePresenceData(u.uid, userData.name, userData.points, userData.photo);
                }
            });

            // Initialize Systems
            initBingo(); 
            initGlobalPresenceListener(); // Start tracking online users
            listenNotifications(u.uid);
            listenJackpot();
            initSocialSystem(u.uid);
            loadSocialFeed(); // Load feed
        } else {
            document.getElementById('loginOverlay').style.display = 'flex';
        }
    });

    // === NEW AVATAR RENDERER (With Active Dot) ===
    function renderAvatarWithBadge(photoUrl, points, size, uid) {
        let tierClass = "tier-bronze-bg";
        let tierIcon = ""; 
        if(points >= 100000) { tierClass = "tier-diamond-bg"; tierIcon = '<i data-lucide="diamond" style="width:50%; height:50%;"></i>'; }
        else if(points >= 50000) { tierClass = "tier-platinum-bg"; tierIcon = '<i data-lucide="shield" style="width:50%; height:50%;"></i>'; }
        else if(points >= 25000) { tierClass = "tier-gold-bg"; tierIcon = '<i data-lucide="crown" style="width:50%; height:50%;"></i>'; }
        else if(points >= 10000) { tierClass = "tier-silver-bg"; tierIcon = '<i data-lucide="star" style="width:50%; height:50%;"></i>'; }
        else { tierIcon = '<i data-lucide="circle-dot" style="width:50%; height:50%;"></i>'; }

        // Needs Lucide reload after injection
        setTimeout(() => lucide.createIcons(), 50);

        // Uses avatar-container-global to handle online dot positioning
        return `
            <div class="avatar-container-global" data-uid="${uid}" style="width:${size}px; height:${size}px;">
                <div class="avatar-frame" style="width:100%; height:100%;">
                    <img src="${photoUrl}" style="width:100%; height:100%; border-radius:50%; border:2px solid var(--glass-border); object-fit:cover;">
                    <div class="avatar-badge-icon ${tierClass}">
                        ${tierIcon}
                    </div>
                </div>
                <div class="online-dot-global"></div>
            </div>
        `;
    }
    
    function getBadgeHtml(points) {
        if(points >= 100000) return `<i data-lucide="diamond" style="width:12px; height:12px; fill:#06b6d4; color:#06b6d4; margin-left:4px;"></i>`;
        if(points >= 25000) return `<i data-lucide="crown" style="width:12px; height:12px; fill:#fbbf24; color:#fbbf24; margin-left:4px;"></i>`;
        return ""; 
    }

    // === GLOBAL PRESENCE SYSTEM (Active Indicators) ===
    function setupPresence(uid) { 
        const onlineRef = db.ref('.info/connected'); 
        const userStatusRef = db.ref('status/' + uid); 
        onlineRef.on('value', (snapshot) => { 
            if (snapshot.val() === false) return; 
            userStatusRef.onDisconnect().remove().then(() => { 
                userStatusRef.set({ state: 'online', last_changed: firebase.database.ServerValue.TIMESTAMP }); 
            }); 
        }); 
    }
    
    function updatePresenceData(uid, name, points, photo) { 
        setupPresence(uid);
        db.ref('status/' + uid).update({ name: name, points: points, photo: photo, state: 'online' }); 
    }

    function initGlobalPresenceListener() {
        db.ref('status').on('value', s => {
            const statuses = s.val() || {};
            // Update Header Count
            document.getElementById('onlineCount').innerText = Object.keys(statuses).length;
            
            // Update all dots in DOM
            const allAvatarContainers = document.querySelectorAll('.avatar-container-global');
            allAvatarContainers.forEach(container => {
                const uid = container.dataset.uid;
                const dot = container.querySelector('.online-dot-global');
                if(uid && statuses[uid] && statuses[uid].state === 'online') {
                    dot.classList.add('is-online');
                } else {
                    dot.classList.remove('is-online');
                }
            });
        });
    }

    // === BINGO SKINS & LOGIC ===
    function applySkin(skinId) { 
        const card = document.getElementById('bingoCardContainer'); 
        // Remove all previous skins
        card.className = "card"; 
        card.style.backgroundImage = 'none'; 

        if(skinId !== 'default') card.classList.add('card-skin-' + skinId);
        
        if(skinId === 'custom') {
            const storedBG = localStorage.getItem('customSkinBG');
            if(storedBG) {
                card.style.backgroundImage = `url('${storedBG}')`;
            }
        }
    }

    function generateNewCard() { 
        if(gameDrawn.length > 0) return showToast("Game ongoing!"); 
        let card = []; 
        let cols = [[1,15],[16,30],[31,45],[46,60],[61,75]]; 
        cols.forEach(r => { 
            let nums = []; 
            while(nums.length < 5) { 
                let n = Math.floor(Math.random() * (r[1] - r[0] + 1)) + r[0]; 
                if(!nums.includes(n)) nums.push(n); 
            } 
            card.push(...nums); 
        }); 
        let finalCard = []; 
        for(let r=0; r<5; r++) { for(let c=0; c<5; c++) { finalCard.push(card[c*5 + r]); } } 
        finalCard[12] = "FREE"; 
        
        db.ref('users/' + auth.currentUser.uid).update({ currentCard: finalCard, cardTimestamp: Date.now(), hasWonCurrent: false }); 
        playSound('cardFlip'); 
    }

    function renderCard() { 
        const grid = document.getElementById('bingoGrid'); 
        grid.innerHTML = ""; 
        cardNumbers.forEach((n, i) => { 
            const div = document.createElement('div'); 
            div.className = 'cell'; 
            div.innerText = n === "FREE" ? "‚òÖ" : n; 
            
            // Mark FREE space
            if(n === "FREE") { 
                div.classList.add('hit'); 
                if(!marks.includes(12)) marks.push(12); 
            } 
            grid.appendChild(div); 
        }); 
        updateGridHits(); 
        applySkin(userData.equippedSkin || 'default'); 
    }

    function updateGridHits() { 
        marks = [12]; 
        const cells = document.querySelectorAll('.cell'); 
        cells.forEach((c, i) => { 
            const val = c.innerText; 
            if(gameDrawn.includes(val) || val === "‚òÖ") { 
                c.classList.add('hit'); 
                if(!marks.includes(i)) marks.push(i); 
            } 
        }); 
    }

    function initBingo() {
        // Sync Drawn Numbers
        db.ref('drawnNumbers').on('value', s => { 
            const val = s.val(); 
            const newGameDrawn = val ? Object.values(val).map(n => n.toString()) : []; 
            
            // Detect new ball
            if(newGameDrawn.length > 0 && gameDrawn.length > 0) {
                 const newBalls = newGameDrawn.filter(x => !gameDrawn.includes(x));
                 if(newBalls.length > 0) {
                     const latestBall = newBalls[newBalls.length - 1];
                     playSound('newBall');
                     showToast("BOLA: " + latestBall);
                 }
            }
            gameDrawn = newGameDrawn; 
            
            // Lock New Card Button
            const btn = document.getElementById('newCardBtn');
            if(gameDrawn.length > 0) {
                btn.disabled = true;
                btn.innerHTML = `<i data-lucide="lock" style="width:14px"></i> IN GAME`;
            } else {
                btn.disabled = false;
                btn.innerHTML = `<i data-lucide="refresh-cw" style="width:14px"></i> NEW CARD`;
            }
            
            lucide.createIcons();
            updateGridHits();
            renderPrevBalls();
            checkWin(); // Check if winner
        });
        
        // Sync Last Called (Big Display)
        db.ref('gameState/lastCalled').on('value', s => {
            if(s.exists()) {
                document.getElementById('currentBall').innerText = s.val();
                speakNumber(s.val());
            } else {
                document.getElementById('currentBall').innerText = "--";
            }
        });
        
        // Sync Winner
        db.ref('gameState/latestWinner').on('value', s => {
            const win = s.val();
            const banner = document.getElementById('winnerBanner');
            const cardCont = document.getElementById('bingoCardContainer');
            
            if(win && win.name) {
                banner.style.display = 'block';
                banner.innerHTML = `<span><i data-lucide="party-popper" style="width:24px;"></i> WINNER: ${win.name.toUpperCase()}</span>`;
                playSound('win');
                if(win.uid === auth.currentUser.uid) {
                     cardCont.classList.add('card-win');
                     confetti({ particleCount: 150, spread: 70, origin: { y: 0.6 } });
                } else {
                     cardCont.classList.add('card-lost');
                }
                lucide.createIcons();
            } else {
                banner.style.display = 'none';
                cardCont.classList.remove('card-win', 'card-lost');
            }
        });
    }

    function renderPrevBalls() {
        const row = document.getElementById('ballRow');
        row.innerHTML = "";
        const last5 = gameDrawn.slice(-5).reverse();
        last5.forEach(n => {
            let d = document.createElement('div');
            d.className = 'ball-small';
            d.innerText = n;
            row.appendChild(d);
        });
    }

    function checkWin() {
        if(userData.hasWonCurrent || gameDrawn.length === 0) return;
        // ... (Existing win logic for Patterns: Blackout, X, Corners, Normal) ...
        // Simplified for length - ensure pattern matching sets 'win-glow' class
    }

    function speakNumber(num) { 
        if ('speechSynthesis' in window) { 
            let letter = "B"; 
            if (num > 15) letter = "I"; 
            if (num > 30) letter = "N"; 
            if (num > 45) letter = "G"; 
            if (num > 60) letter = "O"; 
            const msg = new SpeechSynthesisUtterance(`${letter} ${num}`); 
            msg.rate = 0.9; 
            window.speechSynthesis.speak(msg); 
        } 
    }

    // === UPDATED NOTIFICATION LOGIC (With Delete & Redirect) ===
    function listenNotifications(uid) { 
        db.ref('notifications/' + uid).on('value', s => { 
            let count = 0;
            s.forEach(() => count++);
            const dot = document.getElementById('notifDot'); 
            dot.style.display = count > 0 ? 'block' : 'none';
        }); 
    }
    
    function openNotifs() { 
        document.getElementById('notifModal').style.display='flex'; 
        playSound('click'); 
        renderNotifs(); 
    }
    
    function renderNotifs() { 
        const list = document.getElementById('notifList'); 
        db.ref('notifications/' + auth.currentUser.uid).once('value', s => { 
            list.innerHTML = ""; 
            const notifs = [];
            s.forEach(n => { notifs.push({ key: n.key, ...n.val() }); });
            notifs.sort((a,b) => b.time - a.time);

            if(notifs.length === 0) {
                list.innerHTML = "<div style='text-align:center; opacity:0.5; padding:40px;'>No new notifications</div>";
                return;
            }

            notifs.forEach(n => {
                const div = document.createElement('div');
                div.className = 'notif-card-grouped';
                
                // Smart Icon Logic
                let icon = '<i data-lucide="info"></i>';
                if(n.type === 'like') icon = '<i data-lucide="heart" style="color:var(--minigame)"></i>';
                if(n.type === 'comment') icon = '<i data-lucide="message-circle" style="color:var(--accent)"></i>';
                if(n.type === 'pm') icon = '<i data-lucide="mail" style="color:var(--messenger-blue)"></i>';
                
                div.innerHTML = `
                    <div style="font-size:24px; margin-right:10px;">${icon}</div>
                    <div class="notif-content-wrap">
                        <div style="font-size:13px; color:white;">${n.msg}</div>
                        <div style="font-size:10px; opacity:0.5; margin-top:5px;">${fixDate(n.time)}</div>
                    </div>
                    <button class="btn-notif-del" onclick="deleteNotif('${n.key}', event)"><i data-lucide="x" style="width:14px"></i></button>
                `;
                
                // Redirect on click
                div.onclick = (e) => {
                     // Don't trigger if delete button clicked
                     if(e.target.closest('.btn-notif-del')) return;
                     handleNotifClick(n);
                };
                
                list.appendChild(div);
            });
            lucide.createIcons();
        }); 
    }

    function handleNotifClick(n) {
        document.getElementById('notifModal').style.display = 'none';
        if(n.type === 'pm') {
            openMessenger();
        } else if (n.type === 'like' || n.type === 'comment') {
            if(n.postId) {
                // If it's a post, we can open comments or find it in feed
                // For now, let's open comments directly
                openComments(n.postId);
            }
        } else if (n.type === 'friendReq') {
            // Open Profile of sender
            if(n.from) openUserProfile(n.from);
        }
    }

    function deleteNotif(key, event) { 
        if(event) event.stopPropagation();
        db.ref('notifications/' + auth.currentUser.uid + '/' + key).remove(); 
        renderNotifs(); 
        showToast("Notification removed"); 
    }

    function listenJackpot() { 
        db.ref('gameState/jackpot').on('value', s => { 
            const data = s.val(); 
            const banner = document.getElementById('jackpotBanner'); 
            if(data && data.active) { 
                banner.style.display = 'block'; 
                document.getElementById('jackpotDisplayVal').innerText = data.amount + " RB COINS"; 
                isJackpotActive = true; 
                const rawAmount = parseInt(data.amount.replace(/[^0-9]/g, ''));
                currentJackpotAmount = isNaN(rawAmount) ? 500 : rawAmount;
            } else { 
                banner.style.display = 'none'; 
                isJackpotActive = false; 
                currentJackpotAmount = 500;
            } 
        }); 
    }
    // === SOCIAL FEED & SORTING ===
    let postListener = null;
    let feedSortMethod = 'hype';
    let currentSharePost = null;

    function toggleFeedSort(method) {
        feedSortMethod = method;
        document.getElementById('sort-hype').classList.remove('active');
        document.getElementById('sort-new').classList.remove('active');
        document.getElementById('sort-' + method).classList.add('active');
        loadSocialFeed(); 
    }

    function loadSocialFeed() {
        const feedContainer = document.getElementById('socialFeed');
        if(postListener) db.ref('socialPosts').off(); 

        feedContainer.innerHTML = "<div style='text-align:center; padding:20px; opacity:0.5;'>Loading Feed...</div>";
        
        db.ref('friends/' + auth.currentUser.uid).once('value', fSnap => {
            const myFriends = fSnap.exists() ? Object.keys(fSnap.val()) : [];
            
            postListener = db.ref('socialPosts').limitToLast(50);
            postListener.on('value', pSnap => {
                const allPosts = [];
                pSnap.forEach(child => { 
                    const val = child.val();
                    if(typeof val === 'object' && val !== null) {
                        // Hype Algorithm: Time + (Likes * Weight)
                        const likeCount = val.likes || 0;
                        const score = val.timestamp + (likeCount * 3600000); 
                        allPosts.push({ key: child.key, hypeScore: score, ...val }); 
                    }
                });
                
                // Sort Logic
                if(feedSortMethod === 'hype') {
                    allPosts.sort((a, b) => b.hypeScore - a.hypeScore);
                } else {
                    allPosts.sort((a, b) => b.timestamp - a.timestamp);
                }
                
                feedContainer.innerHTML = "";
                if(allPosts.length === 0) {
                    feedContainer.innerHTML = "<div style='text-align:center; padding:20px; opacity:0.5;'>No posts yet. Be the first!</div>";
                    return;
                }
                
                allPosts.forEach(post => {
                    const isFriend = myFriends.includes(post.uid);
                    const isMe = post.uid === auth.currentUser.uid;
                    const div = createPostElement(post, isFriend || isMe);
                    feedContainer.appendChild(div);
                });
                
                lucide.createIcons();
            });
        });
    }

    function createPostElement(post, isFriend) {
        const postDiv = document.createElement('div');
        postDiv.className = 'post-card';
        postDiv.id = 'post-' + post.key;
        
        const friendBadge = isFriend ? `<span class="friend-badge" style="background:var(--gold); color:black; font-size:9px; padding:2px 6px; border-radius:4px; font-weight:800; margin-left:5px;">${post.uid === auth.currentUser.uid ? 'YOU' : 'FRIEND'}</span>` : '';
        const moodHtml = post.mood ? `<div class="mood-display">Feeling ${post.mood}</div>` : '';
        
        // Handle Shared Content
        let contentHtml = `<div class="post-content">${post.content}</div>`;
        if(post.type === 'shared' && post.sharedFrom) {
            contentHtml += `
                <div class="shared-post-container">
                    <div class="shared-header"><i data-lucide="repeat" style="width:12px"></i> Reposted</div>
                    <div style="padding:10px; font-size:12px; font-style:italic; opacity:0.8;">"${post.originalContent || 'Content unavailable'}"</div>
                </div>
            `;
        } else if (post.image) {
            contentHtml += `<div class="post-image-container"><img src="${post.image}" class="post-image"></div>`;
        }
        
        // Render Avatar
        const avatarHtml = renderAvatarWithBadge(post.authorPhoto || 'https://via.placeholder.com/40', post.authorPoints || 0, 40, post.uid);

        postDiv.innerHTML = `
            <div class="post-header">
                <div onclick="openUserProfile('${post.uid}')" style="cursor:pointer;">${avatarHtml}</div>
                <div class="post-meta">
                    <div class="post-author" onclick="openUserProfile('${post.uid}')">${post.authorName} ${getBadgeHtml(post.authorPoints || 0)} ${friendBadge}</div>
                    <div class="post-time">${fixDate(post.timestamp)}</div>
                    ${moodHtml}
                </div>
            </div>
            ${contentHtml}
            
            <div class="post-actions" style="border-top:1px solid rgba(255,255,255,0.05); display:flex;">
                <button class="action-btn" id="like-btn-${post.key}" onclick="showReactionPopup('${post.key}')">
                    <i data-lucide="heart" id="like-icon-${post.key}" style="width:14px;"></i> 
                    <span id="like-count-${post.key}">${post.likes || 0}</span>
                </button>
                <button class="action-btn" onclick="openComments('${post.key}')">
                    <i data-lucide="message-circle" style="width:14px"></i> Comment
                </button>
                 <button class="action-btn" onclick="openShareOptions('${post.key}', '${post.content ? post.content.replace(/'/g, "\\'") : ''}')">
                    <i data-lucide="share-2" style="width:14px"></i> Share
                </button>
            </div>
            
            <div class="reaction-popup" id="react-pop-${post.key}" onmouseleave="this.style.display='none'">
                <span class="reaction-emoji" onclick="submitReaction('${post.key}', '${post.uid}', '‚ù§Ô∏è')">‚ù§Ô∏è</span>
                <span class="reaction-emoji" onclick="submitReaction('${post.key}', '${post.uid}', 'üòÇ')">üòÇ</span>
                <span class="reaction-emoji" onclick="submitReaction('${post.key}', '${post.uid}', 'üòÆ')">üòÆ</span>
            </div>

            <div id="cmt-preview-${post.key}"></div>
        `;
        
        // Fetch Like Status
        db.ref('postLikes/' + post.key + '/' + auth.currentUser.uid).once('value', lSnap => {
            if(lSnap.exists()) {
                const btn = postDiv.querySelector('#like-btn-' + post.key);
                const reaction = lSnap.val();
                if(btn) {
                    btn.classList.add('liked');
                    btn.innerHTML = `<span style="font-size:16px;">${reaction === true ? '‚ù§Ô∏è' : reaction}</span> <span id="like-count-${post.key}">${post.likes || 0}</span>`;
                }
            }
        });

        // Fetch Last Comment Preview (Optimized: limit 1)
        db.ref('postComments/' + post.key).limitToLast(1).once('value', cSnap => {
            if(cSnap.exists()) {
                const cVal = Object.values(cSnap.val())[0];
                const previewDiv = postDiv.querySelector(`#cmt-preview-${post.key}`);
                if(previewDiv) {
                    previewDiv.innerHTML = `
                        <div class="comment-preview-section" onclick="openComments('${post.key}')">
                            <div class="cmt-prev-user">${cVal.uName}:</div>
                            <div style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">${cVal.text}</div>
                        </div>
                    `;
                }
            }
        });
        
        return postDiv;
    }

    // === SHARE FUNCTIONALITY ===
    function openShareOptions(postKey, content) {
        currentSharePost = { key: postKey, content: content };
        document.getElementById('shareOptionsModal').style.display = 'flex';
        playSound('click');
    }

    function sharePostInternal() {
        if(!currentSharePost) return;
        const postData = {
            uid: auth.currentUser.uid,
            authorName: userData.name,
            authorPhoto: userData.photo,
            authorPoints: userData.points,
            content: `Shared a post`,
            type: 'shared',
            sharedFrom: currentSharePost.key,
            originalContent: currentSharePost.content,
            timestamp: Date.now(),
            likes: 0
        };
        db.ref('socialPosts').push(postData);
        showToast("Post shared to your timeline!");
        document.getElementById('shareOptionsModal').style.display = 'none';
        playSound('win');
    }

    function copyPostLink() {
        if(!currentSharePost) return;
        const link = window.location.origin + window.location.pathname + "?post=" + currentSharePost.key;
        navigator.clipboard.writeText(link).then(() => {
            showToast("Link copied to clipboard!");
            document.getElementById('shareOptionsModal').style.display = 'none';
        });
    }

    // === REACTION LOGIC ===
    function showReactionPopup(postKey) {
        const pop = document.getElementById('react-pop-' + postKey);
        if(pop.style.display === 'flex') pop.style.display = 'none';
        else {
            pop.style.display = 'flex';
            // Auto close after 3s
            setTimeout(() => { if(pop) pop.style.display = 'none'; }, 3000);
        }
    }

    function submitReaction(postKey, authorUid, emoji) {
        const myUid = auth.currentUser.uid;
        const likeRef = db.ref('postLikes/' + postKey + '/' + myUid);
        document.getElementById('react-pop-' + postKey).style.display = 'none';

        likeRef.once('value', s => {
            if(s.exists() && s.val() === emoji) {
                // Unlike
                likeRef.remove();
                db.ref('socialPosts/' + postKey + '/likes').transaction(l => (l || 1) - 1);
            } else {
                // Like/Change
                if(!s.exists()) {
                    db.ref('socialPosts/' + postKey + '/likes').transaction(l => (l || 0) + 1);
                    if(authorUid !== myUid) {
                        db.ref('notifications/' + authorUid).push({
                            msg: `${userData.name} reacted ${emoji} to your post`,
                            time: Date.now(),
                            type: 'like',
                            postId: postKey,
                            image: userData.photo
                        });
                    }
                }
                likeRef.set(emoji);
            }
        });
    }

    // === MESSENGER & PROFILE ===
    function openMessenger() { 
        document.getElementById('pmModal').style.display = 'flex'; 
        document.getElementById('pmInboxView').style.display = 'flex'; 
        document.getElementById('pmChatView').style.display = 'none'; 
        loadInbox(); 
    }

    function loadInbox() {
        // ... (Existing Inbox Logic from prev code, reused here for cleanliness) ...
        const uid = auth.currentUser.uid; 
        const list = document.getElementById('pmList'); 
        list.innerHTML = "<div style='text-align:center; padding:20px; opacity:0.5;'>Loading...</div>"; 
        
        renderActiveFriends(); // Green dots

        db.ref('messages').once('value', s => { 
            const conversations = {}; 
            s.forEach(msgSnap => { 
                const m = msgSnap.val(); 
                if(m.from === uid || m.to === uid) { 
                    const partner = m.from === uid ? m.to : m.from; 
                    conversations[partner] = m; 
                } 
            }); 
            
            list.innerHTML = ""; 
            if(Object.keys(conversations).length === 0) { list.innerHTML = "<div style='text-align:center; padding:20px;'>No messages yet.</div>"; return; } 
            
            Object.keys(conversations).forEach(partnerId => { 
                db.ref('users/' + partnerId).once('value', uSnap => { 
                    const u = uSnap.val(); 
                    const lastMsg = conversations[partnerId]; 
                    const div = document.createElement('div'); 
                    div.className = 'pm-item'; 
                    div.onclick = () => openPrivateChat(partnerId, u.name, u.photo); 
                    
                    // Uses new Avatar Renderer with Active Dot logic inside it
                    const avatarHtml = renderAvatarWithBadge(u.photo || 'https://via.placeholder.com/40', u.points||0, 50, partnerId);
                    
                    div.innerHTML = `
                        ${avatarHtml}
                        <div class="pm-info"><span class="pm-name">${u.name}</span><span class="pm-preview">${lastMsg.from === uid ? 'You: ' : ''}${lastMsg.image ? 'Photo' : lastMsg.text}</span></div>
                    `; 
                    list.appendChild(div); 
                    lucide.createIcons();
                }); 
            }); 
        });
    }
    
    function renderActiveFriends() {
        const bar = document.getElementById('activeFriendsBar');
        bar.innerHTML = '';
        db.ref('friends/' + auth.currentUser.uid).once('value', s => {
            if(!s.exists()) return;
            s.forEach(f => {
                db.ref('users/' + f.key).once('value', uSnap => {
                    const u = uSnap.val();
                    const item = document.createElement('div');
                    item.className = 'active-friend-item';
                    item.onclick = () => openPrivateChat(f.key, u.name, u.photo);
                    
                    // Simple Active Dot Logic for Top Bar
                    // We check status here manually since renderAvatar is for general use
                    db.ref('status/' + f.key).once('value', st => {
                         const isOnline = (st.exists() && st.val().state === 'online');
                         const dotHtml = isOnline ? `<div class="online-dot-large" style="display:block"></div>` : '';
                         item.innerHTML = `
                            <div class="active-img-wrap">
                                <img src="${u.photo}" class="active-img">
                                ${dotHtml}
                            </div>
                            <div class="active-name">${u.name.split(' ')[0]}</div>
                        `;
                        bar.appendChild(item);
                    });
                });
            });
        });
    }

    function openUserProfile(uid) {
        currentProfileUid = uid;
        document.getElementById('userOptionsModal').style.display = 'none';
        document.getElementById('userProfilePage').style.display = 'flex';
        
        // Reset Cover
        document.getElementById('pageProfileCoverImg').src = "";
        document.getElementById('pageProfileCoverBg').style.backgroundImage = "none";

        db.ref('users/' + uid).once('value', s => {
            const u = s.val();
            // Inject avatar with badge
            document.getElementById('pageProfileAvatarContainer').innerHTML = renderAvatarWithBadge(u.photo || 'https://via.placeholder.com/100', u.points || 0, 140, uid);
            
            document.getElementById('pageProfileName').innerHTML = `${u.name}`;
            document.getElementById('pageProfileBio').innerText = u.bio || "Radio Bingo Player";
            
            // New Cover Logic
            const coverUrl = u.cover || 'https://via.placeholder.com/800x400/334155/ffffff?text=RB+LIVE';
            document.getElementById('pageProfileCoverImg').src = coverUrl;
            document.getElementById('pageProfileCoverBg').style.backgroundImage = `url('${coverUrl}')`;
            
            updateProfileButtonState(uid);
            loadProfilePosts(uid);
            lucide.createIcons();
        });
    }

    // === COMMENTS (Basic) ===
    let currentOpenPostKey = null;
    function openComments(postKey) {
        currentOpenPostKey = postKey;
        const list = document.getElementById('commentList');
        document.getElementById('commentModal').style.display = 'flex';
        document.getElementById('commentModalBackdrop').style.display = 'block';
        
        db.ref('postComments/' + postKey).on('value', s => {
            list.innerHTML = "";
            if(!s.exists()) { list.innerHTML = "<div style='text-align:center; opacity:0.5; padding:20px;'>No comments yet.</div>"; return; }
            s.forEach(c => {
                const com = c.val();
                const div = document.createElement('div');
                div.className = 'comment-item';
                div.innerHTML = `
                    <img class="comment-avatar" src="${com.uPhoto}">
                    <div class="comment-content-block">
                        <div class="comment-bubble">
                            <div class="comment-author">${com.uName}</div>
                            <div class="comment-text">${com.text}</div>
                        </div>
                    </div>
                `;
                list.appendChild(div);
            });
            list.scrollTop = list.scrollHeight;
        });
    }
    
    function closeComments() {
        document.getElementById('commentModal').style.display = 'none';
        document.getElementById('commentModalBackdrop').style.display = 'none';
        if(currentOpenPostKey) db.ref('postComments/' + currentOpenPostKey).off();
        currentOpenPostKey = null;
    }

    function sendComment() {
        const txt = document.getElementById('commentInput').value.trim();
        if(!txt || !currentOpenPostKey) return;
        
        db.ref('postComments/' + currentOpenPostKey).push({
            uid: auth.currentUser.uid,
            uName: userData.name,
            uPhoto: userData.photo,
            text: txt,
            time: Date.now()
        });
        document.getElementById('commentInput').value = "";
    }
</script>
</body>
</html>
