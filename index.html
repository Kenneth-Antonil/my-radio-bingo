<!DOCTYPE html>
<html lang="tl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#0f172a">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Radio Bingo Live | Social Ecosystem</title>
    
    <link rel="stylesheet" href="style.css">

    <style>
        /* === CORE THEME & BACKGROUND === */
        :root {
            --bg-dark: #0f172a;
            --glass-card: rgba(30, 41, 59, 0.6);
            --glass-border: rgba(255, 255, 255, 0.08);
            --text-main: #f8fafc;
            --text-sub: #94a3b8;
            --accent: #38bdf8;
            --accent-gradient: linear-gradient(135deg, #0ea5e9 0%, #2563eb 100%);
            --gold-gradient: linear-gradient(135deg, #fbbf24 0%, #d97706 100%);
        }

        body {
            background-color: var(--bg-dark);
            background-image: 
                radial-gradient(at 0% 0%, rgba(56, 189, 248, 0.15) 0px, transparent 50%),
                radial-gradient(at 100% 0%, rgba(236, 72, 153, 0.1) 0px, transparent 50%),
                radial-gradient(at 100% 100%, rgba(99, 102, 241, 0.1) 0px, transparent 50%);
            background-attachment: fixed;
            font-family: 'Inter', sans-serif;
            color: var(--text-main);
            -webkit-font-smoothing: antialiased;
        }

        /* === PREMIUM NAVIGATION === */
        .nav {
            background: rgba(15, 23, 42, 0.85) !important;
            backdrop-filter: blur(12px);
            border-bottom: 1px solid var(--glass-border);
            box-shadow: 0 4px 20px rgba(0,0,0,0.2);
        }

        .bottom-nav {
            background: rgba(15, 23, 42, 0.9) !important;
            backdrop-filter: blur(16px);
            border: 1px solid var(--glass-border);
            border-radius: 20px 20px 0 0;
            box-shadow: 0 -10px 40px rgba(0,0,0,0.3);
            bottom: 0 !important; /* Reset layout */
            padding-bottom: env(safe-area-inset-bottom);
        }
        
        /* Floating Center Button */
        .nav-center .nav-icon-bg {
            background: var(--accent-gradient) !important;
            box-shadow: 0 8px 25px rgba(14, 165, 233, 0.4) !important;
            transform: translateY(-5px);
            border: 4px solid var(--bg-dark);
        }

        /* === PREMIUM FEED CARD === */
        .post-card {
            background: var(--glass-card) !important;
            backdrop-filter: blur(12px) !important;
            border: 1px solid var(--glass-border) !important;
            border-radius: 24px !important;
            box-shadow: 0 8px 30px rgba(0,0,0,0.2) !important;
            margin-bottom: 20px !important;
            overflow: visible !important; /* Allow popups */
            transition: transform 0.2s;
        }
        .post-card:active { transform: scale(0.99); }

        .post-header {
            border-bottom: 1px solid rgba(255,255,255,0.03) !important;
            padding: 16px !important;
        }

        .post-avatar {
            width: 44px !important; 
            height: 44px !important;
            border: 2px solid rgba(255,255,255,0.1);
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
        }

        .post-author {
            font-size: 15px !important;
            letter-spacing: 0.3px;
            color: #ffffff !important;
        }

        .post-time {
            font-size: 11px !important;
            opacity: 0.6;
        }

        .post-content {
            font-size: 15px !important;
            line-height: 1.6 !important;
            color: #e2e8f0 !important;
            padding: 16px !important;
            font-weight: 400;
        }

        .post-image-container {
            background: black;
            margin: 0;
            width: 100%;
        }

        /* Modern Action Buttons */
        .post-actions {
            border-top: 1px solid rgba(255,255,255,0.03) !important;
            padding: 8px 16px !important;
            background: rgba(0,0,0,0.1);
            border-radius: 0 0 24px 24px;
        }

        .action-btn {
            border-radius: 12px !important;
            padding: 10px 16px !important;
            background: transparent;
            font-weight: 600 !important;
            letter-spacing: 0.5px;
            color: #94a3b8 !important;
        }
        .action-btn:hover {
            background: rgba(255,255,255,0.05) !important;
            color: white !important;
        }
        .action-btn.liked {
            color: #f472b6 !important;
            background: rgba(244, 114, 182, 0.1) !important;
        }

        /* === POST CREATOR REDESIGN === */
        .post-creator {
            background: linear-gradient(145deg, rgba(30,41,59,0.8), rgba(15,23,42,0.8)) !important;
            border: 1px solid rgba(56, 189, 248, 0.2) !important;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3) !important;
        }
        .post-input {
            background: rgba(0,0,0,0.3) !important;
            border: 1px solid rgba(255,255,255,0.05) !important;
            border-radius: 16px !important;
            font-size: 14px;
            transition: 0.3s;
        }
        .post-input:focus {
            background: rgba(0,0,0,0.5) !important;
            border-color: var(--accent) !important;
        }
        .mood-chip {
            background: rgba(255,255,255,0.05) !important;
            border: 1px solid rgba(255,255,255,0.1) !important;
            backdrop-filter: blur(5px);
        }
        .mood-chip.active {
            background: var(--accent-gradient) !important;
            border-color: transparent !important;
            box-shadow: 0 4px 12px rgba(14, 165, 233, 0.4);
        }

        /* === REACTIONS POPUP STYLE === */
        .reaction-wrapper { position: relative; display: inline-block; flex: 1; }
        .reaction-box {
            display: none; 
            position: absolute; 
            bottom: 50px; 
            left: 0; 
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            padding: 8px 12px; 
            border-radius: 50px; 
            box-shadow: 0 10px 40px rgba(0,0,0,0.4); 
            gap: 12px; 
            z-index: 100; 
            animation: popUp 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            border: 1px solid rgba(0,0,0,0.1);
        }
        .reaction-wrapper:hover .reaction-box { display: flex; }
        
        .react-emoji { font-size: 26px; cursor: pointer; transition: transform 0.2s; user-select: none; }
        .react-emoji:hover { transform: scale(1.4) translateY(-8px); }
        
        @keyframes popUp { from { transform: scale(0) translateY(10px); opacity: 0; } to { transform: scale(1) translateY(0); opacity: 1; } }

        /* Colors for Active States */
        .react-active-like { color: #3b82f6 !important; text-shadow: 0 0 10px rgba(59,130,246,0.4); } 
        .react-active-love { color: #ef4444 !important; text-shadow: 0 0 10px rgba(239,68,68,0.4); }
        .react-active-haha, .react-active-wow, .react-active-sad { color: #f59e0b !important; }
        .react-active-angry { color: #dc2626 !important; }
        
        .post-actions { overflow: visible !important; }
    </style>

    <link rel="icon" type="image/png" href="https://i.imgur.com/7D8u8h6.png">
    <link rel="apple-touch-icon" href="https://i.imgur.com/7D8u8h6.png">
    <link rel="manifest" href="manifest.json">
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;900&family=Comic+Neue:wght@700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-messaging.js"></script>
    
    <script src="https://pl28660488.effectivegatecpm.com/9b/f5/85/9bf585b6ee39cb9b515e2fae1fa958c2.js"></script>
    <script src="https://pl28660496.effectivegatecpm.com/a6/64/bf/a664bf7e7084386b4f4b428590030df3.js"></script>
</head>
<body>

<div id="splash-screen">
    <div class="splash-logo">RB<span>LIVE</span></div>
    <div class="splash-loader"></div>
</div>

<div id="customToast">
    <i data-lucide="info" class="toast-icon"></i>
    <span class="toast-msg" id="toastMsg">Notification!</span>
</div>

<div id="customConfirmModal">
    <div class="conf-content">
        <i data-lucide="alert-circle" style="width: 40px; height: 40px; color: var(--gold); margin-bottom: 15px;"></i>
        <h3 class="conf-title" id="confTitle">Confirm Action</h3>
        <p class="conf-msg" id="confMsg">Are you sure you want to proceed?</p>
        <div class="conf-actions">
            <button class="btn-conf-no" onclick="closeCustomConfirm()">CANCEL</button>
            <button class="btn-conf-yes" id="confYesBtn">CONFIRM</button>
        </div>
    </div>
</div>

<div id="installGate">
    <div class="gate-logo">RB<span>LIVE</span></div>
    <div class="gate-title">Install to Play</div>
    <p class="gate-desc">To access the full Radio Bingo experience, you must install the official App.</p>
    <button id="gateInstallBtn" class="gate-btn-install" onclick="triggerInstall()">
        <i data-lucide="download-cloud" style="width:20px; height:20px;"></i> INSTALL APP
    </button>
</div>

<div id="notifBlocker">
    <div class="notif-gate-icon">
        <i data-lucide="bell-ring" style="width: 40px; height: 40px; color: #3b82f6;"></i>
    </div>
    <div class="notif-gate-title">ENABLE NOTIFICATIONS</div>
    <p class="notif-gate-desc">To ensure fairness and real-time updates for Bingo Calls, this app requires push notifications to be enabled.</p>
    <button onclick="requestGatePermission()" class="btn-allow-notif">
        <i data-lucide="check-circle" style="width:20px"></i> ALLOW NOTIFICATIONS
    </button>
    <div id="blockedHelp" class="blocked-help">
        <strong style="color:var(--danger); display:block; margin-bottom:5px;">‚ö†Ô∏è NOTIFICATIONS ARE BLOCKED!</strong>
        1. Click the <b>Lock Icon üîí</b> or <b>Settings Icon</b> beside the URL bar.<br>
        2. Click <b>Permissions</b> or <b>Site Settings</b>.<br>
        3. Find <b>Notifications</b> and set to <b>Allow</b>.<br>
        4. Reload this page.
    </div>
</div>

<div id="loginOverlay">
    <div class="login-bg-blob blob-1"></div>
    <div class="login-bg-blob blob-2"></div>
    <div class="login-app-container">
        <div class="app-logo-lg">RB<span>LIVE</span></div>
        <p class="app-tagline">The ultimate live bingo experience.<br>Play, Win, and Redeem Rewards.</p>
        <div class="promo-badge">
            <i data-lucide="gift" style="width:16px"></i> 
            <span>Register now & Get 500 Free RB Coins</span>
        </div>
        <div class="auth-btn-group">
            <button class="btn-main-auth" onclick="login()">
                <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/action/google.svg" alt="Google" style="width:20px">
                Sign in with Google
            </button>
        </div>
    </div>
    <div class="login-footer-legal">
        <div class="legal-text">
            <span>‚ö†Ô∏è DISCLAIMER: NOT A GAMBLING SITE</span>
            <span style="opacity: 0.6; font-size: 9px;">For entertainment purposes only. No real money betting.</span>
        </div>
    </div>
</div>

<div class="nav">
    <div style="display:flex; align-items:center; gap:10px;">
        <span style="font-weight: 900; font-size: 20px; text-shadow: 0 2px 5px rgba(0,0,0,0.8); letter-spacing:-1px;">RB <span style="color:var(--accent-glow)">LIVE</span></span>
    </div>
    <div id="userPanel" style="display:none; align-items: center; gap: 10px;">
        <div class="user-stats">
            <div class="icon-btn" onclick="openSearch()">
                <i data-lucide="search" style="width:20px"></i>
            </div>
            <div class="icon-btn" onclick="openNotifs()">
                <i data-lucide="bell" style="width:20px"></i>
                <span id="notifDot" class="notif-badge"></span>
            </div>
            <div class="points-badge" onclick="window.location.href='store.html'"><i data-lucide="coins" style="width:18px"></i> <span id="userPoints">0</span></div>
        </div>
        <img id="userImg" onclick="document.getElementById('menuModal').style.display='flex'" src="" style="border:2px solid var(--accent); box-shadow:0 0 10px var(--accent);">
    </div>
</div>

<div class="disclaimer"><div class="marquee-content">‚ö†Ô∏è DISCLAIMER: HINDI ITO GAMBLING SITE. For ENTERTAINMENT PURPOSES lamang.</div></div>

<div class="container">
    <div class="ad-container-global">
        <script type="text/javascript">
            atOptions = { 'key' : '9bf585b6ee39cb9b515e2fae1fa958c2', 'format' : 'iframe', 'height' : 50, 'width' : 320, 'params' : {} };
        </script>
        <script type="text/javascript" src="https://pl28660488.effectivegatecpm.com/9b/f5/85/9bf585b6ee39cb9b515e2fae1fa958c2.js"></script>
    </div>

    <div id="view-home" style="display:block;">
        <div id="friendRequestsSection"></div>
        
        <div class="post-creator" id="mainPostCreator">
            <h4 style="margin:0 0 15px 0; color:white; font-size:15px; font-weight:800; display:flex; align-items:center; gap:8px;"><i data-lucide="edit-3" style="width:16px;"></i> Create Post</h4>
            <textarea id="postInput" class="post-input" placeholder="What's on your mind?"></textarea>
            
            <div class="image-preview-container" id="imgPreviewCont">
                <img id="postImgPreview" class="image-preview-img">
                <div class="btn-remove-img" onclick="removePostImage()">X</div>
            </div>

            <div style="display:flex; justify-content:space-between; align-items:center; margin-top:15px;">
                <label for="postImgInput" style="cursor:pointer; color:var(--accent-glow); font-size:12px; font-weight:700; display:flex; align-items:center; gap:5px; padding:8px 12px; background:rgba(255,255,255,0.05); border-radius:12px; transition:0.2s;">
                    <i data-lucide="image" style="width:18px;"></i> Photo
                </label>
                <input type="file" id="postImgInput" accept="image/*" style="display:none" onchange="handlePostImage(this)">
                
                <button class="btn-post" onclick="createPost()" style="background:var(--accent-gradient); box-shadow:0 4px 15px rgba(14,165,233,0.4);">POST</button>
            </div>
            
            <div class="mood-selector" style="margin-top:15px; padding-top:10px; border-top:1px solid rgba(255,255,255,0.05);">
                <div class="mood-chip" onclick="selectMood(this, 'Happy')">üòä Happy</div>
                <div class="mood-chip" onclick="selectMood(this, 'Sad')">üòî Sad</div>
                <div class="mood-chip" onclick="selectMood(this, 'Excited')">ü§© Excited</div>
                <div class="mood-chip" onclick="selectMood(this, 'Angry')">üò° Angry</div>
                <div class="mood-chip" onclick="selectMood(this, 'Chill')">üòé Chill</div>
            </div>
        </div>

        <div id="pymkSection" class="pymk-section" style="display:none;">
            <div class="pymk-title">People You May Know</div>
            <div class="pymk-scroll" id="pymkList"></div>
        </div>

        <div id="socialFeed" class="social-feed-container">
            <div style="text-align:center; padding:20px; opacity:0.5;">Loading Feed...</div>
        </div>
    </div>
</div>

<div class="bottom-nav">
    <button class="nav-item active" onclick="window.location.reload()">
        <i data-lucide="home" class="nav-icon"></i>
        <span class="nav-label">Home</span>
    </button>
    <button class="nav-item" onclick="window.location.href='bingo.html'">
        <i data-lucide="play-circle" class="nav-icon"></i>
        <span class="nav-label">Bingo</span>
    </button>
    <div class="nav-center" onclick="document.getElementById('postInput').focus()">
        <div class="nav-icon-bg"><i data-lucide="plus" style="width:28px; height:28px;"></i></div>
    </div>
    <button class="nav-item" onclick="window.location.href='store.html'">
        <i data-lucide="shopping-bag" class="nav-icon"></i>
        <span class="nav-label">Store</span>
    </button>
    <button class="nav-item" onclick="window.location.href='me.html'">
        <i data-lucide="user" class="nav-icon"></i>
        <span class="nav-label">Me</span>
    </button>
</div>

<div id="searchModal" class="search-modal-container">
    <div class="search-header">
        <button onclick="document.getElementById('searchModal').style.display='none'" style="background:none; border:none; color:white;"><i data-lucide="arrow-left"></i></button>
        <div class="search-bar-wrap">
            <i data-lucide="search" style="width:16px; opacity:0.5;"></i>
            <input type="text" id="searchInput" class="search-input" placeholder="Search users or posts..." onkeyup="handleSearch()">
        </div>
    </div>
    <div id="searchResults" class="search-results">
        <div style="text-align:center; opacity:0.5; padding:20px;">Type to search...</div>
    </div>
</div>

<div id="commentModalBackdrop" class="comment-modal-backdrop" onclick="closeComments()"></div>
<div id="commentModal" class="comment-modal">
    <div class="comment-header">
        <h3 style="margin:0; font-size:16px;">Comments</h3>
        <button onclick="closeComments()" style="background:none; border:none; color:white;"><i data-lucide="x"></i></button>
    </div>
    <div id="commentList" class="comment-list"></div>
    <form class="comment-input-area" onsubmit="event.preventDefault(); sendComment();">
        <input type="text" id="commentInput" class="comment-input" placeholder="Write a comment..." autocomplete="off">
        <button type="submit" style="background:none; border:none; color:var(--accent);"><i data-lucide="send"></i></button>
    </form>
</div>

<div id="notifModal" class="modal" onclick="this.style.display='none'">
    <div class="modal-content" onclick="event.stopPropagation()">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px; border-bottom:1px solid rgba(255,255,255,0.1); padding-bottom:15px;">
            <div style="display:flex; align-items:center; gap:10px;">
                <div style="background:rgba(255,255,255,0.1); padding:8px; border-radius:10px;"><i data-lucide="bell" style="width:20px;"></i></div>
                <h3 style="margin:0; font-size:18px;">Notifications</h3>
            </div>
            <button onclick="document.getElementById('notifModal').style.display='none'" style="background:none; border:none; color:white;"><i data-lucide="x"></i></button>
        </div>
        <div id="notifList"></div>
    </div>
</div>

<div id="userOptionsModal" class="modal" onclick="this.style.display='none'">
    <div class="modal-content" onclick="event.stopPropagation()" style="text-align:center;">
        <img id="optUserImg" style="width:60px; height:60px; border-radius:50%; border:2px solid var(--accent); margin-bottom:10px;">
        <h3 id="optUserName" style="margin:0 0 20px 0; color:white;">User</h3>
        
        <button class="user-opt-btn" onclick="window.location.href='me.html'"><i data-lucide="user"></i> View Profile</button>
        <button class="user-opt-btn" onclick="optAddFriend()"><i data-lucide="user-plus"></i> Add Friend</button>
        <button class="user-opt-btn" onclick="document.getElementById('userOptionsModal').style.display='none'"><i data-lucide="x"></i> Close</button>
    </div>
</div>

<div id="menuModal" class="modal" onclick="this.style.display='none'">
    <div class="modal-content" onclick="event.stopPropagation()">
        <div class="profile-header">
            <img id="profileImgLarge" class="profile-img-large" src="">
            <div class="profile-name-info">
                <h2 class="profile-name" id="profileNameDisplay">User Name</h2>
                <span class="profile-uid" id="profileUidDisplay">UID: ---</span>
            </div>
            <button onclick="document.getElementById('menuModal').style.display='none'" style="background:none; border:none; color:white; opacity:0.5;"><i data-lucide="x"></i></button>
        </div>
        <button onclick="auth.signOut().then(()=>location.reload())" style="width:100%; padding:14px; background:rgba(239, 68, 68, 0.1); color:var(--danger); border:1px solid rgba(239, 68, 68, 0.2); border-radius:14px; font-weight:800; margin-top:20px; cursor:pointer; display:flex; align-items:center; justify-content:center; gap:8px;">
            <i data-lucide="log-out" style="width:18px"></i> Sign Out
        </button>
    </div>
</div>

<script>
    // === INITIALIZATION & UTILS ===
    window.addEventListener('load', () => { setTimeout(hideSplash, 2000); checkNotifGate(); checkInstallGate(); loadSocialFeed(); loadPYMK(); });
    setTimeout(hideSplash, 5000);
    function hideSplash() { const ss = document.getElementById('splash-screen'); if(ss && ss.style.display !== 'none') { ss.style.opacity = '0'; setTimeout(() => ss.style.display = 'none', 800); } }
    
    function checkNotifGate() {
        const blocker = document.getElementById('notifBlocker');
        const help = document.getElementById('blockedHelp');
        if (!("Notification" in window)) { showToast("Notifications not supported on this device."); blocker.style.display = 'none'; return; }
        if (Notification.permission === "granted") { blocker.style.display = 'none'; } else if (Notification.permission === "denied") { blocker.style.display = 'flex'; help.style.display = 'block'; } else { blocker.style.display = 'flex'; help.style.display = 'none'; }
    }
    function requestGatePermission() { Notification.requestPermission().then(permission => { if (permission === "granted") { checkNotifGate(); requestNotifyPermission(); } else { checkNotifGate(); } }); }
    function showToast(msg) { const toast = document.getElementById('customToast'); document.getElementById('toastMsg').innerText = msg; toast.classList.add('show'); playSound('click'); setTimeout(() => { toast.classList.remove('show'); }, 3000); }

    let confirmCallback = null;
    function showCustomConfirm(title, msg, onYes) { document.getElementById('confTitle').innerText = title; document.getElementById('confMsg').innerText = msg; document.getElementById('customConfirmModal').style.display = 'flex'; confirmCallback = onYes; playSound('click'); }
    function closeCustomConfirm() { document.getElementById('customConfirmModal').style.display = 'none'; confirmCallback = null; }
    document.getElementById('confYesBtn').addEventListener('click', () => { if(confirmCallback) confirmCallback(); closeCustomConfirm(); });

    let deferredPrompt;
    function checkInstallGate() {
        const gate = document.getElementById('installGate');
        const isStandalone = window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone === true;
        if (isStandalone) { gate.style.display = 'none'; } else { gate.style.display = 'flex'; }
    }
    window.addEventListener('beforeinstallprompt', (e) => { e.preventDefault(); deferredPrompt = e; });
    function triggerInstall() { if (deferredPrompt) { deferredPrompt.prompt(); deferredPrompt = null; } }

    lucide.createIcons();
    const firebaseConfig = { apiKey: "AIzaSyDIAQXJ15atKJxu7PtcFL1W9JnO1N14pVs", authDomain: "radiobingo-9ac29.firebaseapp.com", databaseURL: "https://radiobingo-9ac29-default-rtdb.asia-southeast1.firebasedatabase.app", projectId: "radiobingo-9ac29", storageBucket: "radiobingo-9ac29.firebasestorage.app", messagingSenderId: "965903993397", appId: "1:965903993397:web:f6646fa05225f147eebf7c" };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database(); const auth = firebase.auth();
    let messaging; try { messaging = firebase.messaging(); } catch(e) { console.log("Messaging failed to init", e); }
    let userData = {}; 
    const sounds = { click: new Audio('https://cdn.pixabay.com/audio/2022/03/15/audio_2731885542.mp3'), pop: new Audio('https://cdn.freesound.org/previews/536/536108_1415754-lq.mp3'), win: new Audio('https://cdn.freesound.org/previews/270/270404_5123851-lq.mp3') };
    function playSound(type) { if(sounds[type]) { sounds[type].currentTime = 0; sounds[type].volume = 1.0; sounds[type].play().catch(e => console.log("Audio play error", e)); } }
    function requestNotifyPermission() { if ("Notification" in window) { Notification.requestPermission().then(permission => { if (permission === "granted" && messaging) { messaging.getToken().then((currentToken) => { if (currentToken && auth.currentUser) db.ref('users/' + auth.currentUser.uid).update({ fcmToken: currentToken }); }).catch((err) => console.log('Err token', err)); } }); } }

    function fixDate(timestamp) { if(!timestamp) return "No Date"; const d = new Date(parseInt(timestamp)); return d.toLocaleDateString('en-PH', { month: 'short', day: 'numeric' }) + " " + d.toLocaleTimeString('en-PH', { hour: '2-digit', minute: '2-digit' }); }
    function login() { playSound('click'); auth.signInWithPopup(new firebase.auth.GoogleAuthProvider()).then(() => { requestNotifyPermission(); checkNotifGate(); }); }

    auth.onAuthStateChanged(u => {
        if(u) {
            if(messaging) { messaging.getToken().then((token) => { if(token) db.ref('users/' + u.uid).update({ fcmToken: token }); }).catch((err)=>console.log(err)); messaging.onMessage((payload) => { showToast("Notification Received"); playSound('pop'); }); }
            document.getElementById('loginOverlay').style.display = 'none'; document.getElementById('userPanel').style.display = 'flex';
            document.getElementById('userImg').src = u.photoURL; document.getElementById('profileImgLarge').src = u.photoURL;
            document.getElementById('profileUidDisplay').innerText = "ID: " + u.uid.substring(0,8);
            
            const userRef = db.ref('users/'+u.uid);
            userRef.once('value', snapshot => { 
                if (!snapshot.exists()) { 
                    const newRefCode = Math.random().toString(36).substring(2, 8).toUpperCase(); 
                    userRef.set({ name: u.displayName, photo: u.photoURL, points: 500, refCode: newRefCode, last_seen: Date.now(), lastLoginDate: new Date().toDateString() }); 
                } else { 
                    const data = snapshot.val(); 
                    const updates = { last_seen: Date.now() }; 
                    if (!data.name) updates.name = u.displayName;
                    if (!data.photo) updates.photo = u.photoURL;
                    const today = new Date().toDateString(); 
                    if (data.lastLoginDate !== today) { updates.points = (data.points || 0) + 200; updates.lastLoginDate = today; showToast("üéÅ Daily Bonus! +200 RB Coins."); playSound('win'); } 
                    userRef.update(updates); 
                } 
            });
            userRef.on('value', s => { 
                if(s.exists()){ 
                    userData = s.val(); userData.uid = u.uid; 
                    document.getElementById('userPoints').innerText = (userData.points || 0).toLocaleString(); 
                    const badgeHtml = getBadgeHtml(userData.points || 0);
                    document.getElementById('profileNameDisplay').innerHTML = `${userData.name} ${badgeHtml}`;
                } 
            });
            listenNotifications(u.uid);
            loadPYMK();
            loadSocialFeed();
        } else { document.getElementById('loginOverlay').style.display = 'flex'; }
    });

    function getBadgeHtml(points) {
        let tierClass = "tier-bronze";
        if(points >= 100000) tierClass = "tier-diamond";
        else if(points >= 50000) tierClass = "tier-platinum";
        else if(points >= 25000) tierClass = "tier-gold";
        else if(points >= 10000) tierClass = "tier-silver";
        return `<span class="badge-tier ${tierClass}"><i data-lucide="badge-check" class="badge-icon"></i></span>`;
    }

    function compressImage(file, maxWidth, quality) {
        return new Promise((resolve) => {
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = (event) => {
                const img = new Image();
                img.src = event.target.result;
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    let width = img.width;
                    let height = img.height;
                    if (width > maxWidth) {
                        height *= maxWidth / width;
                        width = maxWidth;
                    }
                    canvas.width = width;
                    canvas.height = height;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, width, height);
                    resolve(canvas.toDataURL('image/jpeg', quality));
                };
            };
        });
    }

    // === SOCIAL & HOME LOGIC ===
    let selectedMood = "Happy";
    let selectedImageBase64 = null;
    let postListener = null;

    function selectMood(el, mood) {
        const isActive = el.classList.contains('active');
        document.querySelectorAll('.mood-chip').forEach(c => c.classList.remove('active'));
        if(!isActive) { el.classList.add('active'); selectedMood = mood; } else { selectedMood = null; }
    }
    
    function handlePostImage(input) {
        if(input.files && input.files[0]) {
            compressImage(input.files[0], 800, 0.7).then(base64 => {
                selectedImageBase64 = base64;
                document.getElementById('postImgPreview').src = selectedImageBase64;
                document.getElementById('imgPreviewCont').style.display = 'block';
            });
        }
    }
    
    function removePostImage() {
        selectedImageBase64 = null;
        document.getElementById('postImgInput').value = "";
        document.getElementById('imgPreviewCont').style.display = 'none';
    }

    function createPost() {
        const txt = document.getElementById('postInput').value.trim();
        if(!txt && !selectedImageBase64) return showToast("Type something or add photo!");
        const postData = {
            uid: auth.currentUser.uid,
            authorName: userData.name,
            authorPhoto: userData.photo,
            authorPoints: userData.points, 
            content: txt,
            mood: selectedMood,
            image: selectedImageBase64,
            timestamp: Date.now(),
            likes: 0
        };
        db.ref('socialPosts').push(postData);
        document.getElementById('postInput').value = "";
        removePostImage();
        document.querySelectorAll('.mood-chip').forEach(c => c.classList.remove('active'));
        selectedMood = null;
        showToast("Posted!");
        playSound('pop');
    }

    function loadSocialFeed() {
        const feedContainer = document.getElementById('socialFeed');
        if(postListener) return; 
        feedContainer.innerHTML = "<div style='text-align:center; padding:20px; opacity:0.5;'>Loading Feed...</div>";
        db.ref('friends/' + auth.currentUser.uid).once('value', fSnap => {
            const myFriends = fSnap.exists() ? Object.keys(fSnap.val()) : [];
            postListener = db.ref('socialPosts').limitToLast(50);
            postListener.on('value', pSnap => {
                const allPosts = [];
                pSnap.forEach(child => { allPosts.push({ key: child.key, ...child.val() }); });
                allPosts.sort((a, b) => b.timestamp - a.timestamp);
                feedContainer.innerHTML = "";
                if(allPosts.length === 0) {
                    feedContainer.innerHTML = "<div style='text-align:center; padding:20px; opacity:0.5;'>No posts yet. Be the first!</div>";
                    return;
                }
                let adCounter = 0;
                allPosts.forEach(post => {
                    const isFriend = myFriends.includes(post.uid);
                    const isMe = post.uid === auth.currentUser.uid;
                    const friendBadge = (isFriend || isMe) ? `<span class="friend-badge">${isMe ? 'YOU' : 'FRIEND'}</span>` : '';
                    const postDiv = document.createElement('div');
                    postDiv.className = 'post-card';
                    postDiv.id = 'post-' + post.key;
                    
                    const moodHtml = post.mood ? `<div class="mood-display">Feeling ${post.mood}</div>` : '';
                    const imgHtml = post.image ? `<div class="post-image-container"><img src="${post.image}" class="post-image"></div>` : '';
                    
                    // REACTION LOGIC
                    const myReaction = post.reactions ? post.reactions[auth.currentUser.uid] : null;
                    let reactIcon = '<i data-lucide="thumbs-up" style="width:14px;"></i> Like';
                    let reactClass = '';

                    if(myReaction === 'love') { reactIcon = '‚ù§Ô∏è Love'; reactClass = 'react-active-love'; }
                    else if(myReaction === 'haha') { reactIcon = 'üòÇ Haha'; reactClass = 'react-active-haha'; }
                    else if(myReaction === 'wow') { reactIcon = 'üòÆ Wow'; reactClass = 'react-active-wow'; }
                    else if(myReaction === 'sad') { reactIcon = 'üò¢ Sad'; reactClass = 'react-active-sad'; }
                    else if(myReaction === 'angry') { reactIcon = 'üò° Angry'; reactClass = 'react-active-angry'; }
                    else if(myReaction === 'like') { reactIcon = 'üëç Like'; reactClass = 'react-active-like'; }

                    postDiv.innerHTML = `
                        <div class="post-header">
                            <img class="post-avatar" src="${post.authorPhoto}">
                            <div class="post-meta">
                                <div class="post-author">${post.authorName} ${getBadgeHtml(post.authorPoints || 0)} ${friendBadge}</div>
                                <div class="post-time">${fixDate(post.timestamp)}</div>
                                ${moodHtml}
                            </div>
                        </div>
                        <div class="post-content">${post.content}</div>
                        ${imgHtml}
                        
                        <div class="post-actions" style="overflow:visible;">
                            <div class="reaction-wrapper" style="flex:1;">
                                <div class="reaction-box">
                                    <div class="react-emoji" onclick="submitReaction('${post.key}', 'like')">üëç</div>
                                    <div class="react-emoji" onclick="submitReaction('${post.key}', 'love')">‚ù§Ô∏è</div>
                                    <div class="react-emoji" onclick="submitReaction('${post.key}', 'haha')">üòÇ</div>
                                    <div class="react-emoji" onclick="submitReaction('${post.key}', 'wow')">üòÆ</div>
                                    <div class="react-emoji" onclick="submitReaction('${post.key}', 'sad')">üò¢</div>
                                    <div class="react-emoji" onclick="submitReaction('${post.key}', 'angry')">üò°</div>
                                </div>
                                <button class="action-btn ${reactClass}" id="react-btn-${post.key}" onclick="submitReaction('${post.key}', 'like')">
                                    <span id="react-icon-${post.key}">${reactIcon}</span> 
                                    <span style="margin-left:5px; opacity:0.6;" id="react-count-${post.key}">${post.reactCount || 0}</span>
                                </button>
                            </div>
                            <button class="action-btn" onclick="openComments('${post.key}')">
                                <i data-lucide="message-circle" style="width:14px"></i> Comment
                            </button>
                        </div>
                    `;
                    feedContainer.appendChild(postDiv);
                    adCounter++;
                    if(adCounter % 5 === 0) {
                         const adDiv = document.createElement('div');
                         adDiv.className = 'ad-container-global';
                         adDiv.style.margin = '15px auto';
                         adDiv.innerHTML = `<script type="text/javascript">atOptions = { 'key' : '59f94c5cb7bcd84edb277947774c3b9d', 'format' : 'iframe', 'height' : 50, 'width' : 320, 'params' : {} };<\/script><script type="text/javascript" src="https://directoryeditorweep.com/59f94c5cb7bcd84edb277947774c3b9d/invoke.js"><\/script>`;
                         feedContainer.appendChild(adDiv);
                    }
                });
                lucide.createIcons();
            });
        });
        
        // Init Friend Requests
        db.ref('friendRequests/' + auth.currentUser.uid).on('value', s => {
            const container = document.getElementById('friendRequestsSection');
            container.innerHTML = "";
            s.forEach(req => {
                const requesterId = req.key;
                db.ref('users/' + requesterId).once('value', u => {
                    const uData = u.val();
                    const div = document.createElement('div');
                    div.className = 'friend-req-card';
                    div.innerHTML = `<div class="req-info"><img src="${uData.photo}" style="width:30px;height:30px;border-radius:50%;"><span style="font-weight:700; font-size:12px; color:white;">${uData.name} wants to be friends</span></div><div class="req-actions"><button class="btn-accept" onclick="acceptFriend('${requesterId}')">Accept</button><button class="btn-decline" onclick="declineFriend('${requesterId}')">X</button></div>`;
                    container.appendChild(div);
                });
            });
        });
    }

    function submitReaction(postKey, type) {
        const myUid = auth.currentUser.uid;
        const postRef = db.ref('socialPosts/' + postKey);
        const userReactRef = db.ref('socialPosts/' + postKey + '/reactions/' + myUid);
        
        userReactRef.once('value', snapshot => {
            const currentReact = snapshot.val();
            
            if (currentReact === type) {
                userReactRef.remove();
                postRef.child('reactCount').transaction(c => (c || 1) - 1);
                updateReactUI(postKey, null);
            } else {
                userReactRef.set(type);
                if (!currentReact) {
                    postRef.child('reactCount').transaction(c => (c || 0) + 1);
                }
                updateReactUI(postKey, type);
                showToast("Reacted: " + type.toUpperCase());
                playSound('pop');
            }
        });
    }

    function updateReactUI(key, type) {
        const btn = document.getElementById('react-btn-' + key);
        const iconSpan = document.getElementById('react-icon-' + key);
        
        btn.className = "action-btn"; 
        
        if(!type) {
            iconSpan.innerHTML = '<i data-lucide="thumbs-up" style="width:14px;"></i> Like';
            lucide.createIcons();
        }
        else if(type === 'like') { iconSpan.innerHTML = 'üëç Like'; btn.classList.add('react-active-like'); }
        else if(type === 'love') { iconSpan.innerHTML = '‚ù§Ô∏è Love'; btn.classList.add('react-active-love'); }
        else if(type === 'haha') { iconSpan.innerHTML = 'üòÇ Haha'; btn.classList.add('react-active-haha'); }
        else if(type === 'wow') { iconSpan.innerHTML = 'üòÆ Wow'; btn.classList.add('react-active-wow'); }
        else if(type === 'sad') { iconSpan.innerHTML = 'üò¢ Sad'; btn.classList.add('react-active-sad'); }
        else if(type === 'angry') { iconSpan.innerHTML = 'üò° Angry'; btn.classList.add('react-active-angry'); }
    }
    
    function loadPYMK() {
        if(!auth.currentUser) return;
        const list = document.getElementById('pymkList');
        const container = document.getElementById('pymkSection');
        db.ref('users').limitToLast(20).once('value', s => {
            db.ref('friends/' + auth.currentUser.uid).once('value', fSnap => {
                const friends = fSnap.exists() ? Object.keys(fSnap.val()) : [];
                friends.push(auth.currentUser.uid);
                const candidates = [];
                s.forEach(uSnap => { if(!friends.includes(uSnap.key)) candidates.push({ uid: uSnap.key, ...uSnap.val() }); });
                const shuffled = candidates.sort(() => 0.5 - Math.random()).slice(0, 5);
                if(shuffled.length > 0) {
                    list.innerHTML = "";
                    shuffled.forEach(u => {
                        const div = document.createElement('div'); div.className = 'pymk-card';
                        div.innerHTML = `<img src="${u.photo || 'https://via.placeholder.com/60'}" class="pymk-img"><div class="pymk-name">${u.name}</div><button class="btn-add-friend-sm" onclick="sendFriendReqPYMK('${u.uid}')">ADD</button>`;
                        list.appendChild(div);
                    });
                    container.style.display = 'block';
                } else { container.style.display = 'none'; }
            });
        });
    }

    function sendFriendReqPYMK(uid) { db.ref('friendRequests/' + uid + '/' + auth.currentUser.uid).set(true); showToast("Request Sent!"); loadPYMK(); }
    function acceptFriend(requesterUid) {
        const myUid = auth.currentUser.uid;
        db.ref('friends/' + myUid + '/' + requesterUid).set(true);
        db.ref('friends/' + requesterUid + '/' + myUid).set(true);
        db.ref('friendRequests/' + myUid + '/' + requesterUid).remove();
        showToast("You are now friends!");
    }
    function declineFriend(requesterUid) { db.ref('friendRequests/' + auth.currentUser.uid + '/' + requesterUid).remove(); }
    
    // === NOTIFICATIONS ===
    function listenNotifications(uid) { 
        db.ref('notifications/' + uid).on('value', s => { 
            const dot = document.getElementById('notifDot'); 
            if(s.exists()) dot.style.display = 'block'; else dot.style.display = 'none';
        }); 
    }
    function openNotifs() { document.getElementById('notifModal').style.display='flex'; playSound('click'); renderNotifs(); }
    function renderNotifs() { 
        const list = document.getElementById('notifList'); 
        db.ref('notifications/' + auth.currentUser.uid).once('value', s => { 
            list.innerHTML = ""; 
            let hasSystem = false;
            s.forEach(n => { 
                const val = n.val(); 
                if(val.type === 'pm') return;
                hasSystem = true;
                const div = document.createElement('div'); div.className = 'notif-card-new'; 
                div.innerHTML = `<div class="notif-header-new"><div class="notif-title"><i data-lucide="info" style="width:14px"></i> SYSTEM MSG</div></div><div class="notif-body">${val.msg}</div><div style="font-size:9px; opacity:0.4; margin-top:8px; text-align:right;">${fixDate(val.time)}</div>`; 
                list.prepend(div); 
            }); 
            if(!hasSystem) list.innerHTML = "<div style='text-align:center; opacity:0.5; padding:40px;'>No new notifications</div>";
            lucide.createIcons(); 
        }); 
    }

    // === SEARCH & COMMENTS ===
    function openSearch() { document.getElementById('searchModal').style.display = 'flex'; document.getElementById('searchInput').focus(); }
    function handleSearch() {
        const q = document.getElementById('searchInput').value.toLowerCase().trim();
        const resDiv = document.getElementById('searchResults');
        if(q.length < 2) { resDiv.innerHTML = "<div style='text-align:center; opacity:0.5; padding:20px;'>Type more to search...</div>"; return; }
        db.ref('users').once('value', s => {
            resDiv.innerHTML = ""; let found = false;
            s.forEach(uSnap => {
                const u = uSnap.val();
                if(u.name.toLowerCase().includes(q)) {
                    found = true;
                    const div = document.createElement('div'); div.className = 'search-res-item';
                    div.onclick = () => { showUserOptions(uSnap.key, u.name, u.photo); };
                    div.innerHTML = `<img src="${u.photo || 'https://via.placeholder.com/40'}" class="search-res-img"><div style="font-size:14px; font-weight:700; color:white;">${u.name}</div>`;
                    resDiv.appendChild(div);
                }
            });
            if(!found) resDiv.innerHTML = "<div style='text-align:center; opacity:0.5; padding:20px;'>No users found.</div>";
        });
    }

    let currentOpenPostKey = null;
    function openComments(postKey) {
        currentOpenPostKey = postKey;
        const list = document.getElementById('commentList');
        list.innerHTML = "<div style='text-align:center; color:white; opacity:0.5; padding:20px;'>Loading...</div>";
        document.getElementById('commentModal').style.display = 'flex';
        document.getElementById('commentModalBackdrop').style.display = 'block';
        db.ref('postComments/' + postKey).on('value', s => {
            list.innerHTML = "";
            if(!s.exists()) { list.innerHTML = "<div style='text-align:center; color:white; opacity:0.5; padding:20px;'>No comments yet.</div>"; return; }
            s.forEach(c => {
                const com = c.val();
                const div = document.createElement('div'); div.className = 'comment-item';
                div.innerHTML = `<img class="comment-avatar" src="${com.uPhoto}"><div class="comment-content-block"><div class="comment-bubble"><div class="comment-author">${com.uName}</div><div class="comment-text">${com.text}</div></div></div>`;
                list.appendChild(div);
            });
            list.scrollTop = list.scrollHeight;
        });
    }
    function closeComments() { document.getElementById('commentModal').style.display = 'none'; document.getElementById('commentModalBackdrop').style.display = 'none'; if(currentOpenPostKey) db.ref('postComments/' + currentOpenPostKey).off(); currentOpenPostKey = null; }
    function sendComment() {
        const txt = document.getElementById('commentInput').value.trim();
        if(!txt || !currentOpenPostKey) return;
        db.ref('postComments/' + currentOpenPostKey).push({ uid: auth.currentUser.uid, uName: userData.name, uPhoto: userData.photo, text: txt, time: Date.now() });
        document.getElementById('commentInput').value = "";
    }
    
    let targetUserForOpt = null;
    function showUserOptions(uid, name, photo) {
        targetUserForOpt = { uid, name, photo };
        document.getElementById('optUserImg').src = photo;
        document.getElementById('optUserName').innerText = name;
        document.getElementById('userOptionsModal').style.display = 'flex';
    }
    function optAddFriend() {
        if(!targetUserForOpt) return;
        const targetUid = targetUserForOpt.uid;
        if(targetUid === auth.currentUser.uid) { showToast("That's you!"); return; }
        db.ref('friendRequests/' + targetUid + '/' + auth.currentUser.uid).set(true);
        showToast("Friend Request Sent!");
        document.getElementById('userOptionsModal').style.display = 'none';
    }

</script>
</body>
</html>
