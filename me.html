<!DOCTYPE html>
<html lang="tl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#02040a">
    <title>Radio Bingo Live | My Profile</title>
    
    <link rel="stylesheet" href="style.css">

    <link rel="icon" type="image/png" href="https://i.imgur.com/7D8u8h6.png">
    
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
</head>
<body>

<div id="splash-screen">
    <div class="splash-logo">RB<span>LIVE</span></div>
    <div class="splash-loader"></div>
</div>

<div id="customToast">
    <i data-lucide="info" class="toast-icon"></i>
    <span class="toast-msg" id="toastMsg">Notification!</span>
</div>

<div id="customConfirmModal">
    <div class="conf-content">
        <i data-lucide="alert-triangle" style="width: 50px; height: 50px; color: var(--gold); margin-bottom: 15px;"></i>
        <h3 class="conf-title" id="confTitle">Confirm Action</h3>
        <p class="conf-msg" id="confMsg">Are you sure?</p>
        <div class="conf-actions">
            <button class="btn-conf-no" onclick="closeCustomConfirm()">CANCEL</button>
            <button class="btn-conf-yes" id="confYesBtn">CONFIRM</button>
        </div>
    </div>
</div>

<div class="bottom-nav">
    <button class="nav-item" onclick="window.location.href='index.html'">
        <i data-lucide="home" class="nav-icon"></i>
        <span class="nav-label">Home</span>
    </button>
    <button class="nav-item" onclick="window.location.href='bingo.html'">
        <i data-lucide="play-circle" class="nav-icon"></i>
        <span class="nav-label">Bingo</span>
    </button>
    <div class="nav-center" onclick="window.location.href='index.html'">
        <div class="nav-icon-bg"><i data-lucide="plus" style="width:28px; height:28px;"></i></div>
    </div>
    <button class="nav-item" onclick="window.location.href='store.html'">
        <i data-lucide="shopping-bag" class="nav-icon"></i>
        <span class="nav-label">Store</span>
    </button>
    <button class="nav-item active" onclick="window.location.reload()">
        <i data-lucide="user" class="nav-icon"></i>
        <span class="nav-label">Me</span>
    </button>
</div>

<div class="container" style="padding:0;">
    
    <div class="profile-cover" id="pageProfileCover"></div>
    
    <div class="profile-info-section">
        <div class="profile-header-row" style="display: flex; justify-content: space-between; align-items: flex-end;">
            <img id="pageProfileImg" class="profile-page-img" src="">
            <button onclick="openEditProfile()" style="margin-bottom: 10px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); padding: 8px 16px; border-radius: 20px; color: white; font-size: 12px; font-weight: 700; cursor: pointer;">
                Edit Profile
            </button>
        </div>
        
        <h2 id="pageProfileName" class="profile-page-name">User Name</h2>
        <p id="pageProfileBio" class="profile-page-bio" style="color:var(--text-muted); font-size:14px; margin-top:0;">Radio Bingo Player</p>
        
        <div class="glass-panel" style="padding: 15px; display: flex; justify-content: space-around; text-align: center; margin: 20px 0;">
            <div>
                <div class="stat-val" id="statFriends" style="font-size:18px; font-weight:800; color:white;">0</div>
                <div class="stat-lbl" style="font-size:10px; color:var(--text-muted); text-transform:uppercase;">Friends</div>
            </div>
            <div style="width:1px; background:rgba(255,255,255,0.1);"></div>
            <div>
                <div class="stat-val" id="statLikes" style="font-size:18px; font-weight:800; color:white;">0</div>
                <div class="stat-lbl" style="font-size:10px; color:var(--text-muted); text-transform:uppercase;">Likes</div>
            </div>
            <div style="width:1px; background:rgba(255,255,255,0.1);"></div>
             <div>
                <div class="stat-val" id="statPosts" style="font-size:18px; font-weight:800; color:white;">0</div>
                <div class="stat-lbl" style="font-size:10px; color:var(--text-muted); text-transform:uppercase;">Posts</div>
            </div>
        </div>

        <button class="btn-main-auth" onclick="window.location.href='store.html'" style="width:100%; margin-bottom:30px;">
            <i data-lucide="wallet" style="width:18px"></i> OPEN MY WALLET & REWARDS
        </button>
        
        <div class="section-title"><i data-lucide="grid" style="width:14px"></i> My Feed</div>
        <div id="pageProfileFeed" class="profile-feed-section">
            <div style="text-align:center; padding:40px; color:var(--text-muted); font-size:12px;">Loading posts...</div>
        </div>

        <div class="glass-panel" style="padding: 20px; margin-top: 40px; border-color: rgba(239, 68, 68, 0.3);">
            <div class="section-title" style="margin-top:0; color:var(--danger);"><i data-lucide="shield-alert" style="width:14px"></i> Account Settings</div>
            
            <button class="btn-logout" onclick="performLogout()">
                <i data-lucide="log-out" style="width:18px"></i> LOG OUT
            </button>
            
            <button class="btn-delete-acc" onclick="confirmDeleteAccount()">
                <i data-lucide="trash-2" style="width:18px"></i> DELETE ACCOUNT
            </button>
        </div>
        
        <div style="margin-top:20px; text-align:center; opacity:0.4; font-size:10px; padding-bottom:20px;">
            Radio Bingo Live v6.0<br>
            <a href="#" style="color:white; text-decoration:none;">Privacy Policy</a> &bull; <a href="#" style="color:white; text-decoration:none;">Terms</a>
        </div>
    </div>
</div>

<div id="editProfileModal" class="modal" onclick="this.style.display='none'">
    <div class="modal-content" onclick="event.stopPropagation()">
        <h3 style="margin-top:0; color:white; font-size:18px; font-weight:800; display:flex; align-items:center; gap:8px;">
            <i data-lucide="edit-3" style="width:18px; color:var(--primary);"></i> Edit Profile
        </h3>
        
        <label class="edit-label" style="display:block; margin-bottom:5px; font-size:12px; color:var(--text-muted);">Display Name</label>
        <input type="text" id="editNameIn" class="styled-input" placeholder="Your Name" style="margin-bottom:15px;">
        
        <label class="edit-label" style="display:block; margin-bottom:5px; font-size:12px; color:var(--text-muted);">Bio</label>
        <input type="text" id="editBioIn" class="styled-input" placeholder="Short bio..." style="margin-bottom:15px;">
        
        <div style="display:flex; gap:10px; margin-top:10px;">
            <div style="flex:1;">
                <label class="edit-label" style="font-size:12px;">Profile Pic</label>
                <label for="editProfilePicInput" style="display:block; background:rgba(255,255,255,0.05); padding:15px; text-align:center; border-radius:12px; cursor:pointer; border:1px dashed rgba(255,255,255,0.2); margin-top:5px;">
                    <i data-lucide="camera" style="width:16px; margin-bottom:5px;"></i><br>
                    <span style="font-size:10px;">Change</span>
                </label>
                <input type="file" id="editProfilePicInput" style="display:none;" accept="image/*" onchange="handleProfileUpload(this, 'pfp')">
            </div>
            <div style="flex:1;">
                <label class="edit-label" style="font-size:12px;">Cover Photo</label>
                <label for="editCoverPicInput" style="display:block; background:rgba(255,255,255,0.05); padding:15px; text-align:center; border-radius:12px; cursor:pointer; border:1px dashed rgba(255,255,255,0.2); margin-top:5px;">
                    <i data-lucide="image" style="width:16px; margin-bottom:5px;"></i><br>
                    <span style="font-size:10px;">Change</span>
                </label>
                <input type="file" id="editCoverPicInput" style="display:none;" accept="image/*" onchange="handleProfileUpload(this, 'cover')">
            </div>
        </div>

        <button onclick="saveProfileChanges()" style="width:100%; padding:15px; background:var(--primary); border:none; border-radius:12px; font-weight:900; color:white; cursor:pointer; margin-top:20px; box-shadow:0 5px 20px rgba(59,130,246,0.4);">SAVE CHANGES</button>
    </div>
</div>

<script>
    // === INITIALIZATION ===
    window.addEventListener('load', () => { lucide.createIcons(); setTimeout(hideSplash, 1500); });
    function hideSplash() { const ss = document.getElementById('splash-screen'); if(ss) { ss.style.opacity='0'; setTimeout(()=>ss.style.display='none',800); }}
    
    const firebaseConfig = { apiKey: "AIzaSyDIAQXJ15atKJxu7PtcFL1W9JnO1N14pVs", authDomain: "radiobingo-9ac29.firebaseapp.com", databaseURL: "https://radiobingo-9ac29-default-rtdb.asia-southeast1.firebasedatabase.app", projectId: "radiobingo-9ac29", storageBucket: "radiobingo-9ac29.firebasestorage.app", messagingSenderId: "965903993397", appId: "1:965903993397:web:f6646fa05225f147eebf7c" };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database(); const auth = firebase.auth();
    let userData = {};

    const sounds = { click: new Audio('https://cdn.pixabay.com/audio/2022/03/15/audio_2731885542.mp3') };
    function playSound(type) { if(sounds[type]) { sounds[type].currentTime = 0; sounds[type].volume = 1.0; sounds[type].play().catch(e => console.log(e)); } }
    function showToast(msg) { const toast = document.getElementById('customToast'); document.getElementById('toastMsg').innerText = msg; toast.classList.add('show'); playSound('click'); setTimeout(() => { toast.classList.remove('show'); }, 3000); }
    function fixDate(timestamp) { if(!timestamp) return "Just now"; const d = new Date(parseInt(timestamp)); return d.toLocaleDateString('en-PH', { month: 'short', day: 'numeric' }) + " " + d.toLocaleTimeString('en-PH', { hour: '2-digit', minute: '2-digit' }); }

    let confirmCallback = null;
    function showCustomConfirm(title, msg, onYes) { document.getElementById('confTitle').innerText = title; document.getElementById('confMsg').innerText = msg; document.getElementById('customConfirmModal').style.display = 'flex'; confirmCallback = onYes; playSound('click'); }
    function closeCustomConfirm() { document.getElementById('customConfirmModal').style.display = 'none'; confirmCallback = null; }
    document.getElementById('confYesBtn').addEventListener('click', () => { if(confirmCallback) confirmCallback(); closeCustomConfirm(); });

    // === AUTH & DATA LOADING ===
    auth.onAuthStateChanged(u => {
        if(u) {
            const userRef = db.ref('users/'+u.uid);
            userRef.on('value', s => { 
                if(s.exists()){ 
                    userData = s.val(); userData.uid = u.uid; 
                    renderProfile(userData);
                } 
            });
            loadProfilePosts(u.uid);
        } else {
            window.location.href = 'index.html';
        }
    });

    function getBadgeHtml(points) {
        let tierClass = "tier-bronze";
        if(points >= 100000) tierClass = "tier-diamond";
        else if(points >= 50000) tierClass = "tier-platinum";
        else if(points >= 25000) tierClass = "tier-gold";
        else if(points >= 10000) tierClass = "tier-silver";
        return `<span class="badge-tier ${tierClass}" style="margin-left:5px;"><i data-lucide="badge-check" class="badge-icon" style="width:16px; color:var(--primary-glow);"></i></span>`;
    }

    function renderProfile(u) {
        document.getElementById('pageProfileImg').src = u.photo || 'https://via.placeholder.com/100';
        document.getElementById('pageProfileName').innerHTML = `${u.name} ${getBadgeHtml(u.points || 0)}`;
        document.getElementById('pageProfileBio').innerText = u.bio || "Radio Bingo Player";
        
        if(u.cover) {
            document.getElementById('pageProfileCover').style.backgroundImage = `url('${u.cover}')`;
        } else {
            document.getElementById('pageProfileCover').style.background = '#334155';
            document.getElementById('pageProfileCover').style.backgroundImage = 'none';
        }
        
        db.ref('friends/' + u.uid).once('value', fSnap => {
            document.getElementById('statFriends').innerText = fSnap.numChildren() || 0;
        });
        
        document.getElementById('editNameIn').value = u.name;
        document.getElementById('editBioIn').value = u.bio || "";
    }

    // === EDIT PROFILE LOGIC ===
    function openEditProfile() { document.getElementById('editProfileModal').style.display = 'flex'; }
    
    function compressImage(file, maxWidth, quality) {
        return new Promise((resolve) => {
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = (event) => {
                const img = new Image();
                img.src = event.target.result;
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    let width = img.width;
                    let height = img.height;
                    if (width > maxWidth) { height *= maxWidth / width; width = maxWidth; }
                    canvas.width = width; canvas.height = height;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, width, height);
                    resolve(canvas.toDataURL('image/jpeg', quality));
                };
            };
        });
    }

    function handleProfileUpload(input, type) {
        if(input.files && input.files[0]) {
            const maxWidth = type === 'cover' ? 1200 : 500;
            compressImage(input.files[0], maxWidth, 0.7).then(base64 => {
                input.dataset.b64 = base64;
                showToast("Image ready! Click Save.");
            });
        }
    }

    function saveProfileChanges() {
        const newName = document.getElementById('editNameIn').value.trim();
        const newBio = document.getElementById('editBioIn').value.trim();
        const pfpInput = document.getElementById('editProfilePicInput');
        const coverInput = document.getElementById('editCoverPicInput');
        
        if(newName.length < 2) return showToast("Name too short");
        
        const updates = { name: newName, bio: newBio };
        if(pfpInput.dataset.b64) updates.photo = pfpInput.dataset.b64;
        if(coverInput.dataset.b64) updates.cover = coverInput.dataset.b64;
        
        db.ref('users/' + auth.currentUser.uid).update(updates).then(() => {
            showToast("Profile Updated!");
            document.getElementById('editProfileModal').style.display = 'none';
            pfpInput.value = ""; delete pfpInput.dataset.b64;
            coverInput.value = ""; delete coverInput.dataset.b64;
        });
    }

    // === MY POSTS (Updated to Match Home Feed Design) ===
    function loadProfilePosts(uid) {
        const container = document.getElementById('pageProfileFeed');
        db.ref('socialPosts').orderByChild('uid').equalTo(uid).limitToLast(20).on('value', pSnap => {
            container.innerHTML = "";
            let count = 0; let likes = 0; const posts = [];
            pSnap.forEach(c => { const p = c.val(); posts.push({ key: c.key, ...p }); count++; likes += (p.likes || 0); });
            
            document.getElementById('statPosts').innerText = count;
            document.getElementById('statLikes').innerText = likes;
            
            posts.reverse().forEach(post => {
                 const postDiv = document.createElement('div'); 
                 postDiv.className = 'post-card';
                 const imgHtml = post.image ? `<div class="post-image-container"><img src="${post.image}" class="post-image"></div>` : '';
                 
                 // Using same structure as Home Feed
                 postDiv.innerHTML = `
                    <div class="post-header">
                        <img class="post-avatar" src="${post.authorPhoto}">
                        <div class="post-meta" style="flex:1;">
                            <div class="post-author">${post.authorName}</div>
                            <div class="post-time">${fixDate(post.timestamp)}</div>
                        </div>
                    </div>
                    <div class="post-content">${post.content}</div>
                    ${imgHtml}
                    <div class="post-actions">
                        <button class="action-btn"><i data-lucide="heart" style="width:16px;"></i> ${post.likes || 0}</button>
                        <button class="action-btn"><i data-lucide="message-circle" style="width:16px;"></i></button>
                    </div>
                `;
                 container.appendChild(postDiv);
            });
            if(count === 0) container.innerHTML = "<div style='color:white; opacity:0.5; font-size:12px; text-align:center; padding:20px;'>No posts yet.</div>";
            lucide.createIcons();
        });
    }

    // === ACCOUNT SETTINGS ===
    function performLogout() {
        showCustomConfirm("Log Out", "Are you sure you want to log out?", () => {
            auth.signOut().then(() => {
                window.location.href = 'index.html';
            });
        });
    }

    function confirmDeleteAccount() {
        showCustomConfirm("DELETE ACCOUNT", "This action is PERMANENT. All your data, coins, and skins will be lost. Continue?", () => {
             const user = auth.currentUser;
             const uid = user.uid;
             
             // First, remove user data from Database
             db.ref('users/' + uid).remove()
             .then(() => {
                 // Then delete the auth account
                 user.delete().then(() => {
                     alert("Account deleted.");
                     window.location.href = 'index.html';
                 }).catch((error) => {
                     showToast("Error: Re-login required");
                 });
             })
             .catch((error) => {
                 showToast("Error deleting data");
             });
        });
    }
</script>
</body>
</html>
