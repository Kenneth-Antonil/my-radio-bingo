<!DOCTYPE html>
<html lang="tl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#020617">
    <title>Radio Bingo Live | My Profile</title>
    
    <link rel="stylesheet" href="style.css">

    <link rel="icon" type="image/png" href="https://i.imgur.com/7D8u8h6.png">
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>

    <style>
        /* Specific overrides for the Me page to make it scrollable/full page */
        body { background: #020617; padding-bottom: 80px; }
        .profile-page-container { position: relative; z-index: 1; display: flex; background: transparent; padding-bottom: 0; }
        .section-header { font-size: 12px; font-weight: 800; color: var(--accent-glow); text-transform: uppercase; margin: 20px 0 10px 0; display: flex; align-items: center; gap: 5px; }
        .settings-card { background: rgba(30, 41, 59, 0.5); border: 1px solid rgba(255,255,255,0.05); border-radius: 16px; padding: 15px; margin-bottom: 10px; }
    </style>
</head>
<body>

<div class="bottom-nav">
    <button class="nav-item" onclick="window.location.href='index.html'">
        <i data-lucide="home" class="nav-icon"></i>
        <span class="nav-label">Home</span>
    </button>
    <button class="nav-item" onclick="window.location.href='bingo.html'">
        <i data-lucide="play-circle" class="nav-icon"></i>
        <span class="nav-label">Bingo</span>
    </button>
    <div class="nav-center" onclick="window.location.href='index.html'">
        <div class="nav-icon-bg"><i data-lucide="plus" style="width:28px; height:28px;"></i></div>
    </div>
    <button class="nav-item" onclick="window.location.href='store.html'">
        <i data-lucide="shopping-bag" class="nav-icon"></i>
        <span class="nav-label">Store</span>
    </button>
    <button class="nav-item active" onclick="window.location.reload()">
        <i data-lucide="user" class="nav-icon"></i>
        <span class="nav-label">Me</span>
    </button>
</div>

<div id="customToast">
    <i data-lucide="info" class="toast-icon"></i>
    <span class="toast-msg" id="toastMsg">Notification!</span>
</div>

<div style="width:100%; max-width:500px; margin:0 auto;">
    
    <div class="profile-cover" id="pageProfileCover"></div>
    
    <div class="profile-info-section">
        <div class="profile-header-row">
            <img id="pageProfileImg" class="profile-page-img" src="">
        </div>
        
        <h2 id="pageProfileName" class="profile-page-name">User Name <i data-lucide="badge-check" style="width:20px; color:var(--accent-glow);"></i></h2>
        <p id="pageProfileBio" class="profile-page-bio">Radio Bingo Player</p>
        
        <button class="profile-action-btn secondary" onclick="openEditProfile()">Edit Profile</button>
        <button class="profile-action-btn" style="background:var(--danger); color:white; border:none;" onclick="auth.signOut().then(()=>window.location.href='index.html')">Sign Out</button>

        <div class="profile-stats">
            <div class="stat-item">
                <div class="stat-val" id="statFriends">0</div>
                <div class="stat-lbl">Friends</div>
            </div>
            <div class="stat-item">
                <div class="stat-val" id="statLikes">0</div>
                <div class="stat-lbl">Likes</div>
            </div>
             <div class="stat-item">
                <div class="stat-val" id="statPosts">0</div>
                <div class="stat-lbl">Posts</div>
            </div>
        </div>

        <div class="section-header"><i data-lucide="credit-card" style="width:14px"></i> Wallet & Redemption</div>
        <div class="gcash-section">
            <p style="font-size:11px; color:#cbd5e1; margin-top:0;">Enter your GCash number or Email to receive rewards.</p>
            <div style="display:flex; gap:10px;">
                <input type="text" id="gcashInput" class="styled-input" placeholder="09123456789">
                <button onclick="saveGcash()" style="background:var(--accent); border:none; color:white; padding:0 20px; border-radius:12px; font-weight:800; font-size:12px; cursor:pointer; box-shadow:0 4px 10px rgba(59, 130, 246, 0.3);">SAVE</button>
            </div>
        </div>

        <div class="section-header"><i data-lucide="share-2" style="width:14px"></i> Referral Program</div>
        <div class="ref-container">
            <span style="font-size:10px; font-weight:800; color:var(--success); text-transform:uppercase; margin-bottom:5px; display:block;">Your Invite Link</span>
            <input type="text" id="refLink" readonly class="styled-input" style="background:rgba(0,0,0,0.2); text-align:center; cursor:pointer; margin-bottom:15px;" onclick="this.select(); document.execCommand('copy'); showToast('Copied Link!'); playSound('click');">
            
            <div id="referralInputSection">
                <span style="font-size:10px; font-weight:800; color:var(--gold); text-transform:uppercase; margin-bottom:5px; display:block;">Have a Code?</span>
                <div style="display:flex; gap:10px;">
                    <input type="text" id="referralInput" class="styled-input" placeholder="ENTER CODE">
                    <button onclick="claimReferral()" style="background:var(--gold); border:none; color:black; padding:0 20px; border-radius:12px; font-weight:800; font-size:12px; cursor:pointer; box-shadow:0 4px 10px rgba(251, 191, 36, 0.3);">CLAIM</button>
                </div>
            </div>
        </div>

        <div class="section-header"><i data-lucide="history" style="width:14px"></i> Transaction History</div>
        <div class="history-box" style="margin-top:0;">
            <div id="historyList" class="history-list">
                <div style="text-align:center; opacity:0.5; font-size:12px;">Loading history...</div>
            </div>
        </div>
        
        <div class="section-header"><i data-lucide="layout-grid" style="width:14px"></i> My Posts</div>
        <div id="pageProfileFeed" class="profile-feed-section"></div>
        
        <div style="margin-top:30px; text-align:center; opacity:0.5; font-size:11px; padding-bottom:20px;">
            <a href="#" style="color:white; text-decoration:none;">Privacy Policy</a> | <a href="#" style="color:white; text-decoration:none;">Terms of Service</a>
            <br>Version 2.0.1
        </div>
    </div>
</div>

<div id="editProfileModal" class="modal" onclick="this.style.display='none'">
    <div class="modal-content" onclick="event.stopPropagation()">
        <h3 style="margin-top:0; color:white;">Edit Profile</h3>
        
        <label class="edit-label">Display Name</label>
        <input type="text" id="editNameIn" class="edit-input" placeholder="Your Name">
        
        <label class="edit-label">Bio</label>
        <input type="text" id="editBioIn" class="edit-input" placeholder="Short bio...">
        
        <label class="edit-label">Change Profile Picture</label>
        <input type="file" id="editProfilePicInput" class="edit-input" accept="image/*" onchange="handleProfileUpload(this, 'pfp')">
        
        <label class="edit-label">Change Cover Photo</label>
        <input type="file" id="editCoverPicInput" class="edit-input" accept="image/*" onchange="handleProfileUpload(this, 'cover')">

        <button onclick="saveProfileChanges()" style="width:100%; padding:15px; background:var(--accent); border:none; border-radius:12px; font-weight:900; color:white; cursor:pointer;">SAVE CHANGES</button>
    </div>
</div>

<script>
    // === INITIALIZATION ===
    window.addEventListener('load', () => { lucide.createIcons(); });
    
    const firebaseConfig = { apiKey: "AIzaSyDIAQXJ15atKJxu7PtcFL1W9JnO1N14pVs", authDomain: "radiobingo-9ac29.firebaseapp.com", databaseURL: "https://radiobingo-9ac29-default-rtdb.asia-southeast1.firebasedatabase.app", projectId: "radiobingo-9ac29", storageBucket: "radiobingo-9ac29.firebasestorage.app", messagingSenderId: "965903993397", appId: "1:965903993397:web:f6646fa05225f147eebf7c" };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database(); const auth = firebase.auth();
    let userData = {};

    const sounds = { click: new Audio('https://cdn.pixabay.com/audio/2022/03/15/audio_2731885542.mp3') };
    function playSound(type) { if(sounds[type]) { sounds[type].currentTime = 0; sounds[type].volume = 1.0; sounds[type].play().catch(e => console.log(e)); } }
    function showToast(msg) { const toast = document.getElementById('customToast'); document.getElementById('toastMsg').innerText = msg; toast.classList.add('show'); playSound('click'); setTimeout(() => { toast.classList.remove('show'); }, 3000); }
    function fixDate(timestamp) { if(!timestamp) return "No Date"; const d = new Date(parseInt(timestamp)); return d.toLocaleDateString('en-PH', { month: 'short', day: 'numeric' }) + " " + d.toLocaleTimeString('en-PH', { hour: '2-digit', minute: '2-digit' }); }

    // === AUTH & DATA LOADING ===
    auth.onAuthStateChanged(u => {
        if(u) {
            const userRef = db.ref('users/'+u.uid);
            userRef.on('value', s => { 
                if(s.exists()){ 
                    userData = s.val(); userData.uid = u.uid; 
                    renderProfile(userData);
                } 
            });
            loadProfilePosts(u.uid);
            loadHistory(u.uid);
        } else {
            window.location.href = 'index.html';
        }
    });

    function getBadgeHtml(points) {
        let tierClass = "tier-bronze";
        if(points >= 100000) tierClass = "tier-diamond";
        else if(points >= 50000) tierClass = "tier-platinum";
        else if(points >= 25000) tierClass = "tier-gold";
        else if(points >= 10000) tierClass = "tier-silver";
        return `<span class="badge-tier ${tierClass}"><i data-lucide="badge-check" class="badge-icon"></i></span>`;
    }

    function renderProfile(u) {
        document.getElementById('pageProfileImg').src = u.photo || 'https://via.placeholder.com/100';
        document.getElementById('pageProfileName').innerHTML = `${u.name} ${getBadgeHtml(u.points || 0)}`;
        document.getElementById('pageProfileBio').innerText = u.bio || "Radio Bingo Player";
        
        if(u.cover) {
            document.getElementById('pageProfileCover').style.backgroundImage = `url('${u.cover}')`;
        } else {
            document.getElementById('pageProfileCover').style.background = '#334155';
            document.getElementById('pageProfileCover').style.backgroundImage = 'none';
        }
        
        if(u.gcash) document.getElementById('gcashInput').value = u.gcash;
        document.getElementById('refLink').value = window.location.origin + "/index.html?ref=" + (u.refCode || "");
        if(u.referredBy) document.getElementById('referralInputSection').style.display = 'none';
        
        db.ref('friends/' + u.uid).once('value', fSnap => {
            document.getElementById('statFriends').innerText = fSnap.numChildren() || 0;
        });
        
        document.getElementById('editNameIn').value = u.name;
        document.getElementById('editBioIn').value = u.bio || "";
    }

    // === EDIT PROFILE LOGIC ===
    function openEditProfile() { document.getElementById('editProfileModal').style.display = 'flex'; }
    
    function compressImage(file, maxWidth, quality) {
        return new Promise((resolve) => {
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = (event) => {
                const img = new Image();
                img.src = event.target.result;
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    let width = img.width;
                    let height = img.height;
                    if (width > maxWidth) { height *= maxWidth / width; width = maxWidth; }
                    canvas.width = width; canvas.height = height;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, width, height);
                    resolve(canvas.toDataURL('image/jpeg', quality));
                };
            };
        });
    }

    function handleProfileUpload(input, type) {
        if(input.files && input.files[0]) {
            const maxWidth = type === 'cover' ? 1200 : 500;
            compressImage(input.files[0], maxWidth, 0.7).then(base64 => {
                input.dataset.b64 = base64;
                showToast("Image ready! Click Save.");
            });
        }
    }

    function saveProfileChanges() {
        const newName = document.getElementById('editNameIn').value.trim();
        const newBio = document.getElementById('editBioIn').value.trim();
        const pfpInput = document.getElementById('editProfilePicInput');
        const coverInput = document.getElementById('editCoverPicInput');
        
        if(newName.length < 2) return showToast("Name too short");
        
        const updates = { name: newName, bio: newBio };
        if(pfpInput.dataset.b64) updates.photo = pfpInput.dataset.b64;
        if(coverInput.dataset.b64) updates.cover = coverInput.dataset.b64;
        
        db.ref('users/' + auth.currentUser.uid).update(updates).then(() => {
            showToast("Profile Updated!");
            document.getElementById('editProfileModal').style.display = 'none';
            pfpInput.value = ""; delete pfpInput.dataset.b64;
            coverInput.value = ""; delete coverInput.dataset.b64;
        });
    }

    // === WALLET & REFERRALS ===
    function saveGcash() { 
        const num = document.getElementById('gcashInput').value; 
        if(num.length > 3) { db.ref('users/'+auth.currentUser.uid).update({ gcash: num }); showToast("Info Saved!"); } 
        else showToast("Invalid Details"); 
    }

    function claimReferral() {
        const code = document.getElementById('referralInput').value.trim().toUpperCase();
        if(!code) return showToast("Enter a code");
        if(code === userData.refCode) return showToast("Cannot use own code");
        
        db.ref('users').orderByChild('refCode').equalTo(code).once('value', s => {
            if(s.exists()) {
                const referrerUid = Object.keys(s.val())[0];
                db.ref('users/' + auth.currentUser.uid).update({ referredBy: code });
                db.ref('users/' + auth.currentUser.uid + '/points').transaction(p => (p || 0) + 500);
                db.ref('users/' + referrerUid + '/points').transaction(p => (p || 0) + 1000);
                showToast("Code Claimed! +500 Coins");
                document.getElementById('referralInputSection').style.display = 'none';
                playSound('click');
            } else {
                showToast("Invalid Code");
            }
        });
    }

    function loadHistory(uid) { 
        const list = document.getElementById('historyList'); 
        db.ref('redemptions').orderByChild('uid').equalTo(uid).once('value', s => { 
            list.innerHTML = ""; 
            if(!s.exists()) { list.innerHTML = "<div style='text-align:center; opacity:0.5; padding:10px; font-size:12px;'>No transactions yet</div>"; return; }
            s.forEach(r => { 
                const d = r.val(); 
                let color = '#fbbf24'; 
                if(d.status === 'sent') color = '#10b981'; 
                if(d.status === 'denied') color = '#ef4444'; 
                list.innerHTML += `<div class="history-item"><div><div style="font-weight:700; font-size:12px;">${d.item}</div><div style="font-size:10px; opacity:0.6;">${fixDate(d.timestamp)}</div></div><div style="font-size:10px; font-weight:800; color:${color}; text-transform:uppercase; border:1px solid ${color}; padding:2px 6px; border-radius:4px;">${d.status}</div></div>`; 
            }); 
            lucide.createIcons();
        }); 
    }

    // === MY POSTS ===
    function loadProfilePosts(uid) {
        const container = document.getElementById('pageProfileFeed');
        db.ref('socialPosts').orderByChild('uid').equalTo(uid).limitToLast(20).on('value', pSnap => {
            container.innerHTML = "";
            let count = 0; let likes = 0; const posts = [];
            pSnap.forEach(c => { const p = c.val(); posts.push({ key: c.key, ...p }); count++; likes += (p.likes || 0); });
            
            document.getElementById('statPosts').innerText = count;
            document.getElementById('statLikes').innerText = likes;
            
            posts.reverse().forEach(post => {
                 const postDiv = document.createElement('div'); postDiv.className = 'post-card';
                 const imgHtml = post.image ? `<div class="post-image-container"><img src="${post.image}" class="post-image"></div>` : '';
                 postDiv.innerHTML = `
                        <div class="post-header"><img class="post-avatar" src="${post.authorPhoto}"><div class="post-meta"><div class="post-author">${post.authorName}</div><div class="post-time">${fixDate(post.timestamp)}</div></div></div>
                        <div class="post-content">${post.content}</div>${imgHtml}
                        <div class="post-actions"><button class="action-btn"><i data-lucide="heart" style="width:14px;"></i> ${post.likes || 0}</button></div>
                    `;
                 container.appendChild(postDiv);
            });
            if(count === 0) container.innerHTML = "<div style='color:white; opacity:0.5; font-size:12px; text-align:center; padding:20px;'>No posts yet</div>";
            lucide.createIcons();
        });
    }

</script>
</body>
</html>
